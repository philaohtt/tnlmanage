<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tuition Summary</title>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      /* Dashboard owns page background */
      background: transparent;
      color: #2d3748;
      height: 100%;
      overflow: auto;
    }

    html {
      height: 100%;
    }

    * {
      box-sizing: border-box;
    }

    .container {
      width: 100%;
      min-height: 100%;
      /* Dashboard-embedded content padding */
      padding: 20px;
      background: transparent;
      max-width: none;
      margin: 0;
    }

    .controls {
      background: white;
      padding: 13px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      margin-bottom: 13px;
    }

    .control-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .control-group {
      flex: 1;
      min-width: 128px;
    }

    .control-group label {
      display: block;
      font-size: 9px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 0.2px;
    }

    .control-group input,
    .control-group select {
      width: 100%;
      padding: 6px 10px;
      border: 2px solid #e2e8f0;
      border-radius: 5px;
      font-size: 10px;
      background: white;
      color: #2d3748;
      transition: all 0.2s;
    }

    .control-group input:focus,
    .control-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .info-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0 0 0;
      border-top: 1px solid #e2e8f0;
    }

    .showing-count {
      font-size: 10px;
      color: #718096;
      font-weight: 600;
    }

    .legend {
      display: flex;
      gap: 13px;
      align-items: center;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 9px;
      color: #4a5568;
      font-weight: 500;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .legend-dot.paid { background: #2d7a4f; }
    .legend-dot.unpaid { background: #b44747; }
    .legend-dot.processing { background: #b8860b; }
    .legend-dot.na { background: #9ca3af; }

    .table-container {
      background: white;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 960px;
    }

    thead {
      background: linear-gradient(to bottom, #f7fafc, #edf2f7);
      border-bottom: 2px solid #cbd5e0;
    }

    th {
      padding: 8px 10px;
      text-align: left;
      font-size: 8px;
      font-weight: 700;
      color: #2d3748;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
    }

    th.status-col {
      min-width: 50px;
      max-width: 60px;
    }

    th.month-col {
      text-align: center;
      min-width: 48px;
    }

    tbody tr {
      border-bottom: 1px solid #cbd5e0;
      transition: background 0.15s;
    }

    tbody tr:hover {
      background: #f7fafc;
    }

    td {
      padding: 8px 10px;
      font-size: 10px;
      color: #2d3748;
      border-right: 1px solid #e2e8f0;
    }

    td:last-child {
      border-right: none;
    }

    th {
      border-right: 1px solid #cbd5e0;
    }

    th:last-child {
      border-right: none;
    }

    .student-info {
      min-width: 100px;
      max-width: 130px;
    }

    .student-name {
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 2px;
      font-size: 10px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .student-meta {
      font-size: 9px;
      color: #718096;
      line-height: 1.4;
    }

    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 10px;
      font-size: 8px;
      font-weight: 600;
      letter-spacing: 0.2px;
      white-space: nowrap;
    }

    .status-badge.active {
      background: #c6f6d5;
      color: #22543d;
    }

    .status-badge.inactive {
      background: #feebc8;
      color: #7c2d12;
    }

    .status-badge.finished {
      background: #bee3f8;
      color: #2c5282;
    }

    .status-badge.dropped {
      background: #fed7d7;
      color: #742a2a;
    }

    .month-cell {
      text-align: center;
      font-size: 11px;
      font-weight: 700;
      padding: 8px 4px;
      color: #a0aec0;
    }

    .month-cell.na {
      background: #f1f5f9;
      color: #cbd5e0;
    }

    .summary-cell {
      min-width: 96px;
    }

    .summary-amount {
      font-size: 9px;
      margin: 2px 0;
      font-weight: 600;
      white-space: nowrap;
    }

    .summary-amount.paid { color: #2d7a4f; }
    .summary-amount.unpaid { color: #b44747; }
    .summary-amount.total { color: #2d3748; font-weight: 700; font-size: 10px; }

    .action-cell {
      text-align: center;
    }

    .empty-state {
      text-align: center;
      padding: 64px 16px;
      color: #718096;
    }

    .empty-state h3 {
      font-size: 16px;
      font-weight: 700;
      color: #4a5568;
      margin: 0 0 10px 0;
    }

    .empty-state p {
      font-size: 12px;
      margin: 0 0 20px 0;
    }

    .loading {
      text-align: center;
      padding: 48px;
      color: #718096;
      font-size: 12px;
    }

    .loading-spinner {
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 3px solid #e2e8f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 13px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-state {
      text-align: center;
      padding: 48px 16px;
      color: #e53e3e;
    }

    .error-state h3 {
      font-size: 16px;
      font-weight: 700;
      margin: 0 0 10px 0;
    }

    .error-state p {
      font-size: 12px;
      margin: 0;
      color: #718096;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      max-width: 1100px;
      width: 100%;
      max-height: 90%;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      position: relative;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #e2e8f0;
      flex-shrink: 0;
      gap: 16px;
    }

    .modal-title {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      color: #1a202c;
      flex: 1;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      color: #a0aec0;
      cursor: pointer;
      padding: 0;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
      line-height: 1;
    }

    .modal-close:hover {
      background: #f7fafc;
      color: #2d3748;
    }

    .modal-body {
      overflow-y: auto;
      padding: 20px;
      flex: 1;
    }

    .modal-top-section {
      display: grid;
      grid-template-columns: 2fr 3fr;
      gap: 16px;
      margin-bottom: 20px;
      background: #f7fafc;
      padding: 12px;
      border-radius: 6px;
    }

    .modal-student-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px 16px;
    }

    .modal-info-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }

    .modal-info-label {
      font-size: 10px;
      font-weight: 600;
      color: #718096;
      min-width: 55px;
    }

    .modal-info-value {
      font-size: 12px;
      color: #2d3748;
      font-weight: 500;
    }

    .modal-info-value.name {
      font-size: 15px;
      font-weight: 700;
      color: #1a202c;
    }

    .modal-year-selector-inline {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .modal-year-selector-inline select {
      padding: 3px 6px;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      font-size: 11px;
      background: white;
      color: #2d3748;
      cursor: pointer;
    }

    .modal-year-selector-inline select:focus {
      outline: none;
      border-color: #667eea;
    }

    .modal-payment-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
    }

    .summary-card {
      padding: 8px 10px;
      border-radius: 6px;
      text-align: center;
    }

    .summary-card.expected {
      background: #ede9fe;
      color: #5b21b6;
    }

    .summary-card.paid {
      background: #d1fae5;
      color: #065f46;
    }

    .summary-card.unpaid {
      background: #fee2e2;
      color: #991b1b;
    }

    .summary-card-label {
      font-size: 9px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      margin-bottom: 4px;
      opacity: 0.9;
    }

    .summary-card-value {
      font-size: 16px;
      font-weight: 700;
    }

    .modal-months-section h3 {
      font-size: 13px;
      font-weight: 700;
      color: #1a202c;
      margin: 0 0 12px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .modal-months-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    .month-card {
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      padding: 12px;
      transition: all 0.2s;
    }

    .month-card.no-tuition {
      background: #f1f5f9;
      border-color: #d1d5db;
    }

    .month-card.paid {
      background: #ecfdf5;
      border-color: #86efac;
    }

    .month-card.processing {
      background: #fffbeb;
      border-color: #fdba74;
    }

    .month-card.unpaid {
      background: #fef2f2;
      border-color: #fca5a5;
    }

    .month-card-header {
      font-size: 12px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .month-card.no-tuition .month-card-header {
      color: #94a3b8;
    }

    .month-card-no-tuition-text {
      font-size: 11px;
      color: #94a3b8;
      font-style: italic;
    }

    .month-card-field {
      margin-bottom: 10px;
    }

    .month-card-field label {
      display: block;
      font-size: 10px;
      font-weight: 600;
      color: #64748b;
      margin-bottom: 4px;
    }

    .month-card-field input[type="text"],
    .month-card-field input[type="date"] {
      width: 100%;
      padding: 5px 8px;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      font-size: 12px;
      background: white;
      color: #2d3748;
    }

    .month-card-field input[type="text"]:focus,
    .month-card-field input[type="date"]:focus {
      outline: none;
      border-color: #667eea;
    }

    .month-card-checkboxes {
      display: flex;
      gap: 12px;
      margin-bottom: 10px;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .checkbox-wrapper input[type="checkbox"] {
      width: 15px;
      height: 15px;
      cursor: pointer;
    }

    .checkbox-wrapper label {
      font-size: 11px;
      color: #475569;
      cursor: pointer;
      user-select: none;
      font-weight: 500;
    }

    .extra-fees-section {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #cbd5e0;
    }

    .extra-fees-section h4 {
      font-size: 10px;
      font-weight: 700;
      color: #3b82f6;
      margin: 0 0 8px 0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .extra-fee-item {
      background: rgba(59, 130, 246, 0.05);
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 6px;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .extra-fee-item:last-child {
      margin-bottom: 0;
    }

    .extra-fee-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .extra-fee-name {
      font-weight: 600;
      color: #1e293b;
      font-size: 11px;
    }

    .extra-fee-amount {
      color: #3b82f6;
      font-size: 11px;
      font-weight: 700;
    }

    .extra-fee-checkboxes {
      display: flex;
      gap: 10px;
    }

    .modal-footer {
      padding: 12px 20px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: flex-end;
      flex-shrink: 0;
    }

    .btn-save {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 20px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-save:hover {
      background: #5568d3;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container">
   <div class="controls">
    <div class="control-row">
     <div class="control-group"><label for="search">Search</label> <input type="text" id="search" placeholder="Search by name or student ID">
     </div>
     <div class="control-group"><label for="year-filter">Year</label> <select id="year-filter"> <!-- Options will be populated by JavaScript --> </select>
     </div>
     <div class="control-group"><label for="class-filter">Class</label> <select id="class-filter"> <option value="all">All Classes</option> </select>
     </div>
     <div class="control-group"><label for="status-filter">Status</label> <select id="status-filter"> <option value="all">All</option> <option value="active">Active</option> <option value="inactive">Inactive</option> <option value="finished">Finished</option> <option value="dropped">Dropped</option> </select>
     </div>
     <div class="control-group"><label for="sort-filter">Sort By</label> <select id="sort-filter"> <option value="name-asc">Name A–Z</option> <option value="name-desc">Name Z–A</option> <option value="id-asc">Student ID (Low to High)</option> <option value="id-desc">Student ID (High to Low)</option> </select>
     </div>
    </div>
    <div class="info-bar">
     <div class="showing-count" id="showing-count">
      Loading students...
     </div>
     <div class="legend">
      <div class="legend-item">
       <div class="legend-dot paid"></div><span>Paid</span>
      </div>
      <div class="legend-item">
       <div class="legend-dot unpaid"></div><span>Unpaid</span>
      </div>
      <div class="legend-item">
       <div class="legend-dot processing"></div><span>Processing</span>
      </div>
      <div class="legend-item">
       <div class="legend-dot na"></div><span>N/A</span>
      </div>
     </div>
    </div>
   </div>
   <div class="table-container">
    <table id="tuition-table">
     <thead>
      <tr>
       <th class="student-info">Student Info</th>
       <th class="status-col">Status</th>
       <th class="month-col">JAN</th>
       <th class="month-col">FEB</th>
       <th class="month-col">MAR</th>
       <th class="month-col">APR</th>
       <th class="month-col">MAY</th>
       <th class="month-col">JUN</th>
       <th class="month-col">JUL</th>
       <th class="month-col">AUG</th>
       <th class="month-col">SEP</th>
       <th class="month-col">OCT</th>
       <th class="month-col">NOV</th>
       <th class="month-col">DEC</th>
       <th class="summary-cell">Summary</th>
      </tr>
     </thead>
     <tbody id="table-body">
      <tr>
       <td colspan="15">
        <div class="loading">
         <div class="loading-spinner"></div>
         <div>
          Loading data from Firebase...
         </div>
        </div></td>
      </tr>
     </tbody>
    </table>
   </div><!-- Modal -->
   <div class="modal-overlay" id="modal-overlay">
    <div class="modal-content">
     <div class="modal-header">
      <h1 class="modal-title" id="modal-title">Tuition Details</h1><button class="modal-close" id="modal-close">×</button>
     </div>
     <div class="modal-body" id="modal-body"><!-- Content will be populated by JavaScript -->
     </div>
     <div class="modal-footer"><button class="btn-save" id="btn-save">Save Changes</button>
     </div>
    </div>
   </div>
  </div>
  <script type="module">
    // === PASTE YOUR REAL FIREBASE CONFIG HERE ===
    const firebaseConfig = {
      apiKey: "AIzaSyCDzv0HseeLfijzyXZjKWFh9QaLrMB4afo",
      authDomain: "tnl2026.firebaseapp.com",
      projectId: "tnl2026",
      storageBucket: "tnl2026.firebasestorage.app",
      messagingSenderId: "883525152224",
      appId: "1:883525152224:web:619ae152cd8df3fcca8f85",
      measurementId: "G-3K6LXCKHZ9"
    };

    // Firebase v9 imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const defaultConfig = {
      dashboard_title: "Admin Tuition Summary",
      school_name: "School Management System"
    };

    let allStudents = [];
    let filteredStudents = [];
    let classMap = new Map();
    let availableClasses = new Set();
    let tuitionData = new Map(); // Map<studentId, Map<monthIndex, tuitionDoc>>
    let paymentsData = new Map(); // Map<studentId, Map<monthIndex, paymentDoc>>
    let currentYear = new Date().getFullYear();

    const monthNames = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];

    // Populate year filter with current year as default
    function populateYearFilter() {
      const yearFilter = document.getElementById('year-filter');
      const currentYear = new Date().getFullYear();
      
      for (let year = 2023; year <= 2030; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) {
          option.selected = true;
        }
        yearFilter.appendChild(option);
      }
    }

    // Vietnamese diacritics removal
    function removeDiacritics(str) {
      return str.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }

    async function onConfigChange(config) {
      // Dashboard-embedded: page title/subtitle are owned by the dashboard.
      // Keep this handler resilient in case legacy config values exist.
      const titleEl = document.getElementById('dashboard-title');
      const schoolEl = document.getElementById('school-name');
      if (titleEl) titleEl.textContent = config.dashboard_title || defaultConfig.dashboard_title;
      if (schoolEl) schoolEl.textContent = config.school_name || defaultConfig.school_name;
    }

    async function loadClasses() {
      try {
        const classesSnapshot = await getDocs(collection(db, 'classes'));
        classMap.clear();
        
        classesSnapshot.forEach(doc => {
          const data = doc.data();
          classMap.set(doc.id, data.name || doc.id);
        });

        console.log(`✓ Loaded ${classMap.size} classes`);
        return classMap;
      } catch (error) {
        console.error('Error loading classes:', error);
        return new Map();
      }
    }

    async function loadStudents() {
      try {
        const studentsSnapshot = await getDocs(collection(db, 'students'));
        const students = [];
        
        studentsSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.isDeleted !== true) {
            students.push({
              id: doc.id,
              publicCode: data.publicCode || 'N/A',
              fullName: data.fullName || 'Unknown',
              status: data.status || 'active',
              classId: data.classId || null,
              className: classMap.get(data.classId) || data.classId || 'N/A'
            });
          }
        });

        console.log(`✓ Loaded ${students.length} students (after filtering isDeleted)`);
        return students;
      } catch (error) {
        console.error('Error loading students:', error);
        return [];
      }
    }

    async function loadTuitionForYear(year) {
      try {
        tuitionData.clear();
        console.log(`\n=== Loading tuition data for year ${year} ===`);
        
        const tuitionSnapshot = await getDocs(collection(db, 'tuition_calculations'));
        
        console.log(`✓ Fetched ${tuitionSnapshot.size} total tuition documents`);
        
        let relevantDocsCount = 0;
        
        tuitionSnapshot.forEach(doc => {
          const data = doc.data();
          
          // ONLY process published tuition calculations
          // Check both published field and status field (case-insensitive)
          const isPublished = data.published === true || 
                             (typeof data.status === 'string' && data.status.toLowerCase() === 'published');
          
          if (!isPublished) {
            return;
          }
          
          // Check if this doc matches the pattern TTC_{year}_{MM}_{studentPublicCode}
          const docId = doc.id;
          const pattern = /^TTC_(\d{4})_(\d{2})_(.+)$/;
          const match = docId.match(pattern);
          
          if (match) {
            const [, docYear, docMonth, studentPublicCode] = match;
            
            // Only process documents for the selected year
            if (parseInt(docYear) === year) {
              // Find the student with this publicCode
              const student = allStudents.find(s => s.publicCode === studentPublicCode);
              
              if (student) {
                if (!tuitionData.has(student.id)) {
                  tuitionData.set(student.id, new Map());
                }
                
                const monthIndex = parseInt(docMonth) - 1;
                
                tuitionData.get(student.id).set(monthIndex, {
                  amount: data.finalTotal || 0,
                  baseTuition: data.baseTuition || 0,
                  extraFeesTotal: data.extraFeesTotal || 0,
                  extraFees: data.extraFees || [],
                  hasExtraFees: (data.extraFeesTotal || 0) > 0
                });
                
                relevantDocsCount++;
              }
            }
          }
        });
        
        console.log(`✓ Found ${relevantDocsCount} published tuition documents for year ${year}`);
        
      } catch (error) {
        console.error('Error loading tuition data:', error);
      }
    }

    async function loadPaymentsForYear(year) {
      try {
        paymentsData.clear();
        console.log(`\n=== Loading payments data for year ${year} ===`);
        
        const paymentsSnapshot = await getDocs(collection(db, 'payments'));
        
        console.log(`✓ Fetched ${paymentsSnapshot.size} total payment documents`);
        
        let relevantDocsCount = 0;
        
        paymentsSnapshot.forEach(doc => {
          const data = doc.data();
          
          // Check if this doc matches the pattern PAY_{studentPublicCode}_{year}_{MM}
          const docId = doc.id;
          const pattern = /^PAY_(.+)_(\d{4})_(\d{2})$/;
          const match = docId.match(pattern);
          
          if (match) {
            const [, studentPublicCode, docYear, docMonth] = match;
            
            // Only process documents for the selected year
            if (parseInt(docYear) === year) {
              // Find the student with this publicCode
              const student = allStudents.find(s => s.publicCode === studentPublicCode);
              
              if (student) {
                if (!paymentsData.has(student.id)) {
                  paymentsData.set(student.id, new Map());
                }
                
                const monthIndex = parseInt(docMonth) - 1;
                
                paymentsData.get(student.id).set(monthIndex, {
                  tuitionProcessed: data.tuitionProcessed === true,
                  tuitionPaid: data.tuitionPaid === true,
                  tuitionPaidAt: data.tuitionPaidAt || null,
                  extraFeesProcessed: data.extraFeesProcessed === true,
                  extraFeesPaid: data.extraFeesPaid === true,
                  extraFeesPaidAt: data.extraFeesPaidAt || null
                });
                
                relevantDocsCount++;
              }
            }
          }
        });
        
        console.log(`✓ Found ${relevantDocsCount} payment documents for year ${year}`);
        
      } catch (error) {
        console.error('Error loading payments data:', error);
      }
    }

    function updateAvailableClasses() {
      availableClasses.clear();
      allStudents.forEach(student => {
        if (student.classId) {
          availableClasses.add(student.classId);
        }
      });
      
      const classFilter = document.getElementById('class-filter');
      const currentValue = classFilter.value;
      classFilter.innerHTML = '<option value="all">All Classes</option>';
      
      Array.from(availableClasses).sort().forEach(classId => {
        const option = document.createElement('option');
        option.value = classId;
        option.textContent = classMap.get(classId) || classId;
        classFilter.appendChild(option);
      });
      
      classFilter.value = currentValue;
    }

    function applyFilters() {
      const searchTerm = document.getElementById('search').value;
      const searchNormalized = removeDiacritics(searchTerm);
      const classFilter = document.getElementById('class-filter').value;
      const statusFilter = document.getElementById('status-filter').value;
      const sortFilter = document.getElementById('sort-filter').value;

      filteredStudents = allStudents.filter(student => {
        // Search filter
        const matchesSearch = searchNormalized === '' || 
          removeDiacritics(student.fullName).includes(searchNormalized) || 
          removeDiacritics(student.publicCode).includes(searchNormalized);
        
        // Class filter
        const matchesClass = classFilter === 'all' || student.classId === classFilter;
        
        // Status filter
        const matchesStatus = statusFilter === 'all' || student.status === statusFilter;
        
        return matchesSearch && matchesClass && matchesStatus;
      });

      // Sort
      filteredStudents.sort((a, b) => {
        switch(sortFilter) {
          case 'name-asc':
            return a.fullName.localeCompare(b.fullName);
          case 'name-desc':
            return b.fullName.localeCompare(a.fullName);
          case 'id-asc':
            return a.publicCode.localeCompare(b.publicCode);
          case 'id-desc':
            return b.publicCode.localeCompare(a.publicCode);
          default:
            return 0;
        }
      });

      document.getElementById('showing-count').textContent = `Showing ${filteredStudents.length} student${filteredStudents.length !== 1 ? 's' : ''}`;
    }

    // Format amount for display (divide by 1000, remove trailing zeros)
    function formatDisplayAmount(amount) {
      const divided = amount / 1000;
      return divided.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 3 });
    }

    function renderTable() {
      const tbody = document.getElementById('table-body');
      
      if (filteredStudents.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="15">
              <div class="empty-state">
                <h3>No students found</h3>
                <p>Adjust your filters or check your Firebase data</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filteredStudents.map((student) => {
        const studentTuition = tuitionData.get(student.id) || new Map();
        const studentPayments = paymentsData.get(student.id) || new Map();
        
        let paidSum = 0;
        let unpaidSum = 0;
        let totalSum = 0;
        
        const monthCells = monthNames.map((monthName, monthIndex) => {
          const tuition = studentTuition.get(monthIndex);
          const payment = studentPayments.get(monthIndex);
          
          if (!tuition) {
            return `<td class="month-cell na">N/A</td>`;
          }
          
          const amountRaw = tuition.amount;
          const extraFeesTotal = tuition.extraFeesTotal || 0;
          
          totalSum += amountRaw;
          
          // Determine payment status
          let statusClass = '';
          let bgColor = '';
          
          if (!payment) {
            statusClass = 'unpaid';
            bgColor = '#fffafa';
            unpaidSum += amountRaw;
          } else {
            const tuitionProcessed = payment.tuitionProcessed || false;
            const tuitionPaid = payment.tuitionPaid || false;
            const extraFeesProcessed = payment.extraFeesProcessed || false;
            const extraFeesPaid = payment.extraFeesPaid || false;
            
            // Fully paid: tuition paid AND (no extra fees OR extra fees paid)
            if (tuitionPaid && (extraFeesTotal === 0 || extraFeesPaid)) {
              statusClass = 'paid';
              bgColor = '#f0fff4';
              paidSum += amountRaw;
            } else if (tuitionProcessed || extraFeesProcessed || tuitionPaid || extraFeesPaid) {
              // Partial payment or processing
              statusClass = 'processing';
              bgColor = '#fffbeb';
              unpaidSum += amountRaw;
            } else {
              statusClass = 'unpaid';
              bgColor = '#fff0f0';
              unpaidSum += amountRaw;
            }
          }
          
          const blueDot = tuition?.hasExtraFees ? ' <span style="color: #3b82f6; font-size: 16px;">●</span>' : '';
          
          let textColor = '#111827';
          if (statusClass === 'paid') {
            textColor = '#14532d';
          } else if (statusClass === 'processing') {
            textColor = '#78350f';
          } else if (statusClass === 'unpaid') {
            textColor = '#7f1d1d';
          }
          
          return `<td class="month-cell" style="background-color: ${bgColor}; color: ${textColor};">${formatDisplayAmount(amountRaw)}${blueDot}</td>`;
        }).join('');

        return `
          <tr data-student-id="${student.id}" style="cursor: pointer;">
            <td class="student-info">
              <div class="student-name">${student.fullName}</div>
              <div class="student-meta">
                ID: ${student.publicCode}<br>
                ${student.className}
              </div>
            </td>
            <td>
              <span class="status-badge ${student.status}">${getStatusLabel(student.status)}</span>
            </td>
            ${monthCells}
            <td class="summary-cell">
              <div class="summary-amount paid">Paid: ${paidSum.toLocaleString('en-US')}</div>
              <div class="summary-amount unpaid">Unpaid: ${unpaidSum.toLocaleString('en-US')}</div>
              <div class="summary-amount total">Total: ${totalSum.toLocaleString('en-US')}</div>
            </td>
          </tr>
        `;
      }).join('');

      // Add click event listeners to all rows
      document.querySelectorAll('tbody tr[data-student-id]').forEach(row => {
        row.addEventListener('click', () => {
          const studentId = row.getAttribute('data-student-id');
          const student = filteredStudents.find(s => s.id === studentId);
          if (student) {
            openModal(student);
          }
        });
      });
    }

    function getStatusLabel(status) {
      const labels = {
        'active': 'Active',
        'inactive': 'Inactive',
        'finished': 'Finished',
        'dropped': 'Dropped'
      };
      return labels[status] || status.charAt(0).toUpperCase() + status.slice(1);
    }

    let currentModalStudent = null;
    let currentModalYear = currentYear;
    let modalMonthStates = new Map(); // Format: { tuition: {paid, date}, extraFees: {paid, date} }

    function openModal(student) {
      currentModalStudent = student;
      currentModalYear = currentYear;
      
      // Initialize modal states from payments data
      modalMonthStates.clear();
      const studentTuition = tuitionData.get(student.id) || new Map();
      const studentPayments = paymentsData.get(student.id) || new Map();
      
      monthNames.forEach((_, monthIndex) => {
        const tuition = studentTuition.get(monthIndex);
        const payment = studentPayments.get(monthIndex);
        
        if (tuition) {
          modalMonthStates.set(monthIndex, {
            tuition: { 
              processed: payment?.tuitionProcessed || false,
              paid: payment?.tuitionPaid || false, 
              date: payment?.tuitionPaidAt || '' 
            },
            extraFees: {
              processed: payment?.extraFeesProcessed || false,
              paid: payment?.extraFeesPaid || false,
              date: payment?.extraFeesPaidAt || ''
            }
          });
        }
      });
      
      renderModal();
      document.getElementById('modal-overlay').classList.add('active');
    }

    function getTodayDate() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function renderModal() {
      if (!currentModalStudent) return;

      const student = currentModalStudent;
      const year = currentModalYear;
      
      const studentTuition = tuitionData.get(student.id) || new Map();
      
      let expectedSum = 0;
      let paidSum = 0;
      let unpaidSum = 0;
      
      // Calculate totals
      monthNames.forEach((_, monthIndex) => {
        const tuition = studentTuition.get(monthIndex);
        if (tuition) {
          const totalAmountRaw = tuition.amount;
          expectedSum += totalAmountRaw;
          
          const state = modalMonthStates.get(monthIndex);
          if (state) {
            const extraFeesTotal = tuition.extraFeesTotal || 0;
            const tuitionAmount = totalAmountRaw - extraFeesTotal;
            
            // Determine tuition status
            let tuitionStatus = 'red';
            if (state.tuition.processed && state.tuition.paid) {
              tuitionStatus = 'green';
            } else if (state.tuition.processed && !state.tuition.paid) {
              tuitionStatus = 'yellow';
            }
            
            // Determine extra fees status
            let extraFeesStatus = 'red';
            if (extraFeesTotal > 0) {
              if (state.extraFees.processed && state.extraFees.paid) {
                extraFeesStatus = 'green';
              } else if (state.extraFees.processed && !state.extraFees.paid) {
                extraFeesStatus = 'yellow';
              }
            } else {
              extraFeesStatus = 'green';
            }
            
            // Combined status
            if (tuitionStatus === 'green' && extraFeesStatus === 'green') {
              paidSum += totalAmountRaw;
            } else {
              unpaidSum += totalAmountRaw;
            }
          } else {
            unpaidSum += totalAmountRaw;
          }
        }
      });
      
      // Build year selector options
      let yearOptions = '';
      for (let y = 2023; y <= 2030; y++) {
        yearOptions += `<option value="${y}" ${y === year ? 'selected' : ''}>${y}</option>`;
      }
      
      // Build month cards
      const monthsHTML = monthNames.map((monthName, monthIndex) => {
        const tuition = studentTuition.get(monthIndex);
        const state = modalMonthStates.get(monthIndex);
        
        if (!tuition) {
          return `
            <div class="month-card no-tuition">
              <div class="month-card-header">${monthName}</div>
              <div class="month-card-no-tuition-text">No tuition required</div>
            </div>
          `;
        }
        
        const totalAmountRaw = tuition.amount;
        const extraFeesTotal = tuition.extraFeesTotal || 0;
        const tuitionAmountRaw = totalAmountRaw - extraFeesTotal;
        
        const tuitionProcessed = state?.tuition.processed || false;
        const tuitionPaid = state?.tuition.paid || false;
        const extraFeesProcessed = state?.extraFees.processed || false;
        const extraFeesPaid = state?.extraFees.paid || false;
        
        // Determine tuition status
        let tuitionStatus = 'red';
        if (tuitionProcessed && tuitionPaid) {
          tuitionStatus = 'green';
        } else if (tuitionProcessed && !tuitionPaid) {
          tuitionStatus = 'yellow';
        }
        
        // Determine extra fees status
        let extraFeesStatus = 'red';
        if (extraFeesTotal > 0) {
          if (extraFeesProcessed && extraFeesPaid) {
            extraFeesStatus = 'green';
          } else if (extraFeesProcessed && !extraFeesPaid) {
            extraFeesStatus = 'yellow';
          }
        } else {
          extraFeesStatus = 'green';
        }
        
        // Determine card status
        let statusClass = '';
        if (tuitionStatus === 'green' && extraFeesStatus === 'green') {
          statusClass = 'paid';
        } else if (tuitionStatus === 'red' || extraFeesStatus === 'red') {
          statusClass = 'unpaid';
        } else {
          statusClass = 'processing';
        }
        
        const tuitionFeeLabel = extraFeesTotal > 0 ? `Tuition Fee (of ${formatDisplayAmount(totalAmountRaw)} total)` : 'Tuition Fee';
        
        // Extra fees section
        const extraFeesHTML = extraFeesTotal > 0 && tuition.extraFees && tuition.extraFees.length > 0 ? `
          <div class="extra-fees-section">
            <h4>Extra Fees (${formatDisplayAmount(extraFeesTotal)}.000 total)</h4>
            ${tuition.extraFees.map(fee => `
              <div class="extra-fee-item">
                <div class="extra-fee-header">
                  <span class="extra-fee-name">${fee.name}</span>
                  <span class="extra-fee-amount">${formatDisplayAmount(fee.amount)}.000</span>
                </div>
              </div>
            `).join('')}
            <div class="month-card-checkboxes" style="margin-top: 10px;">
              <div class="checkbox-wrapper">
                <input type="checkbox" id="extra-processed-${monthIndex}" ${extraFeesProcessed ? 'checked' : ''} data-month="${monthIndex}" data-type="extra-processed">
                <label for="extra-processed-${monthIndex}">Processed</label>
              </div>
              <div class="checkbox-wrapper">
                <input type="checkbox" id="extra-paid-${monthIndex}" ${extraFeesPaid ? 'checked' : ''} data-month="${monthIndex}" data-type="extra-paid">
                <label for="extra-paid-${monthIndex}">Paid</label>
              </div>
            </div>
            <div class="month-card-field">
              <label>Extra Fees Payment Date</label>
              <input type="date" id="extra-date-${monthIndex}" value="${state?.extraFees.date || ''}" ${!extraFeesPaid ? 'readonly' : ''} data-month="${monthIndex}" data-type="extra-date">
            </div>
          </div>
        ` : '';
        
        return `
          <div class="month-card ${statusClass}">
            <div class="month-card-header">${monthName}</div>
            
            <div class="month-card-field">
              <label>${tuitionFeeLabel}</label>
              <div style="display: flex; align-items: center; gap: 4px;">
                <input type="text" value="${formatDisplayAmount(tuitionAmountRaw)}" readonly style="flex: 1;">
                <span style="font-size: 11px; color: #64748b; font-weight: 600;">.000</span>
              </div>
            </div>
            
            <div class="month-card-checkboxes">
              <div class="checkbox-wrapper">
                <input type="checkbox" id="processed-${monthIndex}" ${tuitionProcessed ? 'checked' : ''} data-month="${monthIndex}" data-type="processed">
                <label for="processed-${monthIndex}">Processed</label>
              </div>
              <div class="checkbox-wrapper">
                <input type="checkbox" id="paid-${monthIndex}" ${tuitionPaid ? 'checked' : ''} data-month="${monthIndex}" data-type="paid">
                <label for="paid-${monthIndex}">Paid</label>
              </div>
            </div>
            
            <div class="month-card-field">
              <label>Tuition Payment Date</label>
              <input type="date" id="date-${monthIndex}" value="${state?.tuition.date || ''}" ${!tuitionPaid ? 'readonly' : ''} data-month="${monthIndex}" data-type="tuition-date">
            </div>
            
            ${extraFeesHTML}
          </div>
        `;
      }).join('');
      
      const modalBody = document.getElementById('modal-body');
      modalBody.innerHTML = `
        <div class="modal-top-section">
          <div class="modal-student-info">
            <div class="modal-info-row">
              <span class="modal-info-label">Name:</span>
              <span class="modal-info-value name">${student.fullName}</span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Student ID:</span>
              <span class="modal-info-value">${student.publicCode}</span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Class:</span>
              <span class="modal-info-value">${student.className}</span>
            </div>
            <div class="modal-info-row">
              <span class="modal-info-label">Status:</span>
              <span class="status-badge ${student.status}">${getStatusLabel(student.status)}</span>
            </div>
            <div class="modal-info-row modal-year-selector-inline">
              <span class="modal-info-label">Year:</span>
              <select id="modal-year-select">
                ${yearOptions}
              </select>
            </div>
          </div>
          
          <div class="modal-payment-summary">
            <div class="summary-card expected">
              <div class="summary-card-label">Expected</div>
              <div class="summary-card-value">${expectedSum.toLocaleString('en-US')}</div>
            </div>
            <div class="summary-card paid">
              <div class="summary-card-label">Paid</div>
              <div class="summary-card-value">${paidSum.toLocaleString('en-US')}</div>
            </div>
            <div class="summary-card unpaid">
              <div class="summary-card-label">Unpaid</div>
              <div class="summary-card-value">${unpaidSum.toLocaleString('en-US')}</div>
            </div>
          </div>
        </div>
        
        <div class="modal-months-section">
          <h3>Monthly Tuition Details</h3>
          <div class="modal-months-grid">
            ${monthsHTML}
          </div>
        </div>
      `;
      
      document.getElementById('modal-title').textContent = `${student.fullName} – Tuition Details`;
      
      // Add event listener for year selector
      document.getElementById('modal-year-select').addEventListener('change', async (e) => {
        currentModalYear = parseInt(e.target.value);
        
        if (currentModalYear !== currentYear) {
          modalBody.innerHTML = '<div style="text-align: center; padding: 48px;">Loading...</div>';
          await loadTuitionForYear(currentModalYear);
          await loadPaymentsForYear(currentModalYear);
          
          // Re-initialize modal states
          modalMonthStates.clear();
          const studentTuition = tuitionData.get(student.id) || new Map();
          const studentPayments = paymentsData.get(student.id) || new Map();
          
          monthNames.forEach((_, monthIndex) => {
            const tuition = studentTuition.get(monthIndex);
            const payment = studentPayments.get(monthIndex);
            
            if (tuition) {
              modalMonthStates.set(monthIndex, {
                tuition: { 
                  processed: payment?.tuitionProcessed || false,
                  paid: payment?.tuitionPaid || false, 
                  date: payment?.tuitionPaidAt || '' 
                },
                extraFees: {
                  processed: payment?.extraFeesProcessed || false,
                  paid: payment?.extraFeesPaid || false,
                  date: payment?.extraFeesPaidAt || ''
                }
              });
            }
          });
          
          renderModal();
        } else {
          renderModal();
        }
      });
      
      // Add event listeners for checkboxes
      document.querySelectorAll('.month-card input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const monthIndex = parseInt(e.target.dataset.month);
          const type = e.target.dataset.type;
          const isChecked = e.target.checked;
          
          const state = modalMonthStates.get(monthIndex) || { 
            tuition: { processed: false, paid: false, date: '' },
            extraFees: { processed: false, paid: false, date: '' }
          };
          
          if (type === 'processed') {
            state.tuition.processed = isChecked;
            // If unchecking processed, force uncheck paid and clear date
            if (!isChecked) {
              state.tuition.paid = false;
              state.tuition.date = '';
            }
          } else if (type === 'paid') {
            state.tuition.paid = isChecked;
            // If checking paid, auto-check processed
            if (isChecked) {
              state.tuition.processed = true;
              state.tuition.date = getTodayDate();
            } else {
              state.tuition.date = '';
            }
          } else if (type === 'extra-processed') {
            state.extraFees.processed = isChecked;
            // If unchecking processed, force uncheck paid and clear date
            if (!isChecked) {
              state.extraFees.paid = false;
              state.extraFees.date = '';
            }
          } else if (type === 'extra-paid') {
            state.extraFees.paid = isChecked;
            // If checking paid, auto-check processed
            if (isChecked) {
              state.extraFees.processed = true;
              state.extraFees.date = getTodayDate();
            } else {
              state.extraFees.date = '';
            }
          }
          
          modalMonthStates.set(monthIndex, state);
          renderModal();
        });
      });

      // Add event listeners for date inputs
      document.querySelectorAll('.month-card input[type="date"]').forEach(dateInput => {
        dateInput.addEventListener('change', (e) => {
          const monthIndex = parseInt(e.target.dataset.month);
          const type = e.target.dataset.type;
          const newDate = e.target.value;
          
          const state = modalMonthStates.get(monthIndex);
          if (state) {
            if (type === 'tuition-date') {
              state.tuition.date = newDate;
            } else if (type === 'extra-date') {
              state.extraFees.date = newDate;
            }
            modalMonthStates.set(monthIndex, state);
          }
        });
      });
    }

    function closeModal() {
      const modal = document.getElementById('modal-overlay');
      modal.classList.remove('active');
    }

    // Event listeners
    document.getElementById('modal-close').addEventListener('click', closeModal);
    
    document.getElementById('modal-overlay').addEventListener('click', (e) => {
      if (e.target.id === 'modal-overlay') {
        closeModal();
      }
    });

    document.getElementById('btn-save').addEventListener('click', async () => {
      if (!currentModalStudent) return;
      
      const btn = document.getElementById('btn-save');
      const originalText = btn.textContent;
      btn.textContent = 'Saving...';
      btn.disabled = true;
      
      try {
        const student = currentModalStudent;
        const year = currentModalYear;
        const studentTuition = tuitionData.get(student.id) || new Map();
        
        const savePromises = [];
        
        for (const [monthIndex, state] of modalMonthStates.entries()) {
          const tuition = studentTuition.get(monthIndex);
          if (!tuition) continue;
          
          const monthStr = String(monthIndex + 1).padStart(2, '0');
          const paymentDocId = `PAY_${student.publicCode}_${year}_${monthStr}`;
          
          const hasExtraFees = (tuition.extraFeesTotal || 0) > 0;
          
          // Enforce: Paid ⇒ Processed
          if (state.tuition.paid) state.tuition.processed = true;
          if (hasExtraFees && state.extraFees.paid) state.extraFees.processed = true;
          
          const paymentData = {
            studentId: student.id,
            studentPublicCode: student.publicCode,
            year: year,
            month: monthIndex + 1,
            tuitionProcessed: !!state?.tuition?.processed,
            tuitionPaid: !!state?.tuition?.paid,
            tuitionPaidAt: state?.tuition?.paid ? (state?.tuition?.date || null) : null,
            updatedAt: serverTimestamp()
          };
          
          if (hasExtraFees) {
            paymentData.extraFeesProcessed = !!state?.extraFees?.processed;
            paymentData.extraFeesPaid = !!state?.extraFees?.paid;
            paymentData.extraFeesPaidAt = state?.extraFees?.paid ? (state?.extraFees?.date || null) : null;
          }
          
          savePromises.push(setDoc(doc(db, 'payments', paymentDocId), paymentData, { merge: true }));
        }
        
        await Promise.all(savePromises);
        
        // Reload payments data
        await loadPaymentsForYear(year);
        
        // Re-sync modal states
        const studentPayments = paymentsData.get(student.id) || new Map();
        modalMonthStates.forEach((state, monthIndex) => {
          const payment = studentPayments.get(monthIndex);
          if (payment) {
            state.tuition.processed = payment.tuitionProcessed || false;
            state.tuition.paid = payment.tuitionPaid || false;
            state.tuition.date = payment.tuitionPaidAt || '';
            state.extraFees.processed = payment.extraFeesProcessed || false;
            state.extraFees.paid = payment.extraFeesPaid || false;
            state.extraFees.date = payment.extraFeesPaidAt || '';
          }
        });
        
        renderModal();
        
        if (year === currentYear) {
          renderTable();
        }
        
        btn.textContent = 'Saved!';
        btn.style.background = '#10b981';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '';
          btn.disabled = false;
        }, 1500);
        
      } catch (error) {
        console.error('Error saving payments:', error);
        btn.textContent = 'Error!';
        btn.style.background = '#ef4444';
        setTimeout(() => {
          btn.textContent = originalText;
          btn.style.background = '';
          btn.disabled = false;
        }, 2000);
      }
    });

    document.getElementById('search').addEventListener('input', () => {
      applyFilters();
      renderTable();
    });

    document.getElementById('year-filter').addEventListener('change', async (e) => {
      currentYear = parseInt(e.target.value);
      document.getElementById('showing-count').textContent = 'Loading tuition data...';
      await loadTuitionForYear(currentYear);
      await loadPaymentsForYear(currentYear);
      renderTable();
      document.getElementById('showing-count').textContent = `Showing ${filteredStudents.length} student${filteredStudents.length !== 1 ? 's' : ''}`;
    });

    ['class-filter', 'status-filter', 'sort-filter'].forEach(id => {
      document.getElementById(id).addEventListener('change', () => {
        applyFilters();
        renderTable();
      });
    });

    // Initialize
    async function init() {
      try {
        populateYearFilter();

        if (window.elementSdk) {
          window.elementSdk.init({
            defaultConfig,
            onConfigChange,
            mapToCapabilities: (config) => ({
              recolorables: [],
              borderables: [],
              fontEditable: undefined,
              fontSizeable: undefined
            }),
            mapToEditPanelValues: (config) => new Map([
              ["dashboard_title", config.dashboard_title || defaultConfig.dashboard_title],
              ["school_name", config.school_name || defaultConfig.school_name]
            ])
          });
        }

        await loadClasses();
        allStudents = await loadStudents();
        updateAvailableClasses();
        applyFilters();
        
        currentYear = parseInt(document.getElementById('year-filter').value);
        await loadTuitionForYear(currentYear);
        await loadPaymentsForYear(currentYear);
        
        renderTable();

      } catch (error) {
        console.error('Initialization error:', error);
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = `
          <tr>
            <td colspan="15">
              <div class="error-state">
                <h3>Failed to load data</h3>
                <p>Please check your Firebase configuration and connection</p>
              </div>
            </td>
          </tr>
        `;
        document.getElementById('showing-count').textContent = 'Error loading data';
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ba88913e2eb1075',t:'MTc2Nzg0MjE3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>