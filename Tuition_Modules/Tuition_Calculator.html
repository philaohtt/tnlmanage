<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tuition Calculator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div class="w-full h-full overflow-auto">
   <div class="p-6"><!-- Control Panel -->
    <div class="mb-4 p-4 border border-gray-300 bg-gray-50 rounded">
     <div class="flex gap-4 items-end flex-wrap">
      <div><label for="year-select" class="block text-sm font-medium text-gray-700 mb-1">Year</label> <select id="year-select" class="border border-gray-300 rounded px-3 py-2 text-sm"> <option value="2024">2024</option> <option value="2025" selected>2025</option> <option value="2026">2026</option> <option value="2027">2027</option> <option value="2028">2028</option> <option value="2029">2029</option> <option value="2030">2030</option> </select>
      </div>
      <div><label for="month-select" class="block text-sm font-medium text-gray-700 mb-1">Month</label> <select id="month-select" class="border border-gray-300 rounded px-3 py-2 text-sm"> <option value="1">January</option> <option value="2">February</option> <option value="3">March</option> <option value="4">April</option> <option value="5">May</option> <option value="6">June</option> <option value="7">July</option> <option value="8">August</option> <option value="9">September</option> <option value="10">October</option> <option value="11">November</option> <option value="12">December</option> </select>
      </div>
      <div><label for="class-select" class="block text-sm font-medium text-gray-700 mb-1">Class</label> <select id="class-select" class="border border-gray-300 rounded px-3 py-2 text-sm"> <option value="all">All</option> </select>
      </div><button id="load-data-btn" class="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">Load Data</button> <button id="recalc-all-btn" class="px-4 py-2 bg-green-600 text-white text-sm rounded hover:bg-green-700">Recalculate All</button>
     </div>
    </div><!-- Search and Filter Bar -->
    <div class="mb-4 p-3 border border-gray-300 bg-gray-50 rounded">
     <div class="flex gap-3 items-end flex-wrap">
      <div class="flex-1 min-w-48"><label for="search-input" class="block text-sm font-medium text-gray-700 mb-1">Search</label> <input type="text" id="search-input" placeholder="Student name or ID..." class="w-full border border-gray-300 rounded px-3 py-2 text-sm">
      </div>
      <div><label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Status</label> <select id="status-filter" class="border border-gray-300 rounded px-3 py-2 text-sm"> <option value="all">All</option> <option value="draft">Draft</option> <option value="locked">Locked</option> <option value="published">Published</option> </select>
      </div>
      <div><label for="student-status-filter" class="block text-sm font-medium text-gray-700 mb-1">Student Status</label> <select id="student-status-filter" class="border border-gray-300 rounded px-3 py-2 text-sm"> <option value="all">All</option> <option value="active">Active Only</option> </select>
      </div>
      <div><label for="plan-filter" class="block text-sm font-medium text-gray-700 mb-1">Tuition Plan</label> <select id="plan-filter" class="border border-gray-300 rounded px-3 py-2 text-sm"> <option value="all">All</option> </select>
      </div>
      <div><label for="sort-select" class="block text-sm font-medium text-gray-700 mb-1">Sort By</label> <select id="sort-select" class="border border-gray-300 rounded px-3 py-2 text-sm"> <option value="name-asc">Name (A-Z)</option> <option value="name-desc">Name (Z-A)</option> <option value="id-asc">ID (Low-High)</option> <option value="id-desc">ID (High-Low)</option> <option value="total-asc">Total (Low-High)</option> <option value="total-desc">Total (High-Low)</option> </select>
      </div>
     </div>
    </div><!-- Batch Actions Bar -->
    <div class="mb-4 p-3 border border-gray-300 bg-gray-50 rounded">
     <div class="flex gap-3 items-center flex-wrap"><button id="save-selected-btn" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700" disabled>Save Selected</button> <button id="lock-selected-btn" class="px-3 py-1.5 bg-orange-600 text-white text-sm rounded hover:bg-orange-700" disabled>Lock Selected</button> <button id="publish-selected-btn" class="px-3 py-1.5 bg-green-600 text-white text-sm rounded hover:bg-green-700" disabled>Publish Selected</button> <button id="recall-selected-btn" class="px-3 py-1.5 bg-red-600 text-white text-sm rounded hover:bg-red-700" disabled>Recall Selected</button> <span id="selected-count" class="text-sm text-gray-700">0 selected</span>
     </div>
    </div><!-- Debug Info -->
    <div id="debug-info" class="mb-4 border border-blue-300 bg-blue-50 text-sm rounded hidden"><button id="debug-toggle" class="w-full p-4 text-left font-bold hover:bg-blue-100 flex items-center justify-between rounded"> <span>Debug Information</span> <span id="debug-icon">▼</span> </button>
     <div id="debug-content" class="p-4 pt-0 hidden"></div>
    </div><!-- Blueprint Data Table -->
    <div id="blueprint-table-container" class="mb-4 border border-purple-300 rounded hidden"><button id="blueprint-toggle" class="w-full bg-purple-50 p-2 text-left font-bold text-sm hover:bg-purple-100 flex items-center justify-between rounded-t"> <span>Blueprint Data (Raw from Firestore)</span> <span id="blueprint-icon">▼</span> </button>
     <div id="blueprint-table-content" class="overflow-x-auto hidden">
      <table class="w-full text-xs">
       <thead class="bg-purple-100 border-b border-purple-300">
        <tr>
         <th class="p-2 text-left">Student ID</th>
         <th class="p-2 text-left">Public Code</th>
         <th class="p-2 text-left">Student Name</th>
         <th class="p-2 text-left">Class ID</th>
         <th class="p-2 text-left">Class Name</th>
         <th class="p-2 text-left">Status</th>
         <th class="p-2 text-left">Plan ID</th>
         <th class="p-2 text-left">Year</th>
         <th class="p-2 text-left">Month</th>
        </tr>
       </thead>
       <tbody id="blueprint-table-body"></tbody>
      </table>
     </div>
    </div><!-- Main Tuition Table -->
    <div class="border border-gray-300 rounded">
     <div class="overflow-x-auto">
      <table class="w-full text-sm">
       <thead class="bg-gray-100 border-b border-gray-300">
        <tr>
         <th class="p-2 text-left"><input type="checkbox" id="select-all-checkbox" class="w-4 h-4"></th>
         <th class="p-2 text-left">Student</th>
         <th class="p-2 text-left">Class &amp; Status</th>
         <th class="p-2 text-left">Tuition Plan</th>
         <th class="p-2 text-left">Pricing Summary</th>
         <th class="p-2 text-left">Subtotal</th>
         <th class="p-2 text-left">Discount</th>
         <th class="p-2 text-left">Extra Fees</th>
         <th class="p-2 text-left">Final Total</th>
         <th class="p-2 text-left">Status / Actions</th>
        </tr>
       </thead>
       <tbody id="tuition-table-body">
        <tr>
         <td colspan="10" class="p-4 text-center text-gray-500">Click "Load Data" to display tuition records</td>
        </tr>
       </tbody>
      </table>
     </div>
    </div>
   </div>
  </div><!-- Extra Fees Modal -->
  <div id="fees-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
   <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto shadow-xl">
    <h2 id="modal-title" class="text-lg font-bold mb-4">Extra Fees</h2>
    <div id="fees-list" class="mb-4"></div><button id="add-fee-btn" class="px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 mb-4">Add Fee</button>
    <div class="flex gap-2 justify-end"><button id="cancel-fees-btn" class="px-4 py-2 bg-gray-300 text-gray-700 text-sm rounded hover:bg-gray-400">Cancel</button> <button id="save-fees-btn" class="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">Save</button>
    </div>
   </div>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCDzv0HseeLfijzyXZjKWFh9QaLrMB4afo",
      authDomain: "tnl2026.firebaseapp.com",
      projectId: "tnl2026",
      storageBucket: "tnl2026.firebasestorage.app",
      messagingSenderId: "883525152224",
      appId: "1:883525152224:web:619ae152cd8df3fcca8f85",
      measurementId: "G-3K6LXCKHZ9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const defaultConfig = {
      page_title: 'Tuition Calculator',
      page_subtitle: 'Monthly tuition processing'
    };

    let allClasses = [];
    let allPlans = [];
    let currentRecords = [];
    let selectedRows = new Set();
    let currentModalDocId = null;
    let currentFees = {};

    async function onConfigChange(config) {
      // Config change handler - no visible elements to update in module mode
    }

    function formatCurrency(value) {
      return new Intl.NumberFormat('vi-VN').format(value);
    }

    function getStudentStatusColor(status) {
      if (!status) return 'text-red-600';
      const statusLower = status.toLowerCase();
      if (statusLower === 'active') return 'text-green-600';
      return 'text-red-600';
    }

    function sumSessionsByType(typeIds = [], typeNames = [], perCourseCounts = []) {
      const map = {}; // typeId -> { typeName, sessions }
      for (let i = 0; i < typeIds.length; i++) {
        const typeId = typeIds[i];
        if (!typeId) continue;
        const typeName = typeNames[i] || typeId;
        const c = Number(perCourseCounts?.[i] || 0);
        if (!map[typeId]) map[typeId] = { typeName, sessions: 0 };
        map[typeId].sessions += c;
      }
      return map;
    }

    function calculateSubtotal(planItems, sessionsByType) {
      let subtotal = 0;
      planItems.forEach(item => {
        const attendedSessions = sessionsByType[item.courseTypeId]?.sessions || 0;
        
        if (item.pricePerSession !== undefined) {
          subtotal += attendedSessions * item.pricePerSession;
        } else if (item.pricePerMonth !== undefined && attendedSessions > 0) {
          subtotal += item.pricePerMonth;
        }
      });
      return subtotal;
    }

    function buildPricingLines(planItems, sessionsByType) {
      const lines = [];
      planItems.forEach(item => {
        const attendedSessions = sessionsByType[item.courseTypeId]?.sessions || 0;
        const typeName = sessionsByType[item.courseTypeId]?.typeName || item.courseTypeId;
        let amount = 0;
        let detail = '';

        if (item.pricePerSession !== undefined) {
          amount = attendedSessions * item.pricePerSession;
          detail = `${typeName}: ${attendedSessions} sessions × ${formatCurrency(item.pricePerSession)}`;
        } else if (item.pricePerMonth !== undefined && attendedSessions > 0) {
          amount = item.pricePerMonth;
          detail = `${typeName}: Monthly fee (${attendedSessions} sessions attended)`;
        }

        if (amount > 0) {
          lines.push({
            courseTypeId: item.courseTypeId,
            detail: detail,
            amount: amount
          });
        }
      });
      return lines;
    }

    function calculateDiscount(subtotal, type, value) {
      if (type === '%') {
        return Math.round(subtotal * value / 100);
      }
      return value;
    }

    function roundUpToNearest(value, nearest) {
      // Smart rounding based on the specified rules
      // Find which 100k block we're in
      const hundred_k = Math.floor(value / 100000) * 100000;
      const remainder = value - hundred_k;
      
      if (remainder <= 25000) {
        return hundred_k;
      } else if (remainder <= 75000) {
        return hundred_k + 50000;
      } else {
        return hundred_k + 100000;
      }
    }

    function calculateFinalTotal(subtotal, discountAmount, extraFees) {
      const total = subtotal - discountAmount + extraFees;
      const rounded = roundUpToNearest(Math.max(0, total), 50000);
      return rounded;
    }

    let filteredRecords = [];

    function applyFiltersAndSort() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const statusFilter = document.getElementById('status-filter').value;
      const studentStatusFilter = document.getElementById('student-status-filter').value;
      const planFilter = document.getElementById('plan-filter').value;
      const sortBy = document.getElementById('sort-select').value;

      filteredRecords = currentRecords.filter(record => {
        const matchesSearch = !searchTerm || 
          record.studentName.toLowerCase().includes(searchTerm) ||
          record.studentPublicCode.toLowerCase().includes(searchTerm);
        
        const matchesStatus = statusFilter === 'all' || record.status === statusFilter;
        const matchesStudentStatus = studentStatusFilter === 'all' || 
          (studentStatusFilter === 'active' && record.studentStatus?.toLowerCase() === 'active');
        const matchesPlan = planFilter === 'all' || record.tuitionPlanId === planFilter;

        return matchesSearch && matchesStatus && matchesStudentStatus && matchesPlan;
      });

      // Sort
      filteredRecords.sort((a, b) => {
        switch(sortBy) {
          case 'name-asc':
            return a.studentName.localeCompare(b.studentName);
          case 'name-desc':
            return b.studentName.localeCompare(a.studentName);
          case 'id-asc':
            return a.studentPublicCode.localeCompare(b.studentPublicCode);
          case 'id-desc':
            return b.studentPublicCode.localeCompare(a.studentPublicCode);
          case 'total-asc':
            return a.finalTotal - b.finalTotal;
          case 'total-desc':
            return b.finalTotal - a.finalTotal;
          default:
            return 0;
        }
      });

      renderTable();
    }

    async function loadFirestoreData() {
      const classesSnap = await db.collection('classes').get();
      allClasses = classesSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      const plansSnap = await db.collection('tuition_plans').get();
      allPlans = plansSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

      populateClassDropdown();
    }

    function populateClassDropdown() {
      const select = document.getElementById('class-select');
      select.innerHTML = '<option value="all">All</option>';
      allClasses.forEach(cls => {
        const option = document.createElement('option');
        option.value = cls.id;
        option.textContent = cls.name || cls.id;
        select.appendChild(option);
      });
    }

    function populatePlanFilter() {
      const select = document.getElementById('plan-filter');
      select.innerHTML = '<option value="all">All</option>';
      allPlans.forEach(plan => {
        const option = document.createElement('option');
        option.value = plan.id;
        option.textContent = plan.name || plan.id;
        select.appendChild(option);
      });
    }

    async function handleLoadData() {
      const btn = document.getElementById('load-data-btn');
      btn.disabled = true;
      btn.textContent = 'Loading...';

      const year = parseInt(document.getElementById('year-select').value);
      const month = parseInt(document.getElementById('month-select').value);
      const classFilter = document.getElementById('class-select').value;

      let query = db.collection('tuition_blueprint')
        .where('year', '==', year)
        .where('month', '==', month);

      if (classFilter !== 'all') {
        query = query.where('classId', '==', classFilter);
      }

      const blueprintsSnap = await query.get();
      const blueprints = blueprintsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      console.log('[DEBUG] Blueprints fetched:', blueprints.length, blueprints);

      // Show debug info
      const debugInfo = document.getElementById('debug-info');
      const debugContent = document.getElementById('debug-content');
      debugInfo.classList.remove('hidden');
      debugContent.innerHTML = `
        <p><strong>Query Parameters:</strong> Year=${year}, Month=${month}, ClassFilter=${classFilter}</p>
        <p><strong>Blueprints Found:</strong> ${blueprints.length}</p>
        <p><strong>Classes Loaded:</strong> ${allClasses.length}</p>
        <p><strong>Plans Loaded:</strong> ${allPlans.length}</p>
      `;

      // Show blueprint table
      const blueprintTableContainer = document.getElementById('blueprint-table-container');
      const blueprintTableBody = document.getElementById('blueprint-table-body');
      blueprintTableContainer.classList.remove('hidden');
      blueprintTableBody.innerHTML = '';

      blueprints.forEach(bp => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-purple-200';
        tr.innerHTML = `
          <td class="p-2">${bp.studentId || '<em>null</em>'}</td>
          <td class="p-2">${bp.studentPublicCode || '<em>null</em>'}</td>
          <td class="p-2">${bp.studentNameCache || '<em>null</em>'}</td>
          <td class="p-2">${bp.classId || '<em>null</em>'}</td>
          <td class="p-2">${bp.classNameCache || '<em>null</em>'}</td>
          <td class="p-2">${bp.studentStatus || '<em>null</em>'}</td>
          <td class="p-2">${bp.tuitionPlanId || '<em>null</em>'}</td>
          <td class="p-2">${bp.year || '<em>null</em>'}</td>
          <td class="p-2">${bp.month || '<em>null</em>'}</td>
        `;
        blueprintTableBody.appendChild(tr);
      });

      currentRecords = [];

      for (const bp of blueprints) {
        const monthPadded = month.toString().padStart(2, '0');
        const docId = `TTC_${year}_${monthPadded}_${bp.studentPublicCode}`;
        
        const docSnap = await db.collection('tuition_calculations').doc(docId).get();
        
        if (docSnap.exists) {
          currentRecords.push({ id: docId, ...docSnap.data() });
        } else {
          const plan = allPlans.find(p => p.id === bp.tuitionPlanId) || null;

          const sessionsByType = sumSessionsByType(
            bp.courseTypeIdCache || [],
            bp.courseTypeNameCache || [],
            bp.courseSessionCounts || []
          );

          const subtotal = plan ? calculateSubtotal(plan.items || [], sessionsByType) : 0;
          const lines = plan ? buildPricingLines(plan.items || [], sessionsByType) : [];
          
          const newRecord = {
            studentId: bp.studentId || '',
            studentPublicCode: bp.studentPublicCode || '',
            studentName: bp.studentNameCache || '',
            studentStatus: bp.studentStatus || '',
            classId: bp.classId || null,
            className: bp.classNameCache || null,
            tuitionPlanId: bp.tuitionPlanId || null,
            tuitionPlanName: bp.tuitionPlanNameCache || (plan ? plan.name : null),
            courseIds: bp.courseIds || [],
            courseNameCache: bp.courseNameCache || [],
            courseLabels: bp.courseLabels || [],
            courseTypeIdCache: bp.courseTypeIdCache || [],
            courseTypeNameCache: bp.courseTypeNameCache || [],
            coursePricingMethodCache: bp.coursePricingMethodCache || [],
            courseSessionCounts: bp.courseSessionCounts || [],
            sessionCount: bp.sessionCount || 0,
            lines: lines,
            subtotal: subtotal,
            discountType: '%',
            discountValue: 0,
            discountNote: '',
            extraFees: [],
            extraFeesTotal: 0,
            finalTotal: subtotal,
            status: 'draft',
            year: year,
            month: month,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };

          currentRecords.push({ id: docId, ...newRecord });
        }
      }

      populatePlanFilter();
      applyFiltersAndSort();

      btn.disabled = false;
      btn.textContent = 'Load Data';
    }

    function renderTable() {
      const tbody = document.getElementById('tuition-table-body');
      tbody.innerHTML = '';

      const recordsToRender = filteredRecords.length > 0 || currentRecords.length > 0 ? filteredRecords : currentRecords;

      if (currentRecords.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-gray-500">No records found. Click "Load Data" to load/create records.</td></tr>';
        return;
      }

      if (recordsToRender.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" class="p-4 text-center text-gray-500">No records match the current filters.</td></tr>';
        return;
      }

      recordsToRender.forEach(record => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-200';
        tr.dataset.docId = record.id;

        const discountAmount = calculateDiscount(record.subtotal, record.discountType, record.discountValue);

        const sessionsByType = sumSessionsByType(
          record.courseTypeIdCache || [],
          record.courseTypeNameCache || [],
          record.courseSessionCounts || []
        );

        const pricingLines = (record.lines || []).length > 0 
          ? (record.lines || []).map(line => {
              return `${line.detail} = ${formatCurrency(line.amount)}`;
            }).join('<br>')
          : 'No plan assigned';

        const pricingSummary = pricingLines;

        const isReadOnly = record.status === 'published';

        tr.innerHTML = `
          <td class="p-2">
            <input type="checkbox" class="row-checkbox w-4 h-4" data-doc-id="${record.id}" ${isReadOnly ? 'disabled' : ''}>
          </td>
          <td class="p-2">
            <div class="font-medium">${record.studentName}</div>
            <div class="text-xs text-gray-500">${record.studentPublicCode}</div>
          </td>
          <td class="p-2">
            <div>${record.className || 'N/A'}</div>
            <div class="text-xs ${getStudentStatusColor(record.studentStatus)} font-medium">${record.studentStatus || 'N/A'}</div>
          </td>
          <td class="p-2">
            <select class="plan-select border border-gray-300 rounded px-2 py-1 text-xs w-full" data-doc-id="${record.id}" ${isReadOnly ? 'disabled' : ''}>
              ${allPlans.map(p => `<option value="${p.id}" ${p.id === record.tuitionPlanId ? 'selected' : ''}>${p.name}</option>`).join('')}
            </select>
          </td>
          <td class="p-2">
            <div class="text-xs">${pricingSummary}</div>
          </td>
          <td class="p-2">${formatCurrency(record.subtotal)}</td>
          <td class="p-2">
            <div class="flex gap-1 mb-1">
              <select class="discount-type-select border border-gray-300 rounded px-2 py-1 text-xs" data-doc-id="${record.id}" ${isReadOnly ? 'disabled' : ''}>
                <option value="%" ${record.discountType === '%' ? 'selected' : ''}>%</option>
                <option value="₫" ${record.discountType === '₫' ? 'selected' : ''}>₫</option>
              </select>
              <input type="number" class="discount-value-input border border-gray-300 rounded px-2 py-1 text-xs w-20" value="${record.discountValue}" data-doc-id="${record.id}" ${isReadOnly ? 'disabled' : ''}>
            </div>
            <input type="text" class="discount-note-input border border-gray-300 rounded px-1 py-0.5 text-xs w-full" placeholder="Note" value="${record.discountNote || ''}" data-doc-id="${record.id}" ${isReadOnly ? 'disabled' : ''}>
          </td>
          <td class="p-2">
            <button class="edit-fees-btn text-xs text-blue-600 hover:underline mb-1" data-doc-id="${record.id}" ${isReadOnly ? 'disabled' : ''}>Edit Fees (${(record.extraFees || []).length})</button>
            ${(record.extraFees || []).map(fee => `<div class="text-xs text-gray-600">${fee.name}: ${formatCurrency(fee.amount)}</div>`).join('')}
            <div class="text-xs text-gray-700 font-medium mt-1">Total: ${formatCurrency(record.extraFeesTotal)}</div>
          </td>
          <td class="p-2">
            <input type="text" class="final-total-input border border-gray-300 rounded px-2 py-1 text-sm w-32 font-bold" value="${formatCurrency(record.finalTotal)}" data-doc-id="${record.id}" ${isReadOnly ? 'disabled' : ''}>
          </td>
          <td class="p-2">
            ${record.status === 'draft' ? `
              <button class="save-btn text-xs px-2 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 mb-1" data-doc-id="${record.id}">Save</button>
              <button class="lock-btn text-xs px-2 py-1 bg-orange-600 text-white rounded hover:bg-orange-700" data-doc-id="${record.id}">Lock</button>
            ` : record.status === 'locked' ? `
              <button class="publish-btn text-xs px-2 py-1 bg-green-600 text-white rounded hover:bg-green-700 mb-1" data-doc-id="${record.id}">Publish</button>
              <button class="delete-btn text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700" data-doc-id="${record.id}">Delete</button>
            ` : `
              <button class="recall-btn text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700" data-doc-id="${record.id}">Recall</button>
            `}
          </td>
        `;

        tbody.appendChild(tr);
      });

      attachEventListeners();
      updateBatchButtons();
    }

    function attachEventListeners() {
      document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.addEventListener('change', handleRowSelection);
      });

      document.querySelectorAll('.plan-select').forEach(select => {
        select.addEventListener('change', handlePlanChange);
      });

      document.querySelectorAll('.discount-type-select, .discount-value-input').forEach(input => {
        input.addEventListener('input', handleDiscountChange);
      });

      document.querySelectorAll('.discount-note-input').forEach(input => {
        input.addEventListener('input', handleDiscountNoteChange);
      });

      document.querySelectorAll('.final-total-input').forEach(input => {
        input.addEventListener('input', handleFinalTotalChange);
      });

      document.querySelectorAll('.edit-fees-btn').forEach(btn => {
        btn.addEventListener('click', handleEditFees);
      });

      document.querySelectorAll('.save-btn').forEach(btn => {
        btn.addEventListener('click', handleSave);
      });

      document.querySelectorAll('.lock-btn').forEach(btn => {
        btn.addEventListener('click', handleLock);
      });

      document.querySelectorAll('.publish-btn').forEach(btn => {
        btn.addEventListener('click', handlePublish);
      });

      document.querySelectorAll('.recall-btn').forEach(btn => {
        btn.addEventListener('click', handleRecall);
      });

      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', handleDelete);
      });
    }

    function handleRowSelection(e) {
      const docId = e.target.dataset.docId;
      if (e.target.checked) {
        selectedRows.add(docId);
      } else {
        selectedRows.delete(docId);
      }
      updateBatchButtons();
    }

    function updateBatchButtons() {
      const count = selectedRows.size;
      document.getElementById('selected-count').textContent = `${count} selected`;
      
      const saveBtn = document.getElementById('save-selected-btn');
      const lockBtn = document.getElementById('lock-selected-btn');
      const publishBtn = document.getElementById('publish-selected-btn');
      const recallBtn = document.getElementById('recall-selected-btn');

      saveBtn.disabled = count === 0;
      lockBtn.disabled = count === 0;
      publishBtn.disabled = count === 0;
      recallBtn.disabled = count === 0;
    }

    async function handlePlanChange(e) {
      const docId = e.target.dataset.docId;
      const record = currentRecords.find(r => r.id === docId);
      if (!record) return;

      const plan = allPlans.find(p => p.id === e.target.value);
      if (!plan) return;

      const sessionsByType = sumSessionsByType(
        record.courseTypeIdCache || [],
        record.courseTypeNameCache || [],
        record.courseSessionCounts || []
      );

      record.tuitionPlanId = plan.id;
      record.tuitionPlanName = plan.name;
      record.lines = buildPricingLines(plan.items || [], sessionsByType);
      record.subtotal = calculateSubtotal(plan.items || [], sessionsByType);

      const discountAmount = calculateDiscount(record.subtotal, record.discountType, record.discountValue);
      record.finalTotal = calculateFinalTotal(record.subtotal, discountAmount, record.extraFeesTotal);

      updateRowInPlace(docId);
    }

    async function handleDiscountChange(e) {
      const docId = e.target.dataset.docId;
      const record = currentRecords.find(r => r.id === docId);
      if (!record) return;

      const row = document.querySelector(`tr[data-doc-id="${docId}"]`);
      const typeSelect = row.querySelector('.discount-type-select');
      const valueInput = row.querySelector('.discount-value-input');

      record.discountType = typeSelect.value;
      record.discountValue = parseFloat(valueInput.value) || 0;

      const discountAmount = calculateDiscount(record.subtotal, record.discountType, record.discountValue);
      record.finalTotal = calculateFinalTotal(record.subtotal, discountAmount, record.extraFeesTotal);

      updateRowInPlace(docId);
    }

    async function handleDiscountNoteChange(e) {
      const docId = e.target.dataset.docId;
      const record = currentRecords.find(r => r.id === docId);
      if (!record) return;

      record.discountNote = e.target.value;
    }

    async function handleFinalTotalChange(e) {
      const docId = e.target.dataset.docId;
      const record = currentRecords.find(r => r.id === docId);
      if (!record) return;

      // Remove all dots to get raw number
      const rawValue = e.target.value.replace(/\./g, '');
      const numericValue = parseFloat(rawValue) || 0;
      
      record.finalTotal = numericValue;
      
      // Format with thousand separators
      const formatted = new Intl.NumberFormat('de-DE').format(numericValue);
      
      // Update input with formatted value
      const cursorPos = e.target.selectionStart;
      const oldLength = e.target.value.length;
      e.target.value = formatted;
      
      // Adjust cursor position after formatting
      const newLength = formatted.length;
      const diff = newLength - oldLength;
      e.target.setSelectionRange(cursorPos + diff, cursorPos + diff);
    }

    function updateRowInPlace(docId) {
      const record = currentRecords.find(r => r.id === docId);
      if (!record) return;

      const row = document.querySelector(`tr[data-doc-id="${docId}"]`);
      if (!row) return;

      const subtotalCell = row.cells[5];
      const finalTotalInput = row.querySelector('.final-total-input');
      const pricingSummaryCell = row.cells[4];

      const pricingSummary = (record.lines || []).map(line => {
        return `${line.detail} = ${formatCurrency(line.amount)}`;
      }).join('<br>');

      pricingSummaryCell.innerHTML = `<div class="text-xs">${pricingSummary}</div>`;
      subtotalCell.textContent = formatCurrency(record.subtotal);
      if (finalTotalInput) {
        finalTotalInput.value = record.finalTotal;
      }
    }

    function handleEditFees(e) {
      const docId = e.target.dataset.docId;
      const record = currentRecords.find(r => r.id === docId);
      if (!record) return;

      currentModalDocId = docId;
      document.getElementById('modal-title').textContent = `Extra Fees – ${record.studentName} (${record.studentPublicCode})`;
      
      renderFeesList();
      document.getElementById('fees-modal').classList.remove('hidden');
    }

    function renderFeesList() {
      const feesList = document.getElementById('fees-list');
      const record = currentRecords.find(r => r.id === currentModalDocId);
      const fees = record?.extraFees || [];
      
      feesList.innerHTML = '';
      
      fees.forEach((fee, index) => {
        const feeRow = document.createElement('div');
        feeRow.className = 'flex gap-2 mb-2 items-start';
        feeRow.innerHTML = `
          <input type="text" class="fee-name border border-gray-300 rounded px-2 py-1 text-sm flex-1" placeholder="Fee name" value="${fee.name || ''}" data-fee-index="${index}">
          <input type="number" class="fee-amount border border-gray-300 rounded px-2 py-1 text-sm w-32" placeholder="Amount" value="${fee.amount || 0}" data-fee-index="${index}">
          <input type="text" class="fee-note border border-gray-300 rounded px-2 py-1 text-sm flex-1" placeholder="Note" value="${fee.note || ''}" data-fee-index="${index}">
          <button class="remove-fee-btn px-2 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700" data-fee-index="${index}">Remove</button>
        `;
        feesList.appendChild(feeRow);
      });

      document.querySelectorAll('.fee-name, .fee-amount, .fee-note').forEach(input => {
        input.addEventListener('input', handleFeeInputChange);
      });

      document.querySelectorAll('.remove-fee-btn').forEach(btn => {
        btn.addEventListener('click', handleRemoveFee);
      });
    }

    function handleFeeInputChange(e) {
      const index = parseInt(e.target.dataset.feeIndex);
      const record = currentRecords.find(r => r.id === currentModalDocId);
      if (!record) return;

      const feeRow = e.target.closest('div');
      const nameInput = feeRow.querySelector('.fee-name');
      const amountInput = feeRow.querySelector('.fee-amount');
      const noteInput = feeRow.querySelector('.fee-note');

      record.extraFees[index] = {
        name: nameInput.value,
        amount: parseFloat(amountInput.value) || 0,
        note: noteInput.value
      };
    }

    function handleRemoveFee(e) {
      const index = parseInt(e.target.dataset.feeIndex);
      const record = currentRecords.find(r => r.id === currentModalDocId);
      if (!record) return;

      record.extraFees.splice(index, 1);
      renderFeesList();
    }

    document.getElementById('add-fee-btn').addEventListener('click', () => {
      const record = currentRecords.find(r => r.id === currentModalDocId);
      if (!record) return;

      if (!record.extraFees) {
        record.extraFees = [];
      }
      
      record.extraFees.push({
        name: '',
        amount: 0,
        note: ''
      });
      
      renderFeesList();
    });

    document.getElementById('cancel-fees-btn').addEventListener('click', () => {
      document.getElementById('fees-modal').classList.add('hidden');
    });

    document.getElementById('save-fees-btn').addEventListener('click', async () => {
      const record = currentRecords.find(r => r.id === currentModalDocId);
      if (!record) return;

      const total = (record.extraFees || []).reduce((sum, fee) => sum + (fee.amount || 0), 0);
      record.extraFeesTotal = total;
      
      const discountAmount = calculateDiscount(record.subtotal, record.discountType, record.discountValue);
      record.finalTotal = calculateFinalTotal(record.subtotal, discountAmount, record.extraFeesTotal);

      const row = document.querySelector(`tr[data-doc-id="${currentModalDocId}"]`);
      if (row) {
        const feesCell = row.cells[7];
        const feesList = (record.extraFees || []).map(fee => `<div class="text-xs text-gray-600">${fee.name}: ${formatCurrency(fee.amount)}</div>`).join('');
        feesCell.innerHTML = `
          <button class="edit-fees-btn text-xs text-blue-600 hover:underline mb-1" data-doc-id="${currentModalDocId}">Edit Fees (${record.extraFees.length})</button>
          ${feesList}
          <div class="text-xs text-gray-700 font-medium mt-1">Total: ${formatCurrency(record.extraFeesTotal)}</div>
        `;
        
        const finalTotalInput = row.querySelector('.final-total-input');
        if (finalTotalInput) {
          finalTotalInput.value = record.finalTotal;
        }

        row.querySelector('.edit-fees-btn').addEventListener('click', handleEditFees);
      }
      
      document.getElementById('fees-modal').classList.add('hidden');
    });

    async function handleSave(e) {
      const btn = e.target;
      btn.disabled = true;
      btn.textContent = 'Saving...';

      const docId = btn.dataset.docId;
      const record = currentRecords.find(r => r.id === docId);
      
      if (record) {
        const saveData = { ...record };
        delete saveData.id;
        await db.collection('tuition_calculations').doc(docId).set(saveData);
      }

      btn.disabled = false;
      btn.textContent = 'Save';
    }

    async function handleLock(e) {
      const btn = e.target;
      btn.disabled = true;

      const docId = btn.dataset.docId;
      const record = currentRecords.find(r => r.id === docId);
      
      if (record) {
        record.status = 'locked';
        const saveData = { ...record };
        delete saveData.id;
        await db.collection('tuition_calculations').doc(docId).set(saveData);
        renderTable();
      }
    }

    async function handlePublish(e) {
      const btn = e.target;
      btn.disabled = true;

      const docId = btn.dataset.docId;
      const record = currentRecords.find(r => r.id === docId);
      
      if (record) {
        record.status = 'published';
        const saveData = { ...record };
        delete saveData.id;
        await db.collection('tuition_calculations').doc(docId).set(saveData);
        renderTable();
      }
    }

    async function handleRecall(e) {
      const btn = e.target;
      btn.disabled = true;

      const docId = btn.dataset.docId;
      const record = currentRecords.find(r => r.id === docId);
      
      if (record) {
        record.status = 'locked';
        const saveData = { ...record };
        delete saveData.id;
        await db.collection('tuition_calculations').doc(docId).set(saveData);
        renderTable();
      }
    }

    async function handleDelete(e) {
      const btn = e.target;
      const docId = btn.dataset.docId;
      const record = currentRecords.find(r => r.id === docId);
      
      if (!record) return;

      // Show inline confirmation
      const row = document.querySelector(`tr[data-doc-id="${docId}"]`);
      const actionsCell = row.cells[9];
      
      actionsCell.innerHTML = `
        <div class="text-xs text-red-600 font-medium mb-1">Delete this record?</div>
        <button class="confirm-delete-btn text-xs px-2 py-1 bg-red-600 text-white rounded hover:bg-red-700 mr-1" data-doc-id="${docId}">Confirm</button>
        <button class="cancel-delete-btn text-xs px-2 py-1 bg-gray-300 text-gray-700 rounded hover:bg-gray-400" data-doc-id="${docId}">Cancel</button>
      `;

      // Attach event listeners to new buttons
      actionsCell.querySelector('.confirm-delete-btn').addEventListener('click', async (e) => {
        const confirmBtn = e.target;
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Deleting...';

        await db.collection('tuition_calculations').doc(docId).delete();
        
        // Remove from currentRecords
        const index = currentRecords.findIndex(r => r.id === docId);
        if (index > -1) {
          currentRecords.splice(index, 1);
        }
        
        applyFiltersAndSort();
      });

      actionsCell.querySelector('.cancel-delete-btn').addEventListener('click', () => {
        renderTable();
      });
    }

    document.getElementById('select-all-checkbox').addEventListener('change', (e) => {
      const checkboxes = document.querySelectorAll('.row-checkbox:not([disabled])');
      checkboxes.forEach(cb => {
        cb.checked = e.target.checked;
        if (e.target.checked) {
          selectedRows.add(cb.dataset.docId);
        } else {
          selectedRows.delete(cb.dataset.docId);
        }
      });
      updateBatchButtons();
    });

    document.getElementById('save-selected-btn').addEventListener('click', async () => {
      const btn = document.getElementById('save-selected-btn');
      btn.disabled = true;
      btn.textContent = 'Saving...';

      for (const docId of selectedRows) {
        const record = currentRecords.find(r => r.id === docId);
        if (record) {
          const saveData = { ...record };
          delete saveData.id;
          await db.collection('tuition_calculations').doc(docId).set(saveData);
        }
      }

      btn.disabled = false;
      btn.textContent = 'Save Selected';
    });

    document.getElementById('lock-selected-btn').addEventListener('click', async () => {
      const btn = document.getElementById('lock-selected-btn');
      btn.disabled = true;
      btn.textContent = 'Locking...';

      for (const docId of selectedRows) {
        const record = currentRecords.find(r => r.id === docId);
        if (record && record.status === 'draft') {
          record.status = 'locked';
          const saveData = { ...record };
          delete saveData.id;
          await db.collection('tuition_calculations').doc(docId).set(saveData);
        }
      }

      renderTable();
      btn.disabled = false;
      btn.textContent = 'Lock Selected';
    });

    document.getElementById('publish-selected-btn').addEventListener('click', async () => {
      const btn = document.getElementById('publish-selected-btn');
      btn.disabled = true;
      btn.textContent = 'Publishing...';

      for (const docId of selectedRows) {
        const record = currentRecords.find(r => r.id === docId);
        if (record && record.status === 'locked') {
          record.status = 'published';
          const saveData = { ...record };
          delete saveData.id;
          await db.collection('tuition_calculations').doc(docId).set(saveData);
        }
      }

      renderTable();
      btn.disabled = false;
      btn.textContent = 'Publish Selected';
    });

    document.getElementById('recall-selected-btn').addEventListener('click', async () => {
      const btn = document.getElementById('recall-selected-btn');
      btn.disabled = true;
      btn.textContent = 'Recalling...';

      for (const docId of selectedRows) {
        const record = currentRecords.find(r => r.id === docId);
        if (record && record.status === 'published') {
          record.status = 'locked';
          const saveData = { ...record };
          delete saveData.id;
          await db.collection('tuition_calculations').doc(docId).set(saveData);
        }
      }

      renderTable();
      btn.disabled = false;
      btn.textContent = 'Recall Selected';
    });

    document.getElementById('recalc-all-btn').addEventListener('click', async () => {
      const btn = document.getElementById('recalc-all-btn');
      btn.disabled = true;
      btn.textContent = 'Recalculating...';

      for (const record of currentRecords) {
        if (record.status === 'published') continue;

        const plan = allPlans.find(p => p.id === record.tuitionPlanId);
        if (plan) {
          const sessionsByType = sumSessionsByType(
            record.courseTypeIdCache || [],
            record.courseTypeNameCache || [],
            record.courseSessionCounts || []
          );

          record.lines = buildPricingLines(plan.items || [], sessionsByType);
          record.subtotal = calculateSubtotal(plan.items || [], sessionsByType);
          const discountAmount = calculateDiscount(record.subtotal, record.discountType, record.discountValue);
          record.finalTotal = calculateFinalTotal(record.subtotal, discountAmount, record.extraFeesTotal);
          
          const saveData = { ...record };
          delete saveData.id;
          await db.collection('tuition_calculations').doc(record.id).set(saveData);
        }
      }

      applyFiltersAndSort();
      btn.disabled = false;
      btn.textContent = 'Recalculate All';
    });

    document.getElementById('load-data-btn').addEventListener('click', handleLoadData);

    document.getElementById('search-input').addEventListener('input', applyFiltersAndSort);
    document.getElementById('status-filter').addEventListener('change', applyFiltersAndSort);
    document.getElementById('student-status-filter').addEventListener('change', applyFiltersAndSort);
    document.getElementById('plan-filter').addEventListener('change', applyFiltersAndSort);
    document.getElementById('sort-select').addEventListener('change', applyFiltersAndSort);

    document.getElementById('debug-toggle').addEventListener('click', () => {
      const content = document.getElementById('debug-content');
      const icon = document.getElementById('debug-icon');
      content.classList.toggle('hidden');
      icon.textContent = content.classList.contains('hidden') ? '▼' : '▲';
    });

    document.getElementById('blueprint-toggle').addEventListener('click', () => {
      const content = document.getElementById('blueprint-table-content');
      const icon = document.getElementById('blueprint-icon');
      content.classList.toggle('hidden');
      icon.textContent = content.classList.contains('hidden') ? '▼' : '▲';
    });

    async function init() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['page_title', config.page_title || defaultConfig.page_title],
            ['page_subtitle', config.page_subtitle || defaultConfig.page_subtitle]
          ])
        });
      }

      await loadFirestoreData();
      
      // Set current month and year as defaults
      const now = new Date();
      document.getElementById('year-select').value = now.getFullYear().toString();
      document.getElementById('month-select').value = (now.getMonth() + 1).toString();
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9beb61a783be04d3',t:'MTc2ODU0MzExMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>