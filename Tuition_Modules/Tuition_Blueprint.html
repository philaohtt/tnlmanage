<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tuition Blueprint Schema</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script><!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div class="w-full h-full overflow-auto" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
   <div class="w-full min-h-full px-4 py-6">
    <div class="max-w-6xl mx-auto"><!-- Header -->
     <div class="text-center mb-6">
      <h1 id="mainTitle" class="text-white font-bold mb-2" style="font-size: 28px;">Tuition Blueprint Schema</h1>
      <p id="subtitle" class="text-white opacity-90" style="font-size: 14px;">Collection: tuition_blueprint</p>
     </div><!-- Tab Navigation -->
     <div class="bg-white rounded-lg shadow-xl mb-4 overflow-hidden">
      <div class="flex border-b border-gray-200"><button id="schemaTab" class="flex-1 px-4 py-2 font-semibold text-indigo-600 bg-indigo-50 border-b-2 border-indigo-600 transition-colors text-sm" onclick="switchTab('schema')"> Schema Definition </button> <button id="dataTab" class="flex-1 px-4 py-2 font-semibold text-gray-600 hover:bg-gray-50 transition-colors text-sm" onclick="switchTab('data')"> Live Data </button>
      </div>
     </div><!-- Schema View -->
     <div id="schemaView"><!-- Document ID Pattern Card -->
      <div class="bg-white rounded-lg shadow p-4 mb-4">
       <h2 class="font-bold text-gray-800 mb-2 text-base">Document ID Pattern</h2>
       <div class="bg-indigo-50 border-l-4 border-indigo-500 p-3 rounded"><code class="text-indigo-700 font-semibold text-sm">TBP_&lt;YEAR&gt;_&lt;MM&gt;_&lt;STUDENT_PUBLIC_CODE&gt;</code>
        <p class="text-gray-600 mt-1 text-xs">Example: TBP_2026_03_ST001234</p>
       </div>
      </div><!-- Schema Table -->
      <div class="bg-white rounded-lg shadow overflow-hidden">
       <table class="w-full">
        <thead>
         <tr class="bg-indigo-600 text-white">
          <th class="px-3 py-2 text-left font-semibold text-xs" style="width: 25%;">Field Name</th>
          <th class="px-3 py-2 text-left font-semibold text-xs" style="width: 15%;">Type</th>
          <th class="px-3 py-2 text-left font-semibold text-xs" style="width: 45%;">Description</th>
          <th class="px-3 py-2 text-left font-semibold text-xs" style="width: 15%;">Category</th>
         </tr>
        </thead>
        <tbody><!-- Identity Section -->
         <tr class="bg-purple-50">
          <td colspan="4" class="px-3 py-2 font-semibold text-purple-900 text-xs">Identity</td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">studentId</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">string</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Reference to students.docId</td>
          <td class="px-3 py-2"><span class="inline-block bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full text-xs font-medium">Identity</span></td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">studentPublicCode</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">string</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Public identifier from students.publicCode</td>
          <td class="px-3 py-2"><span class="inline-block bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full text-xs font-medium">Identity</span></td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">studentNameCache</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">string</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Cached full name from students.fullName</td>
          <td class="px-3 py-2"><span class="inline-block bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full text-xs font-medium">Identity</span></td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">classId</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">string | null</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Reference to students.classId (nullable)</td>
          <td class="px-3 py-2"><span class="inline-block bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full text-xs font-medium">Identity</span></td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">classNameCache</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">string | null</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Cached class name from classes.name (nullable)</td>
          <td class="px-3 py-2"><span class="inline-block bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full text-xs font-medium">Identity</span></td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">studentStatus</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">string</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Current status from students.status</td>
          <td class="px-3 py-2"><span class="inline-block bg-purple-100 text-purple-800 px-2 py-0.5 rounded-full text-xs font-medium">Identity</span></td>
         </tr><!-- Time Scope Section -->
         <tr class="bg-blue-50">
          <td colspan="4" class="px-3 py-2 font-semibold text-blue-900 text-xs">Time Scope</td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">year</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">number</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Year (e.g., 2026)</td>
          <td class="px-3 py-2"><span class="inline-block bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs font-medium">Time</span></td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">month</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">number</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Month (1–12)</td>
          <td class="px-3 py-2"><span class="inline-block bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs font-medium">Time</span></td>
         </tr><!-- Academic Load Section -->
         <tr class="bg-green-50">
          <td colspan="4" class="px-3 py-2 font-semibold text-green-900 text-xs">Academic Load</td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">courseIds</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">string[]</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Array of course IDs taken in this month</td>
          <td class="px-3 py-2"><span class="inline-block bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs font-medium">Academic</span></td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">courseNameCache</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">string[]</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Cached course names for fast UI rendering</td>
          <td class="px-3 py-2"><span class="inline-block bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs font-medium">Academic</span></td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">courseLabels</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">string[]</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Cached course public codes (same index as courseIds)</td>
          <td class="px-3 py-2"><span class="inline-block bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs font-medium">Academic</span></td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">courseTypeIdCache</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">string[]</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Cached course type IDs (same index as courseIds)</td>
          <td class="px-3 py-2"><span class="inline-block bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs font-medium">Academic</span></td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">courseTypeNameCache</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">string[]</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Cached course type names (same index as courseIds)</td>
          <td class="px-3 py-2"><span class="inline-block bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs font-medium">Academic</span></td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">coursePricingMethodCache</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">string[]</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Cached pricing methods: "per_session" or "per_month" (same index)</td>
          <td class="px-3 py-2"><span class="inline-block bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs font-medium">Academic</span></td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">courseSessionCounts</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">number[]</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Per-course attended sessions (same index as courseIds)</td>
          <td class="px-3 py-2"><span class="inline-block bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs font-medium">Academic</span></td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">sessionCount</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">number</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Total attended sessions (sum of courseSessionCounts)</td>
          <td class="px-3 py-2"><span class="inline-block bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs font-medium">Academic</span></td>
         </tr><!-- Pricing Section -->
         <tr class="bg-yellow-50">
          <td colspan="4" class="px-3 py-2 font-semibold text-yellow-900 text-xs">Pricing</td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">tuitionPlanId</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">string | null</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Reference to tuition_plans.docId (nullable)</td>
          <td class="px-3 py-2"><span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full text-xs font-medium">Pricing</span></td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">tuitionPlanNameCache</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">string | null</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Cached tuition plan name (nullable)</td>
          <td class="px-3 py-2"><span class="inline-block bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full text-xs font-medium">Pricing</span></td>
         </tr><!-- System Section -->
         <tr class="bg-gray-50">
          <td colspan="4" class="px-3 py-2 font-semibold text-gray-900 text-xs">System</td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">status</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">string</td>
          <td class="px-3 py-2 text-gray-600 text-xs">"draft" (editable) or "locked" (finalized)</td>
          <td class="px-3 py-2"><span class="inline-block bg-gray-200 text-gray-800 px-2 py-0.5 rounded-full text-xs font-medium">System</span></td>
         </tr>
         <tr class="border-b border-gray-200 hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">createdAt</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">timestamp</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Document creation timestamp</td>
          <td class="px-3 py-2"><span class="inline-block bg-gray-200 text-gray-800 px-2 py-0.5 rounded-full text-xs font-medium">System</span></td>
         </tr>
         <tr class="hover:bg-gray-50 transition-colors">
          <td class="px-3 py-2"><code class="text-indigo-600 font-medium text-xs">updatedAt</code></td>
          <td class="px-3 py-2 text-gray-700 text-xs">timestamp</td>
          <td class="px-3 py-2 text-gray-600 text-xs">Last update timestamp</td>
          <td class="px-3 py-2"><span class="inline-block bg-gray-200 text-gray-800 px-2 py-0.5 rounded-full text-xs font-medium">System</span></td>
         </tr>
        </tbody>
       </table>
      </div>
     </div><!-- Data View -->
     <div id="dataView" style="display: none;"><!-- Time Selector and Actions -->
      <div class="bg-white rounded-lg shadow p-4 mb-4">
       <div class="flex flex-wrap items-center gap-2 mb-3">
        <div class="flex items-center gap-1"><label class="font-semibold text-gray-700 text-xs">Year:</label> <select id="yearSelect" class="px-2 py-1 border border-gray-300 rounded text-xs focus:outline-none focus:ring-2 focus:ring-indigo-500" onchange="loadSavedMonths()"> <!-- Will be populated by JS --> </select>
        </div>
        <div class="flex items-center gap-1"><label class="font-semibold text-gray-700 text-xs">Month:</label> <select id="monthSelect" class="px-2 py-1 border border-gray-300 rounded text-xs focus:outline-none focus:ring-2 focus:ring-indigo-500" onchange="updateSavedMonthsIndicator()"> <option value="1">January</option> <option value="2">February</option> <option value="3">March</option> <option value="4">April</option> <option value="5">May</option> <option value="6">June</option> <option value="7">July</option> <option value="8">August</option> <option value="9">September</option> <option value="10">October</option> <option value="11">November</option> <option value="12">December</option> </select>
         <div id="savedIndicator" class="hidden px-2 py-0.5 bg-green-100 text-green-800 rounded-full text-xs font-semibold">
          ✓ Has data
         </div>
        </div>
        <div class="flex items-center gap-1"><label class="font-semibold text-gray-700 text-xs">Class:</label> <select id="classSelect" class="px-2 py-1 border border-gray-300 rounded text-xs focus:outline-none focus:ring-2 focus:ring-indigo-500"> <option value="">All Classes</option> <!-- Will be populated by JS --> </select>
        </div>
        <div class="flex items-center gap-1"><label class="font-semibold text-gray-700 text-xs"> <input type="checkbox" id="activeOnlyCheckbox" onchange="filterStudents()" class="mr-1 cursor-pointer"> Active only </label>
        </div>
        <div class="flex-1"></div><button id="loadBtn" onclick="loadDataForPeriod()" class="px-3 py-1 bg-blue-600 text-white rounded font-semibold hover:bg-blue-700 transition-colors text-xs"> Load </button> <button id="refreshBtn" onclick="refreshPeriod()" class="px-3 py-1 bg-orange-600 text-white rounded font-semibold hover:bg-orange-700 transition-colors text-xs"> Refresh </button>
        <div class="h-4 w-px bg-gray-300"></div><button id="saveSelectedBtn" onclick="saveSelected()" class="px-3 py-1 bg-green-600 text-white rounded font-semibold hover:bg-green-700 transition-colors text-xs"> Save </button> <button id="lockSelectedBtn" onclick="lockSelected()" class="px-3 py-1 bg-purple-600 text-white rounded font-semibold hover:bg-purple-700 transition-colors text-xs"> Lock </button> <button id="unlockSelectedBtn" onclick="unlockSelected()" class="px-3 py-1 bg-yellow-600 text-white rounded font-semibold hover:bg-yellow-700 transition-colors text-xs"> Unlock </button>
       </div><!-- Saved Months Grid -->
       <div class="pt-3 border-t border-gray-200">
        <div class="flex items-center justify-between mb-2">
         <h4 class="font-semibold text-gray-700 text-xs">Months with saved data:</h4><button onclick="loadSavedMonths()" class="text-indigo-600 hover:text-indigo-800 text-xs font-medium"> Refresh </button>
        </div>
        <div id="savedMonthsGrid" class="grid grid-cols-12 gap-1"><!-- Will be populated by JS -->
        </div>
       </div>
       <div id="statusMessage" class="mt-3 hidden"></div>
      </div><!-- Data Table -->
      <div class="bg-white rounded-lg shadow overflow-hidden">
       <div class="overflow-x-auto">
        <table class="w-full">
         <thead>
          <tr class="bg-indigo-600 text-white">
           <th class="px-2 py-2 text-center font-semibold text-xs" style="width: 40px;"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" class="w-3 h-3 cursor-pointer"></th>
           <th class="px-2 py-2 text-left font-semibold text-xs" style="width: 18%;">Student</th>
           <th class="px-2 py-2 text-left font-semibold text-xs" style="width: 12%;"><button onclick="loadAllClasses()" class="hover:bg-indigo-700 px-1 py-0.5 rounded transition-colors"> Class &amp; Status </button></th>
           <th class="px-2 py-2 text-left font-semibold text-xs" style="width: 30%;"><button onclick="loadAllCourses()" class="hover:bg-indigo-700 px-1 py-0.5 rounded transition-colors"> Courses </button></th>
           <th class="px-2 py-2 text-left font-semibold text-xs" style="width: 10%;"><button onclick="loadAllAttendance()" class="hover:bg-indigo-700 px-1 py-0.5 rounded transition-colors"> Attendance </button></th>
           <th class="px-2 py-2 text-left font-semibold text-xs" style="width: 15%;">Plan</th>
           <th class="px-2 py-2 text-center font-semibold text-xs" style="width: 12%;">Actions</th>
          </tr>
         </thead>
         <tbody id="dataTableBody">
          <tr>
           <td colspan="7" class="px-4 py-6 text-center text-gray-500 text-sm">Select a year and month, then click Load to view data</td>
          </tr>
         </tbody>
        </table>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div><!-- Attendance Details Modal -->
  <div id="attendanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center" style="z-index: 1000;">
   <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl mx-4" style="max-height: 80vh; overflow: hidden; display: flex; flex-direction: column;"><!-- Modal Header -->
    <div class="px-4 py-3 border-b border-gray-200 bg-indigo-600 text-white flex items-center justify-between">
     <h3 id="modalTitle" class="font-bold text-base">Attendance Details</h3><button onclick="closeAttendanceModal()" class="text-white hover:text-gray-200 transition-colors text-xl"> × </button>
    </div><!-- Modal Body -->
    <div class="px-4 py-3 overflow-auto" style="flex: 1;">
     <div id="modalContent"><!-- Content will be populated by JS -->
     </div>
    </div><!-- Modal Footer -->
    <div class="px-4 py-3 border-t border-gray-200 bg-gray-50 flex justify-end"><button onclick="closeAttendanceModal()" class="px-4 py-1 bg-gray-600 text-white rounded font-semibold hover:bg-gray-700 transition-colors text-xs"> Close </button>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      main_title: "Tuition Blueprint Schema",
      subtitle: "Collection: tuition_blueprint",
      background_color: "#f9fafb",
      secondary_color: "#ffffff",
      surface_color: "#ffffff",
      text_color: "#1f2937",
      accent_color: "#4f46e5"
    };

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCDzv0HseeLfijzyXZjKWFh9QaLrMB4afo",
      authDomain: "tnl2026.firebaseapp.com",
      projectId: "tnl2026",
      storageBucket: "tnl2026.firebasestorage.app",
      messagingSenderId: "883525152224",
      appId: "1:883525152224:web:619ae152cd8df3fcca8f85",
      measurementId: "G-3K6LXCKHZ9"
    };

    // Initialize Firebase
    let db;
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    db = firebase.firestore();

    // Load real data from Firestore
    async function loadTuitionBlueprints() {
      const tbody = document.querySelector('tbody');
      const loadingRow = document.createElement('tr');
      loadingRow.innerHTML = `
        <td colspan="4" class="px-4 py-6 text-center">
          <div class="flex items-center justify-center">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"></div>
            <span class="ml-2 text-gray-600 text-sm">Loading data from Firebase...</span>
          </div>
        </td>
      `;
      tbody.appendChild(loadingRow);

      try {
        const snapshot = await db.collection('tuition_blueprint').limit(10).get();
        
        // Remove loading row
        loadingRow.remove();

        if (snapshot.empty) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = `
            <td colspan="4" class="px-4 py-6 text-center text-gray-500 text-sm">
              No tuition blueprint documents found in the database.
            </td>
          `;
          tbody.appendChild(emptyRow);
          return;
        }

        // Display real data
        snapshot.forEach(doc => {
          const data = doc.data();
          const dataRow = document.createElement('tr');
          dataRow.className = 'bg-indigo-50 border-b border-indigo-200';
          dataRow.innerHTML = `
            <td colspan="4" class="px-4 py-3">
              <div class="space-y-2">
                <div class="flex items-center justify-between">
                  <h3 class="font-bold text-indigo-900 text-sm">Document: ${doc.id}</h3>
                  <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium ${data.status === 'locked' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${data.status || 'N/A'}</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2 text-xs">
                  <div><span class="font-semibold text-gray-700">Student:</span> <span class="text-gray-600">${data.studentNameCache || 'N/A'}</span></div>
                  <div><span class="font-semibold text-gray-700">Public Code:</span> <span class="text-gray-600">${data.studentPublicCode || 'N/A'}</span></div>
                  <div><span class="font-semibold text-gray-700">Class:</span> <span class="text-gray-600">${data.classNameCache || 'N/A'}</span></div>
                  <div><span class="font-semibold text-gray-700">Period:</span> <span class="text-gray-600">${data.year || 'N/A'}/${String(data.month || '').padStart(2, '0')}</span></div>
                  <div><span class="font-semibold text-gray-700">Sessions:</span> <span class="text-gray-600">${data.sessionCount || 0}</span></div>
                  <div><span class="font-semibold text-gray-700">Courses:</span> <span class="text-gray-600">${data.courseIds ? data.courseIds.length : 0}</span></div>
                  <div><span class="font-semibold text-gray-700">Tuition Plan:</span> <span class="text-gray-600">${data.tuitionPlanNameCache || 'N/A'}</span></div>
                  <div><span class="font-semibold text-gray-700">Student Status:</span> <span class="text-gray-600">${data.studentStatus || 'N/A'}</span></div>
                </div>
                ${data.courseNameCache && data.courseNameCache.length > 0 ? `
                  <div class="mt-1">
                    <span class="font-semibold text-gray-700 text-xs">Course Names:</span>
                    <div class="flex flex-wrap gap-1 mt-1">
                      ${data.courseNameCache.map(course => `<span class="inline-block bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded text-xs">${course}</span>`).join('')}
                    </div>
                  </div>
                ` : ''}
              </div>
            </td>
          `;
          tbody.appendChild(dataRow);
        });

      } catch (error) {
        loadingRow.remove();
        const errorRow = document.createElement('tr');
        errorRow.innerHTML = `
          <td colspan="4" class="px-4 py-6 text-center text-red-600 text-sm">
            Error loading data: ${error.message}
          </td>
        `;
        tbody.appendChild(errorRow);
        console.error('Firebase error:', error);
      }
    }

    async function onConfigChange(config) {
      // Config changes handled by parent dashboard
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              config.background_color = value;
              window.elementSdk.setConfig({ background_color: value });
            }
          },
          {
            get: () => config.accent_color || defaultConfig.accent_color,
            set: (value) => {
              config.accent_color = value;
              window.elementSdk.setConfig({ accent_color: value });
            }
          }
        ],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["main_title", config.main_title || defaultConfig.main_title],
        ["subtitle", config.subtitle || defaultConfig.subtitle]
      ]);
    }

    // Tab switching
    function switchTab(tab) {
      const schemaTab = document.getElementById('schemaTab');
      const dataTab = document.getElementById('dataTab');
      const schemaView = document.getElementById('schemaView');
      const dataView = document.getElementById('dataView');

      if (tab === 'schema') {
        schemaTab.className = 'flex-1 px-4 py-2 font-semibold text-indigo-600 bg-indigo-50 border-b-2 border-indigo-600 transition-colors text-sm';
        dataTab.className = 'flex-1 px-4 py-2 font-semibold text-gray-600 hover:bg-gray-50 transition-colors text-sm';
        schemaView.style.display = 'block';
        dataView.style.display = 'none';
      } else {
        schemaTab.className = 'flex-1 px-4 py-2 font-semibold text-gray-600 hover:bg-gray-50 transition-colors text-sm';
        dataTab.className = 'flex-1 px-4 py-2 font-semibold text-indigo-600 bg-indigo-50 border-b-2 border-indigo-600 transition-colors text-sm';
        schemaView.style.display = 'none';
        dataView.style.display = 'block';
        
        // Load saved months grid when switching to data tab
        loadSavedMonths();
      }
    }

    // Store loaded data
    let currentStudentData = [];
    let allStudentData = []; // Store unfiltered data
    let existingBlueprints = new Map();
    let allClasses = new Map(); // Store class data
    let allCourseTypes = new Map(); // Store course type data
    let allTuitionPlans = []; // Store tuition plans
    let savedMonthsCache = new Set(); // Cache which year-month combinations have data
    let currentLoadedPeriod = null; // Track current loaded period to prevent unnecessary reloads

    // Initialize class selector
    async function initializeClassSelector() {
      try {
        const classSelect = document.getElementById('classSelect');
        const classesSnapshot = await db.collection('classes').get();
        
        classesSnapshot.forEach(doc => {
          const classData = doc.data();
          allClasses.set(doc.id, classData.name || 'Unnamed Class');
          
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = classData.name || 'Unnamed Class';
          classSelect.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading classes:', error);
      }
    }

    // Initialize course types
    async function initializeCourseTypes() {
      try {
        const courseTypesSnapshot = await db.collection('course_types').get();
        
        courseTypesSnapshot.forEach(doc => {
          const typeData = doc.data();
          allCourseTypes.set(doc.id, {
            name: typeData.name || 'Unnamed Type',
            pricingMethod: typeData.pricingMethod || 'per_session',
            description: typeData.description || '',
            status: typeData.status || 'active'
          });
        });
      } catch (error) {
        console.error('Error loading course types:', error);
      }
    }

    // Initialize tuition plans
    async function initializeTuitionPlans() {
      try {
        const plansSnapshot = await db.collection('tuition_plans')
          .where('status', '==', 'active')
          .get();
        
        allTuitionPlans = [];
        plansSnapshot.forEach(doc => {
          const planData = doc.data();
          allTuitionPlans.push({
            id: doc.id,
            name: planData.name || 'Unnamed Plan',
            items: planData.items || [],
            totalPrice: planData.totalPrice || 0,
            status: planData.status || 'active'
          });
        });
      } catch (error) {
        console.error('Error loading tuition plans:', error);
      }
    }

    // Get courses and attendance for a student in a specific month
    async function getCoursesAndAttendance(studentId, year, month) {
      try {
        // Step 1: Get student's enrolled courses
        const enrollmentSnapshot = await db.collection('course_enrollments')
          .where('studentId', '==', studentId)
          .get();
        
        const courseIds = [];
        enrollmentSnapshot.forEach(doc => {
          const enrollment = doc.data();
          if (enrollment.courseId) {
            courseIds.push(enrollment.courseId);
          }
        });

        if (courseIds.length === 0) {
          return { courseIds: [], courseNames: [], sessionCount: 0, courseDetails: [] };
        }

        // Step 2: Get ALL course info (including archived/finished courses)
        const coursesMap = new Map();
        
        for (const courseId of courseIds) {
          const courseDoc = await db.collection('courses').doc(courseId).get();
          if (courseDoc.exists) {
            const course = courseDoc.data();
            
            // Get course type info
            let courseTypeName = 'N/A';
            let courseTypePricingMethod = 'per_session';
            if (course.courseTypeId && allCourseTypes.has(course.courseTypeId)) {
              const typeInfo = allCourseTypes.get(course.courseTypeId);
              courseTypeName = typeInfo.name;
              courseTypePricingMethod = typeInfo.pricingMethod;
            }
            
            coursesMap.set(courseId, {
              id: courseId,
              name: course.name || 'Unnamed Course',
              publicCode: course.publicCode || course.code || 'N/A',
              status: course.status,
              courseTypeId: course.courseTypeId || null,
              courseTypeName: courseTypeName,
              courseTypePricingMethod: courseTypePricingMethod
            });
          }
        }

        if (coursesMap.size === 0) {
          return { courseIds: [], courseNames: [], sessionCount: 0, courseDetails: [] };
        }

        // Step 3: Get sessions in the selected month for ALL enrolled courses
        const startDate = new Date(year, month - 1, 1);
        const endDate = new Date(year, month, 0, 23, 59, 59);
        
        const sessionsByCourse = new Map(); // courseId -> [sessionIds]
        
        // Process courses in batches of 10 due to Firestore 'in' limit
        const allCourseIds = Array.from(coursesMap.keys());
        for (let i = 0; i < allCourseIds.length; i += 10) {
          const batchCourseIds = allCourseIds.slice(i, i + 10);
          
          const sessionsSnapshot = await db.collection('course_sessions')
            .where('courseId', 'in', batchCourseIds)
            .get();

          sessionsSnapshot.forEach(doc => {
            const session = doc.data();
            // Skip cancelled sessions
            if (session.sessionStatus === 'cancelled') {
              return;
            }

            // Check if session is in the target month
            let sessionDate;
            if (session.sessionDate && session.sessionDate.toDate) {
              sessionDate = session.sessionDate.toDate();
            } else if (session.sessionDate) {
              sessionDate = new Date(session.sessionDate);
            } else {
              return;
            }

            if (sessionDate >= startDate && sessionDate <= endDate) {
              if (!sessionsByCourse.has(session.courseId)) {
                sessionsByCourse.set(session.courseId, []);
              }
              sessionsByCourse.get(session.courseId).push(doc.id);
            }
          });
        }

        if (sessionsByCourse.size === 0) {
          return { courseIds: [], courseNames: [], sessionCount: 0, courseDetails: [] };
        }

        // Step 4: Get attendance for the student for each course
        const courseDetails = [];
        const attendanceRecords = []; // Store detailed attendance records
        let totalAttendedCount = 0;
        
        for (const [courseId, sessionIds] of sessionsByCourse.entries()) {
          let courseAttendedCount = 0;
          
          // Process in batches of 10 due to Firestore 'in' query limit
          for (let i = 0; i < sessionIds.length; i += 10) {
            const batchSessionIds = sessionIds.slice(i, i + 10);
            
            const attendanceSnapshot = await db.collection('attendance')
              .where('studentId', '==', studentId)
              .where('sessionId', 'in', batchSessionIds)
              .get();

            for (const doc of attendanceSnapshot.docs) {
              const attendance = doc.data();
              // Count present and late as attended (excused doesn't count toward session count)
              if (attendance.status === 'present' || attendance.status === 'late') {
                courseAttendedCount++;
              }
              
              // Get session details for ALL attendance records (present, late, absent, excused)
              if (attendance.status === 'present' || attendance.status === 'late' || attendance.status === 'absent' || attendance.status === 'excused') {
                const sessionDoc = await db.collection('course_sessions').doc(attendance.sessionId).get();
                if (sessionDoc.exists) {
                  const session = sessionDoc.data();
                  let sessionDate = null;
                  if (session.sessionDate && session.sessionDate.toDate) {
                    sessionDate = session.sessionDate.toDate();
                  } else if (session.sessionDate) {
                    sessionDate = new Date(session.sessionDate);
                  }
                  
                  const courseInfo = coursesMap.get(courseId);
                  attendanceRecords.push({
                    courseId: courseId,
                    courseName: courseInfo.name,
                    coursePublicCode: courseInfo.publicCode,
                    sessionId: attendance.sessionId,
                    sessionDate: sessionDate,
                    status: attendance.status,
                    sessionTitle: session.title || 'Untitled Session'
                  });
                }
              }
            }
          }
          
          // Only include courses with attendance data in the month
          if (courseAttendedCount > 0) {
            const courseInfo = coursesMap.get(courseId);
            courseDetails.push({
              courseId: courseId,
              courseName: courseInfo.name,
              coursePublicCode: courseInfo.publicCode,
              courseTypeId: courseInfo.courseTypeId,
              courseTypeName: courseInfo.courseTypeName,
              courseTypePricingMethod: courseInfo.courseTypePricingMethod,
              sessionCount: courseAttendedCount
            });
            totalAttendedCount += courseAttendedCount;
          }
        }
        
        // Sort attendance records by date (most recent first)
        attendanceRecords.sort((a, b) => {
          if (!a.sessionDate || !b.sessionDate) return 0;
          return b.sessionDate - a.sessionDate;
        });

        // Build final arrays with only courses that have attendance
        const finalCourseIds = courseDetails.map(c => c.courseId);
        const finalCourseNames = courseDetails.map(c => c.courseName);
        const finalCourseLabels = courseDetails.map(c => c.coursePublicCode);

        return {
          courseIds: finalCourseIds,
          courseNames: finalCourseNames,
          courseLabels: finalCourseLabels,
          sessionCount: totalAttendedCount,
          courseDetails: courseDetails,
          attendanceRecords: attendanceRecords
        };

      } catch (error) {
        console.error('Error fetching courses and attendance:', error);
        return { courseIds: [], courseNames: [], courseLabels: [], sessionCount: 0, courseDetails: [], attendanceRecords: [] };
      }
    }

    // Initialize year selector
    function initializeYearSelector() {
      const yearSelect = document.getElementById('yearSelect');
      const currentYear = new Date().getFullYear();
      for (let year = currentYear - 2; year <= currentYear + 2; year++) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        if (year === currentYear) option.selected = true;
        yearSelect.appendChild(option);
      }
    }

    // Initialize month selector to current month
    function initializeMonthSelector() {
      const monthSelect = document.getElementById('monthSelect');
      const currentMonth = new Date().getMonth() + 1;
      monthSelect.value = currentMonth;
    }

    // Load saved months from database
    async function loadSavedMonths() {
      const year = parseInt(document.getElementById('yearSelect').value);
      const grid = document.getElementById('savedMonthsGrid');
      
      grid.innerHTML = '<div class="col-span-12 text-center text-gray-500 text-xs">Loading...</div>';
      
      try {
        // Clear cache for this year
        for (let m = 1; m <= 12; m++) {
          const key = `${year}-${m}`;
          savedMonthsCache.delete(key);
        }
        
        const snapshot = await db.collection('tuition_blueprint')
          .where('year', '==', year)
          .get();
        
        // Count documents per month
        const monthCounts = new Map();
        snapshot.forEach(doc => {
          const data = doc.data();
          const key = `${data.year}-${data.month}`;
          monthCounts.set(data.month, (monthCounts.get(data.month) || 0) + 1);
          savedMonthsCache.add(key);
        });
        
        // Create month buttons
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        grid.innerHTML = '';
        
        for (let month = 1; month <= 12; month++) {
          const count = monthCounts.get(month) || 0;
          const hasSaved = count > 0;
          const isCurrentMonth = parseInt(document.getElementById('monthSelect').value) === month;
          
          const button = document.createElement('button');
          button.className = `px-2 py-1 rounded text-xs font-medium transition-colors ${
            hasSaved 
              ? (isCurrentMonth ? 'bg-indigo-600 text-white' : 'bg-green-100 text-green-800 hover:bg-green-200')
              : 'bg-gray-100 text-gray-400'
          }`;
          button.textContent = `${monthNames[month - 1]}${hasSaved ? ` (${count})` : ''}`;
          button.title = hasSaved ? `${count} blueprints saved` : 'No saved data';
          
          if (hasSaved) {
            button.onclick = () => {
              document.getElementById('monthSelect').value = month;
              updateSavedMonthsIndicator();
              loadDataForPeriod();
            };
          } else {
            button.disabled = true;
            button.style.cursor = 'not-allowed';
          }
          
          grid.appendChild(button);
        }
        
        updateSavedMonthsIndicator();
        
      } catch (error) {
        grid.innerHTML = `<div class="col-span-12 text-center text-red-500 text-xs">Error: ${error.message}</div>`;
        console.error('Error loading saved months:', error);
      }
    }

    // Update the saved indicator next to month selector
    function updateSavedMonthsIndicator() {
      const year = parseInt(document.getElementById('yearSelect').value);
      const month = parseInt(document.getElementById('monthSelect').value);
      const key = `${year}-${month}`;
      const indicator = document.getElementById('savedIndicator');
      
      if (savedMonthsCache.has(key)) {
        indicator.classList.remove('hidden');
      } else {
        indicator.classList.add('hidden');
      }
    }

    // Show status message
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('statusMessage');
      const colors = {
        info: 'bg-blue-50 text-blue-800 border-blue-200',
        success: 'bg-green-50 text-green-800 border-green-200',
        error: 'bg-red-50 text-red-800 border-red-200',
        warning: 'bg-yellow-50 text-yellow-800 border-yellow-200'
      };
      statusDiv.className = `mt-3 p-3 rounded border text-xs ${colors[type]}`;
      statusDiv.textContent = message;
      statusDiv.classList.remove('hidden');
      setTimeout(() => statusDiv.classList.add('hidden'), 5000);
    }

    // Load data for selected period (checks existing documents first)
    async function loadDataForPeriod() {
      const year = parseInt(document.getElementById('yearSelect').value);
      const month = parseInt(document.getElementById('monthSelect').value);
      const selectedClassId = document.getElementById('classSelect').value;
      const periodKey = `${year}-${month}-${selectedClassId}`;
      
      const tbody = document.getElementById('dataTableBody');
      
      tbody.innerHTML = `
        <tr>
          <td colspan="7" class="px-4 py-6 text-center">
            <div class="flex items-center justify-center">
              <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"></div>
              <span class="ml-2 text-gray-600 text-sm">Loading data...</span>
            </div>
          </td>
        </tr>
      `;

      try {
        // Load existing blueprints for this period
        existingBlueprints.clear();
        const blueprintSnapshot = await db.collection('tuition_blueprint')
          .where('year', '==', year)
          .where('month', '==', month)
          .get();
        
        const studentsWithBlueprints = new Map();
        blueprintSnapshot.forEach(doc => {
          const data = doc.data();
          studentsWithBlueprints.set(data.studentId, { id: doc.id, ...data });
          existingBlueprints.set(data.studentId, { id: doc.id, ...data });
        });

        // Load students with optional class filter
        let studentsQuery = db.collection('students');
        if (selectedClassId) {
          studentsQuery = studentsQuery.where('classId', '==', selectedClassId);
        }
        const studentsSnapshot = await studentsQuery.get();
        currentStudentData = [];

        for (const studentDoc of studentsSnapshot.docs) {
          const student = { id: studentDoc.id, ...studentDoc.data() };
          
          // Get class name from cache or set to null
          let className = allClasses.get(student.classId) || null;

          // Check if this student has an existing blueprint
          const existingBlueprint = studentsWithBlueprints.get(student.id);
          
          if (existingBlueprint) {
            // Load from existing blueprint and reconstruct courseDetails with all cached data
            const courseDetails = [];
            const courseLabels = existingBlueprint.courseLabels || existingBlueprint.courseNameCache || [];
            const courseSessionCounts = existingBlueprint.courseSessionCounts || [];
            const courseTypeIds = existingBlueprint.courseTypeIdCache || [];
            const courseTypeNames = existingBlueprint.courseTypeNameCache || [];
            const pricingMethods = existingBlueprint.coursePricingMethodCache || [];
            
            if (existingBlueprint.courseIds && courseLabels.length > 0) {
              for (let i = 0; i < existingBlueprint.courseIds.length; i++) {
                courseDetails.push({
                  courseId: existingBlueprint.courseIds[i],
                  courseName: existingBlueprint.courseNameCache[i] || 'Unknown',
                  coursePublicCode: courseLabels[i] || 'N/A',
                  courseTypeId: courseTypeIds[i] || null,
                  courseTypeName: courseTypeNames[i] || 'N/A',
                  courseTypePricingMethod: pricingMethods[i] || 'per_session',
                  sessionCount: courseSessionCounts[i] || 0
                });
              }
            }
            
            currentStudentData.push({
              studentId: student.id,
              studentPublicCode: existingBlueprint.studentPublicCode,
              studentNameCache: existingBlueprint.studentNameCache,
              classId: existingBlueprint.classId,
              classNameCache: existingBlueprint.classNameCache,
              studentStatus: existingBlueprint.studentStatus,
              year: existingBlueprint.year,
              month: existingBlueprint.month,
              courseIds: existingBlueprint.courseIds || [],
              courseNameCache: existingBlueprint.courseNameCache || [],
              courseLabels: courseLabels,
              courseTypeIdCache: courseTypeIds,
              courseTypeNameCache: courseTypeNames,
              coursePricingMethodCache: pricingMethods,
              courseSessionCounts: courseSessionCounts,
              courseDetails: courseDetails,
              sessionCount: existingBlueprint.sessionCount || 0,
              attendanceRecords: [],
              tuitionPlanId: existingBlueprint.tuitionPlanId,
              tuitionPlanNameCache: existingBlueprint.tuitionPlanNameCache,
              status: existingBlueprint.status || 'draft',
              blueprintId: existingBlueprint.id,
              // Track loading status - mark as loaded since we have the data
              classLoaded: true,
              coursesLoaded: true,
              attendanceLoaded: true,
              isLocked: existingBlueprint.status === 'locked',
              selected: false
            });
          } else {
            // No existing blueprint - initialize with empty data
            currentStudentData.push({
              studentId: student.id,
              studentPublicCode: student.publicCode || 'N/A',
              studentNameCache: student.fullName || student.name || 'Unknown',
              classId: student.classId || null,
              classNameCache: className,
              studentStatus: student.status || 'active',
              year: year,
              month: month,
              courseIds: [],
              courseNameCache: [],
              courseDetails: [],
              sessionCount: 0,
              attendanceRecords: [],
              tuitionPlanId: student.tuitionPlanId || null,
              tuitionPlanNameCache: null,
              status: 'draft',
              blueprintId: null,
              // Track loading status
              classLoaded: true,
              coursesLoaded: false,
              attendanceLoaded: false,
              isLocked: false,
              selected: false
            });
          }
        }

        // Mark this period as loaded
        currentLoadedPeriod = periodKey;

        // Store unfiltered data
        allStudentData = [...currentStudentData];

        // Apply filter
        filterStudents();

        const filterText = selectedClassId ? ` (${allClasses.get(selectedClassId)})` : ' (all classes)';
        showStatus(`Loaded ${allStudentData.length} students${filterText}.`, 'success');

      } catch (error) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="px-4 py-6 text-center text-red-600 text-sm">
              Error loading data: ${error.message}
            </td>
          </tr>
        `;
        showStatus(`Error: ${error.message}`, 'error');
        console.error('Error loading data:', error);
      }
    }

    // Refresh period - delete all data for the selected month
    async function refreshPeriod() {
      const year = parseInt(document.getElementById('yearSelect').value);
      const month = parseInt(document.getElementById('monthSelect').value);
      
      // Create confirmation modal
      const confirmModal = document.createElement('div');
      confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center';
      confirmModal.style.zIndex = '2000';
      confirmModal.innerHTML = `
        <div class="bg-white rounded-lg shadow-2xl p-4 max-w-md mx-4">
          <h3 class="font-bold text-base mb-3 text-gray-800">Warning: Confirm Refresh</h3>
          <p class="text-gray-600 text-sm mb-4">
            This will delete ALL blueprints for ${year}/${String(month).padStart(2, '0')}. 
            This action cannot be undone. Are you sure?
          </p>
          <div class="flex gap-2 justify-end">
            <button id="cancelRefresh" class="px-3 py-1 bg-gray-300 text-gray-800 rounded font-semibold hover:bg-gray-400 transition-colors text-xs">
              Cancel
            </button>
            <button id="confirmRefresh" class="px-3 py-1 bg-red-600 text-white rounded font-semibold hover:bg-red-700 transition-colors text-xs">
              Delete All
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(confirmModal);
      
      document.getElementById('cancelRefresh').onclick = () => {
        document.body.removeChild(confirmModal);
      };
      
      document.getElementById('confirmRefresh').onclick = async () => {
        document.body.removeChild(confirmModal);
        
        const refreshBtn = document.getElementById('refreshBtn');
        refreshBtn.disabled = true;
        refreshBtn.innerHTML = 'Deleting...';
        
        try {
          const snapshot = await db.collection('tuition_blueprint')
            .where('year', '==', year)
            .where('month', '==', month)
            .get();
          
          let deletedCount = 0;
          const batch = db.batch();
          
          snapshot.forEach(doc => {
            batch.delete(doc.ref);
            deletedCount++;
          });
          
          await batch.commit();
          
          // Clear cache
          const key = `${year}-${month}`;
          savedMonthsCache.delete(key);
          currentLoadedPeriod = null;
          
          showStatus(`Deleted ${deletedCount} blueprints for ${year}/${String(month).padStart(2, '0')}`, 'success');
          
          // Reload saved months grid and clear table
          await loadSavedMonths();
          currentStudentData = [];
          renderDataTable();
          
        } catch (error) {
          showStatus(`Error deleting: ${error.message}`, 'error');
          console.error('Error deleting blueprints:', error);
        } finally {
          refreshBtn.disabled = false;
          refreshBtn.innerHTML = 'Refresh';
        }
      };
    }

    // Filter students based on active only checkbox
    function filterStudents() {
      const activeOnly = document.getElementById('activeOnlyCheckbox').checked;
      
      if (activeOnly) {
        currentStudentData = allStudentData.filter(s => s.studentStatus === 'active');
      } else {
        currentStudentData = [...allStudentData];
      }
      
      renderDataTable();
    }

    // Toggle select all checkbox
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAllCheckbox').checked;
      currentStudentData.forEach(student => {
        student.selected = selectAll;
      });
      renderDataTable();
    }

    // Toggle individual student selection
    function toggleStudentSelection(studentId) {
      const student = currentStudentData.find(s => s.studentId === studentId);
      if (student) {
        student.selected = !student.selected;
        renderDataTable();
      }
    }

    // Change tuition plan for a student
    async function changeTuitionPlan(studentId, planId) {
      const student = currentStudentData.find(s => s.studentId === studentId);
      if (!student || student.isLocked) return;

      if (!planId) {
        student.tuitionPlanId = null;
        student.tuitionPlanNameCache = null;
      } else {
        const plan = allTuitionPlans.find(p => p.id === planId);
        if (plan) {
          student.tuitionPlanId = planId;
          student.tuitionPlanNameCache = plan.name;
        }
      }
      
      renderDataTable();
    }

    // Save selected students
    async function saveSelected() {
      const selected = currentStudentData.filter(s => s.selected && !s.isLocked);
      if (selected.length === 0) {
        showStatus('No unlocked students selected', 'warning');
        return;
      }

      const saveBtn = document.getElementById('saveSelectedBtn');
      saveBtn.disabled = true;
      saveBtn.innerHTML = 'Saving...';

      try {
        let savedCount = 0;
        let updatedCount = 0;

        for (const data of selected) {
          const docId = `TBP_${data.year}_${String(data.month).padStart(2, '0')}_${data.studentPublicCode}`;

          // Extract all per-course data from courseDetails
          const courseSessionCounts = (data.courseDetails || []).map(c => c.sessionCount || 0);
          const courseTypeIdCache = (data.courseDetails || []).map(c => c.courseTypeId || null);
          const courseTypeNameCache = (data.courseDetails || []).map(c => c.courseTypeName || 'N/A');
          const coursePricingMethodCache = (data.courseDetails || []).map(c => c.courseTypePricingMethod || 'per_session');

          const blueprintData = {
            studentId: data.studentId,
            studentPublicCode: data.studentPublicCode,
            studentNameCache: data.studentNameCache,
            classId: data.classId,
            classNameCache: data.classNameCache,
            studentStatus: data.studentStatus,
            year: data.year,
            month: data.month,
            courseIds: data.courseIds,
            courseNameCache: data.courseNameCache,
            courseLabels: data.courseLabels || data.courseNameCache || [],
            courseTypeIdCache: courseTypeIdCache,
            courseTypeNameCache: courseTypeNameCache,
            coursePricingMethodCache: coursePricingMethodCache,
            courseSessionCounts: courseSessionCounts,
            sessionCount: data.sessionCount,
            tuitionPlanId: data.tuitionPlanId,
            tuitionPlanNameCache: data.tuitionPlanNameCache,
            status: 'draft',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };

          if (data.blueprintId) {
            // Update existing document
            await db.collection('tuition_blueprint').doc(data.blueprintId).update(blueprintData);
            updatedCount++;
          } else {
            // Create new document
            blueprintData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            await db.collection('tuition_blueprint').doc(docId).set(blueprintData);
            data.blueprintId = docId;
            savedCount++;
          }
        }

        // Update saved months cache
        const year = parseInt(document.getElementById('yearSelect').value);
        const month = parseInt(document.getElementById('monthSelect').value);
        const key = `${year}-${month}`;
        savedMonthsCache.add(key);

        showStatus(`Saved ${savedCount} new and updated ${updatedCount} blueprints!`, 'success');
        
        // Reload saved months grid
        await loadSavedMonths();
        
        // Re-render table without reloading data
        renderDataTable();

      } catch (error) {
        showStatus(`Error saving: ${error.message}`, 'error');
        console.error('Error saving blueprints:', error);
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = 'Save';
      }
    }

    // Lock selected students
    async function lockSelected() {
      const selected = currentStudentData.filter(s => s.selected && s.blueprintId && !s.isLocked);
      if (selected.length === 0) {
        showStatus('No saved and unlocked students selected', 'warning');
        return;
      }

      const lockBtn = document.getElementById('lockSelectedBtn');
      lockBtn.disabled = true;
      lockBtn.innerHTML = 'Locking...';

      try {
        let lockedCount = 0;

        for (const data of selected) {
          await db.collection('tuition_blueprint').doc(data.blueprintId).update({
            status: 'locked',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          data.status = 'locked';
          data.isLocked = true;
          lockedCount++;
        }

        showStatus(`Locked ${lockedCount} blueprints!`, 'success');
        renderDataTable();

      } catch (error) {
        showStatus(`Error locking: ${error.message}`, 'error');
        console.error('Error locking blueprints:', error);
      } finally {
        lockBtn.disabled = false;
        lockBtn.innerHTML = 'Lock';
      }
    }

    // Unlock selected students
    async function unlockSelected() {
      const selected = currentStudentData.filter(s => s.selected && s.blueprintId && s.isLocked);
      if (selected.length === 0) {
        showStatus('No locked students selected', 'warning');
        return;
      }

      const unlockBtn = document.getElementById('unlockSelectedBtn');
      unlockBtn.disabled = true;
      unlockBtn.innerHTML = 'Unlocking...';

      try {
        let unlockedCount = 0;

        for (const data of selected) {
          await db.collection('tuition_blueprint').doc(data.blueprintId).update({
            status: 'draft',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          data.status = 'draft';
          data.isLocked = false;
          unlockedCount++;
        }

        showStatus(`Unlocked ${unlockedCount} blueprints!`, 'success');
        renderDataTable();

      } catch (error) {
        showStatus(`Error unlocking: ${error.message}`, 'error');
        console.error('Error unlocking blueprints:', error);
      } finally {
        unlockBtn.disabled = false;
        unlockBtn.innerHTML = 'Unlock';
      }
    }

    // Individual student actions
    async function saveStudent(studentId) {
      const student = currentStudentData.find(s => s.studentId === studentId);
      if (!student || student.isLocked) return;

      try {
        const docId = `TBP_${student.year}_${String(student.month).padStart(2, '0')}_${student.studentPublicCode}`;

        // Extract all per-course data from courseDetails
        const courseSessionCounts = (student.courseDetails || []).map(c => c.sessionCount || 0);
        const courseTypeIdCache = (student.courseDetails || []).map(c => c.courseTypeId || null);
        const courseTypeNameCache = (student.courseDetails || []).map(c => c.courseTypeName || 'N/A');
        const coursePricingMethodCache = (student.courseDetails || []).map(c => c.courseTypePricingMethod || 'per_session');

        const blueprintData = {
          studentId: student.studentId,
          studentPublicCode: student.studentPublicCode,
          studentNameCache: student.studentNameCache,
          classId: student.classId,
          classNameCache: student.classNameCache,
          studentStatus: student.studentStatus,
          year: student.year,
          month: student.month,
          courseIds: student.courseIds,
          courseNameCache: student.courseNameCache,
          courseLabels: student.courseLabels || student.courseNameCache || [],
          courseTypeIdCache: courseTypeIdCache,
          courseTypeNameCache: courseTypeNameCache,
          coursePricingMethodCache: coursePricingMethodCache,
          courseSessionCounts: courseSessionCounts,
          sessionCount: student.sessionCount,
          tuitionPlanId: student.tuitionPlanId,
          tuitionPlanNameCache: student.tuitionPlanNameCache,
          status: 'draft',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (student.blueprintId) {
          await db.collection('tuition_blueprint').doc(student.blueprintId).update(blueprintData);
        } else {
          blueprintData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('tuition_blueprint').doc(docId).set(blueprintData);
          student.blueprintId = docId;
        }

        // Update saved months cache
        const year = parseInt(document.getElementById('yearSelect').value);
        const month = parseInt(document.getElementById('monthSelect').value);
        const key = `${year}-${month}`;
        savedMonthsCache.add(key);
        
        showStatus('Blueprint saved!', 'success');
        await loadSavedMonths();
        renderDataTable();

      } catch (error) {
        showStatus(`Error saving: ${error.message}`, 'error');
      }
    }

    async function lockStudent(studentId) {
      const student = currentStudentData.find(s => s.studentId === studentId);
      if (!student || !student.blueprintId || student.isLocked) return;

      try {
        await db.collection('tuition_blueprint').doc(student.blueprintId).update({
          status: 'locked',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        student.status = 'locked';
        student.isLocked = true;
        showStatus('Blueprint locked!', 'success');
        renderDataTable();
      } catch (error) {
        showStatus(`Error locking: ${error.message}`, 'error');
      }
    }

    async function unlockStudent(studentId) {
      const student = currentStudentData.find(s => s.studentId === studentId);
      if (!student || !student.blueprintId || !student.isLocked) return;

      try {
        await db.collection('tuition_blueprint').doc(student.blueprintId).update({
          status: 'draft',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        student.status = 'draft';
        student.isLocked = false;
        showStatus('Blueprint unlocked!', 'success');
        renderDataTable();
      } catch (error) {
        showStatus(`Error unlocking: ${error.message}`, 'error');
      }
    }

    // Load all classes (already loaded, just refresh display)
    async function loadAllClasses() {
      showStatus('Classes already loaded!', 'info');
      renderDataTable();
    }

    // Load all courses on demand
    async function loadAllCourses() {
      if (currentStudentData.length === 0) {
        showStatus('Please load students first', 'warning');
        return;
      }

      const year = parseInt(document.getElementById('yearSelect').value);
      const month = parseInt(document.getElementById('monthSelect').value);

      // Pre-load sessions map
      const startDate = new Date(year, month - 1, 1);
      const endDate = new Date(year, month, 0, 23, 59, 59);
      
      const sessionsSnapshot = await db.collection('course_sessions')
        .where('sessionDate', '>=', startDate)
        .where('sessionDate', '<=', endDate)
        .get();
      
      const sessionsMap = new Map();
      sessionsSnapshot.forEach(doc => {
        const session = doc.data();
        if (session.sessionStatus === 'cancelled') return;
        
        let sessionDate;
        if (session.sessionDate && session.sessionDate.toDate) {
          sessionDate = session.sessionDate.toDate();
        } else if (session.sessionDate) {
          sessionDate = new Date(session.sessionDate);
        } else {
          return;
        }
        
        sessionsMap.set(doc.id, {
          courseId: session.courseId,
          date: sessionDate,
          title: session.title || 'Untitled Session'
        });
      });

      try {
        // Process in batches
        const batchSize = 5;
        for (let i = 0; i < currentStudentData.length; i += batchSize) {
          const batch = currentStudentData.slice(i, i + batchSize);
          
          await Promise.all(batch.map(async (student) => {
            if (!student.coursesLoaded && !student.isLocked) {
              student.coursesLoading = true;
              renderDataTable();
              
              const courseData = await getCoursesAndAttendance(student.studentId, year, month, sessionsMap);
              student.courseIds = courseData.courseIds;
              student.courseNameCache = courseData.courseNames;
              student.courseLabels = courseData.courseLabels;
              student.courseDetails = courseData.courseDetails;
              student.attendanceRecords = courseData.attendanceRecords;
              student.coursesLoaded = true;
              student.coursesLoading = false;
            }
          }));
          
          renderDataTable();
        }

      } catch (error) {
        showStatus(`Error loading courses: ${error.message}`, 'error');
      }
    }

    // Load all attendance on demand
    async function loadAllAttendance() {
      if (currentStudentData.length === 0) {
        showStatus('Please load students first', 'warning');
        return;
      }

      const year = parseInt(document.getElementById('yearSelect').value);
      const month = parseInt(document.getElementById('monthSelect').value);

      // Pre-load sessions map
      const startDate = new Date(year, month - 1, 1);
      const endDate = new Date(year, month, 0, 23, 59, 59);
      
      const sessionsSnapshot = await db.collection('course_sessions')
        .where('sessionDate', '>=', startDate)
        .where('sessionDate', '<=', endDate)
        .get();
      
      const sessionsMap = new Map();
      sessionsSnapshot.forEach(doc => {
        const session = doc.data();
        if (session.sessionStatus === 'cancelled') return;
        
        let sessionDate;
        if (session.sessionDate && session.sessionDate.toDate) {
          sessionDate = session.sessionDate.toDate();
        } else if (session.sessionDate) {
          sessionDate = new Date(session.sessionDate);
        } else {
          return;
        }
        
        sessionsMap.set(doc.id, {
          courseId: session.courseId,
          date: sessionDate,
          title: session.title || 'Untitled Session'
        });
      });

      try {
        // Process in batches
        const batchSize = 5;
        for (let i = 0; i < currentStudentData.length; i += batchSize) {
          const batch = currentStudentData.slice(i, i + batchSize);
          
          await Promise.all(batch.map(async (student) => {
            if (!student.attendanceLoaded && !student.isLocked) {
              student.attendanceLoading = true;
              renderDataTable();
              
              const courseData = await getCoursesAndAttendance(student.studentId, year, month, sessionsMap);
              student.sessionCount = courseData.sessionCount;
              student.courseDetails = courseData.courseDetails;
              student.attendanceRecords = courseData.attendanceRecords;
              
              if (!student.coursesLoaded) {
                student.courseIds = courseData.courseIds;
                student.courseNameCache = courseData.courseNames;
                student.courseLabels = courseData.courseLabels;
                student.coursesLoaded = true;
              }
              student.attendanceLoaded = true;
              student.attendanceLoading = false;
            }
          }));
          
          renderDataTable();
        }

      } catch (error) {
        showStatus(`Error loading attendance: ${error.message}`, 'error');
      }
    }

    // Render data table
    function renderDataTable() {
      const tbody = document.getElementById('dataTableBody');
      tbody.innerHTML = '';

      if (currentStudentData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7" class="px-3 py-4 text-center text-gray-500 text-xs">
              No students found
            </td>
          </tr>
        `;
        return;
      }

      currentStudentData.forEach(data => {
        const row = document.createElement('tr');
        row.className = `border-b border-gray-200 hover:bg-gray-50 transition-colors ${data.isLocked ? 'bg-red-50' : ''}`;
        
        // Courses column content with course type info
        let coursesContent;
        if (data.coursesLoading) {
          coursesContent = `
            <div class="flex items-center gap-1">
              <div class="animate-spin rounded-full h-3 w-3 border-b-2 border-indigo-600"></div>
              <span class="text-gray-500 text-xs">Loading...</span>
            </div>
          `;
        } else if (data.coursesLoaded) {
          // Render from courseDetails with session counts and course type
          if (data.courseDetails && data.courseDetails.length > 0) {
            coursesContent = `
              <div class="space-y-1">
                ${data.courseDetails.map(course => `
                  <div class="text-xs whitespace-nowrap">
                    <span class="inline-block bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded font-medium">${course.coursePublicCode || course.courseName}</span>
                    <span class="text-gray-600 ml-1"><span class="font-medium">${course.courseTypeName}</span> · ${course.sessionCount} session${course.sessionCount !== 1 ? 's' : ''}</span>
                  </div>
                `).join('')}
              </div>
            `;
          } else if (data.courseLabels && data.courseLabels.length > 0) {
            // Fallback to courseLabels without session counts if courseDetails not available
            coursesContent = `
              <div class="space-y-1">
                ${data.courseLabels.map(label => `
                  <div class="flex items-center gap-1 text-xs whitespace-nowrap">
                    <span class="inline-block bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded font-medium">${label}</span>
                  </div>
                `).join('')}
              </div>
            `;
          } else {
            coursesContent = '<span class="text-gray-400 text-xs">No attended courses</span>';
          }
        } else {
          coursesContent = '<span class="text-gray-400 text-xs italic">Click header to load</span>';
        }

        // Attendance column content
        let attendanceContent;
        if (data.attendanceLoading) {
          attendanceContent = `
            <div class="flex items-center justify-center gap-1">
              <div class="animate-spin rounded-full h-3 w-3 border-b-2 border-indigo-600"></div>
              <span class="text-gray-500 text-xs">Loading...</span>
            </div>
          `;
        } else if (data.attendanceLoaded) {
          // If attendanceLoaded is true, show session count from blueprint
          attendanceContent = `
            <div class="flex justify-center">
              <button onclick="openAttendanceModal('${data.studentId}')" class="px-3 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-800 rounded font-semibold transition-colors text-xs">
                ${data.sessionCount} session${data.sessionCount !== 1 ? 's' : ''}
              </button>
            </div>
          `;
        } else {
          // Only show "Click to load" if no blueprint exists
          attendanceContent = '<div class="text-center"><span class="text-gray-400 text-xs italic">Click header to load</span></div>';
        }

        // Tuition plan dropdown
        let tuitionPlanContent;
        if (data.isLocked) {
          tuitionPlanContent = `
            <div class="text-xs">
              <span class="text-gray-700 font-medium">${data.tuitionPlanNameCache || 'Not set'}</span>
              ${data.tuitionPlanNameCache ? `<div class="text-xs text-gray-500 mt-0.5">Locked</div>` : ''}
            </div>
          `;
        } else {
          const planOptions = allTuitionPlans.map(plan => {
            const formattedPrice = plan.totalPrice.toLocaleString('vi-VN');
            return `<option value="${plan.id}" ${data.tuitionPlanId === plan.id ? 'selected' : ''}>${plan.name} - ${formattedPrice} ₫</option>`;
          }).join('');
          
          tuitionPlanContent = `
            <select onchange="changeTuitionPlan('${data.studentId}', this.value)" 
                    class="w-full px-2 py-1 border border-gray-300 rounded text-xs focus:outline-none focus:ring-2 focus:ring-indigo-500">
              <option value="">Select plan...</option>
              ${planOptions}
            </select>
          `;
        }

        // Status badge and action buttons merged
        let statusAndActions;
        if (data.isLocked) {
          statusAndActions = `
            <div class="flex flex-col items-center gap-1">
              <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Locked</span>
              <button onclick="unlockStudent('${data.studentId}')" class="px-2 py-0.5 bg-yellow-500 hover:bg-yellow-600 text-white rounded text-xs font-medium transition-colors">Unlock</button>
            </div>
          `;
        } else if (data.blueprintId) {
          statusAndActions = `
            <div class="flex flex-col items-center gap-1">
              <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Saved</span>
              <div class="flex gap-1">
                <button onclick="saveStudent('${data.studentId}')" class="px-2 py-0.5 bg-green-500 hover:bg-green-600 text-white rounded text-xs font-medium transition-colors">Save</button>
                <button onclick="lockStudent('${data.studentId}')" class="px-2 py-0.5 bg-purple-500 hover:bg-purple-600 text-white rounded text-xs font-medium transition-colors">Lock</button>
              </div>
            </div>
          `;
        } else {
          statusAndActions = `
            <div class="flex flex-col items-center gap-1">
              <span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Draft</span>
              <button onclick="saveStudent('${data.studentId}')" class="px-2 py-0.5 bg-green-500 hover:bg-green-600 text-white rounded text-xs font-medium transition-colors">Save</button>
            </div>
          `;
        }
        
        row.innerHTML = `
          <td class="px-2 py-2 text-center">
            <input type="checkbox" ${data.selected ? 'checked' : ''} onchange="toggleStudentSelection('${data.studentId}')" class="w-3 h-3 cursor-pointer">
          </td>
          <td class="px-2 py-2">
            <div class="font-semibold text-gray-800 text-xs">
              ${data.studentNameCache}
            </div>
            <div class="text-gray-500" style="font-size: 10px;">${data.studentPublicCode}</div>
          </td>
          <td class="px-2 py-2">
            <div class="space-y-0.5">
              <div class="text-gray-700 text-xs">
                ${data.classNameCache || 'N/A'}
              </div>
              <div>
                ${data.studentStatus === 'active' 
                  ? '<span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span>'
                  : data.studentStatus === 'inactive'
                  ? '<span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Inactive</span>'
                  : data.studentStatus === 'finished'
                  ? '<span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">Finished</span>'
                  : data.studentStatus === 'dropped'
                  ? '<span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Dropped</span>'
                  : '<span class="inline-block px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">Unknown</span>'
                }
              </div>
            </div>
          </td>
          <td class="px-2 py-2">
            ${coursesContent}
          </td>
          <td class="px-2 py-2">
            ${attendanceContent}
          </td>
          <td class="px-2 py-2">
            ${tuitionPlanContent}
          </td>
          <td class="px-2 py-2">
            ${statusAndActions}
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    // Open attendance details modal
    async function openAttendanceModal(studentId) {
      const student = currentStudentData.find(s => s.studentId === studentId);
      if (!student) {
        return;
      }

      const modal = document.getElementById('attendanceModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalContent = document.getElementById('modalContent');

      modalTitle.textContent = `Attendance Details - ${student.studentNameCache}`;

      // Show loading state if attendance not loaded yet
      if (!student.attendanceRecords || student.attendanceRecords.length === 0) {
        modalContent.innerHTML = `
          <div class="flex items-center justify-center py-6">
            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"></div>
            <span class="ml-2 text-gray-600 text-sm">Loading attendance details...</span>
          </div>
        `;
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // Load attendance data with pre-loaded sessions map
        const year = parseInt(document.getElementById('yearSelect').value);
        const month = parseInt(document.getElementById('monthSelect').value);
        
        const startDate = new Date(year, month - 1, 1);
        const endDate = new Date(year, month, 0, 23, 59, 59);
        
        const sessionsSnapshot = await db.collection('course_sessions')
          .where('sessionDate', '>=', startDate)
          .where('sessionDate', '<=', endDate)
          .get();
        
        const sessionsMap = new Map();
        sessionsSnapshot.forEach(doc => {
          const session = doc.data();
          if (session.sessionStatus === 'cancelled') return;
          
          let sessionDate;
          if (session.sessionDate && session.sessionDate.toDate) {
            sessionDate = session.sessionDate.toDate();
          } else if (session.sessionDate) {
            sessionDate = new Date(session.sessionDate);
          } else {
            return;
          }
          
          sessionsMap.set(doc.id, {
            courseId: session.courseId,
            date: sessionDate,
            title: session.title || 'Untitled Session'
          });
        });
        
        const courseData = await getCoursesAndAttendance(student.studentId, year, month, sessionsMap);
        student.attendanceRecords = courseData.attendanceRecords;
        student.attendanceLoaded = true;

        // Check if modal is still open for this student
        if (!modal.classList.contains('hidden')) {
          displayAttendanceInModal(student);
        }
        return;
      }

      // Display attendance data
      displayAttendanceInModal(student);
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    // Display attendance data in modal
    function displayAttendanceInModal(student) {
      const modalContent = document.getElementById('modalContent');
      
      // Format attendance records
      let content = `
        <div class="mb-3">
          <div class="text-gray-600 text-xs">
            <strong>Student:</strong> ${student.studentNameCache} (${student.studentPublicCode})<br>
            <strong>Total Sessions:</strong> ${student.sessionCount}<br>
            <strong>Period:</strong> ${student.year}/${String(student.month).padStart(2, '0')}
          </div>
        </div>
      `;

      if (!student.attendanceRecords || student.attendanceRecords.length === 0) {
        content += `<div class="text-center text-gray-500 py-6 text-sm">No attendance records found</div>`;
        modalContent.innerHTML = content;
        return;
      }

      content += '<div class="space-y-2">';

      // Group by course
      const byCourse = {};
      student.attendanceRecords.forEach(record => {
        if (!byCourse[record.coursePublicCode]) {
          byCourse[record.coursePublicCode] = [];
        }
        byCourse[record.coursePublicCode].push(record);
      });

      for (const [courseCode, records] of Object.entries(byCourse)) {
        content += `
          <div class="border border-gray-200 rounded-lg overflow-hidden">
            <div class="bg-indigo-50 px-3 py-2 border-b border-gray-200">
              <h4 class="font-semibold text-indigo-900 text-sm">
                ${courseCode} - ${records[0].courseName}
              </h4>
              <p class="text-xs text-gray-600">${records.length} session${records.length > 1 ? 's' : ''}</p>
            </div>
            <div class="p-3">
              <table class="w-full text-xs">
                <thead>
                  <tr class="border-b border-gray-200">
                    <th class="text-left py-1 text-gray-700 font-semibold">Date</th>
                    <th class="text-left py-1 text-gray-700 font-semibold">Session</th>
                    <th class="text-left py-1 text-gray-700 font-semibold">Status</th>
                  </tr>
                </thead>
                <tbody>
        `;

        records.forEach(record => {
          const dateStr = record.sessionDate ? 
            record.sessionDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 
            'N/A';
          
          // Status color and text mapping
          let statusColor, statusText;
          switch(record.status) {
            case 'present':
              statusColor = 'bg-green-100 text-green-800';
              statusText = 'Present';
              break;
            case 'late':
              statusColor = 'bg-yellow-100 text-yellow-800';
              statusText = 'Late';
              break;
            case 'absent':
              statusColor = 'bg-red-100 text-red-800';
              statusText = 'Absent';
              break;
            case 'excused':
              statusColor = 'bg-blue-100 text-blue-800';
              statusText = 'Excused';
              break;
            default:
              statusColor = 'bg-gray-100 text-gray-800';
              statusText = record.status;
          }

          content += `
            <tr class="border-b border-gray-100">
              <td class="py-1 text-gray-700">${dateStr}</td>
              <td class="py-1 text-gray-700">${record.sessionTitle}</td>
              <td class="py-1">
                <span class="inline-block px-2 py-0.5 rounded text-xs font-medium ${statusColor}">${statusText}</span>
              </td>
            </tr>
          `;
        });

        content += `
                </tbody>
              </table>
            </div>
          </div>
        `;
      }

      content += '</div>';
      modalContent.innerHTML = content;
    }

    // Close attendance details modal
    function closeAttendanceModal() {
      const modal = document.getElementById('attendanceModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      loadTuitionBlueprints();
      initializeYearSelector();
      initializeMonthSelector();
      await initializeClassSelector();
      await initializeCourseTypes();
      await initializeTuitionPlans();
      // Load saved months on initial page load
      loadSavedMonths();
    });

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9beb5d20e4b304d3',t:'MTc2ODU0MjkyNS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>