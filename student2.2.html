<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Directory System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <style>
        .tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
        }
        .status-tab-active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .modal-backdrop {
            backdrop-filter: blur(4px);
        }
        .card-shadow {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        
        <!-- Header Card -->
        <div class="bg-white rounded-lg border card-shadow p-4 mb-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <svg class="w-8 h-8" viewBox="0 0 48 48" fill="none">
                            <circle cx="24" cy="24" r="20" fill="#3b82f6" opacity="0.1"/>
                            <path d="M12 20L24 14L36 20L24 26L12 20Z" fill="#3b82f6"/>
                            <path d="M24 26V34" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
                            <path d="M20 34H28" stroke="#3b82f6" stroke-width="2" stroke-linecap="round"/>
                            <circle cx="24" cy="24" r="18" stroke="#3b82f6" stroke-width="2" fill="none"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-lg font-bold text-gray-900">üéì Student Directory System</h1>
                        <p class="text-sm text-gray-600">Complete student lifecycle management platform</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="w-3 h-3 bg-green-500 rounded-full" id="connectionStatus"></div>
                    <span class="text-sm text-gray-600" id="syncIndicator">Connecting...</span>
                </div>
            </div>
        </div>

        <!-- Dashboard Overview Card -->
        <div class="bg-white rounded-lg border card-shadow p-4 mb-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-6">
                    <h2 class="text-lg font-semibold text-gray-900">Dashboard Overview</h2>
                    <p class="text-sm text-gray-600" id="dashboardSummary">üìä <span id="totalStudents">0</span> students ‚Ä¢ <span id="activeStudents">0</span> active ‚Ä¢ <span id="totalClasses">0</span> classes</p>
                </div>
                <div class="flex space-x-2">
                    <button id="addStudentBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm font-medium transition-colors">
                        Add Student
                    </button>
                    <button id="importBtn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm font-medium transition-colors">
                        Import
                    </button>
                    <button id="exportBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded text-sm font-medium transition-colors">
                        Export
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Tabs -->
        <div class="bg-white rounded-lg border card-shadow mb-4">
            <div class="flex border-b">
                <button id="studentsTab" class="flex items-center px-4 py-2.5 text-sm font-medium tab-active transition-colors">
                    üë• Students
                </button>
                <button id="classesTab" class="flex items-center px-4 py-2.5 text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors">
                    üìö Classes
                </button>
            </div>
        </div>

        <!-- Students Section -->
        <div id="studentsSection" class="bg-white rounded-lg border card-shadow">
            <!-- Section Header -->
            <div class="p-4 border-b">
                <div class="flex items-center justify-between">
                    <h3 class="text-base font-semibold text-gray-900">Student Directory</h3>
                    <div id="bulkActions" class="hidden space-x-2">
                        <button class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1.5 rounded text-sm font-medium transition-colors">
                            Bulk Actions
                        </button>
                        <button id="selectAllBtn" class="border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded text-sm font-medium transition-colors">
                            Select All
                        </button>
                    </div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="p-4 border-b">
                <div class="flex items-center space-x-3 mb-3">
                    <div class="flex-1">
                        <input type="text" id="searchInput" placeholder="üîç Search by name, ID, contact, school..." 
                               class="w-full px-3 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <button id="filtersBtn" class="border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded text-sm font-medium transition-colors">
                        Filters
                    </button>
                    <button id="clearBtn" class="border border-gray-300 hover:bg-gray-50 text-gray-700 px-3 py-1.5 rounded text-sm font-medium transition-colors">
                        Clear
                    </button>
                </div>

                <!-- Expandable Filter Panel -->
                <div id="filterPanel" class="hidden grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 p-3 bg-gray-50 rounded">
                    <select id="statusFilter" class="px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="finished">Finished</option>
                        <option value="dropped">Dropped</option>
                    </select>
                    <select id="classFilter" class="px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        <option value="">All Classes</option>
                    </select>
                    <select id="enrollmentYearFilter" class="px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        <option value="">Enrollment Year</option>
                    </select>
                    <select id="finishedYearFilter" class="px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        <option value="">Finished Year</option>
                    </select>
                    <select id="sortByFilter" class="px-2 py-1.5 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500">
                        <option value="name-asc">Name A-Z</option>
                        <option value="name-desc">Name Z-A</option>
                        <option value="id-asc">ID Ascending</option>
                        <option value="id-desc">ID Descending</option>
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                    </select>
                </div>
            </div>

            <!-- Status Tabs -->
            <div class="px-4 border-b">
                <div class="flex space-x-4">
                    <button id="activeTab" class="py-2 px-1 text-sm font-medium status-tab-active transition-colors">
                        Active Students (<span id="activeCount">0</span>)
                    </button>
                    <button id="inactiveTab" class="py-2 px-1 text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors">
                        Inactive/Finished (<span id="inactiveCount">0</span>)
                    </button>
                    <button id="droppedTab" class="py-2 px-1 text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors">
                        Dropped (<span id="droppedCount">0</span>)
                    </button>
                </div>
            </div>

            <!-- Student Table -->
            <div class="overflow-x-auto">
                <table class="w-full table-fixed min-w-[1200px]">
                    <thead class="bg-gray-50">
                        <tr id="tableHeader">
                            <th class="w-12 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <input type="checkbox" id="selectAllCheckbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            </th>
                            <th class="w-24 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID</th>
                            <th class="w-48 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                            <th class="w-24 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date of Birth</th>
                            <th class="w-20 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="hidden sm:table-cell w-40 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">School</th>
                            <th class="hidden md:table-cell w-32 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                            <th class="hidden lg:table-cell w-20 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Enrolled</th>
                            <th id="finishedHeader" class="hidden lg:table-cell w-20 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Finished</th>
                            <th class="w-24 px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="10" class="px-6 py-8 text-center text-gray-500">
                                Loading students...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Classes Section (Hidden) -->
        <div id="classesSection" class="hidden bg-white rounded-lg border card-shadow">
            <div class="p-6 border-b">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Class Management</h3>
                    <button id="addClassBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        Add Class
                    </button>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Academic Year</th>
                            <th class="hidden md:table-cell px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Management Code</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Students</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student List</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="classTableBody" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                                Loading classes...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Student Profile Modal -->
    <div id="studentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex items-center justify-between">
                    <h3 id="studentModalTitle" class="text-lg font-semibold text-gray-900">Student Profile</h3>
                    <button id="closeStudentModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Profile Tabs -->
            <div class="border-b">
                <div class="flex space-x-6 px-6">
                    <button id="basicInfoTab" class="py-3 px-1 font-medium text-blue-600 border-b-2 border-blue-600 transition-colors">
                        üóÇ Basic Info
                    </button>
                    <button id="contactTab" class="py-3 px-1 font-medium text-gray-600 hover:text-gray-900 transition-colors">
                        üìû Contact
                    </button>
                    <button id="progressTab" class="py-3 px-1 font-medium text-gray-600 hover:text-gray-900 transition-colors">
                        üìà Learning Progress
                    </button>
                    <button id="notesTab" class="py-3 px-1 font-medium text-gray-600 hover:text-gray-900 transition-colors">
                        üìù Notes
                    </button>
                </div>
            </div>

            <form id="studentForm" class="p-6">
                <!-- Basic Info Tab -->
                <div id="basicInfoContent" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Student ID *</label>
                            <input type="text" id="studentHumanId" placeholder="e.g. STU001" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                            <p class="text-xs text-gray-500 mt-1">Enter unique ID (cannot be changed later)</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Management Code</label>
                            <input type="text" id="studentManagementCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm" readonly>
                            <p class="text-xs text-gray-500 mt-1">Auto-generated tracking code</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
                            <input type="text" id="studentFullName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth *</label>
                            <input type="date" id="studentDateOfBirth" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="studentStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="finished">Finished</option>
                                <option value="dropped">Dropped</option>
                            </select>
                        </div>
                    </div>

                    <!-- Additional Fields Toggle -->
                    <div class="mt-6">
                        <button type="button" id="toggleAdditionalFields" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            Show additional fields
                        </button>
                    </div>

                    <!-- Additional Fields (Hidden by default for new students) -->
                    <div id="additionalFields" class="hidden space-y-4 mt-4 p-4 bg-gray-50 rounded-lg">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">School</label>
                                <input type="text" id="studentSchool" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Class Assignment</label>
                                <select id="studentClassRef" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Select Class</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Year Enrolled</label>
                                <input type="number" id="studentEnrollmentYear" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" min="2000" max="2030">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Year Finished</label>
                                <input type="number" id="studentGraduationYear" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" min="2000" max="2030">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contact Tab -->
                <div id="contactContent" class="hidden space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Student Phone</label>
                            <input type="tel" id="studentPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Parent/Guardian Name</label>
                            <input type="text" id="parentName" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Parent/Guardian Phone</label>
                            <input type="tel" id="parentPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Emergency Contact</label>
                            <input type="tel" id="emergencyContact" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Learning Progress Tab -->
                <div id="progressContent" class="hidden space-y-4">
                    <!-- Compact Summary Panel -->
                    <div class="bg-blue-50 rounded-lg p-4">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center space-x-3 mb-2">
                                    <h4 id="progressStudentName" class="text-lg font-semibold text-gray-900">Student Name</h4>
                                    <span id="progressStudentStatus" class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Active</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-3">ID: <span id="progressStudentId">STU001</span></p>
                                
                                <!-- General Progress Notes integrated -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-600 mb-1">General Progress Notes</label>
                                    <textarea id="progressNotes" rows="2" placeholder="Enter progress notes and observations..." class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-1 focus:ring-blue-500"></textarea>
                                </div>
                            </div>
                            
                            <!-- Compact Stats -->
                            <div class="grid grid-cols-2 gap-3 text-center ml-4">
                                <div class="bg-white rounded p-2">
                                    <div id="firstLessonDate" class="text-sm font-bold text-blue-600">-</div>
                                    <div class="text-xs text-gray-600">First</div>
                                </div>
                                <div class="bg-white rounded p-2">
                                    <div id="recentLessonDate" class="text-sm font-bold text-blue-600">-</div>
                                    <div class="text-xs text-gray-600">Recent</div>
                                </div>
                                <div class="bg-white rounded p-2">
                                    <div id="totalLessons" class="text-sm font-bold text-blue-600">0</div>
                                    <div class="text-xs text-gray-600">Lessons</div>
                                </div>
                                <div class="bg-white rounded p-2">
                                    <div id="totalAssessments" class="text-sm font-bold text-blue-600">0</div>
                                    <div class="text-xs text-gray-600">Tests</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Course Category Tabs -->
                    <div class="border-b">
                        <div class="flex space-x-6">
                            <button type="button" id="inProgressCoursesTab" class="py-2 px-1 font-medium text-blue-600 border-b-2 border-blue-600 course-status-tab" data-status="inProgress">
                                üìö In Progress (<span id="inProgressCount">0</span>)
                            </button>
                            <button type="button" id="upcomingCoursesTab" class="py-2 px-1 font-medium text-gray-600 hover:text-gray-900 course-status-tab" data-status="upcoming">
                                üìÖ Upcoming (<span id="upcomingCount">0</span>)
                            </button>
                            <button type="button" id="finishedCoursesTab" class="py-2 px-1 font-medium text-gray-600 hover:text-gray-900 course-status-tab" data-status="finished">
                                ‚úÖ Finished (<span id="finishedCount">0</span>)
                            </button>
                        </div>
                    </div>

                    <!-- Course Cards Container -->
                    <div id="courseCardsContainer">
                        <!-- Course cards will be populated here -->
                    </div>
                </div>

                <!-- Notes Tab -->
                <div id="notesContent" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Other Notes & Observations</label>
                        <textarea id="studentNotes" rows="8" placeholder="Enter any additional notes, observations, or important information about this student..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                </div>

                <!-- Save/Cancel Buttons -->
                <div class="flex justify-end space-x-3 pt-6 border-t mt-6">
                    <button type="button" id="cancelStudentForm" class="border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        Save Student
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-900">Import Students</h3>
                    <button id="closeImportModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Import Tabs -->
            <div class="border-b">
                <div class="flex space-x-6 px-6">
                    <button id="fileImportTab" class="py-3 px-1 font-medium text-blue-600 border-b-2 border-blue-600 transition-colors">
                        üìÅ File Upload
                    </button>
                    <button id="textImportTab" class="py-3 px-1 font-medium text-gray-600 hover:text-gray-900 transition-colors">
                        üìù Copy & Paste
                    </button>
                </div>
            </div>

            <!-- File Import Content -->
            <div id="fileImportContent" class="p-6">
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
                    <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3-3m-3 3l3 3m-3-3H21" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <div class="mt-4">
                        <label for="fileUpload" class="cursor-pointer">
                            <span class="mt-2 block text-sm font-medium text-gray-900">
                                Drop files here or click to upload
                            </span>
                            <span class="mt-1 block text-sm text-gray-500">
                                CSV files up to 10MB
                            </span>
                        </label>
                        <input id="fileUpload" name="file-upload" type="file" accept=".csv" class="sr-only">
                    </div>
                </div>
            </div>

            <!-- Text Import Content -->
            <div id="textImportContent" class="hidden p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Paste your student data below:</label>
                    <textarea id="importTextArea" rows="8" placeholder="Paste data from Excel, Google Sheets, or CSV format here...&#10;&#10;Example:&#10;STU001	John Smith	15/03/2005	active	Central High	11A	2020&#10;STU002	Jane Doe	22/07/2004	active	West High	11B	2020" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data Format</label>
                        <select id="importFormat" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="auto">Auto-detect</option>
                            <option value="tab">Tab-separated (from Excel)</option>
                            <option value="csv">Comma-separated (CSV)</option>
                            <option value="pipe">Pipe-separated (|)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">First Row</label>
                        <select id="hasHeader" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="true">Contains headers</option>
                            <option value="false">Data only (no headers)</option>
                        </select>
                    </div>
                </div>
                
                <button id="previewImportBtn" class="hidden bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    Preview Data
                </button>
            </div>

            <!-- Column Mapping -->
            <div id="columnMapping" class="hidden border-t p-6">
                <h4 class="text-md font-semibold text-gray-900 mb-3">Map Columns to Student Fields</h4>
                <p class="text-sm text-gray-600 mb-4">Match each column from your data to the corresponding student field. Fields marked with * are required.</p>
                <div id="columnMappingGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Column mapping will be populated here -->
                </div>
            </div>

            <!-- Import Preview -->
            <div id="importPreview" class="hidden border-t p-6">
                <h4 class="text-md font-semibold text-gray-900 mb-3">Data Preview</h4>
                <p id="previewStats" class="text-sm text-gray-600 mb-4"><!-- Stats will be populated here --></p>
                <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr id="previewHeader">
                                <!-- Headers will be populated here -->
                            </tr>
                        </thead>
                        <tbody id="previewBody" class="bg-white">
                            <!-- Preview rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="border-t p-6 flex justify-end space-x-3">
                <button id="cancelImport" class="border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
                    Cancel
                </button>
                <button id="processImport" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    Import Students
                </button>
            </div>
        </div>
    </div>

    <!-- Class Form Modal -->
    <div id="classModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-lg w-full">
            <div class="p-6 border-b">
                <div class="flex items-center justify-between">
                    <h3 id="classModalTitle" class="text-lg font-semibold text-gray-900">Add New Class</h3>
                    <button id="closeClassModal" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <form id="classForm" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Class Name</label>
                    <input type="text" id="className" placeholder="e.g. 12A" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Management Code</label>
                    <input type="text" id="classManagementCode" class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 font-mono text-sm" readonly>
                    <p class="text-xs text-gray-500 mt-1">Auto-generated tracking code</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                    <input type="text" id="classType" placeholder="e.g. IELTS, THPT, General English" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Academic Year</label>
                    <input type="number" id="classYear" min="2020" max="2030" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="classStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancelClassForm" class="border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors">
                        Cancel
                    </button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                        Save Class
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBikDynsjPuXbFCUqfQowEwosO4tl66WOI",
            authDomain: "tnl-app-ver3.firebaseapp.com",
            projectId: "tnl-app-ver3",
            storageBucket: "tnl-app-ver3.firebasestorage.app",
            messagingSenderId: "87206246036",
            appId: "1:87206246036:web:5f96bf7e59a2a0d9a82681",
            measurementId: "G-XGP4JNMZNQ"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let students = [];
        let classes = [];
        let studentStats = [];
        let usedStudentIds = []; // Track all used student IDs (including deleted ones)
        let courses = [];
        let enrollments = [];
        let attendanceDates = [];
        let attendance = [];
        let assessments = [];
        let performance = [];
        let currentTab = 'students';
        let currentStatusFilter = 'active';
        let editingStudent = null;
        let editingClass = null;

        // Initialize the application
        async function init() {
            try {
                updateConnectionStatus('connecting');
                setupEventListeners();
                await loadData();
                updateConnectionStatus('connected');
                updateDashboard();
                renderStudents();
                renderClasses();
            } catch (error) {
                console.error('Initialization error:', error);
                updateConnectionStatus('connected'); // Show as connected even if using sample data
                // Load sample data as fallback
                loadSampleData();
                updateDashboard();
                renderStudents();
                renderClasses();
            }
        }

        // Update connection status indicator
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('syncIndicator');
            const statusDot = document.getElementById('connectionStatus');
            
            switch(status) {
                case 'connecting':
                    indicator.textContent = 'Connecting...';
                    statusDot.className = 'w-3 h-3 bg-yellow-500 rounded-full';
                    break;
                case 'connected':
                    indicator.textContent = 'Connected';
                    statusDot.className = 'w-3 h-3 bg-green-500 rounded-full';
                    break;
                case 'error':
                    indicator.textContent = 'Connection Error';
                    statusDot.className = 'w-3 h-3 bg-red-500 rounded-full';
                    break;
            }
        }

        // Load data from Firestore
        async function loadData() {
            try {
                // Load students
                const studentsSnapshot = await db.collection('students').get();
                students = studentsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Load classes
                const classesSnapshot = await db.collection('classes').get();
                classes = classesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Load student stats
                const statsSnapshot = await db.collection('studentStats').get();
                studentStats = statsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Load used student IDs (including deleted ones)
                const usedIdsSnapshot = await db.collection('usedStudentIds').get();
                usedStudentIds = usedIdsSnapshot.docs.map(doc => doc.id);

                // Also add current student IDs to the used list
                students.forEach(student => {
                    if (student.humanId && !usedStudentIds.includes(student.humanId)) {
                        usedStudentIds.push(student.humanId);
                    }
                });

                // Load learning progress data
                const coursesSnapshot = await db.collection('courses').get();
                courses = coursesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                const enrollmentsSnapshot = await db.collection('enrollments').get();
                enrollments = enrollmentsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                const attendanceDatesSnapshot = await db.collection('attendanceDates').get();
                attendanceDates = attendanceDatesSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                const attendanceSnapshot = await db.collection('attendance').get();
                attendance = attendanceSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                const assessmentsSnapshot = await db.collection('assessments').get();
                assessments = assessmentsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                const performanceSnapshot = await db.collection('performance').get();
                performance = performanceSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                populateClassDropdowns();
            } catch (error) {
                console.error('Error loading data:', error);
                // Fall back to sample data if Firebase fails
                loadSampleData();
            }
        }

        // Load sample data as fallback
        function loadSampleData() {
            students = [
                {
                    id: 'student_stu001_alice_johnson',
                    fullName: 'Alice Johnson',
                    normalizedFullName: 'alice johnson',
                    humanId: 'STU001',
                    managementCode: 'STU-20-09-001',
                    dateOfBirth: '2005-03-15',
                    status: 'active',
                    classRef: 'classes/class_11a_11a_ielts',
                    school: 'Central High School',
                    enrollmentYear: 2020,
                    graduationYear: null,
                    contact: {
                        studentPhone: '+1-555-0123',
                        parentName: 'Mary Johnson',
                        parentPhone: '+1-555-0124',
                        emergencyContact: '+1-555-0125'
                    },
                    notes: 'Excellent student with strong motivation',
                    progressNotes: 'Shows consistent improvement in speaking skills',
                    searchTokens: ['alice', 'johnson', 'stu001'],
                    createdAt: new Date('2020-09-01'),
                    updatedAt: new Date('2024-01-15')
                }
            ];

            classes = [
                {
                    id: 'class_11a_11a_ielts',
                    name: '11A',
                    type: 'IELTS',
                    year: 2024,
                    status: 'active',
                    managementCode: 'CLS-24-01-01',
                    createdAt: new Date('2024-01-01'),
                    updatedAt: new Date('2024-01-01')
                }
            ];

            // Initialize used IDs with sample data
            usedStudentIds = ['STU001'];

            populateClassDropdowns();
        }

        // Save student to Firestore
        async function saveStudent(studentData) {
            try {
                if (studentData.id && students.find(s => s.id === studentData.id)) {
                    // Update existing student (ID cannot be changed)
                    const docId = studentData.id;
                    const updateData = { ...studentData };
                    delete updateData.id; // Remove id from update data
                    await db.collection('students').doc(docId).update(updateData);
                    const index = students.findIndex(s => s.id === studentData.id);
                    students[index] = studentData;
                } else {
                    // Create new student with custom document ID including name
                    const docId = createDocumentId(studentData.humanId, 'student', studentData.fullName);
                    const saveData = { ...studentData };
                    delete saveData.id; // Remove id from save data
                    
                    // Add management code for tracking
                    saveData.managementCode = generateManagementCode('student', studentData);
                    
                    // Reserve the student ID permanently
                    await db.collection('usedStudentIds').doc(studentData.humanId).set({
                        reservedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        status: 'active',
                        managementCode: saveData.managementCode,
                        fullName: studentData.fullName
                    });
                    
                    await db.collection('students').doc(docId).set(saveData);
                    studentData.id = docId;
                    studentData.managementCode = saveData.managementCode;
                    students.push(studentData);
                    
                    // Add to local used IDs list
                    if (!usedStudentIds.includes(studentData.humanId)) {
                        usedStudentIds.push(studentData.humanId);
                    }
                }
                return true;
            } catch (error) {
                console.error('Error saving student:', error);
                return false;
            }
        }

        // Save class to Firestore
        async function saveClass(classData) {
            try {
                if (classData.id && classes.find(c => c.id === classData.id)) {
                    // Update existing class
                    const docId = classData.id;
                    const updateData = { ...classData };
                    delete updateData.id; // Remove id from update data
                    await db.collection('classes').doc(docId).update(updateData);
                    const index = classes.findIndex(c => c.id === classData.id);
                    classes[index] = classData;
                } else {
                    // Create new class with custom document ID including name and type
                    const additionalInfo = `${classData.name}_${classData.type}`;
                    const docId = createDocumentId(classData.name, 'class', additionalInfo);
                    const saveData = { ...classData };
                    delete saveData.id; // Remove id from save data
                    
                    // Add management code for tracking
                    saveData.managementCode = generateManagementCode('class', classData);
                    
                    await db.collection('classes').doc(docId).set(saveData);
                    classData.id = docId;
                    classData.managementCode = saveData.managementCode;
                    classes.push(classData);
                }
                return true;
            } catch (error) {
                console.error('Error saving class:', error);
                return false;
            }
        }

        // Delete student from Firestore
        async function deleteStudentFromDB(studentId) {
            try {
                const student = students.find(s => s.id === studentId);
                if (student && student.humanId) {
                    // Mark the ID as deleted but keep it reserved
                    await db.collection('usedStudentIds').doc(student.humanId).update({
                        status: 'deleted',
                        deletedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                await db.collection('students').doc(studentId).delete();
                students = students.filter(s => s.id !== studentId);
                return true;
            } catch (error) {
                console.error('Error deleting student:', error);
                return false;
            }
        }

        // Populate class dropdowns and year filters
        function populateClassDropdowns() {
            const classSelect = document.getElementById('studentClassRef');
            const classFilter = document.getElementById('classFilter');
            const enrollmentYearFilter = document.getElementById('enrollmentYearFilter');
            const finishedYearFilter = document.getElementById('finishedYearFilter');
            
            // Clear existing options (except first)
            classSelect.innerHTML = '<option value="">Select Class</option>';
            classFilter.innerHTML = '<option value="">All Classes</option>';
            enrollmentYearFilter.innerHTML = '<option value="">Enrollment Year</option>';
            finishedYearFilter.innerHTML = '<option value="">Finished Year</option>';
            
            // Populate class options
            classes.forEach(cls => {
                const option1 = new Option(`${cls.name} (${cls.type})`, `classes/${cls.id}`);
                const option2 = new Option(`${cls.name} (${cls.type})`, cls.id);
                classSelect.appendChild(option1);
                classFilter.appendChild(option2);
            });
            
            // Populate year filters with unique years from students
            const enrollmentYears = [...new Set(students.map(s => s.enrollmentYear).filter(year => year))].sort((a, b) => b - a);
            const finishedYears = [...new Set(students.map(s => s.graduationYear).filter(year => year))].sort((a, b) => b - a);
            
            enrollmentYears.forEach(year => {
                enrollmentYearFilter.appendChild(new Option(year, year));
            });
            
            finishedYears.forEach(year => {
                finishedYearFilter.appendChild(new Option(year, year));
            });
        }

        // Setup all event listeners
        function setupEventListeners() {
            // Main tabs
            document.getElementById('studentsTab').addEventListener('click', () => switchTab('students'));
            document.getElementById('classesTab').addEventListener('click', () => switchTab('classes'));

            // Status tabs
            document.getElementById('activeTab').addEventListener('click', () => switchStatusTab('active'));
            document.getElementById('inactiveTab').addEventListener('click', () => switchStatusTab('inactive'));
            document.getElementById('droppedTab').addEventListener('click', () => switchStatusTab('dropped'));

            // Profile tabs
            document.getElementById('basicInfoTab').addEventListener('click', () => switchProfileTab('basicInfo'));
            document.getElementById('contactTab').addEventListener('click', () => switchProfileTab('contact'));
            document.getElementById('progressTab').addEventListener('click', () => switchProfileTab('progress'));
            document.getElementById('notesTab').addEventListener('click', () => switchProfileTab('notes'));

            // Additional fields toggle
            document.getElementById('toggleAdditionalFields').addEventListener('click', toggleAdditionalFields);

            // Buttons
            document.getElementById('addStudentBtn').addEventListener('click', () => openStudentModal());
            document.getElementById('importBtn').addEventListener('click', () => openImportModal());
            document.getElementById('exportBtn').addEventListener('click', exportStudents);
            document.getElementById('addClassBtn').addEventListener('click', () => openClassModal());
            document.getElementById('filtersBtn').addEventListener('click', toggleFilters);
            document.getElementById('clearBtn').addEventListener('click', clearFilters);

            // Search and filters
            document.getElementById('searchInput').addEventListener('input', handleSearch);
            document.getElementById('statusFilter').addEventListener('change', renderStudents);
            document.getElementById('classFilter').addEventListener('change', renderStudents);
            document.getElementById('enrollmentYearFilter').addEventListener('change', renderStudents);
            document.getElementById('finishedYearFilter').addEventListener('change', renderStudents);
            document.getElementById('sortByFilter').addEventListener('change', renderStudents);

            // Modal controls
            document.getElementById('closeStudentModal').addEventListener('click', closeStudentModal);
            document.getElementById('closeImportModal').addEventListener('click', closeImportModal);
            document.getElementById('closeClassModal').addEventListener('click', closeClassModal);
            document.getElementById('cancelStudentForm').addEventListener('click', closeStudentModal);
            document.getElementById('cancelImport').addEventListener('click', closeImportModal);
            document.getElementById('cancelClassForm').addEventListener('click', closeClassModal);
            
            // Import tab controls
            document.getElementById('fileImportTab').addEventListener('click', () => switchImportTab('file'));
            document.getElementById('textImportTab').addEventListener('click', () => switchImportTab('text'));
            document.getElementById('previewImportBtn').addEventListener('click', previewImportData);
            document.getElementById('importTextArea').addEventListener('input', handleTextAreaChange);
            document.getElementById('importFormat').addEventListener('change', handleTextAreaChange);
            document.getElementById('hasHeader').addEventListener('change', handleTextAreaChange);
            
            // Add debugging for modal backdrop clicks
            document.getElementById('studentModal').addEventListener('click', function(e) {
                console.log('Modal clicked:', e.target);
                if (e.target === this) {
                    console.log('Backdrop clicked - closing modal');
                    closeStudentModal();
                }
            });

            // Forms
            document.getElementById('studentForm').addEventListener('submit', handleStudentSubmit);
            document.getElementById('classForm').addEventListener('submit', handleClassSubmit);
            document.getElementById('processImport').addEventListener('click', handleImport);

            // Course status tabs
            document.querySelectorAll('.course-status-tab').forEach(tab => {
                tab.addEventListener('click', (e) => switchCourseStatusTab(e.target.dataset.status));
            });

            // Select all functionality
            document.getElementById('selectAllCheckbox').addEventListener('change', handleSelectAll);
        }

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab appearance
            document.getElementById('studentsTab').classList.toggle('tab-active', tab === 'students');
            document.getElementById('classesTab').classList.toggle('tab-active', tab === 'classes');
            
            // Show/hide sections
            document.getElementById('studentsSection').classList.toggle('hidden', tab !== 'students');
            document.getElementById('classesSection').classList.toggle('hidden', tab !== 'classes');
        }

        // Status tab switching
        function switchStatusTab(status) {
            currentStatusFilter = status;
            
            // Update tab appearance
            document.querySelectorAll('[id$="Tab"]').forEach(tab => {
                tab.classList.remove('status-tab-active');
                tab.classList.add('text-gray-600', 'hover:text-gray-900');
            });
            
            const activeTab = document.getElementById(status + 'Tab');
            activeTab.classList.add('status-tab-active');
            activeTab.classList.remove('text-gray-600', 'hover:text-gray-900');
            
            // Keep finished column always visible for consistency
            
            renderStudents();
        }

        // Update dashboard statistics
        function updateDashboard() {
            const totalStudents = students.length;
            const activeStudents = students.filter(s => s.status === 'active').length;
            const inactiveStudents = students.filter(s => s.status === 'inactive' || s.status === 'finished').length;
            const droppedStudents = students.filter(s => s.status === 'dropped').length;
            const totalClasses = classes.length;

            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('activeStudents').textContent = activeStudents;
            document.getElementById('totalClasses').textContent = totalClasses;
            document.getElementById('activeCount').textContent = activeStudents;
            document.getElementById('inactiveCount').textContent = inactiveStudents;
            document.getElementById('droppedCount').textContent = droppedStudents;
        }

        // Render students table
        function renderStudents() {
            const tbody = document.getElementById('studentTableBody');
            let filteredStudents = students;

            // Filter by status
            if (currentStatusFilter === 'active') {
                filteredStudents = students.filter(s => s.status === 'active');
            } else if (currentStatusFilter === 'inactive') {
                filteredStudents = students.filter(s => s.status === 'inactive' || s.status === 'finished');
            } else if (currentStatusFilter === 'dropped') {
                filteredStudents = students.filter(s => s.status === 'dropped');
            }

            // Apply search filter
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredStudents = filteredStudents.filter(student => 
                    student.normalizedFullName?.includes(searchTerm) ||
                    student.humanId?.toLowerCase().includes(searchTerm) ||
                    student.school?.toLowerCase().includes(searchTerm) ||
                    student.searchTokens?.some(token => token.startsWith(searchTerm)) ||
                    (student.contact?.studentPhone && student.contact.studentPhone.includes(searchTerm)) ||
                    (student.contact?.parentPhone && student.contact.parentPhone.includes(searchTerm))
                );
            }

            // Apply additional filters
            const classFilter = document.getElementById('classFilter').value;
            const enrollmentYearFilter = document.getElementById('enrollmentYearFilter').value;
            const finishedYearFilter = document.getElementById('finishedYearFilter').value;
            const sortByFilter = document.getElementById('sortByFilter').value;

            if (classFilter) {
                filteredStudents = filteredStudents.filter(student => 
                    student.classRef === `classes/${classFilter}`
                );
            }

            if (enrollmentYearFilter) {
                filteredStudents = filteredStudents.filter(student => 
                    student.enrollmentYear == enrollmentYearFilter
                );
            }

            if (finishedYearFilter) {
                filteredStudents = filteredStudents.filter(student => 
                    student.graduationYear == finishedYearFilter
                );
            }

            // Apply sorting
            if (sortByFilter) {
                switch (sortByFilter) {
                    case 'name-asc':
                        filteredStudents.sort((a, b) => (a.fullName || '').localeCompare(b.fullName || ''));
                        break;
                    case 'name-desc':
                        filteredStudents.sort((a, b) => (b.fullName || '').localeCompare(a.fullName || ''));
                        break;
                    case 'id-asc':
                        filteredStudents.sort((a, b) => (a.humanId || '').localeCompare(b.humanId || ''));
                        break;
                    case 'id-desc':
                        filteredStudents.sort((a, b) => (b.humanId || '').localeCompare(a.humanId || ''));
                        break;
                    case 'newest':
                        filteredStudents.sort((a, b) => new Date(b.createdAt || 0) - new Date(a.createdAt || 0));
                        break;
                    case 'oldest':
                        filteredStudents.sort((a, b) => new Date(a.createdAt || 0) - new Date(b.createdAt || 0));
                        break;
                }
            }

            if (filteredStudents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="px-6 py-8 text-center text-gray-500">
                            No students found matching your criteria.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredStudents.map(student => {
                const className = getClassNameFromRef(student.classRef);
                const contactInfo = student.contact ? `${student.contact.studentPhone || ''} ${student.contact.parentPhone || ''}`.trim() : '';
                
                return `
                <tr class="hover:bg-gray-50 cursor-pointer" onclick="openStudentProfile('${student.id}')">
                    <td class="w-12 px-3 py-4" onclick="event.stopPropagation()">
                        <input type="checkbox" class="student-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500" data-id="${student.id}">
                    </td>
                    <td class="w-24 px-3 py-4 text-sm font-medium text-gray-900 truncate" title="${student.humanId || ''}">${student.humanId || ''}</td>
                    <td class="w-48 px-3 py-4 text-sm text-gray-900 truncate" title="${student.fullName || ''}">${student.fullName || ''}</td>
                    <td class="w-24 px-3 py-4 text-sm text-gray-900 text-center">${student.dateOfBirth ? new Date(student.dateOfBirth).toLocaleDateString('en-GB') : '-'}</td>
                    <td class="w-20 px-3 py-4">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(student.status)}">
                            ${student.status ? student.status.charAt(0).toUpperCase() + student.status.slice(1) : 'Unknown'}
                        </span>
                    </td>
                    <td class="hidden sm:table-cell w-40 px-3 py-4 text-sm text-gray-900 truncate" title="${student.school || ''}">${student.school || ''}</td>
                    <td class="hidden md:table-cell w-32 px-3 py-4 text-sm text-gray-900 truncate" title="${getClassNameOnly(student.classRef)}">${getClassNameOnly(student.classRef)}</td>
                    <td class="hidden lg:table-cell w-20 px-3 py-4 text-sm text-gray-900 text-center">${student.enrollmentYear || ''}</td>
                    <td class="hidden lg:table-cell w-20 px-3 py-4 text-sm text-gray-900 text-center">${student.graduationYear || '-'}</td>
                    <td class="w-24 px-3 py-4 text-sm font-medium" onclick="event.stopPropagation()">
                        <div class="flex space-x-1">
                            <button onclick="editStudent('${student.id}')" class="text-blue-600 hover:text-blue-900 text-xs">Edit</button>
                            <button onclick="deleteStudent('${student.id}')" class="text-red-600 hover:text-red-900 text-xs">Del</button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // Render classes table
        function renderClasses() {
            const tbody = document.getElementById('classTableBody');
            
            if (classes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            No classes found. Click "Add Class" to get started.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = classes.map(cls => {
                const studentCount = students.filter(s => s.classRef === `classes/${cls.id}`).length;
                
                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${cls.name || ''}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${cls.type || ''}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${cls.year || ''}</td>
                    <td class="hidden md:table-cell px-6 py-4 text-sm text-gray-500 font-mono">${cls.managementCode || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">${studentCount}</td>
                    <td class="px-6 py-4">
                        <button onclick="toggleStudentList('${cls.id}')" class="text-blue-600 hover:text-blue-900 text-sm font-medium transition-colors" id="viewListBtn_${cls.id}">
                            View List (${studentCount})
                        </button>
                        <div id="studentList_${cls.id}" class="hidden mt-3 p-3 bg-gray-50 rounded-lg border">
                            <div class="flex items-center justify-between mb-2">
                                <h4 class="font-medium text-gray-900 text-sm">Students in ${cls.name}</h4>
                                <span class="text-xs text-gray-500">${studentCount} enrolled</span>
                            </div>
                            <div id="studentListContent_${cls.id}" class="space-y-1 max-h-48 overflow-y-auto">
                                <!-- Student list will be populated here -->
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(cls.status)}">
                            ${cls.status ? cls.status.charAt(0).toUpperCase() + cls.status.slice(1) : 'Unknown'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm font-medium space-x-2">
                        <button onclick="editClass('${cls.id}')" class="text-blue-600 hover:text-blue-900">Edit</button>
                        <button onclick="deleteClass('${cls.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                </tr>
                `;
            }).join('');
        }

        // Get status color classes
        function getStatusColor(status) {
            switch(status) {
                case 'active': return 'bg-green-100 text-green-800';
                case 'inactive': return 'bg-yellow-100 text-yellow-800';
                case 'finished': return 'bg-blue-100 text-blue-800';
                case 'dropped': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // Get class name from reference
        function getClassNameFromRef(classRef) {
            if (!classRef) return '-';
            const classId = classRef.split('/')[1];
            const cls = classes.find(c => c.id === classId);
            return cls ? `${cls.name} (${cls.type})` : '-';
        }

        // Get class name only (without type)
        function getClassNameOnly(classRef) {
            if (!classRef) return '-';
            const classId = classRef.split('/')[1];
            const cls = classes.find(c => c.id === classId);
            return cls ? cls.name : '-';
        }

        // Generate search tokens
        function generateSearchTokens(text) {
            return text.toLowerCase()
                .replace(/[^\w\s]/g, '')
                .split(/\s+/)
                .filter(token => token.length > 0);
        }

        // Generate normalized name
        function normalizeText(text) {
            return text.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '');
        }

        // Generate unique student ID
        function generateStudentId() {
            const existingIds = students.map(s => s.humanId).filter(id => id);
            let counter = 1;
            let newId;
            
            do {
                newId = `STU${counter.toString().padStart(3, '0')}`;
                counter++;
            } while (existingIds.includes(newId));
            
            return newId;
        }

        // Generate unique class ID
        function generateClassId() {
            const existingIds = classes.map(c => c.name).filter(name => name);
            let counter = 1;
            let newId;
            
            do {
                newId = `CLASS${counter.toString().padStart(2, '0')}`;
                counter++;
            } while (existingIds.includes(newId));
            
            return newId;
        }

        // Create document ID from human-readable ID and additional info
        function createDocumentId(humanId, type = 'student', additionalInfo = '') {
            // Remove special characters and convert to lowercase
            const cleanId = humanId.toLowerCase().replace(/[^a-z0-9]/g, '');
            
            if (type === 'student' && additionalInfo) {
                // For students: include Student ID and Full Name
                const cleanName = additionalInfo.toLowerCase()
                    .replace(/[^a-z0-9\s]/g, '')
                    .replace(/\s+/g, '_')
                    .substring(0, 20); // Limit name length
                return `student_${cleanId}_${cleanName}`;
            } else if (type === 'class' && additionalInfo) {
                // For classes: include class name and type
                const cleanInfo = additionalInfo.toLowerCase()
                    .replace(/[^a-z0-9\s]/g, '')
                    .replace(/\s+/g, '_')
                    .substring(0, 25); // Limit info length
                return `class_${cleanId}_${cleanInfo}`;
            }
            
            // Fallback to original format
            return `${type}_${cleanId}`;
        }

        // Generate management codes for tracking
        function generateManagementCode(type, data) {
            const timestamp = new Date().getFullYear().toString().slice(-2);
            const month = (new Date().getMonth() + 1).toString().padStart(2, '0');
            
            if (type === 'student') {
                // Format: STU-YY-MM-XXX (e.g., STU-24-12-001)
                const sequence = (students.length + 1).toString().padStart(3, '0');
                return `STU-${timestamp}-${month}-${sequence}`;
            } else if (type === 'class') {
                // Format: CLS-YY-MM-XX (e.g., CLS-24-12-01)
                const sequence = (classes.length + 1).toString().padStart(2, '0');
                return `CLS-${timestamp}-${month}-${sequence}`;
            }
            
            return null;
        }

        // Check if student ID is unique (including deleted ones)
        function isStudentIdUnique(humanId, excludeId = null) {
            // For existing students being edited, allow their current ID
            if (excludeId) {
                const existingStudent = students.find(s => s.id === excludeId);
                if (existingStudent && existingStudent.humanId === humanId) {
                    return true;
                }
            }
            
            // Check if ID has ever been used (including deleted students)
            return !usedStudentIds.includes(humanId);
        }

        // Profile tab switching
        function switchProfileTab(tab) {
            // Update tab appearance
            document.querySelectorAll('[id$="Tab"]').forEach(tabEl => {
                if (tabEl.id.includes('basicInfo') || tabEl.id.includes('contact') || tabEl.id.includes('progress') || tabEl.id.includes('notes')) {
                    tabEl.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                    tabEl.classList.add('text-gray-600', 'hover:text-gray-900');
                }
            });
            
            const activeTab = document.getElementById(tab + 'Tab');
            activeTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            activeTab.classList.remove('text-gray-600', 'hover:text-gray-900');
            
            // Show/hide content
            document.getElementById('basicInfoContent').classList.toggle('hidden', tab !== 'basicInfo');
            document.getElementById('contactContent').classList.toggle('hidden', tab !== 'contact');
            document.getElementById('progressContent').classList.toggle('hidden', tab !== 'progress');
            document.getElementById('notesContent').classList.toggle('hidden', tab !== 'notes');
        }

        // Toggle additional fields
        function toggleAdditionalFields() {
            const fields = document.getElementById('additionalFields');
            const toggle = document.getElementById('toggleAdditionalFields');
            
            if (fields.classList.contains('hidden')) {
                fields.classList.remove('hidden');
                toggle.textContent = 'Hide additional fields';
            } else {
                fields.classList.add('hidden');
                toggle.textContent = 'Show additional fields';
            }
        }

        // Open student profile (when clicking on row)
        function openStudentProfile(studentId) {
            editingStudent = studentId;
            const student = students.find(s => s.id === studentId);
            const modal = document.getElementById('studentModal');
            const title = document.getElementById('studentModalTitle');
            
            title.textContent = `${student.fullName} - Student Profile`;
            populateStudentForm(student);
            
            // Show additional fields for existing students
            document.getElementById('additionalFields').classList.remove('hidden');
            document.getElementById('toggleAdditionalFields').textContent = 'Hide additional fields';
            
            // Update progress tab info
            updateProgressTab(student);
            
            // Show all tabs for existing students
            document.getElementById('contactTab').style.display = 'block';
            document.getElementById('progressTab').style.display = 'block';
            document.getElementById('notesTab').style.display = 'block';
            
            modal.classList.remove('hidden');
        }

        // Modal functions
        function openStudentModal(studentId = null) {
            editingStudent = studentId;
            const modal = document.getElementById('studentModal');
            const title = document.getElementById('studentModalTitle');
            
            if (studentId) {
                openStudentProfile(studentId);
                return;
            } else {
                title.textContent = 'Add New Student';
                document.getElementById('studentForm').reset();
                
                // Clear the student ID field for manual entry
                const studentIdField = document.getElementById('studentHumanId');
                studentIdField.value = '';
                studentIdField.readOnly = false;
                studentIdField.classList.remove('bg-gray-50');
                studentIdField.parentElement.querySelector('p').textContent = 'Enter unique ID (cannot be changed later)';
                
                // Hide additional fields for new students
                document.getElementById('additionalFields').classList.add('hidden');
                document.getElementById('toggleAdditionalFields').textContent = 'Show additional fields';
                
                // Hide other tabs for new students
                document.getElementById('contactTab').style.display = 'none';
                document.getElementById('progressTab').style.display = 'none';
                document.getElementById('notesTab').style.display = 'none';
                
                // Switch to basic info tab
                switchProfileTab('basicInfo');
            }
            
            modal.classList.remove('hidden');
        }

        function closeStudentModal() {
            document.getElementById('studentModal').classList.add('hidden');
            editingStudent = null;
        }

        function openImportModal() {
            // Reset to file import tab by default
            switchImportTab('file');
            document.getElementById('importTextArea').value = '';
            resetImportState();
            document.getElementById('importModal').classList.remove('hidden');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.add('hidden');
        }

        function openClassModal(classId = null) {
            editingClass = classId;
            const modal = document.getElementById('classModal');
            const title = document.getElementById('classModalTitle');
            
            if (classId) {
                const cls = classes.find(c => c.id === classId);
                title.textContent = 'Edit Class';
                populateClassForm(cls);
            } else {
                title.textContent = 'Add New Class';
                document.getElementById('classForm').reset();
            }
            
            modal.classList.remove('hidden');
        }

        function closeClassModal() {
            document.getElementById('classModal').classList.add('hidden');
            editingClass = null;
        }

        // Form handling
        function populateStudentForm(student) {
            const studentIdField = document.getElementById('studentHumanId');
            studentIdField.value = student.humanId || '';
            
            // Make Student ID readonly for existing students
            if (student.id) {
                studentIdField.readOnly = true;
                studentIdField.classList.add('bg-gray-50');
                studentIdField.parentElement.querySelector('p').textContent = 'Student ID cannot be changed';
            } else {
                studentIdField.readOnly = false;
                studentIdField.classList.remove('bg-gray-50');
                studentIdField.parentElement.querySelector('p').textContent = 'Enter unique ID (cannot be changed later)';
            }
            
            document.getElementById('studentFullName').value = student.fullName || '';
            document.getElementById('studentManagementCode').value = student.managementCode || '';
            document.getElementById('studentDateOfBirth').value = student.dateOfBirth || '';
            document.getElementById('studentStatus').value = student.status || 'active';
            document.getElementById('studentClassRef').value = student.classRef || '';
            document.getElementById('studentSchool').value = student.school || '';
            document.getElementById('studentEnrollmentYear').value = student.enrollmentYear || '';
            document.getElementById('studentGraduationYear').value = student.graduationYear || '';
            document.getElementById('studentPhone').value = student.contact?.studentPhone || '';
            document.getElementById('parentName').value = student.contact?.parentName || '';
            document.getElementById('parentPhone').value = student.contact?.parentPhone || '';
            document.getElementById('emergencyContact').value = student.contact?.emergencyContact || '';
            document.getElementById('studentNotes').value = student.notes || '';
            document.getElementById('progressNotes').value = student.progressNotes || '';
        }

        function updateProgressTab(student) {
            document.getElementById('progressStudentName').textContent = student.fullName || 'Student Name';
            document.getElementById('progressStudentId').textContent = student.humanId || 'STU001';
            
            const statusElement = document.getElementById('progressStudentStatus');
            statusElement.textContent = student.status ? student.status.charAt(0).toUpperCase() + student.status.slice(1) : 'Unknown';
            statusElement.className = `inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(student.status)}`;
            
            // Calculate and display progress statistics
            updateProgressStatistics(student);
            
            // Load and display courses
            loadStudentCourses(student);
        }

        // Calculate progress statistics for a student
        function updateProgressStatistics(student) {
            const studentEnrollments = enrollments.filter(e => e.studentId === student.id);
            const studentCourseIds = studentEnrollments.map(e => e.courseId);
            
            // Get all attendance records for this student
            const studentAttendance = attendance.filter(a => a.studentId === student.id);
            
            // Get all performance records for this student
            const studentPerformance = performance.filter(p => p.studentId === student.id);
            
            // Calculate first and recent lesson dates
            const attendanceDatesForStudent = attendanceDates.filter(ad => 
                studentCourseIds.includes(ad.courseId) && 
                studentAttendance.some(sa => sa.dateId === ad.id)
            );
            
            let firstLessonDate = null;
            let recentLessonDate = null;
            
            if (attendanceDatesForStudent.length > 0) {
                const sortedDates = attendanceDatesForStudent
                    .map(ad => new Date(ad.date))
                    .sort((a, b) => a - b);
                
                firstLessonDate = sortedDates[0];
                recentLessonDate = sortedDates[sortedDates.length - 1];
            }
            
            // Update display
            document.getElementById('firstLessonDate').textContent = firstLessonDate ? 
                firstLessonDate.toLocaleDateString() : '-';
            document.getElementById('recentLessonDate').textContent = recentLessonDate ? 
                recentLessonDate.toLocaleDateString() : '-';
            document.getElementById('totalLessons').textContent = studentAttendance.length;
            document.getElementById('totalAssessments').textContent = studentPerformance.length;
        }

        // Load and display courses for a student
        function loadStudentCourses(student) {
            const studentEnrollments = enrollments.filter(e => e.studentId === student.id);
            const studentCourses = studentEnrollments.map(enrollment => {
                const course = courses.find(c => c.id === enrollment.courseId);
                return course ? { ...course, enrollmentStatus: enrollment.status } : null;
            }).filter(Boolean);
            
            // Group courses by status
            const inProgressCourses = studentCourses.filter(c => c.status === 'inProgress');
            const upcomingCourses = studentCourses.filter(c => c.status === 'upcoming');
            const finishedCourses = studentCourses.filter(c => c.status === 'finished');
            
            // Update counts
            document.getElementById('inProgressCount').textContent = inProgressCourses.length;
            document.getElementById('upcomingCount').textContent = upcomingCourses.length;
            document.getElementById('finishedCount').textContent = finishedCourses.length;
            
            // Display courses for the active tab (default: in progress)
            displayCourses(inProgressCourses, student);
        }

        // Switch course status tab
        function switchCourseStatusTab(status) {
            // Update tab appearance
            document.querySelectorAll('.course-status-tab').forEach(tab => {
                tab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                tab.classList.add('text-gray-600', 'hover:text-gray-900');
            });
            
            const activeTab = document.getElementById(status + 'CoursesTab');
            activeTab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
            activeTab.classList.remove('text-gray-600', 'hover:text-gray-900');
            
            // Get current student and display courses for selected status
            if (editingStudent) {
                const student = students.find(s => s.id === editingStudent);
                if (student) {
                    const studentEnrollments = enrollments.filter(e => e.studentId === student.id);
                    const studentCourses = studentEnrollments.map(enrollment => {
                        const course = courses.find(c => c.id === enrollment.courseId);
                        return course ? { ...course, enrollmentStatus: enrollment.status } : null;
                    }).filter(Boolean);
                    
                    const filteredCourses = studentCourses.filter(c => c.status === status);
                    displayCourses(filteredCourses, student);
                }
            }
        }

        // Display courses in cards
        function displayCourses(courses, student) {
            const container = document.getElementById('courseCardsContainer');
            
            if (courses.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <div class="text-4xl mb-2">üìö</div>
                        <p>No courses found for this category</p>
                        <p class="text-sm">Course information will appear here once enrolled</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = courses.map(course => {
                const courseAttendance = attendance.filter(a => 
                    a.studentId === student.id && a.courseId === course.id
                );
                const coursePerformance = performance.filter(p => 
                    p.studentId === student.id && p.courseId === course.id
                );
                const courseAssessments = assessments.filter(a => a.courseId === course.id);
                
                // Calculate attendance rate
                const totalLessons = attendanceDates.filter(ad => ad.courseId === course.id).length;
                const attendedLessons = courseAttendance.filter(a => a.status === 'present').length;
                const attendanceRate = totalLessons > 0 ? Math.round((attendedLessons / totalLessons) * 100) : 0;
                
                // Calculate average score
                const scores = coursePerformance.map(p => p.score).filter(s => s != null);
                const averageScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : null;
                
                return `
                    <div class="bg-white border rounded-lg p-4 card-shadow">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <h4 class="text-base font-semibold text-gray-900">${course.name}</h4>
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(course.status)}">
                                        ${course.status ? course.status.charAt(0).toUpperCase() + course.status.slice(1) : 'Unknown'}
                                    </span>
                                </div>
                                <p class="text-xs text-gray-600">${course.code} ‚Ä¢ ${course.teacher || 'No teacher'} ‚Ä¢ ${course.schedule || 'No schedule'}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div class="text-center p-2 bg-gray-50 rounded">
                                <div class="text-lg font-bold text-blue-600">${attendanceRate}%</div>
                                <div class="text-xs text-gray-600">Attendance</div>
                                <div class="text-xs text-gray-500">${attendedLessons}/${totalLessons}</div>
                            </div>
                            <div class="text-center p-2 bg-gray-50 rounded">
                                <div class="text-lg font-bold text-green-600">${averageScore !== null ? averageScore + '%' : '-'}</div>
                                <div class="text-xs text-gray-600">Avg Score</div>
                                <div class="text-xs text-gray-500">${coursePerformance.length}/${courseAssessments.length}</div>
                            </div>
                            <div class="text-center p-2 bg-gray-50 rounded">
                                <div class="text-lg font-bold text-purple-600">${course.sessionCount || 0}</div>
                                <div class="text-xs text-gray-600">Sessions</div>
                                <div class="text-xs text-gray-500">total</div>
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <button onclick="toggleAttendanceHistory('${course.id}', '${student.id}', event)" class="w-full flex items-center justify-between px-3 py-2 bg-blue-50 hover:bg-blue-100 text-sm font-medium text-blue-700 transition-colors">
                                    <span>üìÖ Attendance History (${attendedLessons}/${totalLessons})</span>
                                    <svg id="attendanceChevron_${course.id}" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div id="attendanceHistory_${course.id}" class="hidden px-3 py-2 bg-gray-50 text-xs border-t border-gray-200">
                                    <div class="text-gray-600 mb-2 font-medium">Recent attendance records:</div>
                                    <div id="attendanceDetails_${course.id}">Loading...</div>
                                </div>
                            </div>
                            
                            <div class="border border-gray-200 rounded-lg overflow-hidden">
                                <button onclick="toggleAssessmentHistory('${course.id}', '${student.id}', event)" class="w-full flex items-center justify-between px-3 py-2 bg-green-50 hover:bg-green-100 text-sm font-medium text-green-700 transition-colors">
                                    <span>üìä Assessment History (${coursePerformance.length}/${courseAssessments.length})</span>
                                    <svg id="assessmentChevron_${course.id}" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div id="assessmentHistory_${course.id}" class="hidden px-3 py-2 bg-gray-50 text-xs border-t border-gray-200">
                                    <div class="text-gray-600 mb-2 font-medium">Recent assessment scores:</div>
                                    <div id="assessmentDetails_${course.id}">Loading...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle attendance history display
        function toggleAttendanceHistory(courseId, studentId, event) {
            console.log('toggleAttendanceHistory called', { courseId, studentId, event });
            
            // Stop event propagation to prevent modal from closing
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
            }
            
            const historyDiv = document.getElementById(`attendanceHistory_${courseId}`);
            const detailsDiv = document.getElementById(`attendanceDetails_${courseId}`);
            const chevron = document.getElementById(`attendanceChevron_${courseId}`);
            
            console.log('Elements found:', { historyDiv, detailsDiv, chevron });
            
            if (historyDiv.classList.contains('hidden')) {
                // Show attendance history
                historyDiv.classList.remove('hidden');
                chevron.classList.add('rotate-180');
                
                // Load attendance data
                const studentAttendanceRecords = attendance.filter(a => 
                    a.studentId === studentId && a.courseId === courseId
                );
                
                if (studentAttendanceRecords.length === 0) {
                    detailsDiv.innerHTML = '<div class="text-gray-500">No attendance records found</div>';
                } else {
                    // Get the most recent 5 records
                    const recentRecords = studentAttendanceRecords
                        .map(record => {
                            const dateInfo = attendanceDates.find(ad => ad.id === record.dateId);
                            return { ...record, dateInfo };
                        })
                        .filter(record => record.dateInfo)
                        .sort((a, b) => new Date(b.dateInfo.date) - new Date(a.dateInfo.date))
                        .slice(0, 5);
                    
                    detailsDiv.innerHTML = recentRecords.map(record => `
                        <div class="flex justify-between items-center py-1">
                            <span>${new Date(record.dateInfo.date).toLocaleDateString()} - ${record.dateInfo.lessonName || 'Lesson'}</span>
                            <span class="px-2 py-1 rounded text-xs ${record.status === 'present' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${record.status === 'present' ? '‚úì Present' : '‚úó Absent'}
                            </span>
                        </div>
                    `).join('');
                    
                    if (studentAttendanceRecords.length > 5) {
                        detailsDiv.innerHTML += `<div class="text-gray-500 text-center mt-2">... and ${studentAttendanceRecords.length - 5} more records</div>`;
                    }
                }
            } else {
                // Hide attendance history
                historyDiv.classList.add('hidden');
                chevron.classList.remove('rotate-180');
            }
        }

        // Toggle assessment history display
        function toggleAssessmentHistory(courseId, studentId, event) {
            console.log('toggleAssessmentHistory called', { courseId, studentId, event });
            
            // Stop event propagation to prevent modal from closing
            if (event) {
                event.preventDefault();
                event.stopPropagation();
                event.stopImmediatePropagation();
            }
            
            const historyDiv = document.getElementById(`assessmentHistory_${courseId}`);
            const detailsDiv = document.getElementById(`assessmentDetails_${courseId}`);
            const chevron = document.getElementById(`assessmentChevron_${courseId}`);
            
            console.log('Elements found:', { historyDiv, detailsDiv, chevron });
            
            if (historyDiv.classList.contains('hidden')) {
                // Show assessment history
                historyDiv.classList.remove('hidden');
                chevron.classList.add('rotate-180');
                
                // Load assessment data
                const studentPerformanceRecords = performance.filter(p => 
                    p.studentId === studentId && p.courseId === courseId
                );
                
                if (studentPerformanceRecords.length === 0) {
                    detailsDiv.innerHTML = '<div class="text-gray-500">No assessment records found</div>';
                } else {
                    // Get assessment details and sort by date
                    const recentRecords = studentPerformanceRecords
                        .map(record => {
                            const assessmentInfo = assessments.find(a => a.id === record.assessmentId);
                            return { ...record, assessmentInfo };
                        })
                        .filter(record => record.assessmentInfo)
                        .sort((a, b) => new Date(b.assessmentInfo.date) - new Date(a.assessmentInfo.date))
                        .slice(0, 5);
                    
                    detailsDiv.innerHTML = recentRecords.map(record => {
                        const percentage = record.assessmentInfo.maxScore > 0 ? 
                            Math.round((record.score / record.assessmentInfo.maxScore) * 100) : 0;
                        
                        return `
                            <div class="flex justify-between items-center py-1">
                                <div>
                                    <div>${record.assessmentInfo.description || 'Assessment'}</div>
                                    <div class="text-gray-500">${new Date(record.assessmentInfo.date).toLocaleDateString()}</div>
                                </div>
                                <div class="text-right">
                                    <div class="font-medium">${record.score}/${record.assessmentInfo.maxScore} (${percentage}%)</div>
                                    ${record.comments ? `<div class="text-gray-500 text-xs">${record.comments}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    if (studentPerformanceRecords.length > 5) {
                        detailsDiv.innerHTML += `<div class="text-gray-500 text-center mt-2">... and ${studentPerformanceRecords.length - 5} more records</div>`;
                    }
                }
            } else {
                // Hide assessment history
                historyDiv.classList.add('hidden');
                chevron.classList.remove('rotate-180');
            }
        }

        function populateClassForm(cls) {
            document.getElementById('className').value = cls.name || '';
            document.getElementById('classManagementCode').value = cls.managementCode || '';
            document.getElementById('classType').value = cls.type || '';
            document.getElementById('classYear').value = cls.year || '';
            document.getElementById('classStatus').value = cls.status || 'active';
        }

        async function handleStudentSubmit(e) {
            e.preventDefault();
            
            const fullName = document.getElementById('studentFullName').value;
            const humanId = document.getElementById('studentHumanId').value.trim();
            
            // Validate student ID format
            if (!humanId) {
                alert('Student ID is required.');
                return;
            }
            
            // Validate unique student ID
            if (!isStudentIdUnique(humanId, editingStudent)) {
                alert('This Student ID has already been used and cannot be reused. Please choose a different ID.');
                return;
            }
            
            const studentData = {
                fullName: fullName,
                normalizedFullName: normalizeText(fullName),
                humanId: humanId,
                dateOfBirth: document.getElementById('studentDateOfBirth').value,
                status: document.getElementById('studentStatus').value,
                classRef: document.getElementById('studentClassRef').value || null,
                school: document.getElementById('studentSchool').value,
                enrollmentYear: parseInt(document.getElementById('studentEnrollmentYear').value) || null,
                graduationYear: parseInt(document.getElementById('studentGraduationYear').value) || null,
                contact: {
                    studentPhone: document.getElementById('studentPhone').value,
                    parentName: document.getElementById('parentName').value,
                    parentPhone: document.getElementById('parentPhone').value,
                    emergencyContact: document.getElementById('emergencyContact').value
                },
                notes: document.getElementById('studentNotes').value,
                progressNotes: document.getElementById('progressNotes').value,
                searchTokens: generateSearchTokens(`${fullName} ${humanId}`),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (editingStudent) {
                studentData.id = editingStudent;
            } else {
                studentData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }

            const success = await saveStudent(studentData);
            if (success) {
                updateDashboard();
                renderStudents();
                populateClassDropdowns();
                closeStudentModal();
            } else {
                alert('Error saving student. Please try again.');
            }
        }

        async function handleClassSubmit(e) {
            e.preventDefault();
            
            const classData = {
                name: document.getElementById('className').value,
                type: document.getElementById('classType').value,
                year: parseInt(document.getElementById('classYear').value),
                status: document.getElementById('classStatus').value,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (editingClass) {
                classData.id = editingClass;
            } else {
                classData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }

            const success = await saveClass(classData);
            if (success) {
                updateDashboard();
                renderClasses();
                populateClassDropdowns();
                closeClassModal();
            } else {
                alert('Error saving class. Please try again.');
            }
        }

        // Utility functions
        function editStudent(id) {
            openStudentModal(id);
        }

        async function deleteStudent(id) {
            if (confirm('Are you sure you want to delete this student?')) {
                const success = await deleteStudentFromDB(id);
                if (success) {
                    updateDashboard();
                    renderStudents();
                } else {
                    alert('Error deleting student. Please try again.');
                }
            }
        }

        function editClass(id) {
            openClassModal(id);
        }

        async function deleteClass(id) {
            if (confirm('Are you sure you want to delete this class?')) {
                try {
                    await db.collection('classes').doc(id).delete();
                    classes = classes.filter(c => c.id !== id);
                    updateDashboard();
                    renderClasses();
                    populateClassDropdowns();
                } catch (error) {
                    console.error('Error deleting class:', error);
                    alert('Error deleting class. Please try again.');
                }
            }
        }

        function toggleFilters() {
            const panel = document.getElementById('filterPanel');
            panel.classList.toggle('hidden');
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('classFilter').value = '';
            document.getElementById('enrollmentYearFilter').value = '';
            document.getElementById('finishedYearFilter').value = '';
            document.getElementById('sortByFilter').value = 'name-asc';
            renderStudents();
        }

        function handleSearch() {
            renderStudents();
        }

        function handleSelectAll(e) {
            const checkboxes = document.querySelectorAll('.student-checkbox');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
        }

        function exportStudents() {
            const csv = convertToCSV(students);
            downloadCSV(csv, 'students.csv');
        }

        function convertToCSV(data) {
            const headers = ['Human ID', 'Full Name', 'Date of Birth', 'Status', 'School', 'Class', 'Enrollment Year', 'Graduation Year', 'Student Phone', 'Parent Name', 'Parent Phone', 'Emergency Contact', 'Notes'];
            const rows = data.map(student => [
                student.humanId || '',
                student.fullName || '',
                student.dateOfBirth ? new Date(student.dateOfBirth).toLocaleDateString('en-GB') : '',
                student.status || '',
                student.school || '',
                getClassNameFromRef(student.classRef),
                student.enrollmentYear || '',
                student.graduationYear || '',
                student.contact?.studentPhone || '',
                student.contact?.parentName || '',
                student.contact?.parentPhone || '',
                student.contact?.emergencyContact || '',
                student.notes || ''
            ]);
            
            return [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
        }

        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Global variables for import
        let currentImportTab = 'file';
        let parsedImportData = [];
        let importColumnMapping = {};

        // Switch import tabs
        function switchImportTab(tab) {
            currentImportTab = tab;
            
            // Update tab appearance
            document.getElementById('fileImportTab').classList.toggle('text-blue-600', tab === 'file');
            document.getElementById('fileImportTab').classList.toggle('border-b-2', tab === 'file');
            document.getElementById('fileImportTab').classList.toggle('border-blue-600', tab === 'file');
            document.getElementById('fileImportTab').classList.toggle('text-gray-600', tab !== 'file');
            document.getElementById('fileImportTab').classList.toggle('hover:text-gray-900', tab !== 'file');
            
            document.getElementById('textImportTab').classList.toggle('text-blue-600', tab === 'text');
            document.getElementById('textImportTab').classList.toggle('border-b-2', tab === 'text');
            document.getElementById('textImportTab').classList.toggle('border-blue-600', tab === 'text');
            document.getElementById('textImportTab').classList.toggle('text-gray-600', tab !== 'text');
            document.getElementById('textImportTab').classList.toggle('hover:text-gray-900', tab !== 'text');
            
            // Show/hide content
            document.getElementById('fileImportContent').classList.toggle('hidden', tab !== 'file');
            document.getElementById('textImportContent').classList.toggle('hidden', tab !== 'text');
            
            // Show/hide preview button
            document.getElementById('previewImportBtn').classList.toggle('hidden', tab !== 'text');
            
            // Reset import state when switching tabs
            resetImportState();
        }

        // Reset import state
        function resetImportState() {
            parsedImportData = [];
            importColumnMapping = {};
            document.getElementById('columnMapping').classList.add('hidden');
            document.getElementById('importPreview').classList.add('hidden');
            document.getElementById('previewImportBtn').classList.add('hidden');
        }

        // Handle text area changes
        function handleTextAreaChange() {
            const textArea = document.getElementById('importTextArea');
            const previewBtn = document.getElementById('previewImportBtn');
            
            if (textArea.value.trim()) {
                previewBtn.classList.remove('hidden');
            } else {
                previewBtn.classList.add('hidden');
                resetImportState();
            }
        }

        // Parse date in dd/mm/yyyy format and similar formats
        function parseDateString(dateStr) {
            if (!dateStr || !dateStr.trim()) return null;
            
            const cleaned = dateStr.trim();
            
            // Try dd/mm/yyyy, dd-mm-yyyy, dd.mm.yyyy formats
            const ddmmyyyyPattern = /^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/;
            const match = cleaned.match(ddmmyyyyPattern);
            
            if (match) {
                const day = parseInt(match[1]);
                const month = parseInt(match[2]);
                const year = parseInt(match[3]);
                
                // Validate date components
                if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 1900 && year <= 2030) {
                    // Convert to ISO format (yyyy-mm-dd)
                    return `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                }
            }
            
            // Try yyyy-mm-dd format (ISO format)
            const isoPattern = /^(\d{4})-(\d{1,2})-(\d{1,2})$/;
            const isoMatch = cleaned.match(isoPattern);
            if (isoMatch) {
                const year = parseInt(isoMatch[1]);
                const month = parseInt(isoMatch[2]);
                const day = parseInt(isoMatch[3]);
                
                if (day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 1900 && year <= 2030) {
                    return cleaned; // Already in correct format
                }
            }
            
            return null; // Invalid date format
        }

        // Parse text data based on format
        function parseTextData(text, format, hasHeader) {
            const lines = text.trim().split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];
            
            let separator;
            if (format === 'auto') {
                // Auto-detect separator
                const firstLine = lines[0];
                if (firstLine.includes('\t')) separator = '\t';
                else if (firstLine.includes('|')) separator = '|';
                else separator = ',';
            } else if (format === 'tab') {
                separator = '\t';
            } else if (format === 'pipe') {
                separator = '|';
            } else {
                separator = ',';
            }
            
            const rows = lines.map(line => {
                // Simple CSV parsing (doesn't handle quoted fields with separators)
                return line.split(separator).map(cell => cell.trim().replace(/^["']|["']$/g, ''));
            });
            
            let headers = [];
            let dataRows = rows;
            
            if (hasHeader && rows.length > 0) {
                headers = rows[0];
                dataRows = rows.slice(1);
            } else {
                // Generate default headers
                const maxColumns = Math.max(...rows.map(row => row.length));
                headers = Array.from({length: maxColumns}, (_, i) => `Column ${i + 1}`);
            }
            
            return { headers, dataRows };
        }

        // Preview import data
        function previewImportData() {
            const textArea = document.getElementById('importTextArea');
            const format = document.getElementById('importFormat').value;
            const hasHeader = document.getElementById('hasHeader').value === 'true';
            
            const text = textArea.value.trim();
            if (!text) {
                alert('Please paste some data to preview.');
                return;
            }
            
            try {
                const { headers, dataRows } = parseTextData(text, format, hasHeader);
                parsedImportData = { headers, dataRows };
                
                // Show column mapping
                showColumnMapping(headers);
                
                // Show preview
                showImportPreview(headers, dataRows);
                
            } catch (error) {
                console.error('Error parsing data:', error);
                alert('Error parsing the data. Please check the format and try again.');
            }
        }

        // Show column mapping interface
        function showColumnMapping(headers) {
            const mappingDiv = document.getElementById('columnMapping');
            const gridDiv = document.getElementById('columnMappingGrid');
            
            const fieldOptions = [
                { value: '', label: 'Skip this column' },
                { value: 'humanId', label: 'Student ID *' },
                { value: 'fullName', label: 'Full Name *' },
                { value: 'dateOfBirth', label: 'Date of Birth *' },
                { value: 'status', label: 'Status *' },
                { value: 'school', label: 'School' },
                { value: 'classRef', label: 'Class' },
                { value: 'enrollmentYear', label: 'Enrollment Year' },
                { value: 'graduationYear', label: 'Graduation Year' },
                { value: 'studentPhone', label: 'Student Phone' },
                { value: 'parentName', label: 'Parent Name' },
                { value: 'parentPhone', label: 'Parent Phone' },
                { value: 'emergencyContact', label: 'Emergency Contact' },
                { value: 'notes', label: 'Notes' }
            ];
            
            gridDiv.innerHTML = headers.map((header, index) => `
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">${header}</label>
                    <select id="mapping_${index}" class="w-full px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500">
                        ${fieldOptions.map(option => {
                            // Auto-detect mapping based on header name
                            const headerLower = header.toLowerCase();
                            let selected = false;
                            if (headerLower.includes('id') && option.value === 'humanId') selected = true;
                            else if (headerLower.includes('name') && !headerLower.includes('parent') && option.value === 'fullName') selected = true;
                            else if (headerLower.includes('birth') || headerLower.includes('dob') && option.value === 'dateOfBirth') selected = true;
                            else if (headerLower.includes('status') && option.value === 'status') selected = true;
                            else if (headerLower.includes('school') && option.value === 'school') selected = true;
                            else if (headerLower.includes('class') && option.value === 'classRef') selected = true;
                            else if (headerLower.includes('enrollment') && option.value === 'enrollmentYear') selected = true;
                            else if (headerLower.includes('graduation') && option.value === 'graduationYear') selected = true;
                            else if (headerLower.includes('student') && headerLower.includes('phone') && option.value === 'studentPhone') selected = true;
                            else if (headerLower.includes('parent') && headerLower.includes('name') && option.value === 'parentName') selected = true;
                            else if (headerLower.includes('parent') && headerLower.includes('phone') && option.value === 'parentPhone') selected = true;
                            else if (headerLower.includes('emergency') && option.value === 'emergencyContact') selected = true;
                            else if (headerLower.includes('note') && option.value === 'notes') selected = true;
                            
                            return `<option value="${option.value}" ${selected ? 'selected' : ''}>${option.label}</option>`;
                        }).join('')}
                    </select>
                </div>
            `).join('');
            
            mappingDiv.classList.remove('hidden');
        }

        // Show import preview
        function showImportPreview(headers, dataRows) {
            const previewDiv = document.getElementById('importPreview');
            const headerRow = document.getElementById('previewHeader');
            const bodyDiv = document.getElementById('previewBody');
            const statsDiv = document.getElementById('previewStats');
            
            // Show headers
            headerRow.innerHTML = headers.map(header => `<th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">${header}</th>`).join('');
            
            // Show first 5 rows
            const previewRows = dataRows.slice(0, 5);
            bodyDiv.innerHTML = previewRows.map(row => `
                <tr class="border-t border-gray-200">
                    ${row.map(cell => `<td class="px-3 py-2 text-xs text-gray-900">${cell || '-'}</td>`).join('')}
                </tr>
            `).join('');
            
            // Show statistics
            statsDiv.innerHTML = `
                <strong>${dataRows.length}</strong> rows found, showing first <strong>${Math.min(5, dataRows.length)}</strong> rows. 
                <strong>${headers.length}</strong> columns detected.
            `;
            
            previewDiv.classList.remove('hidden');
        }

        // Get column mapping
        function getColumnMapping() {
            const mapping = {};
            const headers = parsedImportData.headers;
            
            headers.forEach((header, index) => {
                const select = document.getElementById(`mapping_${index}`);
                if (select && select.value) {
                    mapping[index] = select.value;
                }
            });
            
            return mapping;
        }

        // Validate required fields
        function validateImportMapping(mapping) {
            const required = ['humanId', 'fullName', 'dateOfBirth', 'status'];
            const mappedFields = Object.values(mapping);
            
            for (const field of required) {
                if (!mappedFields.includes(field)) {
                    return { valid: false, missing: field };
                }
            }
            
            return { valid: true };
        }

        // Process import data
        async function processImportData() {
            if (currentImportTab === 'text') {
                if (!parsedImportData.headers || !parsedImportData.dataRows) {
                    alert('Please preview the data first.');
                    return false;
                }
                
                const mapping = getColumnMapping();
                const validation = validateImportMapping(mapping);
                
                if (!validation.valid) {
                    alert(`Missing required field: ${validation.missing}. Please map all required columns.`);
                    return false;
                }
                
                const studentsToImport = [];
                const errors = [];
                
                for (let i = 0; i < parsedImportData.dataRows.length; i++) {
                    const row = parsedImportData.dataRows[i];
                    const student = {};
                    
                    try {
                        // Map columns to student fields
                        Object.entries(mapping).forEach(([columnIndex, fieldName]) => {
                            const value = row[parseInt(columnIndex)];
                            if (value && value.trim()) {
                                if (fieldName === 'enrollmentYear' || fieldName === 'graduationYear') {
                                    student[fieldName] = parseInt(value);
                                } else if (fieldName === 'classRef') {
                                    // Find class by name
                                    const cls = classes.find(c => c.name === value.trim());
                                    if (cls) {
                                        student[fieldName] = `classes/${cls.id}`;
                                    }
                                } else if (fieldName === 'dateOfBirth') {
                                    // Parse date using dd/mm/yyyy format
                                    const parsedDate = parseDateString(value.trim());
                                    if (parsedDate) {
                                        student[fieldName] = parsedDate;
                                    } else {
                                        errors.push(`Row ${i + 1}: Invalid date format "${value.trim()}" (use dd/mm/yyyy, dd-mm-yyyy, or dd.mm.yyyy)`);
                                        return;
                                    }
                                } else {
                                    student[fieldName] = value.trim();
                                }
                            }
                        });
                        
                        // Validate required fields
                        if (!student.humanId || !student.fullName || !student.dateOfBirth || !student.status) {
                            errors.push(`Row ${i + 1}: Missing required fields`);
                            continue;
                        }
                        
                        // Validate status
                        if (!['active', 'inactive', 'finished', 'dropped'].includes(student.status)) {
                            errors.push(`Row ${i + 1}: Invalid status "${student.status}"`);
                            continue;
                        }
                        
                        // Check for duplicate student ID
                        if (!isStudentIdUnique(student.humanId)) {
                            errors.push(`Row ${i + 1}: Student ID "${student.humanId}" already exists`);
                            continue;
                        }
                        
                        // Add additional fields
                        student.normalizedFullName = normalizeText(student.fullName);
                        student.searchTokens = generateSearchTokens(`${student.fullName} ${student.humanId}`);
                        student.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                        student.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                        
                        // Handle contact information
                        if (student.studentPhone || student.parentName || student.parentPhone || student.emergencyContact) {
                            student.contact = {
                                studentPhone: student.studentPhone || '',
                                parentName: student.parentName || '',
                                parentPhone: student.parentPhone || '',
                                emergencyContact: student.emergencyContact || ''
                            };
                            delete student.studentPhone;
                            delete student.parentName;
                            delete student.parentPhone;
                            delete student.emergencyContact;
                        }
                        
                        studentsToImport.push(student);
                        
                    } catch (error) {
                        errors.push(`Row ${i + 1}: ${error.message}`);
                    }
                }
                
                if (errors.length > 0) {
                    const proceed = confirm(`Found ${errors.length} errors:\n${errors.slice(0, 5).join('\n')}${errors.length > 5 ? '\n...' : ''}\n\nProceed with importing ${studentsToImport.length} valid students?`);
                    if (!proceed) return false;
                }
                
                // Import students
                let successCount = 0;
                for (const student of studentsToImport) {
                    const success = await saveStudent(student);
                    if (success) successCount++;
                }
                
                alert(`Successfully imported ${successCount} out of ${studentsToImport.length} students.`);
                return successCount > 0;
                
            } else {
                // File import (placeholder)
                const fileInput = document.getElementById('fileUpload');
                if (fileInput.files.length === 0) {
                    alert('Please select a CSV file to import.');
                    return false;
                }
                
                alert('File import functionality will be implemented here.');
                return false;
            }
        }

        function handleImport() {
            processImportData().then(success => {
                if (success) {
                    updateDashboard();
                    renderStudents();
                    populateClassDropdowns();
                    closeImportModal();
                }
            });
        }

        // Toggle student list for a class
        function toggleStudentList(classId) {
            const listDiv = document.getElementById(`studentList_${classId}`);
            const contentDiv = document.getElementById(`studentListContent_${classId}`);
            const button = document.getElementById(`viewListBtn_${classId}`);
            
            if (listDiv.classList.contains('hidden')) {
                // Show the list and populate it
                const classStudents = students.filter(s => s.classRef === `classes/${classId}`);
                
                // Sort students: active first, then by name
                classStudents.sort((a, b) => {
                    if (a.status === 'active' && b.status !== 'active') return -1;
                    if (a.status !== 'active' && b.status === 'active') return 1;
                    return (a.fullName || '').localeCompare(b.fullName || '');
                });
                
                if (classStudents.length === 0) {
                    contentDiv.innerHTML = '<p class="text-gray-500 text-sm">No students enrolled in this class</p>';
                } else {
                    contentDiv.innerHTML = classStudents.map(student => `
                        <div class="flex items-center justify-between py-2 px-3 bg-white rounded border">
                            <div class="flex items-center space-x-3">
                                <span class="font-medium text-gray-900">${student.fullName || 'Unknown'}</span>
                                <span class="text-sm text-gray-500">(${student.humanId || 'No ID'})</span>
                            </div>
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(student.status)}">
                                ${student.status ? student.status.charAt(0).toUpperCase() + student.status.slice(1) : 'Unknown'}
                            </span>
                        </div>
                    `).join('');
                }
                
                listDiv.classList.remove('hidden');
                button.textContent = `Hide List (${classStudents.length})`;
            } else {
                // Hide the list
                listDiv.classList.add('hidden');
                const studentCount = students.filter(s => s.classRef === `classes/${classId}`).length;
                button.textContent = `View List (${studentCount})`;
            }
        }

        // Initialize the application when the page loads
        init();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'981dfb4e60da85c7',t:'MTc1ODMzNjI3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
