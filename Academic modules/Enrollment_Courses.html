<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enrollment - School LMS</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8f9fa;
      color: #1a1a1a;
      font-size: 13px;
      line-height: 1.5;
      height: 100%;
      width: 100%;
    }

    html {
      height: 100%;
      width: 100%;
    }

    .page-wrapper {
      width: 100%;
      height: 100%;
      overflow-y: auto;
    }

    .page-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
    }

    /* Buttons */
    .btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    .btn-primary:hover {
      opacity: 0.9;
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: white;
      color: #64748b;
      border-color: #e5e7eb;
    }

    .btn-secondary:hover {
      border-color: #2563eb;
      color: #2563eb;
    }

    .btn-success {
      background: #16a34a;
      color: white;
      border-color: #16a34a;
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn-success:hover {
      opacity: 0.9;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
      border-color: #dc2626;
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn-danger:hover {
      opacity: 0.9;
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
      border-color: #f59e0b;
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn-warning:hover {
      opacity: 0.9;
    }

    .btn-icon {
      padding: 8px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #64748b;
    }

    .btn-icon:hover {
      border-color: #2563eb;
      color: #2563eb;
    }

    /* Cards */
    .card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
      transition: all 0.2s;
    }

    /* Course Summary Card */
    .course-summary {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .course-details {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
    }

    .course-name-large {
      font-size: calc(13px * 1.15);
      font-weight: 700;
      color: #1a1a1a;
    }

    .course-meta {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 11px;
      color: #64748b;
    }

    .course-stats {
      display: flex;
      gap: 12px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      background: #f8f9fa;
      border-radius: 6px;
    }

    .stat-value {
      font-size: calc(13px * 1.3);
      font-weight: 700;
      color: #2563eb;
    }

    .stat-label {
      font-size: 11px;
      color: #64748b;
      font-weight: 500;
    }

    /* Manage Tab */
    .manage-controls {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 12px 14px;
      margin-bottom: 14px;
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 10px;
      align-items: center;
    }

    .search-input {
      flex: 1;
      padding: 7px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 12px;
      background: #f8f9fa;
      transition: all 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: #2563eb;
      background: white;
    }

    .filter-select {
      padding: 7px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 12px;
      background: #f8f9fa;
      cursor: pointer;
      min-width: 140px;
    }

    .manage-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .student-panel {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      padding: 12px 14px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .panel-header:hover {
      background: #f8f9fa;
    }

    .panel-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .panel-title {
      font-size: calc(13px * 1.08);
      font-weight: 600;
      color: #1a1a1a;
    }

    .collapse-icon {
      font-size: 14px;
      color: #64748b;
      transition: transform 0.2s;
    }

    .collapse-icon.collapsed {
      transform: rotate(-90deg);
    }

    .count-badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 7px;
      background: #2563eb;
      color: white;
      border-radius: 10px;
      font-size: 10px;
      font-weight: 600;
    }

    .panel-body {
      flex: 1;
      overflow-y: auto;
      min-height: 350px;
      max-height: 500px;
    }

    .panel-body.collapsed {
      display: none;
    }

    .panel-actions {
      padding: 10px 14px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 6px;
      justify-content: flex-end;
    }

    .panel-actions.collapsed {
      display: none;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    .student-table {
      width: 100%;
      border-collapse: collapse;
    }

    .student-table thead {
      background: #f8f9fa;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .student-table th {
      text-align: left;
      padding: 8px 10px;
      font-size: 10px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border-bottom: 1px solid #e5e7eb;
    }

    .student-table th:first-child {
      width: 35px;
      padding-left: 14px;
    }

    .student-table td {
      padding: 10px;
      font-size: 12px;
      border-bottom: 1px solid #f1f3f5;
    }

    .student-table td:first-child {
      padding-left: 14px;
    }

    .student-table tbody tr {
      transition: all 0.2s;
    }

    .student-table tbody tr:hover {
      background: #f8f9fa;
    }

    .student-table tbody tr.dropped {
      opacity: 0.6;
    }

    .student-table input[type="checkbox"] {
      width: 14px;
      height: 14px;
      cursor: pointer;
      accent-color: #2563eb;
    }

    .student-id {
      font-weight: 500;
      color: #64748b;
      font-size: 11px;
    }

    .student-name-cell {
      font-weight: 500;
      color: #1a1a1a;
      font-size: 12px;
    }

    .contact-info {
      font-size: 11px;
      color: #64748b;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .badge-active {
      background: #dcfce7;
      color: #166534;
    }

    .badge-inactive {
      background: #fee2e2;
      color: #991b1b;
    }

    .badge-finished {
      background: #e0e7ff;
      color: #3730a3;
    }

    .badge-dropped {
      background: #f1f5f9;
      color: #64748b;
    }

    .action-buttons {
      display: flex;
      gap: 6px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 30px 16px;
      color: #64748b;
    }

    .empty-state-icon {
      font-size: calc(13px * 2);
      margin-bottom: 10px;
      opacity: 0.4;
    }

    .empty-state-text {
      font-size: calc(13px * 1);
      font-weight: 500;
      color: #1a1a1a;
      margin-bottom: 3px;
    }

    .empty-state-subtext {
      font-size: 12px;
      color: #64748b;
    }

    /* Loading State */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e5e7eb;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(2px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease-out;
    }

    .modal-overlay.active {
      display: flex;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .modal {
      background: white;
      border-radius: 12px;
      max-width: 600px;
      width: 90%;
      border: 1px solid #e5e7eb;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header {
      padding: 18px 20px;
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-title {
      font-size: calc(13px * 1.23);
      font-weight: 600;
      color: #1a1a1a;
    }

    .modal-body {
      padding: 20px;
      color: #64748b;
      font-size: 13px;
      line-height: 1.6;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* Toast */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 14px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 320px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast-icon {
      font-size: calc(13px * 1.4);
      flex-shrink: 0;
    }

    .toast-message {
      flex: 1;
      font-size: 13px;
      color: #1a1a1a;
      font-weight: 500;
    }

    .toast-success {
      border-left: 3px solid #16a34a;
    }

    .toast-error {
      border-left: 3px solid #dc2626;
    }

    @media (max-width: 968px) {
      .manage-grid {
        grid-template-columns: 1fr;
      }

      .course-summary {
        flex-direction: column;
        align-items: flex-start;
      }

      .course-details {
        flex-direction: column;
        align-items: flex-start;
      }

      .course-stats {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
   <div class="loading-spinner"></div>
  </div>
  <div class="page-wrapper">
   <div class="page-container"><!-- Manage Tab -->
    <div id="manageTab"></div>
   </div>
  </div><!-- Confirmation Modal -->
  <div class="modal-overlay" id="modalOverlay">
   <div class="modal">
    <div class="modal-header">
     <h2 class="modal-title" id="modalTitle">Confirm Action</h2>
    </div>
    <div class="modal-body" id="modalBody">
     Are you sure?
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" id="modalCancel">Cancel</button> <button class="btn btn-primary" id="modalConfirm">Confirm</button>
    </div>
   </div>
  </div><!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>
  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCDzv0HseeLfijzyXZjKWFh9QaLrMB4afo",
      authDomain: "tnl2026.firebaseapp.com",
      projectId: "tnl2026",
      storageBucket: "tnl2026.firebasestorage.app",
      messagingSenderId: "883525152224",
      appId: "1:883525152224:web:619ae152cd8df3fcca8f85",
      measurementId: "G-3K6LXCKHZ9"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global state
    let currentCourseId = null;
    let currentCourseName = null;
    let currentCourse = null;
    let students = []; // Array of {id (docId), publicCode, fullName, classId, status, ...}
    let courseEnrollments = [];
    let classes = [];
    let classMap = new Map();
    let isLoading = true;

    // Manage Tab State
    let globalSearch = '';
    let statusFilter = '';
    let classFilter = '';
    let availableCollapsed = false;
    let enrolledCollapsed = false;
    let selectedAvailable = new Set();
    let selectedEnrolled = new Set();

    // Parse URL parameters
    function getUrlParameter(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Vietnamese diacritic normalization
    function removeDiacritics(str) {
      // Comprehensive Vietnamese diacritic removal
      return str
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '') // Remove combining diacritical marks
        .replace(/Ä‘/g, 'd')
        .replace(/Ä/g, 'D')
        .replace(/Äƒ/g, 'a')
        .replace(/Ä‚/g, 'A')
        .replace(/Ã¢/g, 'a')
        .replace(/Ã‚/g, 'A')
        .replace(/Ãª/g, 'e')
        .replace(/ÃŠ/g, 'E')
        .replace(/Ã´/g, 'o')
        .replace(/Ã”/g, 'O')
        .replace(/Æ¡/g, 'o')
        .replace(/Æ /g, 'O')
        .replace(/Æ°/g, 'u')
        .replace(/Æ¯/g, 'U');
    }

    // Search filter with Vietnamese support
    function matchesSearch(text, searchTerm) {
      if (!searchTerm) return true;
      const normalizedText = removeDiacritics(text.toLowerCase());
      const normalizedSearch = removeDiacritics(searchTerm.toLowerCase());
      return normalizedText.includes(normalizedSearch);
    }

    // Show/Hide Loading
    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'flex';
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    // Load Data from Firestore
    async function loadData() {
      try {
        showLoading();
        
        // Get courseId from URL
        currentCourseId = getUrlParameter('courseId');
        
        if (!currentCourseId) {
          showToast('No course ID provided in URL', 'error');
          hideLoading();
          return;
        }

        // Fetch course document
        const courseDoc = await db.collection('courses').doc(currentCourseId).get();
        if (!courseDoc.exists) {
          showToast('Course not found', 'error');
          hideLoading();
          return;
        }
        
        currentCourse = { id: courseDoc.id, ...courseDoc.data() };
        currentCourseName = currentCourse.name;

        // Fetch all students
        const studentsSnapshot = await db.collection('students').get();
        students = studentsSnapshot.docs.map(doc => ({ 
          id: doc.id,  // Firestore document ID
          publicCode: doc.data().publicCode,  // Human-readable student code
          fullName: doc.data().fullName,
          classId: doc.data().classId,
          status: doc.data().status,
          ...doc.data()
        }));

        // Fetch all classes
        const classesSnapshot = await db.collection('classes').get();
        classes = classesSnapshot.docs.map(doc => ({ 
          id: doc.id, 
          ...doc.data() 
        }));
        
        // Build class map for quick lookup
        classMap = new Map();
        classes.forEach(cls => {
          classMap.set(cls.id, cls.name || cls.id);
        });

        // Fetch course enrollments for this course
        const enrollmentsSnapshot = await db.collection('course_enrollments')
          .where('courseId', '==', currentCourseId)
          .get();
        
        courseEnrollments = enrollmentsSnapshot.docs.map(doc => ({ 
          id: doc.id,
          studentId: doc.data().studentId,
          status: doc.data().status,
          enrolledAt: doc.data().enrolledAt,
          droppedAt: doc.data().droppedAt,
          studentNameCache: doc.data().studentNameCache,
          studentPublicCodeCache: doc.data().studentPublicCodeCache,
          ...doc.data() 
        }));

        isLoading = false;
        hideLoading();
        
        renderManageTab();
        
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('Error loading data: ' + error.message, 'error');
        hideLoading();
      }
    }

    // Get enrolled count for current course
    function getEnrolledCount() {
      return courseEnrollments.filter(e => e.status === 'active').length;
    }

    // Initialize
    function init() {
      setupModal();
      loadData();
    }

    // Render Manage Tab
    function renderManageTab() {
      if (!currentCourse) return;

      const enrolledCount = getEnrolledCount();
      const manageTab = document.getElementById('manageTab');
      
      manageTab.innerHTML = `
        <!-- Course Summary -->
        <div class="course-summary">
          <div class="course-details">
            <div class="course-name-large">${currentCourse.name}</div>
            <div class="course-meta">
              <span>Code: <strong>${currentCourse.publicCode || 'N/A'}</strong></span>
              <span>â€¢</span>
              <span>Status: <strong style="color: #16a34a;">${(currentCourse.status || 'active').toUpperCase()}</strong></span>
            </div>
          </div>
          <div class="course-stats">
            <div class="stat-item">
              <span class="stat-value">${enrolledCount}</span>
              <span class="stat-label">Enrolled</span>
            </div>
          </div>
        </div>

        <!-- Global Controls -->
        <div class="manage-controls">
          <input type="text" class="search-input" id="globalSearch" placeholder="Search by name or ID...">
          <select class="filter-select" id="statusFilter" onchange="updateStudentLists()">
            <option value="">All Statuses</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="finished">Finished</option>
            <option value="dropped">Dropped</option>
          </select>
          <select class="filter-select" id="classFilter" onchange="updateStudentLists()">
            <option value="">All Classes</option>
          </select>
        </div>

        <!-- Student Panels -->
        <div class="manage-grid">
          <!-- Available Students -->
          <div class="student-panel">
            <div class="panel-header" onclick="toggleAvailable()">
              <div class="panel-title-row">
                <span class="collapse-icon" id="availableIcon">â–¼</span>
                <span class="panel-title">Available Students</span>
                <span class="count-badge" id="availableCount">0</span>
              </div>
            </div>
            <div class="panel-body" id="availableBody"></div>
            <div class="panel-actions" id="availableActions">
              <button class="btn btn-primary" onclick="bulkEnrollSelected()" id="enrollSelectedBtn" disabled>
                Enroll Selected (<span id="availableSelectedCount">0</span>)
              </button>
            </div>
          </div>

          <!-- Enrolled Students -->
          <div class="student-panel">
            <div class="panel-header" onclick="toggleEnrolled()">
              <div class="panel-title-row">
                <span class="collapse-icon" id="enrolledIcon">â–¼</span>
                <span class="panel-title">Enrolled Students</span>
                <span class="count-badge" id="enrolledCount">0</span>
              </div>
            </div>
            <div class="panel-body" id="enrolledBody"></div>
            <div class="panel-actions" id="enrolledActions">
              <button class="btn btn-danger" onclick="bulkDropSelected()" id="dropSelectedBtn" disabled>
                Drop Selected (<span id="enrolledSelectedCount">0</span>)
              </button>
            </div>
          </div>
        </div>
      `;

      // Populate class filter dynamically
      const uniqueClassIds = [...new Set(students.map(s => s.classId || s.class))].filter(Boolean).sort();
      const classFilter = document.getElementById('classFilter');
      uniqueClassIds.forEach(classId => {
        const option = document.createElement('option');
        option.value = classId;
        option.textContent = classMap.get(classId) || classId;
        classFilter.appendChild(option);
      });

      // Setup event listeners
      document.getElementById('globalSearch').addEventListener('input', (e) => {
        globalSearch = e.target.value;
        updateStudentLists();
      });

      // Restore search value after render
      document.getElementById('globalSearch').value = globalSearch;
      document.getElementById('statusFilter').value = statusFilter;
      document.getElementById('classFilter').value = classFilter;

      updateStudentLists();
    }

    function toggleAvailable() {
      availableCollapsed = !availableCollapsed;
      const icon = document.getElementById('availableIcon');
      const body = document.getElementById('availableBody');
      const actions = document.getElementById('availableActions');
      
      icon.classList.toggle('collapsed', availableCollapsed);
      body.classList.toggle('collapsed', availableCollapsed);
      actions.classList.toggle('collapsed', availableCollapsed);
    }

    function toggleEnrolled() {
      enrolledCollapsed = !enrolledCollapsed;
      const icon = document.getElementById('enrolledIcon');
      const body = document.getElementById('enrolledBody');
      const actions = document.getElementById('enrolledActions');
      
      icon.classList.toggle('collapsed', enrolledCollapsed);
      body.classList.toggle('collapsed', enrolledCollapsed);
      actions.classList.toggle('collapsed', enrolledCollapsed);
    }

    // Update student lists
    function updateStudentLists() {
      const statusFilterValue = document.getElementById('statusFilter').value;
      const classFilterValue = document.getElementById('classFilter').value;

      // Get enrolled student IDs
      const enrolledStudentIds = courseEnrollments.map(e => e.studentId);

      // Filter available students (not enrolled)
      let availableStudents = students.filter(s => {
        return !enrolledStudentIds.includes(s.id);
      });
      
      // Apply global search and filters
      availableStudents = availableStudents.filter(s => {
        const nameToSearch = s.fullName || '';
        const idToSearch = s.publicCode || '';
        const classToCheck = s.classId;
        
        // Search filter
        if (globalSearch && !matchesSearch(nameToSearch, globalSearch) && !matchesSearch(idToSearch, globalSearch)) {
          return false;
        }
        // Status filter
        if (statusFilterValue && s.status !== statusFilterValue) {
          return false;
        }
        // Class filter
        if (classFilterValue && classToCheck !== classFilterValue) {
          return false;
        }
        return true;
      });

      // Filter enrolled students
      let enrolledStudents = students.filter(s => {
        return enrolledStudentIds.includes(s.id);
      });
      
      // Apply global search and filters
      enrolledStudents = enrolledStudents.filter(s => {
        const enrollment = courseEnrollments.find(e => e.studentId === s.id);
        const nameToSearch = s.fullName || '';
        const idToSearch = s.publicCode || '';
        const classToCheck = s.classId;
        
        // Search filter
        if (globalSearch && !matchesSearch(nameToSearch, globalSearch) && !matchesSearch(idToSearch, globalSearch)) {
          return false;
        }
        // Status filter - check enrollment status for dropped, otherwise student status
        const statusToCheck = enrollment && enrollment.status === 'dropped' ? 'dropped' : s.status;
        if (statusFilterValue && statusToCheck !== statusFilterValue) {
          return false;
        }
        // Class filter
        if (classFilterValue && classToCheck !== classFilterValue) {
          return false;
        }
        return true;
      });

      // Separate active and dropped, sort so dropped appear at bottom
      const activeEnrolled = enrolledStudents.filter(s => {
        const enrollment = courseEnrollments.find(e => e.studentId === s.id);
        return enrollment && enrollment.status === 'active';
      });

      const droppedEnrolled = enrolledStudents.filter(s => {
        const enrollment = courseEnrollments.find(e => e.studentId === s.id);
        return enrollment && enrollment.status === 'dropped';
      });

      const sortedEnrolled = [...activeEnrolled, ...droppedEnrolled];

      // Render lists
      renderAvailableList(availableStudents);
      renderEnrolledList(sortedEnrolled);

      // Update counts
      document.getElementById('availableCount').textContent = availableStudents.length;
      document.getElementById('enrolledCount').textContent = enrolledStudents.length;
    }

    // Render available students list
    function renderAvailableList(studentList) {
      const body = document.getElementById('availableBody');
      
      if (studentList.length === 0) {
        body.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">âœ“</div>
            <div class="empty-state-text">No available students</div>
            <div class="empty-state-subtext">All students are enrolled in this course</div>
          </div>
        `;
        return;
      }

      body.innerHTML = `
        <table class="student-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllAvailable" onchange="toggleSelectAllAvailable()"></th>
              <th>Student ID</th>
              <th>Full Name</th>
              <th>Class</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${studentList.map(student => {
              const classDisplayName = classMap.get(student.classId) || student.classId || 'N/A';
              return `
              <tr>
                <td><input type="checkbox" class="available-checkbox" value="${student.id}" onchange="updateAvailableSelection()"></td>
                <td><span class="student-id">${student.publicCode}</span></td>
                <td class="student-name-cell">${student.fullName || 'N/A'}</td>
                <td>${classDisplayName}</td>
                <td><span class="badge badge-${student.status || 'active'}">${(student.status || 'active').toUpperCase()}</span></td>
                <td>
                  <button class="btn btn-success" onclick="enrollStudent('${student.id}')">
                    Enroll
                  </button>
                </td>
              </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    // Cache for student records check
    let studentRecordsCache = new Map();

    // Check if student has attendance or assessment records (with caching)
    async function checkStudentHasRecords(studentId) {
      // Check cache first
      if (studentRecordsCache.has(studentId)) {
        return studentRecordsCache.get(studentId);
      }

      try {
        // Check attendance records
        const attendanceSnapshot = await db.collection('attendance')
          .where('courseId', '==', currentCourseId)
          .where('studentId', '==', studentId)
          .limit(1)
          .get();
        
        if (!attendanceSnapshot.empty) {
          studentRecordsCache.set(studentId, true);
          return true;
        }

        // Check assessment records
        const assessmentSnapshot = await db.collection('assessments')
          .where('courseId', '==', currentCourseId)
          .where('studentId', '==', studentId)
          .limit(1)
          .get();
        
        if (!assessmentSnapshot.empty) {
          studentRecordsCache.set(studentId, true);
          return true;
        }

        studentRecordsCache.set(studentId, false);
        return false;
      } catch (error) {
        console.error('Error checking student records:', error);
        return true; // Assume has records to be safe
      }
    }

    // Batch check all students for records (more efficient)
    async function batchCheckStudentRecords(studentIds) {
      const results = new Map();
      
      try {
        // Batch query for attendance
        const attendanceSnapshot = await db.collection('attendance')
          .where('courseId', '==', currentCourseId)
          .where('studentId', 'in', studentIds.slice(0, 10)) // Firestore 'in' limit is 10
          .get();
        
        attendanceSnapshot.forEach(doc => {
          results.set(doc.data().studentId, true);
        });

        // Batch query for assessments
        const assessmentSnapshot = await db.collection('assessments')
          .where('courseId', '==', currentCourseId)
          .where('studentId', 'in', studentIds.slice(0, 10))
          .get();
        
        assessmentSnapshot.forEach(doc => {
          results.set(doc.data().studentId, true);
        });

        // Set all unchecked students as having no records
        studentIds.forEach(id => {
          if (!results.has(id)) {
            results.set(id, false);
          }
        });

        // Update cache
        results.forEach((hasRecords, studentId) => {
          studentRecordsCache.set(studentId, hasRecords);
        });

        return results;
      } catch (error) {
        console.error('Error batch checking student records:', error);
        // Return safe defaults
        studentIds.forEach(id => {
          results.set(id, true);
        });
        return results;
      }
    }

    // Render enrolled students list
    async function renderEnrolledList(studentList) {
      const body = document.getElementById('enrolledBody');
      
      if (studentList.length === 0) {
        body.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ðŸ“š</div>
            <div class="empty-state-text">No enrolled students</div>
            <div class="empty-state-subtext">Start enrolling students to this course</div>
          </div>
        `;
        return;
      }

      // First render the table immediately with basic buttons
      body.innerHTML = `
        <table class="student-table">
          <thead>
            <tr>
              <th><input type="checkbox" id="selectAllEnrolled" onchange="toggleSelectAllEnrolled()"></th>
              <th>Student ID</th>
              <th>Full Name</th>
              <th>Class</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="enrolledTableBody">
            ${studentList.map(student => {
              const enrollment = courseEnrollments.find(e => e.studentId === student.id);
              const isDropped = enrollment && enrollment.status === 'dropped';
              const rowClass = isDropped ? 'dropped' : '';
              const classDisplayName = classMap.get(student.classId) || student.classId || 'N/A';
              
              // Show basic action buttons immediately
              let actionButtons = '';
              if (isDropped) {
                actionButtons = `<button class="btn btn-warning" onclick="reenrollStudent('${student.id}')">Re-enroll</button>`;
              } else {
                actionButtons = `<button class="btn btn-danger" onclick="dropStudent('${student.id}')">Drop</button>`;
              }

              return `
                <tr class="${rowClass}" data-student-id="${student.id}">
                  <td><input type="checkbox" class="enrolled-checkbox" value="${student.id}" ${isDropped ? 'disabled' : ''} onchange="updateEnrolledSelection()"></td>
                  <td><span class="student-id">${student.publicCode}</span></td>
                  <td class="student-name-cell">${student.fullName || 'N/A'}</td>
                  <td>${classDisplayName}</td>
                  <td><span class="badge badge-${isDropped ? 'dropped' : (student.status || 'active')}">${isDropped ? 'DROPPED' : (student.status || 'active').toUpperCase()}</span></td>
                  <td>
                    <div class="action-buttons">
                      ${actionButtons}
                    </div>
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      `;

      // Then check records in background and update buttons asynchronously
      // Process in batches of 10 to respect Firestore 'in' query limit
      const studentIds = studentList.map(s => s.id);
      const batches = [];
      for (let i = 0; i < studentIds.length; i += 10) {
        batches.push(studentIds.slice(i, i + 10));
      }
      
      // Check all batches in parallel
      const batchPromises = batches.map(batch => batchCheckStudentRecords(batch));
      const batchResults = await Promise.all(batchPromises);
      
      // Combine all results
      const recordsMap = new Map();
      batchResults.forEach(result => {
        result.forEach((hasRecords, studentId) => {
          recordsMap.set(studentId, hasRecords);
        });
      });
      
      // Update buttons only for DROPPED students WITHOUT records (to add Remove button)
      studentList.forEach(student => {
        const hasRecords = recordsMap.get(student.id);
        const enrollment = courseEnrollments.find(e => e.studentId === student.id);
        const isDropped = enrollment && enrollment.status === 'dropped';
        
        // Only update if student is DROPPED and has NO records
        if (isDropped && !hasRecords) {
          const row = document.querySelector(`tr[data-student-id="${student.id}"]`);
          if (row) {
            const actionsCell = row.querySelector('.action-buttons');
            
            // Dropped students WITHOUT records: show Re-enroll + Remove
            actionsCell.innerHTML = `
              <button class="btn btn-warning" onclick="reenrollStudent('${student.id}')">Re-enroll</button>
              <button class="btn btn-danger" onclick="removeStudent('${student.id}')">Remove</button>
            `;
          }
        }
        // Active students always show only Drop button
        // Dropped students WITH records show only Re-enroll button
      });
    }

    // Checkbox management
    function toggleSelectAllAvailable() {
      const checked = document.getElementById('selectAllAvailable').checked;
      document.querySelectorAll('.available-checkbox').forEach(cb => {
        cb.checked = checked;
      });
      updateAvailableSelection();
    }

    function toggleSelectAllEnrolled() {
      const checked = document.getElementById('selectAllEnrolled').checked;
      document.querySelectorAll('.enrolled-checkbox:not(:disabled)').forEach(cb => {
        cb.checked = checked;
      });
      updateEnrolledSelection();
    }

    function updateAvailableSelection() {
      const checkboxes = document.querySelectorAll('.available-checkbox:checked');
      selectedAvailable = new Set(Array.from(checkboxes).map(cb => cb.value));
      document.getElementById('enrollSelectedBtn').disabled = selectedAvailable.size === 0;
      document.getElementById('availableSelectedCount').textContent = selectedAvailable.size;
    }

    function updateEnrolledSelection() {
      const checkboxes = document.querySelectorAll('.enrolled-checkbox:checked');
      selectedEnrolled = new Set(Array.from(checkboxes).map(cb => cb.value));
      document.getElementById('dropSelectedBtn').disabled = selectedEnrolled.size === 0;
      document.getElementById('enrolledSelectedCount').textContent = selectedEnrolled.size;
    }

    // Enroll student
    async function enrollStudent(studentId) {
      const student = students.find(s => s.id === studentId);
      if (!student) return;

      const studentName = student.fullName || 'Unknown';
      const studentCode = student.publicCode || 'N/A';

      showModal(
        'Confirm Enrollment',
        `Enroll ${studentName} (${studentCode}) in ${currentCourse.name}?`,
        async () => {
          try {
            showLoading();
            
            const enrollmentId = `ENR_${currentCourseId}_${studentId}`;
            const now = firebase.firestore.Timestamp.now();
            
            // Check if enrollment already exists
            const enrollmentDoc = await db.collection('course_enrollments').doc(enrollmentId).get();
            
            if (enrollmentDoc.exists) {
              // Re-activate existing enrollment
              await db.collection('course_enrollments').doc(enrollmentId).update({
                status: 'active',
                updatedAt: now
              });
              
              // Update local state
              const enrollment = courseEnrollments.find(e => e.id === enrollmentId);
              if (enrollment) {
                enrollment.status = 'active';
                enrollment.updatedAt = now;
              }
            } else {
              // Create new enrollment
              const newEnrollment = {
                courseId: currentCourseId,
                studentId: studentId,
                status: 'active',
                enrolledAt: now,
                droppedAt: null,
                studentNameCache: student.fullName,
                studentPublicCodeCache: student.publicCode,
                createdAt: now,
                updatedAt: now
              };
              
              await db.collection('course_enrollments').doc(enrollmentId).set(newEnrollment);
              
              // Update local state
              courseEnrollments.push({
                id: enrollmentId,
                ...newEnrollment
              });
            }

            hideLoading();
            renderManageTab();
            showToast(`${studentName} enrolled successfully`, 'success');
            selectedAvailable.clear();
            
          } catch (error) {
            console.error('Error enrolling student:', error);
            showToast('Error enrolling student: ' + error.message, 'error');
            hideLoading();
          }
        }
      );
    }

    // Drop student
    async function dropStudent(studentId) {
      const student = students.find(s => s.id === studentId);
      if (!student) return;

      const studentName = student.fullName || 'Unknown';
      const studentCode = student.publicCode || 'N/A';

      showModal(
        'Confirm Drop',
        `Drop ${studentName} (${studentCode}) from ${currentCourse.name}? The student will be marked as dropped but enrollment record will be kept.`,
        async () => {
          try {
            showLoading();
            
            const enrollmentId = `ENR_${currentCourseId}_${studentId}`;
            const now = firebase.firestore.Timestamp.now();
            
            await db.collection('course_enrollments').doc(enrollmentId).update({
              status: 'dropped',
              droppedAt: now,
              updatedAt: now
            });

            // Update local state
            const enrollment = courseEnrollments.find(e => e.id === enrollmentId);
            if (enrollment) {
              enrollment.status = 'dropped';
              enrollment.droppedAt = now;
              enrollment.updatedAt = now;
            }

            hideLoading();
            renderManageTab();
            showToast(`${studentName} dropped successfully`, 'success');
            selectedEnrolled.clear();
            
          } catch (error) {
            console.error('Error dropping student:', error);
            showToast('Error dropping student: ' + error.message, 'error');
            hideLoading();
          }
        }
      );
    }

    // Re-enroll student
    async function reenrollStudent(studentId) {
      const student = students.find(s => s.id === studentId);
      if (!student) return;

      const studentName = student.fullName || 'Unknown';
      const studentCode = student.publicCode || 'N/A';

      showModal(
        'Confirm Re-enrollment',
        `Re-enroll ${studentName} (${studentCode}) in ${currentCourse.name}?`,
        async () => {
          try {
            showLoading();
            
            const enrollmentId = `ENR_${currentCourseId}_${studentId}`;
            const now = firebase.firestore.Timestamp.now();
            
            await db.collection('course_enrollments').doc(enrollmentId).update({
              status: 'active',
              updatedAt: now
            });

            // Update local state
            const enrollment = courseEnrollments.find(e => e.id === enrollmentId);
            if (enrollment) {
              enrollment.status = 'active';
              enrollment.updatedAt = now;
            }

            hideLoading();
            renderManageTab();
            showToast(`${studentName} re-enrolled successfully`, 'success');
            
          } catch (error) {
            console.error('Error re-enrolling student:', error);
            showToast('Error re-enrolling student: ' + error.message, 'error');
            hideLoading();
          }
        }
      );
    }

    // Remove student (delete enrollment record)
    async function removeStudent(studentId) {
      const student = students.find(s => s.id === studentId);
      if (!student) return;

      const studentName = student.fullName || 'Unknown';
      const studentCode = student.publicCode || 'N/A';

      // Double-check they have no records
      const hasRecords = await checkStudentHasRecords(studentId);
      if (hasRecords) {
        showToast('Cannot remove student with attendance or assessment records. Please drop instead.', 'error');
        return;
      }

      showModal(
        'Confirm Removal',
        `Permanently remove ${studentName} (${studentCode}) from ${currentCourse.name}? This will delete the enrollment record entirely. This action cannot be undone.`,
        async () => {
          try {
            showLoading();
            
            const enrollmentId = `ENR_${currentCourseId}_${studentId}`;
            
            // Delete the enrollment document
            await db.collection('course_enrollments').doc(enrollmentId).delete();

            // Update local state
            const index = courseEnrollments.findIndex(e => e.id === enrollmentId);
            if (index !== -1) {
              courseEnrollments.splice(index, 1);
            }

            // Clear cache for this student
            studentRecordsCache.delete(studentId);

            hideLoading();
            renderManageTab();
            showToast(`${studentName} removed successfully`, 'success');
            selectedEnrolled.clear();
            
          } catch (error) {
            console.error('Error removing student:', error);
            showToast('Error removing student: ' + error.message, 'error');
            hideLoading();
          }
        }
      );
    }

    // Bulk enroll
    async function bulkEnrollSelected() {
      const count = selectedAvailable.size;
      if (count === 0) return;

      showModal(
        'Confirm Bulk Enrollment',
        `Enroll ${count} student(s) in ${currentCourse.name}?`,
        async () => {
          try {
            showLoading();
            
            const batch = db.batch();
            const now = firebase.firestore.Timestamp.now();
            const newEnrollments = [];
            
            for (const studentId of selectedAvailable) {
              const student = students.find(s => s.id === studentId);
              if (!student) continue;
              
              const enrollmentId = `ENR_${currentCourseId}_${studentId}`;
              const enrollmentRef = db.collection('course_enrollments').doc(enrollmentId);
              
              // Check if enrollment already exists
              const existingEnrollment = courseEnrollments.find(e => e.id === enrollmentId);
              
              if (existingEnrollment) {
                // Re-activate
                batch.update(enrollmentRef, {
                  status: 'active',
                  updatedAt: now
                });
                existingEnrollment.status = 'active';
                existingEnrollment.updatedAt = now;
              } else {
                // New enrollment
                const newEnrollment = {
                  courseId: currentCourseId,
                  studentId: studentId,
                  status: 'active',
                  enrolledAt: now,
                  droppedAt: null,
                  studentNameCache: student.fullName,
                  studentPublicCodeCache: student.publicCode,
                  createdAt: now,
                  updatedAt: now
                };
                
                batch.set(enrollmentRef, newEnrollment);
                newEnrollments.push({
                  id: enrollmentId,
                  ...newEnrollment
                });
              }
            }

            await batch.commit();
            
            // Update local state
            courseEnrollments.push(...newEnrollments);
            
            hideLoading();
            renderManageTab();
            showToast(`${count} student(s) enrolled successfully`, 'success');
            selectedAvailable.clear();
            
          } catch (error) {
            console.error('Error bulk enrolling:', error);
            showToast('Error bulk enrolling: ' + error.message, 'error');
            hideLoading();
          }
        }
      );
    }

    // Bulk drop
    async function bulkDropSelected() {
      const count = selectedEnrolled.size;
      if (count === 0) return;

      showModal(
        'Confirm Bulk Drop',
        `Drop ${count} student(s) from ${currentCourse.name}? They will be marked as dropped.`,
        async () => {
          try {
            showLoading();
            
            const batch = db.batch();
            const now = firebase.firestore.Timestamp.now();
            
            selectedEnrolled.forEach(studentId => {
              const enrollmentId = `ENR_${currentCourseId}_${studentId}`;
              const enrollmentRef = db.collection('course_enrollments').doc(enrollmentId);
              
              batch.update(enrollmentRef, {
                status: 'dropped',
                droppedAt: now,
                updatedAt: now
              });
              
              // Update local state
              const enrollment = courseEnrollments.find(e => e.id === enrollmentId);
              if (enrollment) {
                enrollment.status = 'dropped';
                enrollment.droppedAt = now;
                enrollment.updatedAt = now;
              }
            });

            await batch.commit();
            hideLoading();
            renderManageTab();
            showToast(`${count} student(s) dropped successfully`, 'success');
            selectedEnrolled.clear();
            
          } catch (error) {
            console.error('Error bulk dropping:', error);
            showToast('Error bulk dropping: ' + error.message, 'error');
            hideLoading();
          }
        }
      );
    }

    // Modal
    let modalCallback = null;

    function setupModal() {
      document.getElementById('modalCancel').addEventListener('click', () => {
        hideModal();
      });

      document.getElementById('modalConfirm').addEventListener('click', () => {
        if (modalCallback) modalCallback();
        hideModal();
      });

      document.getElementById('modalOverlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          hideModal();
        }
      });
    }

    function showModal(title, message, callback) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').textContent = message;
      modalCallback = callback;
      document.getElementById('modalOverlay').classList.add('active');
    }

    function hideModal() {
      document.getElementById('modalOverlay').classList.remove('active');
      modalCallback = null;
    }

    // Toast
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.innerHTML = `
        <div class="toast-icon">${type === 'success' ? 'âœ“' : 'âœ•'}</div>
        <div class="toast-message">${message}</div>
      `;

      document.getElementById('toastContainer').appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    // Initialize on load
    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b70b44632aa1fc2',t:'MTc2NzI1Njc0Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>