<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Course Assessment Management</title>
  <script src="/_sdk/element_sdk.js"></script><!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Inter, system-ui, -apple-system, sans-serif;
      font-size: 11px;
      color: #1a1a1a;
      background-color: #f8f9fa;
    }
    
    #app-container {
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: #f8f9fa;
    }
    
    .main-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 16px;
    }
    
    /* Cards */
    .card {
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .card-title {
      font-size: calc(11px * 1.18);
      font-weight: 600;
      margin: 0 0 12px 0;
      color: #1a1a1a;
    }
    
    /* Form Layout */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 12px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      font-size: calc(11px * 0.91);
      font-weight: 500;
      color: #1a1a1a;
      margin-bottom: 4px;
    }
    
    .form-group input,
    .form-group select {
      height: 32px;
      padding: 0 10px;
      background: #f8f9fa;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 11px;
      color: #1a1a1a;
      transition: border-color 0.2s, background-color 0.2s;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #2563eb;
      background: #ffffff;
    }
    
    .form-group input::placeholder {
      color: #9ca3af;
    }
    
    /* Buttons */
    .btn-primary {
      height: 32px;
      padding: 0 14px;
      background: #2563eb;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s;
      white-space: nowrap;
    }
    
    .btn-primary:hover {
      opacity: 0.9;
    }
    
    .btn-secondary {
      height: 32px;
      padding: 0 14px;
      background: #ffffff;
      color: #64748b;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
      white-space: nowrap;
    }
    
    .btn-secondary:hover {
      border-color: #2563eb;
      color: #2563eb;
    }
    
    .btn-small {
      height: 26px;
      padding: 0 8px;
      font-size: calc(11px * 0.91);
    }
    
    /* Table */
    .table-container {
      overflow-x: auto;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      background: #ffffff;
      max-height: calc(100% - 200px);
      position: relative;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background: #f8f9fa;
      position: sticky;
      top: 0;
      z-index: 20;
    }
    
    thead th {
      padding: 6px 8px;
      text-align: left;
      font-size: calc(11px * 0.91);
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border-bottom: 1px solid #e5e7eb;
      white-space: nowrap;
      vertical-align: middle;
      background: #f8f9fa;
    }
    
    tbody td {
      padding: 6px 8px;
      font-size: 11px;
      color: #1a1a1a;
      border-bottom: 1px solid #e5e7eb;
    }
    
    tbody tr {
      transition: background-color 0.2s;
    }
    
    tbody tr:hover {
      background: #f8f9fa;
    }
    
    .sticky-col {
      position: sticky;
      background: #ffffff;
      z-index: 15;
    }
    
    .sticky-col-1 {
      left: 0;
      width: 70px;
      min-width: 70px;
      max-width: 70px;
      box-shadow: 2px 0 4px rgba(0,0,0,0.03);
    }
    
    .sticky-col-2 {
      left: 70px;
      width: 140px;
      min-width: 140px;
      max-width: 140px;
      box-shadow: 2px 0 4px rgba(0,0,0,0.03);
    }
    
    .sticky-col-3 {
      left: 210px;
      width: 90px;
      min-width: 90px;
      max-width: 90px;
      box-shadow: 2px 0 4px rgba(0,0,0,0.03);
    }
    
    thead .sticky-col {
      background: #f8f9fa;
      z-index: 25;
    }
    
    tbody tr:hover .sticky-col {
      background: #f8f9fa;
    }
    
    /* Assessment Column Header */
    .assessment-header {
      min-width: 120px;
      padding: 6px 8px;
      text-align: center;
    }
    
    .assessment-header-content {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
    }
    
    .assessment-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: calc(11px * 1.09);
      font-weight: 600;
      color: #1a1a1a;
    }
    
    .assessment-actions {
      display: flex;
      gap: 6px;
    }
    
    .icon-btn {
      cursor: pointer;
      transition: opacity 0.2s;
      width: 14px;
      height: 14px;
    }
    
    .icon-btn:hover {
      opacity: 0.7;
    }
    
    .assessment-meta {
      font-size: calc(11px * 0.91);
      color: #64748b;
      font-weight: 400;
    }
    
    .assessment-stats {
      font-size: calc(11px * 0.91);
      font-weight: 500;
      color: #2563eb;
    }
    
    /* Grade Cells */
    .grade-cell {
      text-align: center;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s;
      position: relative;
    }
    
    .grade-cell:hover {
      opacity: 0.8;
    }
    
    .grade-with-comment {
      position: relative;
    }
    
    .comment-indicator {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: help;
    }
    
    .comment-indicator svg {
      width: 14px;
      height: 14px;
    }
    
    .comment-tooltip {
      position: absolute;
      top: -8px;
      right: 20px;
      background: #1a1a1a;
      color: #ffffff;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: calc(11px * 0.91);
      font-weight: 400;
      white-space: normal;
      max-width: 250px;
      z-index: 100;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    
    .comment-indicator:hover .comment-tooltip {
      opacity: 1;
    }
    
    .grade-high {
      background: #d1fae5;
      color: #065f46;
    }
    
    .grade-medium {
      background: #fef3c7;
      color: #92400e;
    }
    
    .grade-low {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .grade-empty {
      background: #f8f9fa;
      color: #9ca3af;
    }
    
    .status-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: calc(11px * 0.91);
      font-weight: 500;
    }
    
    .status-active {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    
    .status-inactive,
    .status-finished {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fcd34d;
    }
    
    .status-dropped {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    
    .dropped-row {
      background: #f3f4f6;
      opacity: 0.6;
    }
    
    /* Modal */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.2s;
    }
    
    .modal-backdrop.active {
      display: flex;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from { 
        opacity: 0;
        transform: translateY(20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal {
      background: #ffffff;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 85%;
      display: flex;
      flex-direction: column;
      animation: slideUp 0.3s;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
    }
    
    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      background: #ffffff;
      border-radius: 12px 12px 0 0;
    }
    
    .modal-header h3 {
      font-size: calc(11px * 1.36);
      font-weight: 600;
      margin: 0;
      color: #1a1a1a;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 22px;
      color: #64748b;
      cursor: pointer;
      line-height: 1;
      padding: 0;
      width: 22px;
      height: 22px;
      transition: color 0.2s;
    }
    
    .modal-close:hover {
      color: #1a1a1a;
    }
    
    .modal-body {
      padding: 20px;
      overflow-y: auto;
    }
    
    .modal-info {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #e5e7eb;
      margin-bottom: 16px;
    }
    
    .modal-info-item {
      font-size: 11px;
    }
    
    .modal-info-item strong {
      font-weight: 600;
      color: #64748b;
      display: block;
      margin-bottom: 4px;
    }
    
    .modal-info-item input {
      width: 100%;
      height: 32px;
      padding: 0 10px;
      background: #f8f9fa;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 11px;
      color: #1a1a1a;
    }
    
    .modal-info-item input:focus {
      outline: none;
      border-color: #2563eb;
      background: #ffffff;
    }
    
    .grade-inputs {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .grade-input-row {
      display: grid;
      grid-template-columns: 180px 140px 1fr;
      gap: 10px;
      align-items: start;
    }
    
    .score-input-wrapper {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .score-input-wrapper input {
      width: 80px;
      height: 32px;
      padding: 0 10px;
      background: #f8f9fa;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 11px;
      color: #1a1a1a;
      text-align: center;
    }
    
    /* Remove number input spinners */
    .score-input-wrapper input::-webkit-outer-spin-button,
    .score-input-wrapper input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    .score-input-wrapper input[type=number] {
      -moz-appearance: textfield;
    }
    
    .score-input-wrapper input:focus {
      outline: none;
      border-color: #2563eb;
      background: #ffffff;
    }
    
    .max-score-display {
      font-size: 11px;
      color: #64748b;
      font-weight: 500;
    }
    
    .grade-input-label {
      font-size: 11px;
      font-weight: 500;
      color: #1a1a1a;
      padding-top: 8px;
    }
    
    .grade-input-row textarea {
      min-height: 32px;
      padding: 8px 10px;
      background: #f8f9fa;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 11px;
      color: #1a1a1a;
      font-family: Inter, system-ui, -apple-system, sans-serif;
      resize: vertical;
    }
    
    .grade-input-row textarea:focus {
      outline: none;
      border-color: #2563eb;
      background: #ffffff;
    }
    
    .modal-footer {
      padding: 12px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      position: sticky;
      bottom: 0;
      background: #ffffff;
      border-radius: 0 0 12px 12px;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 10px 16px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      z-index: 2000;
      animation: slideIn 0.3s;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .notification-success {
      background: #d1fae5;
      color: #065f46;
      border: 1px solid #6ee7b7;
    }
    
    .notification-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      animation: fadeIn 0.2s;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .loading-spinner {
      background: #ffffff;
      border-radius: 12px;
      padding: 24px 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2);
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e5e7eb;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-text {
      font-size: calc(11px * 1.09);
      font-weight: 500;
      color: #1a1a1a;
    }
    
    .delete-confirm {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 6px;
    }
    
    .delete-confirm-text {
      font-size: calc(11px * 0.91);
      color: #991b1b;
      font-weight: 500;
    }
    
    .delete-confirm-actions {
      display: flex;
      gap: 6px;
    }
    
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .modal {
        width: 95%;
        max-height: 90%;
      }
      
      .grade-input-row {
        grid-template-columns: 1fr;
        gap: 6px;
      }
      
      .modal-info {
        grid-template-columns: 1fr;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app-container" class="h-full w-full">
   <div class="main-content"><!-- Course Header -->
    <div class="card" style="margin-bottom: 20px;">
     <h1 id="course-header" style="font-size: calc(11px * 1.82); font-weight: 700; margin: 0; color: #1a1a1a;">Loading course...</h1>
    </div><!-- Add Assessment Card -->
    <div class="card">
     <h2 class="card-title">Add Assessment</h2>
     <form id="add-assessment-form">
      <div class="form-grid">
       <div class="form-group"><label for="assessment-date">Date</label> <input type="date" id="assessment-date">
       </div>
       <div class="form-group"><label for="assessment-name">Name</label> <input type="text" id="assessment-name" placeholder="Quiz 1">
       </div>
       <div class="form-group"><label for="assessment-teacher">Teacher</label> <select id="assessment-teacher"> <option value="">Select teacher...</option> </select>
       </div>
       <div class="form-group"><label for="assessment-max-score">Max Score <span style="color: #9ca3af; font-weight: 400;">(Optional)</span></label> <input type="number" id="assessment-max-score" placeholder="e.g., 100">
       </div>
       <div class="form-group"><label>&nbsp;</label> <button type="submit" id="add-button" class="btn-primary">Add Assessment</button>
       </div>
      </div>
     </form>
     <div class="form-group" style="max-width: 200px;"><label for="student-sort">Sort Students By</label> <select id="student-sort"> <option value="id">Student ID</option> <option value="name">Student Name</option> </select>
     </div>
    </div><!-- Assessment Performance Matrix -->
    <div class="card" style="padding: 0;">
     <div class="table-container">
      <table id="performance-table">
       <thead>
        <tr>
         <th class="sticky-col sticky-col-1">ID</th>
         <th class="sticky-col sticky-col-2">Name</th>
         <th class="sticky-col sticky-col-3">Status</th><!-- Assessment columns will be added here -->
        </tr>
       </thead>
       <tbody id="table-body"><!-- Student rows will be added here -->
       </tbody>
      </table>
     </div>
    </div>
   </div>
  </div><!-- Grade Entry Modal -->
  <div id="grade-modal" class="modal-backdrop">
   <div class="modal">
    <div class="modal-header">
     <h3 id="modal-title">Enter Grades</h3><button id="modal-close" class="modal-close">×</button>
    </div>
    <div class="modal-body">
     <div id="modal-info" class="modal-info"><!-- Assessment info will be displayed here -->
     </div>
     <div id="grade-inputs" class="grade-inputs"><!-- Grade inputs will be added here -->
     </div>
    </div>
    <div class="modal-footer"><button id="modal-cancel" class="btn-secondary">Cancel</button> <button id="modal-save" class="btn-primary">Save Grades</button>
    </div>
   </div>
  </div><!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
   <div class="loading-spinner">
    <div class="spinner"></div>
    <div class="loading-text" id="loading-text">
     Loading...
    </div>
   </div>
  </div>
  <script>
    // ============================================================================
    // FIREBASE CONFIGURATION
    // ============================================================================
    const firebaseConfig = {
      apiKey: "AIzaSyCDzv0HseeLfijzyXZjKWFh9QaLrMB4afo",
      authDomain: "tnl2026.firebaseapp.com",
      projectId: "tnl2026",
      storageBucket: "tnl2026.firebasestorage.app",
      messagingSenderId: "883525152224",
      appId: "1:883525152224:web:619ae152cd8df3fcca8f85",
      measurementId: "G-3K6LXCKHZ9"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ============================================================================
    // FIRESTORE COLLECTIONS SCHEMA & DOCUMENT ID RULES
    // ============================================================================
    
    /**
     * Collection: courses (DEPENDENCY - already exists in system)
     * Document ID: {courseId} (e.g., "CRS_2025_DEMO-CO-001")
     * Fields:
     *   - publicCode: string (e.g., "DEMO-CO-001")
     *   - name: string (e.g., "Computer Science 101")
     *   - status: string ("active" | "archived")
     *   - assessmentCount: number
     *   - createdAt: timestamp
     *   - updatedAt: timestamp
     */
    
    /**
     * Collection: staff (DEPENDENCY - already exists in system)
     * Document ID: {staffId} (e.g., "Tchr001")
     * Fields:
     *   - fullName: string (e.g., "Dr. Jane Smith")
     *   - preferredName: string (e.g., "Dr. Smith" - shorter display name)
     *   - roles: array<string> (e.g., ["Teacher", "Department Head"])
     *   - status: string ("active" | "inactive")
     *   - createdAt: timestamp
     *   - updatedAt: timestamp
     */
    
    /**
     * Collection: students (DEPENDENCY - already exists in system)
     * Document ID: {studentId} (internal ID)
     * Fields:
     *   - publicCode: string (display ID, e.g., "Stu001")
     *   - fullName: string (e.g., "Alice Johnson")
     *   - status: string ("active" | "inactive")
     *   - classId: string
     *   - createdAt: timestamp
     *   - updatedAt: timestamp
     */
    
    /**
     * Collection: course_staff (DEPENDENCY - already exists in system)
     * Document ID: CST_{courseId}_{staffId}
     *   Example: "CST_CRS_2025_DEMO-CO-001_Tchr001"
     * Fields:
     *   - courseId: string (e.g., "CRS_2025_DEMO-CO-001")
     *   - staffId: string (e.g., "Tchr001")
     *   - staffNameCache: string (display name cache, preferredName if available)
     *   - role: string ("Primary Teacher" | "Assistant Teacher")
     *   - createdAt: timestamp
     *   - updatedAt: timestamp
     * Composite Indexes:
     *   - courseId + role
     */
    
    /**
     * Collection: course_enrollments (DEPENDENCY - already exists in system)
     * Document ID: ENR_{courseId}_{studentId}
     *   Example: "ENR_CRS_2025_DEMO-CO-001_stu123"
     * Fields:
     *   - courseId: string (e.g., "CRS_2025_DEMO-CO-001")
     *   - studentId: string (student doc ID, e.g., "stu123")
     *   - status: string ("active" | "dropped")
     *   - enrolledAt: timestamp
     *   - droppedAt: timestamp (optional)
     * Composite Indexes:
     *   - courseId + status
     */
    
    /**
     * Collection: assessments
     * Document ID: ASM_{courseId}_{yyyymmdd}_{seq}
     *   Where:
     *     - yyyymmdd = date with dashes removed (e.g., "20250115")
     *     - seq = two-digit sequence number (01, 02, etc.)
     *   Example: "ASM_CRS_2025_DEMO-CO-001_20250115_01"
     * Fields:
     *   - courseId: string (required, e.g., "CRS_2025_DEMO-CO-001")
     *   - date: string (required, "YYYY-MM-DD" format)
     *   - name: string (required, e.g., "Quiz 1")
     *   - createdByStaffId: string (staffId, e.g., "Tchr001")
     *   - createdByNameCache: string (display name cache, preferredName if available)
     *   - updatedByStaffId: string (staffId of last editor)
     *   - updatedByNameCache: string (display name cache of last editor)
     *   - gradedByStaffId: string (staffId who entered grades)
     *   - gradedByNameCache: string (display name cache who entered grades)
     *   - maxScore: number (optional, can be null)
     *   - status: string ("active" | "archived", default "active")
     *   - createdAt: timestamp
     *   - updatedAt: timestamp
     * Composite Indexes:
     *   - courseId + date
     *   - courseId + status
     */
    
    /**
     * Collection: grades
     * Document ID: GRD_{assessmentId}_{studentId}
     *   Example: "GRD_ASM_CRS_2025_DEMO-CO-001_20250115_01_stu123"
     * Fields:
     *   - assessmentId: string (required, points to assessments docId)
     *   - studentId: string (required, student doc ID)
     *   - score: number | null (if null and comment empty, delete record)
     *   - comment: string (optional, empty string if none)
     *   - createdAt: timestamp
     *   - updatedAt: timestamp
     * Composite Indexes:
     *   - assessmentId
     *   - studentId
     * Deletion Rule:
     *   - If score is null/empty AND comment is empty, delete the grade record
     */

    // ============================================================================
    // DOCUMENT ID BUILDERS & HELPERS
    // ============================================================================
    
    /**
     * Build assessment document ID following naming convention
     * Format: ASM_{courseId}_{yyyymmdd}_{seq}
     * Sequence starts at 01 and increments for assessments on the same date
     * @param {string} courseId - Course document ID
     * @param {string} date - Date in YYYY-MM-DD format
     * @param {Array<string>} existingAssessmentIds - Array of existing assessment IDs to check for collisions
     * @returns {string} Assessment document ID
     */
    function makeAssessmentDocId(courseId, date, existingAssessmentIds = []) {
      const datePart = date.replace(/-/g, ''); // "2025-01-15" -> "20250115"
      const basePrefix = `ASM_${courseId}_${datePart}_`;
      
      // Find highest sequence number for this date
      let maxSeq = 0;
      existingAssessmentIds.forEach(id => {
        if (id.startsWith(basePrefix)) {
          const seqMatch = id.match(/_(\d{2})$/);
          if (seqMatch) {
            const seq = parseInt(seqMatch[1], 10);
            if (seq > maxSeq) maxSeq = seq;
          }
        }
      });
      
      const nextSeq = String(maxSeq + 1).padStart(2, '0');
      return `${basePrefix}${nextSeq}`;
    }
    
    /**
     * Build grade document ID following naming convention
     * Format: GRD_{assessmentId}_{studentId}
     * @param {string} assessmentId - Assessment document ID
     * @param {string} studentId - Student document ID
     * @returns {string} Grade document ID
     */
    function makeGradeDocId(assessmentId, studentId) {
      return `GRD_${assessmentId}_${studentId}`;
    }
    
    /**
     * Build course staff document ID following naming convention
     * Format: CST_{courseId}_{staffId}
     * @param {string} courseId - Course document ID
     * @param {string} staffId - Staff document ID
     * @returns {string} Course staff document ID
     */
    function makeCourseStaffDocId(courseId, staffId) {
      return `CST_${courseId}_${staffId}`;
    }

    // ============================================================================
    // CONFIGURATION
    // ============================================================================
    
    // Get courseId from URL parameter (passed from Courses.html)
    const urlParams = new URLSearchParams(window.location.search);
    let currentCourseId = urlParams.get('courseId');
    
    // Fallback if no courseId provided
    if (!currentCourseId) {
      console.warn('No courseId provided in URL parameter');
      currentCourseId = "CRS_2025_DEMO-CO-001"; // Fallback for testing
    }
    
    const defaultConfig = {
      add_button_text: "Add Assessment",
      primary_bg: "#f8f9fa",
      surface_color: "#ffffff",
      text_color: "#1a1a1a",
      primary_action: "#2563eb",
      secondary_action: "#64748b"
    };

    let config = { ...defaultConfig };

    // ============================================================================
    // APPLICATION STATE
    // ============================================================================
    
    let students = []; // Will hold enriched student data (from course_enrollments + students collections)
    let assessments = []; // Will hold assessment documents
    let grades = []; // Will hold grade documents
    let currentAssessmentId = null; // Currently selected assessment for grade modal
    let coursePrimaryTeacherStaffId = null; // Primary teacher staffId for this course
    let coursePrimaryTeacherName = null; // Primary teacher display name for this course
    let staffMap = new Map(); // Map of staffId -> staff object (for all active teachers)

    // ============================================================================
    // DATA ACCESS LAYER (DAL) - Placeholder Functions for Firestore Integration
    // ============================================================================
    
    /**
     * Load course information by courseId
     * FIRESTORE OPERATION:
     *   - Collection: courses
     *   - Query: getDoc(doc(db, 'courses', courseId))
     * @param {string} courseId - Course document ID
     * @returns {Promise<Object|null>} Course document or null
     */
    async function dal_loadCourse(courseId) {
      try {
        const docRef = db.collection('courses').doc(courseId);
        const docSnap = await docRef.get();
        return docSnap.exists ? { id: docSnap.id, ...docSnap.data() } : null;
      } catch (error) {
        console.error('Error loading course:', error);
        throw error;
      }
    }
    
    /**
     * Load course_enrollments for a specific course
     * FIRESTORE OPERATION:
     *   - Collection: course_enrollments
     *   - Query: where('courseId', '==', courseId)
     *   - Composite Index Required: courseId + status
     * @param {string} courseId - Course document ID
     * @returns {Promise<Array>} Array of enrollment documents
     */
    async function dal_loadEnrollmentsByCourse(courseId) {
      try {
        const querySnapshot = await db.collection('course_enrollments')
          .where('courseId', '==', courseId)
          .get();
        return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error('Error loading enrollments:', error);
        throw error;
      }
    }
    
    /**
     * Load student documents by their document IDs
     * FIRESTORE OPERATION:
     *   - Collection: students
     *   - Query: Multiple getDoc() calls or batched read
     * @param {Array<string>} studentIds - Array of student document IDs
     * @returns {Promise<Map>} Map of studentId -> student document
     */
    async function dal_loadStudentsByIds(studentIds) {
      try {
        const studentMap = new Map();
        
        // Batch read students in chunks of 10 (Firestore limit for 'in' queries)
        const chunks = [];
        for (let i = 0; i < studentIds.length; i += 10) {
          chunks.push(studentIds.slice(i, i + 10));
        }
        
        for (const chunk of chunks) {
          const querySnapshot = await db.collection('students')
            .where(firebase.firestore.FieldPath.documentId(), 'in', chunk)
            .get();
          
          querySnapshot.docs.forEach(doc => {
            studentMap.set(doc.id, { id: doc.id, ...doc.data() });
          });
        }
        
        return studentMap;
      } catch (error) {
        console.error('Error loading students:', error);
        throw error;
      }
    }
    
    /**
     * Load staff member by document ID
     * FIRESTORE OPERATION:
     *   - Collection: staff
     *   - Query: getDoc(doc(db, 'staff', staffId))
     * @param {string} staffId - Staff document ID (e.g., "Tchr001")
     * @returns {Promise<Object|null>} Staff document or null
     */
    async function dal_loadStaffById(staffId) {
      try {
        const docRef = db.collection('staff').doc(staffId);
        const docSnap = await docRef.get();
        return docSnap.exists ? { id: docSnap.id, ...docSnap.data() } : null;
      } catch (error) {
        console.error('Error loading staff:', error);
        throw error;
      }
    }
    
    /**
     * Load all active teachers (staff with "Teacher" role)
     * FIRESTORE OPERATION:
     *   - Collection: staff
     *   - Query: where('roles', 'array-contains', 'Teacher'), where('status', '==', 'active')
     * @returns {Promise<Array>} Array of teacher staff documents
     */
    async function dal_loadActiveTeachers() {
      try {
        const querySnapshot = await db.collection('staff')
          .where('roles', 'array-contains', 'Teacher')
          .where('status', '==', 'active')
          .get();
        return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error('Error loading teachers:', error);
        throw error;
      }
    }
    
    /**
     * Load course_staff records for a specific course
     * FIRESTORE OPERATION:
     *   - Collection: course_staff
     *   - Query: where('courseId', '==', courseId)
     * @param {string} courseId - Course document ID
     * @returns {Promise<Array>} Array of course_staff documents
     */
    async function dal_loadCourseStaff(courseId) {
      try {
        const querySnapshot = await db.collection('course_staff')
          .where('courseId', '==', courseId)
          .get();
        return querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.error('Error loading course staff:', error);
        throw error;
      }
    }
    
    /**
     * Load assessments for a specific course, ordered by date
     * FIRESTORE OPERATION:
     *   - Collection: assessments
     *   - Query: where('courseId', '==', courseId)
     *   - Filtering and sorting done in code to avoid composite index requirement
     * @param {string} courseId - Course document ID
     * @returns {Promise<Array>} Array of assessment documents sorted by date
     */
    async function dal_loadAssessmentsByCourse(courseId) {
      try {
        const querySnapshot = await db.collection('assessments')
          .where('courseId', '==', courseId)
          .get();
        
        // Filter and sort in code to avoid composite index and handle missing status
        const assessments = querySnapshot.docs
          .map(doc => ({ id: doc.id, ...doc.data() }))
          .filter(assessment => {
            // Treat missing status as 'active' for backward compatibility
            const status = assessment.status || 'active';
            return status === 'active';
          })
          .sort((a, b) => {
            // Sort by date ascending
            const dateA = a.date || '';
            const dateB = b.date || '';
            return dateA.localeCompare(dateB);
          });
        
        return assessments;
      } catch (error) {
        console.error('Error loading assessments:', error);
        throw error;
      }
    }
    
    /**
     * Load all grade records for a specific course
     * FIRESTORE OPERATION:
     *   - Collection: grades
     *   - Query: where('assessmentId', 'in', assessmentIds) (batched)
     * @param {Array<string>} assessmentIds - Array of assessment IDs
     * @returns {Promise<Array>} Array of grade documents
     */
    async function dal_loadGradesByAssessments(assessmentIds) {
      try {
        if (assessmentIds.length === 0) return [];
        
        const allGrades = [];
        
        // Batch queries in chunks of 10 (Firestore limit for 'in' queries)
        const chunks = [];
        for (let i = 0; i < assessmentIds.length; i += 10) {
          chunks.push(assessmentIds.slice(i, i + 10));
        }
        
        for (const chunk of chunks) {
          const querySnapshot = await db.collection('grades')
            .where('assessmentId', 'in', chunk)
            .get();
          
          querySnapshot.docs.forEach(doc => {
            allGrades.push({ id: doc.id, ...doc.data() });
          });
        }
        
        return allGrades;
      } catch (error) {
        console.error('Error loading grades:', error);
        throw error;
      }
    }
    
    /**
     * Create a new assessment document
     * FIRESTORE OPERATION:
     *   - Collection: assessments
     *   - Operation: setDoc(doc(db, 'assessments', assessmentId), payload)
     * @param {string} courseId - Course document ID
     * @param {Object} payload - Assessment data
     * @param {string} payload.date - Date in YYYY-MM-DD format
     * @param {string} payload.name - Assessment name
     * @param {string} payload.createdByStaffId - Staff ID
     * @param {string} payload.createdByNameCache - Staff display name
     * @param {number|null} payload.maxScore - Maximum score (optional)
     * @returns {Promise<string>} The created assessment document ID
     */
    async function dal_createAssessment(courseId, payload) {
      try {
        // Get existing assessment IDs to check for collisions
        const existingAssessments = await dal_loadAssessmentsByCourse(courseId);
        const existingIds = existingAssessments.map(a => a.id);
        
        // Generate deterministic document ID
        const assessmentId = makeAssessmentDocId(
          courseId,
          payload.date,
          existingIds
        );
        
        const assessmentDoc = {
          courseId: courseId,
          date: payload.date,
          name: payload.name,
          createdByStaffId: payload.createdByStaffId,
          createdByNameCache: payload.createdByNameCache,
          maxScore: payload.maxScore || null,
          status: 'active',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('assessments').doc(assessmentId).set(assessmentDoc);
        return assessmentId;
      } catch (error) {
        console.error('Error creating assessment:', error);
        throw error;
      }
    }
    
    /**
     * Update an existing assessment document
     * FIRESTORE OPERATION:
     *   - Collection: assessments
     *   - Operation: updateDoc(doc(db, 'assessments', assessmentId), updates)
     * @param {string} assessmentId - Assessment document ID
     * @param {Object} updates - Fields to update
     * @returns {Promise<void>}
     */
    async function dal_updateAssessment(assessmentId, updates) {
      try {
        await db.collection('assessments').doc(assessmentId).update({
          ...updates,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) {
        console.error('Error updating assessment:', error);
        throw error;
      }
    }
    
    /**
     * Delete an assessment and all associated grade records
     * FIRESTORE OPERATION:
     *   - Collection: assessments
     *   - Operation: deleteDoc(doc(db, 'assessments', assessmentId))
     *   - Also delete all grade records where assessmentId matches
     * @param {string} assessmentId - Assessment document ID
     * @returns {Promise<void>}
     */
    async function dal_deleteAssessment(assessmentId) {
      try {
        // Delete the assessment document
        await db.collection('assessments').doc(assessmentId).delete();
        
        // Delete all associated grade records
        const querySnapshot = await db.collection('grades')
          .where('assessmentId', '==', assessmentId)
          .get();
        
        const batch = db.batch();
        querySnapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });
        await batch.commit();
      } catch (error) {
        console.error('Error deleting assessment:', error);
        throw error;
      }
    }
    
    /**
     * Save or update a grade record
     * If score is null and comment is empty, DELETE the record (Firestore deletion rule)
     * FIRESTORE OPERATION:
     *   - Collection: grades
     *   - Operation: setDoc(doc(db, 'grades', gradeId), payload) or deleteDoc()
     * @param {string} gradeId - Grade document ID
     * @param {Object} payload - Grade data
     * @param {string} payload.assessmentId - Assessment document ID
     * @param {string} payload.studentId - Student document ID
     * @param {number|null} payload.score - Score value
     * @param {string} payload.comment - Comment text
     * @returns {Promise<void>}
     */
    async function dal_saveGradeRecord(gradeId, payload) {
      try {
        // Deletion rule: if score is null/empty AND comment is empty, delete the record
        const shouldDelete = (payload.score === null || payload.score === undefined || payload.score === '') 
                            && (!payload.comment || payload.comment.trim() === '');
        
        if (shouldDelete) {
          await db.collection('grades').doc(gradeId).delete();
          return;
        }
        
        const gradeDoc = {
          assessmentId: payload.assessmentId,
          studentId: payload.studentId,
          score: payload.score,
          comment: payload.comment || '',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        const docRef = db.collection('grades').doc(gradeId);
        const docSnap = await docRef.get();
        
        if (docSnap.exists) {
          await docRef.update(gradeDoc);
        } else {
          await docRef.set({
            ...gradeDoc,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      } catch (error) {
        console.error('Error saving grade record:', error);
        throw error;
      }
    }
    
    /**
     * Delete a grade record (explicit deletion, not via save rule)
     * FIRESTORE OPERATION:
     *   - Collection: grades
     *   - Operation: deleteDoc(doc(db, 'grades', gradeId))
     * @param {string} gradeId - Grade document ID
     * @returns {Promise<void>}
     */
    async function dal_deleteGradeRecord(gradeId) {
      try {
        await db.collection('grades').doc(gradeId).delete();
      } catch (error) {
        console.error('Error deleting grade record:', error);
        throw error;
      }
    }

    // ============================================================================
    // UI HELPER FUNCTIONS
    // ============================================================================
    
    function showLoading(message = 'Loading...') {
      const overlay = document.getElementById('loading-overlay');
      const text = document.getElementById('loading-text');
      if (text) text.textContent = message;
      if (overlay) overlay.classList.add('active');
    }
    
    function hideLoading() {
      const overlay = document.getElementById('loading-overlay');
      if (overlay) overlay.classList.remove('active');
    }
    
    function buildGradesLookup(gradeRecords) {
      const lookup = {};
      for (const record of gradeRecords) {
        if (!lookup[record.assessmentId]) {
          lookup[record.assessmentId] = {};
        }
        lookup[record.assessmentId][record.studentId] = {
          score: record.score,
          comment: record.comment || ''
        };
      }
      return lookup;
    }
    
    function calculateAverage(assessmentId, gradesLookup) {
      const assessmentGrades = gradesLookup[assessmentId] || {};
      const activeGrades = Object.entries(assessmentGrades)
        .filter(([studentId]) => students.find(s => s.id === studentId && s.status === 'active'))
        .map(([, gradeData]) => gradeData.score)
        .filter(score => typeof score === 'number' && !isNaN(score)); // Only include valid numbers
      
      if (activeGrades.length === 0) return 'N/A';
      
      const avg = activeGrades.reduce((sum, score) => sum + score, 0) / activeGrades.length;
      return avg.toFixed(1);
    }
    
    // ============================================================================
    // UI RENDERING FUNCTIONS
    // ============================================================================

    function renderTable() {
      const thead = document.querySelector('#performance-table thead tr');
      const tbody = document.getElementById('table-body');
      const gradesLookup = buildGradesLookup(grades);
      
      // Clear existing assessment columns
      while (thead.children.length > 3) {
        thead.removeChild(thead.lastChild);
      }
      
      // Add assessment column headers
      assessments.forEach(assessment => {
        const th = document.createElement('th');
        th.className = 'assessment-header';
        const avgScore = calculateAverage(assessment.id, gradesLookup);
        const gradedCount = Object.keys(gradesLookup[assessment.id] || {}).length;
        const totalCount = students.filter(s => s.status === "active").length;
        
        // Display teacher name - use cache or fallback to staffMap
        let teacherDisplay = assessment.createdByNameCache || 'Unknown';
        if (!assessment.createdByNameCache && assessment.createdByStaffId && staffMap.has(assessment.createdByStaffId)) {
          const staff = staffMap.get(assessment.createdByStaffId);
          teacherDisplay = staff.preferredName || staff.fullName || staff.id;
        }
        
        th.innerHTML = `
          <div class="assessment-header-content">
            <div class="assessment-title">
              <span>${assessment.name}</span>
              <div class="assessment-actions">
                <svg class="icon-btn" data-action="edit" data-id="${assessment.id}" fill="none" stroke="#2563eb" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                <svg class="icon-btn" data-action="delete" data-id="${assessment.id}" fill="none" stroke="#dc2626" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
              </div>
            </div>
            <div class="assessment-meta">${assessment.date}</div>
            <div class="assessment-meta">${teacherDisplay}</div>
            ${assessment.maxScore ? `<div class="assessment-meta">Max: ${assessment.maxScore}</div>` : ''}
            <div class="assessment-stats">Avg: ${avgScore}</div>
            <div class="assessment-meta">${gradedCount}/${totalCount}</div>
          </div>
        `;
        thead.appendChild(th);
      });
      
      // Clear and add student rows
      tbody.innerHTML = '';
      students.forEach(student => {
        const tr = document.createElement('tr');
        if (student.status === 'dropped') tr.className = 'dropped-row';
        
        const tdId = document.createElement('td');
        tdId.className = 'sticky-col sticky-col-1';
        tdId.textContent = student.publicCode;
        tr.appendChild(tdId);
        
        const tdName = document.createElement('td');
        tdName.className = 'sticky-col sticky-col-2';
        tdName.textContent = student.fullName;
        tr.appendChild(tdName);
        
        const tdStatus = document.createElement('td');
        tdStatus.className = 'sticky-col sticky-col-3';
        let statusClass = 'status-active';
        if (student.status === 'dropped') statusClass = 'status-dropped';
        else if (student.status === 'inactive' || student.status === 'finished') statusClass = 'status-inactive';
        tdStatus.innerHTML = `<span class="status-badge ${statusClass}">${student.status}</span>`;
        tr.appendChild(tdStatus);
        
        // Grade cells
        assessments.forEach(assessment => {
          const tdGrade = document.createElement('td');
          tdGrade.className = 'grade-cell';
          const gradeData = gradesLookup[assessment.id]?.[student.id];
          const isDropped = student.status === 'dropped';
          
          // Check if score is a valid number
          const hasValidScore = gradeData && typeof gradeData.score === 'number' && !isNaN(gradeData.score);
          
          if (hasValidScore) {
            const score = gradeData.score;
            const percentage = assessment.maxScore ? (score / assessment.maxScore) * 100 : 0;
            let cellClass = 'grade-empty';
            if (assessment.maxScore) {
              if (percentage >= 80) cellClass = 'grade-high';
              else if (percentage >= 60) cellClass = 'grade-medium';
              else cellClass = 'grade-low';
            }
            tdGrade.classList.add(cellClass);
            if (gradeData.comment) {
              tdGrade.classList.add('grade-with-comment');
              tdGrade.innerHTML = `${score}<span class="comment-indicator"><svg fill="#2563eb" viewBox="0 0 24 24"><path d="M8 10h8M8 14h6M6 4h12a2 2 0 012 2v12a2 2 0 01-2 2H7l-4 4V6a2 2 0 012-2z"/></svg><span class="comment-tooltip">${gradeData.comment}</span></span>`;
            } else {
              tdGrade.textContent = score;
            }
          } else {
            tdGrade.classList.add('grade-empty');
            tdGrade.textContent = '—';
          }
          
          if (!isDropped) {
            tdGrade.dataset.studentId = student.id;
            tdGrade.dataset.assessmentId = assessment.id;
            tdGrade.addEventListener('click', openGradeModal);
          }
          tr.appendChild(tdGrade);
        });
        tbody.appendChild(tr);
      });
      
      document.querySelectorAll('.icon-btn').forEach(button => {
        button.addEventListener('click', handleAssessmentAction);
      });
    }

    function populateTeacherDropdown(selectId, defaultStaffId = null) {
      const selectElement = document.getElementById(selectId);
      if (!selectElement) return;
      
      // Clear existing options except the first placeholder
      while (selectElement.options.length > 1) {
        selectElement.remove(1);
      }
      
      // Populate with active teachers from staffMap
      staffMap.forEach((staff, staffId) => {
        const option = document.createElement('option');
        option.value = staffId;
        const displayName = staff.preferredName || staff.fullName;
        option.textContent = `${displayName} (${staffId})`;
        selectElement.appendChild(option);
      });
      
      // Set default selection
      if (defaultStaffId && staffMap.has(defaultStaffId)) {
        selectElement.value = defaultStaffId;
      }
    }
    
    function sortStudents(sortBy) {
      // Sort active students first, then dropped students
      students.sort((a, b) => {
        // First, sort by status (active students before dropped)
        if (a.status === 'dropped' && b.status !== 'dropped') return 1;
        if (a.status !== 'dropped' && b.status === 'dropped') return -1;
        
        // Then sort by the selected criteria within each group
        if (sortBy === 'id') {
          return a.publicCode.localeCompare(b.publicCode);
        } else if (sortBy === 'name') {
          return a.fullName.localeCompare(b.fullName);
        }
        return 0;
      });
      renderTable();
    }

    function handleAssessmentAction(event) {
      event.stopPropagation();
      const action = event.currentTarget.dataset.action;
      const assessmentId = event.currentTarget.dataset.id;
      
      if (action === 'edit') {
        openGradeModal(null, assessmentId);
      } else if (action === 'delete') {
        handleDeleteAssessment(assessmentId, event.currentTarget);
      }
    }

    async function handleDeleteAssessment(assessmentId, buttonElement) {
      const assessment = assessments.find(a => a.id === assessmentId);
      const headerCell = buttonElement.closest('th');
      const originalContent = headerCell.innerHTML;
      
      headerCell.innerHTML = `
        <div class="delete-confirm">
          <div class="delete-confirm-text">Delete "${assessment.name}"?</div>
          <div class="delete-confirm-actions">
            <button class="btn-primary btn-small confirm-delete-btn">Delete</button>
            <button class="btn-secondary btn-small cancel-delete-btn">Cancel</button>
          </div>
        </div>
      `;
      
      headerCell.querySelector('.confirm-delete-btn').addEventListener('click', async () => {
        try {
          showLoading('Deleting assessment...');
          
          await dal_deleteAssessment(assessmentId);
          await loadCourseData();
          
          hideLoading();
          showNotification('Assessment deleted successfully', 'success');
        } catch (error) {
          console.error('Error deleting assessment:', error);
          hideLoading();
          showNotification('Failed to delete assessment', 'error');
          headerCell.innerHTML = originalContent;
          headerCell.querySelectorAll('.icon-btn').forEach(button => {
            button.addEventListener('click', handleAssessmentAction);
          });
        }
      });
      
      headerCell.querySelector('.cancel-delete-btn').addEventListener('click', () => {
        headerCell.innerHTML = originalContent;
        headerCell.querySelectorAll('.icon-btn').forEach(button => {
          button.addEventListener('click', handleAssessmentAction);
        });
      });
    }

    function openGradeModal(event, assessmentId = null) {
      const modal = document.getElementById('grade-modal');
      const modalTitle = document.getElementById('modal-title');
      const modalInfo = document.getElementById('modal-info');
      const modalInputs = document.getElementById('grade-inputs');
      
      if (event) assessmentId = event.currentTarget.dataset.assessmentId;
      
      currentAssessmentId = assessmentId;
      const assessment = assessments.find(a => a.id === assessmentId);
      const gradesLookup = buildGradesLookup(grades);
      
      // Display teacher name - use cache or fallback to staffMap
      let teacherDisplay = assessment.createdByNameCache || 'Unknown';
      if (!assessment.createdByNameCache && assessment.createdByStaffId && staffMap.has(assessment.createdByStaffId)) {
        const staff = staffMap.get(assessment.createdByStaffId);
        teacherDisplay = staff.preferredName || staff.fullName || staff.id;
      }
      
      modalTitle.textContent = `Grades — ${assessment.name}`;
      modalInfo.innerHTML = `
        <div class="modal-info-item">
          <strong>Date</strong>
          <input type="date" id="modal-date" value="${assessment.date}">
        </div>
        <div class="modal-info-item">
          <strong>Teacher</strong>
          <select id="modal-teacher">
            <option value="">Select teacher...</option>
          </select>
        </div>
        <div class="modal-info-item">
          <strong>Max score</strong>
          <input type="number" id="modal-maxscore" value="${assessment.maxScore || ''}" placeholder="Optional">
        </div>
      `;
      
      // Populate teacher dropdown with current assessment's teacher selected
      populateTeacherDropdown('modal-teacher', assessment.createdByStaffId || coursePrimaryTeacherStaffId);
      
      modalInputs.innerHTML = '';
      const activeStudents = students.filter(s => s.status === 'active');
      
      if (activeStudents.length === 0) {
        modalInputs.innerHTML = '<div style="padding: 20px; text-align: center; color: #64748b;">No active students enrolled in this course.</div>';
        modal.classList.add('active');
        return;
      }
      
      activeStudents.forEach(student => {
        const gradeData = gradesLookup[assessmentId]?.[student.id];
        const currentScore = gradeData?.score !== undefined && gradeData?.score !== null ? gradeData.score : '';
        const currentComment = gradeData?.comment || '';
        const maxScoreDisplay = assessment.maxScore ? `/${assessment.maxScore}` : '';
        
        const inputRow = document.createElement('div');
        inputRow.className = 'grade-input-row';
        inputRow.innerHTML = `
          <div class="grade-input-label">${student.publicCode} — ${student.fullName}</div>
          <div class="score-input-wrapper">
            <input type="number" class="grade-input-field" data-student-id="${student.id}" data-student-code="${student.publicCode}" value="${currentScore}">
            ${maxScoreDisplay ? `<span class="max-score-display">${maxScoreDisplay}</span>` : ''}
          </div>
          <textarea class="comment-input-field" data-student-id="${student.id}" placeholder="Comment (optional)" rows="1">${currentComment}</textarea>
        `;
        modalInputs.appendChild(inputRow);
      });
      
      modal.classList.add('active');
    }

    function closeGradeModal() {
      document.getElementById('grade-modal').classList.remove('active');
      currentAssessmentId = null;
    }

    async function handleSaveGrades() {
      if (!currentAssessmentId) return;
      
      try {
        showLoading('Saving grades...');
        
        const assessment = assessments.find(a => a.id === currentAssessmentId);
        const selectedTeacherStaffId = document.getElementById('modal-teacher')?.value;
        const selectedTeacherName = selectedTeacherStaffId && staffMap.has(selectedTeacherStaffId) 
          ? (staffMap.get(selectedTeacherStaffId).preferredName || staffMap.get(selectedTeacherStaffId).fullName)
          : null;
        
        const updatedFields = {
          date: document.getElementById('modal-date')?.value || assessment.date,
          maxScore: document.getElementById('modal-maxscore')?.value ? parseInt(document.getElementById('modal-maxscore').value) : null,
          updatedByStaffId: selectedTeacherStaffId || assessment.createdByStaffId || coursePrimaryTeacherStaffId,
          updatedByNameCache: selectedTeacherName || assessment.createdByNameCache || coursePrimaryTeacherName,
          gradedByStaffId: selectedTeacherStaffId || assessment.createdByStaffId || coursePrimaryTeacherStaffId,
          gradedByNameCache: selectedTeacherName || assessment.createdByNameCache || coursePrimaryTeacherName
        };
        
        // If teacher was changed, update the createdBy fields as well
        if (selectedTeacherStaffId && selectedTeacherStaffId !== assessment.createdByStaffId) {
          updatedFields.createdByStaffId = selectedTeacherStaffId;
          updatedFields.createdByNameCache = selectedTeacherName;
        }
        
        await dal_updateAssessment(currentAssessmentId, updatedFields);
        
        const scoreInputs = document.querySelectorAll('.grade-input-field');
        const commentInputs = document.querySelectorAll('.comment-input-field');
        const savePromises = [];
        
        scoreInputs.forEach((input, index) => {
          const gradeId = makeGradeDocId(currentAssessmentId, input.dataset.studentId);
          const payload = {
            assessmentId: currentAssessmentId,
            studentId: input.dataset.studentId,
            score: input.value.trim() !== '' ? parseFloat(input.value) : null,
            comment: commentInputs[index].value.trim()
          };
          savePromises.push(dal_saveGradeRecord(gradeId, payload));
        });
        
        await Promise.all(savePromises);
        await loadCourseData();
        hideLoading();
        closeGradeModal();
        showNotification('Grades and assessment details saved', 'success');
      } catch (error) {
        console.error('Error saving grades:', error);
        hideLoading();
        showNotification('Failed to save grades', 'error');
      }
    }

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `notification notification-${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // ============================================================================
    // DATA LOADING & INITIALIZATION
    // ============================================================================

    /**
     * Load all course data from DAL
     */
    async function loadCourseData() {
      try {
        showLoading('Loading course data...');
        
        // Load enrollments for this course
        const enrollmentsData = await dal_loadEnrollmentsByCourse(currentCourseId);
        
        // Extract unique student IDs
        const studentIds = enrollmentsData.map(e => e.studentId);
        
        // Load student details
        const studentsMap = await dal_loadStudentsByIds(studentIds);
        
        // Merge enrollment + student data
        students = enrollmentsData.map(enrollment => {
          const studentData = studentsMap.get(enrollment.studentId);
          
          // Normalize status from Firestore to lowercase
          const rawStatus = (enrollment.status || 'active').toString().toLowerCase().trim();
          
          return {
            id: enrollment.studentId,
            publicCode: studentData?.publicCode || '',
            fullName: studentData?.fullName || 'Unknown',
            status: rawStatus,
            classId: studentData?.classId || ''
          };
        });
        
        // Load assessments
        assessments = await dal_loadAssessmentsByCourse(currentCourseId);
        
        // Load grades for all assessments
        const assessmentIds = assessments.map(a => a.id);
        grades = await dal_loadGradesByAssessments(assessmentIds);
        
        // Re-render UI
        renderTable();
        
        hideLoading();
      } catch (error) {
        console.error('Error loading course data:', error);
        hideLoading();
        showNotification('Failed to load course data', 'error');
      }
    }

    /**
     * Initialize the application
     */
    async function initializeApp() {
      try {
        showLoading('Initializing...');
        
        // Load course info
        const courseInfo = await dal_loadCourse(currentCourseId);
        if (!courseInfo) {
          hideLoading();
          showNotification('Course not found', 'error');
          return;
        }
        console.log('Course loaded:', courseInfo);
        
        // Load all active teachers FIRST
        const teachers = await dal_loadActiveTeachers();
        staffMap = new Map(teachers.map(t => [t.id, t]));
        console.log('Loaded teachers:', staffMap.size);
        
        // Load course_staff to find primary teacher
        const courseStaffRecords = await dal_loadCourseStaff(currentCourseId);
        const primaryTeacherRecord = courseStaffRecords.find(cs => cs.role === 'Primary Teacher');
        
        if (primaryTeacherRecord) {
          coursePrimaryTeacherStaffId = primaryTeacherRecord.staffId;
          // Get display name from staffMap
          if (staffMap.has(coursePrimaryTeacherStaffId)) {
            const staff = staffMap.get(coursePrimaryTeacherStaffId);
            coursePrimaryTeacherName = staff.preferredName || staff.fullName || staff.id;
          } else {
            // Fallback to cached name in course_staff
            coursePrimaryTeacherName = primaryTeacherRecord.staffNameCache;
          }
        }
        
        // Update course header
        const courseHeader = document.getElementById('course-header');
        if (courseHeader) {
          courseHeader.textContent = `${courseInfo.publicCode} — ${courseInfo.name}`;
        }
        
        // Populate teacher dropdown in add assessment form with default selection
        populateTeacherDropdown('assessment-teacher', coursePrimaryTeacherStaffId);
        
        // Load all course data
        await loadCourseData();
      } catch (error) {
        console.error('Error initializing app:', error);
        hideLoading();
        showNotification('Failed to initialize application', 'error');
      }
    }

    // ============================================================================
    // EVENT HANDLERS
    // ============================================================================

    // Event Listeners
    document.getElementById('add-assessment-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const date = document.getElementById('assessment-date').value;
      const name = document.getElementById('assessment-name').value;
      const teacherStaffId = document.getElementById('assessment-teacher').value;
      const maxScore = document.getElementById('assessment-max-score').value;
      
      if (!date || !name || !teacherStaffId) {
        showNotification('Please fill in Date, Name, and Teacher fields', 'error');
        return;
      }
      
      try {
        showLoading('Adding assessment...');
        
        // Get teacher name from staffMap (preferredName if available, otherwise fullName)
        const teacherName = staffMap.has(teacherStaffId) 
          ? (staffMap.get(teacherStaffId).preferredName || staffMap.get(teacherStaffId).fullName)
          : 'Unknown';
        
        const payload = {
          date: date,
          name: name,
          createdByStaffId: teacherStaffId,
          createdByNameCache: teacherName,
          maxScore: maxScore ? parseInt(maxScore) : null
        };
        
        // Create assessment via DAL
        const newAssessmentId = await dal_createAssessment(currentCourseId, payload);
        console.log('Created assessment:', newAssessmentId);
        
        // Clear form
        document.getElementById('assessment-date').value = '';
        document.getElementById('assessment-name').value = '';
        document.getElementById('assessment-max-score').value = '';
        
        // Reset teacher dropdown to default (primary teacher)
        populateTeacherDropdown('assessment-teacher', coursePrimaryTeacherStaffId);
        
        // Reload data and re-render
        await loadCourseData();
        
        hideLoading();
        showNotification(`Assessment "${name}" added successfully`, 'success');
      } catch (error) {
        console.error('Error adding assessment:', error);
        hideLoading();
        showNotification('Failed to add assessment', 'error');
      }
    });

    document.getElementById('student-sort').addEventListener('change', (e) => {
      sortStudents(e.target.value);
    });

    document.getElementById('modal-close').addEventListener('click', closeGradeModal);
    document.getElementById('modal-cancel').addEventListener('click', closeGradeModal);
    document.getElementById('modal-save').addEventListener('click', handleSaveGrades);

    document.getElementById('grade-modal').addEventListener('click', (e) => {
      if (e.target.id === 'grade-modal') {
        closeGradeModal();
      }
    });

    // ============================================================================
    // ELEMENT SDK IMPLEMENTATION
    // ============================================================================
    async function onConfigChange(newConfig) {
      const addButtonElement = document.getElementById('add-button');
      const appContainer = document.getElementById('app-container');
      
      if (addButtonElement) {
        addButtonElement.textContent = newConfig.add_button_text || defaultConfig.add_button_text;
      }
      
      const primaryBg = newConfig.primary_bg || defaultConfig.primary_bg;
      const surfaceColor = newConfig.surface_color || defaultConfig.surface_color;
      const textColor = newConfig.text_color || defaultConfig.text_color;
      const primaryAction = newConfig.primary_action || defaultConfig.primary_action;
      
      if (appContainer) {
        appContainer.style.backgroundColor = primaryBg;
      }
      
      document.body.style.backgroundColor = primaryBg;
      document.body.style.color = textColor;
      
      document.querySelectorAll('.card').forEach(el => {
        el.style.backgroundColor = surfaceColor;
      });
      
      document.querySelectorAll('.btn-primary').forEach(el => {
        el.style.backgroundColor = primaryAction;
      });
    }

    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (cfg) => ({
          recolorables: [
            {
              get: () => cfg.primary_bg || defaultConfig.primary_bg,
              set: (value) => {
                cfg.primary_bg = value;
                window.elementSdk.setConfig({ primary_bg: value });
              }
            },
            {
              get: () => cfg.surface_color || defaultConfig.surface_color,
              set: (value) => {
                cfg.surface_color = value;
                window.elementSdk.setConfig({ surface_color: value });
              }
            },
            {
              get: () => cfg.text_color || defaultConfig.text_color,
              set: (value) => {
                cfg.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => cfg.primary_action || defaultConfig.primary_action,
              set: (value) => {
                cfg.primary_action = value;
                window.elementSdk.setConfig({ primary_action: value });
              }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ["add_button_text", cfg.add_button_text || defaultConfig.add_button_text]
        ])
      });
      
      config = window.elementSdk.config;
    }

    // ============================================================================
    // APP INITIALIZATION
    // ============================================================================
    
    // Initialize the application on page load
    initializeApp();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b6a4cfc541abc74',t:'MTc2NzE4OTYwMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
