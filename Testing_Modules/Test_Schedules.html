<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mock Test Schedules</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, query, where, orderBy, Timestamp, onSnapshot, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyCDzv0HseeLfijzyXZjKWFh9QaLrMB4afo",
      authDomain: "tnl2026.firebaseapp.com",
      projectId: "tnl2026",
      storageBucket: "tnl2026.firebasestorage.app",
      messagingSenderId: "883525152224",
      appId: "1:883525152224:web:619ae152cd8df3fcca8f85",
      measurementId: "G-3K6LXCKHZ9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Timestamp ID helpers
    function pad2(n) { return String(n).padStart(2, '0'); }
    function pad3(n) { return String(n).padStart(3, '0'); }
    
    function tsId(prefix) {
      const now = new Date();
      const Y = now.getFullYear();
      const M = pad2(now.getMonth() + 1);
      const D = pad2(now.getDate());
      const h = pad2(now.getHours());
      const m = pad2(now.getMinutes());
      const s = pad2(now.getSeconds());
      const ms = pad3(now.getMilliseconds());
      const r = pad3(Math.floor(Math.random() * 1000));
      return `${prefix}_${Y}${M}${D}_${h}${m}${s}_${ms}_${r}`;
    }

    // Global state
    const state = {
      currentTab: 'types',
      types: [],
      events: [],
      slotsByEvent: {},
      registrations: [],
      selectedEventId: null,
      slotsUnsubscriber: null,
      registrationsUnsubscriber: null,
      editingTypeId: null,
      editingEventId: null,
      editingSlotId: null,
      searchQuery: '',
      unsubscribers: []
    };



    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      setupTabNavigation();
      setupSearchFilter();
      await loadTypes();
      setupEventsListener();
      renderCurrentTab();
    });

    function setupTabNavigation() {
      document.getElementById('tabTypes').addEventListener('click', () => switchTab('types'));
      document.getElementById('tabSchedules').addEventListener('click', () => switchTab('schedules'));
    }

    function setupSearchFilter() {
      document.getElementById('searchEvents').addEventListener('input', (e) => {
        state.searchQuery = e.target.value.toLowerCase();
        renderEventsList();
      });
    }

    function switchTab(tab) {
      state.currentTab = tab;
      
      const typesTab = document.getElementById('tabTypes');
      const schedulesTab = document.getElementById('tabSchedules');
      const viewTypes = document.getElementById('viewTypes');
      const viewSchedules = document.getElementById('viewSchedules');
      
      if (tab === 'types') {
        typesTab.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
        typesTab.classList.remove('text-gray-600');
        schedulesTab.classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
        schedulesTab.classList.add('text-gray-600');
        viewTypes.classList.remove('hidden');
        viewSchedules.classList.add('hidden');
      } else {
        schedulesTab.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
        schedulesTab.classList.remove('text-gray-600');
        typesTab.classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
        typesTab.classList.add('text-gray-600');
        viewSchedules.classList.remove('hidden');
        viewTypes.classList.add('hidden');
      }
      
      renderCurrentTab();
    }

    function renderCurrentTab() {
      if (state.currentTab === 'types') {
        renderTypes();
      } else {
        renderEventsList();
        if (state.selectedEventId) {
          renderEventDetails();
        }
      }
    }

    // Load types
    async function loadTypes() {
      const snapshot = await getDocs(collection(db, 'mockTestTypes'));
      state.types = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    // Setup real-time events listener
    function setupEventsListener() {
      const q = query(collection(db, 'mockTestEvents'), orderBy('createdAt', 'desc'));
      const unsubscribe = onSnapshot(q, (snapshot) => {
        state.events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderEventsList();
        if (state.selectedEventId) {
          renderEventDetails();
        }
      });
      state.unsubscribers.push(unsubscribe);
    }

    // Setup real-time slots listener for selected event
    function setupSlotsListener(eventId) {
      // Unsubscribe previous slots listener
      if (state.slotsUnsubscriber) {
        state.slotsUnsubscriber();
      }
      
      const q = query(collection(db, 'mockTestSlots'), where('eventId', '==', eventId), orderBy('startAt', 'asc'));
      state.slotsUnsubscriber = onSnapshot(q, (snapshot) => {
        state.slotsByEvent[eventId] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderSlotsTable();
      });
    }

    // Setup real-time registrations listener for selected event
    function setupRegistrationsListener(eventId) {
      // Unsubscribe previous registrations listener
      if (state.registrationsUnsubscriber) {
        state.registrationsUnsubscriber();
      }
      
      const q = query(collection(db, 'mockTestRegistrations'), where('eventId', '==', eventId));
      state.registrationsUnsubscriber = onSnapshot(q, (snapshot) => {
        state.registrations = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderSlotsTable();
      });
    }

    // Render Test Types
    function renderTypes() {
      const container = document.getElementById('typesList');
      container.innerHTML = '';

      if (state.types.length === 0) {
        container.innerHTML = '<div class="text-center py-12 text-gray-500">No test types yet. Create your first one!</div>';
        return;
      }

      state.types.forEach(type => {
        const div = document.createElement('div');
        div.className = 'bg-white border border-gray-200 rounded-lg p-5 hover:shadow-md transition-shadow';
        
        const regMessagePreview = type.templates?.regMessage 
          ? (type.templates.regMessage.length > 80 ? type.templates.regMessage.substring(0, 80) + '...' : type.templates.regMessage)
          : 'No message template';
        
        div.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div>
              <h3 class="font-bold text-lg text-gray-800">${escapeHtml(type.name)}</h3>
              <p class="text-sm text-gray-600 mt-1">Format: <span class="font-medium">${escapeHtml(type.format)}</span></p>
            </div>
            <div class="flex gap-2">
              <button onclick="window.editType('${type.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-medium px-3 py-1 rounded hover:bg-blue-50">Edit</button>
              <button onclick="window.deleteType('${type.id}')" class="text-red-600 hover:text-red-800 text-sm font-medium px-3 py-1 rounded hover:bg-red-50">Delete</button>
            </div>
          </div>
          <div class="text-sm text-gray-700 space-y-2">
            <p><span class="font-medium">Components:</span> ${type.components && type.components.length > 0 ? type.components.join(', ') : 'None'}</p>
            <p><span class="font-medium">Duration:</span> ${type.defaultDurationMin} min | <span class="font-medium">Fee:</span> ${formatVnd(type.defaultFeeVnd)} VND</p>
            <p class="text-xs text-gray-600 italic mt-2"><span class="font-medium">Reg Message:</span> ${escapeHtml(regMessagePreview)}</p>
          </div>
        `;
        container.appendChild(div);
      });
    }

    // Render Events List (left panel)
    function renderEventsList() {
      const container = document.getElementById('eventsList');
      container.innerHTML = '';

      let filteredEvents = state.events;
      if (state.searchQuery) {
        filteredEvents = state.events.filter(e => 
          e.title.toLowerCase().includes(state.searchQuery) || 
          e.location.toLowerCase().includes(state.searchQuery)
        );
      }

      if (filteredEvents.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500 text-sm">No events found</div>';
        return;
      }

      filteredEvents.forEach(event => {
        const type = state.types.find(t => t.id === event.typeId);
        const regOpen = event.regOpenAt ? event.regOpenAt.toDate() : null;
        const regClose = event.regCloseAt ? event.regCloseAt.toDate() : null;
        
        const div = document.createElement('div');
        div.className = `border-b border-gray-200 p-2 cursor-pointer hover:bg-gray-50 transition-colors ${state.selectedEventId === event.id ? 'bg-blue-50 border-l-4 border-l-blue-600' : ''}`;
        div.onclick = () => selectEvent(event.id);
        
        div.innerHTML = `
          <h4 class="font-semibold text-gray-800 text-xs mb-0.5">${escapeHtml(event.title)}</h4>
          <p class="text-xs text-gray-600">${type ? escapeHtml(type.name) : 'Unknown'}</p>
          <p class="text-xs text-gray-500">${regOpen ? formatDate(regOpen) : 'TBD'} - ${regClose ? formatDate(regClose) : 'TBD'}</p>
        `;
        container.appendChild(div);
      });
    }

    // Select event
    function selectEvent(eventId) {
      state.selectedEventId = eventId;
      setupSlotsListener(eventId);
      setupRegistrationsListener(eventId);
      renderEventsList();
      renderEventDetails();
    }

    // Render Event Details (right panel)
    function renderEventDetails() {
      const event = state.events.find(e => e.id === state.selectedEventId);
      if (!event) {
        document.getElementById('eventDetailsArea').innerHTML = '<div class="text-center py-12 text-gray-500">Select an event to view details</div>';
        return;
      }

      const type = state.types.find(t => t.id === event.typeId);
      const regOpen = event.regOpenAt ? event.regOpenAt.toDate() : null;
      const regClose = event.regCloseAt ? event.regCloseAt.toDate() : null;

      document.getElementById('eventDetailsArea').innerHTML = `
        <div class="space-y-3">
          <!-- Event Info + Registration Tools - Single Row -->
          <div class="bg-white border border-gray-200 rounded-lg p-4">
            <div class="flex gap-4 items-start">
              <!-- Event Details - Left Side -->
              <div class="flex-1 min-w-0 flex flex-col">
                <div class="text-center mb-3">
                  <h3 class="text-lg font-bold text-gray-800">${escapeHtml(event.title)}</h3>
                  <p class="text-xs text-gray-600 mt-1">${type ? escapeHtml(type.name) : 'Unknown'} (${type ? escapeHtml(type.format) : ''}) ‚Ä¢ ${escapeHtml(event.location)}</p>
                </div>
                <div class="text-xs text-gray-700 text-center mb-3">
                  <p><span class="font-medium">Registration:</span> ${regOpen ? formatDateTime(regOpen) : 'TBD'} ‚Üí ${regClose ? formatDateTime(regClose) : 'TBD'}</p>
                  ${event.notes ? `<p class="mt-1"><span class="font-medium">Notes:</span> ${escapeHtml(event.notes)}</p>` : ''}
                </div>
                <div class="flex gap-2 justify-center mt-auto">
                  <button onclick="window.editEvent('${event.id}')" class="text-blue-600 hover:text-blue-800 text-xs font-medium px-3 py-1.5 rounded hover:bg-blue-50 border border-blue-200">Edit</button>
                  <button onclick="window.deleteEvent('${event.id}')" class="text-red-600 hover:text-red-800 text-xs font-medium px-3 py-1.5 rounded hover:bg-red-50 border border-red-200">Delete</button>
                </div>
              </div>

              <!-- Registration Link - Middle -->
              <div class="flex-shrink-0" style="min-width: 280px; max-width: 320px;">
                <label class="text-xs font-semibold text-gray-700 mb-1 block">üìã Registration Link</label>
                <div class="flex gap-2 mb-1">
                  <input type="text" id="regLinkDisplay" readonly class="flex-1 min-w-0 bg-gray-50 border border-gray-300 rounded px-2 py-1 text-xs" />
                </div>
                <div class="flex gap-2">
                  <button onclick="window.copyRegLink()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs font-medium whitespace-nowrap">
                    Copy
                  </button>
                  <button onclick="window.openRegPage()" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-xs font-medium whitespace-nowrap">
                    Open
                  </button>
                </div>
              </div>

              <!-- QR Code - Right Side -->
              <div class="flex-shrink-0">
                <label class="text-xs font-semibold text-gray-700 mb-1 block text-center">QR Code</label>
                <div id="qrCodeContainer" class="bg-white p-2 rounded border border-gray-300 flex justify-center"></div>
              </div>
            </div>
          </div>

          <!-- Slots Card -->
          <div class="bg-white border border-gray-200 rounded-lg p-4">
            <div class="flex justify-between items-center mb-3">
              <h4 class="text-base font-bold text-gray-800">Test Slots</h4>
              <button onclick="window.showBatchSlotModal()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded text-sm font-medium transition-colors">
                + Add Slots
              </button>
            </div>
            <div id="slotsSection"></div>
          </div>
        </div>
      `;

      // Generate registration link
      const regLink = new URL('Test_Regis.html', window.location.href);
      regLink.searchParams.set('eventId', event.id);
      const regLinkStr = regLink.toString();

      document.getElementById('regLinkDisplay').value = regLinkStr;
      
      // Generate QR code
      const qrContainer = document.getElementById('qrCodeContainer');
      qrContainer.innerHTML = '';
      new QRCode(qrContainer, {
        text: regLinkStr,
        width: 120,
        height: 120
      });

      window.currentRegLink = regLinkStr;

      renderSlotsTable();
    }

    // Render Slots Table
    function renderSlotsTable() {
      const container = document.getElementById('slotsSection');
      if (!container) return;

      const slots = state.slotsByEvent[state.selectedEventId] || [];

      if (slots.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-gray-500 text-sm">No slots yet. Click "Add Slots" to create.</div>';
        return;
      }

      let html = `<div class="space-y-2">`;

      slots.forEach(slot => {
        const start = slot.startAt ? slot.startAt.toDate() : null;
        
        // Calculate duration dynamically from type duration
        const event = state.events.find(e => e.id === state.selectedEventId);
        const type = event ? state.types.find(t => t.id === event.typeId) : null;
        const durationMin = type ? type.defaultDurationMin : 0;
        
        const occupied = state.registrations.filter(r => 
          r.slotId === slot.id && 
          ['pending', 'confirmed'].includes(r.status)
        ).length;

        const available = slot.capacity - occupied;
        const statusColor = slot.status === 'open' ? 'text-green-600' : 'text-gray-500';
        const statusBg = slot.status === 'open' ? 'bg-green-50' : 'bg-gray-100';
        const occupiedColor = occupied >= slot.capacity ? 'text-red-600' : 'text-gray-700';

        html += `
          <div class="border border-gray-200 rounded p-2 hover:bg-gray-50 transition-colors">
            <div class="flex justify-between items-start mb-1">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2 flex-wrap">
                  <span class="text-sm font-semibold text-gray-800">${start ? formatDateTime(start) : 'TBD'}</span>
                  <span class="${statusBg} ${statusColor} px-2 py-0.5 rounded text-xs font-medium">${slot.status.toUpperCase()}</span>
                </div>
              </div>
              <div class="flex gap-1 flex-shrink-0">
                <button onclick="window.editSlot('${slot.id}')" class="text-blue-600 hover:text-blue-800 text-xs px-2 py-0.5 rounded hover:bg-blue-50" title="Edit">‚úèÔ∏è</button>
                <button onclick="window.toggleSlotStatus('${slot.id}', '${slot.status}')" class="text-purple-600 hover:text-purple-800 text-xs px-2 py-0.5 rounded hover:bg-purple-50" title="Toggle Status">üîÑ</button>
                <button onclick="window.deleteSlot('${slot.id}')" class="text-red-600 hover:text-red-800 text-xs px-2 py-0.5 rounded hover:bg-red-50" title="Delete">üóëÔ∏è</button>
              </div>
            </div>
            <div class="text-xs text-gray-600 flex flex-wrap gap-2">
              <span>üìç ${escapeHtml(slot.room)}</span>
              <span>‚Ä¢</span>
              <span>üë• Cap: ${slot.capacity}</span>
              <span>‚Ä¢</span>
              <span class="${occupiedColor} font-medium">Occupied: ${occupied}</span>
              <span>‚Ä¢</span>
              <span>Available: ${available}</span>
              <span>‚Ä¢</span>
              <span>‚è±Ô∏è ${durationMin} min</span>
            </div>
          </div>
        `;
      });

      html += `</div>`;

      container.innerHTML = html;
    }

    // Type CRUD
    window.showTypeModal = function() {
      state.editingTypeId = null;
      document.getElementById('typeForm').reset();
      document.getElementById('typeModalTitle').textContent = 'Create Test Type';
      
      // Reset component checkboxes
      document.querySelectorAll('input[name="typeComponents"]').forEach(cb => cb.checked = false);
      
      showModal('typeModal');
    };

    window.editType = async function(typeId) {
      const type = state.types.find(t => t.id === typeId);
      if (!type) return;
      
      state.editingTypeId = typeId;
      document.getElementById('typeModalTitle').textContent = 'Edit Test Type';
      document.getElementById('typeName').value = type.name || '';
      document.getElementById('typeFormat').value = type.format || 'IELTS';
      
      // Set component checkboxes
      document.querySelectorAll('input[name="typeComponents"]').forEach(cb => {
        cb.checked = type.components && type.components.includes(cb.value);
      });
      
      document.getElementById('typeDuration').value = type.defaultDurationMin || '';
      document.getElementById('typeFee').value = type.defaultFeeVnd || '';
      document.getElementById('typeRegMsg').value = type.templates?.regMessage || '';
      document.getElementById('typeConfirmMsg').value = type.templates?.confirmMessage || '';
      
      showModal('typeModal');
    };

    window.saveType = async function() {
      const name = document.getElementById('typeName').value.trim();
      const format = document.getElementById('typeFormat').value;
      const duration = parseInt(document.getElementById('typeDuration').value) || 0;
      const fee = parseInt(document.getElementById('typeFee').value) || 0;
      const regMsg = document.getElementById('typeRegMsg').value.trim();
      const confirmMsg = document.getElementById('typeConfirmMsg').value.trim();

      // Get selected components
      const components = Array.from(document.querySelectorAll('input[name="typeComponents"]:checked'))
        .map(cb => cb.value);

      if (!name || !format || duration <= 0 || components.length === 0) {
        showToast('Please fill in all required fields and select at least one component', 'error');
        return;
      }

      const typeData = {
        name,
        format,
        components,
        defaultDurationMin: duration,
        defaultFeeVnd: fee,
        templates: {
          regMessage: regMsg,
          confirmMessage: confirmMsg
        }
      };

      try {
        if (state.editingTypeId) {
          await updateDoc(doc(db, 'mockTestTypes', state.editingTypeId), typeData);
          showToast('Test type updated successfully', 'success');
        } else {
          const newId = tsId('TYPE');
          await setDoc(doc(db, 'mockTestTypes', newId), typeData);
          showToast('Test type created successfully', 'success');
        }
        
        await loadTypes();
        hideModal('typeModal');
        renderCurrentTab();
      } catch (error) {
        console.error('Error saving type:', error);
        showToast('Error saving test type', 'error');
      }
    };

    window.deleteType = async function(typeId) {
      const eventsUsingType = state.events.filter(e => e.typeId === typeId);
      if (eventsUsingType.length > 0) {
        showToast(`Cannot delete: ${eventsUsingType.length} event(s) use this type`, 'error');
        return;
      }

      const confirmed = await showConfirm('Are you sure you want to delete this test type?');
      if (!confirmed) return;

      try {
        await deleteDoc(doc(db, 'mockTestTypes', typeId));
        await loadTypes();
        renderCurrentTab();
        showToast('Test type deleted successfully', 'success');
      } catch (error) {
        console.error('Error deleting type:', error);
        showToast('Error deleting test type', 'error');
      }
    };

    // Event CRUD
    window.showEventModal = function() {
      state.editingEventId = null;
      document.getElementById('eventForm').reset();
      document.getElementById('eventModalTitle').textContent = 'Create Test Event';
      populateTypeSelect();
      showModal('eventModal');
    };

    window.editEvent = async function(eventId) {
      const event = state.events.find(e => e.id === eventId);
      if (!event) return;
      
      state.editingEventId = eventId;
      document.getElementById('eventModalTitle').textContent = 'Edit Test Event';
      populateTypeSelect();
      
      document.getElementById('eventType').value = event.typeId || '';
      document.getElementById('eventTitle').value = event.title || '';
      document.getElementById('eventLocation').value = event.location || '';
      
      if (event.regOpenAt) {
        document.getElementById('eventRegOpen').value = formatDateTimeInput(event.regOpenAt.toDate());
      }
      if (event.regCloseAt) {
        document.getElementById('eventRegClose').value = formatDateTimeInput(event.regCloseAt.toDate());
      }
      
      document.getElementById('eventNotes').value = event.notes || '';
      showModal('eventModal');
    };

    window.saveEvent = async function() {
      const typeId = document.getElementById('eventType').value;
      const title = document.getElementById('eventTitle').value.trim();
      const location = document.getElementById('eventLocation').value.trim();
      const regOpenStr = document.getElementById('eventRegOpen').value;
      const regCloseStr = document.getElementById('eventRegClose').value;
      const notes = document.getElementById('eventNotes').value.trim();

      if (!typeId || !title || !location || !regOpenStr || !regCloseStr) {
        showToast('Please fill in all required fields', 'error');
        return;
      }

      const eventData = {
        typeId,
        title,
        location,
        regOpenAt: Timestamp.fromDate(new Date(regOpenStr)),
        regCloseAt: Timestamp.fromDate(new Date(regCloseStr)),
        notes,
        updatedAt: Timestamp.now()
      };

      try {
        if (state.editingEventId) {
          await updateDoc(doc(db, 'mockTestEvents', state.editingEventId), eventData);
          showToast('Event updated successfully', 'success');
        } else {
          const newId = tsId('EVT');
          await setDoc(doc(db, 'mockTestEvents', newId), {
            ...eventData,
            createdAt: Timestamp.now()
          });
          showToast('Event created successfully', 'success');
          
          // Auto-select the new event
          state.selectedEventId = newId;
        }
        
        hideModal('eventModal');
      } catch (error) {
        console.error('Error saving event:', error);
        showToast('Error saving event', 'error');
      }
    };

    window.deleteEvent = async function(eventId) {
      const slots = state.slotsByEvent[eventId] || [];
      if (slots.length > 0) {
        showToast(`Cannot delete: ${slots.length} slot(s) exist for this event`, 'error');
        return;
      }

      const confirmed = await showConfirm('Are you sure you want to delete this event?');
      if (!confirmed) return;

      try {
        await deleteDoc(doc(db, 'mockTestEvents', eventId));
        if (state.selectedEventId === eventId) {
          state.selectedEventId = null;
          document.getElementById('eventDetailsArea').innerHTML = '<div class="text-center py-12 text-gray-500">Select an event to view details</div>';
        }
        showToast('Event deleted successfully', 'success');
      } catch (error) {
        console.error('Error deleting event:', error);
        showToast('Error deleting event', 'error');
      }
    };

    // Batch Slot Modal
    let slotRows = [];

    window.showBatchSlotModal = function() {
      if (!state.selectedEventId) return;
      
      document.getElementById('batchSlotForm').reset();
      slotRows = [];
      addSlotRow(); // Add first row
      showModal('batchSlotModal');
    };

    function getSlotDefaults() {
      return {
        room: localStorage.getItem('lastSlotRoom') || 'Room 101',
        capacity: parseInt(localStorage.getItem('lastSlotCapacity')) || 30,
        status: localStorage.getItem('lastSlotStatus') || 'open'
      };
    }

    function saveSlotDefaults(room, capacity, status) {
      localStorage.setItem('lastSlotRoom', room);
      localStorage.setItem('lastSlotCapacity', capacity);
      localStorage.setItem('lastSlotStatus', status);
    }

    function addSlotRow() {
      const defaults = getSlotDefaults();
      const row = {
        id: Date.now() + Math.random(),
        startTime: '',
        endTime: '',
        room: defaults.room,
        capacity: defaults.capacity,
        status: defaults.status
      };
      slotRows.push(row);
      renderSlotRows();
    }

    window.addSlotRow = addSlotRow;

    function removeSlotRow(rowId) {
      slotRows = slotRows.filter(r => r.id !== rowId);
      renderSlotRows();
    }

    window.removeSlotRow = removeSlotRow;

    function renderSlotRows() {
      const container = document.getElementById('slotRowsContainer');
      container.innerHTML = '';

      slotRows.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.className = 'border-b border-gray-200 hover:bg-gray-50';
        
        const duration = calculateDuration(row.startTime, row.endTime);
        const durationDisplay = duration >= 0 ? `${duration} min` : '<span class="text-red-600">Invalid</span>';
        
        tr.innerHTML = `
          <td class="py-2 px-3">
            <input type="time" value="${row.startTime}" onchange="window.updateSlotRow(${row.id}, 'startTime', this.value)" required class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </td>
          <td class="py-2 px-3">
            <input type="time" value="${row.endTime}" onchange="window.updateSlotRow(${row.id}, 'endTime', this.value)" required class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </td>
          <td class="py-2 px-3 text-sm text-gray-700">${durationDisplay}</td>
          <td class="py-2 px-3">
            <input type="number" value="${row.capacity}" onchange="window.updateSlotRow(${row.id}, 'capacity', this.value)" required min="1" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </td>
          <td class="py-2 px-3">
            <input type="text" value="${row.room}" onchange="window.updateSlotRow(${row.id}, 'room', this.value)" required class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
          </td>
          <td class="py-2 px-3">
            <select onchange="window.updateSlotRow(${row.id}, 'status', this.value)" class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              <option value="open" ${row.status === 'open' ? 'selected' : ''}>Open</option>
              <option value="closed" ${row.status === 'closed' ? 'selected' : ''}>Closed</option>
            </select>
          </td>
          <td class="py-2 px-3 text-center">
            ${slotRows.length > 1 ? `<button type="button" onclick="window.removeSlotRow(${row.id})" class="text-red-600 hover:text-red-800 text-xs font-medium px-2 py-1 rounded hover:bg-red-50">Remove</button>` : '‚Äî'}
          </td>
        `;
        
        container.appendChild(tr);
      });
    }

    window.updateSlotRow = function(rowId, field, value) {
      const row = slotRows.find(r => r.id === rowId);
      if (row) {
        row[field] = value;
        
        // Save defaults to localStorage when user changes these fields
        if (field === 'capacity' || field === 'room' || field === 'status') {
          const currentDefaults = getSlotDefaults();
          if (field === 'capacity') currentDefaults.capacity = value;
          if (field === 'room') currentDefaults.room = value;
          if (field === 'status') currentDefaults.status = value;
          saveSlotDefaults(currentDefaults.room, currentDefaults.capacity, currentDefaults.status);
        }
        
        renderSlotRows();
      }
    };

    function calculateDuration(startTime, endTime) {
      if (!startTime || !endTime) return -1;
      
      const start = new Date(`2000-01-01T${startTime}`);
      const end = new Date(`2000-01-01T${endTime}`);
      
      if (end <= start) return -1;
      
      return Math.round((end - start) / 60000);
    }

    window.createBatchSlots = async function() {
      const dateStr = document.getElementById('batchSlotDate').value;
      
      if (!dateStr) {
        showToast('Please select a date', 'error');
        return;
      }

      // Validate all rows
      for (let row of slotRows) {
        if (!row.startTime || !row.endTime || !row.room || row.capacity <= 0) {
          showToast('Please fill in all fields for all slots', 'error');
          return;
        }
        
        const duration = calculateDuration(row.startTime, row.endTime);
        if (duration <= 0) {
          showToast('End time must be after start time for all slots', 'error');
          return;
        }
      }

      // Get existing slots for duplicate checking
      const existingSlots = state.slotsByEvent[state.selectedEventId] || [];

      try {
        let created = 0;
        let skipped = 0;

        // Create all slots
        for (let row of slotRows) {
          const startDT = new Date(`${dateStr}T${row.startTime}`);
          
          // Check for duplicate: same eventId, same startAt (minute), same room
          const isDuplicate = existingSlots.some(slot => {
            if (!slot.startAt) return false;
            const existingStart = slot.startAt.toDate();
            return existingStart.getTime() === startDT.getTime() && slot.room === row.room;
          });

          if (isDuplicate) {
            skipped++;
            continue;
          }

          const slotData = {
            eventId: state.selectedEventId,
            startAt: Timestamp.fromDate(startDT),
            capacity: parseInt(row.capacity),
            room: row.room,
            status: row.status
          };

          const newId = tsId('SLOT');
          await setDoc(doc(db, 'mockTestSlots', newId), slotData);
          created++;
        }

        if (skipped > 0) {
          showToast(`Created ${created} slot(s), skipped ${skipped} duplicate(s)`, 'success');
        } else {
          showToast(`${created} slot(s) created successfully`, 'success');
        }
        
        hideModal('batchSlotModal');
      } catch (error) {
        console.error('Error creating slots:', error);
        showToast('Error creating slots', 'error');
      }
    };

    // Edit single slot
    window.editSlot = async function(slotId) {
      const slot = (state.slotsByEvent[state.selectedEventId] || []).find(s => s.id === slotId);
      if (!slot) return;
      
      state.editingSlotId = slotId;
      document.getElementById('editSlotModalTitle').textContent = 'Edit Slot';
      
      if (slot.startAt) {
        document.getElementById('editSlotStart').value = formatDateTimeInput(slot.startAt.toDate());
      }
      
      document.getElementById('editSlotCapacity').value = slot.capacity || '';
      document.getElementById('editSlotRoom').value = slot.room || '';
      document.getElementById('editSlotStatus').value = slot.status || 'open';
      
      showModal('editSlotModal');
    };

    window.saveEditSlot = async function() {
      const startStr = document.getElementById('editSlotStart').value;
      const capacity = parseInt(document.getElementById('editSlotCapacity').value) || 0;
      const room = document.getElementById('editSlotRoom').value.trim();
      const status = document.getElementById('editSlotStatus').value;

      if (!startStr || capacity <= 0 || !room) {
        showToast('Please fill in all required fields', 'error');
        return;
      }

      const startAt = Timestamp.fromDate(new Date(startStr));

      try {
        await updateDoc(doc(db, 'mockTestSlots', state.editingSlotId), {
          startAt,
          capacity,
          room,
          status
        });
        
        showToast('Slot updated successfully', 'success');
        hideModal('editSlotModal');
      } catch (error) {
        console.error('Error updating slot:', error);
        showToast('Error updating slot', 'error');
      }
    };

    window.toggleSlotStatus = async function(slotId, currentStatus) {
      const newStatus = currentStatus === 'open' ? 'closed' : 'open';
      
      try {
        await updateDoc(doc(db, 'mockTestSlots', slotId), {
          status: newStatus,
          updatedAt: Timestamp.now()
        });
        showToast(`Slot status changed to ${newStatus}`, 'success');
      } catch (error) {
        console.error('Error toggling slot status:', error);
        showToast('Error updating slot status', 'error');
      }
    };

    window.deleteSlot = async function(slotId) {
      const regs = state.registrations.filter(r => r.slotId === slotId);
      if (regs.length > 0) {
        showToast(`Cannot delete: ${regs.length} registration(s) exist for this slot`, 'error');
        return;
      }

      const confirmed = await showConfirm('Are you sure you want to delete this slot?');
      if (!confirmed) return;

      try {
        await deleteDoc(doc(db, 'mockTestSlots', slotId));
        showToast('Slot deleted successfully', 'success');
      } catch (error) {
        console.error('Error deleting slot:', error);
        showToast('Error deleting slot', 'error');
      }
    };

    // Registration tools
    window.copyRegLink = function() {
      if (!window.currentRegLink) return;
      
      navigator.clipboard.writeText(window.currentRegLink).then(() => {
        showToast('Registration link copied to clipboard!', 'success');
      }).catch(() => {
        showToast('Failed to copy link', 'error');
      });
    };

    window.openRegPage = function() {
      if (!window.currentRegLink) return;
      window.open(window.currentRegLink, '_blank', 'noopener,noreferrer');
    };

    // Helper functions
    function populateTypeSelect() {
      const select = document.getElementById('eventType');
      select.innerHTML = '<option value="">Select a test type</option>';
      state.types.forEach(type => {
        const option = document.createElement('option');
        option.value = type.id;
        option.textContent = `${type.name} (${type.format})`;
        select.appendChild(option);
      });
    }

    function formatDate(date) {
      if (!date) return '';
      const day = pad2(date.getDate());
      const month = pad2(date.getMonth() + 1);
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function formatDateTime(date) {
      if (!date) return '';
      const day = pad2(date.getDate());
      const month = pad2(date.getMonth() + 1);
      const year = date.getFullYear();
      let hours = date.getHours();
      const minutes = pad2(date.getMinutes());
      const ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours ? hours : 12; // 0 should be 12
      return `${day}/${month}/${year}, ${hours}:${minutes} ${ampm}`;
    }

    function formatTime(date) {
      if (!date) return '';
      return date.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
      });
    }

    function formatDateTimeInput(date) {
      if (!date) return '';
      const Y = date.getFullYear();
      const M = pad2(date.getMonth() + 1);
      const D = pad2(date.getDate());
      const h = pad2(date.getHours());
      const m = pad2(date.getMinutes());
      return `${Y}-${M}-${D}T${h}:${m}`;
    }

    function formatVnd(amount) {
      return new Intl.NumberFormat('vi-VN').format(amount);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Modal functions
    function showModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
    }

    function hideModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    window.closeTypeModal = () => hideModal('typeModal');
    window.closeEventModal = () => hideModal('eventModal');
    window.closeBatchSlotModal = () => hideModal('batchSlotModal');
    window.closeEditSlotModal = () => hideModal('editSlotModal');

    // Prevent ESC key from closing modals
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        e.preventDefault();
        e.stopPropagation();
      }
    });

    // Toast notifications
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      
      toastMessage.textContent = message;
      toast.className = 'fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white transform transition-transform duration-300';
      
      if (type === 'success') {
        toast.classList.add('bg-green-600');
      } else if (type === 'error') {
        toast.classList.add('bg-red-600');
      } else {
        toast.classList.add('bg-blue-600');
      }
      
      toast.classList.remove('translate-y-20');
      
      setTimeout(() => {
        toast.classList.add('translate-y-20');
      }, 3000);
    }

    window.showToast = showToast;

    // Confirmation dialog
    async function showConfirm(message) {
      return new Promise((resolve) => {
        const dialog = document.getElementById('confirmDialog');
        const messageEl = document.getElementById('confirmMessage');
        const yesBtn = document.getElementById('confirmYes');
        const noBtn = document.getElementById('confirmNo');
        
        messageEl.textContent = message;
        dialog.classList.remove('hidden');
        
        const handleYes = () => {
          dialog.classList.add('hidden');
          yesBtn.removeEventListener('click', handleYes);
          noBtn.removeEventListener('click', handleNo);
          resolve(true);
        };
        
        const handleNo = () => {
          dialog.classList.add('hidden');
          yesBtn.removeEventListener('click', handleYes);
          noBtn.removeEventListener('click', handleNo);
          resolve(false);
        };
        
        yesBtn.addEventListener('click', handleYes);
        noBtn.addEventListener('click', handleNo);
      });
    }

    window.showConfirm = showConfirm;
  </script>
  <style>
    body {
      box-sizing: border-box;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gradient-to-br from-slate-50 to-blue-50 h-full">
  <div class="w-full h-full flex flex-col"><!-- Header -->
   <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-6 py-4">
     <h1 class="text-3xl font-bold text-gray-800">üìÖ Mock Test Schedules</h1>
    </div>
   </header><!-- Tabs -->
   <div class="max-w-7xl mx-auto px-6 w-full">
    <div class="border-b border-gray-200">
     <nav class="flex space-x-8"><button id="tabTypes" class="py-3 px-1 border-b-2 border-blue-600 text-blue-600 font-semibold text-sm"> Test Types </button> <button id="tabSchedules" class="py-3 px-1 text-gray-600 hover:text-gray-800 font-semibold text-sm"> Test Schedules </button>
     </nav>
    </div>
   </div><!-- Content -->
   <main class="flex-1 overflow-hidden">
    <div class="max-w-7xl mx-auto px-6 py-6 h-full"><!-- Test Types View -->
     <div id="viewTypes">
      <div class="mb-4 flex justify-between items-center">
       <h2 class="text-xl font-bold text-gray-800">Test Types</h2><button onclick="window.showTypeModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors shadow-sm"> + New Type </button>
      </div>
      <div id="typesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 overflow-y-auto" style="max-height: calc(100vh - 220px);"></div>
     </div><!-- Test Schedules View -->
     <div id="viewSchedules" class="hidden h-full">
      <div class="flex gap-3 h-full"><!-- Left Panel: Events List (Narrow) -->
       <div class="w-80 flex-shrink-0 flex flex-col bg-white border border-gray-200 rounded-lg shadow-sm" style="max-height: calc(100vh - 180px);">
        <div class="p-3 border-b border-gray-200 space-y-2"><button onclick="window.showEventModal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded text-sm font-medium transition-colors"> + New Event </button> <input type="text" id="searchEvents" placeholder="Search events..." class="w-full px-2 py-1.5 border border-gray-300 rounded text-xs focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div id="eventsList" class="flex-1 overflow-y-auto"></div>
       </div><!-- Right Panel: Workspace -->
       <div class="flex-1 overflow-y-auto" style="max-height: calc(100vh - 180px);">
        <div id="eventDetailsArea" class="text-center py-12 text-gray-500">
         Select an event to view details
        </div>
       </div>
      </div>
     </div>
    </div>
   </main><!-- Type Modal -->
   <div id="typeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="event.stopPropagation()">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
     <div class="p-6">
      <div class="flex justify-between items-center mb-4">
       <h2 id="typeModalTitle" class="text-2xl font-bold text-gray-800">Create Test Type</h2><button onclick="window.closeTypeModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">√ó</button>
      </div>
      <form id="typeForm" class="space-y-4" onsubmit="event.preventDefault(); window.saveType();">
       <div><label class="block text-sm font-semibold text-gray-700 mb-1">Test Name *</label> <input type="text" id="typeName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-1">Format *</label> <select id="typeFormat" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="IELTS">IELTS</option> <option value="TOEIC">TOEIC</option> <option value="TOEFL">TOEFL</option> <option value="Custom">Custom</option> </select>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Components * (select at least one)</label>
        <div class="grid grid-cols-2 gap-2"><label class="flex items-center space-x-2 p-2 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="typeComponents" value="Listening" class="rounded text-blue-600 focus:ring-blue-500"> <span class="text-sm">Listening</span> </label> <label class="flex items-center space-x-2 p-2 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="typeComponents" value="Reading" class="rounded text-blue-600 focus:ring-blue-500"> <span class="text-sm">Reading</span> </label> <label class="flex items-center space-x-2 p-2 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="typeComponents" value="Writing" class="rounded text-blue-600 focus:ring-blue-500"> <span class="text-sm">Writing</span> </label> <label class="flex items-center space-x-2 p-2 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer"> <input type="checkbox" name="typeComponents" value="Speaking" class="rounded text-blue-600 focus:ring-blue-500"> <span class="text-sm">Speaking</span> </label>
        </div>
       </div>
       <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-sm font-semibold text-gray-700 mb-1">Duration (minutes) *</label> <input type="number" id="typeDuration" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-1">Fee (VND)</label> <input type="number" id="typeFee" min="0" value="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-1">Registration Message Template</label> <textarea id="typeRegMsg" rows="3" placeholder="Use {EVENT_TITLE}, {REG_LINK}, {REG_ID}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"></textarea>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-1">Confirmation Message Template</label> <textarea id="typeConfirmMsg" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"></textarea>
       </div>
       <div class="flex gap-3 pt-4"><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"> Save Type </button> <button type="button" onclick="window.closeTypeModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold transition-colors"> Cancel </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Event Modal -->
   <div id="eventModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="event.stopPropagation()">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
     <div class="p-6">
      <div class="flex justify-between items-center mb-4">
       <h2 id="eventModalTitle" class="text-2xl font-bold text-gray-800">Create Test Event</h2><button onclick="window.closeEventModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">√ó</button>
      </div>
      <form id="eventForm" class="space-y-4" onsubmit="event.preventDefault(); window.saveEvent();">
       <div><label class="block text-sm font-semibold text-gray-700 mb-1">Test Type *</label> <select id="eventType" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Select a test type</option> </select>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-1">Event Title *</label> <input type="text" id="eventTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-1">Location *</label> <input type="text" id="eventLocation" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
       </div>
       <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-sm font-semibold text-gray-700 mb-1">Registration Opens *</label> <input type="datetime-local" id="eventRegOpen" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-1">Registration Closes *</label> <input type="datetime-local" id="eventRegClose" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-1">Notes</label> <textarea id="eventNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"></textarea>
       </div>
       <div class="flex gap-3 pt-4"><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"> Save Event </button> <button type="button" onclick="window.closeEventModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold transition-colors"> Cancel </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Batch Add Slots Modal -->
   <div id="batchSlotModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="event.stopPropagation()">
    <div class="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
     <div class="p-6">
      <div class="flex justify-between items-center mb-4">
       <h2 class="text-2xl font-bold text-gray-800">Add Slots</h2><button onclick="window.closeBatchSlotModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">√ó</button>
      </div>
      <form id="batchSlotForm" class="space-y-4" onsubmit="event.preventDefault(); window.createBatchSlots();">
       <div><label class="block text-sm font-semibold text-gray-700 mb-1">Select Date *</label> <input type="date" id="batchSlotDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-2">Slots</label>
        <div class="overflow-x-auto">
         <table class="w-full text-sm border border-gray-200">
          <thead class="bg-gray-50">
           <tr>
            <th class="text-left py-2 px-3 font-semibold text-gray-700">Start Time</th>
            <th class="text-left py-2 px-3 font-semibold text-gray-700">End Time</th>
            <th class="text-left py-2 px-3 font-semibold text-gray-700">Duration</th>
            <th class="text-left py-2 px-3 font-semibold text-gray-700">Capacity</th>
            <th class="text-left py-2 px-3 font-semibold text-gray-700">Room</th>
            <th class="text-left py-2 px-3 font-semibold text-gray-700">Status</th>
            <th class="text-center py-2 px-3 font-semibold text-gray-700">Remove</th>
           </tr>
          </thead>
          <tbody id="slotRowsContainer"></tbody>
         </table>
        </div>
       </div><button type="button" onclick="window.addSlotRow()" class="w-full bg-green-100 hover:bg-green-200 text-green-700 px-4 py-2 rounded-lg font-semibold transition-colors border border-green-300"> + Add Another Slot </button>
       <div class="flex gap-3 pt-4 border-t border-gray-200"><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"> Create Slots </button> <button type="button" onclick="window.closeBatchSlotModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold transition-colors"> Cancel </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Edit Single Slot Modal -->
   <div id="editSlotModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="event.stopPropagation()">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full" onclick="event.stopPropagation()">
     <div class="p-6">
      <div class="flex justify-between items-center mb-4">
       <h2 id="editSlotModalTitle" class="text-2xl font-bold text-gray-800">Edit Slot</h2><button onclick="window.closeEditSlotModal()" class="text-gray-400 hover:text-gray-600 text-2xl font-bold">√ó</button>
      </div>
      <form class="space-y-4" onsubmit="event.preventDefault(); window.saveEditSlot();">
       <div><label class="block text-sm font-semibold text-gray-700 mb-1">Start Time *</label> <input type="datetime-local" id="editSlotStart" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
       </div>
       <div class="grid grid-cols-2 gap-4">
        <div><label class="block text-sm font-semibold text-gray-700 mb-1">Capacity *</label> <input type="number" id="editSlotCapacity" required min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div><label class="block text-sm font-semibold text-gray-700 mb-1">Room *</label> <input type="text" id="editSlotRoom" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
       </div>
       <div><label class="block text-sm font-semibold text-gray-700 mb-1">Status *</label> <select id="editSlotStatus" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="open">Open</option> <option value="closed">Closed</option> </select>
       </div>
       <div class="flex gap-3 pt-4"><button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"> Save </button> <button type="button" onclick="window.closeEditSlotModal()" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold transition-colors"> Cancel </button>
       </div>
      </form>
     </div>
    </div>
   </div><!-- Confirmation Dialog -->
   <div id="confirmDialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
     <p id="confirmMessage" class="text-gray-800 mb-6 text-lg"></p>
     <div class="flex gap-3"><button id="confirmYes" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition-colors"> Yes, Delete </button> <button id="confirmNo" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg font-semibold transition-colors"> Cancel </button>
     </div>
    </div>
   </div><!-- Toast Notification -->
   <div id="toast" class="fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg text-white transform translate-y-20 transition-transform duration-300 z-50">
    <p id="toastMessage"></p>
   </div>
  </div>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c48571281d604f6',t:'MTc2OTUxNzg1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>