<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admission Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDdx6QyXzCWz7BRZInLu16LGnYBKvFO1CM",
            authDomain: "tnl-management-app.firebaseapp.com",
            projectId: "tnl-management-app",
            storageBucket: "tnl-management-app.firebasestorage.app",
            messagingSenderId: "710843379828",
            appId: "1:710843379828:web:76978490616ebe41bf2121",
            measurementId: "G-8W29VX7WTP"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // Firebase connection status
        let isOnline = true;
        let syncStatus = 'connected';

        // Monitor connection status
        db.enableNetwork().then(() => {
            isOnline = true;
            syncStatus = 'connected';
            updateSyncIndicator();
        }).catch(() => {
            isOnline = false;
            syncStatus = 'offline';
            updateSyncIndicator();
        });

        // Listen for connection changes
        window.addEventListener('online', () => {
            isOnline = true;
            syncStatus = 'connected';
            updateSyncIndicator();
            syncPendingChanges();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            syncStatus = 'offline';
            updateSyncIndicator();
        });
    </script>

    <!-- Styling -->
    <style>
        .timeline-step {
            position: relative;
            padding: 0.5rem 0.75rem;
            border-left: 2px solid #e5e7eb;
            font-size: 0.75rem;
            line-height: 1.2;
        }
        .timeline-step.active {
            border-left-color: #3b82f6;
            background-color: #f8fafc;
        }
        .timeline-step.completed {
            border-left-color: #10b981;
            background-color: #f8fafc;
        }
        
        .card-hover {
            transition: all 0.2s ease;
        }
        .card-hover:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        
        .btn-sm {
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            line-height: 1.2;
            border-radius: 0.375rem;
        }
        
        .btn-xs {
            padding: 0.125rem 0.5rem;
            font-size: 0.7rem;
            line-height: 1.1;
            border-radius: 0.25rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.125rem 0.5rem;
            font-size: 0.7rem;
            font-weight: 500;
            border-radius: 0.25rem;
            line-height: 1.2;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.25rem 0.75rem;
            font-size: 0.75rem;
            line-height: 1.3;
        }
        
        .info-label {
            color: #6b7280;
            font-weight: 500;
        }
        
        .info-value {
            color: #374151;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .timeline-step {
                padding: 0.375rem 0.5rem;
                font-size: 0.7rem;
            }
            .mobile-scroll {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            .mobile-table {
                min-width: 700px;
            }
        }

        /* Sync indicator animations */
        .sync-indicator {
            transition: all 0.3s ease;
        }
        .sync-pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Clean form styling */
        .form-input {
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            transition: border-color 0.15s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-3 rounded-lg mr-4">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-semibold text-gray-900 mb-1 flex items-center">
                            📚 Admission Management System
                        </h1>
                        <p class="text-gray-600 text-sm">Manage prospective students through the admission process</p>
                    </div>
                </div>
                
                <!-- Sync Status -->
                <div id="syncIndicator" class="flex items-center px-3 py-2 rounded-lg text-xs border">
                    <div id="syncIcon" class="w-2 h-2 rounded-full mr-2"></div>
                    <span id="syncText">Connected</span>
                </div>
            </div>
            
            <!-- Phase Toggle -->
            <div class="flex bg-gray-100 rounded-lg p-1">
                <button id="processingTab" class="flex-1 py-3 px-4 rounded-md text-sm font-medium bg-white text-gray-900 shadow-sm flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    Processing
                </button>
                <button id="completedTab" class="flex-1 py-3 px-4 rounded-md text-sm font-medium text-gray-600 hover:text-gray-900 flex items-center justify-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Completed
                </button>
            </div>
        </div>

        <!-- Processing Phase -->
        <div id="processingPhase" class="space-y-6">
            <!-- Processing Candidates Section -->
            <div id="processingSection" class="max-w-7xl mx-auto">
                <div class="bg-white rounded-b-xl shadow-lg">
                    <!-- Controls -->
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex flex-col lg:flex-row gap-4 items-start lg:items-center justify-between">
                            <button onclick="showAddCandidateForm()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex items-center space-x-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                <span>Add New Candidate</span>
                            </button>
                            
                            <div class="flex flex-col sm:flex-row gap-4 w-full lg:w-auto">
                                <input type="text" id="searchInput" placeholder="Search candidates..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-64">
                                <select id="sortByName" onchange="sortCandidates()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Sort by Name</option>
                                    <option value="asc">Name A-Z</option>
                                    <option value="desc">Name Z-A</option>
                                </select>
                                <select id="sortByStatus" onchange="sortCandidates()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                    <option value="">Sort by Status</option>
                                    <option value="create">Create Test</option>
                                    <option value="complete">Complete Test</option>
                                    <option value="grade">Grade Test</option>
                                    <option value="inform">Inform Result</option>
                                    <option value="decide">Make Decision</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Candidates Table -->
                    <div class="overflow-x-auto">
                        <table class="w-full table-fixed">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="w-[15%] px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Candidate Info</th>
                                    <th class="w-[20%] px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test Status</th>
                                    <th class="w-[20%] px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test Results</th>
                                    <th class="w-[25%] px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Recommendation</th>
                                    <th class="w-[20%] px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="candidatesTableBody" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                                        <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                        <p class="text-lg font-medium">No candidates in processing</p>
                                        <p class="text-sm">Click "Add New Candidate" to get started</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Completed Phase -->
        <div id="completedPhase" class="hidden space-y-6">
            <!-- Completed Sub-Navigation -->
            <div class="bg-white rounded-lg shadow-sm border p-6">
                <div class="text-center mb-4">
                    <p class="text-sm text-gray-600">Click on each tab to view candidates</p>
                </div>
                <div class="flex justify-center gap-4">
                    <button id="acceptedTabBtn" class="px-6 py-3 rounded-lg text-sm font-medium bg-green-100 text-green-800 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        ✅ Accepted
                        <span id="acceptedCount" class="ml-2 px-2 py-0.5 bg-green-200 text-green-800 rounded-full text-xs">0</span>
                    </button>
                    <button id="rejectedTabBtn" class="px-6 py-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-red-100 hover:text-red-800 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                        ❌ Rejected
                        <span id="rejectedCount" class="ml-2 px-2 py-0.5 bg-gray-200 text-gray-600 rounded-full text-xs">0</span>
                    </button>
                    <button id="onHoldTabBtn" class="px-6 py-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-yellow-100 hover:text-yellow-800 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        ⏳ On Hold
                        <span id="onHoldCount" class="ml-2 px-2 py-0.5 bg-gray-200 text-gray-600 rounded-full text-xs">0</span>
                    </button>
                </div>
            </div>

            <!-- Accepted Tab -->
            <div id="acceptedTab" class="space-y-4">
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="flex-1 relative">
                            <svg class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input type="text" id="acceptedSearchInput" placeholder="🔍 Search accepted candidates..." 
                                   class="form-input w-full pl-10">
                        </div>
                        <div class="relative">
                            <svg class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h9m5-4v12m0 0l-4-4m4 4l4-4"></path>
                            </svg>
                            <select id="acceptedSortSelect" class="form-input pl-10">
                                <option value="name">📝 Sort by Name</option>
                                <option value="date">📅 Sort by Decision Date</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b border-green-100 bg-green-50">
                        <h3 class="text-lg font-medium text-green-800 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            ✅ Accepted Candidates
                        </h3>
                    </div>
                    <div id="acceptedCandidates" class="p-4 space-y-3 max-h-[60vh] overflow-y-auto">
                        <!-- Content will be populated -->
                    </div>
                </div>
            </div>

            <!-- Rejected Tab -->
            <div id="rejectedTab" class="hidden space-y-4">
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="flex-1 relative">
                            <svg class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input type="text" id="rejectedSearchInput" placeholder="🔍 Search rejected candidates..." 
                                   class="form-input w-full pl-10">
                        </div>
                        <div class="relative">
                            <svg class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h9m5-4v12m0 0l-4-4m4 4l4-4"></path>
                            </svg>
                            <select id="rejectedSortSelect" class="form-input pl-10">
                                <option value="name">📝 Sort by Name</option>
                                <option value="date">📅 Sort by Decision Date</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b border-red-100 bg-red-50">
                        <h3 class="text-lg font-medium text-red-800 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                            ❌ Rejected Candidates
                        </h3>
                    </div>
                    <div id="rejectedCandidates" class="p-4 space-y-3 max-h-[60vh] overflow-y-auto">
                        <!-- Content will be populated -->
                    </div>
                </div>
            </div>

            <!-- On Hold Tab -->
            <div id="onHoldTab" class="hidden space-y-4">
                <div class="bg-white rounded-lg shadow-sm border p-4">
                    <div class="flex flex-col sm:flex-row gap-3">
                        <div class="flex-1 relative">
                            <svg class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <input type="text" id="onHoldSearchInput" placeholder="🔍 Search on-hold candidates..." 
                                   class="form-input w-full pl-10">
                        </div>
                        <div class="relative">
                            <svg class="w-4 h-4 absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h9m5-4v12m0 0l-4-4m4 4l4-4"></path>
                            </svg>
                            <select id="onHoldSortSelect" class="form-input pl-10">
                                <option value="name">📝 Sort by Name</option>
                                <option value="date">📅 Sort by Decision Date</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-lg shadow-sm border">
                    <div class="px-6 py-4 border-b border-yellow-100 bg-yellow-50">
                        <h3 class="text-lg font-medium text-yellow-800 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            ⏳ On Hold Candidates
                        </h3>
                    </div>
                    <div id="onHoldCandidates" class="p-4 space-y-3 max-h-[60vh] overflow-y-auto">
                        <!-- Content will be populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Add Candidate Modal -->
    <div id="addCandidateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">👤 Add New Candidate</h3>
                <button onclick="closeAddCandidateModal()" class="text-gray-400 hover:text-gray-600">×</button>
            </div>
            <form id="candidateForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="fullName" required class="form-input w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                    <input type="date" id="dateOfBirth" required class="form-input w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">School</label>
                    <input type="text" id="school" class="form-input w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Learning Needs</label>
                    <input type="text" id="learningNeeds" class="form-input w-full">
                </div>
                <div class="md:col-span-2 flex gap-2 pt-2">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white btn-sm font-medium">
                        Save Candidate
                    </button>
                    <button type="button" onclick="closeAddCandidateModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 btn-sm">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Candidate Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-medium mb-4">Edit Candidate</h3>
            <form id="editForm" class="space-y-4">
                <input type="hidden" id="editId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="editFullName" class="form-input w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                    <input type="date" id="editDateOfBirth" class="form-input w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">School</label>
                    <input type="text" id="editSchool" class="form-input w-full">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Learning Needs</label>
                    <textarea id="editLearningNeeds" rows="2" class="form-input w-full"></textarea>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white btn-sm">Save</button>
                    <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 btn-sm">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Test Results Modal -->
    <div id="resultsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
            <h3 class="text-lg font-medium mb-4">Test Results</h3>
            <form id="resultsForm" class="space-y-4">
                <input type="hidden" id="resultsId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Test Results</label>
                    <textarea id="testResults" rows="3" placeholder="Enter test scores and performance details..." class="form-input w-full"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Grading</label>
                    <textarea id="grading" rows="2" placeholder="Enter grading details..." class="form-input w-full"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Recommendations</label>
                    <textarea id="recommendations" rows="3" placeholder="Enter recommendations..." class="form-input w-full"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Attach Files</label>
                    <input type="file" id="attachments" multiple class="form-input w-full">
                    <div id="attachmentsList" class="mt-2"></div>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white btn-sm">Save Results</button>
                    <button type="button" onclick="closeResultsModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 btn-sm">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Decision Modal -->
    <div id="decisionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-medium mb-4">Make Decision</h3>
            <form id="decisionForm" class="space-y-4">
                <input type="hidden" id="decisionId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Decision</label>
                    <select id="decision" class="form-input w-full">
                        <option value="">Select Decision</option>
                        <option value="accepted">Accept</option>
                        <option value="rejected">Reject</option>
                        <option value="onhold">Put on Hold</option>
                    </select>
                </div>
                <div id="reasonSection" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Reason</label>
                    <textarea id="decisionReason" rows="3" placeholder="Enter reason..." class="form-input w-full"></textarea>
                </div>
                <div class="flex gap-2 pt-2">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white btn-sm">Save Decision</button>
                    <button type="button" onclick="closeDecisionModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 btn-sm">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Timeline Modal -->
    <div id="timelineModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Timeline</h3>
                <button onclick="closeTimelineModal()" class="text-gray-400 hover:text-gray-600">×</button>
            </div>
            <div id="timelineContent">
                <!-- Content will be populated -->
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Candidate Details</h3>
                <button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-600">×</button>
            </div>
            <div id="detailContent">
                <!-- Content will be populated -->
            </div>
        </div>
    </div>

    <script>
        // Application State
        let candidates = [];
        let completedCandidates = [];
        let currentPhase = 'processing';
        let candidateCounter = 0;

        // Test Status Steps
        const testSteps = [
            { id: 'added', name: 'Added to System' },
            { id: 'create', name: 'Test Created' },
            { id: 'complete', name: 'Test Completed' },
            { id: 'grade', name: 'Test Graded' },
            { id: 'inform', name: 'Results Informed' },
            { id: 'decide', name: 'Decision Made' }
        ];

        // Firebase Helper Functions
        async function getNextCandidateId() {
            try {
                setSyncStatus('syncing');
                const counterDoc = await db.collection('counters').doc('candidates').get();
                let nextNumber = 1;
                
                if (counterDoc.exists) {
                    nextNumber = counterDoc.data().count + 1;
                }
                
                await db.collection('counters').doc('candidates').set({ count: nextNumber });
                setSyncStatus('connected');
                return `candidate_${nextNumber.toString().padStart(4, '0')}`;
            } catch (error) {
                console.error('Error getting next candidate ID:', error);
                setSyncStatus('error');
                return `candidate_${Date.now()}`;
            }
        }

        async function saveCandidateToFirebase(candidateData) {
            try {
                setSyncStatus('syncing');
                const candidateId = await getNextCandidateId();
                await db.collection('Candidates').doc(candidateId).set(candidateData);
                setSyncStatus('connected');
                return candidateId;
            } catch (error) {
                console.error('Error saving candidate:', error);
                setSyncStatus('error');
                throw error;
            }
        }

        async function updateCandidateInFirebase(candidateId, updateData) {
            try {
                setSyncStatus('syncing');
                await db.collection('Candidates').doc(candidateId).update(updateData);
                setSyncStatus('connected');
            } catch (error) {
                console.error('Error updating candidate:', error);
                setSyncStatus('error');
                throw error;
            }
        }

        async function deleteCandidateFromFirebase(candidateId) {
            try {
                setSyncStatus('syncing');
                await db.collection('Candidates').doc(candidateId).delete();
                setSyncStatus('connected');
            } catch (error) {
                console.error('Error deleting candidate:', error);
                setSyncStatus('error');
                throw error;
            }
        }

        async function loadCandidatesFromFirebase() {
            try {
                setSyncStatus('syncing');
                const snapshot = await db.collection('Candidates')
                    .where('status', '!=', 'completed')
                    .orderBy('status')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                candidates = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));
                setSyncStatus('connected');
            } catch (error) {
                console.error('Error loading candidates:', error);
                setSyncStatus('error');
                candidates = [];
            }
        }

        async function loadCompletedCandidatesFromFirebase() {
            try {
                setSyncStatus('syncing');
                const snapshot = await db.collection('Candidates')
                    .where('status', '==', 'completed')
                    .orderBy('decisionDate', 'desc')
                    .get();
                
                completedCandidates = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));
                setSyncStatus('connected');
            } catch (error) {
                console.error('Error loading completed candidates:', error);
                setSyncStatus('error');
                completedCandidates = [];
            }
        }

        // Sync Status Management
        function setSyncStatus(status) {
            syncStatus = status;
            updateSyncIndicator();
        }

        function updateSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            const icon = document.getElementById('syncIcon');
            const text = document.getElementById('syncText');

            indicator.className = 'flex items-center px-2 py-1 rounded-md text-xs sync-indicator';
            icon.className = 'w-2 h-2 rounded-full mr-1.5';

            switch (syncStatus) {
                case 'connected':
                    indicator.classList.add('bg-green-50', 'text-green-700');
                    icon.classList.add('bg-green-500');
                    text.textContent = 'Connected';
                    break;
                case 'syncing':
                    indicator.classList.add('bg-blue-50', 'text-blue-700');
                    icon.classList.add('bg-blue-500', 'sync-pulse');
                    text.textContent = 'Syncing...';
                    break;
                case 'offline':
                    indicator.classList.add('bg-gray-50', 'text-gray-700');
                    icon.classList.add('bg-gray-500');
                    text.textContent = 'Offline';
                    break;
                case 'error':
                    indicator.classList.add('bg-red-50', 'text-red-700');
                    icon.classList.add('bg-red-500');
                    text.textContent = 'Error';
                    break;
            }
        }

        async function syncPendingChanges() {
            await loadCandidatesFromFirebase();
            await loadCompletedCandidatesFromFirebase();
            renderCandidates();
            renderCompletedCandidates();
        }

        // Vietnamese text normalization for search
        function normalizeVietnamese(str) {
            return str.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/đ/g, 'd')
                .replace(/Đ/g, 'D');
        }

        // Initialize the application
        async function init() {
            setSyncStatus('syncing');
            try {
                await loadCandidatesFromFirebase();
                await loadCompletedCandidatesFromFirebase();
                setupEventListeners();
                renderCandidates();
                renderCompletedCandidates();
                setSyncStatus('connected');
                setupRealtimeListeners();
            } catch (error) {
                console.error('Error initializing app:', error);
                setSyncStatus('error');
                setupEventListeners();
                renderCandidates();
                renderCompletedCandidates();
            }
        }

        // Setup real-time listeners for Firebase
        function setupRealtimeListeners() {
            db.collection('Candidates')
                .onSnapshot((snapshot) => {
                    const allCandidates = snapshot.docs.map(doc => ({ 
                        id: doc.id, 
                        ...doc.data() 
                    }));
                    
                    // Separate processing and completed candidates
                    candidates = allCandidates.filter(c => c.status !== 'completed');
                    completedCandidates = allCandidates.filter(c => c.status === 'completed');
                    
                    renderCandidates();
                    renderCompletedCandidates();
                }, (error) => {
                    console.error('Error listening to candidates:', error);
                });
        }

        // Sorting function
        function sortCandidates(candidateList = null) {
            const sortByName = document.getElementById('sortByName').value;
            const sortByStatus = document.getElementById('sortByStatus').value;
            
            let toSort = candidateList || candidates;
            
            if (sortByName) {
                toSort.sort((a, b) => {
                    if (sortByName === 'asc') {
                        return a.fullName.localeCompare(b.fullName);
                    } else {
                        return b.fullName.localeCompare(a.fullName);
                    }
                });
            }
            
            if (sortByStatus) {
                toSort = toSort.filter(candidate => candidate.status === sortByStatus);
            }
            
            if (!candidateList) {
                renderCandidates();
            }
            
            return toSort;
        }

        // Show add candidate form modal
        function showAddCandidateForm() {
            document.getElementById('addCandidateModal').classList.remove('hidden');
            document.getElementById('addCandidateModal').classList.add('flex');
        }

        // Close add candidate modal
        function closeAddCandidateModal() {
            document.getElementById('addCandidateModal').classList.add('hidden');
            document.getElementById('addCandidateModal').classList.remove('flex');
            document.getElementById('candidateForm').reset();
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('processingTab').addEventListener('click', () => switchPhase('processing'));
            document.getElementById('completedTab').addEventListener('click', () => switchPhase('completed'));

            // Completed sub-tabs
            document.getElementById('acceptedTabBtn').addEventListener('click', () => switchCompletedTab('accepted'));
            document.getElementById('rejectedTabBtn').addEventListener('click', () => switchCompletedTab('rejected'));
            document.getElementById('onHoldTabBtn').addEventListener('click', () => switchCompletedTab('onHold'));

            document.getElementById('candidateForm').addEventListener('submit', handleAddCandidate);
            document.getElementById('editForm').addEventListener('submit', handleEditCandidate);
            document.getElementById('resultsForm').addEventListener('submit', handleSaveResults);
            document.getElementById('decisionForm').addEventListener('submit', handleMakeDecision);

            document.getElementById('searchInput').addEventListener('input', renderCandidates);
            
            // Individual search inputs for each completed tab
            document.getElementById('acceptedSearchInput').addEventListener('input', () => renderCompletedCandidates('accepted'));
            document.getElementById('acceptedSortSelect').addEventListener('change', () => renderCompletedCandidates('accepted'));
            document.getElementById('rejectedSearchInput').addEventListener('input', () => renderCompletedCandidates('rejected'));
            document.getElementById('rejectedSortSelect').addEventListener('change', () => renderCompletedCandidates('rejected'));
            document.getElementById('onHoldSearchInput').addEventListener('input', () => renderCompletedCandidates('onhold'));
            document.getElementById('onHoldSortSelect').addEventListener('change', () => renderCompletedCandidates('onhold'));

            document.getElementById('decision').addEventListener('change', function() {
                const reasonSection = document.getElementById('reasonSection');
                if (this.value === 'rejected' || this.value === 'onhold') {
                    reasonSection.classList.remove('hidden');
                } else {
                    reasonSection.classList.add('hidden');
                }
            });

            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('fixed')) {
                    const modals = ['addCandidateModal', 'editModal', 'resultsModal', 'decisionModal', 'detailModal', 'timelineModal'];
                    modals.forEach(modalId => {
                        const modal = document.getElementById(modalId);
                        if (!modal.classList.contains('hidden')) {
                            modal.classList.add('hidden');
                            modal.classList.remove('flex');
                        }
                    });
                }
            });
        }

        // Switch between phases
        function switchPhase(phase) {
            currentPhase = phase;
            const processingPhase = document.getElementById('processingPhase');
            const completedPhase = document.getElementById('completedPhase');
            const processingTab = document.getElementById('processingTab');
            const completedTab = document.getElementById('completedTab');

            if (phase === 'processing') {
                processingPhase.classList.remove('hidden');
                completedPhase.classList.add('hidden');
                processingTab.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                processingTab.classList.remove('text-gray-600');
                completedTab.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
                completedTab.classList.add('text-gray-600');
            } else {
                processingPhase.classList.add('hidden');
                completedPhase.classList.remove('hidden');
                completedTab.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
                completedTab.classList.remove('text-gray-600');
                processingTab.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
                processingTab.classList.add('text-gray-600');
                
                // Default to accepted tab when switching to completed
                switchCompletedTab('accepted');
            }
        }

        // Switch between completed sub-tabs
        function switchCompletedTab(tabType) {
            const tabs = ['accepted', 'rejected', 'onHold'];
            
            // Hide all tabs
            tabs.forEach(tab => {
                const tabElement = document.getElementById(`${tab}Tab`);
                const btnElement = document.getElementById(`${tab}TabBtn`);
                
                if (tabElement) tabElement.classList.add('hidden');
                
                if (btnElement) {
                    btnElement.classList.remove('bg-green-100', 'text-green-800', 'bg-red-100', 'text-red-800', 'bg-yellow-100', 'text-yellow-800');
                    btnElement.classList.add('bg-gray-100', 'text-gray-600');
                }
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`${tabType}Tab`);
            const selectedBtn = document.getElementById(`${tabType}TabBtn`);
            
            if (selectedTab) selectedTab.classList.remove('hidden');
            
            if (selectedBtn) {
                selectedBtn.classList.remove('bg-gray-100', 'text-gray-600');
                if (tabType === 'accepted') {
                    selectedBtn.classList.add('bg-green-100', 'text-green-800');
                } else if (tabType === 'rejected') {
                    selectedBtn.classList.add('bg-red-100', 'text-red-800');
                } else if (tabType === 'onHold') {
                    selectedBtn.classList.add('bg-yellow-100', 'text-yellow-800');
                }
            }
            
            // Render the specific tab content
            renderCompletedCandidates(tabType);
        }

        // Add new candidate
        async function handleAddCandidate(e) {
            e.preventDefault();
            
            const candidateData = {
                fullName: document.getElementById('fullName').value,
                dateOfBirth: document.getElementById('dateOfBirth').value,
                school: document.getElementById('school').value || '',
                learningNeeds: document.getElementById('learningNeeds').value || '',
                status: 'added',
                statusHistory: [{
                    step: 'added',
                    date: new Date().toISOString(),
                    completed: true
                }],
                testResults: '',
                grading: '',
                recommendations: '',
                attachments: [],
                createdAt: new Date().toISOString()
            };

            try {
                const candidateId = await saveCandidateToFirebase(candidateData);
                // Don't manually add to candidates array - real-time listener will handle it
                closeAddCandidateModal();
                showNotification('Candidate added successfully', 'success');
            } catch (error) {
                showNotification('Error adding candidate', 'error');
            }
        }

        // Render candidates table
        function renderCandidates() {
            const tbody = document.getElementById('candidatesTableBody');
            const searchTerm = document.getElementById('searchInput').value;
            
            let filteredCandidates = candidates.filter(candidate => {
                if (!searchTerm) return true;
                const normalizedSearch = normalizeVietnamese(searchTerm);
                const normalizedName = normalizeVietnamese(candidate.fullName);
                return normalizedName.includes(normalizedSearch);
            });

            // Apply sorting
            sortCandidates(filteredCandidates);

            if (filteredCandidates.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <svg class="w-12 h-12 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                            <p class="text-lg font-medium">${candidates.length === 0 ? 'No candidates in processing' : 'No candidates match your search'}</p>
                            <p class="text-sm">${candidates.length === 0 ? 'Click "Add New Candidate" to get started' : 'Try adjusting your search criteria'}</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filteredCandidates.map(candidate => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-4">
                        <div class="text-sm font-medium text-gray-900">${candidate.fullName}</div>
                        <div class="text-sm text-gray-500">DOB: ${new Date(candidate.dateOfBirth).toLocaleDateString()}</div>
                        ${candidate.school ? `<div class="text-sm text-gray-500">School: ${candidate.school}</div>` : ''}
                        ${candidate.learningNeeds ? `<div class="text-sm text-gray-500">Needs: ${candidate.learningNeeds}</div>` : ''}
                    </td>
                    <td class="px-4 py-4">
                        ${renderTestStatus(candidate)}
                    </td>
                    <td class="px-4 py-4">
                        ${candidate.attachments && candidate.attachments.length > 0 ? 
                            `<div class="text-xs text-gray-500 mt-1">${candidate.attachments.length} file(s) attached</div>` : ''}
                        <button onclick="openResultsModal('${candidate.id}')" class="text-blue-600 hover:text-blue-800 text-xs underline mt-1">
                            ${candidate.testResults ? 'View/Edit Results' : 'Add Results'}
                        </button>
                    </td>
                    <td class="px-4 py-4">
                        <div class="text-sm text-gray-900 break-words">
                            ${candidate.recommendations || 'No recommendations yet'}
                        </div>
                    </td>
                    <td class="px-4 py-4">
                        ${renderActionButtons(candidate)}
                    </td>
                </tr>
            `).join('');
        }

        // Render test status for candidate
        function renderTestStatus(candidate) {
            const currentStepIndex = testSteps.findIndex(step => step.id === candidate.status);
            const currentStep = testSteps[currentStepIndex];
            const nextStep = testSteps[currentStepIndex + 1];
            
            const currentStepHistory = candidate.statusHistory?.find(h => h.step === candidate.status);
            const currentStepDate = currentStepHistory ? new Date(currentStepHistory.date).toLocaleString() : '';
            
            // Status descriptions
            const statusDescriptions = {
                'added': 'Added to system',
                'create': 'Test created', 
                'complete': 'Test completed',
                'grade': 'Test graded',
                'inform': 'Results informed',
                'decide': 'Ready for decision'
            };

            // Next step descriptions
            const nextStepDescriptions = {
                'create': 'Create test',
                'complete': 'Complete test',
                'grade': 'Grade test',
                'inform': 'Inform result',
                'decide': 'Make decision'
            };
            
            return `
                <div class="space-y-2">
                    <div class="font-medium text-gray-900 text-sm">
                        ${statusDescriptions[candidate.status] || currentStep.name}
                    </div>
                    ${currentStepDate ? `<div class="text-xs text-gray-500">${currentStepDate}</div>` : ''}
                    ${nextStep ? `<div class="text-xs text-blue-600 font-medium">Next step: ${nextStepDescriptions[nextStep.id]}</div>` : ''}
                    <button onclick="viewTimeline('${candidate.id}')" class="text-xs text-blue-600 hover:text-blue-800 underline">
                        📅 View Timeline
                    </button>
                </div>
            `;
        }

        // Render action buttons based on current status
        function renderActionButtons(candidate) {
            const currentStepIndex = testSteps.findIndex(step => step.id === candidate.status);
            const nextStep = testSteps[currentStepIndex + 1];
            
            // Next step descriptions
            const nextStepDescriptions = {
                'create': 'Create test',
                'complete': 'Complete test',
                'grade': 'Grade test',
                'inform': 'Inform result',
                'decide': 'Make decision'
            };
            
            let buttons = `<div class="space-y-1">`;
            
            if (candidate.status === 'decide') {
                buttons += `
                    <div><button onclick="makeDecision('${candidate.id}', 'accepted')" class="text-green-600 hover:text-green-800 font-bold text-xs">
                        Accept
                    </button></div>
                    <div><button onclick="makeDecision('${candidate.id}', 'rejected')" class="text-red-600 hover:text-red-800 font-bold text-xs">
                        Reject
                    </button></div>
                    <div><button onclick="makeDecision('${candidate.id}', 'onhold')" class="text-yellow-600 hover:text-yellow-800 font-bold text-xs">
                        Hold
                    </button></div>
                `;
            } else if (nextStep) {
                buttons += `
                    <div><button onclick="progressToNextStep('${candidate.id}')" class="text-blue-600 hover:text-blue-800 font-bold text-xs">
                        ${nextStepDescriptions[nextStep.id]}
                    </button></div>
                `;
            }
            
            buttons += `
                <div><button onclick="editCandidate('${candidate.id}')" class="text-blue-600 hover:text-blue-800 font-bold text-xs">
                    Edit
                </button></div>
                <div><button onclick="deleteCandidate('${candidate.id}')" class="text-red-600 hover:text-red-800 font-bold text-xs">
                    Delete
                </button></div>
            `;

            return buttons + '</div>';
        }

        // View timeline modal
        function viewTimeline(candidateId) {
            const candidate = candidates.find(c => c.id === candidateId);
            
            const timelineContent = `
                <div class="space-y-4">
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h4 class="font-medium text-gray-900 mb-1">${candidate.fullName}</h4>
                        <p class="text-sm text-gray-600">Timeline Management</p>
                    </div>
                    
                    <div class="space-y-3">
                        ${testSteps.map((step, index) => {
                            const currentStepIndex = testSteps.findIndex(s => s.id === candidate.status);
                            const isCompleted = index < currentStepIndex;
                            const isCurrent = index === currentStepIndex;
                            const stepHistory = candidate.statusHistory?.find(h => h.step === step.id);
                            
                            return `
                                <div class="p-4 rounded-lg border-l-4 ${isCompleted ? 'bg-green-50 border-green-500' : isCurrent ? 'bg-blue-50 border-blue-500' : 'bg-gray-50 border-gray-300'}">
                                    <div class="flex items-start space-x-3">
                                        <input type="checkbox" 
                                               id="step_${step.id}_${candidateId}" 
                                               ${isCompleted || isCurrent ? 'checked' : ''} 
                                               onchange="toggleTimelineStep('${candidateId}', '${step.id}', this.checked)"
                                               class="mt-1 w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                                        <div class="flex-1">
                                            <div class="flex justify-between items-start mb-2">
                                                <h5 class="font-medium text-sm ${isCompleted ? 'text-green-800' : isCurrent ? 'text-blue-800' : 'text-gray-600'}">${step.name}</h5>
                                                <div class="status-badge ${isCompleted ? 'bg-green-100 text-green-800' : isCurrent ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-600'}">
                                                    ${isCompleted ? '✅ Done' : isCurrent ? '🔄 Current' : '⏳ Pending'}
                                                </div>
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <label class="text-xs text-gray-500">Completion Date/Time:</label>
                                                <input type="datetime-local" 
                                                       id="datetime_${step.id}_${candidateId}"
                                                       value="${stepHistory ? new Date(stepHistory.date).toISOString().slice(0, 16) : ''}"
                                                       onchange="updateTimelineDateTime('${candidateId}', '${step.id}', this.value)"
                                                       class="text-xs border rounded px-2 py-1 ${isCompleted || isCurrent ? '' : 'bg-gray-100'}"
                                                       ${isCompleted || isCurrent ? '' : 'disabled'}>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="flex justify-end pt-4 border-t">
                        <button onclick="saveTimelineChanges('${candidateId}')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                            💾 Save Changes
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('timelineContent').innerHTML = timelineContent;
            document.getElementById('timelineModal').classList.remove('hidden');
            document.getElementById('timelineModal').classList.add('flex');
        }

        // Make decision (direct from action buttons)
        function makeDecision(candidateId, decision) {
            if (decision === 'accepted') {
                processDecision(candidateId, decision, '');
            } else {
                document.getElementById('decisionId').value = candidateId;
                document.getElementById('decision').value = decision;
                document.getElementById('reasonSection').classList.remove('hidden');
                document.getElementById('decisionModal').classList.remove('hidden');
                document.getElementById('decisionModal').classList.add('flex');
            }
        }

        // Process decision
        async function processDecision(candidateId, decision, reason) {
            const candidate = candidates.find(c => c.id === candidateId);
            const completedData = {
                status: 'completed',
                decision: decision,
                decisionReason: reason,
                decisionDate: new Date().toISOString(),
                confirmationStatus: decision === 'accepted' ? 'awaiting' : null
            };

            try {
                await updateCandidateInFirebase(candidateId, completedData);
                // Don't manually update arrays - real-time listener will handle it
                showNotification(`Decision made: ${decision}`, 'success');
            } catch (error) {
                showNotification('Error making decision', 'error');
            }
        }

        // Progress to next step
        async function progressToNextStep(candidateId) {
            const candidate = candidates.find(c => c.id === candidateId);
            const currentStepIndex = testSteps.findIndex(step => step.id === candidate.status);
            const nextStep = testSteps[currentStepIndex + 1];

            if (nextStep) {
                const updatedCandidate = {
                    ...candidate,
                    status: nextStep.id,
                    statusHistory: [
                        ...candidate.statusHistory,
                        {
                            step: nextStep.id,
                            date: new Date().toISOString(),
                            completed: false
                        }
                    ]
                };

                try {
                    await updateCandidateInFirebase(candidateId, {
                        status: nextStep.id,
                        statusHistory: updatedCandidate.statusHistory
                    });
                    
                    const index = candidates.findIndex(c => c.id === candidateId);
                    candidates[index] = updatedCandidate;
                    renderCandidates();
                    
                    // Auto-open results modal if grading test
                    if (nextStep.id === 'grade') {
                        setTimeout(() => openResultsModal(candidateId), 500);
                    }
                    
                    showNotification(`Progressed to: ${nextStep.name}`, 'success');
                } catch (error) {
                    showNotification('Error updating status', 'error');
                }
            }
        }

        // Timeline editing functions
        function toggleTimelineStep(candidateId, stepId, isChecked) {
            const datetimeInput = document.getElementById(`datetime_${stepId}_${candidateId}`);
            if (isChecked) {
                datetimeInput.disabled = false;
                datetimeInput.classList.remove('bg-gray-100');
                if (!datetimeInput.value) {
                    datetimeInput.value = new Date().toISOString().slice(0, 16);
                }
            } else {
                datetimeInput.disabled = true;
                datetimeInput.classList.add('bg-gray-100');
                datetimeInput.value = '';
            }
        }

        function updateTimelineDateTime(candidateId, stepId, datetime) {
            // This will be saved when user clicks "Save Changes"
        }

        async function saveTimelineChanges(candidateId) {
            const candidate = candidates.find(c => c.id === candidateId);
            const updatedStatusHistory = [];
            let newStatus = 'added';

            // Process each step
            testSteps.forEach(step => {
                const checkbox = document.getElementById(`step_${step.id}_${candidateId}`);
                const datetimeInput = document.getElementById(`datetime_${step.id}_${candidateId}`);
                
                if (checkbox.checked && datetimeInput.value) {
                    updatedStatusHistory.push({
                        step: step.id,
                        date: new Date(datetimeInput.value).toISOString(),
                        completed: true
                    });
                    newStatus = step.id;
                }
            });

            try {
                await updateCandidateInFirebase(candidateId, {
                    status: newStatus,
                    statusHistory: updatedStatusHistory
                });

                const index = candidates.findIndex(c => c.id === candidateId);
                candidates[index] = { 
                    ...candidates[index], 
                    status: newStatus, 
                    statusHistory: updatedStatusHistory 
                };

                renderCandidates();
                closeTimelineModal();
                showNotification('Timeline updated successfully', 'success');
            } catch (error) {
                showNotification('Error updating timeline', 'error');
            }
        }

        // Edit candidate
        function editCandidate(candidateId) {
            const candidate = candidates.find(c => c.id === candidateId) || completedCandidates.find(c => c.id === candidateId);
            
            document.getElementById('editId').value = candidateId;
            document.getElementById('editFullName').value = candidate.fullName;
            document.getElementById('editDateOfBirth').value = candidate.dateOfBirth;
            document.getElementById('editSchool').value = candidate.school;
            document.getElementById('editLearningNeeds').value = candidate.learningNeeds;
            
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        // Handle edit candidate
        async function handleEditCandidate(e) {
            e.preventDefault();
            
            const candidateId = document.getElementById('editId').value;
            const updatedData = {
                fullName: document.getElementById('editFullName').value,
                dateOfBirth: document.getElementById('editDateOfBirth').value,
                school: document.getElementById('editSchool').value,
                learningNeeds: document.getElementById('editLearningNeeds').value
            };

            try {
                await updateCandidateInFirebase(candidateId, updatedData);
                
                // Update in processing candidates
                const processingIndex = candidates.findIndex(c => c.id === candidateId);
                if (processingIndex !== -1) {
                    candidates[processingIndex] = { ...candidates[processingIndex], ...updatedData };
                    renderCandidates();
                }
                
                // Update in completed candidates
                const completedIndex = completedCandidates.findIndex(c => c.id === candidateId);
                if (completedIndex !== -1) {
                    completedCandidates[completedIndex] = { ...completedCandidates[completedIndex], ...updatedData };
                    // Re-render all completed tabs
                    renderCompletedCandidates('accepted');
                    renderCompletedCandidates('rejected');
                    renderCompletedCandidates('onhold');
                }
                
                closeEditModal();
                showNotification('Candidate updated successfully', 'success');
            } catch (error) {
                showNotification('Error updating candidate', 'error');
            }
        }

        // Delete candidate
        async function deleteCandidate(candidateId) {
            if (confirm('Are you sure you want to delete this candidate?')) {
                try {
                    await deleteCandidateFromFirebase(candidateId);
                    
                    // Update local arrays immediately
                    candidates = candidates.filter(c => c.id !== candidateId);
                    completedCandidates = completedCandidates.filter(c => c.id !== candidateId);
                    
                    // Re-render all sections
                    renderCandidates();
                    renderCompletedCandidates('accepted');
                    renderCompletedCandidates('rejected');
                    renderCompletedCandidates('onhold');
                    
                    showNotification('Candidate deleted successfully', 'success');
                } catch (error) {
                    showNotification('Error deleting candidate', 'error');
                }
            }
        }

        // Open results modal
        function openResultsModal(candidateId) {
            const candidate = candidates.find(c => c.id === candidateId) || completedCandidates.find(c => c.id === candidateId);
            
            document.getElementById('resultsId').value = candidateId;
            document.getElementById('testResults').value = candidate.testResults || '';
            document.getElementById('grading').value = candidate.grading || '';
            document.getElementById('recommendations').value = candidate.recommendations || '';
            
            const attachmentsList = document.getElementById('attachmentsList');
            if (candidate.attachments && candidate.attachments.length > 0) {
                attachmentsList.innerHTML = candidate.attachments.map(file => 
                    `<div class="text-sm text-gray-600">${file.name}</div>`
                ).join('');
            } else {
                attachmentsList.innerHTML = '';
            }
            
            document.getElementById('resultsModal').classList.remove('hidden');
            document.getElementById('resultsModal').classList.add('flex');
        }

        // Handle save results
        async function handleSaveResults(e) {
            e.preventDefault();
            
            const candidateId = document.getElementById('resultsId').value;
            const files = document.getElementById('attachments').files;
            
            const attachments = [];
            for (let i = 0; i < files.length; i++) {
                attachments.push({
                    name: files[i].name,
                    size: files[i].size,
                    type: files[i].type,
                    url: `demo-url-${files[i].name}`
                });
            }

            const updatedData = {
                testResults: document.getElementById('testResults').value,
                grading: document.getElementById('grading').value,
                recommendations: document.getElementById('recommendations').value,
                attachments: attachments.length > 0 ? attachments : (candidates.find(c => c.id === candidateId) || completedCandidates.find(c => c.id === candidateId)).attachments || []
            };

            try {
                await updateCandidateInFirebase(candidateId, updatedData);
                
                // Update in processing candidates
                const processingIndex = candidates.findIndex(c => c.id === candidateId);
                if (processingIndex !== -1) {
                    candidates[processingIndex] = { ...candidates[processingIndex], ...updatedData };
                    renderCandidates();
                }
                
                // Update in completed candidates
                const completedIndex = completedCandidates.findIndex(c => c.id === candidateId);
                if (completedIndex !== -1) {
                    completedCandidates[completedIndex] = { ...completedCandidates[completedIndex], ...updatedData };
                    // Re-render all completed tabs
                    renderCompletedCandidates('accepted');
                    renderCompletedCandidates('rejected');
                    renderCompletedCandidates('onhold');
                }
                
                closeResultsModal();
                showNotification('Test results saved successfully', 'success');
            } catch (error) {
                showNotification('Error saving results', 'error');
            }
        }

        // Handle make decision
        async function handleMakeDecision(e) {
            e.preventDefault();
            
            const candidateId = document.getElementById('decisionId').value;
            const decision = document.getElementById('decision').value;
            const reason = document.getElementById('decisionReason').value;
            
            if (!decision) {
                showNotification('Please select a decision', 'error');
                return;
            }

            if ((decision === 'rejected' || decision === 'onhold') && !reason.trim()) {
                showNotification('Please provide a reason', 'error');
                return;
            }

            closeDecisionModal();
            await processDecision(candidateId, decision, reason);
        }

        // Render completed candidates
        function renderCompletedCandidates(type = null) {
            // Update counts
            const accepted = completedCandidates.filter(c => c.decision === 'accepted');
            const rejected = completedCandidates.filter(c => c.decision === 'rejected');
            const onHold = completedCandidates.filter(c => c.decision === 'onhold');
            
            document.getElementById('acceptedCount').textContent = accepted.length;
            document.getElementById('rejectedCount').textContent = rejected.length;
            document.getElementById('onHoldCount').textContent = onHold.length;
            
            if (type === 'accepted' || currentPhase === 'accepted') {
                const searchTerm = document.getElementById('acceptedSearchInput').value;
                const sortBy = document.getElementById('acceptedSortSelect').value;
                renderCandidateCards('acceptedCandidates', filterAndSort(accepted, searchTerm, sortBy), 'accepted');
            }
            
            if (type === 'rejected' || currentPhase === 'rejected') {
                const searchTerm = document.getElementById('rejectedSearchInput').value;
                const sortBy = document.getElementById('rejectedSortSelect').value;
                renderCandidateCards('rejectedCandidates', filterAndSort(rejected, searchTerm, sortBy), 'rejected');
            }
            
            if (type === 'onHold' || type === null) {
                const searchTerm = document.getElementById('onHoldSearchInput').value;
                const sortBy = document.getElementById('onHoldSortSelect').value;
                renderCandidateCards('onHoldCandidates', filterAndSort(onHold, searchTerm, sortBy), 'onhold');
            }
        }
        
        // Filter and sort helper function
        function filterAndSort(candidates, searchTerm, sortBy) {
            let filtered = candidates.filter(candidate => {
                if (!searchTerm) return true;
                const normalizedSearch = normalizeVietnamese(searchTerm);
                const normalizedName = normalizeVietnamese(candidate.fullName);
                return normalizedName.includes(normalizedSearch);
            });

            return filtered.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.fullName.localeCompare(b.fullName);
                    case 'date':
                        return new Date(b.decisionDate) - new Date(a.decisionDate);
                    default:
                        return 0;
                }
            });
        }

        // Render candidate cards for completed section
        function renderCandidateCards(containerId, candidates, type) {
            const container = document.getElementById(containerId);
            
            if (candidates.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-center py-8 text-sm">No candidates in this category</div>';
                return;
            }

            container.innerHTML = candidates.map(candidate => `
                <div class="bg-white rounded-lg border shadow-sm card-hover">
                    <div class="p-4 cursor-pointer" onclick="toggleCandidateExpansion('${candidate.id}')">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-medium text-gray-900 text-base">${candidate.fullName}</h4>
                                <div class="text-sm text-gray-600 mt-1">
                                    ${new Date(candidate.dateOfBirth).toLocaleDateString()} • ${candidate.school || 'No school specified'}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 mb-1">${new Date(candidate.decisionDate).toLocaleDateString()}</div>
                                <div id="expandIcon_${candidate.id}" class="text-gray-400 text-sm">▼</div>
                            </div>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="status-badge ${
                                type === 'accepted' ? 
                                    (candidate.confirmationStatus === 'confirmed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800') :
                                    (type === 'rejected' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800')
                            }">
                                ${type === 'accepted' ? 
                                    (candidate.confirmationStatus === 'confirmed' ? '✅ Confirmed' : '⏳ Awaiting Confirmation') :
                                    (type === 'rejected' ? '❌ Rejected' : '⏳ On Hold')
                                }
                            </span>
                        </div>
                    </div>
                    
                    <div id="expanded_${candidate.id}" class="hidden border-t border-gray-200">
                        <div class="p-4 space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <h5 class="font-medium text-gray-700 mb-2 text-sm">📋 Test Results</h5>
                                    <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded break-words">
                                        ${candidate.testResults || 'No test results available'}
                                    </div>
                                    ${candidate.recommendations ? `
                                        <div class="mt-2">
                                            <h6 class="font-medium text-gray-700 text-xs mb-1">💡 Recommendations</h6>
                                            <div class="text-sm text-gray-600 bg-green-50 p-2 rounded break-words">
                                                ${candidate.recommendations}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <div>
                                    <h5 class="font-medium text-gray-700 mb-2 text-sm">📝 Decision Details</h5>
                                    ${type !== 'accepted' && candidate.decisionReason ? `
                                        <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded break-words">
                                            <strong>Reason:</strong> ${candidate.decisionReason}
                                        </div>
                                    ` : ''}
                                    ${candidate.learningNeeds ? `
                                        <div class="text-sm text-gray-600 bg-blue-50 p-3 rounded mt-2 break-words">
                                            <strong>Learning Needs:</strong> ${candidate.learningNeeds}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <div class="flex flex-wrap gap-2 pt-3 border-t border-gray-100">
                                ${candidate.confirmationStatus !== 'confirmed' && type === 'accepted' ? `
                                    <button onclick="confirmCandidate('${candidate.id}')" class="bg-green-600 hover:bg-green-700 text-white btn-xs">
                                        ✅ Confirm
                                    </button>
                                ` : ''}
                                <button onclick="editCandidate('${candidate.id}')" class="bg-blue-600 hover:bg-blue-700 text-white btn-xs">
                                    ✏️ Edit
                                </button>
                                <button onclick="openResultsModal('${candidate.id}')" class="bg-purple-600 hover:bg-purple-700 text-white btn-xs">
                                    📊 Results
                                </button>
                                <button onclick="moveBackToProcessing('${candidate.id}')" class="bg-orange-600 hover:bg-orange-700 text-white btn-xs">
                                    ↩️ Move Back
                                </button>
                                <button onclick="deleteCandidate('${candidate.id}')" class="bg-red-600 hover:bg-red-700 text-white btn-xs">
                                    🗑️ Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Toggle candidate expansion
        function toggleCandidateExpansion(candidateId) {
            const expandedDiv = document.getElementById(`expanded_${candidateId}`);
            const icon = document.getElementById(`expandIcon_${candidateId}`);
            
            if (expandedDiv.classList.contains('hidden')) {
                expandedDiv.classList.remove('hidden');
                icon.textContent = '▲';
            } else {
                expandedDiv.classList.add('hidden');
                icon.textContent = '▼';
            }
        }

        // Confirm candidate
        async function confirmCandidate(candidateId) {
            try {
                await updateCandidateInFirebase(candidateId, {
                    confirmationStatus: 'confirmed',
                    confirmedDate: new Date().toISOString()
                });

                // Update local data immediately
                const index = completedCandidates.findIndex(c => c.id === candidateId);
                if (index !== -1) {
                    completedCandidates[index].confirmationStatus = 'confirmed';
                    completedCandidates[index].confirmedDate = new Date().toISOString();
                }

                // Re-render all completed tabs to show the change
                renderCompletedCandidates('accepted');
                renderCompletedCandidates('rejected');
                renderCompletedCandidates('onhold');
                showNotification('Candidate confirmed successfully', 'success');
            } catch (error) {
                showNotification('Error confirming candidate', 'error');
            }
        }

        // Move candidate back to processing
        async function moveBackToProcessing(candidateId) {
            const candidate = completedCandidates.find(c => c.id === candidateId);
            
            if (confirm('Move this candidate back to processing?')) {
                const processingData = {
                    status: 'decide',
                    decision: firebase.firestore.FieldValue.delete(),
                    decisionReason: firebase.firestore.FieldValue.delete(),
                    decisionDate: firebase.firestore.FieldValue.delete(),
                    confirmationStatus: firebase.firestore.FieldValue.delete(),
                    confirmedDate: firebase.firestore.FieldValue.delete()
                };

                try {
                    await updateCandidateInFirebase(candidateId, processingData);
                    
                    // Update local arrays immediately
                    const completedIndex = completedCandidates.findIndex(c => c.id === candidateId);
                    if (completedIndex !== -1) {
                        const movedCandidate = { ...completedCandidates[completedIndex] };
                        // Remove from completed
                        completedCandidates.splice(completedIndex, 1);
                        
                        // Add to processing with updated status
                        movedCandidate.status = 'decide';
                        delete movedCandidate.decision;
                        delete movedCandidate.decisionReason;
                        delete movedCandidate.decisionDate;
                        delete movedCandidate.confirmationStatus;
                        delete movedCandidate.confirmedDate;
                        
                        candidates.push(movedCandidate);
                    }
                    
                    // Re-render both sections
                    renderCandidates();
                    renderCompletedCandidates('accepted');
                    renderCompletedCandidates('rejected');
                    renderCompletedCandidates('onhold');
                    
                    showNotification('Candidate moved back to processing', 'success');
                } catch (error) {
                    showNotification('Error moving candidate', 'error');
                }
            }
        }

        // Modal close functions
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        function closeResultsModal() {
            document.getElementById('resultsModal').classList.add('hidden');
            document.getElementById('resultsModal').classList.remove('flex');
        }

        function closeDecisionModal() {
            document.getElementById('decisionModal').classList.add('hidden');
            document.getElementById('decisionModal').classList.remove('flex');
        }

        function closeTimelineModal() {
            document.getElementById('timelineModal').classList.add('hidden');
            document.getElementById('timelineModal').classList.remove('flex');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.add('hidden');
            document.getElementById('detailModal').classList.remove('flex');
        }

        // Show notification
        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-lg text-white font-medium transition-all duration-300 max-w-sm ${
                type === 'success' ? 'bg-green-600' : 'bg-red-600'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Initialize the application when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'973254841614e2f7',t:'MTc1NTg2NTI4OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
