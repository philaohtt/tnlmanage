<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Ultra Compact Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.4rem 0;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
            flex-shrink: 0;
            position: relative;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .header h1 {
            font-size: 1rem;
            margin: 0;
            font-weight: 600;
        }
        
        .header-info {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            opacity: 0.9;
        }
        
        .logout-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Ultra Compact Navigation */
        .nav {
            background: white;
            padding: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            flex-shrink: 0;
            height: 45px;
        }
        
        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            height: 100%;
        }
        
        .nav-item {
            flex: 1;
            text-align: center;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 0 0.5rem;
            text-decoration: none;
            color: #555;
            font-weight: 500;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
            cursor: pointer;
        }
        
        .nav-link:hover, .nav-link.active {
            background: #f8f9fa;
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        /* Hide admin-only items for non-admin users */
        .nav-item.admin-only {
            display: none;
        }
        
        .nav-item.admin-only.show {
            display: block;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Header -->
    <div id="topHeader" class="header fixed top-0 left-0 right-0 z-50 hidden">
        <div class="header-info" id="userInfo"></div>
        <h1>üéì School Management System</h1>
        <button onclick="logout()" class="logout-btn">
            <i class="fas fa-sign-out-alt mr-1"></i>Logout
        </button>
    </div>

    <!-- Navigation -->
    <nav id="topNav" class="nav fixed top-10 left-0 right-0 z-40 hidden">
        <div class="nav-container">
            <div class="nav-item">
                <a onclick="openModule('workflow2.2.html')" class="nav-link">
                    <span class="mr-1 text-lg">üìö</span>Workflow
                </a>
            </div>
            <div class="nav-item">
                <a onclick="openModule('admission2.2.html')" class="nav-link">
                    <span class="mr-1 text-lg">üìù</span>Admission
                </a>
            </div>
            <div class="nav-item">
                <a onclick="openModule('student2.2.html')" class="nav-link">
                    <span class="mr-1 text-lg">üë•</span>Students
                </a>
            </div>
            <div class="nav-item">
                <a onclick="openModule('courses2.2.html')" class="nav-link">
                    <span class="mr-1 text-lg">üìö</span>Courses
                </a>
            </div>
            <div class="nav-item admin-only" id="tuitionNav">
                <a onclick="openModule('tuition2.2.html')" class="nav-link">
                    <span class="mr-1 text-lg">üí∞</span>Tuition
                </a>
            </div>
            <div class="nav-item">
                <a onclick="openModule('facilities2.2.html')" class="nav-link">
                    <span class="mr-1 text-lg">üè´</span>Facilities
                </a>
            </div>
            <div class="nav-item admin-only" id="accountsNav">
                <a onclick="showAccountsModule()" class="nav-link">
                    <span class="mr-1 text-lg">üë§</span>Accounts
                </a>
            </div>
        </div>
    </nav>

    <!-- Login Form -->
    <div id="loginContainer" class="flex items-center justify-center min-h-screen">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-graduation-cap text-indigo-600 text-5xl mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-800 mb-2">School Management</h2>
                <p class="text-gray-600">Sign in to access your dashboard</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                    <input type="text" id="username" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                    <input type="password" id="password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                </div>
                
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors">
                    <i class="fas fa-sign-in-alt mr-2"></i>Sign In
                </button>
            </form>
            
            <div id="loginError" class="mt-4 text-red-600 text-sm text-center hidden"></div>
        </div>
    </div>

    <!-- Module Content Area -->
    <div id="moduleContainer" class="hidden" style="padding-top: 85px;">
        <iframe id="moduleFrame" class="w-full border-0" style="height: calc(100vh - 85px);"></iframe>
    </div>

    <!-- Accounts Module -->
    <div id="accountsModule" class="p-6 hidden" style="padding-top: 85px; min-height: calc(100vh - 85px);">
        <div class="max-w-6xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-user-cog mr-3 text-red-600"></i>Account Management
                </h2>
                
                <!-- Create Account Form -->
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Create New Account</h3>
                    <form id="createAccountForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
                            <input type="text" id="newFullName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                            <input type="text" id="newUsername" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="newPassword" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Role</label>
                            <select id="newRole" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500">
                                <option value="">Select Role</option>
                                <option value="Administrator">Administrator</option>
                                <option value="Teacher">Teacher</option>
                                <option value="Staff">Staff Member</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="bg-red-600 hover:bg-red-700 text-white px-6 py-2 rounded-lg transition-colors">
                                <i class="fas fa-plus mr-2"></i>Create Account
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Accounts List -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-700 mb-4">Existing Accounts</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full bg-white border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Full Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Username</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="accountsList" class="divide-y divide-gray-200">
                                <!-- Accounts will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDdx6QyXzCWz7BRZInLu16LGnYBKvFO1CM",
            authDomain: "tnl-management-app.firebaseapp.com",
            projectId: "tnl-management-app",
            storageBucket: "tnl-management-app.appspot.com",
            messagingSenderId: "590918430866",
            appId: "1:590918430866:web:123456789abcdef"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Authentication system
        let currentUser = null;
        let userRole = null;
        let lastActivity = Date.now();
        let activityTimer = null;
        let currentModule = null;

        // Admin account stored locally (for login)
        const adminAccount = {
            'admin': { password: 'Thanhtung@233', role: 'Administrator', fullName: 'System Administrator' }
        };

        // Initialize admin account in localStorage
        function initializeAdminAccount() {
            if (!localStorage.getItem('schoolAccounts')) {
                localStorage.setItem('schoolAccounts', JSON.stringify(adminAccount));
            }
        }

        // Activity tracking for auto-logout
        function updateActivity() {
            lastActivity = Date.now();
            localStorage.setItem('lastActivity', lastActivity.toString());
        }

        function startActivityTimer() {
            if (activityTimer) clearInterval(activityTimer);
            
            activityTimer = setInterval(() => {
                const now = Date.now();
                const timeSinceActivity = now - lastActivity;
                const thirtyMinutes = 30 * 60 * 1000; // 30 minutes in milliseconds
                
                if (timeSinceActivity >= thirtyMinutes) {
                    alert('Session expired due to inactivity. Please log in again.');
                    logout();
                }
            }, 60000); // Check every minute
        }

        function stopActivityTimer() {
            if (activityTimer) {
                clearInterval(activityTimer);
                activityTimer = null;
            }
        }

        // Track user activity
        document.addEventListener('click', updateActivity);
        document.addEventListener('keypress', updateActivity);
        document.addEventListener('mousemove', updateActivity);
        document.addEventListener('scroll', updateActivity);

        // Check authentication state on page load
        window.addEventListener('load', () => {
            initializeAdminAccount();
            const savedUser = localStorage.getItem('currentUser');
            const savedActivity = localStorage.getItem('lastActivity');
            const savedModule = localStorage.getItem('currentModule');
            
            if (savedUser && savedActivity) {
                const now = Date.now();
                const lastActivityTime = parseInt(savedActivity);
                const timeSinceActivity = now - lastActivityTime;
                const thirtyMinutes = 30 * 60 * 1000;
                
                if (timeSinceActivity < thirtyMinutes) {
                    // Session is still valid
                    currentUser = JSON.parse(savedUser);
                    userRole = currentUser.role;
                    lastActivity = lastActivityTime;
                    showDashboard();
                    startActivityTimer();
                    
                    // Restore the current module if it exists
                    if (savedModule) {
                        currentModule = savedModule;
                        if (savedModule === 'accounts') {
                            showAccountsModule();
                        } else {
                            openModule(savedModule);
                        }
                    }
                } else {
                    // Session expired
                    localStorage.removeItem('currentUser');
                    localStorage.removeItem('lastActivity');
                    localStorage.removeItem('currentModule');
                    showLogin();
                }
            } else {
                showLogin();
            }
        });

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const accounts = JSON.parse(localStorage.getItem('schoolAccounts'));
            
            if (accounts[username] && accounts[username].password === password) {
                currentUser = {
                    username: username,
                    role: accounts[username].role,
                    fullName: accounts[username].fullName,
                    uid: username
                };
                userRole = currentUser.role;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                updateActivity();
                startActivityTimer();
                showDashboard();
            } else {
                showError('Invalid username or password');
            }
        });

        // Create account form handler
        document.getElementById('createAccountForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const fullName = document.getElementById('newFullName').value;
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newPassword').value;
            const role = document.getElementById('newRole').value;
            
            try {
                // Create document ID from full name (no spaces)
                const docId = fullName.replace(/\s+/g, '');
                
                // Check if account already exists
                const docRef = db.collection('userAccounts').doc(docId);
                const doc = await docRef.get();
                
                if (doc.exists) {
                    alert('Account with this full name already exists!');
                    return;
                }
                
                // Create new account in Firestore
                await docRef.set({
                    fullName: fullName,
                    username: username,
                    password: password,
                    role: role,
                    fullAccess: true,
                    created: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                document.getElementById('createAccountForm').reset();
                loadAccounts();
                alert('Account created successfully!');
            } catch (error) {
                console.error('Error creating account:', error);
                alert('Error creating account: ' + error.message);
            }
        });

        function showLogin() {
            document.getElementById('loginContainer').classList.remove('hidden');
            document.getElementById('topHeader').classList.add('hidden');
            document.getElementById('topNav').classList.add('hidden');
            document.getElementById('moduleContainer').classList.add('hidden');
            document.getElementById('accountsModule').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('loginContainer').classList.add('hidden');
            document.getElementById('topHeader').classList.remove('hidden');
            document.getElementById('topNav').classList.remove('hidden');
            document.getElementById('moduleContainer').classList.add('hidden');
            document.getElementById('accountsModule').classList.add('hidden');
            
            // Update user info
            document.getElementById('userInfo').textContent = `${currentUser.fullName} (${userRole})`;
            
            // Show/hide admin-only modules
            if (userRole === 'Administrator') {
                document.getElementById('tuitionNav').classList.add('show');
                document.getElementById('accountsNav').classList.add('show');
            } else {
                document.getElementById('tuitionNav').classList.remove('show');
                document.getElementById('accountsNav').classList.remove('show');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        function openModule(moduleFile) {
            document.getElementById('moduleContainer').classList.remove('hidden');
            document.getElementById('accountsModule').classList.add('hidden');
            document.getElementById('moduleFrame').src = moduleFile;
            
            // Save current module state
            currentModule = moduleFile;
            localStorage.setItem('currentModule', moduleFile);
            updateActivity();
        }

        function showAccountsModule() {
            if (userRole !== 'Administrator') {
                alert('Access denied. Administrator privileges required.');
                return;
            }
            
            document.getElementById('moduleContainer').classList.add('hidden');
            document.getElementById('accountsModule').classList.remove('hidden');
            loadAccounts();
            
            // Save current module state
            currentModule = 'accounts';
            localStorage.setItem('currentModule', 'accounts');
            updateActivity();
        }

        async function loadAccounts() {
            try {
                const accountsList = document.getElementById('accountsList');
                accountsList.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">Loading accounts...</td></tr>';
                
                console.log('Loading accounts from Firestore...');
                const snapshot = await db.collection('userAccounts').get();
                console.log('Snapshot size:', snapshot.size);
                
                accountsList.innerHTML = '';
                
                if (snapshot.empty) {
                    accountsList.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No accounts found</td></tr>';
                    return;
                }
                
                snapshot.forEach((doc) => {
                    console.log('Document ID:', doc.id);
                    const data = doc.data();
                    console.log('Document data:', data);
                    
                    const row = document.createElement('tr');
                    
                    // Handle fullAccess field safely
                    const fullAccess = data.fullAccess !== undefined ? data.fullAccess : true;
                    const statusColor = fullAccess ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const statusText = fullAccess ? 'Active' : 'Locked';
                    
                    // Handle role colors
                    const roleColor = data.role === 'Administrator' ? 'bg-red-100 text-red-800' : 
                                     data.role === 'Teacher' ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800';
                    
                    // Handle created date safely
                    let createdDate = 'N/A';
                    if (data.created) {
                        try {
                            if (data.created.toDate) {
                                createdDate = data.created.toDate().toLocaleDateString();
                            } else if (data.created instanceof Date) {
                                createdDate = data.created.toLocaleDateString();
                            } else {
                                createdDate = new Date(data.created).toLocaleDateString();
                            }
                        } catch (e) {
                            console.log('Error parsing date:', e);
                            createdDate = 'Invalid Date';
                        }
                    }
                    
                    // Safely get field values with defaults
                    const fullName = data.fullName || 'N/A';
                    const username = data.username || 'N/A';
                    const role = data.role || 'N/A';
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 text-sm text-gray-900">${fullName}</td>
                        <td class="px-6 py-4 text-sm text-gray-900">${username}</td>
                        <td class="px-6 py-4 text-sm">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${roleColor}">
                                ${role}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusColor}">
                                ${statusText}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">${createdDate}</td>
                        <td class="px-6 py-4 text-sm space-x-2">
                            <button onclick="editAccount('${doc.id}')" class="text-blue-600 hover:text-blue-800" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="toggleAccountLock('${doc.id}', ${fullAccess})" class="text-yellow-600 hover:text-yellow-800" title="${fullAccess ? 'Lock' : 'Unlock'}">
                                <i class="fas fa-${fullAccess ? 'lock' : 'unlock'}"></i>
                            </button>
                            <button onclick="deleteAccount('${doc.id}')" class="text-red-600 hover:text-red-800" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    accountsList.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error loading accounts:', error);
                document.getElementById('accountsList').innerHTML = `<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading accounts: ${error.message}</td></tr>`;
            }
        }

        async function editAccount(docId) {
            try {
                const doc = await db.collection('userAccounts').doc(docId).get();
                if (!doc.exists) {
                    alert('Account not found!');
                    return;
                }
                
                const data = doc.data();
                const newFullName = prompt('Full Name:', data.fullName);
                const newUsername = prompt('Username:', data.username);
                const newPassword = prompt('Password:', data.password);
                const newRole = prompt('Role (Administrator/Teacher/Staff):', data.role);
                
                if (newFullName && newUsername && newPassword && newRole) {
                    await db.collection('userAccounts').doc(docId).update({
                        fullName: newFullName,
                        username: newUsername,
                        password: newPassword,
                        role: newRole,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    loadAccounts();
                    alert('Account updated successfully!');
                }
            } catch (error) {
                console.error('Error updating account:', error);
                alert('Error updating account: ' + error.message);
            }
        }

        async function toggleAccountLock(docId, currentStatus) {
            try {
                const newStatus = !currentStatus;
                await db.collection('userAccounts').doc(docId).update({
                    fullAccess: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                loadAccounts();
                alert(`Account ${newStatus ? 'unlocked' : 'locked'} successfully!`);
            } catch (error) {
                console.error('Error toggling account lock:', error);
                alert('Error updating account status: ' + error.message);
            }
        }

        async function deleteAccount(docId) {
            if (confirm('Are you sure you want to delete this account? This action cannot be undone.')) {
                try {
                    await db.collection('userAccounts').doc(docId).delete();
                    loadAccounts();
                    alert('Account deleted successfully!');
                } catch (error) {
                    console.error('Error deleting account:', error);
                    alert('Error deleting account: ' + error.message);
                }
            }
        }

        function logout() {
            localStorage.removeItem('currentUser');
            localStorage.removeItem('lastActivity');
            localStorage.removeItem('currentModule');
            stopActivityTimer();
            currentUser = null;
            userRole = null;
            currentModule = null;
            showLogin();
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97734848116a1c68',t:'MTc1NjU0NjM2MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
