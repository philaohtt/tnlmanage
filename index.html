<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>School Management System - Login</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
      * {
          margin: 0;
          padding: 0;
          box-sizing: border-box;
      }
      
      body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          line-height: 1.6;
          color: #333;
          height: 100vh;
          display: flex;
          flex-direction: column;
      }
      
      /* Login Screen Styles */
      .login-container {
          display: flex;
          align-items: center;
          justify-content: center;
          min-height: 100vh;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          padding: 1rem;
      }
      
      .login-box {
          background: white;
          padding: 2.5rem;
          border-radius: 12px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.2);
          width: 100%;
          max-width: 400px;
          text-align: center;
      }
      
      .login-header {
          margin-bottom: 2rem;
      }
      
      .login-header h1 {
          font-size: 1.8rem;
          color: #2c3e50;
          margin-bottom: 0.5rem;
      }
      
      .login-header p {
          color: #666;
          font-size: 0.95rem;
      }
      
      .login-form {
          display: flex;
          flex-direction: column;
          gap: 1rem;
      }
      
      .form-group {
          text-align: left;
      }
      
      .form-group label {
          display: block;
          margin-bottom: 0.5rem;
          color: #555;
          font-weight: 500;
      }
      
      .form-group input, .form-group select {
          width: 100%;
          padding: 0.75rem;
          border: 2px solid #e1e8ed;
          border-radius: 6px;
          font-size: 1rem;
          transition: border-color 0.3s ease;
      }
      
      .form-group input:focus, .form-group select:focus {
          outline: none;
          border-color: #667eea;
      }
      
      .login-btn {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 0.75rem 1.5rem;
          border: none;
          border-radius: 6px;
          font-size: 1rem;
          font-weight: 500;
          cursor: pointer;
          transition: transform 0.2s ease;
      }
      
      .login-btn:hover {
          transform: translateY(-1px);
      }
      
      .login-btn:active {
          transform: translateY(0);
      }
      
      .error-message {
          color: #e74c3c;
          font-size: 0.9rem;
          margin-top: 0.5rem;
          display: none;
      }
      
      .success-message {
          color: #27ae60;
          font-size: 0.9rem;
          margin-top: 0.5rem;
          display: none;
      }
      
      /* Main App Styles (hidden initially) */
      .main-app {
          display: none;
          height: 100vh;
          flex-direction: column;
      }
      
      /* Compact Header */
      .header {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 0.75rem 0;
          text-align: center;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          flex-shrink: 0;
          position: relative;
      }
      
      .header h1 {
          font-size: 1.5rem;
          margin-bottom: 0.2rem;
          font-weight: 600;
      }
      
      .header p {
          font-size: 0.85rem;
          opacity: 0.9;
      }
      
      .header-info {
          position: absolute;
          left: 1rem;
          top: 50%;
          transform: translateY(-50%);
          font-size: 0.8rem;
          opacity: 0.9;
      }
      
      .logout-btn {
          position: absolute;
          right: 1rem;
          top: 50%;
          transform: translateY(-50%);
          background: rgba(255,255,255,0.2);
          color: white;
          border: 1px solid rgba(255,255,255,0.3);
          padding: 0.4rem 0.8rem;
          border-radius: 4px;
          font-size: 0.8rem;
          cursor: pointer;
          transition: background 0.3s ease;
      }
      
      .logout-btn:hover {
          background: rgba(255,255,255,0.3);
      }
      
      /* Compact Navigation */
      .nav {
          background: white;
          padding: 0;
          box-shadow: 0 1px 3px rgba(0,0,0,0.1);
          flex-shrink: 0;
      }
      
      .nav-container {
          max-width: 1200px;
          margin: 0 auto;
          display: flex;
      }
      
      .nav-item {
          flex: 1;
          text-align: center;
      }
      
      .nav-link {
          display: block;
          padding: 0.75rem 0.5rem;
          text-decoration: none;
          color: #555;
          font-weight: 500;
          font-size: 0.9rem;
          transition: all 0.3s ease;
          border-bottom: 2px solid transparent;
          cursor: pointer;
      }
      
      .nav-link:hover, .nav-link.active {
          background: #f8f9fa;
          color: #667eea;
          border-bottom-color: #667eea;
      }
      
      /* Hide admin-only items for non-admin users */
      .nav-item.admin-only {
          display: none;
      }
      
      .nav-item.admin-only.show {
          display: block;
      }
      
      /* Maximized Content Area */
      .content {
          flex: 1;
          overflow: hidden;
          display: flex;
          flex-direction: column;
      }
      
      .module-content {
          display: none;
          flex: 1;
          overflow: hidden;
      }
      
      .module-content.active {
          display: flex;
          flex-direction: column;
      }
      
      .module-frame {
          width: 100%;
          flex: 1;
          border: none;
          background: white;
      }
      
      /* Compact Home page */
      .home-content {
          flex: 1;
          padding: 1.5rem;
          overflow-y: auto;
      }
      
      .welcome-section {
          background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
          padding: 1.5rem;
          border-radius: 8px;
          margin-bottom: 1.5rem;
          text-align: center;
      }
      
      .welcome-section h2 {
          font-size: 1.5rem;
          color: #2c3e50;
          margin-bottom: 0.5rem;
      }
      
      .welcome-section p {
          font-size: 0.95rem;
          color: #555;
          max-width: 600px;
          margin: 0 auto;
      }
      
      .features-grid {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 1rem;
      }
      
      .feature-card {
          background: white;
          padding: 1.25rem;
          border-radius: 6px;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
          transition: transform 0.3s ease;
          text-align: center;
          cursor: pointer;
          border: 2px solid transparent;
      }
      
      .feature-card:hover {
          transform: translateY(-2px);
          border-color: #667eea;
          box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      }
      
      .feature-card.admin-only {
          display: none;
      }
      
      .feature-card.admin-only.show {
          display: block;
      }
      
      .feature-icon {
          font-size: 2rem;
          margin-bottom: 0.5rem;
      }
      
      .feature-card h3 {
          color: #2c3e50;
          margin-bottom: 0.5rem;
          font-size: 1rem;
      }
      
      .feature-card p {
          color: #666;
          font-size: 0.85rem;
      }
      
      /* Account Management Styles */
      .account-management {
          flex: 1;
          padding: 1.5rem;
          overflow-y: auto;
      }
      
      .account-section {
          background: white;
          padding: 1.5rem;
          border-radius: 8px;
          margin-bottom: 1.5rem;
          box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      
      .account-section h3 {
          color: #2c3e50;
          margin-bottom: 1rem;
          font-size: 1.25rem;
      }
      
      .account-form {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
          gap: 1rem;
          margin-bottom: 1rem;
      }
      
      .account-form .form-group {
          margin-bottom: 0;
      }
      
      .account-form .form-group.full-width {
          grid-column: 1 / -1;
      }
      
      .btn {
          padding: 0.75rem 1.5rem;
          border: none;
          border-radius: 6px;
          font-size: 0.9rem;
          font-weight: 500;
          cursor: pointer;
          transition: all 0.3s ease;
          margin-right: 0.5rem;
      }
      
      .btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
      }
      
      .btn-primary {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
      }
      
      .btn-primary:hover:not(:disabled) {
          transform: translateY(-1px);
      }
      
      .btn-danger {
          background: #e74c3c;
          color: white;
      }
      
      .btn-danger:hover:not(:disabled) {
          background: #c0392b;
      }
      
      .btn-secondary {
          background: #6c757d;
          color: white;
      }
      
      .btn-secondary:hover:not(:disabled) {
          background: #5a6268;
      }
      
      .accounts-table {
          width: 100%;
          border-collapse: collapse;
          margin-top: 1rem;
      }
      
      .accounts-table th,
      .accounts-table td {
          padding: 0.75rem;
          text-align: left;
          border-bottom: 1px solid #e1e8ed;
      }
      
      .accounts-table th {
          background: #f8f9fa;
          font-weight: 600;
          color: #2c3e50;
      }
      
      .accounts-table tr:hover {
          background: #f8f9fa;
      }
      
      .role-badge {
          padding: 0.25rem 0.5rem;
          border-radius: 4px;
          font-size: 0.8rem;
          font-weight: 500;
      }
      
      .role-admin {
          background: #e74c3c;
          color: white;
      }
      
      .role-teacher {
          background: #3498db;
          color: white;
      }
      
      .role-staff {
          background: #27ae60;
          color: white;
      }
      
      .role-registrar {
          background: #f39c12;
          color: white;
      }
      
      /* Modal Styles */
      .modal {
          display: none;
          position: fixed;
          z-index: 1000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.5);
      }
      
      .modal-content {
          background-color: white;
          margin: 10% auto;
          padding: 2rem;
          border-radius: 8px;
          width: 90%;
          max-width: 500px;
          box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      }
      
      .modal-header {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 1rem;
      }
      
      .modal-header h3 {
          color: #2c3e50;
          margin: 0;
      }
      
      .close {
          color: #aaa;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
      }
      
      .close:hover {
          color: #000;
      }
      
      /* Minimal Footer */
      .footer {
          background: #2c3e50;
          color: white;
          text-align: center;
          padding: 0.5rem 0;
          font-size: 0.8rem;
          flex-shrink: 0;
      }
      
      /* Loading state */
      .loading {
          display: flex;
          align-items: center;
          justify-content: center;
          flex: 1;
          color: #666;
          font-size: 0.9rem;
      }
      
      .loading::after {
          content: '';
          display: inline-block;
          width: 16px;
          height: 16px;
          border: 2px solid #667eea;
          border-radius: 50%;
          border-top-color: transparent;
          animation: spin 1s linear infinite;
          margin-left: 8px;
      }
      
      @keyframes spin {
          to { transform: rotate(360deg); }
      }
      
      /* Mobile responsiveness */
      @media (max-width: 768px) {
          .login-box {
              padding: 2rem;
              margin: 1rem;
          }
          
          .header h1 {
              font-size: 1.25rem;
          }
          
          .header p {
              font-size: 0.75rem;
          }
          
          .header-info {
              position: static;
              transform: none;
              margin-top: 0.5rem;
              text-align: center;
          }
          
          .logout-btn {
              position: static;
              transform: none;
              margin-top: 0.5rem;
              display: block;
              width: auto;
          }
          
          .nav-link {
              padding: 0.6rem 0.25rem;
              font-size: 0.8rem;
          }
          
          .home-content, .account-management {
              padding: 1rem;
          }
          
          .welcome-section {
              padding: 1rem;
          }
          
          .welcome-section h2 {
              font-size: 1.25rem;
          }
          
          .features-grid {
              grid-template-columns: 1fr;
          }
          
          .feature-card {
              padding: 1rem;
          }
          
          .account-form {
              grid-template-columns: 1fr;
          }
          
          .modal-content {
              margin: 5% auto;
              width: 95%;
              padding: 1.5rem;
          }
          
          .accounts-table {
              font-size: 0.8rem;
          }
      }
      
      /* Ensure full height usage */
      html {
          height: 100%;
      }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="login-screen" class="login-container">
      <div class="login-box">
          <div class="login-header">
              <h1>üè´ School Management System</h1>
              <p>Please enter your credentials to access the system</p>
          </div>
          
          <form class="login-form" onsubmit="return handleLogin(event)">
              <div class="form-group">
                  <label for="username">Username</label>
                  <input type="text" id="username" name="username" required placeholder="Enter your username">
              </div>
              
              <div class="form-group">
                  <label for="password">Password</label>
                  <input type="password" id="password" name="password" required placeholder="Enter your password">
              </div>
              
              <button type="submit" class="login-btn">Access System</button>
              
              <div id="error-message" class="error-message">
                  Invalid credentials. Please check your username and password.
              </div>
              
              <div id="success-message" class="success-message">
                  Access granted! Loading system...
              </div>
          </form>
          
          <div style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; font-size: 0.8rem; color: #666;">
              <strong>Default Admin Account:</strong><br>
              Username: admin<br>
              Password: admin123
          </div>
      </div>
  </div>

  <!-- Main Application (hidden initially) -->
  <div id="main-app" class="main-app">
      <!-- Compact Header -->
      <header class="header">
          <div class="header-info">
              <div id="current-user">User: Guest</div>
              <div id="current-role">Role: --</div>
              <div id="login-time">Login: --</div>
          </div>
          <h1>üè´ School Management System</h1>
          <p>Educational Administration Platform</p>
          <button class="logout-btn" onclick="logout()">Logout</button>
      </header>

      <!-- Compact Navigation -->
      <nav class="nav">
          <div class="nav-container">
              <div class="nav-item">
                  <a href="#" class="nav-link active" onclick="showModule('home')">üè† Home</a>
              </div>
		<div class="nav-item admin-only">
                  <a href="#" class="nav-link" onclick="showModule('workflow')">üìö Work Flow</a>
              </div>
              <div class="nav-item">
                  <a href="#" class="nav-link" onclick="showModule('admission')">üìù Admission</a>
              </div>
              <div class="nav-item">
                  <a href="#" class="nav-link" onclick="showModule('students')">üë• Students</a>
              </div>
              <div class="nav-item">
                  <a href="#" class="nav-link" onclick="showModule('courses')">üìö Courses</a>
              </div>
              <div class="nav-item admin-only">
                  <a href="#" class="nav-link" onclick="showModule('tuition')">üí∞ Tuition</a>
              </div>
		<div class="nav-item admin-only">
                  <a href="#" class="nav-link" onclick="showModule('facilities')">üè´ Facilities</a>
              </div>
              <div class="nav-item admin-only">
                  <a href="#" class="nav-link" onclick="showModule('accounts')">üë§ Accounts</a>
              </div>
          </div>
      </nav>

      <!-- Content Area -->
      <main class="content">
          <!-- Home Module -->
          <div id="home" class="module-content active">
              <div class="home-content">
                  <div class="welcome-section">
                      <h2>Welcome to School Management System</h2>
                      <p>Streamline your educational administration with our comprehensive platform. Manage admissions, students, courses, and more from one central location.</p>
                  </div>

                  <div class="features-grid">
			<div class="feature-card" onclick="showModule('workflow')" data-module="workflow">
                          <div class="feature-icon">üìö</div>
                          <h3>Work Flow Management</h3>
                          <p>Assign and track tasks across team members.</p>
                      </div>

                      <div class="feature-card" onclick="showModule('admission')" data-module="admission">
                          <div class="feature-icon">üìù</div>
                          <h3>Admission Management</h3>
                          <p>Handle student applications, track admission status, and manage enrollment processes efficiently.</p>
                      </div>

                      <div class="feature-card" onclick="showModule('students')" data-module="students">
                          <div class="feature-icon">üë•</div>
                          <h3>Student Directory</h3>
                          <p>Comprehensive student profiles with contact information, academic records, and progress tracking.</p>
                      </div>

                      <div class="feature-card" onclick="showModule('courses')" data-module="courses">
                          <div class="feature-icon">üìö</div>
                          <h3>Course Management</h3>
                          <p>Organize courses, manage schedules, track attendance, and monitor student performance.</p>
                      </div>
			
			<div class="feature-card" onclick="showModule('facilities')" data-module="facilities">
                          <div class="feature-icon">üè´</div>
                          <h3>Facility Management</h3>
                          <p>Track and manage facilities and keep inventory.</p>
                      </div>

                      <div class="feature-card admin-only" onclick="showModule('tuition')" data-module="tuition">
                          <div class="feature-icon">üí∞</div>
                          <h3>Tuition & Fees</h3>
                          <p>Handle fee collection, payment tracking, financial reports, and billing management.</p>
                      </div>

                      <div class="feature-card admin-only" onclick="showModule('accounts')" data-module="accounts">
                          <div class="feature-icon">üë§</div>
                          <h3>Account Management</h3>
                          <p>Create and manage user accounts, set permissions, and control system access.</p>
                      </div>
                  </div>
              </div>
          </div>

          <!-- Account Management Module -->
          <div id="accounts" class="module-content">
              <div class="account-management">
                  <div class="account-section">
                      <h3>Create New Account</h3>
                      <form class="account-form" onsubmit="return createAccount(event)">
                          <div class="form-group">
                              <label for="newUsername">Username</label>
                              <input type="text" id="newUsername" required placeholder="Enter username">
                          </div>
                          
                          <div class="form-group">
                              <label for="newPassword">Password</label>
                              <input type="password" id="newPassword" required placeholder="Enter password">
                          </div>
                          
                          <div class="form-group">
                              <label for="newRole">Role</label>
                              <select id="newRole" required>
                                  <option value="">Select role</option>
                                  <option value="admin">Administrator</option>
                                  <option value="teacher">Teacher</option>
                                  <option value="staff">Staff Member</option>
                                  <option value="registrar">Registrar</option>
                              </select>
                          </div>
                          
                          <div class="form-group">
                              <label for="newFullName">Full Name</label>
                              <input type="text" id="newFullName" required placeholder="Enter full name">
                          </div>
                          
                          <div class="form-group full-width">
                              <button type="submit" class="btn btn-primary" id="createAccountBtn">Create Account</button>
                          </div>
                      </form>
                      
                      <div id="account-message" style="display: none; margin-top: 1rem; padding: 0.75rem; border-radius: 4px;"></div>
                  </div>

                  <div class="account-section">
                      <h3>Existing Accounts</h3>
                      <div id="accounts-loading" class="loading" style="display: none;">Loading accounts...</div>
                      <table class="accounts-table">
                          <thead>
                              <tr>
                                  <th>Username</th>
                                  <th>Full Name</th>
                                  <th>Role</th>
                                  <th>Created</th>
                                  <th>Actions</th>
                              </tr>
                          </thead>
                          <tbody id="accounts-tbody">
                              <!-- Accounts will be populated here -->
                          </tbody>
                      </table>
                  </div>
              </div>
          </div>

          <!-- Other Modules (loaded via iframe) -->
	<div id="workflow" class="module-content">
              <div class="loading">Loading Work Flow Module...</div>
              <iframe class="module-frame" src="workflow2.2.html" style="display:none;"></iframe>
          </div>          

		<div id="admission" class="module-content">
              <div class="loading">Loading Admission Module...</div>
              <iframe class="module-frame" src="admission2.2.html" style="display:none;"></iframe>
          </div>

          <div id="students" class="module-content">
              <div class="loading">Loading Student Directory...</div>
              <iframe class="module-frame" src="student2.2.html" style="display:none;"></iframe>
          </div>

          <div id="courses" class="module-content">
              <div class="loading">Loading Course Management...</div>
              <iframe class="module-frame" src="courses2.2.html" style="display:none;"></iframe>
          </div>

          <div id="facilities" class="module-content">
              <div class="loading">Loading Facility Management...</div>
              <iframe class="module-frame" src="facilities2.2.html" style="display:none;"></iframe>
          </div>

          <div id="tuition" class="module-content">
              <div class="loading">Loading Tuition Management...</div>
              <iframe class="module-frame" src="tuition2.2.html" style="display:none;"></iframe>
          </div>
      </main>

      <!-- Minimal Footer -->
      <footer class="footer">
          <p>&copy; 2024 School Management System. All rights reserved.</p>
      </footer>
  </div>

  <!-- Edit Account Modal -->
  <div id="editModal" class="modal">
      <div class="modal-content">
          <div class="modal-header">
              <h3>Edit Account</h3>
              <span class="close" onclick="closeEditModal()">&times;</span>
          </div>
          <form onsubmit="return updateAccount(event)">
              <input type="hidden" id="editUsername">
              <div class="form-group">
                  <label for="editFullName">Full Name</label>
                  <input type="text" id="editFullName" required>
              </div>
              <div class="form-group">
                  <label for="editRole">Role</label>
                  <select id="editRole" required>
                      <option value="admin">Administrator</option>
                      <option value="teacher">Teacher</option>
                      <option value="staff">Staff Member</option>
                      <option value="registrar">Registrar</option>
                  </select>
              </div>
              <div class="form-group">
                  <label for="editNewPassword">New Password (leave blank to keep current)</label>
                  <input type="password" id="editNewPassword" placeholder="Enter new password">
              </div>
              <div class="form-group">
                  <button type="submit" class="btn btn-primary" id="updateAccountBtn">Update Account</button>
                  <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
              </div>
          </form>
      </div>
  </div>

  <script>
      // Firebase Configuration
      const firebaseConfig = {
          apiKey: "AIzaSyDdx6QyXzCWz7BRZInLu16LGnYBKvFO1CM",
          authDomain: "tnl-management-app.firebaseapp.com",
          projectId: "tnl-management-app",
          storageBucket: "tnl-management-app.appspot.com",
          messagingSenderId: "590918430866",
          appId: "1:590918430866:web:123456789abcdef"
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // User session management
      let currentUser = {
          username: '',
          role: '',
          loginTime: null
      };

      // Initialize with only admin account
      let userAccounts = {
          'admin': { 
              password: 'admin123', 
              role: 'admin', 
              fullAccess: true,
              fullName: 'System Administrator',
              created: new Date().toISOString()
          }
      };

      // Save accounts to Firestore
      async function saveAccountToFirestore(username, accountData) {
          try {
              await db.collection('userAccounts').doc(username).set({
                  ...accountData,
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
              });
              console.log('Account saved to Firestore:', username);
          } catch (error) {
              console.error('Error saving to Firestore:', error);
              throw error;
          }
      }

      // Load accounts from Firestore
      async function loadAccountsFromFirestore() {
          try {
              const snapshot = await db.collection('userAccounts').get();
              const firestoreAccounts = {};
              
              snapshot.forEach(doc => {
                  const data = doc.data();
                  firestoreAccounts[doc.id] = {
                      password: data.password,
                      role: data.role,
                      fullName: data.fullName,
                      fullAccess: data.fullAccess || data.role === 'admin',
                      created: data.created
                  };
              });

                            // Merge with local accounts (admin account takes precedence)
              userAccounts = { ...firestoreAccounts, ...userAccounts };
              
              console.log('Accounts loaded from Firestore');
              return true;
          } catch (error) {
              console.error('Error loading from Firestore:', error);
              // Fall back to localStorage if Firestore fails
              return loadAccountsFromLocalStorage();
          }
      }

      // Delete account from Firestore
      async function deleteAccountFromFirestore(username) {
          try {
              await db.collection('userAccounts').doc(username).delete();
              console.log('Account deleted from Firestore:', username);
          } catch (error) {
              console.error('Error deleting from Firestore:', error);
              throw error;
          }
      }

      // Fallback: Save accounts to localStorage
      function saveAccountsToLocalStorage() {
          try {
              localStorage.setItem('schoolManagementAccounts', JSON.stringify(userAccounts));
          } catch (error) {
              console.error('Error saving to localStorage:', error);
          }
      }

      // Fallback: Load accounts from localStorage
      function loadAccountsFromLocalStorage() {
          try {
              const saved = localStorage.getItem('schoolManagementAccounts');
              if (saved) {
                  const localAccounts = JSON.parse(saved);
                  userAccounts = { ...userAccounts, ...localAccounts };
                  return true;
              }
          } catch (error) {
              console.error('Error loading from localStorage:', error);
          }
          return false;
      }

      // Initialize the app
      async function initializeApp() {
          try {
              // Try to load from Firestore first
              await loadAccountsFromFirestore();
          } catch (error) {
              console.error('Failed to initialize with Firestore, using localStorage fallback');
              loadAccountsFromLocalStorage();
          }
      }

      // Handle login form submission
      function handleLogin(event) {
          event.preventDefault();
          
          const username = document.getElementById('username').value.toLowerCase();
          const password = document.getElementById('password').value;
          
          const errorMsg = document.getElementById('error-message');
          const successMsg = document.getElementById('success-message');
          
          // Hide previous messages
          errorMsg.style.display = 'none';
          successMsg.style.display = 'none';
          
          // Validate credentials
          if (userAccounts[username] && userAccounts[username].password === password) {
              
              // Successful login
              currentUser = {
                  username: username,
                  role: userAccounts[username].role,
                  loginTime: new Date(),
                  fullAccess: userAccounts[username].fullAccess || userAccounts[username].role === 'admin'
              };
              
              successMsg.style.display = 'block';
              
              // Delay transition to main app
              setTimeout(() => {
                  showMainApp();
              }, 1500);
              
          } else {
              // Failed login
              errorMsg.style.display = 'block';
          }
          
          return false;
      }

      // Show main application after successful login
      function showMainApp() {
          document.getElementById('login-screen').style.display = 'none';
          document.getElementById('main-app').style.display = 'flex';
          
          // Update header info
          document.getElementById('current-user').textContent = `User: ${currentUser.username}`;
          document.getElementById('current-role').textContent = `Role: ${currentUser.role}`;
          document.getElementById('login-time').textContent = `Login: ${currentUser.loginTime.toLocaleTimeString()}`;
          
          // Show/hide admin-only features
          toggleAdminFeatures(currentUser.fullAccess);
          
          // Load accounts table if admin
          if (currentUser.fullAccess) {
              loadAccountsTable();
          }
          
          // Show home module by default
          showModule('home');
      }

      // Toggle admin-only features visibility
      function toggleAdminFeatures(showAdmin) {
          const adminElements = document.querySelectorAll('.admin-only');
          adminElements.forEach(element => {
              if (showAdmin) {
                  element.classList.add('show');
              } else {
                  element.classList.remove('show');
              }
          });
      }

      // Show specific module
      function showModule(moduleName) {
          // Hide all modules
          const modules = document.querySelectorAll('.module-content');
          modules.forEach(module => {
              module.classList.remove('active');
          });
          
          // Remove active class from all nav links
          const navLinks = document.querySelectorAll('.nav-link');
          navLinks.forEach(link => {
              link.classList.remove('active');
          });
          
          // Show selected module
          const selectedModule = document.getElementById(moduleName);
          if (selectedModule) {
              selectedModule.classList.add('active');
              
              // Add active class to corresponding nav link
              const navLink = document.querySelector(`[onclick="showModule('${moduleName}')"]`);
              if (navLink) {
                  navLink.classList.add('active');
              }
              
              // Load iframe if needed
              if (['admission', 'students', 'courses', 'tuition'].includes(moduleName)) {
                  loadModuleIframe(moduleName);
              }
          }
      }

      // Load module iframe
      function loadModuleIframe(moduleName) {
          const moduleDiv = document.getElementById(moduleName);
          const iframe = moduleDiv.querySelector('.module-frame');
          const loading = moduleDiv.querySelector('.loading');
          
          if (iframe && loading && iframe.style.display === 'none') {
              // Show iframe and hide loading after a short delay
              setTimeout(() => {
                  loading.style.display = 'none';
                  iframe.style.display = 'block';
              }, 1000);
          }
      }

      // Create new account
      async function createAccount(event) {
          event.preventDefault();
          
          const username = document.getElementById('newUsername').value.toLowerCase();
          const password = document.getElementById('newPassword').value;
          const role = document.getElementById('newRole').value;
          const fullName = document.getElementById('newFullName').value;
          
          const createBtn = document.getElementById('createAccountBtn');
          const originalText = createBtn.textContent;
          
          // Disable button and show loading
          createBtn.disabled = true;
          createBtn.textContent = 'Creating...';
          
          try {
              // Check if username already exists
              if (userAccounts[username]) {
                  showAccountMessage('Username already exists. Please choose a different username.', 'error');
                  return false;
              }
              
              // Validate inputs
              if (username.length < 3) {
                  showAccountMessage('Username must be at least 3 characters long.', 'error');
                  return false;
              }
              
              if (password.length < 6) {
                  showAccountMessage('Password must be at least 6 characters long.', 'error');
                  return false;
              }
              
              // Create new account object
              const accountData = {
                  password: password,
                  role: role,
                  fullName: fullName,
                  fullAccess: role === 'admin',
                  created: new Date().toISOString()
              };
              
              // Save to Firestore first
              await saveAccountToFirestore(username, accountData);
              
              // Add to local accounts
              userAccounts[username] = accountData;
              
              // Also save to localStorage as backup
              saveAccountsToLocalStorage();
              
              // Show success message
              showAccountMessage(`Account created successfully for ${fullName} (${username}).`, 'success');
              
              // Clear form
              document.getElementById('newUsername').value = '';
              document.getElementById('newPassword').value = '';
              document.getElementById('newRole').value = '';
              document.getElementById('newFullName').value = '';
              
              // Reload accounts table
              loadAccountsTable();
              
          } catch (error) {
              console.error('Error creating account:', error);
              showAccountMessage('Failed to create account. Please try again.', 'error');
          } finally {
              // Re-enable button
              createBtn.disabled = false;
              createBtn.textContent = originalText;
          }
          
          return false;
      }

      // Show account message
      function showAccountMessage(message, type) {
          const messageDiv = document.getElementById('account-message');
          messageDiv.textContent = message;
          messageDiv.style.display = 'block';
          
          if (type === 'error') {
              messageDiv.style.backgroundColor = '#fee';
              messageDiv.style.color = '#c33';
              messageDiv.style.borderLeft = '4px solid #e74c3c';
          } else {
              messageDiv.style.backgroundColor = '#efe';
              messageDiv.style.color = '#363';
              messageDiv.style.borderLeft = '4px solid #27ae60';
          }
          
          // Hide message after 5 seconds
          setTimeout(() => {
              messageDiv.style.display = 'none';
          }, 5000);
      }

      // Load accounts table
      async function loadAccountsTable() {
          const tbody = document.getElementById('accounts-tbody');
          const loadingDiv = document.getElementById('accounts-loading');
          
          // Show loading
          loadingDiv.style.display = 'flex';
          tbody.innerHTML = '';
          
          try {
              // Reload from Firestore to get latest data
              await loadAccountsFromFirestore();
              
              Object.keys(userAccounts).forEach(username => {
                  const account = userAccounts[username];
                  const row = document.createElement('tr');
                  
                  const createdDate = new Date(account.created).toLocaleDateString();
                  
                  row.innerHTML = `
                      <td>${username}</td>
                      <td>${account.fullName}</td>
                      <td><span class="role-badge role-${account.role}">${account.role.charAt(0).toUpperCase() + account.role.slice(1)}</span></td>
                      <td>${createdDate}</td>
                      <td>
                          <button class="btn btn-secondary" onclick="editAccount('${username}')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem; margin-right: 0.25rem;">Edit</button>
                          ${username !== 'admin' ? `<button class="btn btn-danger" onclick="deleteAccount('${username}')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">Delete</button>` : ''}
                      </td>
                  `;
                  
                  tbody.appendChild(row);
              });
              
          } catch (error) {
              console.error('Error loading accounts table:', error);
              showAccountMessage('Failed to load accounts. Please refresh the page.', 'error');
          } finally {
              // Hide loading
              loadingDiv.style.display = 'none';
          }
      }

      // Edit account
      function editAccount(username) {
          const account = userAccounts[username];
          if (!account) return;
          
          document.getElementById('editUsername').value = username;
          document.getElementById('editFullName').value = account.fullName;
          document.getElementById('editRole').value = account.role;
          document.getElementById('editNewPassword').value = '';
          
          document.getElementById('editModal').style.display = 'block';
      }

      // Update account
      async function updateAccount(event) {
          event.preventDefault();
          
          const username = document.getElementById('editUsername').value;
          const fullName = document.getElementById('editFullName').value;
          const role = document.getElementById('editRole').value;
          const newPassword = document.getElementById('editNewPassword').value;
          
          const updateBtn = document.getElementById('updateAccountBtn');
          const originalText = updateBtn.textContent;
          
          // Disable button and show loading
          updateBtn.disabled = true;
          updateBtn.textContent = 'Updating...';
          
          try {
              if (!userAccounts[username]) {
                  alert('Account not found.');
                  return false;
              }
              
              // Update account data
              const updatedAccount = {
                  ...userAccounts[username],
                  fullName: fullName,
                  role: role,
                  fullAccess: role === 'admin'
              };
              
              if (newPassword.trim()) {
                  if (newPassword.length < 6) {
                      alert('Password must be at least 6 characters long.');
                      return false;
                  }
                  updatedAccount.password = newPassword;
              }
              
              // Save to Firestore
              await saveAccountToFirestore(username, updatedAccount);
              
              // Update local accounts
              userAccounts[username] = updatedAccount;
              
              // Also save to localStorage as backup
              saveAccountsToLocalStorage();
              
              // Close modal
              closeEditModal();
              
              // Show success message
              showAccountMessage(`Account updated successfully for ${fullName}.`, 'success');
              
              // Reload accounts table
              loadAccountsTable();
              
          } catch (error) {
              console.error('Error updating account:', error);
              alert('Failed to update account. Please try again.');
          } finally {
              // Re-enable button
              updateBtn.disabled = false;
              updateBtn.textContent = originalText;
          }
          
          return false;
      }

      // Delete account
      async function deleteAccount(username) {
          if (username === 'admin') {
              alert('Cannot delete the admin account.');
              return;
          }
          
          if (confirm(`Are you sure you want to delete the account for ${userAccounts[username].fullName} (${username})?`)) {
              try {
                  // Delete from Firestore
                  await deleteAccountFromFirestore(username);
                  
                  // Delete from local accounts
                  delete userAccounts[username];
                  
                  // Also update localStorage
                  saveAccountsToLocalStorage();
                  
                  showAccountMessage(`Account deleted successfully.`, 'success');
                  loadAccountsTable();
                  
              } catch (error) {
                  console.error('Error deleting account:', error);
                  showAccountMessage('Failed to delete account. Please try again.', 'error');
              }
          }
      }

      // Close edit modal
      function closeEditModal() {
          document.getElementById('editModal').style.display = 'none';
      }

      // Logout function
      function logout() {
          if (confirm('Are you sure you want to logout?')) {
              currentUser = { username: '', role: '', loginTime: null };
              document.getElementById('main-app').style.display = 'none';
              document.getElementById('login-screen').style.display = 'flex';
              
              // Clear login form
              document.getElementById('username').value = '';
              document.getElementById('password').value = '';
              
              // Hide any messages
              document.getElementById('error-message').style.display = 'none';
              document.getElementById('success-message').style.display = 'none';
          }
      }

      // Close modal when clicking outside
      window.onclick = function(event) {
          const modal = document.getElementById('editModal');
          if (event.target === modal) {
              closeEditModal();
          }
      }

      // Initialize app when page loads
      window.onload = async function() {
          await initializeApp();
      }
  </script>
</body>
</html>