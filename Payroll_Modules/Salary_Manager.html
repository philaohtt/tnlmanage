<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Salary Manager</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&amp;display=swap" rel="stylesheet"><!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .status-draft { background: #F3F4F6; color: #6B7280; border: 1px solid #D1D5DB; }
    .status-finalized { background: #ECFDF5; color: #047857; border: 1px solid #A7F3D0; }
    .status-approved { background: #EFF6FF; color: #1D4ED8; border: 1px solid #BFDBFE; }
    .badge-ok { background: #ECFDF5; color: #047857; }
    .badge-missing { background: #FEF2F2; color: #B91C1C; }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full overflow-auto"></div>
  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCDzv0HseeLfijzyXZjKWFh9QaLrMB4afo",
      authDomain: "tnl2026.firebaseapp.com",
      projectId: "tnl2026",
      storageBucket: "tnl2026.firebasestorage.app",
      messagingSenderId: "883525152224",
      appId: "1:883525152224:web:619ae152cd8df3fcca8f85"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // State
    let staff = [];
    let allTimesheets = []; // All timesheets across all periods
    let allSalaries = []; // All salaries across all periods
    let allSalaryRuns = []; // All salary runs
    let selectedStaff = null;
    let isLoading = false;
    let unsubscribers = [];
    let tempAdjustments = {}; // Store temporary adjustments before generating salaries
    let selectedPeriod = null; // { year, month } for filtering when needed
    let activeTab = 'salaries'; // 'salaries' or 'banking'

    const defaultConfig = {
      module_title: 'Salary Manager',
      company_name: 'Your Company',
      primary_color: '#111827',
      secondary_color: '#6B7280',
      background_color: '#FFFFFF',
      text_color: '#374151',
      accent_color: '#2563EB'
    };

    // Element SDK
    async function onConfigChange(config) {
      render();
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.primary_color || defaultConfig.primary_color,
            set: (value) => window.elementSdk?.setConfig({ primary_color: value })
          },
          {
            get: () => config.secondary_color || defaultConfig.secondary_color,
            set: (value) => window.elementSdk?.setConfig({ secondary_color: value })
          },
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => window.elementSdk?.setConfig({ background_color: value })
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => window.elementSdk?.setConfig({ text_color: value })
          },
          {
            get: () => config.accent_color || defaultConfig.accent_color,
            set: (value) => window.elementSdk?.setConfig({ accent_color: value })
          }
        ],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ['module_title', config.module_title || defaultConfig.module_title],
        ['company_name', config.company_name || defaultConfig.company_name]
      ]);
    }

    // Helpers
    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN').format(amount || 0);
    }

    function getSalaryDocId(staffId) {
      return `SAL_${staffId}_${selectedYear}_${String(selectedMonth).padStart(2, '0')}`;
    }

    function getSalaryRunId() {
      return `SAL_${selectedYear}_${String(selectedMonth).padStart(2, '0')}`;
    }

    function hasBanking(s) {
      return s.banking?.bankCode && s.banking?.accountNumber && s.banking?.accountName;
    }

    function showToast(msg, type = 'info') {
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : '#3B82F6';
      toast.className = 'fixed top-4 right-4 px-4 py-2 rounded-lg text-white text-sm font-medium shadow-lg z-50';
      toast.style.background = bgColor;
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Firestore Operations
    async function loadData() {
      console.log('[Load] Loading all data across all periods');
      isLoading = true;
      render();

      // Unsubscribe previous listeners
      unsubscribers.forEach(unsub => unsub());
      unsubscribers = [];

      try {
        // Load active staff
        const staffUnsub = db.collection('staff')
          .where('status', '==', 'active')
          .onSnapshot(snap => {
            staff = snap.docs.map(doc => {
              const data = doc.data();
              return {
                id: data.staffId || doc.id, // Use staffId field, fallback to doc ID
                docId: doc.id, // Keep original doc ID for updates
                ...data
              };
            });
            console.log(`[Staff] Loaded ${staff.length} active staff`);
            render();
          });
        unsubscribers.push(staffUnsub);

        // Load ALL approved timesheets
        const tsUnsub = db.collection('timesheets')
          .where('status', '==', 'approved')
          .onSnapshot(snap => {
            allTimesheets = snap.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            console.log(`[Timesheets] Loaded ${allTimesheets.length} approved timesheets`);
            render();
          });
        unsubscribers.push(tsUnsub);

        // Load ALL salary runs
        const runUnsub = db.collection('salaryRuns')
          .onSnapshot(snap => {
            allSalaryRuns = snap.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            console.log(`[SalaryRuns] Loaded ${allSalaryRuns.length} salary runs`);
            render();
          });
        unsubscribers.push(runUnsub);

        // Load ALL salaries
        const salUnsub = db.collection('salaries')
          .onSnapshot(snap => {
            allSalaries = snap.docs.map(doc => ({
              id: doc.id,
              ...doc.data()
            }));
            console.log(`[Salaries] Loaded ${allSalaries.length} salary records`);
            render();
          });
        unsubscribers.push(salUnsub);

        showToast('Data loaded successfully', 'success');
        
        // Auto-generate salaries for all periods
        await autoGenerateAllPeriods();
      } catch (error) {
        console.error('[Load Error]', error);
        showToast('Failed to load data: ' + error.message, 'error');
      } finally {
        isLoading = false;
        render();
      }
    }

    async function autoGenerateAllPeriods() {
      console.log('[Auto-Generate] Processing all periods...');

      // Get unique periods from timesheets
      const periods = new Set();
      allTimesheets.forEach(ts => {
        periods.add(`${ts.year}_${ts.month}`);
      });

      for (const period of periods) {
        const [year, month] = period.split('_').map(Number);
        const salaryRun = allSalaryRuns.find(r => r.year === year && r.month === month);
        
        if (!salaryRun || salaryRun.status !== 'finalized') {
          await generateSalariesForPeriod(year, month);
          await generateQRForPeriod(year, month);
        }
      }
    }

    async function generateSalariesForPeriod(year, month) {
      console.log(`[Generate] Creating salary records for ${year}-${month}...`);

      try {
        const batch = db.batch();
        const runId = `SAL_${year}_${String(month).padStart(2, '0')}`;
        const salaryRun = allSalaryRuns.find(r => r.year === year && r.month === month);

        // Create/update salary run
        const runRef = db.collection('salaryRuns').doc(runId);
        if (!salaryRun) {
          batch.set(runRef, {
            year: year,
            month: month,
            status: 'draft',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        } else {
          batch.update(runRef, {
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        // Generate salary for each active staff
        for (const s of staff) {
          const ts = allTimesheets.find(t => t.staffId === s.id && t.year === year && t.month === month);
          const gross = ts?.totalPay || 0;
          const salDocId = `SAL_${s.id}_${year}_${String(month).padStart(2, '0')}`;
          const existing = allSalaries.find(sal => sal.id === salDocId);
          
          // Use temporary adjustments if they exist, otherwise use existing
          const adjustments = tempAdjustments[`${s.id}_${year}_${month}`] || existing?.adjustments || [];

          const salaryData = {
            staffId: s.id,
            year: year,
            month: month,
            timesheetId: ts?.id || null,
            gross: gross,
            adjustments: adjustments,
            bonusTotal: 0,
            deductionTotal: 0,
            net: gross,
            bankingSnapshot: {
              bankCode: s.banking?.bankCode || '',
              accountNumber: s.banking?.accountNumber || '',
              accountName: s.banking?.accountName || ''
            },
            qr: existing?.qr || null,
            isPaid: existing?.isPaid || false,
            paidAt: existing?.paidAt || null,
            paidBy: existing?.paidBy || null,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };

          // Calculate totals from adjustments
          if (salaryData.adjustments.length > 0) {
            salaryData.bonusTotal = salaryData.adjustments
              .filter(a => a.type === 'bonus')
              .reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
            salaryData.deductionTotal = salaryData.adjustments
              .filter(a => a.type === 'deduction')
              .reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
            salaryData.net = Math.max(0, gross + salaryData.bonusTotal - salaryData.deductionTotal);
          }

          const salRef = db.collection('salaries').doc(salDocId);
          if (existing) {
            batch.update(salRef, salaryData);
          } else {
            salaryData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            batch.set(salRef, salaryData);
          }
        }

        await batch.commit();
        
        // Clear temporary adjustments for this period
        Object.keys(tempAdjustments).forEach(key => {
          if (key.includes(`_${year}_${month}`)) {
            delete tempAdjustments[key];
          }
        });
        
        console.log(`[Generate] Created/updated ${staff.length} salary records for ${year}-${month}`);
      } catch (error) {
        console.error('[Generate Error]', error);
        throw error;
      }
    }

    async function generateQRForPeriod(year, month) {
      console.log(`[QR] Generating QR codes for ${year}-${month}...`);

      try {
        const batch = db.batch();
        let count = 0;

        const periodSalaries = allSalaries.filter(s => s.year === year && s.month === month);

        for (const sal of periodSalaries) {
          if (sal.net > 0 && sal.bankingSnapshot?.bankCode && sal.bankingSnapshot?.accountNumber && !sal.qr?.payload) {
            const vietqrPayload = generateVietQRPayload(
              sal.bankingSnapshot.bankCode,
              sal.bankingSnapshot.accountNumber,
              sal.net,
              `Salary ${month}/${year}`
            );

            const salRef = db.collection('salaries').doc(sal.id);
            batch.update(salRef, {
              qr: {
                format: 'vietqr',
                payload: vietqrPayload
              },
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            count++;
          }
        }

        if (count > 0) {
          await batch.commit();
          console.log(`[QR] Generated ${count} QR codes for ${year}-${month}`);
        }
      } catch (error) {
        console.error('[QR Error]', error);
        throw error;
      }
    }

    function generateVietQRPayload(bankCode, accountNumber, amount, message) {
      const template = 'compact2';
      const encodedMsg = encodeURIComponent(message);
      return `https://api.vietqr.io/image/${bankCode}-${accountNumber}-${template}.jpg?amount=${Math.round(amount)}&addInfo=${encodedMsg}`;
    }

    async function finalizePeriod(year, month) {
      const runId = `SAL_${year}_${String(month).padStart(2, '0')}`;
      const salaryRun = allSalaryRuns.find(r => r.year === year && r.month === month);

      if (!salaryRun) {
        showToast('No salary run to finalize', 'error');
        return;
      }

      if (salaryRun.status === 'finalized') {
        showToast('Already finalized', 'error');
        return;
      }

      console.log(`[Finalize] Locking period ${year}-${month}...`);
      isLoading = true;
      render();

      try {
        await db.collection('salaryRuns').doc(runId).update({
          status: 'finalized',
          finalizedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log('[Finalize] Period locked');
        showToast(`Period ${month}/${year} finalized successfully`, 'success');
      } catch (error) {
        console.error('[Finalize Error]', error);
        showToast('Failed to finalize: ' + error.message, 'error');
      } finally {
        isLoading = false;
      }
    }

    async function saveBanking(staffId, banking) {
      console.log(`[Banking] Saving for ${staffId}`, banking);
      isLoading = true;
      render();

      try {
        // Find the document ID for this staff member
        const staffMember = staff.find(s => s.id === staffId);
        const docId = staffMember?.docId || staffId;
        
        await db.collection('staff').doc(docId).update({
          banking: banking,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        console.log('[Banking] Saved');
        showToast('Banking details saved', 'success');
      } catch (error) {
        console.error('[Banking Error]', error);
        showToast('Failed to save banking: ' + error.message, 'error');
      } finally {
        isLoading = false;
      }
    }

    async function saveSalary(staffId, year, month, adjustments, transferReference) {
      const salaryRun = allSalaryRuns.find(r => r.year === year && r.month === month);
      
      if (salaryRun?.status === 'finalized') {
        showToast('Period is finalized. Cannot edit.', 'error');
        return;
      }

      console.log(`[Salary] Saving for ${staffId} ${year}-${month}`, adjustments);
      isLoading = true;
      render();

      try {
        const salDocId = `SAL_${staffId}_${year}_${String(month).padStart(2, '0')}`;
        const sal = allSalaries.find(s => s.id === salDocId);
        const gross = sal?.gross || 0;

        const bonusTotal = adjustments
          .filter(a => a.type === 'bonus')
          .reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
        const deductionTotal = adjustments
          .filter(a => a.type === 'deduction')
          .reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
        const net = Math.max(0, gross + bonusTotal - deductionTotal);

        await db.collection('salaries').doc(salDocId).update({
          adjustments: adjustments,
          bonusTotal: bonusTotal,
          deductionTotal: deductionTotal,
          net: net,
          transferReference: transferReference,
          qr: null, // Reset QR when transfer reference changes
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Regenerate QR with new transfer reference
        await generateQRForPeriod(year, month);

        console.log('[Salary] Saved', { bonusTotal, deductionTotal, net });
        showToast('Salary saved', 'success');
        selectedStaff = null;
        selectedPeriod = null;
        render();
      } catch (error) {
        console.error('[Salary Error]', error);
        showToast('Failed to save salary: ' + error.message, 'error');
      } finally {
        isLoading = false;
      }
    }

    async function saveTempAdjustments(staffId, year, month, adjustments) {
      const key = `${staffId}_${year}_${month}`;
      tempAdjustments[key] = adjustments;
      console.log('[Temp] Saved adjustments for', key, adjustments);
      showToast('Adjustments saved', 'success');
      selectedStaff = null;
      selectedPeriod = null;
      render();
      
      // Auto-generate salaries for this period
      await generateSalariesForPeriod(year, month);
      await generateQRForPeriod(year, month);
    }

    async function togglePaid(staffId, year, month, isPaid) {
      const salDocId = `SAL_${staffId}_${year}_${String(month).padStart(2, '0')}`;
      console.log(`[Paid] Toggle ${salDocId} to ${isPaid}`);
      isLoading = true;
      render();

      try {
        const updateData = {
          isPaid: isPaid,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        if (isPaid) {
          updateData.paidAt = firebase.firestore.FieldValue.serverTimestamp();
          updateData.paidBy = 'ADMIN';
        } else {
          updateData.paidAt = null;
          updateData.paidBy = null;
        }

        await db.collection('salaries').doc(salDocId).update(updateData);
        console.log('[Paid] Updated');
      } catch (error) {
        console.error('[Paid Error]', error);
        showToast('Failed to update paid status: ' + error.message, 'error');
      } finally {
        isLoading = false;
      }
    }

    // Helper to render adjustments list HTML
    function renderAdjustmentsList(adjustments, config, canEdit) {
      if (adjustments.length === 0) {
        return `
          <div class="col-span-full text-center py-8 border border-dashed rounded-lg" style="border-color: #D1D5DB;">
            <p class="text-sm" style="color: ${config.text_color}; opacity: 0.5;">No adjustments yet</p>
          </div>
        `;
      }

      return adjustments.map((adj, i) => `
        <div class="p-4 rounded-lg border space-y-3 ${adj.type === 'bonus' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
          <div class="flex items-center gap-2">
            <select data-index="${i}" data-field="type" class="px-3 py-2 border rounded-lg text-sm font-medium flex-1 bg-white" style="border-color: #E5E7EB;" ${!canEdit ? 'disabled' : ''}>
              <option value="bonus" ${adj.type === 'bonus' ? 'selected' : ''}>+ Bonus</option>
              <option value="deduction" ${adj.type === 'deduction' ? 'selected' : ''}>− Deduction</option>
            </select>
            <button onclick="removeAdjustment(${i})" class="w-8 h-8 rounded-lg border text-sm font-medium hover:bg-white" style="border-color: #E5E7EB; color: ${config.text_color};" ${!canEdit ? 'disabled' : ''}>✕</button>
          </div>
          <div>
            <label class="block text-xs font-medium mb-1" style="color: ${config.text_color};">Description</label>
            <input type="text" data-index="${i}" data-field="label" value="${adj.label || ''}" placeholder="e.g., Performance bonus, Late penalty" class="w-full px-3 py-2 border rounded-lg text-sm" style="border-color: #E5E7EB;" ${!canEdit ? 'disabled' : ''}>
          </div>
          <div>
            <label class="block text-xs font-medium mb-1" style="color: ${config.text_color};">Amount (VND)</label>
            <input type="number" data-index="${i}" data-field="amount" value="${adj.amount || 0}" step="1000" placeholder="0" class="w-full px-3 py-2 border rounded-lg text-sm font-medium" style="border-color: #E5E7EB;" ${!canEdit ? 'disabled' : ''}>
          </div>
        </div>
      `).join('');
    }

    // Helper to update salary summary values
    function updateSalarySummary() {
      if (!selectedStaff || !selectedPeriod) return;

      const { year, month } = selectedPeriod;
      const salDocId = `SAL_${selectedStaff.id}_${year}_${String(month).padStart(2, '0')}`;
      const sal = allSalaries.find(s => s.id === salDocId);
      const ts = allTimesheets.find(t => t.staffId === selectedStaff.id && t.year === year && t.month === month);
      const tempKey = `${selectedStaff.id}_${year}_${month}`;
      
      const adjustments = sal?.adjustments || tempAdjustments[tempKey] || [];
      const gross = ts?.totalPay || 0;
      
      const bonusTotal = adjustments
        .filter(a => a.type === 'bonus')
        .reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
      const deductionTotal = adjustments
        .filter(a => a.type === 'deduction')
        .reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
      const net = Math.max(0, gross + bonusTotal - deductionTotal);

      // Update summary values
      const summaryBonus = document.getElementById('summaryBonus');
      const summaryDeduction = document.getElementById('summaryDeduction');
      const summaryNet = document.getElementById('summaryNet');

      if (summaryBonus) summaryBonus.textContent = `+${formatCurrency(bonusTotal)}`;
      if (summaryDeduction) summaryDeduction.textContent = `-${formatCurrency(deductionTotal)}`;
      if (summaryNet) summaryNet.textContent = formatCurrency(net);
    }

    // Render
    function render() {
      const config = window.elementSdk?.config || defaultConfig;
      const app = document.getElementById('app');

      app.innerHTML = `
        <div class="min-h-full w-full" style="background: ${config.background_color};">
          <!-- Header with Tabs -->
          <div class="bg-white border-b" style="border-color: #E5E7EB;">
            <div class="px-6 py-4">
              <h1 class="text-xl font-bold mb-4" style="color: ${config.primary_color};">${config.module_title}</h1>
              <div class="flex gap-2">
                <button onclick="switchTab('salaries')" class="px-4 py-2 rounded-lg font-medium text-sm transition-colors ${activeTab === 'salaries' ? 'text-white' : ''}" style="background: ${activeTab === 'salaries' ? config.primary_color : 'transparent'}; color: ${activeTab === 'salaries' ? '#FFFFFF' : config.text_color};">
                  Salary Management
                </button>
                <button onclick="switchTab('banking')" class="px-4 py-2 rounded-lg font-medium text-sm transition-colors ${activeTab === 'banking' ? 'text-white' : ''}" style="background: ${activeTab === 'banking' ? config.primary_color : 'transparent'}; color: ${activeTab === 'banking' ? '#FFFFFF' : config.text_color};">
                  Banking Details
                </button>
              </div>
            </div>
          </div>

          <!-- Main Content -->
          <div class="px-6 py-6">
            ${activeTab === 'salaries' ? renderAllPeriods(config) : renderBankingTab(config)}
          </div>

          <!-- Side Panel -->
          ${selectedStaff && selectedPeriod ? renderSidePanel(config) : ''}
        </div>
      `;

      attachListeners();
    }

    function renderBankingTab(config) {
      if (staff.length === 0) {
        return `
          <div class="bg-white rounded-lg border p-8 text-center" style="border-color: #E5E7EB;">
            <p class="text-sm font-medium mb-1" style="color: ${config.text_color};">No active staff found</p>
            <p class="text-sm" style="color: ${config.text_color}; opacity: 0.5;">Waiting for data to load...</p>
          </div>
        `;
      }

      return `
        <div class="bg-white rounded-lg border overflow-hidden" style="border-color: #E5E7EB;">
          <div class="px-5 py-4 border-b bg-gradient-to-r from-blue-50 to-indigo-50" style="border-color: #E5E7EB;">
            <h3 class="text-lg font-semibold" style="color: ${config.primary_color};">Staff Banking Information</h3>
            <p class="text-xs mt-1" style="color: ${config.text_color}; opacity: 0.6;">Manage bank account details for salary payments</p>
          </div>
          
          <div class="p-5">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              ${staff.map(s => {
                const banking = hasBanking(s);
                return `
                  <div class="border rounded-lg p-5 hover:border-blue-400 hover:shadow-lg transition-all" style="border-color: ${banking ? '#A7F3D0' : '#FEE2E2'}; background: ${banking ? '#ECFDF5' : '#FEF2F2'};">
                    <div class="flex items-start justify-between mb-4">
                      <div class="flex-1">
                        <div class="font-semibold text-base" style="color: ${config.text_color};">${s.fullName || s.preferredName || 'Unknown'}</div>
                        <div class="text-xs mt-1" style="color: ${config.text_color}; opacity: 0.5;">${s.id}</div>
                      </div>
                      <span class="px-3 py-1.5 rounded-lg text-xs font-medium ${banking ? 'bg-green-600' : 'bg-red-600'} text-white shadow-sm">
                        ${banking ? '✓ Complete' : '✗ Missing'}
                      </span>
                    </div>
                    
                    ${banking ? `
                      <div class="space-y-2 text-sm mb-4">
                        <div class="flex items-center gap-2">
                          <span style="color: ${config.text_color}; opacity: 0.6;">Bank Code:</span>
                          <span class="font-medium">${s.banking.bankCode}</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <span style="color: ${config.text_color}; opacity: 0.6;">Account:</span>
                          <span class="font-medium">${s.banking.accountNumber}</span>
                        </div>
                        <div class="flex items-center gap-2">
                          <span style="color: ${config.text_color}; opacity: 0.6;">Name:</span>
                          <span class="font-medium">${s.banking.accountName}</span>
                        </div>
                      </div>
                    ` : `
                      <div class="text-sm font-medium text-red-600 mb-4">
                        No banking details on file
                      </div>
                    `}
                    
                    <button onclick="openBankingModal('${s.id}')" class="w-full px-4 py-2 rounded-lg font-medium text-sm text-white transition-colors" style="background: ${config.primary_color};">
                      ${banking ? 'Edit Details' : 'Add Details'}
                    </button>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;
    }

    function renderAllPeriods(config) {
      if (staff.length === 0) {
        return `
          <div class="bg-white rounded-lg border p-8 text-center" style="border-color: #E5E7EB;">
            <p class="text-sm font-medium mb-1" style="color: ${config.text_color};">No active staff found</p>
            <p class="text-sm" style="color: ${config.text_color}; opacity: 0.5;">Waiting for data to load...</p>
          </div>
        `;
      }

      // Get all unique periods from timesheets and sort by year/month desc
      const periodsSet = new Set();
      allTimesheets.forEach(ts => {
        periodsSet.add(`${ts.year}_${ts.month}`);
      });
      
      const periods = Array.from(periodsSet)
        .map(p => {
          const [year, month] = p.split('_').map(Number);
          return { year, month };
        })
        .sort((a, b) => {
          if (a.year !== b.year) return b.year - a.year;
          return b.month - a.month;
        });

      if (periods.length === 0) {
        return `
          <div class="bg-white rounded-lg border p-8 text-center" style="border-color: #E5E7EB;">
            <p class="text-sm font-medium mb-1" style="color: ${config.text_color};">No salary periods yet</p>
            <p class="text-sm" style="color: ${config.text_color}; opacity: 0.5;">Salary records will appear here once timesheets are approved</p>
          </div>
        `;
      }

      // If a period is selected, show detailed view
      if (selectedPeriod && !selectedStaff) {
        return renderPeriodDetail(config, selectedPeriod.year, selectedPeriod.month);
      }

      // Otherwise show calendar view
      return renderCalendarView(config, periods);
    }

    function renderCalendarView(config, periods) {
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
      
      // Group periods by year
      const periodsByYear = {};
      periods.forEach(period => {
        if (!periodsByYear[period.year]) {
          periodsByYear[period.year] = [];
        }
        periodsByYear[period.year].push(period);
      });
      
      // Sort years descending
      const years = Object.keys(periodsByYear).map(Number).sort((a, b) => b - a);
      
      return `
        <div>
          <div class="space-y-4">
            ${years.map(year => {
              const yearPeriods = periodsByYear[year];
              const yearSalaries = allSalaries.filter(s => s.year === year);
              const yearTotal = yearSalaries.reduce((sum, s) => sum + (s.net || 0), 0);
              const yearPaidCount = yearSalaries.filter(s => s.isPaid).length;
              
              return `
                <div class="bg-white rounded-lg border overflow-hidden" style="border-color: #E5E7EB;">
                  <!-- Year Header -->
                  <div class="px-5 py-3 cursor-pointer hover:bg-gray-50 transition-colors border-b" style="border-color: #E5E7EB;" onclick="toggleYear(${year})">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <span id="yearIcon${year}" class="text-sm transition-transform" style="color: ${config.text_color}; opacity: 0.4;">▼</span>
                        <h3 class="text-lg font-semibold" style="color: ${config.primary_color};">${year}</h3>
                        <span class="text-xs px-2 py-1 rounded bg-gray-100" style="color: ${config.text_color};">
                          ${yearPeriods.length} ${yearPeriods.length === 1 ? 'month' : 'months'}
                        </span>
                      </div>
                      <div class="text-right">
                        <div class="text-base font-semibold" style="color: ${config.primary_color};">
                          ${formatCurrency(yearTotal)}
                        </div>
                        <div class="text-xs" style="color: ${config.text_color}; opacity: 0.5;">
                          ${yearPaidCount}/${yearSalaries.length} paid
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <!-- Months Grid -->
                  <div id="yearContent${year}" class="p-5">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3">
                      ${yearPeriods.map(period => {
                        const { month } = period;
                        const periodSalaries = allSalaries.filter(s => s.year === year && s.month === month);
                        const salaryRun = allSalaryRuns.find(r => r.year === year && r.month === month);
                        
                        const totalPay = periodSalaries.reduce((sum, s) => sum + (s.net || 0), 0);
                        const staffCount = periodSalaries.length;
                        const paidCount = periodSalaries.filter(s => s.isPaid).length;
                        
                        return `
                          <div onclick="selectPeriod(${year}, ${month})" 
                            class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg border border-blue-200 p-4 cursor-pointer hover:border-blue-400 hover:shadow-md transition-all" style="">
                            <div class="flex items-center justify-between mb-3">
                              <h4 class="text-sm font-semibold" style="color: ${config.primary_color};">
                                ${monthNames[month - 1]}
                              </h4>
                              ${salaryRun ? `
                                <span class="px-2 py-0.5 rounded text-xs font-medium status-${salaryRun.status}">
                                  ${salaryRun.status.toUpperCase()}
                                </span>
                              ` : ''}
                            </div>
                            
                            <div class="space-y-1.5 text-xs">
                              <div class="flex items-center justify-between">
                                <span style="color: ${config.text_color}; opacity: 0.6;">Total:</span>
                                <span class="font-semibold" style="color: ${config.primary_color};">
                                  ${formatCurrency(totalPay)}
                                </span>
                              </div>
                              
                              <div class="flex items-center justify-between">
                                <span style="color: ${config.text_color}; opacity: 0.6;">Staff:</span>
                                <span class="font-medium">${staffCount}</span>
                              </div>
                              
                              <div class="flex items-center justify-between">
                                <span style="color: ${config.text_color}; opacity: 0.6;">Paid:</span>
                                <span class="font-medium ${paidCount === staffCount && staffCount > 0 ? 'text-green-600' : 'text-orange-600'}">
                                  ${paidCount}/${staffCount}
                                </span>
                              </div>
                            </div>
                          </div>
                        `;
                      }).join('')}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function renderPeriodDetail(config, year, month) {
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                          'July', 'August', 'September', 'October', 'November', 'December'];
      
      const salaryRun = allSalaryRuns.find(r => r.year === year && r.month === month);
      const periodSalaries = allSalaries.filter(s => s.year === year && s.month === month);
      
      // Calculate totals for the period
      const totalGross = periodSalaries.reduce((sum, s) => sum + (s.gross || 0), 0);
      const totalBonuses = periodSalaries.reduce((sum, s) => sum + (s.bonusTotal || 0), 0);
      const totalDeductions = periodSalaries.reduce((sum, s) => sum + (s.deductionTotal || 0), 0);
      const totalNet = periodSalaries.reduce((sum, s) => sum + (s.net || 0), 0);
      const paidCount = periodSalaries.filter(s => s.isPaid).length;

      return `
        <div>
          <!-- Back Button -->
          <button onclick="backToCalendar()" class="mb-4 px-3 py-2 rounded-lg text-sm font-medium border" 
            style="color: ${config.text_color}; border-color: #E5E7EB;">
            ← Back
          </button>
          
          <div class="bg-white rounded-lg border overflow-hidden" style="border-color: #E5E7EB;">
            <!-- Period Header -->
            <div class="px-5 py-4 border-b flex items-center justify-between" style="border-color: #E5E7EB;">
              <div>
                <h2 class="text-lg font-semibold" style="color: ${config.primary_color};">
                  ${monthNames[month - 1]} ${year}
                </h2>
                <div class="flex items-center gap-3 mt-1 text-xs" style="color: ${config.text_color}; opacity: 0.6;">
                  <span>${periodSalaries.length} staff</span>
                  <span>•</span>
                  <span>${formatCurrency(totalNet)} total</span>
                  ${salaryRun ? `
                    <span>•</span>
                    <span class="px-2 py-0.5 rounded font-medium status-${salaryRun.status}">
                      ${salaryRun.status.toUpperCase()}
                    </span>
                  ` : ''}
                  <span>•</span>
                  <span>${paidCount}/${periodSalaries.length} paid</span>
                </div>
              </div>
              <button onclick="finalizePeriod(${year}, ${month})" 
                class="px-3 py-2 rounded-lg text-sm font-medium text-white bg-red-600 hover:bg-red-700" 
                ${isLoading || !salaryRun || salaryRun?.status === 'finalized' ? 'disabled' : ''}>
                Finalize Period
              </button>
            </div>

            <!-- Table -->
            <table class="w-full text-sm">
              <thead class="border-b bg-gray-50" style="border-color: #E5E7EB;">
                <tr>
                  <th class="px-4 py-2 text-left font-medium text-xs" style="color: ${config.text_color};">Staff</th>
                  <th class="px-4 py-2 text-center font-medium text-xs" style="color: ${config.text_color};">Banking</th>
                  <th class="px-4 py-2 text-right font-medium text-xs" style="color: ${config.text_color};">Gross</th>
                  <th class="px-4 py-2 text-right font-medium text-xs" style="color: ${config.text_color};">Bonuses</th>
                  <th class="px-4 py-2 text-right font-medium text-xs" style="color: ${config.text_color};">Deductions</th>
                  <th class="px-4 py-2 text-right font-medium text-xs" style="color: ${config.text_color};">Net</th>
                  <th class="px-4 py-2 text-center font-medium text-xs" style="color: ${config.text_color};">QR</th>
                  <th class="px-4 py-2 text-center font-medium text-xs" style="color: ${config.text_color};">Paid</th>
                </tr>
              </thead>
              <tbody>
                ${staff.map(s => {
                  const ts = allTimesheets.find(t => t.staffId === s.id && t.year === year && t.month === month);
                  const salDocId = `SAL_${s.id}_${year}_${String(month).padStart(2, '0')}`;
                  const sal = allSalaries.find(sal => sal.id === salDocId);
                  const tempKey = `${s.id}_${year}_${month}`;
                  const tempAdj = tempAdjustments[tempKey];
                  const banking = hasBanking(s);
                  
                  // Calculate values from either saved salary or temp adjustments
                  let gross = 0;
                  let bonusTotal = 0;
                  let deductionTotal = 0;
                  let net = 0;
                  
                  if (sal) {
                    gross = sal.gross;
                    bonusTotal = sal.bonusTotal;
                    deductionTotal = sal.deductionTotal;
                    net = sal.net;
                  } else if (tempAdj) {
                    gross = ts?.totalPay || 0;
                    bonusTotal = tempAdj.filter(a => a.type === 'bonus').reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
                    deductionTotal = tempAdj.filter(a => a.type === 'deduction').reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
                    net = Math.max(0, gross + bonusTotal - deductionTotal);
                  } else if (ts) {
                    gross = ts.totalPay || 0;
                    net = gross;
                  }
                  
                  // Only show row if there's a timesheet for this period
                  if (!ts && !sal) return '';
                  
                  return `
                    <tr class="border-b hover:bg-gray-50 cursor-pointer transition-colors" style="border-color: #E5E7EB;" onclick='openStaffForPeriod(${JSON.stringify(s)}, ${year}, ${month})'>
                      <td class="px-4 py-3">
                        <div class="font-medium text-xs" style="color: ${config.text_color};">${s.fullName || s.preferredName || 'Unknown'}</div>
                        <div class="text-xs" style="color: ${config.text_color}; opacity: 0.5;">${s.id}</div>
                        ${tempAdj ? '<div class="text-xs text-orange-600 font-medium mt-0.5">Unsaved</div>' : ''}
                      </td>
                      <td class="px-4 py-3 text-center">
                        <button onclick="event.stopPropagation(); openBankingModal('${s.id}')" class="px-2 py-1 rounded text-xs font-medium ${banking ? 'badge-ok hover:bg-green-100' : 'badge-missing hover:bg-red-100'} transition-colors">
                          ${banking ? '✓ Edit' : '✗ Add'}
                        </button>
                      </td>
                      <td class="px-4 py-3 text-right font-medium" style="color: ${config.text_color};">
                        ${formatCurrency(gross)}
                      </td>
                      <td class="px-4 py-3 text-right font-medium text-green-600">
                        ${bonusTotal > 0 ? '+' + formatCurrency(bonusTotal) : '-'}
                      </td>
                      <td class="px-4 py-3 text-right font-medium text-red-600">
                        ${deductionTotal > 0 ? '-' + formatCurrency(deductionTotal) : '-'}
                      </td>
                      <td class="px-4 py-3 text-right font-semibold" style="color: ${config.primary_color};">
                        ${formatCurrency(net)}
                      </td>
                      <td class="px-4 py-3 text-center">
                        ${sal?.qr?.payload ? `
                          <button onclick="event.stopPropagation(); viewQR('${s.id}', ${year}, ${month})" class="px-2 py-1 rounded text-white text-xs font-medium bg-blue-600 hover:bg-blue-700">
                            View
                          </button>
                        ` : '<span class="text-xs" style="opacity: 0.3;">-</span>'}
                      </td>
                      <td class="px-4 py-3 text-center">
                        ${sal ? `<input type="checkbox" ${sal.isPaid ? 'checked' : ''} onclick="event.stopPropagation(); togglePaid('${s.id}', ${year}, ${month}, this.checked)" class="w-4 h-4 cursor-pointer" ${salaryRun?.status === 'finalized' ? 'disabled' : ''}>` : '-'}
                      </td>
                    </tr>
                  `;
                }).join('')}
                
                <!-- Period Totals -->
                <tr class="border-t bg-gray-50 font-semibold" style="border-color: #E5E7EB;">
                  <td class="px-4 py-3 text-xs" style="color: ${config.text_color};" colspan="2">TOTAL</td>
                  <td class="px-4 py-3 text-right text-xs" style="color: ${config.text_color};">${formatCurrency(totalGross)}</td>
                  <td class="px-4 py-3 text-right text-xs text-green-600">+${formatCurrency(totalBonuses)}</td>
                  <td class="px-4 py-3 text-right text-xs text-red-600">-${formatCurrency(totalDeductions)}</td>
                  <td class="px-4 py-3 text-right text-xs" style="color: ${config.primary_color};">${formatCurrency(totalNet)}</td>
                  <td class="px-4 py-3" colspan="2"></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      `;
    }



    function renderSidePanel(config) {
      const s = selectedStaff;
      const { year, month } = selectedPeriod;
      const salDocId = `SAL_${s.id}_${year}_${String(month).padStart(2, '0')}`;
      const sal = allSalaries.find(sal => sal.id === salDocId);
      const ts = allTimesheets.find(t => t.staffId === s.id && t.year === year && t.month === month);
      const gross = ts?.totalPay || 0;
      const tempKey = `${s.id}_${year}_${month}`;
      
      // Use saved adjustments, temp adjustments, or empty array
      const adjustments = sal?.adjustments || tempAdjustments[tempKey] || [];
      
      const bonusTotal = adjustments
        .filter(a => a.type === 'bonus')
        .reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
      const deductionTotal = adjustments
        .filter(a => a.type === 'deduction')
        .reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
      const net = Math.max(0, gross + bonusTotal - deductionTotal);

      const isSalaryGenerated = !!sal;
      const salaryRun = allSalaryRuns.find(r => r.year === year && r.month === month);
      const canEdit = !salaryRun || salaryRun.status !== 'finalized';

      return `
        <div class="fixed inset-0 bg-white overflow-y-auto z-40" id="salaryPanel">
          <div class="max-w-4xl mx-auto p-6 space-y-6">
            <!-- Header -->
            <div class="flex items-center justify-between border-b pb-4" style="border-color: #E5E7EB;">
              <h2 class="text-lg font-semibold" style="color: ${config.primary_color};">${isSalaryGenerated ? 'Edit Salary' : 'Add Adjustments'}</h2>
              <button onclick="closePanel()" class="w-8 h-8 rounded-lg hover:bg-gray-100 font-medium text-sm" style="color: ${config.text_color};">✕</button>
            </div>

            <!-- Staff Info -->
            <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-lg p-4 border border-amber-200">
              <div class="font-semibold text-sm mb-1" style="color: ${config.text_color};">${s.fullName || s.preferredName}</div>
              <div class="text-xs" style="color: ${config.text_color}; opacity: 0.6;">${s.id}</div>
              ${ts ? `
                <div class="mt-2 text-xs px-2 py-1 bg-blue-50 text-blue-700 rounded inline-block border border-blue-200">
                  Timesheet: ${formatCurrency(ts.totalPay)} (${ts.totalSessions || 0} sessions)
                </div>
              ` : `
                <div class="mt-2 text-xs px-2 py-1 bg-yellow-50 text-yellow-700 rounded inline-block border border-yellow-200">
                  No approved timesheet
                </div>
              `}

            </div>

            <!-- Three Column Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
              <!-- Banking Editor -->
              <div>
                <h3 class="font-semibold mb-3 text-sm" style="color: ${config.text_color};">Banking Details</h3>
                <div class="space-y-3">
                  <div>
                    <label class="block text-xs font-medium mb-1" style="color: ${config.text_color};">Bank Code</label>
                    <input type="text" id="bankCode" value="${s.banking?.bankCode || ''}" class="w-full px-3 py-2 border rounded-lg text-sm" style="border-color: #E5E7EB;" placeholder="e.g. VCB, TCB">
                  </div>
                  <div>
                    <label class="block text-xs font-medium mb-1" style="color: ${config.text_color};">Account Number</label>
                    <input type="text" id="accountNumber" value="${s.banking?.accountNumber || ''}" class="w-full px-3 py-2 border rounded-lg text-sm" style="border-color: #E5E7EB;">
                  </div>
                  <div>
                    <label class="block text-xs font-medium mb-1" style="color: ${config.text_color};">Account Name</label>
                    <input type="text" id="accountName" value="${s.banking?.accountName || ''}" class="w-full px-3 py-2 border rounded-lg text-sm" style="border-color: #E5E7EB;">
                  </div>
                  <button onclick="saveBankingClick()" class="w-full px-3 py-2 rounded-lg font-medium text-white text-sm" style="background: ${config.secondary_color};">
                    Save Banking
                  </button>
                </div>
              </div>

              <!-- Transfer Reference -->
              <div>
                <h3 class="font-semibold mb-3 text-sm" style="color: ${config.text_color};">Transfer Reference</h3>
                <div class="space-y-3">
                  <div>
                    <label class="block text-xs font-medium mb-1" style="color: ${config.text_color};">QR Code Message</label>
                    <input type="text" id="transferReference" value="${sal?.transferReference || `Salary ${month}/${year}`}" class="w-full px-3 py-2 border rounded-lg text-sm" style="border-color: #E5E7EB;" placeholder="e.g. Salary 01/2024">
                  </div>
                  <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-xs" style="color: ${config.text_color}; opacity: 0.7;">This message will appear on the QR code for bank transfers. Update it before generating the QR code.</p>
                  </div>
                </div>
              </div>

              <!-- Summary Card -->
              <div>
                <h3 class="font-semibold mb-3 text-sm" style="color: ${config.text_color};">Salary Summary</h3>
                <div class="bg-gradient-to-br from-purple-50 to-blue-50 rounded-lg p-5 space-y-3 border border-purple-200" style="">
                  <div class="flex justify-between items-center text-sm">
                    <span class="font-medium" style="color: ${config.text_color};">Gross Pay:</span>
                    <span class="font-semibold" id="summaryGross">${formatCurrency(gross)}</span>
                  </div>
                  <div class="flex justify-between items-center text-sm text-green-700">
                    <span class="font-medium">Total Bonuses:</span>
                    <span class="font-semibold" id="summaryBonus">+${formatCurrency(bonusTotal)}</span>
                  </div>
                  <div class="flex justify-between items-center text-sm text-red-700">
                    <span class="font-medium">Total Deductions:</span>
                    <span class="font-semibold" id="summaryDeduction">-${formatCurrency(deductionTotal)}</span>
                  </div>
                  <div class="border-t pt-3 flex justify-between items-center" style="border-color: #E5E7EB;">
                    <span class="font-semibold text-sm" style="color: ${config.text_color};">Net Pay:</span>
                    <span class="font-bold text-xl" style="color: ${config.primary_color};" id="summaryNet">${formatCurrency(net)}</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Adjustments Full Width -->
            <div>
              <div class="flex items-center justify-between mb-4">
                <h3 class="font-semibold text-sm" style="color: ${config.text_color};">Salary Adjustments</h3>
                <button onclick="addAdjustment()" class="px-3 py-2 rounded-lg font-medium text-white text-sm" style="background: ${config.accent_color};" ${!canEdit ? 'disabled' : ''}>
                  + Add Adjustment
                </button>
              </div>

              <div id="adjustmentsList" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                ${renderAdjustmentsList(adjustments, config, canEdit)}
              </div>

              <!-- Action Buttons -->
              <div class="flex gap-3">
                <button onclick="closePanel()" class="flex-1 px-4 py-3 rounded-lg font-medium text-sm border" style="border-color: #E5E7EB; color: ${config.text_color};">
                  Cancel
                </button>
                ${isSalaryGenerated ? `
                  <button onclick="saveSalaryClick()" class="flex-1 px-4 py-3 rounded-lg font-medium text-white text-sm" style="background: ${config.primary_color};" ${!canEdit ? 'disabled' : ''}>
                    Save Changes
                  </button>
                ` : `
                  <button onclick="saveTempClick()" class="flex-1 px-4 py-3 rounded-lg font-medium text-white text-sm" style="background: ${config.accent_color};">
                    Save Adjustments
                  </button>
                `}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Event Handlers
    function attachListeners() {
      // No period selectors needed - showing all periods
    }

    window.selectPeriod = function(year, month) {
      selectedPeriod = { year, month };
      selectedStaff = null;
      render();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.switchTab = function(tab) {
      activeTab = tab;
      selectedStaff = null;
      selectedPeriod = null;
      render();
    };

    window.toggleYear = function(year) {
      const content = document.getElementById(`yearContent${year}`);
      const icon = document.getElementById(`yearIcon${year}`);
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
      } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(-90deg)';
      }
    };

    window.backToCalendar = function() {
      selectedPeriod = null;
      selectedStaff = null;
      render();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    window.openStaffForPeriod = function(staff, year, month) {
      selectedStaff = staff;
      selectedPeriod = { year, month };
      render();
    };

    window.closePanel = function() {
      selectedStaff = null;
      render();
    };

    window.saveBankingClick = function() {
      const bankCode = document.getElementById('bankCode').value.trim();
      const accountNumber = document.getElementById('accountNumber').value.trim();
      const accountName = document.getElementById('accountName').value.trim();

      if (!bankCode || !accountNumber || !accountName) {
        showToast('Please fill all banking fields', 'error');
        return;
      }

      saveBanking(selectedStaff.id, {
        bankCode,
        accountNumber,
        accountName,
        bankName: ''
      });
    };

    window.addAdjustment = function() {
      if (!selectedStaff || !selectedPeriod) return;
      
      const { year, month } = selectedPeriod;
      const salDocId = `SAL_${selectedStaff.id}_${year}_${String(month).padStart(2, '0')}`;
      const sal = allSalaries.find(s => s.id === salDocId);
      const tempKey = `${selectedStaff.id}_${year}_${month}`;
      const tempAdj = tempAdjustments[tempKey];
      
      const currentAdjustments = sal?.adjustments || tempAdj || [];
      const newAdjustments = [...currentAdjustments, {
        type: 'bonus',
        label: '',
        amount: 0
      }];

      if (sal) {
        const salIndex = allSalaries.findIndex(s => s.id === salDocId);
        allSalaries[salIndex] = { ...sal, adjustments: newAdjustments };
      } else {
        tempAdjustments[tempKey] = newAdjustments;
      }
      
      // Update only the adjustments list container and summary
      const config = window.elementSdk?.config || defaultConfig;
      const salaryRun = allSalaryRuns.find(r => r.year === year && r.month === month);
      const canEdit = !salaryRun || salaryRun.status !== 'finalized';
      
      const adjustmentsList = document.getElementById('adjustmentsList');
      if (adjustmentsList) {
        adjustmentsList.innerHTML = renderAdjustmentsList(newAdjustments, config, canEdit);
      }
      
      updateSalarySummary();
    };

    window.removeAdjustment = function(index) {
      if (!selectedStaff || !selectedPeriod) return;
      
      const { year, month } = selectedPeriod;
      const salDocId = `SAL_${selectedStaff.id}_${year}_${String(month).padStart(2, '0')}`;
      const sal = allSalaries.find(s => s.id === salDocId);
      const tempKey = `${selectedStaff.id}_${year}_${month}`;
      const tempAdj = tempAdjustments[tempKey];
      
      const currentAdjustments = [...(sal?.adjustments || tempAdj || [])];
      currentAdjustments.splice(index, 1);

      if (sal) {
        const salIndex = allSalaries.findIndex(s => s.id === salDocId);
        allSalaries[salIndex] = { ...sal, adjustments: currentAdjustments };
      } else {
        tempAdjustments[tempKey] = currentAdjustments;
      }
      
      // Update only the adjustments list container and summary
      const config = window.elementSdk?.config || defaultConfig;
      const salaryRun = allSalaryRuns.find(r => r.year === year && r.month === month);
      const canEdit = !salaryRun || salaryRun.status !== 'finalized';
      
      const adjustmentsList = document.getElementById('adjustmentsList');
      if (adjustmentsList) {
        adjustmentsList.innerHTML = renderAdjustmentsList(currentAdjustments, config, canEdit);
      }
      
      updateSalarySummary();
    };

    window.saveSalaryClick = function() {
      if (!selectedStaff || !selectedPeriod) return;

      const { year, month } = selectedPeriod;
      const salDocId = `SAL_${selectedStaff.id}_${year}_${String(month).padStart(2, '0')}`;
      const sal = allSalaries.find(s => s.id === salDocId);
      const adjustments = [...(sal.adjustments || [])];

      // Update from form fields
      document.querySelectorAll('#adjustmentsList select, #adjustmentsList input').forEach(field => {
        const index = parseInt(field.dataset.index);
        const fieldName = field.dataset.field;
        if (adjustments[index]) {
          adjustments[index][fieldName] = fieldName === 'amount' ? parseFloat(field.value) || 0 : field.value;
        }
      });

      const transferReference = document.getElementById('transferReference')?.value || `Salary ${month}/${year}`;

      saveSalary(selectedStaff.id, year, month, adjustments, transferReference);
    };

    window.saveTempClick = function() {
      if (!selectedStaff || !selectedPeriod) return;

      const { year, month } = selectedPeriod;
      const tempKey = `${selectedStaff.id}_${year}_${month}`;
      const tempAdj = tempAdjustments[tempKey] || [];
      const adjustments = [...tempAdj];

      // Update from form fields
      document.querySelectorAll('#adjustmentsList select, #adjustmentsList input').forEach(field => {
        const index = parseInt(field.dataset.index);
        const fieldName = field.dataset.field;
        if (adjustments[index]) {
          adjustments[index][fieldName] = fieldName === 'amount' ? parseFloat(field.value) || 0 : field.value;
        }
      });

      saveTempAdjustments(selectedStaff.id, year, month, adjustments);
    };

    window.viewQR = function(staffId, year, month) {
      const salDocId = `SAL_${staffId}_${year}_${String(month).padStart(2, '0')}`;
      const sal = allSalaries.find(s => s.id === salDocId);
      if (!sal?.qr?.payload) return;

      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md border" style="border-color: #E5E7EB;">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold">Payment QR Code</h3>
            <button onclick="this.closest('.fixed').remove()" class="w-8 h-8 rounded-lg hover:bg-gray-100 text-sm font-medium">✕</button>
          </div>
          <img src="${sal.qr.payload}" alt="VietQR" class="w-full rounded-lg border" style="border-color: #E5E7EB;" onerror="this.src=''; this.alt='QR Code failed to load'; this.style.display='none';">
          <div class="mt-4 text-center">
            <p class="font-semibold text-base">${formatCurrency(sal.net)} VND</p>
            <p class="text-xs mt-1" style="opacity: 0.6;">Salary ${month}/${year}</p>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };

    window.openBankingModal = function(staffId) {
      const s = staff.find(st => st.id === staffId);
      if (!s) return;

      const config = window.elementSdk?.config || defaultConfig;
      const modal = document.createElement('div');
      modal.id = 'bankingModal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 border" style="border-color: #E5E7EB;">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold" style="color: ${config.primary_color};">Banking Details</h3>
            <button onclick="closeBankingModal()" class="w-8 h-8 rounded-lg hover:bg-gray-100 text-sm font-medium">✕</button>
          </div>
          
          <div class="mb-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
            <p class="text-sm font-medium" style="color: ${config.text_color};">${s.fullName || s.preferredName}</p>
            <p class="text-xs mt-0.5" style="color: ${config.text_color}; opacity: 0.6;">${s.id}</p>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1" style="color: ${config.text_color};">Bank Code</label>
              <input type="text" id="modalBankCode" value="${s.banking?.bankCode || ''}" class="w-full px-3 py-2 border rounded-lg text-sm" style="border-color: #E5E7EB;" placeholder="e.g., VCB, TCB, VTB">
              <p class="text-xs mt-1" style="color: ${config.text_color}; opacity: 0.5;">Standard bank code (e.g., VCB for Vietcombank)</p>
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-1" style="color: ${config.text_color};">Account Number</label>
              <input type="text" id="modalAccountNumber" value="${s.banking?.accountNumber || ''}" class="w-full px-3 py-2 border rounded-lg text-sm" style="border-color: #E5E7EB;" placeholder="Enter account number">
            </div>
            
            <div>
              <label class="block text-sm font-medium mb-1" style="color: ${config.text_color};">Account Name</label>
              <input type="text" id="modalAccountName" value="${s.banking?.accountName || ''}" class="w-full px-3 py-2 border rounded-lg text-sm" style="border-color: #E5E7EB;" placeholder="Enter account holder name">
              <p class="text-xs mt-1" style="color: ${config.text_color}; opacity: 0.5;">Name as it appears on bank account</p>
            </div>
          </div>

          <div class="flex gap-3 mt-6">
            <button onclick="closeBankingModal()" class="flex-1 px-4 py-2 rounded-lg font-medium text-sm border" style="border-color: #E5E7EB; color: ${config.text_color};">
              Cancel
            </button>
            <button onclick="saveBankingModal('${staffId}')" class="flex-1 px-4 py-2 rounded-lg font-medium text-white text-sm" style="background: ${config.primary_color};">
              Save Banking
            </button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    };

    window.closeBankingModal = function() {
      const modal = document.getElementById('bankingModal');
      if (modal) modal.remove();
    };

    window.saveBankingModal = function(staffId) {
      const bankCode = document.getElementById('modalBankCode').value.trim();
      const accountNumber = document.getElementById('modalAccountNumber').value.trim();
      const accountName = document.getElementById('modalAccountName').value.trim();

      if (!bankCode || !accountNumber || !accountName) {
        showToast('Please fill all banking fields', 'error');
        return;
      }

      saveBanking(staffId, {
        bankCode,
        accountNumber,
        accountName,
        bankName: ''
      });

      closeBankingModal();
    };

    // Initialize
    async function init() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities,
          mapToEditPanelValues
        });
      }
      render();
      // Auto-load data on init
      loadData();
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9c1745c3568f9354',t:'MTc2OTAwMzM0My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
