<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Learning Progress</title>
  <style>
    body {
      box-sizing: border-box;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f5f7fa;
      color: #2d3748;
      line-height: 1.5;
      min-height: 100%;
    }

    .top-bar {
      position: sticky;
      top: 0;
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 100;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .top-bar h1 {
      font-size: 16px;
      font-weight: 600;
      color: #1a202c;
    }

    .top-bar-center {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: #4a5568;
      font-weight: 500;
    }

    .top-bar-right {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .filter-group {
      display: flex;
      gap: 8px;
      align-items: center;
      padding-right: 12px;
      border-right: 1px solid #e2e8f0;
    }

    .filter-label {
      font-size: 12px;
      color: #718096;
      font-weight: 500;
    }

    .filter-select {
      padding: 6px 10px;
      border: 1px solid #e2e8f0;
      background: white;
      color: #4a5568;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
    }

    .filter-select:hover {
      border-color: #cbd5e0;
      background: #f7fafc;
    }

    .btn {
      padding: 6px 12px;
      border: 1px solid #e2e8f0;
      background: white;
      color: #4a5568;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }

    .btn:hover {
      background: #f7fafc;
      border-color: #cbd5e0;
    }

    .btn-primary {
      background: #4299e1;
      color: white;
      border-color: #4299e1;
    }

    .btn-primary:hover {
      background: #3182ce;
      border-color: #3182ce;
    }

    .container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 12px;
    }

    .card {
      background: white;
      border-radius: 6px;
      padding: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      margin-bottom: 12px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      color: #1a202c;
      margin-bottom: 10px;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .badge-active { background: #c6f6d5; color: #22543d; }
    .badge-upcoming { background: #bee3f8; color: #2c5282; }
    .badge-finished { background: #e2e8f0; color: #4a5568; }
    .badge-hold { background: #fed7d7; color: #742a2a; }
    .badge-risk { background: #feebc8; color: #7c2d12; }

    .indicators-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .indicator-card {
      background: white;
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      text-align: center;
      border-top: 3px solid #e2e8f0;
    }

    .indicator-card.green { border-top-color: #48bb78; }
    .indicator-card.yellow { border-top-color: #ecc94b; }
    .indicator-card.red { border-top-color: #f56565; }
    .indicator-card.gray { border-top-color: #a0aec0; }

    .indicator-value {
      font-size: 28px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 4px;
    }

    .indicator-label {
      font-size: 11px;
      color: #718096;
      margin-bottom: 6px;
    }

    .indicator-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .indicator-badge.green { background: #c6f6d5; color: #22543d; }
    .indicator-badge.yellow { background: #fefcbf; color: #744210; }
    .indicator-badge.red { background: #fed7d7; color: #742a2a; }
    .indicator-badge.gray { background: #e2e8f0; color: #4a5568; }

    .course-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .course-row {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      padding: 10px 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .course-row:hover {
      background: #edf2f7;
      border-color: #cbd5e0;
    }

    .course-row.expanded {
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .course-row.highlighted {
      border: 2px solid #4299e1;
      background: #ebf8ff;
    }

    .course-main {
      display: grid;
      grid-template-columns: 2fr 1.5fr 1fr 1fr 1fr;
      gap: 12px;
      align-items: center;
    }

    .course-name {
      font-weight: 600;
      color: #1a202c;
      font-size: 13px;
    }

    .course-code {
      font-size: 11px;
      color: #718096;
      margin-top: 1px;
    }

    .course-teachers {
      font-size: 12px;
      color: #718096;
    }

    .course-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .course-stat-value {
      font-weight: 600;
      font-size: 14px;
    }

    .course-stat-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #718096;
    }

    .course-details {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #e2e8f0;
      display: none;
    }

    .course-row.expanded .course-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .detail-section h4 {
      font-size: 11px;
      font-weight: 600;
      color: #4a5568;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .detail-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .load-more-btn {
      margin-top: 8px;
      padding: 6px 12px;
      background: #edf2f7;
      border: 1px solid #cbd5e0;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 600;
      color: #4a5568;
      text-align: center;
      transition: all 0.2s;
    }

    .load-more-btn:hover {
      background: #e2e8f0;
      border-color: #a0aec0;
    }

    .detail-item {
      display: flex;
      justify-content: space-between;
      padding: 5px 8px;
      background: #f7fafc;
      border-radius: 3px;
      font-size: 11px;
    }

    .detail-date {
      color: #718096;
    }

    .detail-status {
      font-weight: 600;
    }

    .timeline {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 300px;
      overflow-y: auto;
    }

    .timeline-item {
      display: flex;
      gap: 10px;
      padding: 8px 10px;
      background: #fff5f5;
      border-left: 3px solid #fc8181;
      border-radius: 3px;
    }

    .timeline-item.warning {
      background: #fffaf0;
      border-left-color: #ed8936;
    }

    .timeline-date {
      font-size: 11px;
      color: #718096;
      font-weight: 600;
      min-width: 75px;
    }

    .timeline-content {
      flex: 1;
    }

    .timeline-course {
      font-weight: 600;
      font-size: 12px;
      color: #1a202c;
      margin-bottom: 1px;
    }

    .timeline-label {
      font-size: 11px;
      color: #4a5568;
    }

    .flags-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 300px;
      overflow-y: auto;
    }

    .flag-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 4px;
      border-left: 3px solid;
    }

    .flag-item.critical {
      background: #fff5f5;
      border-left-color: #f56565;
    }

    .flag-item.warning {
      background: #fffaf0;
      border-left-color: #ed8936;
    }

    .flag-item.info {
      background: #ebf8ff;
      border-left-color: #4299e1;
    }

    .flag-icon {
      font-size: 16px;
    }

    .flag-text {
      flex: 1;
      font-size: 12px;
      color: #2d3748;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
    }

    .empty-state h2 {
      font-size: 20px;
      color: #4a5568;
      margin-bottom: 12px;
    }

    .empty-state p {
      color: #718096;
      margin-bottom: 24px;
    }

    .search-box {
      max-width: 400px;
      margin: 0 auto;
      display: flex;
      gap: 8px;
    }

    .search-input {
      flex: 1;
      padding: 10px 16px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #a0aec0;
      font-size: 14px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #718096;
      font-size: 14px;
    }

    .error-message {
      background: #fff5f5;
      border: 1px solid #feb2b2;
      border-radius: 6px;
      padding: 16px;
      color: #742a2a;
      margin-bottom: 20px;
    }

    @media (max-width: 1200px) {
      .indicators-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .top-bar {
        flex-direction: column;
        gap: 8px;
        align-items: stretch;
      }

      .top-bar-right {
        flex-direction: column;
      }

      .filter-group {
        padding-right: 0;
        border-right: none;
        border-bottom: 1px solid #e2e8f0;
        padding-bottom: 8px;
      }

      .course-main {
        grid-template-columns: 1fr;
        gap: 6px;
      }

      .course-row.expanded .course-details {
        grid-template-columns: 1fr;
      }

      .indicators-grid {
        grid-template-columns: 1fr;
      }

      .container > div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="top-bar">
   <h1>Learning Progress</h1>
   <div class="top-bar-center" id="studentDisplay">
    Loading...
   </div>
   <div class="top-bar-right">
    <div class="filter-group"><span class="filter-label">Period:</span> <select class="filter-select" id="periodFilter" onchange="applyFilters()"> <option value="30">Last 30 Days</option> <option value="60" selected>Last 60 Days</option> <option value="90">Last 90 Days</option> <option value="180">Last 6 Months</option> <option value="365">Last Year</option> <option value="all">All Time</option> </select>
    </div>
    <div class="filter-group"><span class="filter-label">Status:</span> <select class="filter-select" id="statusFilter" onchange="applyFilters()"> <option value="active" selected>Active Only</option> <option value="all">All Courses</option> <option value="finished">Finished Only</option> </select>
    </div><button class="btn" onclick="history.back()">Back</button> <button class="btn" onclick="location.reload()">Refresh</button>
   </div>
  </div>
  <div class="container" id="mainContainer">
   <div class="loading">
    Loading student data...
   </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCDzv0HseeLfijzyXZjKWFh9QaLrMB4afo",
      authDomain: "tnl2026.firebaseapp.com",
      projectId: "tnl2026",
      storageBucket: "tnl2026.firebasestorage.app",
      messagingSenderId: "883525152224",
      appId: "1:883525152224:web:619ae152cd8df3fcca8f85",
      measurementId: "G-3K6LXCKHZ9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ========== HELPERS ==========

    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    function normalizeStudentId(studentId) {
      return studentId.toLowerCase().trim().replace(/\s+/g, '-').replace(/[^a-z0-9-_]/g, '');
    }

    async function safeQuery(collectionName, buildQueryFn) {
      try {
        const queryRef = buildQueryFn(db.collection(collectionName));
        const snapshot = await queryRef.get();
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      } catch (error) {
        console.warn(`Query failed for ${collectionName}:`, error);
        return [];
      }
    }

    function percent(numerator, denominator) {
      if (!denominator || denominator === 0) return 0;
      return Math.round((numerator / denominator) * 100);
    }

    function formatDate(dateValue) {
      if (!dateValue) return 'Unknown';
      
      let date;
      if (dateValue.toDate) {
        // Firestore Timestamp
        date = dateValue.toDate();
      } else if (dateValue instanceof Date) {
        date = dateValue;
      } else if (typeof dateValue === 'string') {
        // Handle yyyy-mm-dd format and ISO strings
        date = new Date(dateValue);
      } else if (typeof dateValue === 'number') {
        date = new Date(dateValue);
      } else if (dateValue.seconds) {
        // Firestore Timestamp object (manual check)
        date = new Date(dateValue.seconds * 1000);
      } else {
        return 'Unknown';
      }

      if (isNaN(date.getTime())) return 'Unknown';

      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }

    function getDaysAgo(dateValue) {
      if (!dateValue) return 999;
      
      let date;
      if (dateValue.toDate) {
        // Firestore Timestamp
        date = dateValue.toDate();
      } else if (dateValue instanceof Date) {
        date = dateValue;
      } else if (typeof dateValue === 'string') {
        // Handle yyyy-mm-dd format and ISO strings
        date = new Date(dateValue);
      } else if (typeof dateValue === 'number') {
        date = new Date(dateValue);
      } else if (dateValue.seconds) {
        // Firestore Timestamp object (manual check)
        date = new Date(dateValue.seconds * 1000);
      } else {
        return 999;
      }

      if (isNaN(date.getTime())) return 999;

      const now = new Date();
      const diffMs = now - date;
      return Math.floor(diffMs / (1000 * 60 * 60 * 24));
    }

    function isWithin60Days(dateValue) {
      return getDaysAgo(dateValue) <= 60;
    }

    function isWithinPeriod(dateValue, days) {
      if (days === 'all') return true;
      if (!dateValue) return false;
      
      const daysAgo = getDaysAgo(dateValue);
      if (daysAgo === 999) return false; // Invalid date
      
      return daysAgo <= parseInt(days);
    }

    window.applyFilters = function() {
      if (!currentStudent || currentEnrollments.length === 0) return;
      
      const periodDays = document.getElementById('periodFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;

      // Filter enrollments by status
      let filteredEnrollments;
      if (statusFilter === 'active') {
        filteredEnrollments = currentEnrollments.filter(e => e.normalizedStatus === 'active');
      } else if (statusFilter === 'finished') {
        filteredEnrollments = currentEnrollments.filter(e => e.normalizedStatus === 'finished');
      } else {
        filteredEnrollments = currentEnrollments;
      }

      // Filter attendance and performance by period
      const filteredAttendance = currentAttendance.filter(a => {
        return isWithinPeriod(a._effectiveDate, periodDays);
      });

      const filteredPerformance = currentPerformance.filter(p => {
        const date = p.date || p.createdAt;
        return isWithinPeriod(date, periodDays);
      });

      renderDashboard(
        currentStudent,
        filteredEnrollments,
        currentCourses,
        filteredAttendance,
        filteredPerformance,
        currentSessions,
        periodDays
      );
    };

    // ========== GLOBAL STATE ==========

    let currentStudent = null;
    let currentEnrollments = [];
    let currentCourses = {};
    let currentAttendance = [];
    let currentPerformance = [];
    let currentSessions = [];
    let currentTeachersByCourseId = {};

    // ========== MAIN LOGIC ==========

    // Get URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    // Try multiple parameter names for student ID (case-insensitive)
    let studentId = null;
    for (const [key, value] of urlParams.entries()) {
      const lowerKey = key.toLowerCase();
      if (lowerKey === 'studentid' || lowerKey === 'student' || lowerKey === 'id') {
        studentId = value;
        break;
      }
    }
    
    const targetCourseId = getQueryParam('courseId');
    const fromParam = getQueryParam('from');

    console.log('URL Parameters:', {
      studentId,
      targetCourseId,
      fromParam,
      allParams: Object.fromEntries(urlParams)
    });

    if (!studentId) {
      showEmptyState();
    } else {
      loadStudentProgress(studentId);
    }

    function showEmptyState() {
      const container = document.getElementById('mainContainer');
      container.innerHTML = `
        <div class="empty-state">
          <h2>No Student Selected</h2>
          <p>Enter a student ID to view their learning progress</p>
          <div class="search-box">
            <input type="text" class="search-input" id="studentIdInput" placeholder="Enter Student ID (e.g., Stu001)">
            <button class="btn btn-primary" onclick="loadStudentFromInput()">Load</button>
          </div>
        </div>
      `;
    }

    window.loadStudentFromInput = function() {
      const input = document.getElementById('studentIdInput');
      const studentId = input.value.trim();
      if (studentId) {
        window.location.href = `?studentId=${encodeURIComponent(studentId)}`;
      }
    };

    async function loadStudentProgress(studentId) {
      try {
        // Step 1: Resolve student document
        let studentDoc = null;
        let studentDocId = null;
        let student = null;

        // Try querying by publicCode field
        const studentsByIdQuery = await db.collection('students').where('publicCode', '==', studentId).limit(1).get();
        if (!studentsByIdQuery.empty) {
          studentDoc = studentsByIdQuery.docs[0];
          studentDocId = studentDoc.id;
          student = { id: studentDocId, ...studentDoc.data() };
        } else {
          // Try by normalized doc ID
          const normalizedId = 'stu_' + normalizeStudentId(studentId);
          const directDoc = await db.collection('students').doc(normalizedId).get();
          if (directDoc.exists) {
            studentDocId = directDoc.id;
            student = { id: studentDocId, ...directDoc.data() };
          }
        }

        if (!student) {
          showError('Student not found', `No student found with ID: ${studentId}`);
          return;
        }

        // Update header
        updateHeader(student);

        // Step 2: Load enrollments
        const enrollments = await safeQuery('course_enrollments', (col) => col.where('studentId', '==', studentDocId));

        if (enrollments.length === 0) {
          showNoEnrollments(student);
          return;
        }

        // Normalize enrollment status
        enrollments.forEach(e => {
          const rawStatus = e.status || 'active';
          e.normalizedStatus = normalizeEnrollmentStatus(rawStatus);
        });

        // Step 3: Load courses
        const courseIds = [...new Set(enrollments.map(e => e.courseId))];
        const courses = {};
        for (const courseId of courseIds) {
          try {
            const courseDoc = await db.collection('courses').doc(courseId).get();
            if (courseDoc.exists) {
              courses[courseId] = { id: courseDoc.id, ...courseDoc.data() };
            }
          } catch (err) {
            console.warn(`Failed to load course ${courseId}:`, err);
          }
        }

        // Step 4: Load attendance data with courseId
        let attendanceRecords = await safeQuery('attendance', (col) => col.where('studentId', '==', studentDocId));
        
        // Add courseId to attendance records by looking up sessionId in courseSessions
        // We'll do this after loading sessions

        // Step 5: Load grades and assessments
        let gradeRecords = await safeQuery('grades', (col) => col.where('studentId', '==', studentDocId));
        
        // Load assessment details for each grade
        const assessmentIds = [...new Set(gradeRecords.map(g => g.assessmentId).filter(Boolean))];
        const assessmentMap = {};
        for (const assessmentId of assessmentIds) {
          try {
            const assessmentDoc = await db.collection('assessments').doc(assessmentId).get();
            if (assessmentDoc.exists) {
              assessmentMap[assessmentId] = { id: assessmentDoc.id, ...assessmentDoc.data() };
            }
          } catch (err) {
            console.warn(`Failed to load assessment ${assessmentId}:`, err);
          }
        }

        // Merge grade and assessment data for performance records
        const performanceRecords = gradeRecords.map(grade => {
          const assessment = assessmentMap[grade.assessmentId] || {};
          return {
            ...grade,
            name: assessment.name || 'Unknown Assessment',
            date: assessment.date || grade.createdAt,
            status: assessment.status || 'completed',
            courseId: assessment.courseId || null // Get courseId from assessment
          };
        });

        // Step 6: Load course sessions (for timeline and date resolution)
        let courseSessions = [];
        if (courseIds.length > 0) {
          // Firestore 'in' query supports max 10 items, so batch if needed
          for (let i = 0; i < courseIds.length; i += 10) {
            const batch = courseIds.slice(i, i + 10);
            const batchSessions = await safeQuery('course_sessions', (col) => col.where('courseId', 'in', batch));
            courseSessions.push(...batchSessions);
          }
        }

        // Build sessionDate map for date normalization AND courseId lookup
        const sessionDateById = {};
        const sessionCourseById = {};
        courseSessions.forEach(session => {
          if (session.sessionDate) {
            sessionDateById[session.id] = session.sessionDate;
          }
          if (session.courseId) {
            sessionCourseById[session.id] = session.courseId;
          }
        });

        // Add courseId to attendance records from session lookup
        attendanceRecords.forEach(a => {
          if (a.sessionId && sessionCourseById[a.sessionId]) {
            a.courseId = sessionCourseById[a.sessionId];
          }
        });

        // Step 7: Load course staff (teachers) for all courses
        let courseStaffRecords = [];
        if (courseIds.length > 0) {
          // Firestore 'in' query supports max 10 items, so batch if needed
          for (let i = 0; i < courseIds.length; i += 10) {
            const batch = courseIds.slice(i, i + 10);
            const batchRecords = await safeQuery('course_staff', (col) => col.where('courseId', 'in', batch));
            courseStaffRecords.push(...batchRecords);
          }
        }

        // Build teacher map by courseId
        const teachersByCourseId = {};
        courseStaffRecords.forEach(staff => {
          if (!teachersByCourseId[staff.courseId]) {
            teachersByCourseId[staff.courseId] = [];
          }
          teachersByCourseId[staff.courseId].push({
            name: staff.staffNameCache || staff.staffId,
            role: staff.role || 'teacher'
          });
        });

        // Normalize attendance dates BEFORE filtering
        attendanceRecords.forEach(a => {
          a._effectiveDate = a.date || 
                             (a.sessionId && sessionDateById[a.sessionId] ? sessionDateById[a.sessionId] : null) ||
                             a.createdAt;
        });

        // Store all data globally
        currentStudent = student;
        currentEnrollments = enrollments;
        currentCourses = courses;
        currentAttendance = attendanceRecords;
        currentPerformance = performanceRecords;
        currentSessions = courseSessions;
        currentTeachersByCourseId = teachersByCourseId;

        // Apply initial filters (60 days + active courses)
        applyFilters();

      } catch (error) {
        console.error('Error loading student progress:', error);
        showError('Error loading data', error.message);
      }
    }

    function normalizeEnrollmentStatus(status) {
      const s = (status || '').toLowerCase();
      if (s === 'active' || s === 'enrolled') return 'active';
      if (s === 'upcoming' || s === 'pending') return 'upcoming';
      if (s === 'finished' || s === 'completed' || s === 'graduated') return 'finished';
      return 'active';
    }

    function updateHeader(student) {
      const display = document.getElementById('studentDisplay');
      const statusBadge = getStatusBadge(student.status || 'active');
      display.innerHTML = `
        <span>${student.fullName || 'Unknown Student'}</span>
        <span class="badge ${statusBadge.class}">${statusBadge.text}</span>
        <span style="color: #a0aec0;">${student.publicCode || student.id}</span>
      `;
    }

    function getStatusBadge(status) {
      const s = (status || '').toLowerCase();
      if (s === 'active' || s === 'enrolled') return { class: 'badge-active', text: 'Active' };
      if (s === 'upcoming') return { class: 'badge-upcoming', text: 'Upcoming' };
      if (s === 'finished' || s === 'completed') return { class: 'badge-finished', text: 'Finished' };
      if (s === 'hold') return { class: 'badge-hold', text: 'On Hold' };
      if (s === 'risk') return { class: 'badge-risk', text: 'At Risk' };
      return { class: 'badge-active', text: 'Active' };
    }

    function showError(title, message) {
      const container = document.getElementById('mainContainer');
      container.innerHTML = `
        <div class="error-message">
          <h3 style="margin-bottom: 8px;">${title}</h3>
          <p>${message}</p>
        </div>
        <div style="text-align: center;">
          <button class="btn btn-primary" onclick="location.href='?'">Go Back</button>
        </div>
      `;
    }

    function showNoEnrollments(student) {
      const container = document.getElementById('mainContainer');
      container.innerHTML = `
        <div class="card">
          <h3 class="card-title">${student.fullName || 'Student'}</h3>
          <div class="no-data">No course enrollments found for this student.</div>
        </div>
      `;
    }

    function renderDashboard(student, enrollments, courses, attendanceRecords, performanceRecords, courseSessions, periodDays = '60') {
      // Compute overall metrics - use all enrollments (already filtered by status)
      const displayEnrollments = enrollments;
      
      // Attendance rate (using records that are already filtered by period in applyFilters)
      const attendanceRate = computeAttendanceRate(attendanceRecords);

      // Average performance (using records that are already filtered by period in applyFilters)
      const avgPerformance = computeAveragePerformance(performanceRecords);

      // Course summaries - these records are already filtered by period
      const courseSummaries = displayEnrollments.map(enrollment => {
        const course = courses[enrollment.courseId] || { name: 'Unknown Course' };
        const courseAttendance = attendanceRecords.filter(a => a.courseId === enrollment.courseId);
        const coursePerformance = performanceRecords.filter(p => p.courseId === enrollment.courseId);
        
        const courseAttendanceRate = computeAttendanceRate(courseAttendance);
        const courseAvgPerformance = computeAveragePerformance(coursePerformance);

        // Sort by date descending (most recent first)
        const sortedAttendance = courseAttendance.sort((a, b) => {
          const dateA = a._effectiveDate?.toDate ? a._effectiveDate.toDate() : new Date(a._effectiveDate || 0);
          const dateB = b._effectiveDate?.toDate ? b._effectiveDate.toDate() : new Date(b._effectiveDate || 0);
          return dateB - dateA;
        });

        const sortedPerformance = coursePerformance.sort((a, b) => {
          const dateA = (a.date || a.createdAt)?.toDate ? (a.date || a.createdAt).toDate() : new Date(a.date || a.createdAt || 0);
          const dateB = (b.date || b.createdAt)?.toDate ? (b.date || b.createdAt).toDate() : new Date(b.date || b.createdAt || 0);
          return dateB - dateA;
        });

        return {
          enrollment,
          course,
          attendanceRate: courseAttendanceRate,
          avgPerformance: courseAvgPerformance,
          allAttendanceRecords: sortedAttendance,
          allPerformanceRecords: sortedPerformance,
          attendanceDisplayCount: 10,
          performanceDisplayCount: 5
        };
      });

      // Resolve attendance dates asynchronously
      resolveAttendanceDates(courseSummaries);

      // Store course summaries globally for load more functionality
      currentCourseSummaries = courseSummaries;

      // Timeline highlights
      const timelineItems = generateTimelineHighlights(attendanceRecords, performanceRecords, courseSessions, courses);

      // System flags
      const flags = generateSystemFlags(courseSummaries, attendanceRate, attendanceRecords, performanceRecords);

      // Get period label
      const periodLabel = periodDays === 'all' ? 'All Time' : 
                          periodDays === '365' ? 'Last Year' :
                          periodDays === '180' ? 'Last 6 Months' :
                          periodDays === '90' ? 'Last 90 Days' :
                          periodDays === '30' ? 'Last 30 Days' :
                          'Last 60 Days';

      // Render
      const container = document.getElementById('mainContainer');
      container.innerHTML = `
        ${renderIndicators(attendanceRate, avgPerformance, displayEnrollments.length, flags.length, periodLabel)}
        ${renderCourses(courseSummaries)}
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
          ${renderTimeline(timelineItems, periodLabel)}
          ${renderFlags(flags)}
        </div>
      `;

      // Attach event listeners
      attachCourseListeners();

      // Handle courseId targeting
      if (targetCourseId) {
        setTimeout(() => {
          const targetRow = document.querySelector(`[data-course-id="${targetCourseId}"]`);
          if (targetRow) {
            targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetRow.classList.add('highlighted');
            targetRow.classList.add('expanded');
          }
        }, 100);
      }
    }

    async function resolveAttendanceDates(courseSummaries) {
      const sessionCache = {};
      let needsRerender = false;
      
      for (const cs of courseSummaries) {
        for (const record of cs.allAttendanceRecords) {
          // Priority 1: Direct date field in attendance record
          if (record.date) {
            record.resolvedDate = formatDate(record.date);
            record.resolvedDateValue = record.date; // Store original for filtering
            continue;
          }
          
          // Priority 2: sessionId exists - load from course_sessions collection
          // The sessionId IS the document ID in course_sessions
          if (record.sessionId) {
            try {
              // Check cache first
              if (sessionCache[record.sessionId]) {
                record.resolvedDate = sessionCache[record.sessionId].formatted;
                record.resolvedDateValue = sessionCache[record.sessionId].value;
                continue;
              }
              
              // Load session document using sessionId as doc ID
              const sessionDoc = await db.collection('course_sessions').doc(record.sessionId).get();
              if (sessionDoc.exists) {
                const sessionData = sessionDoc.data();
                // Look for sessionDate field (yyyy-mm-dd format)
                const dateValue = sessionData.sessionDate;
                const dateFormatted = formatDate(dateValue);
                sessionCache[record.sessionId] = { formatted: dateFormatted, value: dateValue };
                record.resolvedDate = dateFormatted;
                record.resolvedDateValue = dateValue;
                needsRerender = true;
                continue;
              }
            } catch (err) {
              console.warn('Failed to load session date:', err);
            }
          }
          
          // Priority 3: Fallback to createdAt field
          if (record.createdAt) {
            record.resolvedDate = formatDate(record.createdAt);
            record.resolvedDateValue = record.createdAt;
            continue;
          }
          
          // No date found
          record.resolvedDate = '—';
          record.resolvedDateValue = null;
        }
      }
      
      // Re-render courses section after resolving dates
      if (needsRerender) {
        const coursesCard = document.querySelector('.card:has(.course-list)');
        if (coursesCard) {
          coursesCard.innerHTML = `
            <h3 class="card-title">Courses</h3>
            ${renderCoursesList(courseSummaries)}
          `;
          attachCourseListeners();
        }
      }
    }

    function renderSingleCourseRow(cs) {
      const course = cs.course;
      
      // Get teachers from the global teacher map
      const teachers = currentTeachersByCourseId[course.id] || [];
      const teacherNames = teachers.length > 0 
        ? teachers.map(t => t.name).join(', ')
        : 'Not assigned';
      
      const attendanceColor = cs.attendanceRate >= 80 ? 'green' : cs.attendanceRate >= 60 ? 'yellow' : 'red';
      const performanceColor = cs.avgPerformance >= 70 ? 'green' : cs.avgPerformance >= 50 ? 'yellow' : 'red';

      // Show only the requested number of records
      const displayAttendance = cs.allAttendanceRecords.slice(0, cs.attendanceDisplayCount);
      const displayPerformance = cs.allPerformanceRecords.slice(0, cs.performanceDisplayCount);

      const attendanceRecordsHtml = displayAttendance.length > 0
        ? displayAttendance.map(a => {
          const displayDate = a.resolvedDate || '—';
          const status = (a.status || 'Unknown').toLowerCase();
          let statusColor = '#4a5568'; // default gray
          let statusBg = 'transparent';
          
          if (status === 'present') {
            statusColor = '#22543d';
            statusBg = '#c6f6d5';
          } else if (status === 'absent') {
            statusColor = '#742a2a';
            statusBg = '#fed7d7';
          } else if (status === 'late') {
            statusColor = '#7c2d12';
            statusBg = '#feebc8';
          } else if (status === 'excused') {
            statusColor = '#2c5282';
            statusBg = '#bee3f8';
          }
          
          return `
            <div class="detail-item">
              <span class="detail-date">${displayDate}</span>
              <span class="detail-status" style="color: ${statusColor}; background: ${statusBg}; padding: 2px 8px; border-radius: 4px; font-weight: 600;">${a.status || 'Unknown'}</span>
            </div>
          `;
        }).join('')
        : '<div class="no-data">No attendance records</div>';

      const hasMoreAttendance = cs.allAttendanceRecords.length > cs.attendanceDisplayCount;
      const attendanceLoadMoreBtn = hasMoreAttendance 
        ? `<button class="load-more-btn" data-course-id="${course.id}" data-type="attendance">Load More (${cs.allAttendanceRecords.length - cs.attendanceDisplayCount} remaining)</button>`
        : '';

      const performanceRecordsHtml = displayPerformance.length > 0
        ? displayPerformance.map(p => {
          const score = p.score !== null && p.score !== undefined ? p.score : '—';
          const maxScore = p.maxScore || p.totalScore || 100;
          const scorePercent = percent(p.score, maxScore);
          const percentScore = p.score !== null && p.score !== undefined ? ` (${scorePercent}%)` : '';
          
          let scoreColor = '#4a5568'; // default gray
          let scoreBg = 'transparent';
          
          if (p.score !== null && p.score !== undefined) {
            if (scorePercent >= 70) {
              scoreColor = '#22543d';
              scoreBg = '#c6f6d5';
            } else if (scorePercent >= 50) {
              scoreColor = '#7c2d12';
              scoreBg = '#feebc8';
            } else {
              scoreColor = '#742a2a';
              scoreBg = '#fed7d7';
            }
          }
          
          return `
            <div class="detail-item">
              <span>${formatDate(p.date || p.createdAt)}</span>
              <span class="detail-status" style="color: ${scoreColor}; background: ${scoreBg}; padding: 2px 8px; border-radius: 4px; font-weight: 600;">${score}/${maxScore}${percentScore}</span>
            </div>
          `;
        }).join('')
        : '<div class="no-data">No assessment scores</div>';

      const hasMorePerformance = cs.allPerformanceRecords.length > cs.performanceDisplayCount;
      const performanceLoadMoreBtn = hasMorePerformance 
        ? `<button class="load-more-btn" data-course-id="${course.id}" data-type="performance">Load More (${cs.allPerformanceRecords.length - cs.performanceDisplayCount} remaining)</button>`
        : '';

      return `
        <div class="course-row" data-course-id="${course.id}">
          <div class="course-main">
            <div>
              <div class="course-name">${course.name || 'Unknown Course'}</div>
              ${course.publicCode ? `<div class="course-code">${course.publicCode}</div>` : ''}
            </div>
            <div class="course-teachers">${teacherNames}</div>
            <div class="course-stat">
              <span class="course-stat-value" style="color: ${attendanceColor === 'green' ? '#48bb78' : attendanceColor === 'yellow' ? '#ecc94b' : '#f56565'}">${cs.attendanceRate}%</span>
              <span class="course-stat-label">Attendance</span>
            </div>
            <div class="course-stat">
              <span class="course-stat-value" style="color: ${performanceColor === 'green' ? '#48bb78' : performanceColor === 'yellow' ? '#ecc94b' : '#f56565'}">${cs.avgPerformance}%</span>
              <span class="course-stat-label">Performance</span>
            </div>
            <span class="badge badge-${cs.enrollment.normalizedStatus}">${cs.enrollment.normalizedStatus}</span>
          </div>
          <div class="course-details">
            <div class="detail-section">
              <h4>Attendance Records (${cs.allAttendanceRecords.length} total)</h4>
              <div class="detail-list">
                ${attendanceRecordsHtml}
              </div>
              ${attendanceLoadMoreBtn}
            </div>
            <div class="detail-section">
              <h4>Assessments (${cs.allPerformanceRecords.length} total)</h4>
              <div class="detail-list">
                ${performanceRecordsHtml}
              </div>
              ${performanceLoadMoreBtn}
            </div>
          </div>
        </div>
      `;
    }

    function renderCoursesList(courseSummaries) {
      const rows = courseSummaries.map(cs => renderSingleCourseRow(cs)).join('');
      return `<div class="course-list">${rows}</div>`;
    }

    function computeAttendanceRate(attendanceRecords) {
      if (attendanceRecords.length === 0) return 0;
      const present = attendanceRecords.filter(a => {
        const status = (a.status || '').toLowerCase();
        return status === 'present' || status === 'late';
      }).length;
      return percent(present, attendanceRecords.length);
    }

    function computeAveragePerformance(performanceRecords) {
      if (performanceRecords.length === 0) return 0;
      
      let totalPercent = 0;
      let count = 0;

      performanceRecords.forEach(p => {
        const score = p.score;
        const maxScore = p.maxScore || p.totalScore || 100;
        
        if (score !== null && score !== undefined && maxScore > 0) {
          totalPercent += (score / maxScore) * 100;
          count++;
        }
      });

      return count > 0 ? Math.round(totalPercent / count) : 0;
    }

    function generateTimelineHighlights(attendanceRecords, performanceRecords, courseSessions, courses) {
      const items = [];

      // Absences (already filtered by period)
      attendanceRecords.forEach(a => {
        const date = a._effectiveDate || a.date || a.createdAt;
        const status = (a.status || '').toLowerCase();
        if (status === 'absent' || status === 'excused') {
          items.push({
            date,
            course: courses[a.courseId]?.name || 'Unknown Course',
            label: status === 'excused' ? 'Excused absence' : 'Absent from session',
            severity: 'critical'
          });
        } else if (status === 'late') {
          items.push({
            date,
            course: courses[a.courseId]?.name || 'Unknown Course',
            label: 'Arrived late',
            severity: 'warning'
          });
        }
      });

      // Sort by date descending
      items.sort((a, b) => {
        const dateA = a.date?.toDate ? a.date.toDate() : new Date(a.date || 0);
        const dateB = b.date?.toDate ? b.date.toDate() : new Date(b.date || 0);
        return dateB - dateA;
      });

      return items.slice(0, 10); // Limit to 10 items
    }

    function generateSystemFlags(courseSummaries, overallAttendance, attendanceRecords, performanceRecords) {
      const flags = [];

      // Overall attendance < 70%
      if (overallAttendance < 70) {
        flags.push({
          severity: 'critical',
          text: `Overall attendance is ${overallAttendance}% (below 70% threshold)`
        });
      }

      // Per-course attendance
      courseSummaries.forEach(cs => {
        if (cs.attendanceRate < 70) {
          flags.push({
            severity: 'critical',
            text: `Attendance in ${cs.course.name} is ${cs.attendanceRate}% (below 70%)`
          });
        } else if (cs.attendanceRate >= 70 && cs.attendanceRate <= 85) {
          flags.push({
            severity: 'warning',
            text: `Attendance in ${cs.course.name} is ${cs.attendanceRate}% (watch zone 70-85%)`
          });
        }
      });

      // No recent assessment
      if (performanceRecords.length > 0) {
        const mostRecentPerformance = performanceRecords.reduce((latest, p) => {
          const pDate = p.date || p.createdAt;
          const latestDate = latest.date || latest.createdAt;
          return getDaysAgo(pDate) < getDaysAgo(latestDate) ? p : latest;
        });
        const daysSince = getDaysAgo(mostRecentPerformance.date || mostRecentPerformance.createdAt);
        if (daysSince > 30) {
          flags.push({
            severity: 'warning',
            text: `No assessment score in last 30 days (most recent: ${daysSince} days ago)`
          });
        }
      }

      // 2 consecutive absences (if we have dates)
      const sortedAttendance = attendanceRecords
        .filter(a => a.date)
        .sort((a, b) => {
          const dateA = a.date?.toDate ? a.date.toDate() : new Date(a.date || 0);
          const dateB = b.date?.toDate ? b.date.toDate() : new Date(b.date || 0);
          return dateB - dateA;
        });

      for (let i = 0; i < sortedAttendance.length - 1; i++) {
        const current = sortedAttendance[i];
        const next = sortedAttendance[i + 1];
        const currentStatus = (current.status || '').toLowerCase();
        const nextStatus = (next.status || '').toLowerCase();
        
        if (currentStatus === 'absent' && nextStatus === 'absent') {
          flags.push({
            severity: 'critical',
            text: `Two consecutive absences detected (${formatDate(next.date)} and ${formatDate(current.date)})`
          });
          break;
        }
      }

      return flags;
    }

    function renderIndicators(attendanceRate, avgPerformance, activeCourses, flagCount, periodLabel) {
      const attendanceColor = attendanceRate >= 80 ? 'green' : attendanceRate >= 60 ? 'yellow' : 'red';
      const attendanceBadge = attendanceRate >= 80 ? 'Excellent' : attendanceRate >= 60 ? 'Fair' : 'Poor';

      const performanceColor = avgPerformance >= 70 ? 'green' : avgPerformance >= 50 ? 'yellow' : 'red';
      const performanceBadge = avgPerformance >= 70 ? 'Strong' : avgPerformance >= 50 ? 'Average' : 'Needs support';

      const flagColor = flagCount === 0 ? 'green' : flagCount <= 2 ? 'yellow' : 'red';
      const flagBadge = flagCount === 0 ? 'None' : flagCount <= 2 ? 'Monitor' : 'Action needed';

      return `
        <div class="card">
          <h3 class="card-title">Key Indicators (${periodLabel})</h3>
          <div class="indicators-grid">
            <div class="indicator-card ${attendanceColor}">
              <div class="indicator-value">${attendanceRate}%</div>
              <div class="indicator-label">Attendance Rate</div>
              <span class="indicator-badge ${attendanceColor}">${attendanceBadge}</span>
            </div>
            <div class="indicator-card ${performanceColor}">
              <div class="indicator-value">${avgPerformance}%</div>
              <div class="indicator-label">Average Performance</div>
              <span class="indicator-badge ${performanceColor}">${performanceBadge}</span>
            </div>
            <div class="indicator-card gray">
              <div class="indicator-value">${activeCourses}</div>
              <div class="indicator-label">Courses Displayed</div>
              <span class="indicator-badge gray">Enrolled</span>
            </div>
            <div class="indicator-card ${flagColor}">
              <div class="indicator-value">${flagCount}</div>
              <div class="indicator-label">System Flags</div>
              <span class="indicator-badge ${flagColor}">${flagBadge}</span>
            </div>
          </div>
        </div>
      `;
    }

    function renderCourses(courseSummaries) {
      if (courseSummaries.length === 0) {
        return `
          <div class="card">
            <h3 class="card-title">Courses</h3>
            <div class="no-data">No course enrollments match the selected filters</div>
          </div>
        `;
      }

      return `
        <div class="card">
          <h3 class="card-title">Courses</h3>
          ${renderCoursesList(courseSummaries)}
        </div>
      `;
    }

    function renderTimeline(items, periodLabel) {
      if (items.length === 0) {
        return `
          <div class="card">
            <h3 class="card-title">Timeline Highlights (${periodLabel})</h3>
            <div class="no-data">No exceptions or highlights to display</div>
          </div>
        `;
      }

      const itemsHtml = items.map(item => {
        const cssClass = item.severity === 'warning' ? 'timeline-item warning' : 'timeline-item';
        return `
          <div class="${cssClass}">
            <div class="timeline-date">${formatDate(item.date)}</div>
            <div class="timeline-content">
              <div class="timeline-course">${item.course}</div>
              <div class="timeline-label">${item.label}</div>
            </div>
          </div>
        `;
      }).join('');

      return `
        <div class="card">
          <h3 class="card-title">Timeline Highlights (${periodLabel})</h3>
          <div class="timeline">${itemsHtml}</div>
        </div>
      `;
    }

    function renderFlags(flags) {
      if (flags.length === 0) {
        return `
          <div class="card">
            <h3 class="card-title">System Flags</h3>
            <div class="no-data" style="color: #48bb78;">✓ No academic risks detected</div>
          </div>
        `;
      }

      const flagsHtml = flags.map(flag => {
        const icon = flag.severity === 'critical' ? '⛔' : flag.severity === 'warning' ? '⚠' : 'ℹ';
        return `
          <div class="flag-item ${flag.severity}">
            <span class="flag-icon">${icon}</span>
            <span class="flag-text">${flag.text}</span>
          </div>
        `;
      }).join('');

      return `
        <div class="card">
          <h3 class="card-title">System Flags</h3>
          <div class="flags-list">${flagsHtml}</div>
        </div>
      `;
    }

    function attachCourseListeners() {
      document.querySelectorAll('.course-row').forEach(row => {
        row.addEventListener('click', (e) => {
          // Don't toggle if clicking on a button
          if (e.target.classList.contains('load-more-btn')) {
            return;
          }
          row.classList.toggle('expanded');
        });
      });

      // Attach load more button listeners
      document.querySelectorAll('.load-more-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const courseId = btn.getAttribute('data-course-id');
          const type = btn.getAttribute('data-type');
          
          if (type === 'attendance') {
            loadMoreAttendance(courseId);
          } else if (type === 'performance') {
            loadMorePerformance(courseId);
          }
        });
      });
    }

    function loadMoreAttendance(courseId) {
      const courseSummary = currentCourseSummaries.find(cs => cs.course.id === courseId);
      if (!courseSummary) return;

      courseSummary.attendanceDisplayCount += 10;
      
      // Re-render just this course row
      const courseRow = document.querySelector(`[data-course-id="${courseId}"]`);
      if (courseRow) {
        const wasExpanded = courseRow.classList.contains('expanded');
        courseRow.outerHTML = renderSingleCourseRow(courseSummary);
        
        // Reattach listeners and restore expanded state
        const newRow = document.querySelector(`[data-course-id="${courseId}"]`);
        if (wasExpanded) {
          newRow.classList.add('expanded');
        }
        attachCourseListeners();
      }
    }

    function loadMorePerformance(courseId) {
      const courseSummary = currentCourseSummaries.find(cs => cs.course.id === courseId);
      if (!courseSummary) return;

      courseSummary.performanceDisplayCount += 5;
      
      // Re-render just this course row
      const courseRow = document.querySelector(`[data-course-id="${courseId}"]`);
      if (courseRow) {
        const wasExpanded = courseRow.classList.contains('expanded');
        courseRow.outerHTML = renderSingleCourseRow(courseSummary);
        
        // Reattach listeners and restore expanded state
        const newRow = document.querySelector(`[data-course-id="${courseId}"]`);
        if (wasExpanded) {
          newRow.classList.add('expanded');
        }
        attachCourseListeners();
      }
    }

    let currentCourseSummaries = [];
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b63a651a02c97a7',t:'MTc2NzExOTg2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>