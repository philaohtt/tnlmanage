<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timesheet Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"><!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <style>
    body { box-sizing: border-box; font-family: 'Inter', sans-serif; }
    
    .app-wrapper {
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      background: #f1f5f9;
      overflow: hidden;
    }
    
    /* Header gradient */
    .header-gradient {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #3b7ab8 100%);
    }
    
    /* Sticky bars */
    .sticky-bar {
      position: sticky;
      top: 0;
      z-index: 40;
      background: #fff;
      border-bottom: 1px solid #e2e8f0;
    }
    
    /* Table styling */
    .ts-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    
    .ts-table th {
      background: #f8fafc;
      padding: 6px 8px;
      text-align: left;
      font-weight: 600;
      color: #475569;
      border-bottom: 2px solid #e2e8f0;
      white-space: nowrap;
    }
    
    .ts-table th.text-center {
      text-align: center;
    }
    
    .ts-table td {
      padding: 4px 6px;
      border-bottom: 1px solid #f1f5f9;
      vertical-align: middle;
    }
    
    .ts-table tr:hover td {
      background: #f8fafc;
    }
    
    /* Yellow highlight for rows needing review */
    .ts-table tr.needs-review td {
      background: #fef9c3;
    }
    
    .ts-table tr.needs-review:hover td {
      background: #fef08a;
    }
    
    /* Editable cells */
    .cell-input {
      width: 100%;
      padding: 4px 6px;
      border: 1px solid transparent;
      border-radius: 3px;
      font-size: 12px;
      background: transparent;
      transition: all 0.15s;
    }
    
    .cell-input:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }
    
    .cell-input:focus {
      outline: none;
      border-color: #3b82f6;
      background: #fff;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    
    .cell-input.invalid {
      background: #fef2f2;
      border-color: #fca5a5;
    }
    
    .cell-input.readonly {
      background: #f8fafc;
      cursor: not-allowed;
      color: #64748b;
    }
    
    .cell-select {
      padding: 4px 6px;
      border: 1px solid transparent;
      border-radius: 3px;
      font-size: 12px;
      background: transparent;
      cursor: pointer;
      width: 100%;
    }
    
    .cell-select:hover {
      background: #f1f5f9;
      border-color: #cbd5e1;
    }
    
    .cell-select:focus {
      outline: none;
      border-color: #3b82f6;
    }
    
    /* Section headers */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      font-weight: 600;
      font-size: 12px;
      color: #fff;
      border-radius: 6px 6px 0 0;
      margin-top: 16px;
    }
    
    .section-tutoring { background: #059669; }
    .section-group { background: #2563eb; }
    .section-assistant { background: #7c3aed; }
    .section-other { background: #d97706; }
    
    /* Status chips */
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
    }
    
    .chip-draft { background: #fef3c7; color: #92400e; }
    .chip-submitted { background: #dbeafe; color: #1e40af; }
    .chip-approved { background: #d1fae5; color: #065f46; }
    .chip-rejected { background: #fee2e2; color: #991b1b; }
    .chip-paid { background: #e0e7ff; color: #4338ca; }
    .chip-ok { background: #d1fae5; color: #065f46; }
    .chip-missing { background: #fee2e2; color: #991b1b; }
    .chip-cancelled { background: #f3f4f6; color: #6b7280; }
    .chip-needs_review { background: #fef3c7; color: #92400e; }
    .chip-warning { background: #fef3c7; color: #92400e; }
    
    /* Buttons */
    .btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-primary {
      background: #2563eb;
      color: #fff;
      box-shadow: 0 1px 2px rgba(37, 99, 235, 0.2);
    }
    .btn-primary:hover:not(:disabled) { background: #1d4ed8; }
    
    .btn-secondary {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
    }
    .btn-secondary:hover:not(:disabled) { background: #e2e8f0; }
    
    .btn-success {
      background: #059669;
      color: #fff;
      box-shadow: 0 1px 2px rgba(5, 150, 105, 0.2);
    }
    .btn-success:hover:not(:disabled) { background: #047857; }
    
    .btn-danger {
      background: #dc2626;
      color: #fff;
    }
    .btn-danger:hover:not(:disabled) { background: #b91c1c; }
    
    .btn-add {
      background: rgba(255,255,255,0.2);
      color: #fff;
      padding: 4px 8px;
      font-size: 11px;
    }
    .btn-add:hover:not(:disabled) { background: rgba(255,255,255,0.3); }
    
    .btn-del {
      padding: 2px 6px;
      font-size: 10px;
      background: #fee2e2;
      color: #dc2626;
      border-radius: 4px;
      border: none;
      cursor: pointer;
    }
    .btn-del:hover { background: #fecaca; }
    
    /* Loading spinner */
    .spinner {
      border: 2px solid #f3f4f6;
      border-top: 2px solid #3b82f6;
      border-radius: 50%;
      width: 14px;
      height: 14px;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Sidebar cards */
    .sidebar-card {
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .toast {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      animation: slideIn 0.3s ease;
    }
    
    .toast-success { background: #059669; color: #fff; }
    .toast-error { background: #dc2626; color: #fff; }
    .toast-warning { background: #d97706; color: #fff; }
    .toast-info { background: #2563eb; color: #fff; }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 200;
    }
    
    .modal-content {
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }
    
    /* Code badge */
    .code-badge {
      font-family: 'Monaco', 'Consolas', monospace;
      background: #1e293b;
      color: #22d3ee;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
    }
    
    /* Locked staff badge */
    .locked-staff-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #f1f5f9;
      border: 1px solid #cbd5e1;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      color: #475569;
    }
    
    .locked-staff-badge .lock-icon {
      color: #64748b;
    }
    
    /* Scrollable areas */
    .main-scroll {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    .table-wrapper {
      background: #fff;
      border-radius: 0 0 6px 6px;
      overflow-x: auto;
      border: 1px solid #e2e8f0;
      border-top: none;
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #64748b;
    }
    
    .empty-state svg {
      width: 64px;
      height: 64px;
      margin: 0 auto 16px;
      opacity: 0.5;
    }
    
    /* Number inputs without spinners */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] { -moz-appearance: textfield; }
    
    /* Dropdown styling */
    .control-select {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
      background: #fff;
      min-width: 140px;
    }
    
    .control-select:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    
    /* Timesheet overview cards */
    .timesheet-card {
      background: #fff;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
    }
    
    .iframe-compact #sidebar {
      width: 180px !important;
      padding: 6px !important;
    }
    
    .timesheet-card:hover {
      border-color: #cbd5e1;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transform: translateY(-1px);
    }
    
    .timesheet-card.active {
      border-color: #3b82f6;
      background: #eff6ff;
    }
    
    .timesheet-card.has-data {
      border-color: #10b981;
    }
    
    .timesheet-card.has-data:hover {
      border-color: #059669;
    }
    
    .timesheet-card-month {
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      margin-bottom: 4px;
    }
    
    .timesheet-card-year {
      font-size: 16px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }
    
    .timesheet-card-status {
      font-size: 10px;
      margin-top: 6px;
    }
    
    .timesheet-card-pay {
      font-size: 12px;
      font-weight: 600;
      color: #059669;
      margin-top: 4px;
    }
    
    .timesheet-card-empty {
      font-size: 11px;
      color: #94a3b8;
      font-style: italic;
    }
    
    .control-input {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
      background: #fff;
    }
    
    .control-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    
    /* Setup panel */
    .setup-panel {
      max-width: 600px;
      margin: 60px auto;
      background: #fff;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .setup-panel h2 {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }
    
    .setup-panel p {
      color: #64748b;
      margin-bottom: 24px;
    }
    
    .setup-panel label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: #475569;
      margin-bottom: 6px;
    }
    
    .setup-panel input,
    .setup-panel textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 16px;
    }
    
    .setup-panel input:focus,
    .setup-panel textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    .setup-panel textarea {
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      min-height: 120px;
    }
    
    .setup-panel .error-box {
      background: #fef2f2;
      border: 1px solid #fca5a5;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 16px;
      color: #991b1b;
      font-size: 13px;
    }
    
    .setup-panel .success-box {
      background: #f0fdf4;
      border: 1px solid #86efac;
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 16px;
      color: #166534;
      font-size: 13px;
    }
    
    /* Iframe Compact Mode */
    .iframe-compact .header-gradient {
      padding: 12px 24px;
    }
    
    .iframe-compact .sticky-bar {
      padding: 8px 16px;
    }
    
    .iframe-compact .section-header {
      margin-top: 8px;
      padding: 6px 10px;
    }
    
    .iframe-compact .main-scroll {
      padding: 8px;
    }
    
    .iframe-compact .sidebar-card {
      padding: 12px;
      margin-bottom: 12px;
    }
    
    /* Timesheet Overview Collapsible */
    .timesheet-overview-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }
    
    .timesheet-overview-header h3 {
      font-size: 13px;
      font-weight: 600;
      color: #475569;
    }
    
    .timesheet-overview-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .btn-toggle {
      padding: 4px 8px;
      font-size: 11px;
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    .btn-toggle:hover {
      background: #e2e8f0;
    }
    
    .timesheet-list-content {
      overflow: visible;
    }
    
    .iframe-compact .timesheet-list-content {
      max-height: 22vh;
      overflow: auto;
    }
    
    .iframe-compact .timesheet-overview.collapsed .timesheet-list-content {
      display: none;
    }
    
    /* Horizontal month cards in iframe */
    .iframe-compact #timesheet-grid {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      overflow-y: hidden;
      padding-bottom: 6px;
    }
    
    .iframe-compact .timesheet-card {
      flex: 0 0 auto;
      min-width: 90px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full m-0">
  <div class="app-wrapper" id="app"><!-- Firebase Setup Panel (shown if not configured) -->
   <div id="setup-panel" class="setup-panel" style="display: none;">
    <h2>üî• Firebase Setup Required</h2>
    <p>Please configure your Firebase project to connect to Firestore.</p>
    <div id="setup-error" class="error-box" style="display: none;"></div>
    <div id="setup-success" class="success-box" style="display: none;"></div><label for="api-key">API Key</label> <input type="text" id="api-key" placeholder="AIzaSy..."> <label for="project-id">Project ID</label> <input type="text" id="project-id" placeholder="your-project-id"> <label for="firebase-config">Or paste full Firebase config JSON</label> <textarea id="firebase-config" placeholder="{\n  &quot;apiKey&quot;: &quot;...&quot;,\n  &quot;projectId&quot;: &quot;...&quot;\n}"></textarea> <button class="btn btn-primary" onclick="saveFirebaseConfig()" style="width: 100%;"> Connect to Firebase </button>
   </div><!-- Main App (hidden until Firebase is configured) -->
   <div id="main-app" style="display: none;"><!-- Control Bar 1 -->
    <div class="sticky-bar px-4 py-3">
     <div class="flex items-center gap-3 flex-wrap"><span id="status-chip" class="chip chip-draft">Draft</span> <!-- Staff Selector (Admin only) --> <select id="staff-select" class="control-select flex-1 max-w-xs" onchange="onStaffChange()" style="display: none;"> <option value="">Select Teacher</option> </select> <!-- Locked Staff Badge (Non-Admin) -->
      <div id="locked-staff-display" class="locked-staff-badge" style="display: none;">
       <svg class="lock-icon" width="14" height="14" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /> <path d="M7 11V7a5 5 0 0 1 10 0v4" />
       </svg><span id="locked-staff-text">Loading...</span>
      </div><button class="btn btn-secondary" onclick="toggleTimesheetOverview()" id="btn-overview" disabled>
       <svg width="14" height="14" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="btn-overview-icon"><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /> <line x1="16" y1="2" x2="16" y2="6" /> <line x1="8" y1="2" x2="8" y2="6" /> <line x1="3" y1="10" x2="21" y2="10" />
       </svg><span id="btn-overview-text">Close Timesheets</span> </button> <select id="month-select" class="control-select" onchange="onPeriodChange()"> <option value="1">01</option> <option value="2">02</option> <option value="3">03</option> <option value="4">04</option> <option value="5">05</option> <option value="6">06</option> <option value="7">07</option> <option value="8">08</option> <option value="9">09</option> <option value="10">10</option> <option value="11">11</option> <option value="12">12</option> </select> <select id="year-select" class="control-select" onchange="onPeriodChange()"> <option value="2025">2025</option> <option value="2026">2026</option> <option value="2027">2027</option> <option value="2028">2028</option> <option value="2029">2029</option> <option value="2030">2030</option> </select>
      <div class="code-badge" id="timesheet-id">
       TS_---_----_--
      </div>
      <div class="flex-1"></div>
      <div class="flex items-center gap-2"><button class="btn btn-primary" id="btn-generate" onclick="generateDraft()" disabled> <span id="generate-spinner" class="spinner" style="display: none;"></span>
        <svg width="14" height="14" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="generate-icon">
         <path d="M12 5v14M5 12h14" />
        </svg> Generate Draft </button> <button class="btn btn-secondary" onclick="confirmReset()" id="btn-reset" disabled>Reset Draft</button> <button class="btn btn-secondary" onclick="saveDraft()" id="btn-save" disabled> <span id="save-spinner" class="spinner" style="display: none;"></span> <span id="save-text">Save Draft</span> </button> <button class="btn btn-success" onclick="submitTimesheet()" id="btn-submit" disabled> <span id="submit-spinner" class="spinner" style="display: none;"></span>
        <svg width="14" height="14" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="submit-icon">
         <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
        </svg> Submit </button>
      </div>
     </div>
    </div><!-- Timesheet Overview Panel -->
    <div id="timesheet-overview" class="sticky-bar px-4 py-4 bg-slate-50" style="display: block; top: 58px;">
     <div class="timesheet-overview-header">
      <h3>Your Timesheets</h3>
      <div class="timesheet-overview-controls"><button class="btn-toggle" onclick="toggleTimesheetListExpanded()" id="btn-toggle-list">
        <svg width="12" height="12" viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="toggle-icon"><polyline points="6 9 12 15 18 9" />
        </svg><span id="toggle-text">Collapse</span> </button> <button class="btn btn-secondary" onclick="toggleTimesheetOverview()" style="padding: 4px 8px; font-size: 11px;">Close</button>
      </div>
     </div>
     <div class="timesheet-list-content" id="timesheet-list-content">
      <div id="timesheet-grid" class="grid grid-cols-12 gap-2"><!-- Timesheet cards will be inserted here -->
      </div>
     </div>
    </div><!-- Main Content -->
    <div class="flex flex-1 overflow-hidden"><!-- Left: Table Panel -->
     <div class="flex-1 main-scroll p-4">
      <div id="empty-state" class="empty-state">
       <svg viewbox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" /> <path d="M3 9h18M9 21V9" />
       </svg>
       <h3 class="text-lg font-semibold text-slate-700 mb-2">No timesheet entries yet</h3>
       <p class="text-slate-500 mb-4">Select a teacher and generate a draft to get started</p><button class="btn btn-primary" onclick="generateDraft()" id="btn-generate-empty" disabled>Generate Draft</button>
      </div>
      <div id="tables-container" style="display: none;"><!-- GROUP TEACHING Section (First) -->
       <div class="section-container" data-section="group">
        <div class="section-header section-group">
         <div class="flex items-center gap-3"><span>üéì GROUP TEACHING</span>
          <div class="flex items-center gap-2" id="bulk-controls-group" style="display: none;"><span class="text-xs opacity-90">|</span> <span class="text-xs opacity-90 whitespace-nowrap" id="selected-count-group">0 selected</span> <select class="cell-select text-xs" id="bulk-class-type-group" style="background: rgba(255,255,255,0.95); color: #1e40af; border-color: rgba(255,255,255,0.3); font-weight: 500;"> <option value="">Set Class Type</option> </select> <button class="btn-add text-xs" onclick="applyBulkClassType('group')" style="padding: 3px 8px;">Apply</button> <button class="btn-add text-xs" onclick="clearSelection('group')" style="padding: 3px 8px;">Clear</button>
          </div>
         </div><button class="btn btn-add" onclick="addRow('group')">+ Add Row</button>
        </div>
        <div class="table-wrapper">
         <table class="ts-table">
          <thead>
           <tr>
            <th class="text-center" style="width:30px"><input type="checkbox" id="select-all-group" onchange="toggleSelectAll('group', this.checked)" style="cursor: pointer;"></th>
            <th class="text-center" style="width:30px">#</th>
            <th style="width:100px">Date</th>
            <th style="width:120px">Course</th>
            <th style="width:120px">Class Type</th>
            <th style="width:70px">Students</th>
            <th style="width:70px">Minutes</th>
            <th style="width:70px">Sessions</th>
            <th style="width:100px">Pay</th>
            <th style="width:150px">Notes</th>
            <th style="width:80px">Status</th>
            <th style="width:50px">Action</th>
           </tr>
          </thead>
          <tbody id="tbody-group"></tbody>
         </table>
        </div>
       </div><!-- TUTORING Section (Second) -->
       <div class="section-container" data-section="tutoring">
        <div class="section-header section-tutoring"><span>üë§ TUTORING</span> <button class="btn btn-add" onclick="addRow('tutoring')">+ Add Row</button>
        </div>
        <div class="table-wrapper">
         <table class="ts-table">
          <thead>
           <tr>
            <th class="text-center" style="width:30px">#</th>
            <th style="width:100px">Date</th>
            <th style="width:120px">Course</th>
            <th style="width:120px">Student</th>
            <th style="width:100px">Student Charge</th>
            <th style="width:80px">Mgmt Fee</th>
            <th style="width:70px">Minutes</th>
            <th style="width:70px">Sessions</th>
            <th style="width:100px">Pay</th>
            <th style="width:150px">Notes</th>
            <th style="width:80px">Status</th>
            <th style="width:50px">Action</th>
           </tr>
          </thead>
          <tbody id="tbody-tutoring"></tbody>
         </table>
        </div>
       </div><!-- ASSISTANT TEACHING Section (Third) -->
       <div class="section-container" data-section="assistant">
        <div class="section-header section-assistant">
         <div class="flex items-center gap-3"><span>ü§ù ASSISTANT TEACHING</span>
          <div class="flex items-center gap-2" id="bulk-controls-assistant" style="display: none;"><span class="text-xs opacity-90">|</span> <span class="text-xs opacity-90 whitespace-nowrap" id="selected-count-assistant">0 selected</span> <select class="cell-select text-xs" id="bulk-class-type-assistant" style="background: rgba(255,255,255,0.95); color: #7c3aed; border-color: rgba(255,255,255,0.3); font-weight: 500;"> <option value="">Set Class Type</option> </select> <button class="btn-add text-xs" onclick="applyBulkClassType('assistant')" style="padding: 3px 8px;">Apply</button> <button class="btn-add text-xs" onclick="clearSelection('assistant')" style="padding: 3px 8px;">Clear</button>
          </div>
         </div><button class="btn btn-add" onclick="addRow('assistant')">+ Add Row</button>
        </div>
        <div class="table-wrapper">
         <table class="ts-table">
          <thead>
           <tr>
            <th class="text-center" style="width:30px"><input type="checkbox" id="select-all-assistant" onchange="toggleSelectAll('assistant', this.checked)" style="cursor: pointer;"></th>
            <th class="text-center" style="width:30px">#</th>
            <th style="width:100px">Date</th>
            <th style="width:120px">Course</th>
            <th style="width:120px">Class Type</th>
            <th style="width:70px">Students</th>
            <th style="width:70px">Minutes</th>
            <th style="width:70px">Sessions</th>
            <th style="width:100px">Pay</th>
            <th style="width:150px">Notes</th>
            <th style="width:80px">Status</th>
            <th style="width:50px">Action</th>
           </tr>
          </thead>
          <tbody id="tbody-assistant"></tbody>
         </table>
        </div>
       </div><!-- OTHER TASKS Section -->
       <div class="section-container" data-section="other">
        <div class="section-header section-other"><span>üìã OTHER TASKS (Admin &amp; Academic)</span> <button class="btn btn-add" onclick="addRow('other')">+ Add Row</button>
        </div>
        <div class="table-wrapper">
         <table class="ts-table">
          <thead>
           <tr>
            <th class="text-center" style="width:30px">#</th>
            <th style="width:100px">Date</th>
            <th style="width:140px">Task Name</th>
            <th style="width:180px">Description</th>
            <th style="width:80px">Unit</th>
            <th style="width:70px">Quantity</th>
            <th style="width:100px">Pay</th>
            <th style="width:150px">Notes</th>
            <th style="width:80px">Status</th>
            <th style="width:50px">Action</th>
           </tr>
          </thead>
          <tbody id="tbody-other"></tbody>
         </table>
        </div>
       </div>
      </div>
     </div><!-- Right: Sidebar -->
     <div class="w-64 p-4 bg-slate-100 border-l border-slate-200 overflow-y-auto flex-shrink-0">
      <div class="sidebar-card mb-4">
       <div class="text-xs font-semibold text-slate-500 uppercase mb-2">
        Total Expected Pay
       </div>
       <div id="total-pay" class="text-2xl font-bold text-slate-800">
        0 VND
       </div>
      </div><!-- Manager Comment Section -->
      <div class="sidebar-card mb-4" id="manager-comment-card" style="display: none;">
       <div class="text-xs font-semibold text-slate-500 uppercase mb-2">
        Manager Comment
       </div>
       <div id="manager-comment-text" class="text-xs text-slate-700 p-3 bg-amber-50 border border-amber-200 rounded-md"></div>
      </div>
      <div class="sidebar-card">
       <div class="flex items-center gap-2 mb-3"><span class="text-xs font-semibold text-slate-500 uppercase">Warnings</span> <span id="warning-count" class="chip chip-warning">0</span>
       </div>
       <div id="warnings-list" class="text-xs text-slate-600 space-y-2">
        <p class="text-slate-400 italic">No warnings</p>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Toast Container -->
   <div class="toast-container" id="toast-container"></div><!-- Modal -->
   <div class="modal-overlay" id="modal" style="display: none;">
    <div class="modal-content">
     <h3 id="modal-title" class="text-lg font-semibold mb-2">Confirm Action</h3>
     <p id="modal-message" class="text-slate-600 mb-4">Are you sure?</p>
     <div class="flex justify-end gap-2"><button class="btn btn-secondary" onclick="closeModal()">Cancel</button> <button class="btn btn-danger" id="modal-confirm">Confirm</button>
     </div>
    </div>
   </div>
  </div>
  <script>
    // ============ Authentication URL Configuration ============
    // Allow override via window.AUTHEN_URL (parent iframe) or localStorage
    const AUTHEN_URL = window.AUTHEN_URL || 
                       localStorage.getItem("AUTHEN_URL") || 
                       "https://YOUR_DOMAIN/Authen.html";
    
    // ============ Firebase & Firestore State ============
    let db = null;
    let firebaseConfigured = false;
    
    // ============ Iframe Detection ============
    const inIframe = window.self !== window.top;
    
    // ============ Configuration ============
    const defaultConfig = {
      main_title: 'Timesheet Generator',
      subtitle_text: 'Excel-style timesheet entry'
    };

    // ============ App State ============
    let allEntries = [];
    let currentTimesheet = null;
    let currentStaffId = '';
    let currentMonth = new Date().getMonth() + 1;
    let currentYear = new Date().getFullYear();
    
    // User context (role-based access)
    let userContext = {
      role: '',
      staffId: '',
      uid: '',
      preferredName: '',
      fullName: ''
    };
    
    // Reference data (loaded from Firestore)
    let staffList = [];
    let coursesList = [];
    let courseTypesList = [];
    let classTypesList = [];
    let studentsList = [];
    let tutoringPayRates = []; // { studentCharge -> { managementFee, teacherReceive, payRateId, effectiveFrom, effectiveTo } }
    
    let isLoading = false;
    let entriesListener = null;
    let allTimesheets = [];
    let isOverviewVisible = true;
    let isTimesheetListExpanded = true;
    
    // Selection state for bulk operations
    let selectedEntries = {
      group: new Set(),
      assistant: new Set()
    };
    
    // ============ User Context Loader ============
    async function getSession() {
      // Read from sessionStorage (Authen module contract)
      const uid = sessionStorage.getItem('sessionUid');
      const role = sessionStorage.getItem('sessionRole');
      
      if (!uid || !role) {
        // Show friendly login prompt instead of immediate redirect
        showLoginPrompt();
        return null;
      }
      
      // Resolve staff record from Firestore using uid
      try {
        const staffQuery = await db.collection('staff')
          .where('authUid', '==', uid)
          .limit(1)
          .get();
        
        if (staffQuery.empty) {
          showBlockingMessage('No staff profile linked to this account. Contact admin.');
          return null;
        }
        
        const staffDoc = staffQuery.docs[0];
        const staffData = staffDoc.data();
        
        // Build user context from staff document
        const context = {
          uid: uid,
          role: role,
          staffId: staffDoc.id, // Use document ID as staffId
          preferredName: staffData.preferredName || '',
          fullName: staffData.fullName || '',
          staffData: staffData // Store full staff data if needed
        };
        
        return context;
        
      } catch (error) {
        console.error('Error loading staff profile:', error);
        showBlockingMessage('Error loading staff profile: ' + error.message);
        return null;
      }
    }
    
    async function loadUserContext() {
      const session = await getSession();
      
      if (!session) {
        return false;
      }
      
      userContext = session;
      return true;
    }
    
    function showLoginPrompt() {
      // Check if AUTHEN_URL is configured properly
      const isPlaceholder = AUTHEN_URL === "https://YOUR_DOMAIN/Authen.html";
      const isFileProtocol = AUTHEN_URL.startsWith("file://");
      const shouldShowConfig = isPlaceholder || !AUTHEN_URL;
      
      // Build return URL
      const nextUrl = encodeURIComponent(window.location.href);
      const loginUrl = `${AUTHEN_URL}?next=${nextUrl}`;
      
      // If hosted and URL is configured, redirect immediately
      if (!shouldShowConfig && !isFileProtocol && window.location.protocol !== 'file:') {
        window.location.href = loginUrl;
        return;
      }
      
      // Show friendly login UI with configuration option
      document.getElementById('main-app').innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f1f5f9;">
          <div style="text-align: center; background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 450px;">
            <svg style="width: 64px; height: 64px; margin: 0 auto 20px; color: #2563eb;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
            </svg>
            <h2 style="font-size: 20px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">Login Required</h2>
            <p style="color: #64748b; margin-bottom: 24px;">No session found. Please login via the Authen module.</p>
            
            ${shouldShowConfig ? `
              <div style="background: #fef3c7; border: 1px solid #fbbf24; padding: 12px; border-radius: 6px; margin-bottom: 20px; text-align: left;">
                <p style="color: #92400e; font-size: 13px; margin: 0;">‚ö†Ô∏è Authentication URL not configured. Please set it below.</p>
              </div>
            ` : ''}
            
            <div style="display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
              <button onclick="openLoginInNewTab()" style="background: #2563eb; color: #fff; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500;">
                Open Login
              </button>
              <button onclick="showSetLoginUrl()" style="background: #f1f5f9; color: #475569; padding: 10px 20px; border-radius: 6px; border: 1px solid #e2e8f0; cursor: pointer; font-weight: 500;">
                Set Login URL
              </button>
            </div>
            
            <div id="url-config-section" style="display: none; margin-top: 20px; text-align: left;">
              <label style="display: block; font-size: 13px; font-weight: 600; color: #475569; margin-bottom: 6px;">Authentication URL</label>
              <input type="text" id="authen-url-input" value="${AUTHEN_URL}" placeholder="https://example.com/Authen.html" style="width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px; margin-bottom: 10px;">
              <button onclick="saveAuthenUrl()" style="width: 100%; background: #059669; color: #fff; padding: 10px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500;">
                Save & Retry
              </button>
            </div>
            
            <p style="color: #94a3b8; margin-top: 20px; font-size: 12px; font-style: italic;">After logging in, return to this page to continue.</p>
          </div>
        </div>
      `;
    }
    
    function openLoginInNewTab() {
      const nextUrl = encodeURIComponent(window.location.href);
      const loginUrl = `${AUTHEN_URL}?next=${nextUrl}`;
      window.open(loginUrl, '_blank', 'noopener,noreferrer');
      
      // Show a message to refresh after login
      const container = document.querySelector('[style*="max-width: 450px"]');
      if (container) {
        const msg = document.createElement('div');
        msg.style.cssText = 'margin-top: 16px; padding: 12px; background: #dbeafe; border: 1px solid #93c5fd; border-radius: 6px; color: #1e40af; font-size: 13px;';
        msg.innerHTML = '‚úì Login page opened. After logging in, <strong>refresh this page</strong> to continue.';
        container.appendChild(msg);
      }
    }
    
    function showSetLoginUrl() {
      const section = document.getElementById('url-config-section');
      if (section) {
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
      }
    }
    
    function saveAuthenUrl() {
      const input = document.getElementById('authen-url-input');
      const url = input.value.trim();
      
      if (!url) {
        alert('Please enter a valid URL');
        return;
      }
      
      localStorage.setItem('AUTHEN_URL', url);
      
      // Show success and reload
      const section = document.getElementById('url-config-section');
      section.innerHTML = `
        <div style="background: #d1fae5; border: 1px solid #86efac; padding: 12px; border-radius: 6px; color: #065f46; font-size: 13px;">
          ‚úì URL saved! Reloading...
        </div>
      `;
      
      setTimeout(() => window.location.reload(), 1000);
    }
    
    function showBlockingMessage(message) {
      const nextUrl = encodeURIComponent(window.location.href);
      const loginUrl = `${AUTHEN_URL}?next=${nextUrl}`;
      
      document.getElementById('main-app').innerHTML = `
        <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f1f5f9;">
          <div style="text-align: center; background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); max-width: 400px;">
            <svg style="width: 64px; height: 64px; margin: 0 auto 20px; color: #dc2626;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <line x1="15" y1="9" x2="9" y2="15"/>
              <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            <h2 style="font-size: 20px; font-weight: 700; color: #1e293b; margin-bottom: 12px;">Access Denied</h2>
            <p style="color: #64748b; margin-bottom: 24px;">${message}</p>
            <button onclick="window.open('${loginUrl}', '_blank')" style="background: #2563eb; color: #fff; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500;">
              Go to Login
            </button>
          </div>
        </div>
      `;
    }
    
    function setupRoleBasedUI() {
      const isAdmin = userContext.role.toLowerCase() === 'admin';
      
      const staffSelect = document.getElementById('staff-select');
      const lockedStaffDisplay = document.getElementById('locked-staff-display');
      const lockedStaffText = document.getElementById('locked-staff-text');
      
      if (isAdmin) {
        // Admin: Show staff dropdown
        staffSelect.style.display = 'block';
        lockedStaffDisplay.style.display = 'none';
      } else {
        // Non-Admin: Hide dropdown, show locked badge
        staffSelect.style.display = 'none';
        lockedStaffDisplay.style.display = 'flex';
        
        const displayName = userContext.preferredName || userContext.fullName || userContext.staffId;
        lockedStaffText.textContent = `${displayName} (${userContext.staffId})`;
        
        // Auto-lock to current user's staffId
        currentStaffId = userContext.staffId;
        
        // Enable buttons immediately for non-Admin users
        enableButtons();
        document.getElementById('btn-overview').disabled = false;
        
        // Load their timesheet
        updateTimesheetId();
        loadTimesheet();
        loadAllTimesheets();
        
        // Show overview panel
        if (!isOverviewVisible) {
          toggleTimesheetOverview();
        }
      }
    }
    
    // ============ Firebase Setup ============
    function checkFirebaseConfig() {
      const config = localStorage.getItem('firebase_config');
      if (config) {
        try {
          const parsed = JSON.parse(config);
          initFirebase(parsed);
          return true;
        } catch (e) {
          console.error('Invalid Firebase config', e);
        }
      }
      document.getElementById('setup-panel').style.display = 'block';
      return false;
    }
    
    function saveFirebaseConfig() {
      const apiKey = document.getElementById('api-key').value.trim();
      const projectId = document.getElementById('project-id').value.trim();
      const configText = document.getElementById('firebase-config').value.trim();
      
      let config = null;
      
      // Try parsing JSON first
      if (configText) {
        try {
          config = JSON.parse(configText);
        } catch (e) {
          showSetupError('Invalid JSON format. Please check your Firebase config.');
          return;
        }
      } else if (apiKey && projectId) {
        config = {
          apiKey: apiKey,
          projectId: projectId,
          authDomain: `${projectId}.firebaseapp.com`,
          storageBucket: `${projectId}.appspot.com`,
          messagingSenderId: '000000000000',
          appId: '1:000000000000:web:0000000000000000000000'
        };
      } else {
        showSetupError('Please provide either API Key + Project ID or full Firebase config JSON.');
        return;
      }
      
      // Save and initialize
      localStorage.setItem('firebase_config', JSON.stringify(config));
      initFirebase(config);
    }
    
    function initFirebase(config) {
      try {
        if (!firebase.apps.length) {
          firebase.initializeApp(config);
        }
        db = firebase.firestore();
        firebaseConfigured = true;
        
        document.getElementById('setup-panel').style.display = 'none';
        document.getElementById('main-app').style.display = 'flex';
        document.getElementById('main-app').style.flexDirection = 'column';
        document.getElementById('main-app').style.height = '100%';
        
        showSetupSuccess('Connected to Firebase successfully!');
        
        // Load user context first (async)
        loadUserContext().then(success => {
          if (!success) {
            return; // Blocked - no valid session or redirect happened
          }
          
          // Setup role-based UI
          setupRoleBasedUI();
          
          // Load reference data
          loadReferenceData();
        });
        
      } catch (error) {
        showSetupError('Failed to connect to Firebase: ' + error.message);
        firebaseConfigured = false;
      }
    }
    
    function showSetupError(message) {
      const errorBox = document.getElementById('setup-error');
      errorBox.textContent = message;
      errorBox.style.display = 'block';
      setTimeout(() => errorBox.style.display = 'none', 5000);
    }
    
    function showSetupSuccess(message) {
      const successBox = document.getElementById('setup-success');
      successBox.textContent = message;
      successBox.style.display = 'block';
      setTimeout(() => successBox.style.display = 'none', 3000);
    }
    
    // ============ Load Reference Data ============
    async function loadReferenceData() {
      try {
        // Only load staff list if Admin
        if (userContext.role.toLowerCase() === 'admin') {
          const staffSnapshot = await db.collection('staff')
            .where('status', '==', 'active')
            .where('roles', 'array-contains', 'Teacher')
            .orderBy('preferredName')
            .get();
          
          staffList = staffSnapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          
          // Populate staff dropdown
          const staffSelect = document.getElementById('staff-select');
          staffSelect.innerHTML = '<option value="">Select Teacher</option>';
          
          staffList.forEach(staff => {
            const option = document.createElement('option');
            option.value = staff.staffId || staff.id;
            option.textContent = staff.preferredName
                ? `${staff.preferredName} (${staff.fullName})`
                : (staff.fullName || staff.staffId || staff.id);
            staffSelect.appendChild(option);
          });
        }
        
        // Load ALL courses
        const coursesSnapshot = await db.collection('courses').get();
        
        coursesList = coursesSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Load course types (ALL docs, filter in code)
        const courseTypesSnapshot = await db.collection('course_types').get();
        
        // Filter: keep if status === "active" OR isActive === true OR both fields missing
        courseTypesList = courseTypesSnapshot.docs
          .map(doc => ({
            id: doc.id,
            name: doc.data().name,
            ...doc.data()
          }))
          .filter(ct => {
            const hasStatus = ct.status !== undefined;
            const hasIsActive = ct.isActive !== undefined;
            
            // Both fields missing ‚Üí keep
            if (!hasStatus && !hasIsActive) return true;
            
            // Check if either field indicates active
            return ct.status === 'active' || ct.isActive === true;
          });
        
        courseTypesList.sort((a, b) => (a.sortOrder || 999) - (b.sortOrder || 999));
        
        // Load class types
        const classTypesSnapshot = await db.collection('classTypes').get();
        classTypesList = classTypesSnapshot.docs.map(doc => ({
          id: doc.id,
          name: doc.data().name || doc.id,
          ...doc.data()
        }));
        classTypesList.sort((a, b) => (a.sortOrder || 999) - (b.sortOrder || 999));
        
        // Populate bulk class type dropdowns
        populateBulkClassTypeDropdowns();
        
        // Load students
        const studentsSnapshot = await db.collection('students').get();
        studentsList = studentsSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Load tutoring pay rates
        const payRatesSnapshot = await db.collection('payRates')
          .where('status', '==', 'active')
          .get();
        
        const allRates = payRatesSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        // Filter to tutoring rates only (cat === 'TUTOR' or 'TUTORING')
        const rawTutoringRates = allRates.filter(rate => {
          const cat = (rate.cat || '').toUpperCase();
          return cat === 'TUTOR' || cat === 'TUTORING';
        });
        
        // Build lookup map: studentCharge -> rate data
        // If duplicates, pick the one with latest effectiveFrom
        const rateMap = {};
        rawTutoringRates.forEach(rate => {
          const charge = rate.studentCharge;
          if (charge === undefined || charge === null) return;
          
          const effectiveFrom = rate.effectiveFrom || '0000-00-00';
          
          if (!rateMap[charge] || effectiveFrom > (rateMap[charge].effectiveFrom || '0000-00-00')) {
            rateMap[charge] = {
              managementFee: rate.managementFee || 0,
              teacherReceive: rate.teacherReceive || 0,
              payRateId: rate.id,
              effectiveFrom: rate.effectiveFrom,
              effectiveTo: rate.effectiveTo
            };
          }
        });
        
        tutoringPayRates = rateMap;
        
        // Store all pay rates for group, assistant, and admin tasks
        window.groupPayRates = allRates.filter(r => (r.cat || '').toUpperCase() === 'GROUP');
        window.assistantPayRates = allRates.filter(r => (r.cat || '').toUpperCase() === 'ASSIST');
        window.adminPayRates = allRates.filter(r => (r.cat || '').toUpperCase() === 'ADMIN');
        
        showToast('Reference data loaded successfully', 'success');
        
      } catch (error) {
        showToast('Error loading reference data: ' + error.message, 'error');
        console.error('Error loading reference data:', error);
      }
    }
    
    // ============ Course Lookup Helpers ============
    function populateBulkClassTypeDropdowns() {
      ['group', 'assistant'].forEach(sectionType => {
        const dropdown = document.getElementById(`bulk-class-type-${sectionType}`);
        if (dropdown) {
          dropdown.innerHTML = '<option value="">Set Class Type</option>';
          classTypesList.forEach(ct => {
            const option = document.createElement('option');
            option.value = ct.id;
            option.textContent = ct.name || ct.id;
            dropdown.appendChild(option);
          });
        }
      });
    }
    
    function getCourseById(courseId) {
      return coursesList.find(c => c.id === courseId);
    }
    
    function getCourseTypeById(courseTypeId) {
      return courseTypesList.find(ct => ct.id === courseTypeId);
    }
    
    // ============ Rate Matching Functions ============
    
    function findGroupPayRate(classTypeId, studentsCount, entryDate) {
      if (!window.groupPayRates) return null;
      
      const entryDateStr = normalizeDate(entryDate) || formatDateYYYYMMDD(entryDate);
      
      // Find all matching rates
      const matches = window.groupPayRates.filter(rate => {
        if (rate.classTypeId !== classTypeId) return false;
        
        const minSize = rate.minSize || 0;
        const maxSize = rate.maxSize || 999;
        if (studentsCount < minSize || studentsCount > maxSize) return false;
        
        const effectiveFrom = normalizeDate(rate.effectiveFrom) || '0000-00-00';
        const effectiveTo = normalizeDate(rate.effectiveTo) || '9999-99-99';
        
        return entryDateStr >= effectiveFrom && entryDateStr <= effectiveTo;
      });
      
      if (matches.length === 0) return null;
      
      // Pick the most recent effectiveFrom
      matches.sort((a, b) => {
        const dateA = normalizeDate(a.effectiveFrom) || '0000-00-00';
        const dateB = normalizeDate(b.effectiveFrom) || '0000-00-00';
        return dateB.localeCompare(dateA);
      });
      
      return matches[0];
    }
    
    function findAssistantPayRate(classTypeId, studentsCount, entryDate) {
      if (!window.assistantPayRates) return null;
      
      const entryDateStr = normalizeDate(entryDate) || formatDateYYYYMMDD(entryDate);
      
      const matches = window.assistantPayRates.filter(rate => {
        if (rate.classTypeId !== classTypeId) return false;
        
        const minSize = rate.minSize || 0;
        const maxSize = rate.maxSize || 999;
        if (studentsCount < minSize || studentsCount > maxSize) return false;
        
        const effectiveFrom = normalizeDate(rate.effectiveFrom) || '0000-00-00';
        const effectiveTo = normalizeDate(rate.effectiveTo) || '9999-99-99';
        
        return entryDateStr >= effectiveFrom && entryDateStr <= effectiveTo;
      });
      
      if (matches.length === 0) return null;
      
      matches.sort((a, b) => {
        const dateA = normalizeDate(a.effectiveFrom) || '0000-00-00';
        const dateB = normalizeDate(b.effectiveFrom) || '0000-00-00';
        return dateB.localeCompare(dateA);
      });
      
      return matches[0];
    }
    
    function findAdminPayRate(taskName, unit) {
      if (!window.adminPayRates) return null;
      
      const matches = window.adminPayRates.filter(rate => {
        return rate.taskName === taskName && rate.rateUnit === unit;
      });
      
      if (matches.length === 0) return null;
      
      return matches[0];
    }
    
    async function updateGroupOrAssistantFieldWithRateCalc(entryId, field, value) {
      try {
        const timesheetId = getTimesheetDocId();
        const entryRef = db.collection('timesheets').doc(timesheetId).collection('entries').doc(entryId);
        
        const entryDoc = await entryRef.get();
        if (!entryDoc.exists) return;
        
        const entry = entryDoc.data();
        const entryType = entry.entryType;
        
        if (entryType !== 'group' && entryType !== 'assistant') {
          await updateEntryField(entryId, field, value);
          return;
        }
        
        // Apply the field change
        let classTypeId = entry.classTypeId || '';
        let studentsCount = parseInt(entry.studentsCount) || 0;
        let minutes = parseInt(entry.minutes) || 0;
        let entryDate = entry.date ? entry.date.toDate() : new Date();
        
        if (field === 'classTypeId') {
          classTypeId = value;
        } else if (field === 'studentsCount') {
          studentsCount = parseInt(value) || 0;
        } else if (field === 'minutes') {
          minutes = parseInt(value) || 0;
        } else if (field === 'date') {
          const parsedDate = parseDateFromDisplay(value);
          if (!parsedDate) {
            showToast('Invalid date format. Use dd-mm-yyyy', 'warning');
            return;
          }
          entryDate = parsedDate;
        }
        
        const sessions = minutes > 0 ? parseFloat((minutes / 90).toFixed(2)) : 0;
        
        // Find matching rate
        const matchingRate = entryType === 'group' 
          ? findGroupPayRate(classTypeId, studentsCount, entryDate)
          : findAssistantPayRate(classTypeId, studentsCount, entryDate);
        
        let matched = false;
        let pay = 0;
        let payRateId = '';
        let rateError = '';
        
        if (matchingRate) {
          matched = true;
          payRateId = matchingRate.id;
          
          if (entryType === 'group') {
            pay = Math.round(sessions * (matchingRate.teacherPay || 0));
          } else {
            pay = Math.round(sessions * (matchingRate.assistantPay || 0));
          }
        } else {
          if (!classTypeId) {
            rateError = 'No class type selected';
          } else if (studentsCount === 0) {
            rateError = 'Student count is zero';
          } else {
            rateError = 'No matching rate found for this class type and student count';
          }
        }
        
        const updateData = {
          pay: pay,
          sessions: sessions,
          payRateId: payRateId,
          rateMatched: matched,
          rateError: rateError,
          status: matched ? 'ok' : 'needs_review',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Add the field being updated
        if (field === 'date') {
          updateData.date = firebase.firestore.Timestamp.fromDate(entryDate);
        } else if (field === 'classTypeId') {
          updateData.classTypeId = classTypeId;
          const classType = classTypesList.find(ct => ct.id === classTypeId);
          updateData.classTypeName = classType ? classType.name : '';
        } else if (field === 'studentsCount') {
          updateData.studentsCount = studentsCount;
        } else if (field === 'minutes') {
          updateData.minutes = minutes;
        } else {
          updateData[field] = value;
        }
        
        await entryRef.update(updateData);
        
      } catch (error) {
        console.error('Error updating group/assistant entry:', error);
        showToast('Error calculating pay: ' + error.message, 'error');
      }
    }
    
    async function updateOtherTaskFieldWithRateCalc(entryId, field, value) {
      try {
        const timesheetId = getTimesheetDocId();
        const entryRef = db.collection('timesheets').doc(timesheetId).collection('entries').doc(entryId);
        
        const entryDoc = await entryRef.get();
        if (!entryDoc.exists) return;
        
        const entry = entryDoc.data();
        
        if (entry.entryType !== 'other') {
          await updateEntryField(entryId, field, value);
          return;
        }
        
        // Apply the field change
        let taskName = entry.taskName || '';
        let unit = entry.unit || '';
        let quantity = parseFloat(entry.quantity) || 0;
        let minutes = parseInt(entry.minutes) || 0;
        
        if (field === 'taskName') {
          taskName = value;
        } else if (field === 'unit') {
          unit = value;
        } else if (field === 'quantity') {
          quantity = parseFloat(value) || 0;
        } else if (field === 'minutes') {
          minutes = parseInt(value) || 0;
        }
        
        // If unit is hour, convert minutes to hours for quantity
        if (unit === 'hour' && minutes > 0) {
          quantity = parseFloat((minutes / 60).toFixed(2));
        }
        
        // Find matching rate
        const matchingRate = findAdminPayRate(taskName, unit);
        
        let matched = false;
        let pay = 0;
        let payRateId = '';
        let rateError = '';
        
        if (matchingRate) {
          matched = true;
          payRateId = matchingRate.id;
          pay = Math.round(quantity * (matchingRate.payAmount || 0));
        } else {
          // Default: 100,000 VND per unit
          const defaultPayPerUnit = 100000;
          pay = Math.round(quantity * defaultPayPerUnit);
          rateError = '';
        }
        
        const updateData = {
          pay: pay,
          payRateId: payRateId,
          rateMatched: matched,
          rateError: rateError,
          status: 'ok',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Add the field being updated
        if (field === 'taskName') {
          updateData.taskName = taskName;
        } else if (field === 'unit') {
          updateData.unit = unit;
        } else if (field === 'quantity') {
          updateData.quantity = quantity;
        } else if (field === 'minutes') {
          updateData.minutes = minutes;
          if (unit === 'hour') {
            updateData.quantity = parseFloat((minutes / 60).toFixed(2));
          }
        } else {
          updateData[field] = value;
        }
        
        await entryRef.update(updateData);
        
      } catch (error) {
        console.error('Error updating other task entry:', error);
        showToast('Error calculating pay: ' + error.message, 'error');
      }
    }
    
    // ============ Tutoring Rate Matching ============
    async function updateTutoringFieldWithRateCalc(entryId, field, value) {
      try {
        const timesheetId = getTimesheetDocId();
        const entryRef = db.collection('timesheets').doc(timesheetId).collection('entries').doc(entryId);
        
        // Re-read the entry to get current values
        const entryDoc = await entryRef.get();
        if (!entryDoc.exists) return;
        
        const entry = entryDoc.data();
        if (entry.entryType !== 'tutoring') {
          // Not a tutoring entry, just update the field normally
          await updateEntryField(entryId, field, value);
          return;
        }
        
        // Apply the field change to current values
        let studentCharge = parseInt(entry.studentCharge) || 0;
        let minutes = parseInt(entry.minutes) || 0;
        let entryDate = entry.date ? entry.date.toDate() : new Date();
        
        if (field === 'studentCharge') {
          studentCharge = parseInt(value) || 0;
        } else if (field === 'minutes') {
          minutes = parseInt(value) || 0;
        } else if (field === 'date') {
          const parsedDate = parseDateFromDisplay(value);
          if (!parsedDate) {
            showToast('Invalid date format. Use dd-mm-yyyy', 'warning');
            return;
          }
          entryDate = parsedDate;
        }
        
        const entryDateStr = formatDateYYYYMMDD(entryDate);
        
        // Try to find matching rate
        const rateData = tutoringPayRates[studentCharge];
        
        let matched = false;
        let managementFee = 0;
        let teacherReceive = 0;
        let payRateId = '';
        let rateError = '';
        
        if (rateData) {
          // Normalize rate dates to YYYY-MM-DD
          const effectiveFrom = normalizeDate(rateData.effectiveFrom) || '0000-00-00';
          const effectiveTo = normalizeDate(rateData.effectiveTo) || '9999-99-99';
          
          if (entryDateStr >= effectiveFrom && entryDateStr <= effectiveTo) {
            matched = true;
            managementFee = rateData.managementFee;
            teacherReceive = rateData.teacherReceive;
            payRateId = rateData.payRateId;
          } else {
            rateError = 'Rate exists but not effective for this date';
          }
        } else {
          rateError = 'No matching tutoring rate for this student charge';
        }
        
        // Calculate pay
        const sessions = minutes > 0 ? parseFloat((minutes / 60).toFixed(2)) : 0;
        const pay = matched ? Math.round(sessions * teacherReceive) : 0;
        
        // Build update object
        const updateData = {
          managementFee: managementFee,
          pay: pay,
          sessions: sessions,
          payRateId: payRateId,
          rateMatched: matched,
          rateError: rateError,
          matchedStudentCharge: matched ? studentCharge : 0,
          matchedTeacherReceive: matched ? teacherReceive : 0,
          matchedManagementFee: matched ? managementFee : 0,
          status: matched ? 'ok' : 'needs_review',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // Add the field being updated
        if (field === 'date') {
          updateData.date = firebase.firestore.Timestamp.fromDate(entryDate);
        } else if (field === 'studentCharge') {
          updateData.studentCharge = studentCharge;
        } else if (field === 'minutes') {
          updateData.minutes = minutes;
        } else {
          updateData[field] = value;
        }
        
        await entryRef.update(updateData);
        
      } catch (error) {
        console.error('Error updating tutoring entry:', error);
        showToast('Error calculating tutoring pay: ' + error.message, 'error');
      }
    }
    
    // Normalize date string to YYYY-MM-DD format
    function normalizeDate(dateStr) {
      if (!dateStr) return null;
      
      // If already in YYYY-MM-DD format (10 chars with dashes), return as-is
      if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
        return dateStr;
      }
      
      // Try parsing as date and reformatting
      try {
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return null;
        return formatDateYYYYMMDD(date);
      } catch {
        return null;
      }
    }
    
    function formatDateYYYYMMDD(date) {
      const d = new Date(date);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    // ============ Automatic Task Type Routing ============
    function determineTaskTypeFromCourseTypeName(courseTypeName) {
      if (courseTypeName === 'Tutoring') {
        return {
          taskType: 'Tutoring',
          entryType: 'tutoring'
        };
      }
      
      return {
        taskType: 'GroupTeaching',
        entryType: 'group'
      };
    }
    
    async function fetchCoursesInBatch(courseIds) {
      const courseMap = {};
      const uniqueIds = [...new Set(courseIds.filter(Boolean))];
      
      for (let i = 0; i < uniqueIds.length; i += 10) {
        const batchIds = uniqueIds.slice(i, i + 10);
        
        for (const courseId of batchIds) {
          try {
            const courseDoc = await db.collection('courses').doc(courseId).get();
            if (courseDoc.exists) {
              const data = courseDoc.data();
              courseMap[courseId] = {
                publicCode: data.publicCode || courseId,
                name: data.name || '',
                courseTypeId: data.courseTypeId || ''
              };
            } else {
              courseMap[courseId] = {
                publicCode: courseId,
                name: '',
                courseTypeId: ''
              };
            }
          } catch (err) {
            console.warn(`Failed to fetch course ${courseId}:`, err);
            courseMap[courseId] = {
              publicCode: courseId,
              name: '',
              courseTypeId: ''
            };
          }
        }
      }
      
      return courseMap;
    }
    
    // ============ Number Formatting ============
    function formatNumberWithThousands(num) {
      if (!num && num !== 0) return '';
      return num.toLocaleString('vi-VN');
    }
    
    function parseNumberFromFormatted(str) {
      if (!str) return 0;
      return parseInt(str.replace(/\./g, '').replace(/,/g, '')) || 0;
    }
    
    function formatNumberAsUserTypes(value) {
      // Remove all non-digit characters
      const digitsOnly = value.replace(/\D/g, '');
      if (!digitsOnly) return '';
      
      // Parse and format with thousands separator
      const num = parseInt(digitsOnly);
      return num.toLocaleString('vi-VN');
    }
    
    // ============ UI Helpers ============
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function showModal(title, message, onConfirm) {
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-message').textContent = message;
      document.getElementById('modal').style.display = 'flex';
      document.getElementById('modal-confirm').onclick = () => {
        closeModal();
        onConfirm();
      };
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
    }

    function updateTimesheetId() {
      const staff = currentStaffId || '---';
      const year = currentYear || '----';
      const month = String(currentMonth).padStart(2, '0') || '--';
      document.getElementById('timesheet-id').textContent = `TS_${staff}_${year}_${month}`;
    }

    function updateStatusChip() {
      const chip = document.getElementById('status-chip');
      if (!currentTimesheet) {
        chip.textContent = 'Draft';
        chip.className = 'chip chip-draft';
        return;
      }
      
      const status = currentTimesheet.status || 'draft';
      chip.textContent = status.charAt(0).toUpperCase() + status.slice(1);
      chip.className = `chip chip-${status}`;
    }
    
    function updateManagerComment() {
      const card = document.getElementById('manager-comment-card');
      const text = document.getElementById('manager-comment-text');
      
      // Try multiple possible field names
      const comment = currentTimesheet?.managerComment || 
                     currentTimesheet?.managercomment || 
                     currentTimesheet?.manager_comment ||
                     currentTimesheet?.comment ||
                     currentTimesheet?.rejectionReason;
      
      // Show comment if it exists, regardless of status
      if (comment) {
        text.textContent = comment;
        card.style.display = 'block';
      } else {
        card.style.display = 'none';
      }
    }

    function updateEmptyState() {
      const hasData = allEntries.length > 0;
      document.getElementById('empty-state').style.display = hasData ? 'none' : 'block';
      document.getElementById('tables-container').style.display = hasData ? 'block' : 'none';
    }
    
    function enableButtons() {
      const isAdmin = userContext.role.toLowerCase() === 'admin';
      const isLocked = currentTimesheet && currentTimesheet.status !== 'draft' && !isAdmin;
      
      document.getElementById('btn-generate').disabled = isLocked;
      document.getElementById('btn-generate-empty').disabled = isLocked;
      document.getElementById('btn-reset').disabled = isLocked;
      document.getElementById('btn-save').disabled = isLocked;
      document.getElementById('btn-submit').disabled = isLocked;
      
      // Also disable "Add Row" buttons
      document.querySelectorAll('.btn-add').forEach(btn => {
        btn.disabled = isLocked;
      });
    }
    
    function updateButtonStates() {
      const isAdmin = userContext.role.toLowerCase() === 'admin';
      const isLocked = currentTimesheet && currentTimesheet.status !== 'draft' && !isAdmin;
      
      // Generate and Reset buttons should be disabled for non-draft timesheets (unless Admin)
      document.getElementById('btn-generate').disabled = isLocked;
      document.getElementById('btn-generate-empty').disabled = isLocked;
      document.getElementById('btn-reset').disabled = isLocked;
      
      // Save and Submit buttons should be disabled for non-draft timesheets (unless Admin)
      document.getElementById('btn-save').disabled = isLocked;
      document.getElementById('btn-submit').disabled = isLocked;
      
      // Also disable "Add Row" buttons
      document.querySelectorAll('.btn-add').forEach(btn => {
        btn.disabled = isLocked;
      });
    }
    
    function disableButtons() {
      document.getElementById('btn-generate').disabled = true;
      document.getElementById('btn-generate-empty').disabled = true;
      document.getElementById('btn-reset').disabled = true;
      document.getElementById('btn-save').disabled = true;
      document.getElementById('btn-submit').disabled = true;
    }

    // ============ Firestore Operations ============
    function getTimesheetDocId() {
      return `TS_${currentStaffId}_${currentYear}_${String(currentMonth).padStart(2, '0')}`;
    }
    
    async function loadTimesheet() {
      if (!currentStaffId) return;
      
      try {
        const timesheetId = getTimesheetDocId();
        const timesheetDoc = await db.collection('timesheets').doc(timesheetId).get();
        
        if (timesheetDoc.exists) {
          currentTimesheet = { id: timesheetDoc.id, ...timesheetDoc.data() };
        } else {
          currentTimesheet = null;
        }
        
        updateStatusChip();
        updateManagerComment();
        updateButtonStates(); // Update button states based on timesheet status
        loadEntries();
        
      } catch (error) {
        showToast('Error loading timesheet: ' + error.message, 'error');
        console.error('Error loading timesheet:', error);
      }
    }
    
    function loadEntries() {
      if (entriesListener) {
        entriesListener();
      }
      
      const timesheetId = getTimesheetDocId();
      
      let isFirstLoad = true;
      
      entriesListener = db.collection('timesheets').doc(timesheetId)
        .collection('entries')
        .onSnapshot(snapshot => {
          // Store currently focused element
          const activeElement = document.activeElement;
          const activeId = activeElement?.id;
          const activeValue = activeElement?.value;
          const activeSelectionStart = activeElement?.selectionStart;
          const activeSelectionEnd = activeElement?.selectionEnd;
          
          allEntries = snapshot.docs.map(doc => ({
            id: doc.id,
            ...doc.data()
          }));
          
          // Sort entries: generated first (by date), then manual at the bottom
          allEntries.sort((a, b) => {
            const aIsManual = a.source === 'manual';
            const bIsManual = b.source === 'manual';
            
            // If one is manual and the other isn't, put manual at the bottom
            if (aIsManual && !bIsManual) return 1;
            if (!aIsManual && bIsManual) return -1;
            
            // If both are the same type, sort by date
            const aDate = a.date ? a.date.toDate() : new Date(0);
            const bDate = b.date ? b.date.toDate() : new Date(0);
            return aDate - bDate;
          });
          
          renderAllTables();
          updateSummary();
          updateEmptyState();
          
          // Restore focus after first load
          if (!isFirstLoad && activeElement && activeId) {
            const elementToFocus = document.getElementById(activeId) || 
                                   document.querySelector(`[data-entry-field="${activeId}"]`);
            if (elementToFocus) {
              elementToFocus.focus();
              if (typeof activeSelectionStart === 'number') {
                elementToFocus.setSelectionRange(activeSelectionStart, activeSelectionEnd);
              }
            }
          }
          
          isFirstLoad = false;
        }, error => {
          showToast('Error loading entries: ' + error.message, 'error');
          console.error('Error loading entries:', error);
        });
    }
    
    // ============ Event Handlers ============
    function onStaffChange() {
      // Hard guard: Non-Admin users cannot change staff
      if (userContext.role.toLowerCase() !== 'admin') {
        // Revert to locked staffId
        document.getElementById('staff-select').value = currentStaffId;
        showToast('You can only view your own timesheets', 'warning');
        return;
      }
      
      // Admin can proceed
      currentStaffId = document.getElementById('staff-select').value;
      updateTimesheetId();
      
      if (currentStaffId) {
        enableButtons();
        document.getElementById('btn-overview').disabled = false;
        loadTimesheet();
        loadAllTimesheets();
        // Show overview panel if it was hidden
        if (!isOverviewVisible) {
          toggleTimesheetOverview();
        }
      } else {
        disableButtons();
        document.getElementById('btn-overview').disabled = true;
        currentTimesheet = null;
        allEntries = [];
        allTimesheets = [];
        updateStatusChip();
        updateManagerComment();
        updateEmptyState();
        // Hide overview panel when no staff selected
        if (isOverviewVisible) {
          toggleTimesheetOverview();
        }
      }
    }
    
    async function loadAllTimesheets() {
      if (!currentStaffId) return;
      
      try {
        // Query by currentStaffId (Admin can view any staff's timesheets)
        const timesheetsSnapshot = await db.collection('timesheets')
          .where('staffId', '==', currentStaffId)
          .get();
        
        allTimesheets = timesheetsSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        if (isOverviewVisible) {
          renderTimesheetOverview();
        }
        
      } catch (error) {
        console.error('Error loading all timesheets:', error);
      }
    }
    
    function toggleTimesheetOverview() {
      isOverviewVisible = !isOverviewVisible;
      const panel = document.getElementById('timesheet-overview');
      const btnText = document.getElementById('btn-overview-text');
      
      if (isOverviewVisible) {
        panel.style.display = 'block';
        btnText.textContent = 'Close Timesheets';
        renderTimesheetOverview();
      } else {
        panel.style.display = 'none';
        btnText.textContent = 'View All Timesheets';
      }
    }
    
    function toggleTimesheetListExpanded() {
      isTimesheetListExpanded = !isTimesheetListExpanded;
      const overview = document.getElementById('timesheet-overview');
      const toggleIcon = document.getElementById('toggle-icon');
      const toggleText = document.getElementById('toggle-text');
      
      if (isTimesheetListExpanded) {
        overview.classList.remove('collapsed');
        toggleIcon.innerHTML = '<polyline points="6 9 12 15 18 9"/>';
        toggleText.textContent = 'Collapse';
      } else {
        overview.classList.add('collapsed');
        toggleIcon.innerHTML = '<polyline points="18 15 12 9 6 15"/>';
        toggleText.textContent = 'Expand';
      }
    }
    
    function renderTimesheetOverview() {
      const grid = document.getElementById('timesheet-grid');
      grid.innerHTML = '';
      
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      // Filter to only show timesheets with data
      const timesheetsWithData = allTimesheets.filter(t => t.id && t.id.startsWith(`TS_${currentStaffId}_`));
      
      if (timesheetsWithData.length === 0) {
        grid.innerHTML = '<div class="col-span-12 text-center text-slate-400 py-8">No timesheets found</div>';
        return;
      }
      
      // Sort by year and month (ascending)
      timesheetsWithData.sort((a, b) => {
        const aYear = a.year || 0;
        const aMonth = a.month || 0;
        const bYear = b.year || 0;
        const bMonth = b.month || 0;
        
        if (aYear !== bYear) return aYear - bYear;
        return aMonth - bMonth;
      });
      
      timesheetsWithData.forEach(timesheet => {
        const year = timesheet.year;
        const month = timesheet.month;
        const monthName = months[month - 1] || 'Unknown';
        
        const card = document.createElement('div');
        card.className = 'timesheet-card has-data';
        
        if (year === parseInt(currentYear) && month === parseInt(currentMonth)) {
          card.classList.add('active');
        }
        
        card.onclick = () => selectTimesheet(month, year);
        
        const status = timesheet.status || 'draft';
        const totalPay = timesheet.totalPay || 0;
        
        card.innerHTML = `
          <div class="timesheet-card-month">${monthName}</div>
          <div class="timesheet-card-year">${year}</div>
          <div class="timesheet-card-status">
            <span class="chip chip-${status}">${status}</span>
          </div>
          <div class="timesheet-card-pay">${(totalPay / 1000).toFixed(0)}k VND</div>
        `;
        
        grid.appendChild(card);
      });
    }
    
    function selectTimesheet(month, year) {
      currentMonth = month;
      currentYear = year;
      
      document.getElementById('month-select').value = String(month);
      document.getElementById('year-select').value = String(year);
      
      updateTimesheetId();
      loadTimesheet();
      
      // Re-render overview to update active state
      if (isOverviewVisible) {
        renderTimesheetOverview();
      }
    }
    
    function onPeriodChange() {
      currentMonth = parseInt(document.getElementById('month-select').value);
      currentYear = parseInt(document.getElementById('year-select').value);
      updateTimesheetId();
      
      if (currentStaffId) {
        loadTimesheet();
      }
      
      // Re-render overview to update active state
      if (isOverviewVisible) {
        renderTimesheetOverview();
      }
    }
    
    // ============ Table Rendering ============
    function getFilteredData() {
      // Show all entries since filters are removed
      return allEntries;
    }

    function renderAllTables() {
      const filtered = getFilteredData();
      
      const groupRows = filtered.filter(r => r.entryType === 'group');
      const tutoringRows = filtered.filter(r => r.entryType === 'tutoring');
      const assistantRows = filtered.filter(r => r.entryType === 'assistant');
      const otherRows = filtered.filter(r => r.entryType === 'other');

      // Calculate starting indices for continuous row numbering
      let startIdx = 0;
      
      renderTeachingTable('tbody-group', groupRows, startIdx);
      startIdx += groupRows.length;
      
      renderTutoringTable('tbody-tutoring', tutoringRows, startIdx);
      startIdx += tutoringRows.length;
      
      renderTeachingTable('tbody-assistant', assistantRows, startIdx);
      startIdx += assistantRows.length;
      
      renderOtherTable('tbody-other', otherRows, startIdx);
    }

    function renderTeachingTable(tbodyId, rows, startIdx) {
      const tbody = document.getElementById(tbodyId);
      const sectionType = tbodyId.replace('tbody-', '');
      tbody.innerHTML = '';

      if (rows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="12" class="text-center text-slate-400 py-4 text-xs">No entries in this section</td></tr>`;
        return;
      }

      const isAdmin = userContext.role.toLowerCase() === 'admin';
      const isLocked = currentTimesheet && currentTimesheet.status !== 'draft' && !isAdmin;

      rows.forEach((row, idx) => {
        const rowNumber = startIdx + idx + 1;
        const tr = document.createElement('tr');
        tr.dataset.id = row.id;
        
        // Add needs-review class if status is needs_review
        if (row.status === 'needs_review') {
          tr.classList.add('needs-review');
        }
        
        const dateStr = row.date ? formatDateForDisplay(row.date.toDate()) : '';
        const isInvalidDate = !dateStr;
        const sessions = row.sessions || 0;
        
        const courseInputAttrs = (row.source === 'generated' || isLocked) ? 'readonly class="cell-input readonly"' : 'class="cell-input"';
        const readonlyAttr = isLocked ? 'disabled' : '';

        // Build class type dropdown options
        let classTypeOptions = '<option value="">Select class type</option>';
        classTypesList.forEach(ct => {
          const selected = ct.id === row.classTypeId ? 'selected' : '';
          classTypeOptions += `<option value="${ct.id}" ${selected}>${ct.name || ct.id}</option>`;
        });
        
        const isChecked = selectedEntries[sectionType] && selectedEntries[sectionType].has(row.id);

        tr.innerHTML = `
          <td class="text-center"><input type="checkbox" ${isChecked ? 'checked' : ''} ${readonlyAttr} onchange="toggleEntrySelection('${sectionType}', '${row.id}', this.checked)" style="cursor: pointer;"></td>
          <td class="text-center text-slate-400">${rowNumber}</td>
          <td><input type="text" class="cell-input ${isInvalidDate ? 'invalid' : ''}" ${readonlyAttr} value="${dateStr}" placeholder="dd-mm-yyyy" onchange="updateWithCalculation('${row.id}', 'date', this.value, updateGroupOrAssistantFieldWithRateCalc)" data-entry-field="date-${row.id}"></td>
          <td><input type="text" ${courseInputAttrs} ${readonlyAttr} value="${row.coursePublicCode || ''}" placeholder="Course code" onchange="updateWithCalculation('${row.id}', 'coursePublicCode', this.value, updateEntryField)" data-entry-field="course-${row.id}"></td>
          <td><select class="cell-select" ${readonlyAttr} onchange="updateGroupOrAssistantFieldWithRateCalc('${row.id}', 'classTypeId', this.value)">${classTypeOptions}</select></td>
          <td><input type="number" class="cell-input" ${readonlyAttr} value="${row.studentsCount || ''}" min="0" onchange="updateWithCalculation('${row.id}', 'studentsCount', parseInt(this.value) || 0, updateGroupOrAssistantFieldWithRateCalc)" data-entry-field="students-${row.id}"></td>
          <td><input type="number" class="cell-input" ${readonlyAttr} value="${row.minutes || ''}" min="0" onchange="updateWithCalculation('${row.id}', 'minutes', parseInt(this.value) || 0, updateGroupOrAssistantFieldWithRateCalc)" data-entry-field="minutes-${row.id}"></td>
          <td class="text-center text-slate-500">${sessions}</td>
          <td><input type="text" class="cell-input readonly" value="${formatNumberWithThousands(row.pay || 0)}" readonly></td>
          <td><input type="text" class="cell-input" ${readonlyAttr} value="${row.notes || ''}" onchange="updateWithCalculation('${row.id}', 'notes', this.value, updateEntryField)" data-entry-field="notes-${row.id}"></td>
          <td>${renderStatusChip(row.status)}</td>
          <td><button class="btn-del" ${readonlyAttr} onclick="confirmDelete('${row.id}')">Del</button></td>
        `;
        tbody.appendChild(tr);
      });
      
      updateBulkControls(sectionType);
    }

    function renderTutoringTable(tbodyId, rows, startIdx) {
      const tbody = document.getElementById(tbodyId);
      tbody.innerHTML = '';

      if (rows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="12" class="text-center text-slate-400 py-4 text-xs">No entries in this section</td></tr>`;
        return;
      }

      const isAdmin = userContext.role.toLowerCase() === 'admin';
      const isLocked = currentTimesheet && currentTimesheet.status !== 'draft' && !isAdmin;

      rows.forEach((row, idx) => {
        const rowNumber = startIdx + idx + 1;
        const tr = document.createElement('tr');
        tr.dataset.id = row.id;
        
        // Add needs-review class if status is needs_review
        if (row.status === 'needs_review') {
          tr.classList.add('needs-review');
        }
        
        const dateStr = row.date ? formatDateForDisplay(row.date.toDate()) : '';
        const isInvalidDate = !dateStr;
        const sessions = row.sessions || 0;
        
        const courseInputAttrs = (row.source === 'generated' || isLocked) ? 'readonly class="cell-input readonly"' : 'class="cell-input"';
        const readonlyAttr = isLocked ? 'disabled' : '';
        
        // Determine if rate is matched
        const rateMatched = row.rateMatched === true;
        const studentChargeClass = rateMatched ? 'cell-input' : 'cell-input invalid';
        
        // Status chip
        let statusChip = '';
        if (rateMatched) {
          statusChip = '<span class="chip chip-ok">OK</span>';
        } else {
          const errorMsg = row.rateError || 'RATE NOT FOUND';
          statusChip = `<span class="chip chip-missing" title="${errorMsg}">RATE NOT FOUND</span>`;
        }

        tr.innerHTML = `
          <td class="text-center text-slate-400">${rowNumber}</td>
          <td><input type="text" class="cell-input ${isInvalidDate ? 'invalid' : ''}" ${readonlyAttr} value="${dateStr}" placeholder="dd-mm-yyyy" onchange="updateWithCalculation('${row.id}', 'date', this.value, updateTutoringFieldWithRateCalc)" data-entry-field="date-${row.id}"></td>
          <td><input type="text" ${courseInputAttrs} ${readonlyAttr} value="${row.coursePublicCode || ''}" placeholder="Course code" onchange="updateWithCalculation('${row.id}', 'coursePublicCode', this.value, updateEntryField)" data-entry-field="course-${row.id}"></td>
          <td><input type="text" class="cell-input" ${readonlyAttr} value="${row.studentName || ''}" placeholder="Student name" onchange="updateWithCalculation('${row.id}', 'studentName', this.value, updateTutoringFieldWithRateCalc)" data-entry-field="student-${row.id}"></td>
          <td><input type="text" class="${studentChargeClass}" ${readonlyAttr} value="${formatNumberWithThousands(row.studentCharge || 0)}" placeholder="0" oninput="this.value = formatNumberAsUserTypes(this.value)" onchange="updateWithCalculation('${row.id}', 'studentCharge', parseNumberFromFormatted(this.value), updateTutoringFieldWithRateCalc)" data-entry-field="charge-${row.id}"></td>
          <td><input type="text" class="cell-input readonly" value="${formatNumberWithThousands(row.managementFee || 0)}" readonly></td>
          <td><input type="number" class="cell-input" ${readonlyAttr} value="${row.minutes || ''}" min="0" onchange="updateWithCalculation('${row.id}', 'minutes', parseInt(this.value) || 0, updateTutoringFieldWithRateCalc)" data-entry-field="minutes-${row.id}"></td>
          <td class="text-center text-slate-500">${sessions}</td>
          <td><input type="text" class="cell-input readonly" value="${formatNumberWithThousands(row.pay || 0)}" readonly></td>
          <td><input type="text" class="cell-input" ${readonlyAttr} value="${row.notes || ''}" onchange="updateWithCalculation('${row.id}', 'notes', this.value, updateTutoringFieldWithRateCalc)" data-entry-field="notes-${row.id}"></td>
          <td>${statusChip}</td>
          <td><button class="btn-del" ${readonlyAttr} onclick="confirmDelete('${row.id}')">Del</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderOtherTable(tbodyId, rows, startIdx) {
      const tbody = document.getElementById(tbodyId);
      tbody.innerHTML = '';

      if (rows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="10" class="text-center text-slate-400 py-4 text-xs">No entries in this section</td></tr>`;
        return;
      }

      const isAdmin = userContext.role.toLowerCase() === 'admin';
      const isLocked = currentTimesheet && currentTimesheet.status !== 'draft' && !isAdmin;

      rows.forEach((row, idx) => {
        const rowNumber = startIdx + idx + 1;
        const tr = document.createElement('tr');
        tr.dataset.id = row.id;
        
        const dateStr = row.date ? formatDateForDisplay(row.date.toDate()) : '';
        const isInvalidDate = !dateStr;
        const readonlyAttr = isLocked ? 'disabled' : '';

        tr.innerHTML = `
          <td class="text-center text-slate-400">${rowNumber}</td>
          <td><input type="text" class="cell-input ${isInvalidDate ? 'invalid' : ''}" ${readonlyAttr} value="${dateStr}" placeholder="dd-mm-yyyy" onchange="updateWithCalculation('${row.id}', 'date', this.value, updateOtherTaskFieldWithRateCalc)" data-entry-field="date-${row.id}"></td>
          <td><input type="text" class="cell-input" ${readonlyAttr} value="${row.taskName || ''}" placeholder="Task name" onchange="updateWithCalculation('${row.id}', 'taskName', this.value, updateOtherTaskFieldWithRateCalc)" data-entry-field="task-${row.id}"></td>
          <td><input type="text" class="cell-input" ${readonlyAttr} value="${row.description || ''}" placeholder="Description" onchange="updateWithCalculation('${row.id}', 'description', this.value, updateEntryField)" data-entry-field="desc-${row.id}"></td>
          <td><input type="text" class="cell-input" ${readonlyAttr} value="${row.unit || ''}" placeholder="Unit" onchange="updateWithCalculation('${row.id}', 'unit', this.value, updateOtherTaskFieldWithRateCalc)" data-entry-field="unit-${row.id}"></td>
          <td><input type="number" class="cell-input" ${readonlyAttr} value="${row.quantity || ''}" min="0" step="0.01" onchange="updateWithCalculation('${row.id}', 'quantity', parseFloat(this.value) || 0, updateOtherTaskFieldWithRateCalc)" data-entry-field="qty-${row.id}"></td>
          <td><input type="text" class="cell-input readonly" value="${formatNumberWithThousands(row.pay || 0)}" readonly></td>
          <td><input type="text" class="cell-input" ${readonlyAttr} value="${row.notes || ''}" onchange="updateWithCalculation('${row.id}', 'notes', this.value, updateEntryField)" data-entry-field="notes-${row.id}"></td>
          <td>${renderStatusChip(row.status)}</td>
          <td><button class="btn-del" ${readonlyAttr} onclick="confirmDelete('${row.id}')">Del</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderStatusChip(status) {
      const s = status || 'needs_review';
      const cls = s === 'ok' ? 'chip-ok' : 
                  s === 'missing' ? 'chip-missing' :
                  s === 'cancelled' ? 'chip-cancelled' : 'chip-needs_review';
      return `<span class="chip ${cls}">${s.replace('_', ' ')}</span>`;
    }
    
    // ============ Date Helpers ============
    function formatDateForDisplay(date) {
      const d = new Date(date);
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}-${month}-${year}`;
    }
    
    function parseDateFromDisplay(dateStr) {
      const parts = dateStr.split('-');
      if (parts.length !== 3) return null;
      
      const day = parseInt(parts[0]);
      const month = parseInt(parts[1]) - 1;
      const year = parseInt(parts[2]);
      
      if (isNaN(day) || isNaN(month) || isNaN(year)) return null;
      
      return new Date(year, month, day);
    }
    
    // ============ Data Operations ============
    async function updateWithCalculation(entryId, field, value, updateFn) {
      try {
        await updateFn(entryId, field, value);
      } catch (error) {
        console.error('Error updating entry:', error);
        showToast('Error updating entry: ' + error.message, 'error');
      }
    }
    
    function toggleEntrySelection(sectionType, entryId, checked) {
      if (checked) {
        selectedEntries[sectionType].add(entryId);
      } else {
        selectedEntries[sectionType].delete(entryId);
      }
      updateBulkControls(sectionType);
    }
    
    function toggleSelectAll(sectionType, checked) {
      const filtered = getFilteredData();
      const sectionRows = filtered.filter(r => r.entryType === sectionType);
      
      if (checked) {
        sectionRows.forEach(row => selectedEntries[sectionType].add(row.id));
      } else {
        selectedEntries[sectionType].clear();
      }
      
      renderAllTables();
      updateBulkControls(sectionType);
    }
    
    function clearSelection(sectionType) {
      selectedEntries[sectionType].clear();
      renderAllTables();
      updateBulkControls(sectionType);
    }
    
    function updateBulkControls(sectionType) {
      const count = selectedEntries[sectionType].size;
      const controls = document.getElementById(`bulk-controls-${sectionType}`);
      const countSpan = document.getElementById(`selected-count-${sectionType}`);
      const selectAllCheckbox = document.getElementById(`select-all-${sectionType}`);
      
      const isAdmin = userContext.role.toLowerCase() === 'admin';
      const isLocked = currentTimesheet && currentTimesheet.status !== 'draft' && !isAdmin;
      
      if (controls) {
        controls.style.display = (count > 0 && !isLocked) ? 'flex' : 'none';
      }
      if (countSpan) {
        countSpan.textContent = `${count} selected`;
      }
      
      // Update select-all checkbox state
      if (selectAllCheckbox) {
        const filtered = getFilteredData();
        const sectionRows = filtered.filter(r => r.entryType === sectionType);
        const allSelected = sectionRows.length > 0 && sectionRows.every(row => selectedEntries[sectionType].has(row.id));
        selectAllCheckbox.checked = allSelected;
      }
    }
    
    async function applyBulkClassType(sectionType) {
      const classTypeId = document.getElementById(`bulk-class-type-${sectionType}`).value;
      
      if (!classTypeId) {
        showToast('Please select a class type', 'warning');
        return;
      }
      
      const selectedIds = Array.from(selectedEntries[sectionType]);
      if (selectedIds.length === 0) {
        showToast('No entries selected', 'warning');
        return;
      }
      
      try {
        const classType = classTypesList.find(ct => ct.id === classTypeId);
        const classTypeName = classType ? classType.name : '';
        
        const timesheetId = getTimesheetDocId();
        
        // Process each entry individually to trigger pay recalculation
        for (const entryId of selectedIds) {
          const entryRef = db.collection('timesheets').doc(timesheetId).collection('entries').doc(entryId);
          const entryDoc = await entryRef.get();
          
          if (!entryDoc.exists) continue;
          
          const entry = entryDoc.data();
          const studentsCount = parseInt(entry.studentsCount) || 0;
          const minutes = parseInt(entry.minutes) || 0;
          const entryDate = entry.date ? entry.date.toDate() : new Date();
          
          const sessions = minutes > 0 ? parseFloat((minutes / 90).toFixed(2)) : 0;
          
          // Find matching rate
          const matchingRate = sectionType === 'group' 
            ? findGroupPayRate(classTypeId, studentsCount, entryDate)
            : findAssistantPayRate(classTypeId, studentsCount, entryDate);
          
          let matched = false;
          let pay = 0;
          let payRateId = '';
          let rateError = '';
          
          if (matchingRate) {
            matched = true;
            payRateId = matchingRate.id;
            
            if (sectionType === 'group') {
              pay = Math.round(sessions * (matchingRate.teacherPay || 0));
            } else {
              pay = Math.round(sessions * (matchingRate.assistantPay || 0));
            }
          } else {
            if (!classTypeId) {
              rateError = 'No class type selected';
            } else if (studentsCount === 0) {
              rateError = 'Student count is zero';
            } else {
              rateError = 'No matching rate found for this class type and student count';
            }
          }
          
          await entryRef.update({
            classTypeId: classTypeId,
            classTypeName: classTypeName,
            pay: pay,
            sessions: sessions,
            payRateId: payRateId,
            rateMatched: matched,
            rateError: rateError,
            status: matched ? 'ok' : 'needs_review',
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        showToast(`Updated ${selectedIds.length} entries with pay recalculation`, 'success');
        
        // Clear selection
        selectedEntries[sectionType].clear();
        updateBulkControls(sectionType);
        
        // Reset dropdown
        document.getElementById(`bulk-class-type-${sectionType}`).value = '';
        
      } catch (error) {
        showToast('Error applying bulk update: ' + error.message, 'error');
        console.error('Error applying bulk update:', error);
      }
    }
    


    async function updateCourseType(entryId, courseTypeId) {
      try {
        const timesheetId = getTimesheetDocId();
        const entryRef = db.collection('timesheets').doc(timesheetId).collection('entries').doc(entryId);
        
        // Find the course type
        const courseType = getCourseTypeById(courseTypeId);
        const courseTypeName = courseType ? courseType.name : '';
        
        // Determine routing and session divisor
        const routing = determineTaskTypeFromCourseTypeName(courseTypeName);
        const newEntryType = routing.entryType;
        const newTaskType = routing.taskType;
        const sessionDivisor = newEntryType === 'tutoring' ? 60 : 90;
        
        // Get current entry to recalculate sessions
        const entry = allEntries.find(e => e.id === entryId);
        const minutes = entry ? (entry.minutes || 0) : 0;
        const newSessions = minutes > 0 ? parseFloat((minutes / sessionDivisor).toFixed(2)) : 0;
        
        const updateData = {
          courseTypeId: courseTypeId,
          courseTypeName: courseTypeName,
          entryType: newEntryType,
          taskType: newTaskType,
          sessions: newSessions,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        // If moving to tutoring, add tutoring fields
        if (newEntryType === 'tutoring' && entry && entry.entryType !== 'tutoring') {
          updateData.studentId = '';
          updateData.studentName = '';
          updateData.studentCharge = 0;
          updateData.managementFee = 0;
          // Remove studentsCount field
          updateData.studentsCount = firebase.firestore.FieldValue.delete();
        }
        // If moving from tutoring to group/assistant, add group fields
        else if (newEntryType !== 'tutoring' && entry && entry.entryType === 'tutoring') {
          updateData.studentsCount = 0;
          // Remove tutoring-specific fields
          updateData.studentId = firebase.firestore.FieldValue.delete();
          updateData.studentName = firebase.firestore.FieldValue.delete();
          updateData.studentCharge = firebase.firestore.FieldValue.delete();
          updateData.managementFee = firebase.firestore.FieldValue.delete();
        }
        
        await entryRef.update(updateData);
        
        showToast(`Moved to ${newEntryType === 'tutoring' ? 'Tutoring' : 'Group Teaching'} section`, 'success');
        
      } catch (error) {
        showToast('Error updating course type: ' + error.message, 'error');
        console.error('Error updating course type:', error);
      }
    }

    async function updateEntryField(entryId, field, value) {
      try {
        const timesheetId = getTimesheetDocId();
        const entryRef = db.collection('timesheets').doc(timesheetId).collection('entries').doc(entryId);
        
        const updateData = { updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
        
        if (field === 'date') {
          const parsedDate = parseDateFromDisplay(value);
          if (!parsedDate) {
            showToast('Invalid date format. Use dd-mm-yyyy', 'warning');
            return;
          }
          updateData.date = firebase.firestore.Timestamp.fromDate(parsedDate);
        } else if (field === 'minutes') {
          updateData.minutes = value;
          
          const entry = allEntries.find(e => e.id === entryId);
          if (entry) {
            let divisor = 90;
            if (entry.entryType === 'tutoring') {
              divisor = 60;
            }
            updateData.sessions = value > 0 ? parseFloat((value / divisor).toFixed(2)) : 0;
          } else {
            updateData.sessions = 0;
          }
        } else {
          updateData[field] = value;
        }
        
        await entryRef.update(updateData);
        
      } catch (error) {
        showToast('Error updating entry: ' + error.message, 'error');
        console.error('Error updating entry:', error);
      }
    }

    async function addRow(entryType) {
      if (!currentStaffId) {
        showToast('Please select a teacher first', 'warning');
        return;
      }
      
      try {
        const timesheetId = getTimesheetDocId();
        
        if (!currentTimesheet) {
          await db.collection('timesheets').doc(timesheetId).set({
            staffId: currentStaffId,
            month: currentMonth,
            year: currentYear,
            status: 'draft',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          await loadTimesheet();
        }
        
        const entryId = `ENT_${entryType}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        
        const newEntry = {
          entryType: entryType,
          date: firebase.firestore.Timestamp.fromDate(new Date(currentYear, currentMonth - 1, 1)),
          minutes: 0,
          sessions: 0,
          pay: 0,
          notes: '',
          status: 'needs_review',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          source: 'manual'
        };
        
        if (entryType === 'group' || entryType === 'assistant') {
          newEntry.courseId = '';
          newEntry.coursePublicCode = '';
          newEntry.courseTypeId = '';
          newEntry.courseTypeName = '';
          newEntry.classTypeId = '';
          newEntry.classTypeName = '';
          newEntry.studentsCount = 0;
          
          // Default minutes based on entry type
          if (entryType === 'assistant') {
            newEntry.minutes = 90;
            newEntry.sessions = 1;
          }
        } else if (entryType === 'tutoring') {
          newEntry.coursePublicCode = '';
          newEntry.studentId = '';
          newEntry.studentName = '';
          newEntry.studentCharge = 0;
          newEntry.managementFee = 0;
          newEntry.minutes = 60;
          newEntry.sessions = 1;
        } else if (entryType === 'other') {
          newEntry.taskName = '';
          newEntry.description = '';
          newEntry.unit = '';
          newEntry.quantity = 0;
        }
        
        await db.collection('timesheets').doc(timesheetId).collection('entries').doc(entryId).set(newEntry);
        
        showToast('Row added', 'success');
        
      } catch (error) {
        showToast('Error adding row: ' + error.message, 'error');
        console.error('Error adding row:', error);
      }
    }

    function confirmDelete(entryId) {
      showModal('Delete Entry', 'Are you sure you want to delete this entry?', () => deleteEntry(entryId));
    }

    async function deleteEntry(entryId) {
      try {
        const timesheetId = getTimesheetDocId();
        await db.collection('timesheets').doc(timesheetId).collection('entries').doc(entryId).delete();
        showToast('Entry deleted', 'success');
      } catch (error) {
        showToast('Error deleting entry: ' + error.message, 'error');
        console.error('Error deleting entry:', error);
      }
    }

    async function generateDraft() {
      if (!currentStaffId) {
        showToast('Please select a teacher', 'warning');
        return;
      }
      
      // Prevent generation if timesheet is locked (not draft) - but allow Admin override
      const isAdmin = userContext.role.toLowerCase() === 'admin';
      if (currentTimesheet && currentTimesheet.status !== 'draft' && !isAdmin) {
        showToast('Cannot regenerate a submitted timesheet', 'warning');
        return;
      }
      
      try {
        document.getElementById('generate-spinner').style.display = 'block';
        document.getElementById('generate-icon').style.display = 'none';
        document.getElementById('btn-generate').disabled = true;
        
        const timesheetId = getTimesheetDocId();
        
        if (!currentTimesheet) {
          await db.collection('timesheets').doc(timesheetId).set({
            staffId: currentStaffId,
            month: currentMonth,
            year: currentYear,
            status: 'draft',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            generatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        const monthStart = `${currentYear}-${String(currentMonth).padStart(2, '0')}-01`;
        const lastDay = new Date(currentYear, currentMonth, 0).getDate();
        const monthEnd = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(lastDay).padStart(2, '0')}`;
        
        // Use currentStaffId for query (Admin can generate for any staff)
        const sessionsSnapshot = await db.collection('course_sessions')
          .where('taughtByStaffId', '==', currentStaffId)
          .where('sessionDate', '>=', monthStart)
          .where('sessionDate', '<=', monthEnd)
          .get();
        
        if (sessionsSnapshot.empty) {
          showToast('No sessions found for this teacher in this month', 'info');
          return;
        }
        
        const sessions = sessionsSnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        const sessionIds = sessions.map(s => s.sessionId || s.id);
        
        const attendanceCounts = {};
        for (let i = 0; i < sessionIds.length; i += 10) {
          const batchIds = sessionIds.slice(i, i + 10);
          const attendanceSnapshot = await db.collection('attendance')
            .where('sessionId', 'in', batchIds)
            .get();
          
          attendanceSnapshot.docs.forEach(doc => {
            const sessionId = doc.data().sessionId;
            attendanceCounts[sessionId] = (attendanceCounts[sessionId] || 0) + 1;
          });
        }
        
        const courseIds = [...new Set(sessions.map(s => s.courseId).filter(Boolean))];
        const courseMap = await fetchCoursesInBatch(courseIds);
        
        const existingEntriesSnapshot = await db.collection('timesheets')
          .doc(timesheetId)
          .collection('entries')
          .get();
        
        const existingSessionIds = new Set(
          existingEntriesSnapshot.docs
            .map(doc => doc.data().refSessionId)
            .filter(Boolean)
        );
        
        const batch = db.batch();
        let addedCount = 0;
        let skippedCount = 0;
        
        for (const session of sessions) {
          const sessionId = session.sessionId || session.id;
          
          if (existingSessionIds.has(sessionId)) {
            skippedCount++;
            continue;
          }
          
          const studentsCount = attendanceCounts[sessionId] || 0;
          
          const dateParts = session.sessionDate.split('-');
          const sessionDateObj = new Date(
            parseInt(dateParts[0]),
            parseInt(dateParts[1]) - 1,
            parseInt(dateParts[2])
          );
          
          const courseData = courseMap[session.courseId] || {
            publicCode: session.courseId || '',
            name: '',
            courseTypeId: ''
          };
          
          let courseTypeId = courseData.courseTypeId || '';
          let courseTypeName = '';
          let taskType = 'GroupTeaching';
          let entryType = 'group';
          let sessionDivisor = 90;
          let defaultMinutes = 90;
          
          if (courseTypeId) {
            const courseType = getCourseTypeById(courseTypeId);
            if (courseType) {
              courseTypeName = courseType.name;
              
              const routing = determineTaskTypeFromCourseTypeName(courseTypeName);
              taskType = routing.taskType;
              entryType = routing.entryType;
              
              if (taskType === 'Tutoring') {
                sessionDivisor = 60;
                defaultMinutes = 60;
              }
            }
          }
          
          const minutes = session.durationMinutes || session.sessionLength || defaultMinutes;
          
          const entryId = `ENT_${entryType}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          const entryRef = db.collection('timesheets').doc(timesheetId).collection('entries').doc(entryId);
          
          const newEntry = {
            entryType: entryType,
            taskType: taskType,
            refSessionId: sessionId,
            date: firebase.firestore.Timestamp.fromDate(sessionDateObj),
            courseId: session.courseId || '',
            coursePublicCode: courseData.publicCode,
            courseName: courseData.name,
            courseTypeId: courseTypeId,
            courseTypeName: courseTypeName,
            classTypeId: '',
            classTypeName: '',
            studentsCount: entryType === 'tutoring' ? 0 : studentsCount,
            minutes: minutes,
            sessions: parseFloat((minutes / sessionDivisor).toFixed(2)),
            pay: 0,
            notes: (entryType !== 'tutoring' && studentsCount === 0) ? 'Missing attendance record' : '',
            status: 'needs_review',
            rateMatched: false,
            rateError: 'No class type selected',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            source: 'generated'
          };
          
          if (entryType === 'tutoring') {
            newEntry.studentId = '';
            newEntry.studentName = '';
            newEntry.studentCharge = 0;
            newEntry.managementFee = 0;
            newEntry.rateError = 'No student charge specified';
          }
          
          batch.set(entryRef, newEntry);
          addedCount++;
        }
        
        if (addedCount > 0) {
          await batch.commit();
        }
        
        showToast(`Draft generated: ${addedCount} entries added, ${skippedCount} skipped (duplicates)`, 'success');
        
        await loadTimesheet();
        await loadAllTimesheets(); // Refresh overview immediately
        
      } catch (error) {
        showToast('Error generating draft: ' + error.message, 'error');
        console.error('Error generating draft:', error);
      } finally {
        document.getElementById('generate-spinner').style.display = 'none';
        document.getElementById('generate-icon').style.display = 'block';
        document.getElementById('btn-generate').disabled = false;
      }
    }

    function confirmReset() {
      // Prevent reset if timesheet is locked (not draft) - but allow Admin override
      const isAdmin = userContext.role.toLowerCase() === 'admin';
      if (currentTimesheet && currentTimesheet.status !== 'draft' && !isAdmin) {
        showToast('Cannot reset a submitted timesheet', 'warning');
        return;
      }
      
      showModal('Reset Draft', 'This will delete all entries in this timesheet. Are you sure?', resetDraft);
    }

    async function resetDraft() {
      try {
        const timesheetId = getTimesheetDocId();
        const entriesSnapshot = await db.collection('timesheets').doc(timesheetId).collection('entries').get();
        
        const batch = db.batch();
        entriesSnapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });
        
        await batch.commit();
        
        // Update timesheet to reset totals
        await db.collection('timesheets').doc(timesheetId).update({
          totalPay: 0,
          totalMinutes: 0,
          totalSessions: 0,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast('Draft reset', 'success');
        await loadAllTimesheets(); // Refresh overview immediately
        
      } catch (error) {
        showToast('Error resetting draft: ' + error.message, 'error');
        console.error('Error resetting draft:', error);
      }
    }

    async function saveDraft() {
      if (!currentTimesheet) {
        showToast('No timesheet to save', 'warning');
        return;
      }
      
      try {
        document.getElementById('save-spinner').style.display = 'block';
        document.getElementById('save-text').style.display = 'none';
        document.getElementById('btn-save').disabled = true;
        
        const timesheetId = getTimesheetDocId();
        
        const totalPay = allEntries.reduce((sum, e) => sum + (e.pay || 0), 0);
        const totalMinutes = allEntries.reduce((sum, e) => sum + (e.minutes || 0), 0);
        const totalSessions = allEntries.reduce((sum, e) => sum + (e.sessions || 0), 0);
        
        await db.collection('timesheets').doc(timesheetId).update({
          totalPay,
          totalMinutes,
          totalSessions,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast('Draft saved successfully', 'success');
        
        // Refresh the timesheets overview
        await loadAllTimesheets();
        
      } catch (error) {
        showToast('Error saving draft: ' + error.message, 'error');
        console.error('Error saving draft:', error);
      } finally {
        document.getElementById('save-spinner').style.display = 'none';
        document.getElementById('save-text').style.display = 'inline';
        document.getElementById('btn-save').disabled = false;
      }
    }

    async function submitTimesheet() {
      if (!currentTimesheet) {
        showToast('No timesheet to submit', 'warning');
        return;
      }
      
      if (allEntries.length === 0) {
        showToast('No entries to submit', 'warning');
        return;
      }
      
      const warnings = validateTimesheet();
      if (warnings.length > 0) {
        showToast('Please fix warnings before submitting', 'warning');
        return;
      }
      
      try {
        document.getElementById('submit-spinner').style.display = 'block';
        document.getElementById('submit-icon').style.display = 'none';
        document.getElementById('btn-submit').disabled = true;
        
        const timesheetId = getTimesheetDocId();
        
        const totalPay = allEntries.reduce((sum, e) => sum + (e.pay || 0), 0);
        const totalMinutes = allEntries.reduce((sum, e) => sum + (e.minutes || 0), 0);
        const totalSessions = allEntries.reduce((sum, e) => sum + (e.sessions || 0), 0);
        
        await db.collection('timesheets').doc(timesheetId).update({
          status: 'submitted',
          submittedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          totalPay,
          totalMinutes,
          totalSessions,
          warningsCount: 0
        });
        
        showToast('Timesheet submitted successfully!', 'success');
        
        await loadTimesheet();
        await loadAllTimesheets(); // Refresh the overview to show updated status
        
      } catch (error) {
        showToast('Error submitting timesheet: ' + error.message, 'error');
        console.error('Error submitting timesheet:', error);
      } finally {
        document.getElementById('submit-spinner').style.display = 'none';
        document.getElementById('submit-icon').style.display = 'block';
        document.getElementById('btn-submit').disabled = false;
      }
    }

    // ============ Validation & Summary ============
    function validateTimesheet() {
      const warnings = [];
      
      // Get filtered data to match the display order
      const filtered = getFilteredData();
      const groupRows = filtered.filter(r => r.entryType === 'group');
      const tutoringRows = filtered.filter(r => r.entryType === 'tutoring');
      const assistantRows = filtered.filter(r => r.entryType === 'assistant');
      const otherRows = filtered.filter(r => r.entryType === 'other');
      
      // Combine in display order with correct row numbers
      const orderedEntries = [
        ...groupRows,
        ...tutoringRows,
        ...assistantRows,
        ...otherRows
      ];
      
      orderedEntries.forEach((row, idx) => {
        const rowNumber = idx + 1;
        
        if (!row.date) {
          warnings.push(`Row ${rowNumber}: Missing date`);
        }
        if ((row.entryType === 'group' || row.entryType === 'assistant') && !row.coursePublicCode) {
          warnings.push(`Row ${rowNumber}: Missing course`);
        }
        if ((row.entryType === 'group' || row.entryType === 'assistant') && !row.classTypeId) {
          warnings.push(`Row ${rowNumber}: Missing class type`);
        }
        if ((row.entryType === 'group' || row.entryType === 'assistant') && (!row.studentsCount || row.studentsCount === 0)) {
          warnings.push(`Row ${rowNumber}: Missing or zero student count`);
        }
        if (row.entryType === 'tutoring' && !row.studentName) {
          warnings.push(`Row ${rowNumber}: Missing student name`);
        }
        if (row.entryType === 'tutoring' && (!row.studentCharge || row.studentCharge === 0)) {
          warnings.push(`Row ${rowNumber}: Missing or zero student charge`);
        }
        if (row.entryType === 'other' && !row.taskName) {
          warnings.push(`Row ${rowNumber}: Missing task name`);
        }
        if (row.entryType === 'other' && !row.unit) {
          warnings.push(`Row ${rowNumber}: Missing unit`);
        }
        // Only check minutes for non-admin tasks
        if (row.entryType !== 'other' && (!row.minutes || row.minutes === 0)) {
          warnings.push(`Row ${rowNumber}: Missing or zero minutes`);
        }
        if (row.entryType === 'other' && (!row.quantity || row.quantity === 0)) {
          warnings.push(`Row ${rowNumber}: Missing or zero quantity`);
        }
        // Check for rate matching issues - skip for Other tasks (they use default 100k VND per unit)
        if (row.entryType !== 'other' && row.rateMatched === false) {
          warnings.push(`Row ${rowNumber}: ${row.rateError || 'Rate not found'}`);
        }
      });

      return warnings;
    }

    function updateSummary() {
      const totalPay = allEntries.reduce((sum, row) => sum + (row.pay || 0), 0);
      document.getElementById('total-pay').textContent = totalPay.toLocaleString('vi-VN') + ' VND';

      const warnings = validateTimesheet();
      document.getElementById('warning-count').textContent = warnings.length;
      
      const warningsList = document.getElementById('warnings-list');
      if (warnings.length === 0) {
        warningsList.innerHTML = '<p class="text-slate-400 italic">No warnings</p>';
      } else {
        warningsList.innerHTML = warnings.slice(0, 5).map(w => 
          `<div class="flex items-start gap-2"><span class="text-amber-500">‚ö†</span><span>${w}</span></div>`
        ).join('');
        if (warnings.length > 5) {
          warningsList.innerHTML += `<p class="text-slate-400 italic">...and ${warnings.length - 5} more</p>`;
        }
      }
    }

    // ============ Element SDK Setup ============
    async function initElementSDK() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (config) => {
            // Config changes no longer update UI since title is removed
          },
          mapToCapabilities: () => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['main_title', config.main_title || defaultConfig.main_title],
            ['subtitle_text', config.subtitle_text || defaultConfig.subtitle_text]
          ])
        });
      }
    }

    // ============ Initialize ============
    function init() {
      // Apply iframe compact mode
      if (inIframe) {
        document.body.classList.add('iframe-compact');
        isTimesheetListExpanded = false; // Default collapsed in iframe
      }
      
      const now = new Date();
      currentMonth = now.getMonth() + 1;
      currentYear = now.getFullYear();
      
      document.getElementById('month-select').value = String(currentMonth);
      document.getElementById('year-select').value = String(currentYear);
      
      updateTimesheetId();
      
      const firebaseConfig = {
        apiKey: "AIzaSyCDzv0HseeLfijzyXZjKWFh9QaLrMB4afo",
        authDomain: "tnl2026.firebaseapp.com",
        projectId: "tnl2026",
        storageBucket: "tnl2026.firebasestorage.app",
        messagingSenderId: "883525152224",
        appId: "1:883525152224:web:619ae152cd8df3fcca8f85",
        measurementId: "G-3K6LXCKHZ9"
      };
      
      localStorage.setItem('firebase_config', JSON.stringify(firebaseConfig));
      initFirebase(firebaseConfig);
      
      initElementSDK();
      
      // Apply initial collapsed state in iframe
      if (inIframe && !isTimesheetListExpanded) {
        const overview = document.getElementById('timesheet-overview');
        const toggleIcon = document.getElementById('toggle-icon');
        const toggleText = document.getElementById('toggle-text');
        
        overview.classList.add('collapsed');
        toggleIcon.innerHTML = '<polyline points="18 15 12 9 6 15"/>';
        toggleText.textContent = 'Expand';
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bf2c4fed29da880',t:'MTc2ODYyMDU3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>