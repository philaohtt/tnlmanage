<!doctype html>
<html lang="vi" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timesheet Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script><!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .status-submitted { background: #FEF3C7; color: #92400E; }
    .status-approved { background: #D1FAE5; color: #065F46; }
    .status-sent_to_banking { background: #DBEAFE; color: #1E40AF; }
    .status-paid { background: #E0E7FF; color: #3730A3; }
    
    .drawer-overlay {
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
    }
    
    .drawer {
      transform: translateX(100%);
      transition: transform 0.3s ease-in-out;
    }
    
    .drawer.open {
      transform: translateX(0);
    }
    
    .timeline-item::before {
      content: '';
      position: absolute;
      left: 11px;
      top: 24px;
      bottom: -16px;
      width: 2px;
      background: #E5E7EB;
    }
    
    .timeline-item:last-child::before {
      display: none;
    }

    /* Timesheet detail table styles - matching generator */
    .ts-table {
      font-size: 13px;
      border-collapse: collapse;
      width: 100%;
    }

    .ts-table thead th {
      background: #F9FAFB;
      border: 1px solid #E5E7EB;
      padding: 4px 3px;
      font-weight: 600;
      font-size: 10px;
      text-transform: uppercase;
      color: #6B7280;
      text-align: left;
      white-space: nowrap;
      line-height: 1.2;
    }

    .ts-table tbody td {
      border: 1px solid #E5E7EB;
      padding: 3px;
      background: white;
      font-size: 11px;
      line-height: 1.3;
    }

    .ts-table tbody tr:hover {
      background: #FFFBEB;
    }

    .ts-table tbody tr.needs-review {
      background: #FEF3C7;
    }

    .ts-table tbody tr.needs-review:hover {
      background: #FDE68A;
    }

    .ts-table input[type="text"],
    .ts-table input[type="number"],
    .ts-table textarea {
      width: 100%;
      border: 1px solid #D1D5DB;
      border-radius: 3px;
      padding: 2px 4px;
      font-size: 11px;
      line-height: 1.3;
    }

    .ts-table textarea {
      min-height: 24px;
      resize: vertical;
    }
    
    .ts-table select {
      width: 100%;
      border: 1px solid #D1D5DB;
      border-radius: 3px;
      padding: 2px 4px;
      font-size: 11px;
      line-height: 1.3;
    }

    .ts-table input[readonly],
    .ts-table textarea[readonly] {
      background: #F9FAFB;
      border-color: #E5E7EB;
      cursor: not-allowed;
    }

    .section-header {
      padding: 12px 16px;
      font-weight: 700;
      font-size: 14px;
      color: white;
      border-radius: 8px 8px 0 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-header.blue { background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 100%); }
    .section-header.green { background: linear-gradient(135deg, #10B981 0%, #059669 100%); }
    .section-header.purple { background: linear-gradient(135deg, #8B5CF6 0%, #6D28D9 100%); }
    .section-header.orange { background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }

    .chip.ok { background: #D1FAE5; color: #065F46; }
    .chip.missing { background: #FEE2E2; color: #991B1B; }
    .chip.cancelled { background: #E5E7EB; color: #374151; }
    .chip.needs-review { background: #FEF3C7; color: #92400E; }
    .chip.paid { background: #DBEAFE; color: #1E40AF; }

    .code-badge {
      display: inline-block;
      background: #EEF2FF;
      color: #4F46E5;
      padding: 4px 12px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-weight: 600;
      font-size: 14px;
      border: 1px solid #C7D2FE;
    }

    .detail-drawer-content {
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 24px;
      height: 100%;
    }

    .detail-drawer-content.split-view {
      grid-template-columns: 1fr 1fr 320px;
    }

    .detail-main {
      overflow-y: auto;
      padding-right: 12px;
    }

    .detail-main-split {
      overflow-y: auto;
      padding-right: 12px;
      border-right: 2px solid #E5E7EB;
      padding-right: 16px;
    }

    .detail-sidebar {
      border-left: 2px solid #E5E7EB;
      padding-left: 24px;
      overflow-y: auto;
    }

    .comparison-header {
      position: sticky;
      top: 0;
      background: white;
      z-index: 5;
      padding: 12px;
      border-bottom: 2px solid #E5E7EB;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .comparison-title {
      font-weight: 700;
      font-size: 14px;
      color: #374151;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .field-changed {
      background: #FEF3C7 !important;
      border: 2px solid #F59E0B !important;
    }

    .row-changed {
      background: #FFFBEB !important;
    }

    .new-row-highlight {
      background: #D1FAE5 !important;
      border-left: 4px solid #10B981 !important;
    }

    .summary-card {
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }

    .summary-card .value {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
    }

    .summary-card .label {
      font-size: 11px;
      color: #6B7280;
      text-transform: uppercase;
      margin-top: 4px;
    }

    .warning-item {
      display: flex;
      align-items: start;
      gap: 8px;
      padding: 8px;
      background: #FEF3C7;
      border-left: 3px solid #F59E0B;
      border-radius: 4px;
      font-size: 12px;
      color: #92400E;
    }
    
    .checkbox-cell input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    
    .table-row:hover {
      background: #F9FAFB;
    }
    
    .action-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.15s ease;
    }
    
    .action-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .multi-select-dropdown {
      position: relative;
    }
    
    .multi-select-options {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      z-index: 50;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    
    .multi-select-options.show {
      display: block;
    }
    
    .tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .bulk-bar {
      transform: translateY(100%);
      transition: transform 0.2s ease;
    }
    
    .bulk-bar.visible {
      transform: translateY(0);
    }

    .line-item-editable {
      background: #FFFBEB;
      border: 1px solid #FCD34D;
    }

    .line-item-editable input {
      background: white;
      border: 1px solid #D1D5DB;
      border-radius: 4px;
      padding: 4px 8px;
      width: 100%;
    }

    .section-collapsible {
      margin-bottom: 16px;
    }

    .section-header-clickable {
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .section-header-clickable:hover {
      opacity: 0.9;
    }

    .section-collapse-icon {
      transition: transform 0.2s ease;
    }

    .section-collapsed .section-collapse-icon {
      transform: rotate(-90deg);
    }

    .section-content {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.2s ease;
    }

    .section-collapsed .section-content {
      max-height: 0;
      opacity: 0;
    }

    .jump-bar {
      position: sticky;
      top: 0;
      z-index: 10;
      background: white;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      padding: 8px 16px;
      display: flex;
      gap: 16px;
      align-items: center;
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .jump-bar a {
      color: #6B7280;
      text-decoration: none;
      padding: 4px 12px;
      border-radius: 6px;
      transition: all 0.15s ease;
    }

    .jump-bar a:hover {
      background: #F3F4F6;
      color: #111827;
    }

    .add-row-btn {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      border: 1px solid rgba(255, 255, 255, 0.3);
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      margin-left: auto;
    }

    .add-row-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .new-row {
      background: #FEF3C7 !important;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full flex flex-col"><!-- Controls Bar -->
   <div class="bg-white border-b border-gray-200 px-6 py-4 flex-shrink-0">
    <div class="flex items-center justify-between flex-wrap gap-4">
     <div class="flex items-center gap-3 flex-wrap"><!-- Month Selector -->
      <div class="flex items-center gap-2"><label class="text-sm text-gray-600">Month:</label> <select id="month-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"> <option value="">All</option> <option value="1">January</option> <option value="2">February</option> <option value="3">March</option> <option value="4">April</option> <option value="5">May</option> <option value="6">June</option> <option value="7">July</option> <option value="8">August</option> <option value="9">September</option> <option value="10">October</option> <option value="11">November</option> <option value="12">December</option> </select>
      </div><!-- Year Selector -->
      <div class="flex items-center gap-2"><label class="text-sm text-gray-600">Year:</label> <select id="year-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"> </select>
      </div><!-- Status Multi-Select -->
      <div class="multi-select-dropdown"><button id="status-filter-btn" class="border border-gray-300 rounded-lg px-3 py-2 text-sm bg-white flex items-center gap-2 min-w-[180px] justify-between"> <span id="status-filter-label">Status</span> <i class="fas fa-chevron-down text-gray-400 text-xs"></i> </button>
       <div id="status-options" class="multi-select-options"><label class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer"> <input type="checkbox" value="submitted" class="status-checkbox" checked> <span class="tag status-submitted">Submitted</span> </label> <label class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer"> <input type="checkbox" value="approved" class="status-checkbox" checked> <span class="tag status-approved">Approved</span> </label> <label class="flex items-center gap-2 px-3 py-2 hover:bg-gray-50 cursor-pointer"> <input type="checkbox" value="paid" class="status-checkbox"> <span class="tag status-paid">Paid</span> </label>
       </div>
      </div><!-- Search Box -->
      <div class="relative"><i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i> <input type="text" id="search-box" placeholder="Search teacher / ID..." class="border border-gray-300 rounded-lg pl-10 pr-4 py-2 text-sm w-[200px] focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
      </div><!-- Refresh Button --> <button id="refresh-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"> <i class="fas fa-sync-alt"></i> Refresh </button>
     </div>
    </div>
   </div><!-- Main Content -->
   <main class="flex-1 overflow-auto px-6 py-4"><!-- Stats Summary -->
    <div class="grid grid-cols-3 gap-4 mb-6">
     <div class="bg-white rounded-xl p-4 border border-gray-200">
      <div class="flex items-center gap-3">
       <div class="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center"><i class="fas fa-inbox text-amber-600"></i>
       </div>
       <div>
        <p class="text-2xl font-bold text-gray-900" id="stat-submitted">0</p>
        <p class="text-xs text-gray-500">Submitted</p>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-xl p-4 border border-gray-200">
      <div class="flex items-center gap-3">
       <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center"><i class="fas fa-check-circle text-green-600"></i>
       </div>
       <div>
        <p class="text-2xl font-bold text-gray-900" id="stat-approved">0</p>
        <p class="text-xs text-gray-500">Approved</p>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-xl p-4 border border-gray-200">
      <div class="flex items-center gap-3">
       <div class="w-10 h-10 rounded-lg bg-indigo-100 flex items-center justify-center"><i class="fas fa-wallet text-indigo-600"></i>
       </div>
       <div>
        <p class="text-2xl font-bold text-gray-900" id="stat-paid">0</p>
        <p class="text-xs text-gray-500">Paid</p>
       </div>
      </div>
     </div>
    </div><!-- Table Container -->
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
     <div class="overflow-x-auto">
      <table class="w-full">
       <thead class="bg-gray-50 border-b border-gray-200">
        <tr>
         <th class="px-4 py-3 text-left"><input type="checkbox" id="select-all" class="w-4 h-4 cursor-pointer"></th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Teacher</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Month/Year</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Submitted At</th>
         <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Status</th>
         <th class="px-4 py-3 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Total Pay</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Paid</th>
         <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
        </tr>
       </thead>
       <tbody id="timesheet-table-body" class="divide-y divide-gray-100"><!-- Rows rendered by JS -->
       </tbody>
      </table>
     </div><!-- Pagination -->
     <div class="px-4 py-3 bg-gray-50 border-t border-gray-200 flex items-center justify-between">
      <p class="text-sm text-gray-600">Showing <span id="showing-start">1</span>-<span id="showing-end">25</span> of <span id="total-count">0</span> timesheets</p>
      <div class="flex items-center gap-2"><button id="prev-page" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"> <i class="fas fa-chevron-left"></i> </button> <span id="page-info" class="text-sm text-gray-600 px-3">Page 1 / 1</span> <button id="next-page" class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed"> <i class="fas fa-chevron-right"></i> </button>
      </div>
     </div>
    </div>
   </main><!-- Bulk Action Bar -->
   <div id="bulk-bar" class="bulk-bar fixed bottom-0 left-0 right-0 bg-indigo-600 text-white px-6 py-3 flex items-center justify-between z-40">
    <div class="flex items-center gap-3"><span id="selected-count" class="font-medium">0 selected</span> <button id="clear-selection" class="text-indigo-200 hover:text-white text-sm underline">Clear selection</button>
    </div>
    <div class="flex items-center gap-3"><button id="bulk-approve" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2"> <i class="fas fa-check"></i> Approve Selected </button>
    </div>
   </div><!-- Drawer Overlay -->
   <div id="drawer-overlay" class="drawer-overlay fixed inset-0 z-40 hidden"></div><!-- Detail Drawer -->
   <div id="detail-drawer" class="drawer fixed top-0 right-0 h-full w-full bg-white shadow-2xl z-50 flex flex-col"><!-- Drawer Header -->
    <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-indigo-50 to-blue-50">
     <div class="flex items-center gap-4"><span id="detail-timesheet-id" class="code-badge">TS-001</span>
      <div>
       <h2 id="detail-teacher-name" class="text-lg font-bold text-gray-900">Teacher Name</h2>
       <p class="text-sm text-gray-600"><span id="detail-teacher-id">TCH001</span> • <span id="detail-period">December 2024</span></p>
      </div><span id="detail-status" class="chip ok">Submitted</span>
     </div><button id="close-drawer" class="w-10 h-10 rounded-lg hover:bg-white flex items-center justify-center transition"> <i class="fas fa-times text-gray-500"></i> </button>
    </div><!-- Drawer Content - Two/Three column layout -->
    <div class="flex-1 overflow-hidden p-6">
     <div id="detail-drawer-content" class="detail-drawer-content"><!-- Original Timesheet (Left - shown in edit mode) -->
      <div id="original-view" class="detail-main-split" style="display: none;">
       <div class="comparison-header">
        <div class="comparison-title"><i class="fas fa-file-alt text-blue-600"></i> Original Timesheet
        </div><button id="collapse-original" class="text-sm text-gray-500 hover:text-gray-700"> <i class="fas fa-chevron-left"></i> Collapse </button>
       </div><!-- Original sections -->
       <div id="original-content"><!-- Rendered by JS -->
       </div>
      </div><!-- Main Content (Center/Left) -->
      <div id="main-view" class="detail-main"><!-- Edit Mode Header (shown only in edit mode) -->
       <div id="edit-view-header" class="comparison-header" style="display: none;"><button id="expand-original" class="text-sm text-gray-500 hover:text-gray-700" style="display: none;"> <i class="fas fa-chevron-right"></i> Show Original </button>
        <div class="comparison-title"><i class="fas fa-edit text-amber-600"></i> Edited Timesheet
        </div>
       </div><!-- Meta Info -->
       <div class="grid grid-cols-3 gap-4 mb-6 text-sm">
        <div>
         <p class="text-gray-500 text-xs uppercase mb-1">Submitted At</p>
         <p class="font-medium text-gray-900" id="detail-submitted">--</p>
        </div>
        <div>
         <p class="text-gray-500 text-xs uppercase mb-1">Last Manager Action</p>
         <p class="font-medium text-gray-900" id="detail-last-action">--</p>
        </div>
        <div>
         <p class="text-gray-500 text-xs uppercase mb-1">Version</p>
         <p class="font-medium text-gray-900" id="detail-version">1</p>
        </div>
       </div><!-- Jump Bar -->
       <div class="jump-bar"><span style="color: #9CA3AF;">Jump to:</span> <a href="#section-group"><i class="fas fa-chalkboard-teacher mr-1"></i>Group</a> <a href="#section-tutoring"><i class="fas fa-user-graduate mr-1"></i>Tutoring</a> <a href="#section-assistant"><i class="fas fa-hands-helping mr-1"></i>Assistant</a> <a href="#section-other"><i class="fas fa-tasks mr-1"></i>Other</a>
       </div><!-- GROUP TEACHING Section -->
       <div id="section-group" class="section-collapsible">
        <div class="section-header blue section-header-clickable" data-section="group"><i class="fas fa-chevron-down section-collapse-icon"></i> <i class="fas fa-chalkboard-teacher"></i> GROUP TEACHING <button class="add-row-btn hidden" data-section="group" onclick="addNewRow('group', event)"> <i class="fas fa-plus mr-1"></i> Add row </button>
        </div>
        <div class="section-content">
         <div class="border border-gray-200 rounded-b-lg overflow-x-auto">
          <table class="ts-table" id="group-teaching-table">
           <thead>
            <tr>
             <th style="width: 40px;">#</th>
             <th style="width: 100px;">Date</th>
             <th style="width: 120px;">Course</th>
             <th style="width: 100px;">Class Type</th>
             <th style="width: 80px;">Students</th>
             <th style="width: 80px;">Minutes</th>
             <th style="width: 80px;">Sessions</th>
             <th style="width: 100px;">Pay</th>
             <th style="width: 150px;">Notes</th>
             <th style="width: 100px;">Status</th>
            </tr>
           </thead>
           <tbody id="group-teaching-body"><!-- Rendered by JS -->
           </tbody>
          </table>
         </div>
        </div>
       </div><!-- TUTORING Section -->
       <div id="section-tutoring" class="section-collapsible">
        <div class="section-header green section-header-clickable" data-section="tutoring"><i class="fas fa-chevron-down section-collapse-icon"></i> <i class="fas fa-user-graduate"></i> TUTORING <button class="add-row-btn hidden" data-section="tutoring" onclick="addNewRow('tutoring', event)"> <i class="fas fa-plus mr-1"></i> Add row </button>
        </div>
        <div class="section-content">
         <div class="border border-gray-200 rounded-b-lg overflow-x-auto">
          <table class="ts-table" id="tutoring-table">
           <thead>
            <tr>
             <th style="width: 40px;">#</th>
             <th style="width: 100px;">Date</th>
             <th style="width: 120px;">Course</th>
             <th style="width: 150px;">Student</th>
             <th style="width: 100px;">Student Charge</th>
             <th style="width: 100px;">Mgmt Fee</th>
             <th style="width: 80px;">Minutes</th>
             <th style="width: 80px;">Sessions</th>
             <th style="width: 100px;">Pay</th>
             <th style="width: 150px;">Notes</th>
             <th style="width: 100px;">Outcome</th>
            </tr>
           </thead>
           <tbody id="tutoring-body"><!-- Rendered by JS -->
           </tbody>
          </table>
         </div>
        </div>
       </div><!-- ASSISTANT TEACHING Section -->
       <div id="section-assistant" class="section-collapsible">
        <div class="section-header purple section-header-clickable" data-section="assistant"><i class="fas fa-chevron-down section-collapse-icon"></i> <i class="fas fa-hands-helping"></i> ASSISTANT TEACHING <button class="add-row-btn hidden" data-section="assistant" onclick="addNewRow('assistant', event)"> <i class="fas fa-plus mr-1"></i> Add row </button>
        </div>
        <div class="section-content">
         <div class="border border-gray-200 rounded-b-lg overflow-x-auto">
          <table class="ts-table" id="assistant-teaching-table">
           <thead>
            <tr>
             <th style="width: 40px;">#</th>
             <th style="width: 100px;">Date</th>
             <th style="width: 120px;">Course</th>
             <th style="width: 100px;">Class Type</th>
             <th style="width: 80px;">Students</th>
             <th style="width: 80px;">Minutes</th>
             <th style="width: 80px;">Sessions</th>
             <th style="width: 100px;">Pay</th>
             <th style="width: 150px;">Notes</th>
             <th style="width: 100px;">Status</th>
            </tr>
           </thead>
           <tbody id="assistant-teaching-body"><!-- Rendered by JS -->
           </tbody>
          </table>
         </div>
        </div>
       </div><!-- OTHER TASKS Section -->
       <div id="section-other" class="section-collapsible">
        <div class="section-header orange section-header-clickable" data-section="other"><i class="fas fa-chevron-down section-collapse-icon"></i> <i class="fas fa-tasks"></i> OTHER TASKS (Admin &amp; Academic) <button class="add-row-btn hidden" data-section="other" onclick="addNewRow('other', event)"> <i class="fas fa-plus mr-1"></i> Add row </button>
        </div>
        <div class="section-content">
         <div class="border border-gray-200 rounded-b-lg overflow-x-auto">
          <table class="ts-table" id="other-tasks-table">
           <thead>
            <tr>
             <th style="width: 40px;">#</th>
             <th style="width: 100px;">Date</th>
             <th style="width: 150px;">Task Name</th>
             <th style="width: 250px;">Description</th>
             <th style="width: 80px;">Unit</th>
             <th style="width: 80px;">Quantity</th>
             <th style="width: 100px;">Pay</th>
             <th style="width: 150px;">Notes</th>
             <th style="width: 100px;">Status</th>
            </tr>
           </thead>
           <tbody id="other-tasks-body"><!-- Rendered by JS -->
           </tbody>
          </table>
         </div>
        </div>
       </div>
      </div><!-- Sidebar (Right) -->
      <div class="detail-sidebar"><!-- Total Expected Pay Card -->
       <div class="mb-6 p-4 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-xl text-white">
        <p class="text-sm opacity-90 mb-1">Total Expected Pay</p>
        <p class="text-2xl font-bold break-words" id="sidebar-total-pay" style="word-break: break-word; overflow-wrap: break-word; max-width: 100%;">0₫</p>
       </div><!-- Summary Cards -->
       <div class="grid grid-cols-2 gap-3 mb-6">
        <div class="summary-card">
         <div class="value" id="detail-total-minutes">
          0h
         </div>
         <div class="label">
          Total Hours
         </div>
        </div>
        <div class="summary-card">
         <div class="value" id="detail-total-sessions">
          0
         </div>
         <div class="label">
          Total Sessions
         </div>
        </div>
       </div><!-- Manager Comment -->
       <div class="mb-6"><label class="block font-semibold text-gray-900 mb-2 text-sm uppercase">Manager Comment</label> <textarea id="manager-comment" rows="4" class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-none" placeholder="Required for 'Return' action..."></textarea>
       </div><!-- Activity Log -->
       <div>
        <h3 class="font-semibold text-gray-900 mb-3 text-sm uppercase">Activity Timeline</h3>
        <div id="activity-log" class="space-y-3"><!-- Activity items rendered by JS -->
        </div>
       </div>
      </div>
     </div>
    </div><!-- Drawer Footer -->
    <div class="px-6 py-4 border-t border-gray-200 bg-gray-50 flex items-center justify-between gap-3"><button id="drawer-close-btn" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 transition"> <i class="fas fa-times mr-1"></i> Close </button>
     <div class="flex items-center gap-2"><button id="drawer-edit-btn" class="action-btn bg-blue-100 text-blue-700 hover:bg-blue-200"> <i class="fas fa-edit mr-1"></i> <span id="edit-btn-text">Make changes</span> </button> <button id="drawer-return-btn" class="action-btn bg-red-100 text-red-700 hover:bg-red-200"> <i class="fas fa-undo mr-1"></i> Return </button> <button id="drawer-approve-btn" class="action-btn bg-green-100 text-green-700 hover:bg-green-200"> <i class="fas fa-check mr-1"></i> Approve </button>
     </div>
    </div><!-- Edit Mode Footer (Hidden by default) -->
    <div id="edit-mode-footer" class="hidden px-6 py-4 border-t-2 border-amber-400 bg-amber-50 flex items-center justify-between gap-3">
     <div class="text-sm text-amber-800 font-medium"><i class="fas fa-edit mr-2"></i> Edit Mode Active - All fields editable except Pay
     </div>
     <div class="flex items-center gap-2"><button id="cancel-edit-btn" class="action-btn bg-gray-100 text-gray-700 hover:bg-gray-200"> <i class="fas fa-times mr-1"></i> Cancel </button> <button id="save-edit-btn" class="action-btn bg-indigo-600 text-white hover:bg-indigo-700"> <i class="fas fa-save mr-1"></i> Save Changes </button>
     </div>
    </div>
   </div>
  </div>
  <script>
    // ============================================
    // FIREBASE CONFIGURATION
    // ============================================
    
    /*
     * FIRESTORE INDEXES REQUIRED:
     * 
     * Collection: timesheets
     * - Composite index: year (ASC), month (ASC), status (ASC)
     * - Composite index: year (ASC), month (ASC)
     * 
     * To create indexes, run these queries once in Firebase Console or wait for 
     * the automatic index creation link in console errors.
     * 
     * SECURITY RULES STRUCTURE (not implemented here):
     * - Managers: can read/write all timesheets, items, activity, banking_queue
     * - Teachers: can read own timesheets (where teacherId == auth.uid)
     */
    
    const firebaseConfig = {
      apiKey: "AIzaSyCDzv0HseeLfijzyXZjKWFh9QaLrMB4afo",
      authDomain: "tnl2026.firebaseapp.com",
      projectId: "tnl2026",
      storageBucket: "tnl2026.firebasestorage.app",
      messagingSenderId: "883525152224",
      appId: "1:883525152224:web:619ae152cd8df3fcca8f85",
      measurementId: "G-3K6LXCKHZ9"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // For demo purposes - in production, get from Firebase Auth
    const CURRENT_MANAGER_ID = 'MGR-001';
    const CURRENT_MANAGER_NAME = 'Manager Demo User';

    // ============================================
    // DATA STATE
    // ============================================
    
    let timesheets = [];
    let itemsByTimesheetId = {};
    let activityByTimesheetId = {};
    let staffCache = {};

    // ============================================
    // STATE
    // ============================================
    
    let filteredTimesheets = [];
    let selectedIds = new Set();
    let currentPage = 1;
    let currentTimesheet = null;
    let currentItems = [];
    let editedItems = [];
    let newRows = []; // Track newly added rows
    let isEditMode = false;
    const PAGE_SIZE = 25;

    // Filter state
    let filters = {
      month: '',
      year: new Date().getFullYear(),
      statuses: ['submitted', 'approved'],
      search: ''
    };

    // ============================================
    // CONFIG FOR ELEMENT SDK
    // ============================================
    
    const defaultConfig = {
      page_title: 'Timesheet Manager',
      primary_color: '#4F46E5',
      secondary_color: '#F3F4F6',
      text_color: '#111827',
      accent_color: '#10B981',
      background_color: '#F9FAFB'
    };

    let config = { ...defaultConfig };

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    
    function formatCurrency(amount) {
      return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
    }

    function formatDate(dateValue) {
      // Handle Firestore Timestamp objects
      let d;
      if (dateValue && dateValue.toDate) {
        d = dateValue.toDate();
      } else if (dateValue) {
        d = new Date(dateValue);
      } else {
        return '--';
      }
      
      // Format as dd-mm-yyyy
      const day = String(d.getDate()).padStart(2, '0');
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const year = d.getFullYear();
      return `${day}-${month}-${year}`;
    }

    function formatDateTime(timestamp) {
      // Handle Firestore Timestamp objects
      let d;
      if (timestamp && timestamp.toDate) {
        d = timestamp.toDate();
      } else {
        d = new Date(timestamp);
      }
      
      // Format: "10 January 2026 at 16:23:45 UTC+7"
      const day = d.getDate();
      const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                          'July', 'August', 'September', 'October', 'November', 'December'];
      const month = monthNames[d.getMonth()];
      const year = d.getFullYear();
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      const seconds = String(d.getSeconds()).padStart(2, '0');
      
      return `${day} ${month} ${year} at ${hours}:${minutes}:${seconds} UTC+7`;
    }

    function getMonthName(month) {
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                      'July', 'August', 'September', 'October', 'November', 'December'];
      return months[month - 1] || month;
    }

    function getStatusLabel(status) {
      const labels = {
        submitted: 'Submitted',
        approved: 'Approved',
        sent_to_banking: 'Sent to Banking',
        paid: 'Paid'
      };
      return labels[status] || status;
    }

    function getActionLabel(action) {
      const labels = {
        submitted: 'Submitted',
        approved: 'Approved',
        returned: 'Returned',
        sent_to_banking: 'Sent to Banking',
        paid: 'Paid',
        marked_paid: 'Marked as Paid',
        unmarked_paid: 'Unmarked as Paid'
      };
      return labels[action] || action;
    }

    function getActionIcon(action) {
      const icons = {
        submitted: 'fa-inbox',
        approved: 'fa-check-circle',
        returned: 'fa-undo',
        sent_to_banking: 'fa-university',
        paid: 'fa-wallet',
        marked_paid: 'fa-money-check-alt',
        unmarked_paid: 'fa-times-circle'
      };
      return icons[action] || 'fa-circle';
    }

    function canEdit(status) {
      return status === 'submitted';
    }

    function canApprove(status) {
      return status === 'submitted';
    }

    function canReturn(status) {
      return status === 'submitted';
    }

    function isLocked(status) {
      return ['sent_to_banking', 'paid'].includes(status);
    }

    /**
     * Clone entries for editing with safe Timestamp handling
     * Converts Firestore Timestamps to Date objects for editable fields
     */
    function cloneEntriesForEdit(entries) {
      return entries.map(entry => {
        const cloned = { ...entry };
        
        // Convert date safely
        if (entry.date) {
          if (entry.date.toDate) {
            // Firestore Timestamp
            cloned.date = entry.date.toDate();
          } else if (entry.date instanceof Date) {
            // Already a Date
            cloned.date = new Date(entry.date);
          } else {
            // Try to parse as date string
            const parsed = new Date(entry.date);
            cloned.date = isNaN(parsed.getTime()) ? null : parsed;
          }
        } else {
          cloned.date = null;
        }
        
        return cloned;
      });
    }

    /**
     * Clone entries for baseline comparison
     * Keeps original Timestamp objects for non-editable reference
     */
    function cloneEntriesForBaseline(entries) {
      return entries.map(entry => {
        const cloned = { ...entry };
        
        // Convert date safely but keep as immutable reference
        if (entry.date) {
          if (entry.date.toDate) {
            // Firestore Timestamp - convert to Date for consistent comparison
            cloned.date = entry.date.toDate();
          } else if (entry.date instanceof Date) {
            // Already a Date - create new instance
            cloned.date = new Date(entry.date);
          } else {
            // Try to parse
            const parsed = new Date(entry.date);
            cloned.date = isNaN(parsed.getTime()) ? null : parsed;
          }
        } else {
          cloned.date = null;
        }
        
        return cloned;
      });
    }

    function toggleSection(sectionId) {
      const section = document.getElementById(`section-${sectionId}`);
      if (section) {
        section.classList.toggle('section-collapsed');
      }
    }

    function addNewRow(sectionType, event) {
      if (event) {
        event.stopPropagation();
        event.preventDefault();
      }
      
      // Generate ID using format: ENT_<entryType>_<timestamp>_<random>
      const timestamp = Date.now();
      const random = Math.random().toString(36).substr(2, 8); // 8 char random string
      const tempId = `ENT_${sectionType}_${timestamp}_${random}`;
      
      // Create a new entry object based on section type
      const newEntry = {
        entryId: tempId,
        entryType: sectionType,
        date: new Date(),
        notes: '',
        pay: 0,
        isNew: true
      };
      
      // Add section-specific fields
      if (sectionType === 'group' || sectionType === 'assistant') {
        newEntry.coursePublicCode = '';
        newEntry.courseId = '';
        newEntry.classTypeName = '';
        newEntry.studentsCount = 0;
        newEntry.minutes = 0;
        newEntry.sessions = 0;
        newEntry.status = 'ok';
      } else if (sectionType === 'tutoring') {
        newEntry.coursePublicCode = '';
        newEntry.courseId = '';
        newEntry.studentName = '';
        newEntry.studentCharge = 0;
        newEntry.managementFee = 0;
        newEntry.minutes = 0;
        newEntry.sessions = 0;
        newEntry.rateMatched = true;
      } else if (sectionType === 'other') {
        newEntry.taskName = '';
        newEntry.description = '';
        newEntry.unit = '';
        newEntry.quantity = 0;
        newEntry.status = 'ok';
      }
      
      // Add to editedItems and newRows
      editedItems.push(newEntry);
      newRows.push(tempId);
      
      // Re-render the section
      renderAllSections(true);
      
      showToast(`New row added to ${sectionType}`, 'success');
    }



    async function validateApprove(ts) {
      // Load entries if not in cache
      let entries = itemsByTimesheetId[ts.id];
      if (!entries) {
        entries = await loadTimesheetEntries(ts.id);
      }
      
      if (entries.length === 0) {
        return { valid: false, message: 'Timesheet must have at least 1 item' };
      }
      if (ts.totalPay <= 0) {
        return { valid: false, message: 'Total pay must be greater than 0' };
      }
      return { valid: true };
    }

    // ============================================
    // FIRESTORE DATA OPERATIONS
    // ============================================
    
    /**
     * Load staff information by staffId
     */
    async function loadStaffInfo(staffId) {
      if (staffCache[staffId]) {
        return staffCache[staffId];
      }
      
      try {
        const doc = await db.collection('staff').doc(staffId).get();
        if (doc.exists) {
          const staffData = doc.data();
          staffCache[staffId] = {
            preferredName: staffData.preferredName || 'Unknown',
            fullName: staffData.fullName || 'Unknown'
          };
          return staffCache[staffId];
        }
        return { preferredName: 'Unknown', fullName: 'Unknown' };
      } catch (error) {
        console.error('Error loading staff info:', error);
        return { preferredName: 'Unknown', fullName: 'Unknown' };
      }
    }
    
    /**
     * Load timesheets from Firestore for selected month/year
     */
    async function loadTimesheets() {
      try {
        console.log('Loading timesheets...', { month: filters.month, year: filters.year });
        
        let query = db.collection('timesheets')
          .where('year', '==', parseInt(filters.year));
        
        if (filters.month) {
          query = query.where('month', '==', parseInt(filters.month));
        }
        
        console.log('Executing Firestore query...');
        const snapshot = await query.get();
        console.log(`Firestore returned ${snapshot.docs.length} documents`);
        
        timesheets = await Promise.all(snapshot.docs.map(async doc => {
          const data = doc.data();
          console.log('Timesheet doc:', doc.id, data);
          
          // Cross-reference with staff collection to get teacher names
          let staffInfo = { preferredName: 'Unknown', fullName: 'Unknown' };
          if (data.staffId) {
            staffInfo = await loadStaffInfo(data.staffId);
          }
          
          return {
            id: doc.id,
            ...data,
            teacherPreferredName: staffInfo.preferredName,
            teacherFullName: staffInfo.fullName
          };
        }));
        
        console.log(`Loaded ${timesheets.length} timesheets:`, timesheets);
        applyFilters();
      } catch (error) {
        console.error('Error loading timesheets:', error);
        console.error('Error details:', error.message, error.code);
        showToast('Failed to load timesheets: ' + error.message, 'error');
      }
    }
    
    /**
     * Load entries subcollection for a timesheet (NOT items - use entries!)
     */
    async function loadTimesheetEntries(timesheetId) {
      try {
        console.log(`Loading entries for timesheet: ${timesheetId}`);
        const snapshot = await db.collection('timesheets')
          .doc(timesheetId)
          .collection('entries')
          .get();
        
        console.log(`Found ${snapshot.docs.length} entries`);
        
        let entries = snapshot.docs.map(doc => {
          const data = doc.data();
          console.log(`Entry ${doc.id}:`, data);
          return {
            entryId: doc.id,
            ...data
          };
        });
        
        // Sort entries: generated entries first (by date), then manual entries at bottom
        entries.sort((a, b) => {
          // Manual entries go last
          if (a.source === 'manual' && b.source !== 'manual') return 1;
          if (a.source !== 'manual' && b.source === 'manual') return -1;
          
          // Sort by date
          const dateA = a.date?.toDate?.() || new Date(a.date);
          const dateB = b.date?.toDate?.() || new Date(b.date);
          return dateA - dateB;
        });
        
        itemsByTimesheetId[timesheetId] = entries;
        console.log(`Loaded and sorted ${entries.length} entries`);
        return entries;
      } catch (error) {
        console.error('Error loading entries:', error);
        showToast('Failed to load timesheet entries', 'error');
        return [];
      }
    }
    
    /**
     * Load activity subcollection for a timesheet
     */
    async function loadTimesheetActivity(timesheetId) {
      try {
        const snapshot = await db.collection('timesheets')
          .doc(timesheetId)
          .collection('activity')
          .orderBy('at', 'asc')
          .get();
        
        const activity = snapshot.docs.map(doc => ({
          activityId: doc.id,
          ...doc.data()
        }));
        
        activityByTimesheetId[timesheetId] = activity;
        return activity;
      } catch (error) {
        console.error('Error loading activity:', error);
        showToast('Failed to load activity log', 'error');
        return [];
      }
    }
    
    /**
     * Add activity log entry
     */
    async function addActivityLog(timesheetId, action, note = '') {
      try {
        const activityData = {
          action,
          note,
          byStaffId: CURRENT_MANAGER_ID,
          by: CURRENT_MANAGER_NAME,
          at: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('timesheets')
          .doc(timesheetId)
          .collection('activity')
          .add(activityData);
        
        console.log('Activity logged:', action);
      } catch (error) {
        console.error('Error adding activity log:', error);
        throw error;
      }
    }

    // ============================================
    // FILTER & SEARCH FUNCTIONS
    // ============================================
    
    function applyFilters() {
      filteredTimesheets = timesheets.filter(ts => {
        // Month filter
        if (filters.month && ts.month !== parseInt(filters.month)) return false;
        
        // Year filter
        if (filters.year && ts.year !== parseInt(filters.year)) return false;
        
        // Status filter
        if (filters.statuses.length > 0 && !filters.statuses.includes(ts.status)) return false;
        
        // Search filter - matches teacher names, teacherId, or timesheet id
        if (filters.search) {
          const search = filters.search.toLowerCase();
          const matchPreferredName = ts.teacherPreferredName.toLowerCase().includes(search);
          const matchFullName = ts.teacherFullName.toLowerCase().includes(search);
          const matchTeacherId = ts.teacherId.toLowerCase().includes(search);
          const matchTimesheetId = ts.id.toLowerCase().includes(search);
          if (!matchPreferredName && !matchFullName && !matchTeacherId && !matchTimesheetId) return false;
        }
        
        return true;
      });
      
      currentPage = 1;
      selectedIds.clear();
      renderTable();
      updateStats();
      updateBulkBar();
    }

    function updateStats() {
      document.getElementById('stat-submitted').textContent = timesheets.filter(t => t.status === 'submitted').length;
      document.getElementById('stat-approved').textContent = timesheets.filter(t => t.status === 'approved').length;
      document.getElementById('stat-paid').textContent = timesheets.filter(t => t.status === 'paid').length;
    }

    // ============================================
    // RENDER FUNCTIONS
    // ============================================
    
    function renderTable() {
      const tbody = document.getElementById('timesheet-table-body');
      const start = (currentPage - 1) * PAGE_SIZE;
      const end = Math.min(start + PAGE_SIZE, filteredTimesheets.length);
      const pageData = filteredTimesheets.slice(start, end);
      
      if (pageData.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" class="px-4 py-12 text-center text-gray-500">
              <i class="fas fa-inbox text-4xl mb-3 text-gray-300"></i>
              <p>No timesheets found</p>
            </td>
          </tr>
        `;
      } else {
        tbody.innerHTML = pageData.map(ts => {
          const activity = activityByTimesheetId[ts.id] || [];
          const lastActivity = activity[activity.length - 1];
          const lastActionText = lastActivity ? `${getActionLabel(lastActivity.action)} (v${ts.version})` : `v${ts.version}`;
          
          return `
          <tr class="table-row" data-id="${ts.id}">
            <td class="px-4 py-3 checkbox-cell">
              <input type="checkbox" class="row-checkbox" data-id="${ts.id}" ${selectedIds.has(ts.id) ? 'checked' : ''} ${ts.locked ? 'disabled' : ''}>
            </td>
            <td class="px-4 py-3">
              <span class="font-mono text-sm text-indigo-600">${ts.id}</span>
            </td>
            <td class="px-4 py-3">
              <div class="font-medium text-gray-900">${ts.teacherPreferredName}</div>
              <div class="text-xs text-gray-400">${ts.teacherFullName}</div>
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">
              ${getMonthName(ts.month)} ${ts.year}
            </td>
            <td class="px-4 py-3 text-sm text-gray-600">
              ${formatDateTime(ts.submittedAt)}
            </td>
            <td class="px-4 py-3">
              <span class="tag status-${ts.status}">${getStatusLabel(ts.status)}</span>
            </td>
            <td class="px-4 py-3 text-right font-medium text-gray-900">
              ${formatCurrency(ts.totalPay)}
            </td>
            <td class="px-4 py-3 text-center">
              <input type="checkbox" class="paid-checkbox w-5 h-5 cursor-pointer" data-id="${ts.id}" ${ts.isPaid ? 'checked' : ''} ${ts.status !== 'approved' ? 'disabled opacity-50' : ''}>
            </td>
            <td class="px-4 py-3">
              <div class="flex items-center justify-center gap-1">
                <button class="action-btn bg-gray-100 text-gray-700 hover:bg-gray-200 btn-open" data-id="${ts.id}" title="View details">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="action-btn bg-gray-100 text-gray-700 hover:bg-gray-200 btn-edit" data-id="${ts.id}" title="Edit" ${!canEdit(ts.status) || ts.locked ? 'disabled' : ''}>
                  <i class="fas fa-edit"></i>
                </button>
                <button class="action-btn bg-green-100 text-green-700 hover:bg-green-200 btn-approve" data-id="${ts.id}" title="Approve" ${!canApprove(ts.status) || ts.locked ? 'disabled' : ''}>
                  <i class="fas fa-check"></i>
                </button>
                <button class="action-btn bg-red-100 text-red-700 hover:bg-red-200 btn-return" data-id="${ts.id}" title="Return" ${!canReturn(ts.status) || ts.locked ? 'disabled' : ''}>
                  <i class="fas fa-undo"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
        }).join('');
      }
      
      // Update pagination info
      document.getElementById('showing-start').textContent = filteredTimesheets.length > 0 ? start + 1 : 0;
      document.getElementById('showing-end').textContent = end;
      document.getElementById('total-count').textContent = filteredTimesheets.length;
      
      const totalPages = Math.ceil(filteredTimesheets.length / PAGE_SIZE) || 1;
      document.getElementById('page-info').textContent = `Page ${currentPage} / ${totalPages}`;
      
      document.getElementById('prev-page').disabled = currentPage === 1;
      document.getElementById('next-page').disabled = currentPage >= totalPages;
      
      // Update select all checkbox
      const selectAll = document.getElementById('select-all');
      const visibleIds = pageData.map(t => t.id);
      const allSelected = visibleIds.length > 0 && visibleIds.every(id => selectedIds.has(id));
      selectAll.checked = allSelected;
    }

    async function renderDrawer(ts) {
      currentTimesheet = ts;
      isEditMode = false;
      
      // Show drawer immediately with loading state
      document.getElementById('drawer-overlay').classList.remove('hidden');
      document.getElementById('detail-drawer').classList.add('open');
      
      // Set basic header info
      document.getElementById('detail-timesheet-id').textContent = ts.id;
      document.getElementById('detail-teacher-name').textContent = ts.teacherPreferredName;
      document.getElementById('detail-teacher-id').textContent = ts.teacherFullName;
      document.getElementById('detail-period').textContent = `${getMonthName(ts.month)} ${ts.year}`;
      
      // Set status chip
      const statusClass = {
        submitted: 'ok',
        approved: 'ok',
        needs_revision: 'needs-review',
        sent_to_banking: 'paid',
        paid: 'paid'
      }[ts.status] || 'ok';
      document.getElementById('detail-status').className = `chip ${statusClass}`;
      document.getElementById('detail-status').textContent = getStatusLabel(ts.status);
      
      // Set meta info
      document.getElementById('detail-submitted').textContent = formatDateTime(ts.submittedAt);
      document.getElementById('detail-version').textContent = ts.version || 1;
      
      // Set manager comment
      document.getElementById('manager-comment').value = ts.managerComment || '';
      
      // Show loading state for tables
      const loadingHtml = '<tr><td colspan="11" class="px-3 py-4 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</td></tr>';
      document.getElementById('group-teaching-body').innerHTML = loadingHtml;
      document.getElementById('tutoring-body').innerHTML = loadingHtml;
      document.getElementById('assistant-teaching-body').innerHTML = loadingHtml;
      document.getElementById('other-tasks-body').innerHTML = loadingHtml;
      document.getElementById('activity-log').innerHTML = '<div class="text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading activity...</div>';
      
      // Load entries and activity from Firestore
      const [entries, activity] = await Promise.all([
        loadTimesheetEntries(ts.id),
        loadTimesheetActivity(ts.id)
      ]);
      
      currentItems = entries;
      editedItems = cloneEntries(currentItems);
      baselineItems = [];
      
      const lastActivity = activity[activity.length - 1];
      const lastActionText = lastActivity ? getActionLabel(lastActivity.action) : '--';
      document.getElementById('detail-last-action').textContent = lastActionText;
      
      // Split entries by entryType (matching Generator's field names)
      const groupTeaching = entries.filter(e => e.entryType === 'group');
      const tutoring = entries.filter(e => e.entryType === 'tutoring');
      const assistantTeaching = entries.filter(e => e.entryType === 'assistant');
      const otherTasks = entries.filter(e => e.entryType === 'other');
      
      // Calculate totals from entry.pay (trust Generator's calculation)
      const totalPay = entries.reduce((sum, e) => sum + (e.pay || 0), 0);
      const totalMinutes = entries.reduce((sum, e) => sum + (e.minutes || 0), 0);
      const totalHours = (totalMinutes / 60).toFixed(1);
      const totalSessions = entries.reduce((sum, e) => sum + (e.sessions || 0), 0);
      
      // Update summary cards
      document.getElementById('sidebar-total-pay').textContent = formatCurrency(totalPay);
      document.getElementById('detail-total-minutes').textContent = totalHours + 'h';
      document.getElementById('detail-total-sessions').textContent = totalSessions;
      
      // Render each section
      renderSectionItems('group-teaching-body', groupTeaching, 'group', false);
      renderSectionItems('tutoring-body', tutoring, 'tutoring', false);
      renderSectionItems('assistant-teaching-body', assistantTeaching, 'assistant', false);
      renderSectionItems('other-tasks-body', otherTasks, 'other', false);
      
      // Render activity log
      renderActivityLog(activity);
      
      // Update button states
      updateDrawerButtons(ts.status, ts.locked);
    }

    function renderSectionItems(tbodyId, entries, sectionType, editable, isOriginal = false) {
      const tbody = document.getElementById(tbodyId);
      
      if (entries.length === 0) {
        const colspan = sectionType === 'tutoring' ? 11 : sectionType === 'other' ? 9 : 10;
        tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center text-gray-400 py-4">No entries</td></tr>`;
        return;
      }
      
      if (sectionType === 'group' || sectionType === 'assistant') {
        tbody.innerHTML = entries.map((entry, idx) => {
          const rowClass = (entry.status === 'needs_review' ? 'needs-review ' : '') + (entry.isNew ? 'new-row-highlight ' : '');
          const statusChip = getStatusChip(entry.status);
          const dateStr = formatDate(entry.date);
          const originalEntry = !isOriginal ? currentItems.find(e => e.entryId === entry.entryId) : null;
          
          const isFieldChanged = (field) => {
            if (isOriginal || !originalEntry || entry.isNew) return false;
            if (field === 'date') {
              const origDate = parseDate(originalEntry.date);
              const currDate = parseDate(entry.date);
              return origDate?.getTime() !== currDate?.getTime();
            }
            return originalEntry[field] !== entry[field];
          };
          
          if (editable && !isOriginal) {
            return `
              <tr class="${rowClass}" data-entry-id="${entry.entryId}">
                <td class="text-center text-gray-500">${idx + 1}</td>
                <td><input type="text" placeholder="dd-mm-yyyy" class="item-date ${isFieldChanged('date') ? 'field-changed' : ''}" value="${dateStr}" data-entry-id="${entry.entryId}" data-field="date"></td>
                <td><input type="text" class="item-field ${isFieldChanged('coursePublicCode') || isFieldChanged('courseId') ? 'field-changed' : ''}" value="${entry.coursePublicCode || entry.courseId || ''}" data-entry-id="${entry.entryId}" data-field="coursePublicCode"></td>
                <td><input type="text" class="item-field ${isFieldChanged('classTypeName') ? 'field-changed' : ''}" value="${entry.classTypeName || ''}" data-entry-id="${entry.entryId}" data-field="classTypeName"></td>
                <td><input type="number" class="item-field text-center ${isFieldChanged('studentsCount') ? 'field-changed' : ''}" value="${entry.studentsCount || 0}" data-entry-id="${entry.entryId}" data-field="studentsCount"></td>
                <td><input type="number" class="item-field text-right ${isFieldChanged('minutes') ? 'field-changed' : ''}" value="${entry.minutes || 0}" data-entry-id="${entry.entryId}" data-field="minutes"></td>
                <td><input type="number" class="item-field text-right ${isFieldChanged('sessions') ? 'field-changed' : ''}" value="${entry.sessions || 0}" data-entry-id="${entry.entryId}" data-field="sessions"></td>
                <td><input type="number" class="item-field text-right ${isFieldChanged('pay') ? 'field-changed' : ''}" value="${entry.pay || 0}" data-entry-id="${entry.entryId}" data-field="pay"></td>
                <td><textarea class="item-field ${isFieldChanged('notes') ? 'field-changed' : ''}" data-entry-id="${entry.entryId}" data-field="notes">${entry.notes || ''}</textarea></td>
                <td><select class="item-field ${isFieldChanged('status') ? 'field-changed' : ''}" data-entry-id="${entry.entryId}" data-field="status">
                  <option value="ok" ${entry.status === 'ok' ? 'selected' : ''}>OK</option>
                  <option value="needs_review" ${entry.status === 'needs_review' ? 'selected' : ''}>Needs Review</option>
                  <option value="cancelled" ${entry.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                </select></td>
              </tr>
            `;
          } else {
            return `
              <tr class="${rowClass}" data-entry-id="${entry.entryId}">
                <td class="text-center text-gray-500">${idx + 1}</td>
                <td><input type="text" placeholder="dd-mm-yyyy" class="item-date" value="${dateStr}" data-entry-id="${entry.entryId}" data-field="date" readonly></td>
                <td><input type="text" class="item-field" value="${entry.coursePublicCode || entry.courseId || ''}" data-entry-id="${entry.entryId}" data-field="coursePublicCode" readonly></td>
                <td><input type="text" class="item-field" value="${entry.classTypeName || ''}" data-entry-id="${entry.entryId}" data-field="classTypeName" readonly></td>
                <td><input type="number" class="item-field text-center" value="${entry.studentsCount || 0}" data-entry-id="${entry.entryId}" data-field="studentsCount" readonly></td>
                <td><input type="number" class="item-field text-right" value="${entry.minutes || 0}" data-entry-id="${entry.entryId}" data-field="minutes" readonly></td>
                <td class="text-right">${entry.sessions || 0}</td>
                <td class="text-right font-medium">${formatCurrency(entry.pay || 0)}</td>
                <td><textarea class="item-field" data-entry-id="${entry.entryId}" data-field="notes" readonly>${entry.notes || ''}</textarea></td>
                <td><select class="item-field" data-entry-id="${entry.entryId}" data-field="status" disabled>
                  <option value="ok" ${entry.status === 'ok' ? 'selected' : ''}>OK</option>
                  <option value="needs_review" ${entry.status === 'needs_review' ? 'selected' : ''}>Needs Review</option>
                  <option value="cancelled" ${entry.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                </select></td>
              </tr>
            `;
          }
        }).join('');
      } else if (sectionType === 'tutoring') {
        tbody.innerHTML = entries.map((entry, idx) => {
          const outcome = (entry.rateMatched === false || entry.rateError) ? 'needs_review' : 'ok';
          const rowClass = (outcome === 'needs_review' ? 'needs-review ' : '') + (entry.isNew ? 'new-row-highlight ' : '');
          const outcomeChip = getStatusChip(outcome);
          const dateStr = formatDate(entry.date);
          const originalEntry = !isOriginal ? currentItems.find(e => e.entryId === entry.entryId) : null;
          
          const isFieldChanged = (field) => {
            if (isOriginal || !originalEntry || entry.isNew) return false;
            if (field === 'date') {
              const origDate = parseDate(originalEntry.date);
              const currDate = parseDate(entry.date);
              return origDate?.getTime() !== currDate?.getTime();
            }
            return originalEntry[field] !== entry[field];
          };
          
          if (editable && !isOriginal) {
            return `
              <tr class="${rowClass}" data-entry-id="${entry.entryId}">
                <td class="text-center text-gray-500">${idx + 1}</td>
                <td><input type="text" placeholder="dd-mm-yyyy" class="item-date ${isFieldChanged('date') ? 'field-changed' : ''}" value="${dateStr}" data-entry-id="${entry.entryId}" data-field="date"></td>
                <td><input type="text" class="item-field ${isFieldChanged('coursePublicCode') || isFieldChanged('courseId') ? 'field-changed' : ''}" value="${entry.coursePublicCode || entry.courseId || ''}" data-entry-id="${entry.entryId}" data-field="coursePublicCode"></td>
                <td><input type="text" class="item-field ${isFieldChanged('studentName') ? 'field-changed' : ''}" value="${entry.studentName || ''}" data-entry-id="${entry.entryId}" data-field="studentName"></td>
                <td><input type="number" class="item-field text-right ${isFieldChanged('studentCharge') ? 'field-changed' : ''}" value="${entry.studentCharge || 0}" data-entry-id="${entry.entryId}" data-field="studentCharge"></td>
                <td><input type="number" class="item-field text-right ${isFieldChanged('managementFee') ? 'field-changed' : ''}" value="${entry.managementFee || 0}" data-entry-id="${entry.entryId}" data-field="managementFee"></td>
                <td><input type="number" class="item-field text-right ${isFieldChanged('minutes') ? 'field-changed' : ''}" value="${entry.minutes || 0}" data-entry-id="${entry.entryId}" data-field="minutes"></td>
                <td><input type="number" class="item-field text-right ${isFieldChanged('sessions') ? 'field-changed' : ''}" value="${entry.sessions || 0}" data-entry-id="${entry.entryId}" data-field="sessions"></td>
                <td><input type="number" class="item-field text-right ${isFieldChanged('pay') ? 'field-changed' : ''}" value="${entry.pay || 0}" data-entry-id="${entry.entryId}" data-field="pay"></td>
                <td><textarea class="item-field ${isFieldChanged('notes') ? 'field-changed' : ''}" data-entry-id="${entry.entryId}" data-field="notes">${entry.notes || ''}</textarea></td>
                <td>${outcomeChip}</td>
              </tr>
            `;
          } else {
            return `
              <tr class="${rowClass}" data-entry-id="${entry.entryId}">
                <td class="text-center text-gray-500">${idx + 1}</td>
                <td><input type="text" placeholder="dd-mm-yyyy" class="item-date" value="${dateStr}" data-entry-id="${entry.entryId}" data-field="date" readonly></td>
                <td><input type="text" class="item-field" value="${entry.coursePublicCode || entry.courseId || ''}" data-entry-id="${entry.entryId}" data-field="coursePublicCode" readonly></td>
                <td><input type="text" class="item-field" value="${entry.studentName || ''}" data-entry-id="${entry.entryId}" data-field="studentName" readonly></td>
                <td><input type="number" class="item-field text-right" value="${entry.studentCharge || 0}" data-entry-id="${entry.entryId}" data-field="studentCharge" readonly></td>
                <td><input type="number" class="item-field text-right" value="${entry.managementFee || 0}" data-entry-id="${entry.entryId}" data-field="managementFee" readonly></td>
                <td><input type="number" class="item-field text-right" value="${entry.minutes || 0}" data-entry-id="${entry.entryId}" data-field="minutes" readonly></td>
                <td class="text-right">${entry.sessions || 0}</td>
                <td class="text-right font-medium">${formatCurrency(entry.pay || 0)}</td>
                <td><textarea class="item-field" data-entry-id="${entry.entryId}" data-field="notes" readonly>${entry.notes || ''}</textarea></td>
                <td>${outcomeChip}</td>
              </tr>
            `;
          }
        }).join('');
      } else if (sectionType === 'other') {
        tbody.innerHTML = entries.map((entry, idx) => {
          const rowClass = (entry.status === 'needs_review' ? 'needs-review ' : '') + (entry.isNew ? 'new-row-highlight ' : '');
          const statusChip = getStatusChip(entry.status);
          const dateStr = formatDate(entry.date);
          const originalEntry = !isOriginal ? currentItems.find(e => e.entryId === entry.entryId) : null;
          
          const isFieldChanged = (field) => {
            if (isOriginal || !originalEntry || entry.isNew) return false;
            if (field === 'date') {
              const origDate = parseDate(originalEntry.date);
              const currDate = parseDate(entry.date);
              return origDate?.getTime() !== currDate?.getTime();
            }
            return originalEntry[field] !== entry[field];
          };
          
          if (editable && !isOriginal) {
            return `
              <tr class="${rowClass}" data-entry-id="${entry.entryId}">
                <td class="text-center text-gray-500">${idx + 1}</td>
                <td><input type="text" placeholder="dd-mm-yyyy" class="item-date ${isFieldChanged('date') ? 'field-changed' : ''}" value="${dateStr}" data-entry-id="${entry.entryId}" data-field="date"></td>
                <td><input type="text" class="item-field ${isFieldChanged('taskName') ? 'field-changed' : ''}" value="${entry.taskName || ''}" data-entry-id="${entry.entryId}" data-field="taskName"></td>
                <td><input type="text" class="item-field ${isFieldChanged('description') ? 'field-changed' : ''}" value="${entry.description || ''}" data-entry-id="${entry.entryId}" data-field="description"></td>
                <td><input type="text" class="item-field ${isFieldChanged('unit') ? 'field-changed' : ''}" value="${entry.unit || ''}" data-entry-id="${entry.entryId}" data-field="unit"></td>
                <td><input type="number" class="item-field ${isFieldChanged('quantity') ? 'field-changed' : ''}" value="${entry.quantity || 0}" data-entry-id="${entry.entryId}" data-field="quantity"></td>
                <td><input type="number" class="item-field text-right ${isFieldChanged('pay') ? 'field-changed' : ''}" value="${entry.pay || 0}" data-entry-id="${entry.entryId}" data-field="pay"></td>
                <td><textarea class="item-field ${isFieldChanged('notes') ? 'field-changed' : ''}" data-entry-id="${entry.entryId}" data-field="notes">${entry.notes || ''}</textarea></td>
                <td><select class="item-field ${isFieldChanged('status') ? 'field-changed' : ''}" data-entry-id="${entry.entryId}" data-field="status">
                  <option value="ok" ${entry.status === 'ok' ? 'selected' : ''}>OK</option>
                  <option value="needs_review" ${entry.status === 'needs_review' ? 'selected' : ''}>Needs Review</option>
                  <option value="pending" ${entry.status === 'pending' ? 'selected' : ''}>Pending</option>
                </select></td>
              </tr>
            `;
          } else {
            return `
              <tr class="${rowClass}" data-entry-id="${entry.entryId}">
                <td class="text-center text-gray-500">${idx + 1}</td>
                <td><input type="text" placeholder="dd-mm-yyyy" class="item-date" value="${dateStr}" data-entry-id="${entry.entryId}" data-field="date" readonly></td>
                <td><input type="text" class="item-field" value="${entry.taskName || ''}" data-entry-id="${entry.entryId}" data-field="taskName" readonly></td>
                <td><input type="text" class="item-field" value="${entry.description || ''}" data-entry-id="${entry.entryId}" data-field="description" readonly></td>
                <td><input type="text" class="item-field" value="${entry.unit || ''}" data-entry-id="${entry.entryId}" data-field="unit" readonly></td>
                <td><input type="number" class="item-field" value="${entry.quantity || 0}" data-entry-id="${entry.entryId}" data-field="quantity" readonly></td>
                <td class="text-right font-medium">${formatCurrency(entry.pay || 0)}</td>
                <td><textarea class="item-field" data-entry-id="${entry.entryId}" data-field="notes" readonly>${entry.notes || ''}</textarea></td>
                <td><select class="item-field" data-entry-id="${entry.entryId}" data-field="status" disabled>
                  <option value="ok" ${entry.status === 'ok' ? 'selected' : ''}>OK</option>
                  <option value="needs_review" ${entry.status === 'needs_review' ? 'selected' : ''}>Needs Review</option>
                  <option value="pending" ${entry.status === 'pending' ? 'selected' : ''}>Pending</option>
                </select></td>
              </tr>
            `;
          }
        }).join('');
      }
      
      // Add event listeners for editable fields if in edit mode
      if (editable && !isOriginal) {
        document.querySelectorAll('.item-field, .item-date').forEach(input => {
          input.addEventListener('input', handleItemEdit);
          input.addEventListener('change', handleItemEdit);
        });
      }
    }

    function getStatusChip(status) {
      const chipMap = {
        ok: '<span class="chip ok">OK</span>',
        missing: '<span class="chip missing">Missing</span>',
        cancelled: '<span class="chip cancelled">Cancelled</span>',
        needs_review: '<span class="chip needs-review">Needs Review</span>',
        completed: '<span class="chip ok">Completed</span>',
        pending: '<span class="chip needs-review">Pending</span>'
      };
      return chipMap[status] || '<span class="chip ok">OK</span>';
    }

    function handleItemEdit(e) {
      const entryId = e.target.dataset.entryId;
      const field = e.target.dataset.field;
      
      if (!field || !entryId) return;
      
      const entry = editedItems.find(i => i.entryId === entryId);
      if (!entry) return;
      
      // Get value based on input type
      let value;
      if (e.target.type === 'number') {
        value = parseFloat(e.target.value) || 0;
      } else if (e.target.classList.contains('item-date')) {
        // Parse dd-mm-yyyy format to Date object
        const parts = e.target.value.split('-');
        if (parts.length === 3) {
          const day = parseInt(parts[0], 10);
          const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
          const year = parseInt(parts[2], 10);
          value = new Date(year, month, day);
        } else {
          value = new Date();
        }
      } else if (e.target.tagName === 'SELECT') {
        value = e.target.value;
      } else {
        value = e.target.value;
      }
      
      entry[field] = value;
    }

    function renderOriginalSections() {
      // Create the full HTML structure for original sections
      const html = `
        <!-- GROUP TEACHING Section -->
        <div id="section-group-original" class="section-collapsible">
          <div class="section-header blue section-header-clickable" data-section="group-original">
            <i class="fas fa-chevron-down section-collapse-icon"></i>
            <i class="fas fa-chalkboard-teacher"></i>
            GROUP TEACHING
          </div>
          <div class="section-content">
            <div class="border border-gray-200 rounded-b-lg overflow-x-auto">
              <table class="ts-table" id="group-teaching-table-original">
                <thead>
                  <tr>
                    <th style="width: 40px;">#</th>
                    <th style="width: 100px;">Date</th>
                    <th style="width: 120px;">Course</th>
                    <th style="width: 100px;">Class Type</th>
                    <th style="width: 80px;">Students</th>
                    <th style="width: 80px;">Minutes</th>
                    <th style="width: 80px;">Sessions</th>
                    <th style="width: 100px;">Pay</th>
                    <th style="width: 150px;">Notes</th>
                    <th style="width: 100px;">Status</th>
                  </tr>
                </thead>
                <tbody id="group-teaching-body-original"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- TUTORING Section -->
        <div id="section-tutoring-original" class="section-collapsible">
          <div class="section-header green section-header-clickable" data-section="tutoring-original">
            <i class="fas fa-chevron-down section-collapse-icon"></i>
            <i class="fas fa-user-graduate"></i>
            TUTORING
          </div>
          <div class="section-content">
            <div class="border border-gray-200 rounded-b-lg overflow-x-auto">
              <table class="ts-table" id="tutoring-table-original">
                <thead>
                  <tr>
                    <th style="width: 40px;">#</th>
                    <th style="width: 100px;">Date</th>
                    <th style="width: 120px;">Course</th>
                    <th style="width: 150px;">Student</th>
                    <th style="width: 100px;">Student Charge</th>
                    <th style="width: 100px;">Mgmt Fee</th>
                    <th style="width: 80px;">Minutes</th>
                    <th style="width: 80px;">Sessions</th>
                    <th style="width: 100px;">Pay</th>
                    <th style="width: 150px;">Notes</th>
                    <th style="width: 100px;">Outcome</th>
                  </tr>
                </thead>
                <tbody id="tutoring-body-original"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- ASSISTANT TEACHING Section -->
        <div id="section-assistant-original" class="section-collapsible">
          <div class="section-header purple section-header-clickable" data-section="assistant-original">
            <i class="fas fa-chevron-down section-collapse-icon"></i>
            <i class="fas fa-hands-helping"></i>
            ASSISTANT TEACHING
          </div>
          <div class="section-content">
            <div class="border border-gray-200 rounded-b-lg overflow-x-auto">
              <table class="ts-table" id="assistant-teaching-table-original">
                <thead>
                  <tr>
                    <th style="width: 40px;">#</th>
                    <th style="width: 100px;">Date</th>
                    <th style="width: 120px;">Course</th>
                    <th style="width: 100px;">Class Type</th>
                    <th style="width: 80px;">Students</th>
                    <th style="width: 80px;">Minutes</th>
                    <th style="width: 80px;">Sessions</th>
                    <th style="width: 100px;">Pay</th>
                    <th style="width: 150px;">Notes</th>
                    <th style="width: 100px;">Status</th>
                  </tr>
                </thead>
                <tbody id="assistant-teaching-body-original"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- OTHER TASKS Section -->
        <div id="section-other-original" class="section-collapsible">
          <div class="section-header orange section-header-clickable" data-section="other-original">
            <i class="fas fa-chevron-down section-collapse-icon"></i>
            <i class="fas fa-tasks"></i>
            OTHER TASKS (Admin & Academic)
          </div>
          <div class="section-content">
            <div class="border border-gray-200 rounded-b-lg overflow-x-auto">
              <table class="ts-table" id="other-tasks-table-original">
                <thead>
                  <tr>
                    <th style="width: 40px;">#</th>
                    <th style="width: 100px;">Date</th>
                    <th style="width: 150px;">Task Name</th>
                    <th style="width: 250px;">Description</th>
                    <th style="width: 80px;">Unit</th>
                    <th style="width: 80px;">Quantity</th>
                    <th style="width: 100px;">Pay</th>
                    <th style="width: 150px;">Notes</th>
                    <th style="width: 100px;">Status</th>
                  </tr>
                </thead>
                <tbody id="other-tasks-body-original"></tbody>
              </table>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('original-content').innerHTML = html;
      
      // Render data for original sections (from baseline)
      const groupTeaching = baselineItems.filter(e => e.entryType === 'group');
      const tutoring = baselineItems.filter(e => e.entryType === 'tutoring');
      const assistantTeaching = baselineItems.filter(e => e.entryType === 'assistant');
      const otherTasks = baselineItems.filter(e => e.entryType === 'other');
      
      renderSectionItems('group-teaching-body-original', groupTeaching, 'group', false, true);
      renderSectionItems('tutoring-body-original', tutoring, 'tutoring', false, true);
      renderSectionItems('assistant-teaching-body-original', assistantTeaching, 'assistant', false, true);
      renderSectionItems('other-tasks-body-original', otherTasks, 'other', false, true);
      
      // Add collapse handlers
      document.querySelectorAll('#original-content .section-header-clickable').forEach(header => {
        header.addEventListener('click', (e) => {
          const sectionId = header.dataset.section;
          const section = document.getElementById(`section-${sectionId}`);
          if (section) {
            section.classList.toggle('section-collapsed');
          }
        });
      });
    }

    function renderAllSections(editable) {
      const groupTeaching = editedItems.filter(e => e.entryType === 'group');
      const tutoring = editedItems.filter(e => e.entryType === 'tutoring');
      const assistantTeaching = editedItems.filter(e => e.entryType === 'assistant');
      const otherTasks = editedItems.filter(e => e.entryType === 'other');
      
      renderSectionItems('group-teaching-body', groupTeaching, 'group', editable, false);
      renderSectionItems('tutoring-body', tutoring, 'tutoring', editable, false);
      renderSectionItems('assistant-teaching-body', assistantTeaching, 'assistant', editable, false);
      renderSectionItems('other-tasks-body', otherTasks, 'other', editable, false);
      
      // Update section collapse state based on content
      updateSectionCollapseState(groupTeaching.length, 'group');
      updateSectionCollapseState(tutoring.length, 'tutoring');
      updateSectionCollapseState(assistantTeaching.length, 'assistant');
      updateSectionCollapseState(otherTasks.length, 'other');
      
      // Show/hide add row buttons
      document.querySelectorAll('.add-row-btn').forEach(btn => {
        if (editable) {
          btn.classList.remove('hidden');
        } else {
          btn.classList.add('hidden');
        }
      });
    }

    function updateSectionCollapseState(count, sectionId) {
      const section = document.getElementById(`section-${sectionId}`);
      if (!section) return;
      
      // Collapse if empty, expand if has content
      if (count === 0) {
        section.classList.add('section-collapsed');
      } else {
        section.classList.remove('section-collapsed');
      }
    }

    function enterEditMode() {
      if (!currentTimesheet || isLocked(currentTimesheet.status)) {
        showToast('Cannot edit locked timesheet', 'error');
        return;
      }
      
      isEditMode = true;
      
      // Create baseline snapshot if not already set
      if (baselineItems.length === 0) {
        baselineItems = cloneEntries(currentItems);
      }
      
      // Clone entries for editing with proper date handling
      editedItems = cloneEntries(currentItems);
      
      // Show split view
      document.getElementById('detail-drawer-content').classList.add('split-view');
      document.getElementById('original-view').style.display = 'block';
      document.getElementById('edit-view-header').style.display = 'flex';
      
      // Render original (left) and editable (right) sections
      renderOriginalSections();
      renderAllSections(true);
      
      updateDrawerButtons(currentTimesheet.status, currentTimesheet.locked);
      document.getElementById('edit-btn-text').textContent = 'Exit editing';
    }

    function exitEditMode() {
      if (!currentTimesheet) return;
      
      isEditMode = false;
      newRows = [];
      baselineItems = [];
      editedItems = cloneEntries(currentItems);
      
      // Hide split view
      document.getElementById('detail-drawer-content').classList.remove('split-view');
      document.getElementById('original-view').style.display = 'none';
      document.getElementById('edit-view-header').style.display = 'none';
      
      renderAllSections(false);
      updateDrawerButtons(currentTimesheet.status, currentTimesheet.locked);
      document.getElementById('edit-btn-text').textContent = 'Make changes';
    }

    function renderActivityLog(log) {
      const container = document.getElementById('activity-log');
      
      // Sort newest first
      const sortedLog = [...log].sort((a, b) => {
        const timeA = a.at?.toDate?.() || new Date(a.at);
        const timeB = b.at?.toDate?.() || new Date(b.at);
        return timeB - timeA;
      });
      
      container.innerHTML = sortedLog.map(entry => `
        <div class="timeline-item relative pl-8">
          <div class="absolute left-0 top-1 w-6 h-6 rounded-full bg-${getActionColor(entry.action)}-100 flex items-center justify-center">
            <i class="fas ${getActionIcon(entry.action)} text-${getActionColor(entry.action)}-600 text-xs"></i>
          </div>
          <div class="activity-card">
            <div class="activity-action">
              ${getActionLabel(entry.action)}
            </div>
            <div class="activity-by">by ${entry.by}</div>
            <div class="activity-time">${formatDateTime(entry.at)}</div>
            ${entry.note ? `<div class="activity-note">${entry.note}</div>` : ''}
          </div>
        </div>
      `).join('');
    }

    function getActionColor(action) {
      const colors = {
        submitted: 'amber',
        approved: 'green',
        returned: 'red',
        sent_to_banking: 'blue',
        paid: 'indigo'
      };
      return colors[action] || 'gray';
    }

    function updateDrawerButtons(status, locked) {
      document.getElementById('drawer-approve-btn').disabled = !canApprove(status) || locked;
      document.getElementById('drawer-return-btn').disabled = !canReturn(status) || locked;
      document.getElementById('manager-comment').disabled = locked;
      
      // Show/hide footers
      document.querySelector('#detail-drawer > div:nth-last-child(2)').classList.toggle('hidden', isEditMode);
      document.getElementById('edit-mode-footer').classList.toggle('hidden', !isEditMode);
    }

    function closeDrawer() {
      document.getElementById('drawer-overlay').classList.add('hidden');
      document.getElementById('detail-drawer').classList.remove('open');
      currentTimesheet = null;
      isEditMode = false;
    }

    function updateBulkBar() {
      const bar = document.getElementById('bulk-bar');
      const count = selectedIds.size;
      
      if (count > 0) {
        bar.classList.add('visible');
        document.getElementById('selected-count').textContent = `${count} selected`;
        
        // Check if bulk approve is valid (all selected must be 'submitted')
        const selectedTimesheets = timesheets.filter(t => selectedIds.has(t.id));
        const canBulkApprove = selectedTimesheets.every(t => canApprove(t.status));
        
        document.getElementById('bulk-approve').disabled = !canBulkApprove;
      } else {
        bar.classList.remove('visible');
      }
    }

    async function saveEdits() {
      if (!currentTimesheet) return;
      
      try {
        // Show loading state
        showToast('Saving changes...', 'info');
        
        const currentVersion = currentTimesheet.version || 1;
        const newVersion = currentVersion + 1;
        
        const batch = db.batch();
        const timesheetRef = db.collection('timesheets').doc(currentTimesheet.id);
        
        // Create version snapshot in history subcollection (save original entries)
        const versionRef = timesheetRef.collection('history').doc(`v${currentVersion}`);
        const versionData = {
          version: currentVersion,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          totalPay: currentTimesheet.totalPay,
          totalMinutes: currentTimesheet.totalMinutes,
          totalSessions: currentTimesheet.totalSessions,
          entriesSnapshot: currentItems.map(entry => {
            // Create clean snapshot without Firestore-specific objects
            const snapshot = { ...entry };
            
            // Convert date to timestamp
            if (snapshot.date) {
              if (snapshot.date.toDate) {
                snapshot.date = firebase.firestore.Timestamp.fromDate(snapshot.date.toDate());
              } else if (snapshot.date instanceof Date) {
                snapshot.date = firebase.firestore.Timestamp.fromDate(snapshot.date);
              }
            }
            
            return snapshot;
          })
        };
        batch.set(versionRef, versionData);
        
        // Now update entries collection with new version
        editedItems.forEach(entry => {
          let entryRef;
          
          // Check if this is a new row - let Firestore generate the ID
          if (newRows.includes(entry.entryId)) {
            entryRef = timesheetRef.collection('entries').doc(); // Generate new ID
          } else {
            entryRef = timesheetRef.collection('entries').doc(entry.entryId);
          }
          
          // Safely parse date
          let dateObj;
          if (entry.date instanceof Date && !isNaN(entry.date.getTime())) {
            dateObj = entry.date;
          } else if (entry.date && entry.date.toDate) {
            dateObj = entry.date.toDate();
          } else if (entry.date) {
            dateObj = new Date(entry.date);
            if (isNaN(dateObj.getTime())) {
              dateObj = new Date(); // Default to now if invalid
            }
          } else {
            dateObj = new Date(); // Default to now if missing
          }
          
          // Prepare data object based on entry type
          const updateData = {
            date: firebase.firestore.Timestamp.fromDate(dateObj),
            notes: entry.notes || '',
            pay: entry.pay || 0
          };
          
          // Add type-specific fields
          if (entry.entryType === 'group' || entry.entryType === 'assistant') {
            updateData.coursePublicCode = entry.coursePublicCode || '';
            updateData.courseId = entry.courseId || '';
            updateData.classTypeName = entry.classTypeName || '';
            updateData.studentsCount = entry.studentsCount || 0;
            updateData.minutes = entry.minutes || 0;
            updateData.sessions = entry.sessions || 0;
            updateData.status = entry.status || 'ok';
          } else if (entry.entryType === 'tutoring') {
            updateData.coursePublicCode = entry.coursePublicCode || '';
            updateData.courseId = entry.courseId || '';
            updateData.studentName = entry.studentName || '';
            updateData.studentCharge = entry.studentCharge || 0;
            updateData.managementFee = entry.managementFee || 0;
            updateData.minutes = entry.minutes || 0;
            updateData.sessions = entry.sessions || 0;
          } else if (entry.entryType === 'other') {
            updateData.taskName = entry.taskName || '';
            updateData.description = entry.description || '';
            updateData.unit = entry.unit || '';
            updateData.quantity = entry.quantity || 0;
            updateData.status = entry.status || 'ok';
          }
          
          // Check if this is a new row
          if (newRows.includes(entry.entryId)) {
            // Create new entry
            updateData.entryType = entry.entryType;
            updateData.source = 'manual';
            updateData.entryId = entryRef.id; // Store the generated ID
            updateData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            batch.set(entryRef, updateData);
          } else {
            // Update existing entry
            batch.update(entryRef, updateData);
          }
        });
        
        // Recalculate totals from edited items
        const totalPay = editedItems.reduce((sum, e) => sum + (e.pay || 0), 0);
        const totalMinutes = editedItems.reduce((sum, e) => sum + (e.minutes || 0), 0);
        const totalSessions = editedItems.reduce((sum, e) => sum + (e.sessions || 0), 0);
        
        // Update timesheet document
        batch.update(timesheetRef, {
          version: newVersion,
          totalPay: totalPay,
          totalMinutes: totalMinutes,
          totalSessions: totalSessions,
          managerLastActionAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Commit batch
        await batch.commit();
        
        // Add activity log
        const changeCount = newRows.length;
        const logMessage = changeCount > 0 
          ? `Edited timesheet and added ${changeCount} new row(s) - v${currentTimesheet.version} saved to history` 
          : `Edited timesheet entries - v${currentTimesheet.version} saved to history`;
        await addActivityLog(currentTimesheet.id, 'edited', logMessage);
        
        // Update local state
        currentTimesheet.version = newVersion;
        currentTimesheet.totalPay = totalPay;
        currentTimesheet.totalMinutes = totalMinutes;
        currentTimesheet.totalSessions = totalSessions;
        
        // Update currentItems with the saved data
        currentItems = cloneEntriesForEdit(editedItems);
        itemsByTimesheetId[currentTimesheet.id] = cloneEntriesForEdit(editedItems);
        newRows = []; // Clear new rows
        
        // Keep edit mode open, re-render with highlights comparing to baseline
        renderAllSections(true);
        
        // Reload activity
        const activity = await loadTimesheetActivity(currentTimesheet.id);
        
        // Update UI
        document.getElementById('detail-version').textContent = newVersion;
        document.getElementById('sidebar-total-pay').textContent = formatCurrency(totalPay);
        document.getElementById('detail-total-minutes').textContent = (totalMinutes / 60).toFixed(1) + 'h';
        document.getElementById('detail-total-sessions').textContent = totalSessions;
        renderActivityLog(activity);
        
        await loadTimesheets(); // Refresh table
        showToast('Changes saved successfully (v' + newVersion + ') - Previous version archived', 'success');
      } catch (error) {
        console.error('Error saving edits:', error);
        showToast('Failed to save changes', 'error');
      }
    }

    function updateDrawerButtons(status, locked) {
      const isLocked = locked || status === 'sent_to_banking' || status === 'paid';
      
      document.getElementById('drawer-edit-btn').disabled = !canEdit(status) || isLocked;
      document.getElementById('drawer-approve-btn').disabled = !canApprove(status) || isLocked;
      document.getElementById('drawer-return-btn').disabled = !canReturn(status) || isLocked;
      document.getElementById('manager-comment').disabled = isLocked;
      
      // Show/hide footers based on edit mode
      const normalFooter = document.querySelector('#detail-drawer > div:nth-last-child(2)');
      const editFooter = document.getElementById('edit-mode-footer');
      
      if (isEditMode) {
        normalFooter.classList.add('hidden');
        editFooter.classList.remove('hidden');
      } else {
        normalFooter.classList.remove('hidden');
        editFooter.classList.add('hidden');
      }
    }

    // ============================================
    // ACTION HANDLERS (UI only - no backend)
    // ============================================
    
    async function handleApprove(id) {
      const ts = timesheets.find(t => t.id === id);
      if (!ts || !canApprove(ts.status) || ts.locked) return;
      
      // Validate
      const validation = await validateApprove(ts);
      if (!validation.valid) {
        showToast(validation.message, 'error');
        return;
      }
      
      try {
        showToast('Approving timesheet...', 'info');
        
        const managerComment = document.getElementById('manager-comment')?.value || '';
        
        // Update timesheet status
        await db.collection('timesheets').doc(ts.id).update({
          status: 'approved',
          managerComment,
          managerId: CURRENT_MANAGER_ID,
          managerLastActionAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Add activity log
        await addActivityLog(ts.id, 'approved', managerComment);
        
        // Update local state
        ts.status = 'approved';
        ts.managerComment = managerComment;
        
        await loadTimesheets(); // Refresh table
        
        if (currentTimesheet && currentTimesheet.id === id) {
          const activity = await loadTimesheetActivity(ts.id);
          currentTimesheet.status = 'approved';
          document.getElementById('detail-status').className = `tag status-${ts.status}`;
          document.getElementById('detail-status').textContent = getStatusLabel(ts.status);
          renderActivityLog(activity);
          updateDrawerButtons(ts.status, ts.locked);
        }
        
        showToast('Timesheet ' + id + ' approved', 'success');
      } catch (error) {
        console.error('Error approving timesheet:', error);
        showToast('Failed to approve timesheet', 'error');
      }
    }

    async function handleReturn(id) {
      const ts = timesheets.find(t => t.id === id);
      if (!ts || !canReturn(ts.status) || ts.locked) return;
      
      const comment = document.getElementById('manager-comment')?.value || '';
      if (!comment.trim()) {
        showToast('Manager comment is required for returning timesheet', 'error');
        return;
      }
      
      try {
        showToast('Returning timesheet...', 'info');
        
        // Update timesheet status to draft (allows teacher to edit)
        await db.collection('timesheets').doc(ts.id).update({
          status: 'draft',
          managerComment: comment,
          managerId: CURRENT_MANAGER_ID,
          managerLastActionAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Add activity log
        await addActivityLog(ts.id, 'returned', comment);
        
        // Update local state
        ts.status = 'draft';
        ts.managerComment = comment;
        
        await loadTimesheets(); // Refresh table
        
        if (currentTimesheet && currentTimesheet.id === id) {
          const activity = await loadTimesheetActivity(ts.id);
          currentTimesheet.status = 'draft';
          document.getElementById('detail-status').className = `tag status-${ts.status}`;
          document.getElementById('detail-status').textContent = getStatusLabel(ts.status);
          renderActivityLog(activity);
          updateDrawerButtons(ts.status, ts.locked);
        }
        
        showToast('Timesheet ' + id + ' returned to draft', 'warning');
      } catch (error) {
        console.error('Error returning timesheet:', error);
        showToast('Failed to return timesheet', 'error');
      }
    }



    async function handleBulkApprove() {
      // First, validate all selected timesheets
      const validationPromises = [...selectedIds].map(async id => {
        const ts = timesheets.find(t => t.id === id);
        if (!ts || !canApprove(ts.status) || ts.locked) return null;
        const validation = await validateApprove(ts);
        return validation.valid ? id : null;
      });
      
      const toApprove = (await Promise.all(validationPromises)).filter(id => id !== null);
      
      if (toApprove.length === 0) {
        showToast('No valid timesheets to approve', 'warning');
        return;
      }
      
      showToast(`Approving ${toApprove.length} timesheet(s)...`, 'info');
      
      try {
        // Process approvals sequentially to avoid race conditions
        for (const id of toApprove) {
          await handleApprove(id);
        }
        
        selectedIds.clear();
        updateBulkBar();
        showToast(`${toApprove.length} timesheet(s) approved`, 'success');
      } catch (error) {
        console.error('Error in bulk approve:', error);
        showToast('Some approvals may have failed', 'error');
      }
    }

    async function handlePaidToggle(id, isPaid) {
      const ts = timesheets.find(t => t.id === id);
      if (!ts) return;
      
      // Only allow toggling for approved timesheets
      if (ts.status !== 'approved') {
        showToast('Only approved timesheets can be marked as paid', 'warning');
        return;
      }
      
      try {
        showToast(isPaid ? 'Marking as paid...' : 'Unmarking as paid...', 'info');
        
        // Update Firestore
        await db.collection('timesheets').doc(ts.id).update({
          isPaid: isPaid,
          paidAt: isPaid ? firebase.firestore.FieldValue.serverTimestamp() : null,
          paidBy: isPaid ? CURRENT_MANAGER_ID : null
        });
        
        // Add activity log
        await addActivityLog(ts.id, isPaid ? 'marked_paid' : 'unmarked_paid', '');
        
        // Update local state
        ts.isPaid = isPaid;
        
        showToast(isPaid ? 'Marked as paid' : 'Unmarked as paid', 'success');
      } catch (error) {
        console.error('Error toggling paid status:', error);
        showToast('Failed to update paid status', 'error');
        // Revert checkbox
        renderTable();
      }
    }

    // Simple toast notification
    function showToast(message, type = 'info') {
      const colors = {
        success: 'bg-green-600',
        warning: 'bg-amber-600',
        error: 'bg-red-600',
        info: 'bg-blue-600'
      };
      
      const toast = document.createElement('div');
      toast.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-[100] animate-pulse`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    
    function initEventListeners() {
      // Year filter population
      const yearSelect = document.getElementById('year-filter');
      const currentYear = new Date().getFullYear();
      yearSelect.innerHTML = ''; // Clear first
      for (let y = currentYear; y >= currentYear - 3; y--) {
        const opt = document.createElement('option');
        opt.value = y;
        opt.textContent = y;
        if (y === currentYear) opt.selected = true;
        yearSelect.appendChild(opt);
      }
      console.log('Year filter populated:', yearSelect.innerHTML);
      
      // Month filter
      document.getElementById('month-filter').addEventListener('change', e => {
        filters.month = e.target.value;
        loadTimesheets(); // Reload from Firestore
      });
      
      // Year filter
      document.getElementById('year-filter').addEventListener('change', e => {
        filters.year = e.target.value;
        loadTimesheets(); // Reload from Firestore
      });
      
      // Status filter dropdown toggle
      document.getElementById('status-filter-btn').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('status-options').classList.toggle('show');
        console.log('Status dropdown toggled');
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', e => {
        if (!e.target.closest('.multi-select-dropdown')) {
          document.getElementById('status-options').classList.remove('show');
        }
      });
      
      // Status checkboxes
      document.querySelectorAll('.status-checkbox').forEach(cb => {
        cb.addEventListener('change', () => {
          filters.statuses = [...document.querySelectorAll('.status-checkbox:checked')].map(c => c.value);
          const label = filters.statuses.length === 0 ? 'All statuses' : 
                        filters.statuses.length === 3 ? 'All statuses' :
                        `${filters.statuses.length} statuses`;
          document.getElementById('status-filter-label').textContent = label;
          applyFilters();
        });
      });
      
      // Search
      let searchTimeout;
      document.getElementById('search-box').addEventListener('input', e => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          filters.search = e.target.value;
          applyFilters();
        }, 300);
      });
      
      // Refresh
      document.getElementById('refresh-btn').addEventListener('click', () => {
        showToast('Refreshing data...', 'info');
        loadTimesheets();
      });
      
      // Select all
      document.getElementById('select-all').addEventListener('change', e => {
        const start = (currentPage - 1) * PAGE_SIZE;
        const end = Math.min(start + PAGE_SIZE, filteredTimesheets.length);
        const pageData = filteredTimesheets.slice(start, end);
        
        if (e.target.checked) {
          pageData.forEach(t => selectedIds.add(t.id));
        } else {
          pageData.forEach(t => selectedIds.delete(t.id));
        }
        
        renderTable();
        updateBulkBar();
      });
      
      // Row checkboxes (delegated)
      document.getElementById('timesheet-table-body').addEventListener('change', e => {
        if (e.target.classList.contains('row-checkbox')) {
          const id = e.target.dataset.id;
          if (e.target.checked) {
            selectedIds.add(id);
          } else {
            selectedIds.delete(id);
          }
          updateBulkBar();
        }
        
        // Handle paid checkbox
        if (e.target.classList.contains('paid-checkbox')) {
          const id = e.target.dataset.id;
          const isChecked = e.target.checked;
          handlePaidToggle(id, isChecked);
        }
      });
      
      // Table action buttons (delegated)
      document.getElementById('timesheet-table-body').addEventListener('click', e => {
        const btn = e.target.closest('button');
        if (!btn) return;
        
        const id = btn.dataset.id;
        
        if (btn.classList.contains('btn-open')) {
          const ts = timesheets.find(t => t.id === id);
          if (ts) renderDrawer(ts);
        } else if (btn.classList.contains('btn-edit')) {
          const ts = timesheets.find(t => t.id === id);
          if (ts) {
            renderDrawer(ts);
            setTimeout(enterEditMode, 100);
          }
        } else if (btn.classList.contains('btn-approve')) {
          handleApprove(id);
        } else if (btn.classList.contains('btn-return')) {
          handleReturn(id);
        }
      });
      
      // Pagination
      document.getElementById('prev-page').addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      });
      
      document.getElementById('next-page').addEventListener('click', () => {
        const totalPages = Math.ceil(filteredTimesheets.length / PAGE_SIZE);
        if (currentPage < totalPages) {
          currentPage++;
          renderTable();
        }
      });
      
      // Bulk actions
      document.getElementById('clear-selection').addEventListener('click', () => {
        selectedIds.clear();
        renderTable();
        updateBulkBar();
      });
      
      document.getElementById('bulk-approve').addEventListener('click', handleBulkApprove);
      
      // Drawer actions
      document.getElementById('close-drawer').addEventListener('click', closeDrawer);
      document.getElementById('drawer-close-btn').addEventListener('click', closeDrawer);
      document.getElementById('drawer-overlay').addEventListener('click', closeDrawer);
      
      document.getElementById('drawer-edit-btn').addEventListener('click', () => {
        if (isEditMode) {
          exitEditMode();
        } else {
          enterEditMode();
        }
      });
      document.getElementById('drawer-approve-btn').addEventListener('click', () => {
        if (currentTimesheet) handleApprove(currentTimesheet.id);
      });
      document.getElementById('drawer-return-btn').addEventListener('click', () => {
        if (currentTimesheet) handleReturn(currentTimesheet.id);
      });
      
      // Edit mode actions
      document.getElementById('cancel-edit-btn').addEventListener('click', exitEditMode);
      document.getElementById('save-edit-btn').addEventListener('click', saveEdits);
      
      // Collapse original view button
      document.getElementById('collapse-original').addEventListener('click', () => {
        const originalView = document.getElementById('original-view');
        const drawerContent = document.getElementById('detail-drawer-content');
        const expandBtn = document.getElementById('expand-original');
        
        originalView.style.display = 'none';
        drawerContent.classList.remove('split-view');
        expandBtn.style.display = 'block';
      });
      
      // Expand original view button
      document.getElementById('expand-original').addEventListener('click', () => {
        const originalView = document.getElementById('original-view');
        const drawerContent = document.getElementById('detail-drawer-content');
        const expandBtn = document.getElementById('expand-original');
        
        originalView.style.display = 'block';
        drawerContent.classList.add('split-view');
        expandBtn.style.display = 'none';
      });
      
      // Section toggle handlers
      document.querySelectorAll('.section-header-clickable').forEach(header => {
        header.addEventListener('click', (e) => {
          // Don't toggle if clicking the add button
          if (e.target.closest('.add-row-btn')) return;
          
          const sectionId = header.dataset.section;
          const section = document.getElementById(`section-${sectionId}`);
          if (section) {
            section.classList.toggle('section-collapsed');
          }
        });
      });
      
      // Jump bar navigation with smooth scroll
      document.querySelectorAll('.jump-bar a').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const targetId = link.getAttribute('href').substring(1);
          const target = document.getElementById(targetId);
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }
        });
      });
    }

    // ============================================
    // ELEMENT SDK INTEGRATION
    // ============================================
    
    async function onConfigChange(cfg) {
      config = { ...defaultConfig, ...cfg };
      // Config applied - no page title needed in dashboard mode
    }

    function mapToCapabilities(cfg) {
      return {
        recolorables: [
          {
            get: () => cfg.primary_color || defaultConfig.primary_color,
            set: (v) => { cfg.primary_color = v; if (window.elementSdk) window.elementSdk.setConfig({ primary_color: v }); }
          },
          {
            get: () => cfg.background_color || defaultConfig.background_color,
            set: (v) => { cfg.background_color = v; if (window.elementSdk) window.elementSdk.setConfig({ background_color: v }); }
          },
          {
            get: () => cfg.text_color || defaultConfig.text_color,
            set: (v) => { cfg.text_color = v; if (window.elementSdk) window.elementSdk.setConfig({ text_color: v }); }
          },
          {
            get: () => cfg.accent_color || defaultConfig.accent_color,
            set: (v) => { cfg.accent_color = v; if (window.elementSdk) window.elementSdk.setConfig({ accent_color: v }); }
          },
          {
            get: () => cfg.secondary_color || defaultConfig.secondary_color,
            set: (v) => { cfg.secondary_color = v; if (window.elementSdk) window.elementSdk.setConfig({ secondary_color: v }); }
          }
        ],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(cfg) {
      return new Map([
        ['page_title', cfg.page_title || defaultConfig.page_title]
      ]);
    }

    // ============================================
    // INITIALIZATION
    // ============================================
    
    async function init() {
      try {
        console.log('=== Starting Timesheet Manager Initialization ===');
        
        // Check Firebase connection
        console.log('Firebase initialized:', !!firebase.apps.length);
        console.log('Firestore initialized:', !!db);
        
        // Initialize Element SDK
        if (window.elementSdk) {
          await window.elementSdk.init({
            defaultConfig,
            onConfigChange,
            mapToCapabilities,
            mapToEditPanelValues
          });
          config = { ...defaultConfig, ...window.elementSdk.config };
          console.log('Element SDK initialized');
        }
        
        // Setup event listeners
        console.log('Setting up event listeners...');
        initEventListeners();
        
        // Apply initial config
        await onConfigChange(config);
        console.log('Config applied');
        
        // Load initial data from Firestore
        console.log('Loading timesheets from Firestore...');
        await loadTimesheets();
        
        console.log('=== Timesheet Manager Ready ===');
      } catch (error) {
        console.error('Error initializing app:', error);
        console.error('Stack trace:', error.stack);
        showToast('Failed to initialize application: ' + error.message, 'error');
      }
    }

    // Wait for DOM before initializing
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9beb7b267108dd39',t:'MTc2ODU0NDE1NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>