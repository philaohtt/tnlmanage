<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Pay</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Onest:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
    }
    
    * {
      font-family: 'Onest', -apple-system, BlinkMacSystemFont, sans-serif;
    }
    
    .currency {
      font-variant-numeric: tabular-nums;
    }
    
    .skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
      background-size: 200% 100%;
      animation: loading 1.5s ease-in-out infinite;
    }
    
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full" style="overflow-x: hidden; overflow-y: auto;"></div>
  <script type="module">
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCDzv0HseeLfijzyXZjKWFh9QaLrMB4afo",
      authDomain: "tnl2026.firebaseapp.com",
      projectId: "tnl2026",
      storageBucket: "tnl2026.firebasestorage.app",
      messagingSenderId: "883525152224",
      appId: "1:883525152224:web:619ae152cd8df3fcca8f85",
      measurementId: "G-3K6LXCKHZ9"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Current user state (will be populated from auth)
    let currentUser = {
      role: null,
      staffId: null,
      userId: null
    };

    // State management
    let isLoading = true;
    let salaryRecords = [];
    let staffRecords = [];
    let selectedStaffId = null;
    let staffList = [];
    let expandedYears = new Set();
    let expandedMonths = new Set();

    // Configuration
    const defaultConfig = {
      primary_color: "#0369a1",
      surface_color: "#ffffff",
      background_color: "#f1f5f9",
      text_color: "#0f172a",
      accent_color: "#059669",
      font_family: "IBM Plex Sans",
      font_size: 14,
      module_title: "My Pay",
      admin_subtitle: "View salary records for all staff",
      staff_subtitle: "View your salary history",
      no_data_message: "No salary record found for this period.",
      no_bonuses_message: "No bonuses",
      no_deductions_message: "No deductions",
      bonuses_table_title: "Bonuses",
      deductions_table_title: "Deductions"
    };

    // Format Vietnamese Dong currency
    function formatVND(amount) {
      if (amount === null || amount === undefined) return '0';
      return Math.round(amount).toLocaleString('vi-VN');
    }

    function formatMonth(month) {
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return months[month - 1] || '';
    }

    function formatMonthYear(month, year) {
      return `${formatMonth(month)} ${year}`;
    }

    // Get staff name by staffId
    function getStaffName(staffId) {
      const staff = staffRecords.find(s => s.staffId === staffId);
      return staff ? staff.displayName : staffId;
    }
    
    // Get staff name with role (Admin view only)
    function getStaffNameWithRole(staffId) {
      const staff = staffRecords.find(s => s.staffId === staffId);
      if (!staff) return staffId;
      
      const role = staff.role || 'Staff';
      if (currentUser.role === 'Admin') {
        return `${staff.displayName} (${role})`;
      }
      return staff.displayName;
    }

    // Get authenticated user info
    async function getAuthenticatedUser() {
      return new Promise((resolve) => {
        auth.onAuthStateChanged(async (user) => {
          if (user) {
            // Fetch user profile to get role and staffId
            const userDoc = await db.collection('users').doc(user.uid).get();
            if (userDoc.exists) {
              const userData = userDoc.data();
              
              // Support both role (string) and roles (array)
              let isAdmin = false;
              if (userData.role && userData.role === 'Admin') {
                isAdmin = true;
              }
              if (userData.roles && Array.isArray(userData.roles) && userData.roles.includes('Admin')) {
                isAdmin = true;
              }
              
              // CRITICAL: Get staffId from links.staffId (Account_Manager structure)
              const staffId = userData.links?.staffId || null;
              
              currentUser = {
                role: isAdmin ? 'Admin' : (userData.role || 'Teacher'),
                staffId: staffId,
                userId: user.uid,
                hasLinkedStaffId: !!staffId
              };
              
              console.log('Authenticated user:', currentUser);
            } else {
              currentUser = {
                role: 'Teacher',
                staffId: null,
                userId: user.uid,
                hasLinkedStaffId: false
              };
            }
          } else {
            currentUser = {
              role: null,
              staffId: null,
              userId: null,
              hasLinkedStaffId: false
            };
          }
          resolve(currentUser);
        });
      });
    }

    // Initialize data from Firestore
    async function initializeData() {
      try {
        isLoading = true;
        render();

        // STEP 1: Get authenticated user first
        await getAuthenticatedUser();

        if (!currentUser.userId) {
          console.error("No authenticated user");
          isLoading = false;
          render();
          return;
        }

        // CRITICAL: Check if user account is linked to a staff profile
        if (!currentUser.hasLinkedStaffId) {
          console.error("User account not linked to staff profile");
          isLoading = false;
          render();
          return;
        }

        // STEP 2: Load ALL salary records from Firestore
        const salarySnapshot = await db.collection('salaries').get();
        let allSalaryRecords = salarySnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));

        // STEP 2: Load staff directory for name resolution and admin dropdown
        // Staff doc.id IS the staffId (STF_...)
        const staffSnapshot = await db.collection('staff').orderBy('preferredName').get();
        staffRecords = staffSnapshot.docs.map(doc => {
          const data = doc.data();
          return {
            staffId: doc.id, // doc.id IS the staffId
            preferredName: data.preferredName || null,
            fullName: data.fullName || null,
            role: data.role || 'Staff',
            displayName: data.preferredName || data.fullName || doc.id
          };
        });

        // STEP 3: Apply CRITICAL permission filter
        // NON-NEGOTIABLE: Non-admin users ONLY see their own records
        if (currentUser.role !== "Admin") {
          salaryRecords = allSalaryRecords.filter(r => r.staffId === currentUser.staffId);
          selectedStaffId = currentUser.staffId;
        } else {
          // Admin: keep all records, but will filter by selected staff
          salaryRecords = allSalaryRecords;
        }

        // STEP 4: Build staff list for Admin ONLY - from staff collection
        if (currentUser.role === "Admin") {
          // Build staff list from entire staff collection (already sorted by preferredName)
          staffList = staffRecords.map(s => ({
            id: s.staffId,
            name: s.displayName
          }));
          
          // Check sessionStorage for previously selected staff
          const rememberedStaffId = sessionStorage.getItem('selectedStaffId');
          const rememberedStaffExists = rememberedStaffId && staffList.some(s => s.id === rememberedStaffId);
          
          // Default: remembered staff OR first staff in list OR staff from latest salary record
          if (rememberedStaffExists) {
            selectedStaffId = rememberedStaffId;
          } else if (salaryRecords.length > 0) {
            const latestRecord = salaryRecords.reduce((latest, record) => {
              if (!latest) return record;
              if (record.year > latest.year) return record;
              if (record.year === latest.year && record.month > latest.month) return record;
              return latest;
            }, null);
            selectedStaffId = latestRecord?.staffId || staffList[0]?.id || null;
            
            // Auto-expand latest year and month
            if (latestRecord) {
              expandedYears.add(latestRecord.year);
              expandedMonths.add(`${latestRecord.year}-${latestRecord.month}`);
            }
          } else {
            selectedStaffId = staffList[0]?.id || null;
          }
          
          // Save to sessionStorage
          if (selectedStaffId) {
            sessionStorage.setItem('selectedStaffId', selectedStaffId);
          }
        } else {
          // Staff view: auto-expand latest year and month for current user
          if (salaryRecords.length > 0) {
            const latestRecord = salaryRecords.reduce((latest, record) => {
              if (!latest) return record;
              if (record.year > latest.year) return record;
              if (record.year === latest.year && record.month > latest.month) return record;
              return latest;
            }, null);
            
            if (latestRecord) {
              expandedYears.add(latestRecord.year);
              expandedMonths.add(`${latestRecord.year}-${latestRecord.month}`);
            }
          }
        }
        
        isLoading = false;
        render();
      } catch (error) {
        console.error("Error loading salary data:", error);
        isLoading = false;
        render();
      }
    }

    function getFilteredRecords() {
      // Apply permission filter
      let records = salaryRecords;
      
      if (currentUser.role === "Admin" && selectedStaffId) {
        records = records.filter(r => r.staffId === selectedStaffId);
      } else if (currentUser.role !== "Admin") {
        records = records.filter(r => r.staffId === currentUser.staffId);
      }
      
      return records;
    }

    function getAvailableYears() {
      const records = getFilteredRecords();
      return [...new Set(records.map(r => r.year))].sort((a, b) => a - b);
    }

    function getMonthsForYear(year) {
      const records = getFilteredRecords();
      return [...new Set(
        records.filter(r => r.year === year).map(r => r.month)
      )].sort((a, b) => a - b);
    }

    function getRecordForMonth(year, month) {
      const records = getFilteredRecords();
      return records.find(r => r.year === year && r.month === month);
    }

    function render() {
      const config = window.elementSdk?.config || defaultConfig;
      const app = document.getElementById('app');
      
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const backgroundColor = config.background_color || defaultConfig.background_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const accentColor = config.accent_color || defaultConfig.accent_color;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const moduleTitle = config.module_title || defaultConfig.module_title;
      const adminSubtitle = config.admin_subtitle || defaultConfig.admin_subtitle;
      const staffSubtitle = config.staff_subtitle || defaultConfig.staff_subtitle;
      const noDataMessage = config.no_data_message || defaultConfig.no_data_message;
      const noBonusesMessage = config.no_bonuses_message || defaultConfig.no_bonuses_message;
      const noDeductionsMessage = config.no_deductions_message || defaultConfig.no_deductions_message;
      const bonusesTableTitle = config.bonuses_table_title || defaultConfig.bonuses_table_title;
      const deductionsTableTitle = config.deductions_table_title || defaultConfig.deductions_table_title;
      
      const isAdmin = currentUser.role === "Admin";
      const subtitle = isAdmin ? adminSubtitle : staffSubtitle;
      const availableYears = getAvailableYears();
      
      app.style.backgroundColor = backgroundColor;
      app.style.fontFamily = `${customFont}, 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif`;
      
      if (isLoading) {
        app.innerHTML = `
          <div class="w-full" style="max-width: 1400px; margin: 0 auto; padding: ${baseSize * 1.5}px;">
            <div class="skeleton" style="height: ${baseSize * 2.5}px; width: 200px; margin-bottom: ${baseSize * 0.5}px; border-radius: 4px;"></div>
            <div class="skeleton" style="height: ${baseSize * 1.2}px; width: 300px; margin-bottom: ${baseSize * 1.5}px; border-radius: 4px;"></div>
            <div class="skeleton" style="height: ${baseSize * 3}px; width: 100%; margin-bottom: ${baseSize * 1.5}px; border-radius: 6px;"></div>
            <div class="skeleton" style="height: ${baseSize * 8}px; width: 100%; border-radius: 6px;"></div>
          </div>
        `;
        return;
      }
      
      // Show error state if user account is not linked to staff profile
      if (!currentUser.hasLinkedStaffId) {
        app.innerHTML = `
          <div class="w-full" style="max-width: 1400px; margin: 0 auto; padding: ${baseSize * 1.5}px;">
            <div style="margin-bottom: ${baseSize * 1.2}px;">
              <h1 style="font-size: ${baseSize * 1.8}px; font-weight: 700; color: ${textColor}; margin: 0 0 ${baseSize * 0.3}px 0; line-height: 1.2;">
                ${moduleTitle}
              </h1>
            </div>
            <div style="background-color: ${surfaceColor}; border-radius: 6px; padding: ${baseSize * 2.5}px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 2px solid #fbbf24;">
              <svg width="${baseSize * 4}" height="${baseSize * 4}" viewBox="0 0 64 64" fill="none" style="margin: 0 auto ${baseSize}px auto;">
                <path d="M32 8C18.745 8 8 18.745 8 32s10.745 24 24 24 24-10.745 24-24S45.255 8 32 8zm0 44c-11.028 0-20-8.972-20-20s8.972-20 20-20 20 8.972 20 20-8.972 20-20 20z" fill="#f59e0b"/>
                <path d="M32 20c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3-1.343-3-3-3zM32 28c-2.21 0-4 1.79-4 4v8c0 2.21 1.79 4 4 4s4-1.79 4-4v-8c0-2.21-1.79-4-4-4z" fill="#f59e0b"/>
              </svg>
              <h2 style="font-size: ${baseSize * 1.2}px; font-weight: 600; color: ${textColor}; margin: 0 0 ${baseSize * 0.5}px 0;">
                Account Not Linked
              </h2>
              <p style="font-size: ${baseSize}px; color: ${textColor}; opacity: 0.7; margin: 0; line-height: 1.5;">
                Your account is not linked to a staff profile.<br>
                Please contact an administrator to link your account in the Account Manager.
              </p>
            </div>
          </div>
        `;
        return;
      }
      
      app.innerHTML = `
        <div class="w-full" style="max-width: 1400px; margin: 0 auto; padding: ${baseSize * 1.5}px; overflow-x: hidden;">
          <!-- Header -->
          <div style="margin-bottom: ${baseSize * 1.2}px;">
            <h1 style="font-size: ${baseSize * 1.8}px; font-weight: 700; color: ${textColor}; margin: 0 0 ${baseSize * 0.3}px 0; line-height: 1.2;">
              ${moduleTitle}
            </h1>
            <p style="font-size: ${baseSize * 0.9}px; color: ${textColor}; opacity: 0.6; margin: 0;">
              ${subtitle}
            </p>
          </div>
          
          <!-- Staff Selector (Admin Only) -->
          ${isAdmin ? `
            <div style="background-color: ${surfaceColor}; border-radius: 6px; padding: ${baseSize}px; margin-bottom: ${baseSize * 1.2}px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.06);">
              <label for="staffSelect" style="display: block; font-size: ${baseSize * 0.85}px; font-weight: 600; color: ${textColor}; margin-bottom: ${baseSize * 0.4}px;">
                Staff Member
              </label>
              <select id="staffSelect" style="width: 100%; padding: ${baseSize * 0.6}px ${baseSize * 0.8}px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: ${baseSize * 0.95}px; color: ${textColor}; background-color: ${surfaceColor}; cursor: pointer;">
                ${staffList.map(s => `<option value="${s.id}" ${s.id === selectedStaffId ? 'selected' : ''}>${s.name}</option>`).join('')}
              </select>
            </div>
          ` : ''}
          
          <!-- Content Area -->
          <div id="contentArea">
            ${availableYears.length === 0 ? `
              <div style="background-color: ${surfaceColor}; border-radius: 6px; padding: ${baseSize * 2.5}px; text-align: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.06);">
                <svg width="${baseSize * 3.5}" height="${baseSize * 3.5}" viewBox="0 0 64 64" fill="none" style="margin: 0 auto ${baseSize * 0.8}px auto; opacity: 0.25;">
                  <path d="M32 8C18.745 8 8 18.745 8 32s10.745 24 24 24 24-10.745 24-24S45.255 8 32 8zm0 44c-11.028 0-20-8.972-20-20s8.972-20 20-20 20 8.972 20 20-8.972 20-20 20z" fill="${textColor}"/>
                  <path d="M32 28c-2.21 0-4 1.79-4 4v8c0 2.21 1.79 4 4 4s4-1.79 4-4v-8c0-2.21-1.79-4-4-4zm0 2c1.105 0 2 .895 2 2v8c0 1.105-.895 2-2 2s-2-.895-2-2v-8c0-1.105.895-2 2-2zM32 20c-1.657 0-3 1.343-3 3s1.343 3 3 3 3-1.343 3-3-1.343-3-3-3z" fill="${textColor}"/>
                </svg>
                <p style="font-size: ${baseSize * 0.95}px; color: ${textColor}; opacity: 0.6; margin: 0;">
                  ${noDataMessage}
                </p>
              </div>
            ` : availableYears.map(year => {
              const months = getMonthsForYear(year);
              const isYearExpanded = expandedYears.has(year);
              
              return `
                <!-- Year ${year} -->
                <div style="background-color: ${surfaceColor}; border-radius: 6px; overflow: hidden; margin-bottom: ${baseSize}px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.06);">
                  <!-- Year Header (Clickable) -->
                  <div data-year="${year}" class="year-header" style="padding: ${baseSize * 0.9}px ${baseSize * 1.2}px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background-color: ${isYearExpanded ? backgroundColor : surfaceColor}; transition: background-color 0.2s; position: sticky; top: 0; z-index: 10; box-shadow: ${isYearExpanded ? '0 2px 4px rgba(0,0,0,0.08)' : 'none'};">
                    <h3 style="font-size: ${baseSize * 1.1}px; font-weight: 600; color: ${textColor}; margin: 0;">
                      ${year}
                    </h3>
                    <svg width="${baseSize * 1.2}" height="${baseSize * 1.2}" viewBox="0 0 24 24" fill="none" style="transform: rotate(${isYearExpanded ? '180' : '0'}deg); transition: transform 0.2s;">
                      <path d="M6 9l6 6 6-6" stroke="${textColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </div>
                  
                  <!-- Months Container (Expandable) -->
                  ${isYearExpanded ? `
                    <div style="border-top: 1px solid #e2e8f0;">
                      ${months.map(month => {
                        const isMonthExpanded = expandedMonths.has(`${year}-${month}`);
                        const record = getRecordForMonth(year, month);
                        
                        return `
                          <!-- Month ${formatMonth(month)} -->
                          <div style="border-bottom: 1px solid #f1f5f9;">
                            <!-- Month Header (Clickable) -->
                            <div data-month="${year}-${month}" class="month-header" style="padding: ${baseSize * 0.8}px ${baseSize * 1.2}px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background-color: ${isMonthExpanded ? '#fafafa' : 'transparent'}; transition: background-color 0.2s;">
                              <div style="display: flex; align-items: center; gap: ${baseSize * 0.8}px;">
                                <span style="font-size: ${baseSize}px; font-weight: 500; color: ${textColor};">
                                  ${formatMonth(month)}
                                </span>
                                ${record ? `
                                  <span class="currency" style="font-size: ${baseSize * 1.1}px; color: ${primaryColor}; font-weight: 700;">
                                    ${formatVND(record.net)} ₫
                                  </span>
                                ` : ''}
                              </div>
                              <svg width="${baseSize}" height="${baseSize}" viewBox="0 0 24 24" fill="none" style="transform: rotate(${isMonthExpanded ? '180' : '0'}deg); transition: transform 0.2s;">
                                <path d="M6 9l6 6 6-6" stroke="${textColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              </svg>
                            </div>
                            
                            <!-- Month Data (Expandable) -->
                            ${isMonthExpanded && record ? `
                              <div style="padding: ${baseSize * 1.2}px; background-color: #fafafa;">
                                <!-- Net Salary Summary Strip -->
                                <div style="background: linear-gradient(135deg, ${primaryColor}, ${accentColor}); border-radius: 6px; padding: ${baseSize * 1.2}px ${baseSize * 1.5}px; margin-bottom: ${baseSize * 1.2}px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                  <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: ${baseSize * 0.9}px; color: white; opacity: 0.95; font-weight: 500;">
                                      Net Salary for ${formatMonthYear(month, year)}
                                    </span>
                                    <span class="currency" style="font-size: ${baseSize * 1.8}px; color: white; font-weight: 700; letter-spacing: -0.5px;">
                                      ${formatVND(record.net)} ₫
                                    </span>
                                  </div>
                                  <div style="margin-top: ${baseSize * 0.5}px; font-size: ${baseSize * 0.75}px; color: white; opacity: 0.85;">
                                    Status: Finalized
                                  </div>
                                </div>
                                <!-- Summary Table -->
                                <div style="background-color: ${surfaceColor}; border-radius: 4px; overflow: hidden; margin-bottom: ${baseSize}px; border: 1px solid #e2e8f0;">
                                  <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                      <tr style="background-color: ${backgroundColor};">
                                        <th style="text-align: left; padding: ${baseSize * 0.6}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.8}px; font-weight: 600; color: ${textColor}; border-bottom: 2px solid ${primaryColor};">
                                          Staff Name
                                        </th>
                                        <th style="text-align: right; padding: ${baseSize * 0.6}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.8}px; font-weight: 600; color: ${textColor}; border-bottom: 2px solid ${primaryColor};">
                                          Gross (₫)
                                        </th>
                                        <th style="text-align: right; padding: ${baseSize * 0.6}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.8}px; font-weight: 600; color: ${textColor}; border-bottom: 2px solid ${primaryColor};">
                                          Bonuses (₫)
                                        </th>
                                        <th style="text-align: right; padding: ${baseSize * 0.6}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.8}px; font-weight: 600; color: ${textColor}; border-bottom: 2px solid ${primaryColor};">
                                          Deductions (₫)
                                        </th>
                                        <th style="text-align: right; padding: ${baseSize * 0.6}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.8}px; font-weight: 600; color: ${textColor}; border-bottom: 2px solid ${primaryColor};">
                                          Net (₫)
                                        </th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      <tr>
                                        <td style="padding: ${baseSize * 0.7}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.9}px; color: ${textColor}; font-weight: 500;">
                                          ${getStaffNameWithRole(record.staffId)}
                                        </td>
                                        <td class="currency" style="text-align: right; padding: ${baseSize * 0.7}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.9}px; color: ${textColor}; opacity: 0.7; font-weight: 400; white-space: nowrap;">
                                          ${formatVND(record.gross)}
                                        </td>
                                        <td class="currency" style="text-align: right; padding: ${baseSize * 0.7}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.9}px; color: ${accentColor}; font-weight: 500; white-space: nowrap;">
                                          ${formatVND(record.bonusTotal)}
                                        </td>
                                        <td class="currency" style="text-align: right; padding: ${baseSize * 0.7}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.9}px; color: #dc2626; font-weight: 500; white-space: nowrap;">
                                          ${formatVND(record.deductionTotal)}
                                        </td>
                                        <td class="currency" style="text-align: right; padding: ${baseSize * 0.7}px ${baseSize * 0.8}px; font-size: ${baseSize * 1.05}px; color: ${primaryColor}; font-weight: 700; white-space: nowrap;">
                                          ${formatVND(record.net)}
                                        </td>
                                      </tr>
                                    </tbody>
                                  </table>
                                </div>
                                
                                <!-- Bonuses Table -->
                                <div style="background-color: ${surfaceColor}; border-radius: 4px; overflow: hidden; margin-bottom: ${baseSize}px; border: 1px solid #e2e8f0;">
                                  <div style="padding: ${baseSize * 0.6}px ${baseSize * 0.8}px; background-color: ${backgroundColor}; border-bottom: 1px solid #e2e8f0;">
                                    <h4 style="font-size: ${baseSize * 0.9}px; font-weight: 600; color: ${textColor}; margin: 0;">
                                      ${bonusesTableTitle}
                                    </h4>
                                  </div>
                                  <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                      <tr style="background-color: ${backgroundColor};">
                                        <th style="text-align: left; padding: ${baseSize * 0.5}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.75}px; font-weight: 600; color: ${textColor}; opacity: 0.8; border-bottom: 1px solid #e2e8f0;">
                                          Type
                                        </th>
                                        <th style="text-align: right; padding: ${baseSize * 0.5}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.75}px; font-weight: 600; color: ${textColor}; opacity: 0.8; border-bottom: 1px solid #e2e8f0;">
                                          Amount (₫)
                                        </th>
                                        <th style="text-align: left; padding: ${baseSize * 0.5}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.75}px; font-weight: 600; color: ${textColor}; opacity: 0.8; border-bottom: 1px solid #e2e8f0;">
                                          Note
                                        </th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      ${(() => {
                                        const bonuses = (record.adjustments || []).filter(adj => adj.type === 'bonus');
                                        if (bonuses.length === 0) {
                                          return `
                                            <tr>
                                              <td colspan="3" style="padding: ${baseSize}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.85}px; color: ${textColor}; opacity: 0.5; text-align: center;">
                                                ${noBonusesMessage}
                                              </td>
                                            </tr>
                                          `;
                                        }
                                        return bonuses.map(bonus => `
                                          <tr>
                                            <td style="padding: ${baseSize * 0.4}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.85}px; color: ${textColor}; border-bottom: 1px solid #f1f5f9;">
                                              ${bonus.label || ''}
                                            </td>
                                            <td class="currency" style="text-align: right; padding: ${baseSize * 0.4}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.85}px; color: ${accentColor}; font-weight: 500; border-bottom: 1px solid #f1f5f9; white-space: nowrap;">
                                              ${formatVND(bonus.amount)}
                                            </td>
                                            <td style="padding: ${baseSize * 0.4}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.75}px; color: ${textColor}; opacity: 0.6; border-bottom: 1px solid #f1f5f9;">
                                              ${bonus.note || ''}
                                            </td>
                                          </tr>
                                        `).join('') + `
                                          <tr style="background-color: ${backgroundColor};">
                                            <td style="padding: ${baseSize * 0.6}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.85}px; font-weight: 600; color: ${textColor};">
                                              Total
                                            </td>
                                            <td class="currency" style="text-align: right; padding: ${baseSize * 0.6}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.85}px; font-weight: 700; color: ${accentColor}; white-space: nowrap;">
                                              ${formatVND(record.bonusTotal)}
                                            </td>
                                            <td></td>
                                          </tr>
                                        `;
                                      })()}
                                    </tbody>
                                  </table>
                                </div>
                                
                                <!-- Deductions Table -->
                                <div style="background-color: ${surfaceColor}; border-radius: 4px; overflow: hidden; border: 1px solid #e2e8f0;">
                                  <div style="padding: ${baseSize * 0.6}px ${baseSize * 0.8}px; background-color: ${backgroundColor}; border-bottom: 1px solid #e2e8f0;">
                                    <h4 style="font-size: ${baseSize * 0.9}px; font-weight: 600; color: ${textColor}; margin: 0;">
                                      ${deductionsTableTitle}
                                    </h4>
                                  </div>
                                  <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                      <tr style="background-color: ${backgroundColor};">
                                        <th style="text-align: left; padding: ${baseSize * 0.5}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.75}px; font-weight: 600; color: ${textColor}; opacity: 0.8; border-bottom: 1px solid #e2e8f0;">
                                          Type
                                        </th>
                                        <th style="text-align: right; padding: ${baseSize * 0.5}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.75}px; font-weight: 600; color: ${textColor}; opacity: 0.8; border-bottom: 1px solid #e2e8f0;">
                                          Amount (₫)
                                        </th>
                                        <th style="text-align: left; padding: ${baseSize * 0.5}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.75}px; font-weight: 600; color: ${textColor}; opacity: 0.8; border-bottom: 1px solid #e2e8f0;">
                                          Note
                                        </th>
                                      </tr>
                                    </thead>
                                    <tbody>
                                      ${(() => {
                                        const deductions = (record.adjustments || []).filter(adj => adj.type === 'deduction');
                                        if (deductions.length === 0) {
                                          return `
                                            <tr>
                                              <td colspan="3" style="padding: ${baseSize}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.85}px; color: ${textColor}; opacity: 0.5; text-align: center;">
                                                ${noDeductionsMessage}
                                              </td>
                                            </tr>
                                          `;
                                        }
                                        return deductions.map(deduction => `
                                          <tr>
                                            <td style="padding: ${baseSize * 0.4}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.85}px; color: ${textColor}; border-bottom: 1px solid #f1f5f9;">
                                              ${deduction.label || ''}
                                            </td>
                                            <td class="currency" style="text-align: right; padding: ${baseSize * 0.4}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.85}px; color: #dc2626; font-weight: 500; border-bottom: 1px solid #f1f5f9; white-space: nowrap;">
                                              ${formatVND(deduction.amount)}
                                            </td>
                                            <td style="padding: ${baseSize * 0.4}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.75}px; color: ${textColor}; opacity: 0.6; border-bottom: 1px solid #f1f5f9;">
                                              ${deduction.note || ''}
                                            </td>
                                          </tr>
                                        `).join('') + `
                                          <tr style="background-color: ${backgroundColor};">
                                            <td style="padding: ${baseSize * 0.6}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.85}px; font-weight: 600; color: ${textColor};">
                                              Total
                                            </td>
                                            <td class="currency" style="text-align: right; padding: ${baseSize * 0.6}px ${baseSize * 0.8}px; font-size: ${baseSize * 0.85}px; font-weight: 700; color: #dc2626; white-space: nowrap;">
                                              ${formatVND(record.deductionTotal)}
                                            </td>
                                            <td></td>
                                          </tr>
                                        `;
                                      })()}
                                    </tbody>
                                  </table>
                                </div>
                              </div>
                            ` : ''}
                          </div>
                        `;
                      }).join('')}
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
      
      // Attach event listeners
      attachEventListeners();
    }

    function attachEventListeners() {
      const isAdmin = currentUser.role === "Admin";
      
      // Staff selector for admins
      if (isAdmin) {
        const staffSelect = document.getElementById('staffSelect');
        if (staffSelect) {
          staffSelect.addEventListener('change', (e) => {
            selectedStaffId = e.target.value;
            expandedYears.clear();
            expandedMonths.clear();
            
            // Remember selection in sessionStorage
            sessionStorage.setItem('selectedStaffId', selectedStaffId);
            
            render();
          });
        }
      }
      
      // Year headers - toggle expand/collapse
      const yearHeaders = document.querySelectorAll('.year-header');
      yearHeaders.forEach(header => {
        header.addEventListener('click', () => {
          const year = parseInt(header.getAttribute('data-year'));
          if (expandedYears.has(year)) {
            expandedYears.delete(year);
            // Close all months for this year
            const months = getMonthsForYear(year);
            months.forEach(month => {
              expandedMonths.delete(`${year}-${month}`);
            });
          } else {
            expandedYears.add(year);
          }
          render();
        });
      });
      
      // Month headers - toggle expand/collapse
      const monthHeaders = document.querySelectorAll('.month-header');
      monthHeaders.forEach(header => {
        header.addEventListener('click', () => {
          const monthKey = header.getAttribute('data-month');
          if (expandedMonths.has(monthKey)) {
            expandedMonths.delete(monthKey);
          } else {
            expandedMonths.add(monthKey);
          }
          render();
        });
      });
    }

    async function onConfigChange(config) {
      render();
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.primary_color || defaultConfig.primary_color,
            set: (value) => {
              config.primary_color = value;
              window.elementSdk.setConfig({ primary_color: value });
            }
          },
          {
            get: () => config.surface_color || defaultConfig.surface_color,
            set: (value) => {
              config.surface_color = value;
              window.elementSdk.setConfig({ surface_color: value });
            }
          },
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              config.background_color = value;
              window.elementSdk.setConfig({ background_color: value });
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              config.text_color = value;
              window.elementSdk.setConfig({ text_color: value });
            }
          },
          {
            get: () => config.accent_color || defaultConfig.accent_color,
            set: (value) => {
              config.accent_color = value;
              window.elementSdk.setConfig({ accent_color: value });
            }
          }
        ],
        borderables: [],
        fontEditable: {
          get: () => config.font_family || defaultConfig.font_family,
          set: (value) => {
            config.font_family = value;
            window.elementSdk.setConfig({ font_family: value });
          }
        },
        fontSizeable: {
          get: () => config.font_size || defaultConfig.font_size,
          set: (value) => {
            config.font_size = value;
            window.elementSdk.setConfig({ font_size: value });
          }
        }
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["module_title", config.module_title || defaultConfig.module_title],
        ["admin_subtitle", config.admin_subtitle || defaultConfig.admin_subtitle],
        ["staff_subtitle", config.staff_subtitle || defaultConfig.staff_subtitle],
        ["no_data_message", config.no_data_message || defaultConfig.no_data_message],
        ["no_bonuses_message", config.no_bonuses_message || defaultConfig.no_bonuses_message],
        ["no_deductions_message", config.no_deductions_message || defaultConfig.no_deductions_message],
        ["bonuses_table_title", config.bonuses_table_title || defaultConfig.bonuses_table_title],
        ["deductions_table_title", config.deductions_table_title || defaultConfig.deductions_table_title]
      ]);
    }

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }
    
    // Start the application
    initializeData();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bf2b8f6c50ea880',t:'MTc2ODYyMDA4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>