<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Courses Module - School Management System</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    * {
      box-sizing: border-box;
    }
    
    .main-content-wrapper {
      min-height: 100%;
    }
    
    .main-content {
      padding: 20px;
    }
    
    .card {
      background-color: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 16px;
      transition: all 0.2s;
    }
    
    .card-hover:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }
    
    .btn-primary {
      background-color: #2563eb;
      color: #ffffff;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: opacity 0.2s;
    }
    
    .btn-primary:hover {
      opacity: 0.9;
    }
    
    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-secondary {
      background-color: #f8f9fa;
      color: #1a1a1a;
      border: 1px solid #e5e7eb;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .btn-secondary:hover {
      border-color: #2563eb;
    }
    
    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .badge-active {
      background-color: #dcfce7;
      color: #166534;
    }
    
    .badge-archived {
      background-color: #f3f4f6;
      color: #6b7280;
    }
    
    .badge-draft {
      background-color: #fef3c7;
      color: #92400e;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background-color: #f8f9fa;
    }
    
    thead th {
      padding: 10px 12px;
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
      border-bottom: 1px solid #e5e7eb;
    }
    
    tbody tr {
      border-bottom: 1px solid #e5e7eb;
      transition: background-color 0.2s;
    }
    
    tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    tbody tr:hover {
      background-color: #e5e7eb;
    }
    
    tbody td {
      padding: 12px;
      font-size: 13px;
      color: #1a1a1a;
    }
    
    .text-muted {
      color: #64748b;
    }
    
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      animation: fadeIn 0.2s;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-content {
      background-color: #ffffff;
      border-radius: 12px;
      max-width: 650px;
      width: 100%;
      max-height: 90%;
      overflow-y: auto;
      animation: slideUp 0.3s;
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .modal-header {
      position: sticky;
      top: 0;
      background-color: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      padding: 20px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .modal-body {
      padding: 24px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #1a1a1a;
      margin-bottom: 6px;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 8px 12px;
      font-size: 13px;
      color: #1a1a1a;
      background-color: #f8f9fa;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #2563eb;
      background-color: #ffffff;
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background-color: #1a1a1a;
      color: #ffffff;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 13px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 2000;
      animation: slideInRight 0.3s;
    }
    
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background-color: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      padding: 16px;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 12px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: #64748b;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .course-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }
    
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #f3f4f6;
      font-size: 13px;
    }
    
    .info-row:last-child {
      border-bottom: none;
    }
    
    .info-label {
      color: #64748b;
      font-weight: 500;
    }
    
    .info-value {
      color: #1a1a1a;
      font-weight: 500;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: #f3f4f6;
      border-radius: 4px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background-color: #2563eb;
      transition: width 0.3s;
    }
    
    .role-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      background-color: #f8f9fa;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      color: #1a1a1a;
    }
    
    .saving-indicator {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 20px 32px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      display: none;
      align-items: center;
      gap: 12px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
    }
    
    .saving-indicator.show {
      display: flex;
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full" style="background-color: #f8f9fa;"></div><!-- Saving Indicator -->
  <div id="savingIndicator" class="saving-indicator">
   <div class="spinner"></div><span>Saving, please wait...</span>
  </div><!-- Loading Indicator -->
  <div id="loadingIndicator" class="saving-indicator show">
   <div class="spinner"></div><span>Loading courses...</span>
  </div>
  <script>
    const defaultConfig = {
      primary_bg: '#f8f9fa',
      surface_color: '#ffffff',
      text_color: '#1a1a1a',
      primary_action: '#2563eb',
      secondary_action: '#64748b',
      border_color: '#e5e7eb',
      font_family: 'Inter',
      font_size: 13,
      module_title: 'Courses',
      page_subtitle: 'Teacher Portal'
    };

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCDzv0HseeLfijzyXZjKWFh9QaLrMB4afo",
      authDomain: "tnl2026.firebaseapp.com",
      projectId: "tnl2026",
      storageBucket: "tnl2026.firebasestorage.app",
      messagingSenderId: "883525152224",
      appId: "1:883525152224:web:619ae152cd8df3fcca8f85",
      measurementId: "G-3K6LXCKHZ9"
    };

    // Initialize Firebase
    let db;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    } catch (error) {
      // Firebase initialization failed
    }

    let currentUser = {
      role: 'teacher',
      id: 'user_001',
      name: 'Teacher User'
    };

    let currentView = 'courses';
    let allData = [];
    let staffData = [];
    let unsubscribe = null;
    let staffUnsubscribe = null;

    // Modal identifiers
    const MODAL_ENROLLMENT_COURSES = 'Enrollment_Courses';
    const MODAL_ATTENDANCE_COURSES = 'Attendance_Courses';
    const MODAL_PERFORMANCE_COURSES = 'Performance_Courses';

    // Course context for navigation
    window.courseContext = null;

    function setCourseContext(course) {
      window.courseContext = {
        courseId: course.id,
        publicCode: course.publicCode,
        name: course.name,
        teacherName: course.primaryTeacherName || '',
        startDate: course.startDate || '',
        status: course.status,
        schedule: course.scheduleText || ''
      };
    }

    async function refreshCourseData(courseId) {
      if (!db) return;
      
      try {
        // Count in parallel for faster performance with proper filters
        const [enrollmentsSnapshot, sessionsSnapshot, assessmentsSnapshot] = await Promise.all([
          db.collection('course_enrollments').where('courseId', '==', courseId).get(),
          db.collection('course_sessions').where('courseId', '==', courseId).get(),
          db.collection('assessments').where('courseId', '==', courseId).get()
        ]);
        
        // Filter students: only count "active" status
        const studentCount = enrollmentsSnapshot.docs.filter(doc => {
          const status = doc.data().status;
          return status === 'active';
        }).length;
        
        // Filter sessions: exclude cancelled
        const sessionCount = sessionsSnapshot.docs.filter(doc => {
          const status = doc.data().sessionStatus;
          return status !== 'cancelled';
        }).length;
        
        // Filter assessments: only count "active" status
        const assessmentCount = assessmentsSnapshot.docs.filter(doc => {
          const status = doc.data().status;
          return status === 'active';
        }).length;
        
        // Update counts in background (don't wait for Firestore)
        db.collection('courses').doc(courseId).update({
          studentCount: studentCount,
          sessionCount: sessionCount,
          assessmentCount: assessmentCount
        }).catch(() => {});
        
        // Immediately update local data and re-render for instant UI update
        const courseIndex = allData.findIndex(c => c.id === courseId);
        if (courseIndex !== -1) {
          allData[courseIndex].studentCount = studentCount;
          allData[courseIndex].sessionCount = sessionCount;
          allData[courseIndex].assessmentCount = assessmentCount;
          renderApp();
        }
      } catch (error) {
        // Silent fail - counts will show as "â€”"
      }
    }

    // Load all course counts on initial load with progressive rendering
    async function loadAllCourseCounts() {
      if (!db || allData.length === 0) return;
      
      try {
        // Load counts for each course individually with progressive updates
        for (const course of allData) {
          // Use Promise.all for parallel queries per course
          Promise.all([
            db.collection('course_enrollments').where('courseId', '==', course.id).get(),
            db.collection('course_sessions').where('courseId', '==', course.id).get(),
            db.collection('assessments').where('courseId', '==', course.id).get()
          ]).then(([enrollmentsSnapshot, sessionsSnapshot, assessmentsSnapshot]) => {
            // Filter students: only count "active" status
            const studentCount = enrollmentsSnapshot.docs.filter(doc => {
              const status = doc.data().status;
              return status === 'active';
            }).length;
            
            // Filter sessions: exclude cancelled
            const sessionCount = sessionsSnapshot.docs.filter(doc => {
              const status = doc.data().sessionStatus;
              return status !== 'cancelled';
            }).length;
            
            // Filter assessments: only count "active" status
            const assessmentCount = assessmentsSnapshot.docs.filter(doc => {
              const status = doc.data().status;
              return status === 'active';
            }).length;
            
            // Update course in allData
            course.studentCount = studentCount;
            course.sessionCount = sessionCount;
            course.assessmentCount = assessmentCount;
            course.countsLoaded = true;
            
            // Update Firestore in background
            db.collection('courses').doc(course.id).update({
              studentCount: studentCount,
              sessionCount: sessionCount,
              assessmentCount: assessmentCount
            }).catch(() => {});
            
            // Progressive render: update UI as each course loads
            renderApp();
          }).catch(() => {
            // Silent fail for this course
          });
        }
      } catch (error) {
        // Silent fail
      }
    }

    function openCourseModal(modalType) {
      if (!window.courseContext) {
        showToast('No course context available');
        return;
      }

      const config = window.elementSdk?.config || defaultConfig;
      const ctx = window.courseContext;
      let targetUrl = '';
      let modalTitle = '';

      switch (modalType) {
        case MODAL_ENROLLMENT_COURSES:
          targetUrl = `Enrollment_Courses.html?courseId=${encodeURIComponent(ctx.courseId)}`;
          modalTitle = 'Manage Students';
          break;

        case MODAL_ATTENDANCE_COURSES:
          targetUrl = `Attendance_Courses.html?courseId=${encodeURIComponent(ctx.courseId)}`;
          modalTitle = 'Manage Attendance';
          break;

        case MODAL_PERFORMANCE_COURSES:
          targetUrl = `Assessment_Courses.html?courseId=${encodeURIComponent(ctx.courseId)}`;
          modalTitle = 'Manage Performance';
          break;

        default:
          showToast('Unknown modal type');
          return;
      }

      // Create modal with iframe
      const modalContent = `
        <div style="position: relative; width: 100%; height: 70vh; min-height: 500px;">
          <iframe 
            id="course-modal-iframe" 
            src="${targetUrl}" 
            style="width: 100%; height: 100%; border: none; border-radius: 8px; background-color: ${config.surface_color || defaultConfig.surface_color};"
            title="${modalTitle}">
          </iframe>
        </div>
      `;

      showModal(modalTitle, modalContent, '90%', true, async () => {
        // Refresh course data when modal closes
        await refreshCourseData(ctx.courseId);
      });
    }

    async function onConfigChange(config) {
      const root = document.documentElement;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      
      root.style.setProperty('--primary-bg', config.primary_bg || defaultConfig.primary_bg);
      root.style.setProperty('--surface-color', config.surface_color || defaultConfig.surface_color);
      root.style.setProperty('--text-color', config.text_color || defaultConfig.text_color);
      root.style.setProperty('--primary-action', config.primary_action || defaultConfig.primary_action);
      root.style.setProperty('--secondary-action', config.secondary_action || defaultConfig.secondary_action);
      root.style.setProperty('--border-color', config.border_color || defaultConfig.border_color);
      
      document.body.style.fontFamily = `${customFont}, system-ui, -apple-system, sans-serif`;
      document.body.style.fontSize = `${baseSize}px`;
    }

    function renderApp() {
      const config = window.elementSdk?.config || defaultConfig;
      const app = document.getElementById('app');
      
      app.innerHTML = `
        <div class="main-content-wrapper">
          <div class="main-content">
            ${renderMainContent()}
          </div>
        </div>
      `;

      attachEventListeners();
    }

    function renderMainContent() {
      switch (currentView) {
        case 'courses':
          return renderCoursesView();
        default:
          return renderCoursesView();
      }
    }

    function renderCoursesView() {
      const config = window.elementSdk?.config || defaultConfig;
      
      if (currentUser.role === 'teacher') {
        return renderTeacherCoursesView();
      }
      
      return '';
    }
    
    let teacherCourseTab = 'inprogress';
    let teacherSearchQuery = '';
    let teacherSortBy = 'courseCode';
    let teacherSortDirection = 'asc'; // 'asc' or 'desc'

    // Firestore real-time listener for Staff
    function setupStaffListener() {
      if (!db) return;
      
      // Unsubscribe from previous listener if exists
      if (staffUnsubscribe) {
        staffUnsubscribe();
      }

      staffUnsubscribe = db.collection('staff')
        .where('status', '==', 'active')
        .onSnapshot((snapshot) => {
          staffData = [];
          snapshot.forEach((doc) => {
            const data = doc.data();
            // Only include staff with "Teacher" role
            if (data.roles && Array.isArray(data.roles) && data.roles.includes('Teacher')) {
              staffData.push({
                id: doc.id,
                publicCode: data.publicCode || doc.id,
                fullName: data.fullName || 'Unknown',
                ...data
              });
            }
          });
        }, () => {
          // Error loading staff
        });
    }

    // Firestore real-time listener
    function setupFirestoreListener() {
      if (!db) {
        // Hide loading indicator if no database
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) loadingIndicator.classList.remove('show');
        return;
      }
      
      // Unsubscribe from previous listener if exists
      if (unsubscribe) {
        unsubscribe();
      }

      let isFirstLoad = true;

      unsubscribe = db.collection('courses').onSnapshot(async (snapshot) => {
        allData = [];
        snapshot.forEach((doc) => {
          allData.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // Query course_staff and course_meetings for display data
        await enrichCoursesData();
        
        // Hide loading indicator after first load
        if (isFirstLoad) {
          const loadingIndicator = document.getElementById('loadingIndicator');
          if (loadingIndicator) loadingIndicator.classList.remove('show');
          isFirstLoad = false;
          loadAllCourseCounts();
        }
        
        renderApp();
      }, () => {
        // Error loading courses - hide loading indicator
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) loadingIndicator.classList.remove('show');
      });
    }

    // Enrich courses with staff and meeting data
    async function enrichCoursesData() {
      if (!db || allData.length === 0) return;

      // Use Promise.all to wait for all enrichment to complete before rendering
      await Promise.all(allData.map(async (course) => {
        try {
          // Query course_staff for this course
          const staffSnapshot = await db.collection('course_staff')
            .where('courseId', '==', course.id)
            .get();
          
          let primaryTeacherName = 'Not assigned';
          let additionalTeacherNames = [];

          staffSnapshot.forEach(doc => {
            const staffData = doc.data();
            if (staffData.role === 'primary') {
              // Use staffNameCache if available, otherwise lookup from staffData array
              if (staffData.staffNameCache) {
                primaryTeacherName = staffData.staffNameCache;
              } else {
                const teacher = staffData.find(s => s.publicCode === staffData.staffId);
                primaryTeacherName = teacher ? teacher.fullName : 'Not assigned';
              }
            } else if (staffData.role === 'assistant') {
              // Use staffNameCache if available, otherwise lookup from staffData array
              if (staffData.staffNameCache) {
                additionalTeacherNames.push(staffData.staffNameCache);
              } else {
                const teacher = staffData.find(s => s.publicCode === staffData.staffId);
                if (teacher) additionalTeacherNames.push(teacher.fullName);
              }
            }
          });

          course.primaryTeacherName = primaryTeacherName;
          course.additionalTeacherNames = additionalTeacherNames;
        } catch (error) {
          course.primaryTeacherName = 'Not assigned';
          course.additionalTeacherNames = [];
        }

        try {
          // Query course_sessions to calculate first and last session dates
          const sessionsSnapshot = await db.collection('course_sessions')
            .where('courseId', '==', course.id)
            .orderBy('sessionDate', 'asc')
            .get();
          
          if (!sessionsSnapshot.empty) {
            const sessionDates = [];
            sessionsSnapshot.forEach(doc => {
              const sessionDate = doc.data().sessionDate;
              if (sessionDate) {
                sessionDates.push(sessionDate);
              }
            });
            
            if (sessionDates.length > 0) {
              course.firstSessionDate = sessionDates[0];
              course.lastSessionDate = sessionDates[sessionDates.length - 1];
            } else {
              course.firstSessionDate = null;
              course.lastSessionDate = null;
            }
          } else {
            course.firstSessionDate = null;
            course.lastSessionDate = null;
          }
        } catch (error) {
          course.firstSessionDate = null;
          course.lastSessionDate = null;
        }

        try {
          // Query course_meetings for this course
          const meetingsSnapshot = await db.collection('course_meetings')
            .where('courseId', '==', course.id)
            .where('isActive', '==', true)
            .get();
          
          if (meetingsSnapshot.empty || course.scheduleType === 'none') {
            course.scheduleText = course.scheduleType === 'none' ? 'No fixed schedule' : 'Not set';
          } else {
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const meetings = [];
            
            meetingsSnapshot.forEach(doc => {
              const m = doc.data();
              const formatTime = (time24) => {
                const [hours, minutes] = time24.split(':');
                const h = parseInt(hours);
                const period = h >= 12 ? 'PM' : 'AM';
                const h12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
                return `${h12}:${minutes} ${period}`;
              };
              meetings.push(`${dayNames[m.dayOfWeek]} ${formatTime(m.startTime)}-${formatTime(m.endTime)}`);
            });

            course.scheduleText = meetings.join(', ');
          }
        } catch (error) {
          course.scheduleText = 'Not set';
        }
      }));
    }

    // Firestore CRUD Operations
    async function createCourse(courseData) {
      if (!db) {
        showToast("Database not initialized");
        return { success: false };
      }

      const savingIndicator = document.getElementById('savingIndicator');
      savingIndicator.classList.add('show');

      try {
        // Generate structured course ID: CRS_<publicCode>_<year>
        const year = courseData.startDate ? new Date(courseData.startDate).getFullYear() : new Date().getFullYear();
        const publicCodeUpper = courseData.publicCode.toUpperCase().replace(/\s+/g, '_');
        const courseId = `CRS_${publicCodeUpper}_${year}`;

        // Check if course ID already exists
        const existingDoc = await db.collection('courses').doc(courseId).get();
        if (existingDoc.exists) {
          savingIndicator.classList.remove('show');
          showToast(`Course ${courseData.publicCode} already exists for year ${year}`);
          return { success: false, error: 'Course ID already exists' };
        }

        // Create course document (NO teacher arrays, NO schedules)
        const newCourseDoc = {
          publicCode: courseData.publicCode,
          name: courseData.name,
          status: courseData.status,
          startDate: courseData.startDate,
          endDate: courseData.endDate || null,
          scheduleType: courseData.scheduleType,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('courses').doc(courseId).set(newCourseDoc);

        // Write course_meetings
        await writeCourseMeetings(courseId, courseData.meetings || []);

        // Write course_staff
        await writeCourseStaff(courseId, courseData.primaryTeacherId, courseData.additionalTeacherIds || []);

        savingIndicator.classList.remove('show');
        return { success: true, courseId };
      } catch (error) {
        savingIndicator.classList.remove('show');
        return { success: false, error };
      }
    }

    async function updateCourse(courseId, courseData) {
      if (!db) {
        showToast("Database not initialized");
        return { success: false };
      }

      const savingIndicator = document.getElementById('savingIndicator');
      savingIndicator.classList.add('show');

      try {
        // Update course document (NO teacher arrays, NO schedules)
        await db.collection('courses').doc(courseId).update({
          publicCode: courseData.publicCode,
          name: courseData.name,
          status: courseData.status,
          startDate: courseData.startDate,
          endDate: courseData.endDate || null,
          scheduleType: courseData.scheduleType,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Replace course_meetings
        await writeCourseMeetings(courseId, courseData.meetings || []);

        // Replace course_staff
        await writeCourseStaff(courseId, courseData.primaryTeacherId, courseData.additionalTeacherIds || []);
        
        savingIndicator.classList.remove('show');
        return { success: true };
      } catch (error) {
        savingIndicator.classList.remove('show');
        return { success: false, error };
      }
    }

    async function writeCourseMeetings(courseId, meetings) {
      if (!db) return;

      // Delete all existing meetings for this course
      const existingMeetings = await db.collection('course_meetings')
        .where('courseId', '==', courseId)
        .get();
      
      const batch = db.batch();
      existingMeetings.forEach(doc => {
        batch.delete(doc.ref);
      });
      await batch.commit();

      // Add new meetings
      if (meetings.length > 0) {
        const batch2 = db.batch();
        meetings.forEach((meeting, index) => {
          const seq = String(index + 1).padStart(3, '0');
          const meetingId = `MTG_${courseId}_${seq}`;
          const meetingRef = db.collection('course_meetings').doc(meetingId);
          
          batch2.set(meetingRef, {
            courseId,
            dayOfWeek: meeting.dayOfWeek,
            startTime: meeting.startTime,
            endTime: meeting.endTime,
            timezone: 'Asia/Bangkok',
            isActive: true
          });
        });
        await batch2.commit();
      }
    }

    async function writeCourseStaff(courseId, primaryTeacherId, additionalTeacherIds) {
      if (!db) return;

      // Delete all existing course_staff for this course
      const existingStaff = await db.collection('course_staff')
        .where('courseId', '==', courseId)
        .get();
      
      const batch = db.batch();
      existingStaff.forEach(doc => {
        batch.delete(doc.ref);
      });
      await batch.commit();

      // Add primary teacher
      if (primaryTeacherId) {
        const primaryStaff = staffData.find(s => s.publicCode === primaryTeacherId);
        const staffDocId = `CST_${courseId}_${primaryTeacherId}`;
        
        await db.collection('course_staff').doc(staffDocId).set({
          courseId,
          staffId: primaryTeacherId,
          role: 'primary',
          staffNameCache: primaryStaff ? primaryStaff.fullName : '',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      // Add additional teachers
      if (additionalTeacherIds.length > 0) {
        const batch2 = db.batch();
        additionalTeacherIds.forEach(teacherId => {
          const teacher = staffData.find(s => s.publicCode === teacherId);
          const staffDocId = `CST_${courseId}_${teacherId}`;
          const staffRef = db.collection('course_staff').doc(staffDocId);
          
          batch2.set(staffRef, {
            courseId,
            staffId: teacherId,
            role: 'assistant',
            staffNameCache: teacher ? teacher.fullName : '',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        await batch2.commit();
      }
    }

    async function deleteCourse(courseId) {
      if (!db) {
        showToast("Database not initialized");
        return { success: false };
      }

      const savingIndicator = document.getElementById('savingIndicator');
      savingIndicator.classList.add('show');

      try {
        // Delete main course document
        await db.collection('courses').doc(courseId).delete();

        // Delete all course_staff entries
        const staffSnapshot = await db.collection('course_staff')
          .where('courseId', '==', courseId)
          .get();
        
        const staffBatch = db.batch();
        staffSnapshot.forEach(doc => {
          staffBatch.delete(doc.ref);
        });
        await staffBatch.commit();

        // Delete all course_meetings entries
        const meetingsSnapshot = await db.collection('course_meetings')
          .where('courseId', '==', courseId)
          .get();
        
        const meetingsBatch = db.batch();
        meetingsSnapshot.forEach(doc => {
          meetingsBatch.delete(doc.ref);
        });
        await meetingsBatch.commit();

        // Delete all enrollments
        const enrollmentsSnapshot = await db.collection('course_enrollments')
          .where('courseId', '==', courseId)
          .get();
        
        const enrollmentsBatch = db.batch();
        enrollmentsSnapshot.forEach(doc => {
          enrollmentsBatch.delete(doc.ref);
        });
        await enrollmentsBatch.commit();

        // Delete all course_sessions
        const sessionsSnapshot = await db.collection('course_sessions')
          .where('courseId', '==', courseId)
          .get();
        
        const sessionsBatch = db.batch();
        sessionsSnapshot.forEach(doc => {
          sessionsBatch.delete(doc.ref);
        });
        await sessionsBatch.commit();

        // Delete all assessments
        const assessmentsSnapshot = await db.collection('assessments')
          .where('courseId', '==', courseId)
          .get();
        
        const assessmentsBatch = db.batch();
        assessmentsSnapshot.forEach(doc => {
          assessmentsBatch.delete(doc.ref);
        });
        await assessmentsBatch.commit();
        
        savingIndicator.classList.remove('show');
        return { success: true };
      } catch (error) {
        console.error("Error deleting course:", error);
        savingIndicator.classList.remove('show');
        return { success: false, error };
      }
    }



    function renderTeacherCoursesView() {
      const config = window.elementSdk?.config || defaultConfig;
      
      const inProgressCourses = allData.filter(c => c.status === 'active');
      const upcomingCourses = allData.filter(c => c.status === 'draft');
      const finishedCourses = allData.filter(c => c.status === 'archived');
      
      let displayCourses = [];
      if (teacherCourseTab === 'inprogress') displayCourses = inProgressCourses;
      else if (teacherCourseTab === 'upcoming') displayCourses = upcomingCourses;
      else displayCourses = finishedCourses;
      
      if (teacherSearchQuery) {
        displayCourses = displayCourses.filter(c => 
          c.name.toLowerCase().includes(teacherSearchQuery.toLowerCase()) ||
          c.publicCode.toLowerCase().includes(teacherSearchQuery.toLowerCase())
        );
      }
      
      displayCourses.sort((a, b) => {
        let comparison = 0;
        
        if (teacherSortBy === 'courseCode') {
          comparison = (a.publicCode || '').localeCompare(b.publicCode || '');
        } else if (teacherSortBy === 'courseName') {
          comparison = (a.name || '').localeCompare(b.name || '');
        } else if (teacherSortBy === 'teacher') {
          comparison = (a.primaryTeacherName || '').localeCompare(b.primaryTeacherName || '');
        } else if (teacherSortBy === 'startDate') {
          const dateA = a.startDate ? new Date(a.startDate).getTime() : 0;
          const dateB = b.startDate ? new Date(b.startDate).getTime() : 0;
          comparison = dateA - dateB;
        } else if (teacherSortBy === 'studentCount') {
          const countA = a.studentCount || 0;
          const countB = b.studentCount || 0;
          comparison = countA - countB;
        } else if (teacherSortBy === 'sessionCount') {
          const countA = a.sessionCount || 0;
          const countB = b.sessionCount || 0;
          comparison = countA - countB;
        } else if (teacherSortBy === 'assessmentCount') {
          const countA = a.assessmentCount || 0;
          const countB = b.assessmentCount || 0;
          comparison = countA - countB;
        }
        
        // Apply sort direction
        return teacherSortDirection === 'desc' ? -comparison : comparison;
      });

      return `
        <!-- Tabs Navigation -->
        <div style="display: flex; justify-content: center; margin-bottom: 24px;">
          <div style="display: inline-flex; gap: 8px; background-color: ${config.surface_color || defaultConfig.surface_color}; padding: 6px; border-radius: 8px; border: 1px solid ${config.border_color || defaultConfig.border_color};">
            <button class="course-tab-btn ${teacherCourseTab === 'inprogress' ? 'active' : ''}" data-tab="inprogress" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border: none; background: ${teacherCourseTab === 'inprogress' ? '#3b82f6' : 'transparent'}; color: ${teacherCourseTab === 'inprogress' ? '#ffffff' : config.text_color}; border-radius: 6px; cursor: pointer; font-size: ${config.font_size || defaultConfig.font_size}px; font-weight: 500; transition: all 0.2s;">
              ðŸ“š In Progress
              <span style="background-color: ${teacherCourseTab === 'inprogress' ? 'rgba(255,255,255,0.2)' : config.border_color}; padding: 2px 8px; border-radius: 12px; font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px;">${inProgressCourses.length}</span>
            </button>
            <button class="course-tab-btn ${teacherCourseTab === 'upcoming' ? 'active' : ''}" data-tab="upcoming" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border: none; background: ${teacherCourseTab === 'upcoming' ? '#f97316' : 'transparent'}; color: ${teacherCourseTab === 'upcoming' ? '#ffffff' : config.text_color}; border-radius: 6px; cursor: pointer; font-size: ${config.font_size || defaultConfig.font_size}px; font-weight: 500; transition: all 0.2s;">
              ðŸ“… Upcoming
              <span style="background-color: ${teacherCourseTab === 'upcoming' ? 'rgba(255,255,255,0.2)' : config.border_color}; padding: 2px 8px; border-radius: 12px; font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px;">${upcomingCourses.length}</span>
            </button>
            <button class="course-tab-btn ${teacherCourseTab === 'finished' ? 'active' : ''}" data-tab="finished" style="display: flex; align-items: center; gap: 8px; padding: 8px 16px; border: none; background: ${teacherCourseTab === 'finished' ? '#10b981' : 'transparent'}; color: ${teacherCourseTab === 'finished' ? '#ffffff' : config.text_color}; border-radius: 6px; cursor: pointer; font-size: ${config.font_size || defaultConfig.font_size}px; font-weight: 500; transition: all 0.2s;">
              âœ… Finished
              <span style="background-color: ${teacherCourseTab === 'finished' ? 'rgba(255,255,255,0.2)' : config.border_color}; padding: 2px 8px; border-radius: 12px; font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px;">${finishedCourses.length}</span>
            </button>
          </div>
        </div>

        <!-- Control Panel Card -->
        <div class="card" style="background-color: ${config.surface_color || defaultConfig.surface_color}; border-color: ${config.border_color || defaultConfig.border_color}; margin-bottom: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 16px;">
            <!-- Left Side: Search and Sort -->
            <div style="display: flex; gap: 12px; flex: 1; align-items: center;">
              <input type="text" id="teacher-search-input" placeholder="Search coursesâ€¦" value="${teacherSearchQuery}" class="form-input" style="flex: 1; max-width: 320px; background-color: ${config.primary_bg || defaultConfig.primary_bg}; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};">
              
              <label for="teacher-sort-select" style="font-size: ${config.font_size || defaultConfig.font_size}px; color: ${config.text_color || defaultConfig.text_color}; font-weight: 500; white-space: nowrap;">Sort by</label>
              <select id="teacher-sort-select" class="form-select" style="width: 200px; background-color: ${config.primary_bg || defaultConfig.primary_bg}; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};">
                <option value="courseCode" ${teacherSortBy === 'courseCode' ? 'selected' : ''}>Course Code</option>
                <option value="courseName" ${teacherSortBy === 'courseName' ? 'selected' : ''}>Course Name</option>
                <option value="teacher" ${teacherSortBy === 'teacher' ? 'selected' : ''}>Teacher</option>
                <option value="startDate" ${teacherSortBy === 'startDate' ? 'selected' : ''}>Start Date</option>
                <option value="studentCount" ${teacherSortBy === 'studentCount' ? 'selected' : ''}>Student Count</option>
                <option value="sessionCount" ${teacherSortBy === 'sessionCount' ? 'selected' : ''}>Session Count</option>
                <option value="assessmentCount" ${teacherSortBy === 'assessmentCount' ? 'selected' : ''}>Assessment Count</option>
              </select>
              
              <button id="sort-direction-btn" class="btn-secondary" style="padding: 8px 12px; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};" title="${teacherSortDirection === 'desc' ? 'Descending' : 'Ascending'}">
                ${teacherSortDirection === 'desc' ? 'â†“' : 'â†‘'}
              </button>
            </div>

            <!-- Right Side: Add Course Button -->
            <button class="btn-primary" id="teacher-add-course-btn" style="background-color: #9333ea; padding: 8px 20px;">+ Add Course</button>
          </div>
        </div>

        <!-- Courses Table -->
        ${displayCourses.length === 0 ? `
          <div class="card" style="background-color: ${config.surface_color || defaultConfig.surface_color}; border-color: ${config.border_color || defaultConfig.border_color};">
            <div class="empty-state">
              <div class="empty-state-icon">ðŸ“š</div>
              <div style="font-size: ${(config.font_size || defaultConfig.font_size) * 1.15}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Add your first course</div>
              <div style="font-size: ${config.font_size || defaultConfig.font_size}px; color: ${config.secondary_action || defaultConfig.secondary_action};">Get started by creating a course to teach</div>
            </div>
          </div>
        ` : `
          <div class="card" style="background-color: ${config.surface_color || defaultConfig.surface_color}; border-color: ${config.border_color || defaultConfig.border_color}; padding: 0; overflow: hidden;">
            <div style="overflow-x: auto;">
              <table>
                <thead style="position: sticky; top: 0; background-color: ${config.primary_bg || defaultConfig.primary_bg}; z-index: 1;">
                  <tr>
                    <th style="color: ${config.secondary_action || defaultConfig.secondary_action}; border-bottom-color: ${config.border_color || defaultConfig.border_color}; padding: 12px 16px;">Course</th>
                    <th style="color: ${config.secondary_action || defaultConfig.secondary_action}; border-bottom-color: ${config.border_color || defaultConfig.border_color}; padding: 12px 16px;">Teacher & Schedule</th>
                    <th style="color: ${config.secondary_action || defaultConfig.secondary_action}; border-bottom-color: ${config.border_color || defaultConfig.border_color}; padding: 12px 16px;">Students</th>
                    <th style="color: ${config.secondary_action || defaultConfig.secondary_action}; border-bottom-color: ${config.border_color || defaultConfig.border_color}; padding: 12px 16px;">Sessions</th>
                    <th style="color: ${config.secondary_action || defaultConfig.secondary_action}; border-bottom-color: ${config.border_color || defaultConfig.border_color}; padding: 12px 16px;">Assessments</th>
                    <th style="color: ${config.secondary_action || defaultConfig.secondary_action}; border-bottom-color: ${config.border_color || defaultConfig.border_color}; padding: 12px 16px; text-align: right;">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  ${displayCourses.map(course => {
                    // Show stored counts immediately, or 0 if not available
                    const studentCount = course.studentCount !== undefined ? course.studentCount : 0;
                    const sessionCount = course.sessionCount !== undefined ? course.sessionCount : 0;
                    const assessmentCount = course.assessmentCount !== undefined ? course.assessmentCount : 0;
                    
                    // Teacher names from cached data
                    const primaryTeacher = course.primaryTeacherName || 'Not assigned';
                    const additionalTeachers = course.additionalTeacherNames || [];
                    
                    // Build teacher display: primary teacher + additional teachers on separate lines
                    let teacherDisplay = `<div style="font-weight: 500; color: ${config.text_color || defaultConfig.text_color};">${primaryTeacher}</div>`;
                    if (additionalTeachers.length > 0) {
                      additionalTeachers.forEach(name => {
                        teacherDisplay += `<div style="font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-top: 2px;">${name}</div>`;
                      });
                    }
                    
                    const scheduleText = course.scheduleText || 'Not set';
                    // Period: first session date to most recent session date
                    let periodText = '';
                    if (course.firstSessionDate && course.lastSessionDate) {
                      // Dates are in yyyy-mm-dd format, convert to dd/mm/yyyy
                      const formatDateStr = (dateStr) => {
                        const parts = dateStr.split('-');
                        return `${parts[2]}/${parts[1]}/${parts[0]}`;
                      };
                      const firstDateStr = formatDateStr(course.firstSessionDate);
                      const lastDateStr = formatDateStr(course.lastSessionDate);
                      periodText = `Period: ${firstDateStr} - ${lastDateStr}`;
                    }
                    
                    // Format start date
                    const courseStartDate = course.startDate ? new Date(course.startDate) : null;
                    const startDateText = courseStartDate ? `Start: ${courseStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}` : '';
                    
                    return `
                      <tr style="border-bottom-color: ${config.border_color || defaultConfig.border_color};">
                        <td style="padding: 12px 16px;">
                          <div style="font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 2px;">${course.publicCode}</div>
                          <div style="font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; color: ${config.secondary_action || defaultConfig.secondary_action};">${course.name}</div>
                        </td>
                        <td style="padding: 12px 16px;">
                          <div style="color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 2px;">${teacherDisplay}</div>
                          <div style="font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; color: ${config.secondary_action || defaultConfig.secondary_action}; margin-top: 6px;">${scheduleText}</div>
                          ${startDateText ? `<div style="font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px; color: ${config.secondary_action || defaultConfig.secondary_action}; margin-top: 2px;">${startDateText}</div>` : ''}
                        </td>
                        <td style="padding: 12px 16px;">
                          <div style="font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 4px;">${studentCount} students</div>
                          <button class="link-btn manage-students-btn" data-course-id="${course.id}" style="background: none; border: none; color: ${config.primary_action || defaultConfig.primary_action}; font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; cursor: pointer; padding: 0; text-decoration: underline;">Manage Students</button>
                        </td>
                        <td style="padding: 12px 16px;">
                          <div style="font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 4px;">${sessionCount} sessions</div>
                          <button class="link-btn manage-attendance-btn" data-course-id="${course.id}" style="background: none; border: none; color: ${config.primary_action || defaultConfig.primary_action}; font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; cursor: pointer; padding: 0; text-decoration: underline; margin-bottom: 4px;">Manage Attendance</button>
                          ${periodText ? `<div style="font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px; color: ${config.secondary_action || defaultConfig.secondary_action}; margin-top: 4px;">${periodText}</div>` : ''}
                        </td>
                        <td style="padding: 12px 16px;">
                          <div style="font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 4px;">${assessmentCount} assessments</div>
                          <button class="link-btn manage-performance-btn" data-course-id="${course.id}" style="background: none; border: none; color: ${config.primary_action || defaultConfig.primary_action}; font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; cursor: pointer; padding: 0; text-decoration: underline;">Manage Performance</button>
                        </td>
                        <td style="padding: 12px 16px; text-align: right;">
                          <button class="text-action-btn" data-action="edit" data-course="${course.id}" style="background: none; border: none; color: ${config.primary_action || defaultConfig.primary_action}; font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; cursor: pointer; padding: 4px 8px;">Edit</button>
                          <span style="color: ${config.border_color || defaultConfig.border_color};">|</span>
                          <button class="text-action-btn" data-action="delete" data-course="${course.id}" style="background: none; border: none; color: #ef4444; font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; cursor: pointer; padding: 4px 8px;">Delete</button>
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `}
      `;
    }

    function showModal(title, content, width = '650px', showCloseButton = false, onClose = null) {
      const config = window.elementSdk?.config || defaultConfig;
      const modal = document.createElement('div');
      modal.className = 'modal-backdrop';
      
      modal.innerHTML = `
        <div class="modal-content" style="max-width: ${width}; width: 100%;">
          <div class="modal-header" style="border-bottom-color: ${config.border_color || defaultConfig.border_color};">
            <h3 style="font-size: ${(config.font_size || defaultConfig.font_size) * 1.23}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin: 0;">${title}</h3>
            ${showCloseButton ? `<button id="close-modal" class="btn-secondary" style="border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};">Close</button>` : `<button id="close-modal" style="background: none; border: none; font-size: ${(config.font_size || defaultConfig.font_size) * 1.85}px; cursor: pointer; color: ${config.secondary_action || defaultConfig.secondary_action}; line-height: 1; padding: 0;">&times;</button>`}
          </div>
          <div class="modal-body">
            ${content}
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      const closeHandler = () => {
        // Close modal immediately
        modal.remove();
        // Run refresh in background without blocking
        if (onClose) {
          onClose();
        }
      };

      document.getElementById('close-modal').addEventListener('click', closeHandler);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeHandler();
        }
      });
    }

    async function loadCourseDataForEdit(courseId) {
      if (!db) return null;

      try {
        // Load course document
        const courseDoc = await db.collection('courses').doc(courseId).get();
        if (!courseDoc.exists) return null;

        const courseData = { id: courseDoc.id, ...courseDoc.data() };

        // Load course_meetings
        const meetingsSnapshot = await db.collection('course_meetings')
          .where('courseId', '==', courseId)
          .where('isActive', '==', true)
          .get();
        
        courseData.meetings = [];
        meetingsSnapshot.forEach(doc => {
          courseData.meetings.push(doc.data());
        });

        // Load course_staff
        const staffSnapshot = await db.collection('course_staff')
          .where('courseId', '==', courseId)
          .get();
        
        courseData.primaryTeacherId = '';
        courseData.additionalTeacherIds = [];
        
        staffSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.role === 'primary') {
            courseData.primaryTeacherId = data.staffId;
          } else if (data.role === 'assistant') {
            courseData.additionalTeacherIds.push(data.staffId);
          }
        });

        return courseData;
      } catch (error) {
        return null;
      }
    }

    function showAddCourseModal(existingCourse = null) {
      const config = window.elementSdk?.config || defaultConfig;
      const isEditMode = !!existingCourse;
      
      // Initialize schedule data
      const scheduleType = existingCourse?.scheduleType || 'fixed';
      const meetings = existingCourse?.meetings || [];
      const noFixedSchedule = scheduleType === 'none';
      
      // Initialize teacher data
      const existingPrimaryTeacherId = existingCourse?.primaryTeacherId || '';
      const additionalTeacherIds = existingCourse?.additionalTeacherIds || [];
      
      const content = `
        <form id="course-form">
          <!-- Two Column Layout for Basic Info -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div class="form-group" style="margin-bottom: 0;">
              <label for="course-public-code" class="form-label" style="color: ${config.text_color || defaultConfig.text_color};">Course Code</label>
              <input type="text" id="course-public-code" class="form-input" required value="${existingCourse?.publicCode || ''}" placeholder="e.g., CS101" style="background-color: ${config.primary_bg || defaultConfig.primary_bg}; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};">
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label for="course-status" class="form-label" style="color: ${config.text_color || defaultConfig.text_color};">Status</label>
              <select id="course-status" class="form-select" required style="background-color: ${config.primary_bg || defaultConfig.primary_bg}; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};">
                <option value="draft" ${existingCourse?.status === 'draft' ? 'selected' : ''}>Upcoming</option>
                <option value="active" ${existingCourse?.status === 'active' || !existingCourse ? 'selected' : ''}>In Progress</option>
                <option value="archived" ${existingCourse?.status === 'archived' ? 'selected' : ''}>Finished</option>
              </select>
            </div>
          </div>

          <div class="form-group" style="margin-bottom: 12px;">
            <label for="course-name" class="form-label" style="color: ${config.text_color || defaultConfig.text_color};">Course Name</label>
            <input type="text" id="course-name" class="form-input" required value="${existingCourse?.name || ''}" placeholder="e.g., Introduction to Computer Science" style="background-color: ${config.primary_bg || defaultConfig.primary_bg}; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};">
          </div>

          <!-- Date Fields Side by Side -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
            <div class="form-group" style="margin-bottom: 0;">
              <label for="course-start-date" class="form-label" style="color: ${config.text_color || defaultConfig.text_color};">Start Date</label>
              <input type="date" id="course-start-date" class="form-input" required value="${existingCourse?.startDate || ''}" style="background-color: ${config.primary_bg || defaultConfig.primary_bg}; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};">
            </div>

            <div class="form-group" style="margin-bottom: 0;">
              <label for="course-end-date" class="form-label" style="color: ${config.text_color || defaultConfig.text_color};">Expected End Date</label>
              <input type="date" id="course-end-date" class="form-input" value="${existingCourse?.endDate || ''}" style="background-color: ${config.primary_bg || defaultConfig.primary_bg}; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};">
            </div>
          </div>

          <!-- Section Divider -->
          <div style="border-top: 1px solid ${config.border_color || defaultConfig.border_color}; margin: 16px 0 12px 0; padding-top: 12px;">
            <div style="font-size: ${(config.font_size || defaultConfig.font_size) * 1.08}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 12px;">Teachers</div>
          </div>

          <div class="form-group" style="margin-bottom: 12px;">
            <label for="course-teacher" class="form-label" style="color: ${config.text_color || defaultConfig.text_color};">Primary Teacher</label>
            <select id="course-teacher" class="form-select" required style="background-color: ${config.primary_bg || defaultConfig.primary_bg}; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};">
              <option value="">Select primary teacher...</option>
              ${staffData.map(staff => {
                const isSelected = existingPrimaryTeacherId === staff.publicCode;
                return `<option value="${staff.publicCode}" ${isSelected ? 'selected' : ''}>${staff.fullName} (${staff.publicCode})</option>`;
              }).join('')}
            </select>
          </div>

          <div class="form-group" style="margin-bottom: 12px;">
            <label for="additional-teacher-select" class="form-label" style="color: ${config.text_color || defaultConfig.text_color};">Additional Teachers (Optional)</label>
            <select id="additional-teacher-select" class="form-select" style="background-color: ${config.primary_bg || defaultConfig.primary_bg}; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};">
              <option value="">Select additional teacher...</option>
            </select>
            <div id="selected-additional-teachers" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 8px;">
              ${additionalTeacherIds.map(teacherId => {
                const teacher = staffData.find(s => s.publicCode === teacherId);
                if (!teacher) return '';
                return `
                  <span class="additional-teacher-tag" data-teacher-id="${teacherId}" style="display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; background-color: ${config.primary_bg || defaultConfig.primary_bg}; border: 1px solid ${config.border_color || defaultConfig.border_color}; border-radius: 6px; font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px; color: ${config.text_color || defaultConfig.text_color};">
                    ${teacher.fullName}
                    <button type="button" class="remove-additional-teacher" data-teacher-id="${teacherId}" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 0; font-size: 16px; line-height: 1;">Ã—</button>
                  </span>
                `;
              }).join('')}
            </div>
          </div>

          <!-- Section Divider -->
          <div style="border-top: 1px solid ${config.border_color || defaultConfig.border_color}; margin: 16px 0 12px 0; padding-top: 12px;">
            <div style="font-size: ${(config.font_size || defaultConfig.font_size) * 1.08}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Weekly Schedule</div>
          </div>

          <div class="form-group" style="margin-bottom: 12px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="no-fixed-schedule" ${noFixedSchedule ? 'checked' : ''} style="cursor: pointer;">
              <span style="font-size: ${config.font_size || defaultConfig.font_size}px; color: ${config.text_color || defaultConfig.text_color};">No fixed schedule</span>
            </label>
          </div>

          <div id="schedule-builder" style="display: ${noFixedSchedule ? 'none' : 'block'}; margin-bottom: 12px;">
            <div style="font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px; color: ${config.secondary_action || defaultConfig.secondary_action}; margin-bottom: 8px;">Enter time in 12-hour format (e.g., 9:00, 3:30) then select AM or PM</div>
            <div id="schedule-rows"></div>
            <button type="button" id="add-schedule-row" class="btn-secondary" style="margin-top: 8px; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color}; font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; padding: 6px 12px;">+ Add weekly session</button>
          </div>

          <div style="display: flex; gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid ${config.border_color || defaultConfig.border_color};">
            <button type="button" id="cancel-btn" class="btn-secondary" style="flex: 1; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};">Cancel</button>
            <button type="submit" class="btn-primary" style="flex: 1; background-color: #9333ea;">${isEditMode ? 'Update Course' : 'Add Course'}</button>
          </div>
        </form>
      `;

      showModal(isEditMode ? 'Edit Course' : 'Add New Course', content);

      // Schedule builder functionality
      const scheduleRowsContainer = document.getElementById('schedule-rows');
      const addScheduleRowBtn = document.getElementById('add-schedule-row');
      const noFixedScheduleCheckbox = document.getElementById('no-fixed-schedule');
      const scheduleBuilder = document.getElementById('schedule-builder');

      let scheduleRowCounter = 0;

      // Day of week mapping
      const dayOfWeekMap = {
        '0': 'Sunday',
        '1': 'Monday',
        '2': 'Tuesday',
        '3': 'Wednesday',
        '4': 'Thursday',
        '5': 'Friday',
        '6': 'Saturday'
      };

      function convertTo12Hour(time24) {
        if (!time24) return { time: '', period: 'AM' };
        const [hours, minutes] = time24.split(':');
        const h = parseInt(hours);
        const period = h >= 12 ? 'PM' : 'AM';
        const h12 = h === 0 ? 12 : h > 12 ? h - 12 : h;
        return { time: `${h12}:${minutes}`, period };
      }

      function convertTo24Hour(time12, period) {
        if (!time12) return '';
        const [hours, minutes] = time12.split(':');
        let h = parseInt(hours);
        
        if (period === 'PM' && h !== 12) h += 12;
        if (period === 'AM' && h === 12) h = 0;
        
        return `${String(h).padStart(2, '0')}:${minutes}`;
      }

      function createScheduleRow(dayOfWeek = '', startTime = '', endTime = '') {
        const rowId = `schedule-row-${scheduleRowCounter++}`;
        const row = document.createElement('div');
        row.id = rowId;
        row.style.cssText = `display: flex; gap: 8px; margin-bottom: 8px; align-items: center;`;
        
        const startTimeData = convertTo12Hour(startTime);
        const endTimeData = convertTo12Hour(endTime);
        
        row.innerHTML = `
          <select class="form-select schedule-day" required style="flex: 1; background-color: ${config.primary_bg || defaultConfig.primary_bg}; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};">
            <option value="">Day</option>
            <option value="0" ${dayOfWeek === 0 || dayOfWeek === '0' ? 'selected' : ''}>Sunday</option>
            <option value="1" ${dayOfWeek === 1 || dayOfWeek === '1' ? 'selected' : ''}>Monday</option>
            <option value="2" ${dayOfWeek === 2 || dayOfWeek === '2' ? 'selected' : ''}>Tuesday</option>
            <option value="3" ${dayOfWeek === 3 || dayOfWeek === '3' ? 'selected' : ''}>Wednesday</option>
            <option value="4" ${dayOfWeek === 4 || dayOfWeek === '4' ? 'selected' : ''}>Thursday</option>
            <option value="5" ${dayOfWeek === 5 || dayOfWeek === '5' ? 'selected' : ''}>Friday</option>
            <option value="6" ${dayOfWeek === 6 || dayOfWeek === '6' ? 'selected' : ''}>Saturday</option>
          </select>
          <div style="display: flex; gap: 4px; align-items: center; flex: 1;">
            <input type="text" class="form-input schedule-start-time" required value="${startTimeData.time}" placeholder="9:00" pattern="[0-9]{1,2}:[0-9]{2}" style="flex: 1; background-color: ${config.primary_bg || defaultConfig.primary_bg}; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};">
            <button type="button" class="btn-secondary schedule-start-am ${startTimeData.period === 'AM' ? 'active-period' : ''}" style="padding: 6px 10px; font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px; border-color: ${config.border_color || defaultConfig.border_color}; background-color: ${startTimeData.period === 'AM' ? config.primary_action : config.primary_bg}; color: ${startTimeData.period === 'AM' ? '#ffffff' : config.text_color};">AM</button>
            <button type="button" class="btn-secondary schedule-start-pm ${startTimeData.period === 'PM' ? 'active-period' : ''}" style="padding: 6px 10px; font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px; border-color: ${config.border_color || defaultConfig.border_color}; background-color: ${startTimeData.period === 'PM' ? config.primary_action : config.primary_bg}; color: ${startTimeData.period === 'PM' ? '#ffffff' : config.text_color};">PM</button>
          </div>
          <span style="color: ${config.secondary_action || defaultConfig.secondary_action};">to</span>
          <div style="display: flex; gap: 4px; align-items: center; flex: 1;">
            <input type="text" class="form-input schedule-end-time" required value="${endTimeData.time}" placeholder="5:00" pattern="[0-9]{1,2}:[0-9]{2}" style="flex: 1; background-color: ${config.primary_bg || defaultConfig.primary_bg}; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};">
            <button type="button" class="btn-secondary schedule-end-am ${endTimeData.period === 'AM' ? 'active-period' : ''}" style="padding: 6px 10px; font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px; border-color: ${config.border_color || defaultConfig.border_color}; background-color: ${endTimeData.period === 'AM' ? config.primary_action : config.primary_bg}; color: ${endTimeData.period === 'AM' ? '#ffffff' : config.text_color};">AM</button>
            <button type="button" class="btn-secondary schedule-end-pm ${endTimeData.period === 'PM' ? 'active-period' : ''}" style="padding: 6px 10px; font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px; border-color: ${config.border_color || defaultConfig.border_color}; background-color: ${endTimeData.period === 'PM' ? config.primary_action : config.primary_bg}; color: ${endTimeData.period === 'PM' ? '#ffffff' : config.text_color};">PM</button>
          </div>
          <button type="button" class="btn-secondary remove-schedule-row" data-row-id="${rowId}" style="padding: 8px 12px; border-color: ${config.border_color || defaultConfig.border_color}; color: #ef4444;">&times;</button>
        `;
        
        scheduleRowsContainer.appendChild(row);
        
        // Add AM/PM toggle listeners
        const startAM = row.querySelector('.schedule-start-am');
        const startPM = row.querySelector('.schedule-start-pm');
        const endAM = row.querySelector('.schedule-end-am');
        const endPM = row.querySelector('.schedule-end-pm');
        
        startAM.addEventListener('click', () => {
          startAM.classList.add('active-period');
          startPM.classList.remove('active-period');
          startAM.style.backgroundColor = config.primary_action || defaultConfig.primary_action;
          startAM.style.color = '#ffffff';
          startPM.style.backgroundColor = config.primary_bg || defaultConfig.primary_bg;
          startPM.style.color = config.text_color || defaultConfig.text_color;
        });
        
        startPM.addEventListener('click', () => {
          startPM.classList.add('active-period');
          startAM.classList.remove('active-period');
          startPM.style.backgroundColor = config.primary_action || defaultConfig.primary_action;
          startPM.style.color = '#ffffff';
          startAM.style.backgroundColor = config.primary_bg || defaultConfig.primary_bg;
          startAM.style.color = config.text_color || defaultConfig.text_color;
        });
        
        endAM.addEventListener('click', () => {
          endAM.classList.add('active-period');
          endPM.classList.remove('active-period');
          endAM.style.backgroundColor = config.primary_action || defaultConfig.primary_action;
          endAM.style.color = '#ffffff';
          endPM.style.backgroundColor = config.primary_bg || defaultConfig.primary_bg;
          endPM.style.color = config.text_color || defaultConfig.text_color;
        });
        
        endPM.addEventListener('click', () => {
          endPM.classList.add('active-period');
          endAM.classList.remove('active-period');
          endPM.style.backgroundColor = config.primary_action || defaultConfig.primary_action;
          endPM.style.color = '#ffffff';
          endAM.style.backgroundColor = config.primary_bg || defaultConfig.primary_bg;
          endAM.style.color = config.text_color || defaultConfig.text_color;
        });
        
        // Add remove listener
        row.querySelector('.remove-schedule-row').addEventListener('click', () => {
          row.remove();
        });
      }

      // Load existing meetings or add one default row
      if (meetings.length > 0) {
        meetings.forEach(meeting => {
          createScheduleRow(meeting.dayOfWeek, meeting.startTime, meeting.endTime);
        });
      } else if (!noFixedSchedule) {
        createScheduleRow();
      }

      // Add row button
      addScheduleRowBtn.addEventListener('click', () => {
        createScheduleRow();
      });

      // Toggle schedule builder
      noFixedScheduleCheckbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          scheduleBuilder.style.display = 'none';
        } else {
          scheduleBuilder.style.display = 'block';
          // Add at least one row if none exist
          if (scheduleRowsContainer.children.length === 0) {
            createScheduleRow();
          }
        }
      });

      // Additional Teachers Dropdown Management
      const primaryTeacherSelect = document.getElementById('course-teacher');
      const additionalTeacherSelect = document.getElementById('additional-teacher-select');
      const selectedAdditionalTeachersContainer = document.getElementById('selected-additional-teachers');
      const selectedAdditionalTeachers = new Set(additionalTeacherIds);

      function updateAdditionalTeacherDropdown() {
        const primaryTeacherId = primaryTeacherSelect.value;
        additionalTeacherSelect.innerHTML = '<option value="">Select additional teacher...</option>';
        
        staffData.forEach(staff => {
          // Don't show primary teacher or already selected additional teachers
          if (staff.publicCode !== primaryTeacherId && !selectedAdditionalTeachers.has(staff.publicCode)) {
            const option = document.createElement('option');
            option.value = staff.publicCode;
            option.textContent = `${staff.fullName} (${staff.publicCode})`;
            additionalTeacherSelect.appendChild(option);
          }
        });
      }

      function renderSelectedAdditionalTeachers() {
        selectedAdditionalTeachersContainer.innerHTML = '';
        selectedAdditionalTeachers.forEach(teacherId => {
          const teacher = staffData.find(s => s.publicCode === teacherId);
          if (!teacher) return;

          const tag = document.createElement('span');
          tag.className = 'additional-teacher-tag';
          tag.dataset.teacherId = teacherId;
          tag.style.cssText = `display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; background-color: ${config.primary_bg || defaultConfig.primary_bg}; border: 1px solid ${config.border_color || defaultConfig.border_color}; border-radius: 6px; font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; color: ${config.text_color || defaultConfig.text_color};`;
          
          tag.innerHTML = `
            ${teacher.fullName}
            <button type="button" class="remove-additional-teacher" data-teacher-id="${teacherId}" style="background: none; border: none; color: #ef4444; cursor: pointer; padding: 0; font-size: 16px; line-height: 1;">Ã—</button>
          `;
          
          selectedAdditionalTeachersContainer.appendChild(tag);
        });

        // Attach remove listeners
        document.querySelectorAll('.remove-additional-teacher').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const teacherId = e.target.dataset.teacherId;
            selectedAdditionalTeachers.delete(teacherId);
            renderSelectedAdditionalTeachers();
            updateAdditionalTeacherDropdown();
          });
        });
      }

      // Update dropdown when primary teacher changes
      primaryTeacherSelect.addEventListener('change', () => {
        const oldPrimaryTeacherId = existingPrimaryTeacherId;
        const newPrimaryTeacherId = primaryTeacherSelect.value;
        
        // If the new primary teacher was in additional teachers, remove them
        if (selectedAdditionalTeachers.has(newPrimaryTeacherId)) {
          selectedAdditionalTeachers.delete(newPrimaryTeacherId);
          renderSelectedAdditionalTeachers();
        }
        
        updateAdditionalTeacherDropdown();
      });

      // Add teacher when selected from dropdown
      additionalTeacherSelect.addEventListener('change', (e) => {
        const teacherId = e.target.value;
        if (teacherId && !selectedAdditionalTeachers.has(teacherId)) {
          selectedAdditionalTeachers.add(teacherId);
          renderSelectedAdditionalTeachers();
          updateAdditionalTeacherDropdown();
          additionalTeacherSelect.value = '';
        }
      });

      // Initial render
      updateAdditionalTeacherDropdown();
      renderSelectedAdditionalTeachers();

      const form = document.getElementById('course-form');
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = isEditMode ? 'Updating...' : 'Adding...';

        const primaryTeacherId = document.getElementById('course-teacher').value;

        // Collect additional teachers from the Set
        const additionalTeacherIdsArray = Array.from(selectedAdditionalTeachers).filter(id => id !== primaryTeacherId);

        // Build meetings data
        let scheduleType, meetings;
        
        if (noFixedScheduleCheckbox.checked) {
          scheduleType = 'none';
          meetings = [];
        } else {
          // Validate and collect schedule rows
          const rows = scheduleRowsContainer.querySelectorAll('[id^="schedule-row-"]');
          
          if (rows.length === 0) {
            showToast('Please add at least one weekly session or check "No fixed schedule"');
            submitBtn.disabled = false;
            submitBtn.textContent = isEditMode ? 'Update Course' : 'Add Course';
            return;
          }

          meetings = [];
          let isValid = true;

          rows.forEach(row => {
            const dayOfWeek = parseInt(row.querySelector('.schedule-day').value);
            const startTime12 = row.querySelector('.schedule-start-time').value;
            const endTime12 = row.querySelector('.schedule-end-time').value;
            const startPeriod = row.querySelector('.schedule-start-am').classList.contains('active-period') ? 'AM' : 'PM';
            const endPeriod = row.querySelector('.schedule-end-am').classList.contains('active-period') ? 'AM' : 'PM';

            if (isNaN(dayOfWeek) || !startTime12 || !endTime12) {
              isValid = false;
              return;
            }

            // Validate time format (H:MM or HH:MM)
            const timePattern = /^([0-9]{1,2}):([0-5][0-9])$/;
            if (!timePattern.test(startTime12) || !timePattern.test(endTime12)) {
              isValid = false;
              return;
            }

            // Convert to 24-hour format
            const startTime = convertTo24Hour(startTime12, startPeriod);
            const endTime = convertTo24Hour(endTime12, endPeriod);

            if (startTime >= endTime) {
              isValid = false;
              return;
            }

            meetings.push({ dayOfWeek, startTime, endTime });
          });

          if (!isValid) {
            showToast('Please fill all schedule fields with valid times');
            submitBtn.disabled = false;
            submitBtn.textContent = isEditMode ? 'Update Course' : 'Add Course';
            return;
          }

          scheduleType = 'fixed';
        }

        const courseData = {
          publicCode: document.getElementById('course-public-code').value,
          name: document.getElementById('course-name').value,
          primaryTeacherId: primaryTeacherId,
          additionalTeacherIds: additionalTeacherIdsArray,
          startDate: document.getElementById('course-start-date').value,
          endDate: document.getElementById('course-end-date').value || null,
          status: document.getElementById('course-status').value,
          scheduleType,
          meetings
        };

        let result;
        if (isEditMode) {
          result = await updateCourse(existingCourse.id, courseData);
        } else {
          result = await createCourse(courseData);
        }
        
        submitBtn.disabled = false;
        submitBtn.textContent = isEditMode ? 'Update Course' : 'Add Course';
        
        if (result.success) {
          document.querySelector('.modal-backdrop').remove();
          showToast(isEditMode ? 'Course updated successfully' : 'Course added successfully');
        } else {
          showToast(isEditMode ? 'Failed to update course' : 'Failed to add course');
        }
      });

      document.getElementById('cancel-btn').addEventListener('click', () => {
        document.querySelector('.modal-backdrop').remove();
      });
    }

    function showDeleteConfirmation(courseId) {
      const config = window.elementSdk?.config || defaultConfig;
      const course = allData.find(item => item.id === courseId);
      
      if (!course) return;

      const content = `
        <div style="text-align: center; padding: 16px 0;">
          <div style="font-size: 48px; margin-bottom: 16px;">ðŸ—‘ï¸</div>
          <div style="font-size: ${(config.font_size || defaultConfig.font_size) * 1.15}px; font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 8px;">Delete Course?</div>
          <div style="font-size: ${config.font_size || defaultConfig.font_size}px; color: ${config.secondary_action || defaultConfig.secondary_action}; margin-bottom: 24px;">
            Are you sure you want to delete "${course.name}"? This action cannot be undone.
          </div>
          <div style="display: flex; gap: 12px;">
            <button id="cancel-delete-btn" class="btn-secondary" style="flex: 1; border-color: ${config.border_color || defaultConfig.border_color}; color: ${config.text_color || defaultConfig.text_color};">Cancel</button>
            <button id="confirm-delete-btn" class="btn-primary" style="flex: 1; background-color: #ef4444;">Delete Course</button>
          </div>
        </div>
      `;

      showModal('Confirm Deletion', content);

      document.getElementById('cancel-delete-btn').addEventListener('click', () => {
        document.querySelector('.modal-backdrop').remove();
      });

      document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
        const confirmBtn = document.getElementById('confirm-delete-btn');
        confirmBtn.disabled = true;
        confirmBtn.textContent = 'Deleting...';

        const result = await deleteCourse(courseId);

        if (result.success) {
          document.querySelector('.modal-backdrop').remove();
          showToast('Course deleted successfully');
        } else {
          confirmBtn.disabled = false;
          confirmBtn.textContent = 'Delete Course';
          showToast('Failed to delete course');
        }
      });
    }

    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.remove(), 3000);
    }

    // Use event delegation to handle dynamically created buttons
    function setupGlobalEventDelegation() {
      document.body.addEventListener('click', (e) => {
        // Handle Manage Students buttons
        if (e.target.classList.contains('manage-students-btn')) {
          e.preventDefault();
          e.stopPropagation();
          const courseId = e.target.dataset.courseId;
          const course = allData.find(c => c.id === courseId);
          if (course) {
            setCourseContext(course);
            openCourseModal(MODAL_ENROLLMENT_COURSES);
          }
        }

        // Handle Manage Attendance buttons
        if (e.target.classList.contains('manage-attendance-btn')) {
          e.preventDefault();
          e.stopPropagation();
          const courseId = e.target.dataset.courseId;
          const course = allData.find(c => c.id === courseId);
          if (course) {
            setCourseContext(course);
            openCourseModal(MODAL_ATTENDANCE_COURSES);
          }
        }

        // Handle Manage Performance buttons
        if (e.target.classList.contains('manage-performance-btn')) {
          e.preventDefault();
          e.stopPropagation();
          const courseId = e.target.dataset.courseId;
          const course = allData.find(c => c.id === courseId);
          if (course) {
            setCourseContext(course);
            openCourseModal(MODAL_PERFORMANCE_COURSES);
          }
        }

        // Handle Edit/Delete buttons
        if (e.target.classList.contains('text-action-btn')) {
          const action = e.target.dataset.action;
          const courseId = e.target.dataset.course;
          
          if (action === 'edit') {
            // Load full course data including meetings and staff
            loadCourseDataForEdit(courseId).then(courseData => {
              if (courseData) {
                showAddCourseModal(courseData);
              } else {
                showToast('Failed to load course data');
              }
            });
          } else if (action === 'delete') {
            showDeleteConfirmation(courseId);
          }
        }
      });
    }

    let searchDebounceTimer = null;

    function filterAndUpdateTable(searchValue) {
      const tbody = document.querySelector('tbody');
      if (!tbody) return;

      // Get current tab courses
      let displayCourses = [];
      if (teacherCourseTab === 'inprogress') displayCourses = allData.filter(c => c.status === 'active');
      else if (teacherCourseTab === 'upcoming') displayCourses = allData.filter(c => c.status === 'draft');
      else displayCourses = allData.filter(c => c.status === 'archived');

      // Apply search filter
      if (searchValue) {
        displayCourses = displayCourses.filter(c => 
          c.name.toLowerCase().includes(searchValue.toLowerCase()) ||
          c.publicCode.toLowerCase().includes(searchValue.toLowerCase())
        );
      }

      // Apply sorting
      displayCourses.sort((a, b) => {
        let comparison = 0;
        
        if (teacherSortBy === 'courseCode') {
          comparison = (a.publicCode || '').localeCompare(b.publicCode || '');
        } else if (teacherSortBy === 'courseName') {
          comparison = (a.name || '').localeCompare(b.name || '');
        } else if (teacherSortBy === 'teacher') {
          comparison = (a.primaryTeacherName || '').localeCompare(b.primaryTeacherName || '');
        } else if (teacherSortBy === 'startDate') {
          const dateA = a.startDate ? new Date(a.startDate).getTime() : 0;
          const dateB = b.startDate ? new Date(b.startDate).getTime() : 0;
          comparison = dateA - dateB;
        } else if (teacherSortBy === 'studentCount') {
          const countA = a.studentCount || 0;
          const countB = b.studentCount || 0;
          comparison = countA - countB;
        } else if (teacherSortBy === 'sessionCount') {
          const countA = a.sessionCount || 0;
          const countB = b.sessionCount || 0;
          comparison = countA - countB;
        } else if (teacherSortBy === 'assessmentCount') {
          const countA = a.assessmentCount || 0;
          const countB = b.assessmentCount || 0;
          comparison = countA - countB;
        }
        
        // Apply sort direction
        return teacherSortDirection === 'desc' ? -comparison : comparison;
      });

      // Update table rows without recreating the entire table
      const existingRows = tbody.querySelectorAll('tr');
      const config = window.elementSdk?.config || defaultConfig;

      // If no results, show empty state or update rows
      if (displayCourses.length === 0) {
        // Trigger full re-render for empty state
        renderApp();
        return;
      }

      // Update existing rows or add new ones
      displayCourses.forEach((course, index) => {
        const studentCount = course.studentCount !== undefined ? course.studentCount : 0;
        const sessionCount = course.sessionCount !== undefined ? course.sessionCount : 0;
        const assessmentCount = course.assessmentCount !== undefined ? course.assessmentCount : 0;
        
        const primaryTeacher = course.primaryTeacherName || 'Not assigned';
        const additionalTeachers = course.additionalTeacherNames || [];
        
        let teacherDisplay = `<div style="font-weight: 500; color: ${config.text_color || defaultConfig.text_color};">${primaryTeacher}</div>`;
        if (additionalTeachers.length > 0) {
          additionalTeachers.forEach(name => {
            teacherDisplay += `<div style="font-weight: 500; color: ${config.text_color || defaultConfig.text_color}; margin-top: 2px;">${name}</div>`;
          });
        }
        
        const scheduleText = course.scheduleText || 'Not set';
        let periodText = '';
        if (course.firstSessionDate && course.lastSessionDate) {
          const formatDateStr = (dateStr) => {
            const parts = dateStr.split('-');
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
          };
          const firstDateStr = formatDateStr(course.firstSessionDate);
          const lastDateStr = formatDateStr(course.lastSessionDate);
          periodText = `Period: ${firstDateStr} - ${lastDateStr}`;
        }
        
        const courseStartDate = course.startDate ? new Date(course.startDate) : null;
        const startDateText = courseStartDate ? `Start: ${courseStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}` : '';
        
        const rowHTML = `
          <td style="padding: 12px 16px;">
            <div style="font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 2px;">${course.publicCode}</div>
            <div style="font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; color: ${config.secondary_action || defaultConfig.secondary_action};">${course.name}</div>
          </td>
          <td style="padding: 12px 16px;">
            <div style="color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 2px;">${teacherDisplay}</div>
            <div style="font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; color: ${config.secondary_action || defaultConfig.secondary_action}; margin-top: 6px;">${scheduleText}</div>
            ${startDateText ? `<div style="font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px; color: ${config.secondary_action || defaultConfig.secondary_action}; margin-top: 2px;">${startDateText}</div>` : ''}
          </td>
          <td style="padding: 12px 16px;">
            <div style="font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 4px;">${studentCount} students</div>
            <button class="link-btn manage-students-btn" data-course-id="${course.id}" style="background: none; border: none; color: ${config.primary_action || defaultConfig.primary_action}; font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; cursor: pointer; padding: 0; text-decoration: underline;">Manage Students</button>
          </td>
          <td style="padding: 12px 16px;">
            <div style="font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 4px;">${sessionCount} sessions</div>
            <button class="link-btn manage-attendance-btn" data-course-id="${course.id}" style="background: none; border: none; color: ${config.primary_action || defaultConfig.primary_action}; font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; cursor: pointer; padding: 0; text-decoration: underline; margin-bottom: 4px;">Manage Attendance</button>
            ${periodText ? `<div style="font-size: ${(config.font_size || defaultConfig.font_size) * 0.85}px; color: ${config.secondary_action || defaultConfig.secondary_action}; margin-top: 4px;">${periodText}</div>` : ''}
          </td>
          <td style="padding: 12px 16px;">
            <div style="font-weight: 600; color: ${config.text_color || defaultConfig.text_color}; margin-bottom: 4px;">${assessmentCount} assessments</div>
            <button class="link-btn manage-performance-btn" data-course-id="${course.id}" style="background: none; border: none; color: ${config.primary_action || defaultConfig.primary_action}; font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; cursor: pointer; padding: 0; text-decoration: underline;">Manage Performance</button>
          </td>
          <td style="padding: 12px 16px; text-align: right;">
            <button class="text-action-btn" data-action="edit" data-course="${course.id}" style="background: none; border: none; color: ${config.primary_action || defaultConfig.primary_action}; font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; cursor: pointer; padding: 4px 8px;">Edit</button>
            <span style="color: ${config.border_color || defaultConfig.border_color};">|</span>
            <button class="text-action-btn" data-action="delete" data-course="${course.id}" style="background: none; border: none; color: #ef4444; font-size: ${(config.font_size || defaultConfig.font_size) * 0.92}px; cursor: pointer; padding: 4px 8px;">Delete</button>
          </td>
        `;

        if (existingRows[index]) {
          existingRows[index].innerHTML = rowHTML;
          existingRows[index].style.borderBottomColor = config.border_color || defaultConfig.border_color;
        } else {
          const newRow = document.createElement('tr');
          newRow.innerHTML = rowHTML;
          newRow.style.borderBottomColor = config.border_color || defaultConfig.border_color;
          tbody.appendChild(newRow);
        }
      });

      // Remove extra rows if needed
      for (let i = displayCourses.length; i < existingRows.length; i++) {
        existingRows[i].remove();
      }
    }

    function attachEventListeners() {
      const courseTabBtns = document.querySelectorAll('.course-tab-btn');
      courseTabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          teacherCourseTab = btn.dataset.tab;
          renderApp();
        });
      });
      
      const teacherSearchInput = document.getElementById('teacher-search-input');
      if (teacherSearchInput) {
        teacherSearchInput.addEventListener('input', (e) => {
          const searchValue = e.target.value;
          teacherSearchQuery = searchValue;
          
          // Clear existing timer
          if (searchDebounceTimer) {
            clearTimeout(searchDebounceTimer);
          }
          
          // Filter and update table immediately without full re-render
          filterAndUpdateTable(searchValue);
        });
      }
      
      const teacherSortSelect = document.getElementById('teacher-sort-select');
      if (teacherSortSelect) {
        teacherSortSelect.addEventListener('change', (e) => {
          teacherSortBy = e.target.value;
          renderApp();
        });
      }
      
      const sortDirectionBtn = document.getElementById('sort-direction-btn');
      if (sortDirectionBtn) {
        sortDirectionBtn.addEventListener('click', () => {
          teacherSortDirection = teacherSortDirection === 'asc' ? 'desc' : 'asc';
          renderApp();
        });
      }
      
      const teacherAddCourseBtn = document.getElementById('teacher-add-course-btn');
      if (teacherAddCourseBtn) {
        teacherAddCourseBtn.addEventListener('click', () => showAddCourseModal());
      }
    }

    async function init() {
      // Setup global event delegation once
      setupGlobalEventDelegation();

      // Setup Firestore listeners
      setupStaffListener();
      setupFirestoreListener();

      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.primary_bg || defaultConfig.primary_bg,
                set: (value) => {
                  config.primary_bg = value;
                  window.elementSdk.setConfig({ primary_bg: value });
                }
              },
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  config.surface_color = value;
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.primary_action || defaultConfig.primary_action,
                set: (value) => {
                  config.primary_action = value;
                  window.elementSdk.setConfig({ primary_action: value });
                }
              },
              {
                get: () => config.secondary_action || defaultConfig.secondary_action,
                set: (value) => {
                  config.secondary_action = value;
                  window.elementSdk.setConfig({ secondary_action: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ['module_title', config.module_title || defaultConfig.module_title],
            ['page_subtitle', config.page_subtitle || defaultConfig.page_subtitle]
          ])
        });
      }

      renderApp();
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9beb488dc47ddd39',t:'MTc2ODU0MjA4Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>