<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Classes - Read Only</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    
    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: 11px;
      font-weight: 500;
      text-transform: capitalize;
    }
    
    .status-active {
      background: rgba(34, 197, 94, 0.15);
      color: #16a34a;
    }
    
    .status-inactive {
      background: rgba(234, 179, 8, 0.15);
      color: #ca8a04;
    }
    
    .status-archived {
      background: rgba(107, 114, 128, 0.15);
      color: #6b7280;
    }
    
    .status-finished {
      background: rgba(59, 130, 246, 0.15);
      color: #2563eb;
    }
    
    .status-dropped {
      background: rgba(239, 68, 68, 0.15);
      color: #dc2626;
    }
    
    .student-muted {
      opacity: 0.55;
    }
    
    .table-row {
      transition: background-color 0.15s ease;
    }
    
    .table-row:hover {
      background-color: rgba(219, 234, 254, 0.5);
    }
    
    .expand-btn {
      transition: all 0.15s ease;
    }
    
    .expand-btn:hover {
      background-color: rgba(99, 102, 241, 0.1);
    }
    
    .student-panel {
      max-height: 350px;
      overflow-y: auto;
    }
    
    .student-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      padding: 8px 10px;
      transition: all 0.15s ease;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    
    .student-card:hover {
      background: #fafafa;
      border-color: #d1d5db;
    }
    
    .student-info {
      flex: 1;
      min-width: 0;
    }
    
    .student-status {
      flex-shrink: 0;
    }
    
    .read-only-badge {
      background: rgba(107, 114, 128, 0.12);
      color: #6b7280;
      padding: 3px 10px;
      border-radius: 9999px;
      font-size: 11px;
      font-weight: 500;
    }
    
    input, select {
      font-size: 13px;
    }
    
    .compact-input {
      padding: 6px 10px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.8);
      transition: all 0.15s ease;
    }
    
    .compact-input:focus {
      outline: none;
      border-color: rgba(99, 102, 241, 0.5);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    .table-header {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #6b7280;
    }
    
    .table-cell {
      font-size: 13px;
      padding: 10px 12px;
    }
    
    .expanded-row {
      background: #fafafa;
    }
    
    .student-panel-container {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 16px;
    }
    
    .student-panel-title {
      font-size: 14px;
      font-weight: 600;
      color: #111827;
      margin-bottom: 12px;
    }
    
    .chevron-icon {
      transition: transform 0.2s ease;
    }
    
    .chevron-icon.expanded {
      transform: rotate(180deg);
    }
    
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }
    
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    
    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.15);
      border-radius: 3px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.25);
    }
    
    .table-container {
      width: 100%;
      overflow-x: auto;
    }
    
    table {
      min-width: 100%;
      table-layout: auto;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-transparent">
  <div id="app" class="h-full flex flex-col p-4"><!-- Header -->
   <div class="flex items-center justify-between mb-4">
    <h1 id="page-title" class="text-xl font-semibold text-gray-800">Classes</h1><span class="read-only-badge">Read only</span>
   </div><!-- Search & Filters -->
   <div class="flex flex-wrap gap-2 mb-4"><input type="text" id="search-input" placeholder="Search by class name, program type, or code…" class="compact-input flex-1 min-w-[200px]"> <select id="status-filter" class="compact-input"> <option value="">All Status</option> <option value="active">Active</option> <option value="inactive">Inactive</option> <option value="archived">Archived</option> </select> <select id="year-filter" class="compact-input"> <option value="">All Years</option> </select> <select id="sort-select" class="compact-input"> <option value="name-asc">Name (A–Z)</option> <option value="name-desc">Name (Z–A)</option> <option value="year-desc">Year (Newest)</option> <option value="year-asc">Year (Oldest)</option> <option value="students-desc">Students (Most)</option> <option value="students-asc">Students (Least)</option> </select>
   </div><!-- Table Container -->
   <div class="flex-1 table-container rounded-lg border border-gray-200 bg-white">
    <table class="w-full">
     <thead class="sticky top-0 bg-gray-50 border-b border-gray-200">
      <tr>
       <th class="table-header table-cell text-left">Class Name</th>
       <th class="table-header table-cell text-left">Program Type</th>
       <th class="table-header table-cell text-left">Academic Year</th>
       <th class="table-header table-cell text-left">Management Code</th>
       <th class="table-header table-cell text-center">Students</th>
       <th class="table-header table-cell text-center">Student List</th>
       <th class="table-header table-cell text-center">Status</th>
      </tr>
     </thead>
     <tbody id="classes-table-body">
      <tr>
       <td colspan="7" class="table-cell text-center text-gray-500 py-8">
        <div class="flex items-center justify-center gap-2">
         <svg class="animate-spin h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewbox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle> <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
         </svg> Loading classes…
        </div></td>
      </tr>
     </tbody>
    </table>
   </div><!-- Error Message -->
   <div id="error-message" class="hidden mt-4 p-3 rounded-lg bg-red-50 border border-red-200 text-red-700 text-sm"></div>
  </div><!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { 
      getFirestore, 
      collection, 
      query, 
      where, 
      orderBy, 
      onSnapshot 
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCDzv0HseeLfijzyXZjKWFh9QaLrMB4afo",
      authDomain: "tnl2026.firebaseapp.com",
      projectId: "tnl2026",
      storageBucket: "tnl2026.firebasestorage.app",
      messagingSenderId: "883525152224",
      appId: "1:883525152224:web:619ae152cd8df3fcca8f85",
      measurementId: "G-3K6LXCKHZ9"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // State
    let classes = [];
    let students = [];
    let expandedClassId = null;
    let isLoading = true;

    // DOM Elements
    const searchInput = document.getElementById('search-input');
    const statusFilter = document.getElementById('status-filter');
    const yearFilter = document.getElementById('year-filter');
    const sortSelect = document.getElementById('sort-select');
    const tableBody = document.getElementById('classes-table-body');
    const errorMessage = document.getElementById('error-message');
    const pageTitle = document.getElementById('page-title');

    // Element SDK Config
    const defaultConfig = {
      page_title: 'Classes'
    };

    let config = { ...defaultConfig };

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          pageTitle.textContent = config.page_title || defaultConfig.page_title;
        },
        mapToCapabilities: () => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['page_title', cfg.page_title || defaultConfig.page_title]
        ])
      });
    }

    // Show error message
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.classList.remove('hidden');
    }

    // Hide error message
    function hideError() {
      errorMessage.classList.add('hidden');
    }

    // Get status class
    function getStatusClass(status) {
      const s = (status || '').toLowerCase();
      if (s === 'active') return 'status-active';
      if (s === 'inactive') return 'status-inactive';
      if (s === 'archived') return 'status-archived';
      if (s === 'finished') return 'status-finished';
      if (s === 'dropped') return 'status-dropped';
      return 'status-inactive';
    }

    // Check if student should be muted
    function isStudentMuted(status) {
      const s = (status || '').toLowerCase();
      return s === 'inactive' || s === 'dropped';
    }

    // Get student count for a class
    function getStudentCount(classId) {
      return students.filter(s => s.classId === classId).length;
    }

    // Get students for a class
    function getClassStudents(classId) {
      return students.filter(s => s.classId === classId);
    }

    // Filter and sort classes
    function getFilteredClasses() {
      const searchTerm = searchInput.value.toLowerCase().trim();
      const statusValue = statusFilter.value.toLowerCase();
      const yearValue = yearFilter.value;
      const sortValue = sortSelect.value;

      let filtered = classes.filter(c => {
        // Search filter
        if (searchTerm) {
          const name = (c.name || '').toLowerCase();
          const program = (c.programType || '').toLowerCase();
          const code = (c.managementCode || '').toLowerCase();
          if (!name.includes(searchTerm) && !program.includes(searchTerm) && !code.includes(searchTerm)) {
            return false;
          }
        }

        // Status filter
        if (statusValue && (c.status || '').toLowerCase() !== statusValue) {
          return false;
        }

        // Year filter
        if (yearValue && c.academicYear !== parseInt(yearValue)) {
          return false;
        }

        return true;
      });

      // Sort
      filtered.sort((a, b) => {
        switch (sortValue) {
          case 'name-asc':
            return (a.name || '').localeCompare(b.name || '');
          case 'name-desc':
            return (b.name || '').localeCompare(a.name || '');
          case 'year-desc':
            return (b.academicYear || 0) - (a.academicYear || 0);
          case 'year-asc':
            return (a.academicYear || 0) - (b.academicYear || 0);
          case 'students-desc':
            return getStudentCount(b.id) - getStudentCount(a.id);
          case 'students-asc':
            return getStudentCount(a.id) - getStudentCount(b.id);
          default:
            return 0;
        }
      });

      return filtered;
    }

    // Update year filter options
    function updateYearFilter() {
      const years = [...new Set(classes.map(c => c.academicYear).filter(y => y))].sort((a, b) => b - a);
      const currentValue = yearFilter.value;
      
      yearFilter.innerHTML = '<option value="">All Years</option>';
      years.forEach(year => {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year;
        yearFilter.appendChild(option);
      });
      
      yearFilter.value = currentValue;
    }

    // Render expanded student panel
    function renderStudentPanel(classItem) {
      const classStudents = getClassStudents(classItem.id);
      
      let studentsHtml = '';
      if (classStudents.length === 0) {
        studentsHtml = '<p class="text-gray-500 text-sm col-span-full">No students enrolled in this class.</p>';
      } else {
        classStudents.forEach(student => {
          const muted = isStudentMuted(student.status) ? 'student-muted' : '';
          const statusClass = getStatusClass(student.status);
          studentsHtml += `
            <div class="student-card ${muted}">
              <div class="student-info">
                <div class="font-semibold text-gray-800 text-sm">${student.publicCode || 'N/A'}</div>
                <div class="text-gray-500 text-xs mt-0.5">${student.fullName || 'Unknown'}</div>
              </div>
              <div class="student-status">
                <span class="status-pill ${statusClass}">${student.status || 'unknown'}</span>
              </div>
            </div>
          `;
        });
      }

      return `
        <tr class="expanded-row" data-expanded-for="${classItem.id}">
          <td colspan="7" class="px-4 py-4">
            <div class="student-panel-container">
              <div class="student-panel-title">
                Students in ${classItem.name} <span class="text-gray-500 font-normal">(${classStudents.length})</span>
              </div>
              <div class="student-panel">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                  ${studentsHtml}
                </div>
              </div>
            </div>
          </td>
        </tr>
      `;
    }

    // Render table
    function renderTable() {
      const filtered = getFilteredClasses();

      if (isLoading) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="7" class="table-cell text-center text-gray-500 py-8">
              <div class="flex items-center justify-center gap-2">
                <svg class="animate-spin h-4 w-4 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Loading classes…
              </div>
            </td>
          </tr>
        `;
        return;
      }

      if (filtered.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="7" class="table-cell text-center text-gray-500 py-8">
              <svg class="w-8 h-8 mx-auto mb-2 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              No classes found
            </td>
          </tr>
        `;
        return;
      }

      let html = '';
      filtered.forEach(classItem => {
        const studentCount = getStudentCount(classItem.id);
        const statusClass = getStatusClass(classItem.status);
        const isExpanded = expandedClassId === classItem.id;
        const chevronClass = isExpanded ? 'expanded' : '';

        html += `
          <tr class="table-row border-b border-gray-100" data-class-id="${classItem.id}">
            <td class="table-cell font-medium text-gray-900">${classItem.name || '—'}</td>
            <td class="table-cell text-gray-600">${classItem.programType || '—'}</td>
            <td class="table-cell text-gray-600">${classItem.academicYear || '—'}</td>
            <td class="table-cell text-gray-600 font-mono text-xs">${classItem.managementCode || '—'}</td>
            <td class="table-cell text-center">
              <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-indigo-50 text-indigo-600 text-xs font-medium">
                ${studentCount}
              </span>
            </td>
            <td class="table-cell text-center">
              <button 
                class="expand-btn inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium text-indigo-600 hover:text-indigo-700"
                data-toggle-class="${classItem.id}"
              >
                View List (${studentCount})
                <svg class="w-3.5 h-3.5 chevron-icon ${chevronClass}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </button>
            </td>
            <td class="table-cell text-center">
              <span class="status-pill ${statusClass}">${classItem.status || 'unknown'}</span>
            </td>
          </tr>
        `;

        if (isExpanded) {
          html += renderStudentPanel(classItem);
        }
      });

      tableBody.innerHTML = html;

      // Add click handlers for expand buttons
      tableBody.querySelectorAll('[data-toggle-class]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const classId = e.currentTarget.dataset.toggleClass;
          if (expandedClassId === classId) {
            expandedClassId = null;
          } else {
            expandedClassId = classId;
          }
          renderTable();
        });
      });
    }

    // Set up Firestore listeners
    function setupListeners() {
      // Classes listener
      const classesQuery = query(
        collection(db, 'classes'),
        orderBy('academicYear', 'desc'),
        orderBy('name', 'asc')
      );

      onSnapshot(classesQuery, (snapshot) => {
        classes = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        isLoading = false;
        hideError();
        updateYearFilter();
        renderTable();
      }, (error) => {
        console.error('Classes listener error:', error);
        isLoading = false;
        if (error.code === 'permission-denied') {
          showError('Permission denied. Check Firestore rules.');
        } else {
          showError(`Error loading classes: ${error.message}`);
        }
        renderTable();
      });

      // Students listener
      const studentsQuery = query(
        collection(db, 'students'),
        where('isDeleted', '==', false)
      );

      onSnapshot(studentsQuery, (snapshot) => {
        students = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        renderTable();
      }, (error) => {
        console.error('Students listener error:', error);
        if (error.code === 'permission-denied') {
          showError('Permission denied. Check Firestore rules for students collection.');
        }
      });
    }

    // Event listeners for filters
    searchInput.addEventListener('input', renderTable);
    statusFilter.addEventListener('change', renderTable);
    yearFilter.addEventListener('change', renderTable);
    sortSelect.addEventListener('change', renderTable);

    // Initialize
    setupListeners();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bedc74ae429a880',t:'MTc2ODU2ODI0NS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>