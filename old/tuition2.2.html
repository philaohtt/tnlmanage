<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuition Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center">
                    <div class="bg-green-100 p-3 rounded-lg mr-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-semibold text-gray-900 mb-1 flex items-center">
                            <span class="mr-2">ðŸ’°</span> Tuition Management System
                        </h1>
                        <p class="text-gray-600">Comprehensive tuition tracking and payment management</p>
                    </div>
                </div>
                <!-- Sync Status and Refresh -->
                <div class="flex items-center space-x-3">
                    <button onclick="refreshAllData()" class="flex items-center px-3 py-2 text-xs text-gray-600 hover:text-gray-800 border border-gray-300 rounded-lg hover:bg-gray-50" title="Refresh all data">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                    <div id="syncIndicator" class="flex items-center px-3 py-2 rounded-lg text-xs border">
                        <div id="syncIcon" class="w-2 h-2 rounded-full mr-2 bg-green-500"></div>
                        <span id="syncText">Connected</span>
                    </div>
                </div>


            </div>
        </div>

        <!-- Main Navigation Tabs -->
        <div class="bg-white rounded-lg shadow-sm border mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6">
                    <button onclick="switchTab('calculator')" id="calculatorTab" class="py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                        Tuition Calculator
                    </button>
                    <button onclick="switchTab('student')" id="studentTab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                        Student Tuition
                    </button>
                    <button onclick="switchTab('payment')" id="paymentTab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                        Payment Tracker
                    </button>
                </nav>
            </div>

            <!-- Tuition Calculator Tab -->
            <div id="calculatorContent" class="p-6">
                <!-- Calculator Sub-tabs -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-6">
                        <button onclick="switchCalculatorTab('planner')" id="plannerSubTab" class="py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                            Course Planner
                        </button>
                        <button onclick="switchCalculatorTab('monthly')" id="monthlySubTab" class="py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                            Monthly Tuition Calculation
                        </button>
                        <button onclick="switchCalculatorTab('extraFees')" id="extraFeesSubTab" class="py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                            Extra Fees Management
                        </button>
                    </nav>
                </div>

                <!-- Course Planner -->
                <div id="plannerContent">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Input Form -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold mb-4">Create Course Plan</h3>
                            <form id="coursePlanForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Plan Code *</label>
                                    <input type="text" id="planCode" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Plan Name *</label>
                                    <input type="text" id="planName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Number of Courses</label>
                                    <input type="number" id="numCourses" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Number of Lessons</label>
                                    <input type="number" id="numLessons" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Number of Hours</label>
                                    <input type="number" id="numHours" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Standard Fee</label>
                                    <div class="relative">
                                        <input type="number" id="standardFee" step="0.001" class="w-full px-3 py-2 pr-12 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <span class="absolute right-3 top-2 text-gray-500 text-sm">.000</span>
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                                    Add Course Plan
                                </button>
                            </form>
                        </div>

                        <!-- Course Plans List -->
                        <div class="bg-white border rounded-lg p-6">
                            <h3 class="text-lg font-semibold mb-4">Course Plans</h3>
                            
                            <!-- Active Plans Section -->
                            <div class="mb-6">
                                <button onclick="toggleSection('activePlans')" class="flex items-center justify-between w-full p-3 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors">
                                    <span class="font-medium text-green-800">Active Plans</span>
                                    <svg id="activePlansIcon" class="w-5 h-5 text-green-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div id="activePlansContent" class="mt-3 space-y-3">
                                    <!-- Active plans will be loaded here -->
                                </div>
                            </div>

                            <!-- Archived Plans Section -->
                            <div>
                                <button onclick="toggleSection('archivedPlans')" class="flex items-center justify-between w-full p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors">
                                    <span class="font-medium text-gray-700">Archived Plans</span>
                                    <svg id="archivedPlansIcon" class="w-5 h-5 text-gray-600 transform transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div id="archivedPlansContent" class="mt-3 space-y-3 hidden">
                                    <!-- Archived plans will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Tuition Calculation -->
                <div id="monthlyContent" class="hidden">
                    <!-- Filters -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
                        <div class="flex items-center mb-4">
                            <div class="bg-blue-100 p-2 rounded-lg mr-3">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-blue-900">Select Month and Year to Get Started</h3>
                                <p class="text-sm text-blue-700">Choose specific month and year to load student data and calculate tuition fees</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-blue-800 mb-1">Month *</label>
                                <select id="monthFilter" class="w-full px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" onchange="checkFiltersAndLoadStudents()">
                                    <option value="">Select Month</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-blue-800 mb-1">Year *</label>
                                <select id="yearFilter" class="w-full px-3 py-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 bg-white" onchange="checkFiltersAndLoadStudents()">
                                    <option value="">Select Year</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Class</label>
                                <select id="classFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadStudentsWithFilters()">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Class Status</label>
                                <select id="classStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadStudentsWithFilters()">
                                    <option value="">All Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Student Status</label>
                                <select id="studentStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadStudentsWithFilters()">
                                    <option value="">All Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Finished">Finished</option>
                                    <option value="Dropped">Dropped</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Load Button -->
                        <div class="mt-4 flex justify-center">
                            <button id="loadStudentsBtn" onclick="loadStudentsWithFilters()" disabled class="px-6 py-2 bg-gray-400 text-white rounded-md text-sm opacity-50 cursor-not-allowed">
                                Select Month and Year First
                            </button>
                        </div>
                    </div>

                    <!-- Loading Indicator -->
                    <div id="monthlyLoadingIndicator" class="hidden bg-white border rounded-lg p-8 mb-6">
                        <div class="flex items-center justify-center">
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mr-3"></div>
                            <span class="text-gray-600">Loading student data...</span>
                        </div>
                    </div>

                    <!-- Getting Started Message -->
                    <div id="monthlyGettingStarted" class="bg-white border rounded-lg p-12 text-center">
                        <div class="max-w-md mx-auto">
                            <div class="bg-gray-100 p-4 rounded-full w-16 h-16 mx-auto mb-4 flex items-center justify-center">
                                <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <h3 class="text-lg font-medium text-gray-900 mb-2">Choose Month and Year to Get Started</h3>
                            <p class="text-gray-500 mb-4">Select a specific month and year from the filters above to load student attendance data and calculate tuition fees.</p>
                            <div class="text-sm text-gray-400">
                                <p>ðŸ’¡ Tip: Start with the current month for the most recent data</p>
                            </div>
                        </div>
                    </div>

                    <!-- Students Table -->
                    <div id="monthlyStudentsTable" class="bg-white border rounded-lg overflow-hidden hidden">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <div class="flex justify-between items-center">
                                <h3 class="text-lg font-semibold text-gray-900">Student Tuition Calculation</h3>
                                <div class="text-sm text-gray-500">
                                    <span id="studentsCount">0 students</span> â€¢ 
                                    <span id="selectedPeriod">No period selected</span>
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Info</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monthly Actual</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course Planner</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Calculated Fee</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adjusted Fee</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Students will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Extra Fees Management -->
                <div id="extraFeesContent" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <!-- Fee Types Management -->
                        <div class="bg-gray-50 rounded-lg">
                            <button onclick="toggleFeeSection('feeTypeManagement')" class="w-full flex items-center justify-between p-4 hover:bg-gray-100 transition-colors rounded-lg">
                                <h3 class="text-lg font-semibold text-gray-900">Fee Types Management</h3>
                                <svg id="feeTypeManagementIcon" class="w-5 h-5 text-gray-600 transform transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="feeTypeManagementContent" class="hidden p-6 pt-0">
                                <form id="feeTypeForm" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Fee Type Name *</label>
                                        <input type="text" id="feeTypeName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Default Amount</label>
                                        <div class="relative">
                                            <input type="number" id="feeTypeAmount" step="0.001" class="w-full px-3 py-2 pr-12 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                            <span class="absolute right-3 top-2 text-gray-500 text-sm">.000</span>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                        <textarea id="feeTypeDescription" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                                    </div>
                                    <div class="flex items-center">
                                        <input type="checkbox" id="feeTypeActive" checked class="rounded mr-2">
                                        <label class="text-sm text-gray-700">Active</label>
                                    </div>
                                    <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                                        <span id="feeTypeSubmitText">Add Fee Type</span>
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Fee Types List -->
                        <div class="bg-white border rounded-lg">
                            <button onclick="toggleFeeSection('feeTypesList')" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 transition-colors rounded-lg">
                                <h3 class="text-lg font-semibold text-gray-900">Fee Types</h3>
                                <svg id="feeTypesListIcon" class="w-5 h-5 text-gray-600 transform transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div id="feeTypesListContent" class="hidden p-6 pt-0">
                                <div id="feeTypesList" class="space-y-3">
                                    <!-- Fee types will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Student Extra Fees Assignment -->
                    <div class="bg-white border rounded-lg">
                        <div class="p-6 border-b border-gray-200">
                            <h3 class="text-lg font-semibold mb-4">Assign Extra Fees to Students</h3>
                            
                            <!-- Filters -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Search Students</label>
                                    <input type="text" id="extraFeeStudentSearch" placeholder="Search by name or ID..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="filterExtraFeeStudents()">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Class</label>
                                    <select id="extraFeeClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterExtraFeeStudents()">
                                        <option value="">All Classes</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                                    <select id="extraFeeYearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterExtraFeeStudents()">
                                        <option value="2023">2023</option>
                                        <option value="2024">2024</option>
                                        <option value="2025">2025</option>
                                        <option value="2026">2026</option>
                                        <option value="2027">2027</option>
                                        <option value="2028">2028</option>
                                        <option value="2029">2029</option>
                                        <option value="2030">2030</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Students Table -->
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Info</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Current Extra Fees</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assign New Fee</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="extraFeeStudentsTable" class="bg-white divide-y divide-gray-200">
                                    <!-- Students will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


            </div>

            <!-- Student Tuition Tab -->
            <div id="studentContent" class="p-6 hidden">
                <h2 class="text-xl font-semibold mb-6">Student Tuition Management</h2>
                
                <!-- Search, Filter, Sort Bar -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Student Tuition Overview</h3>
                        <button onclick="toggleEditMode()" id="editModeBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                            Enable Edit Mode
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                            <input type="text" id="studentSearch" placeholder="Search by name or ID..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="filterStudentTuition()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                            <select id="tuitionYearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterStudentTuition()">
                                <option value="">All Years</option>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Class</label>
                            <select id="tuitionClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterStudentTuition()">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="tuitionStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterStudentTuition()">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Finished">Finished</option>
                                <option value="Dropped">Dropped</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                            <select id="tuitionSortBy" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterStudentTuition()">
                                <option value="name">Name</option>
                                <option value="studentId">Student ID</option>
                                <option value="class">Class</option>
                                <option value="enrollmentYear">Enrollment Year</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Student Tuition Table -->
                <div class="bg-white border rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Info</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Jan</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Feb</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Mar</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Apr</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">May</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Jun</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Jul</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aug</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Sep</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Oct</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Nov</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Dec</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Summary</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentTuitionTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Student tuition data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>


            </div>

            <!-- Payment Tracker Tab -->
            <div id="paymentContent" class="p-6 hidden">
                <h2 class="text-xl font-semibold mb-6">Payment Tracking</h2>
                
                <!-- Record Payment Collapsible Section -->
                <div class="bg-white border rounded-lg mb-6">
                    <button onclick="togglePaymentRecorder()" class="w-full flex items-center justify-between p-4 hover:bg-gray-50 transition-colors">
                        <div class="flex items-center">
                            <svg id="paymentRecorderIcon" class="w-5 h-5 text-gray-600 mr-3 transform transition-transform rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                            <h3 class="text-lg font-semibold text-gray-900">Record Payment(s)</h3>
                        </div>
                        <span class="text-sm text-gray-500">Click to expand</span>
                    </button>
                    
                    <div id="paymentRecorderContent" class="hidden border-t">
                        <div class="p-6">
                            <!-- Payment Records Table -->
                            <div class="overflow-x-auto mb-4" style="max-height: 600px; overflow-y: auto;">
                                <table class="min-w-full">
                                    <thead class="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Payment Date</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Student</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tuition Year</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tuition Month</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Outstanding</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Amount Paid</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Payment Status</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="paymentRecordsTable" class="divide-y divide-gray-200">
                                        <!-- Payment records will be added here -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex justify-between items-center">
                                <button onclick="addPaymentRow()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">
                                    Add Row
                                </button>
                                <div class="space-x-3">
                                    <button onclick="cancelPaymentRecording()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                        Cancel
                                    </button>
                                    <button onclick="recordPayments()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                        Record Payment(s)
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search, Filter, Sort -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                            <input type="text" id="paymentSearch" placeholder="Search by student name or ID..." 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                   oninput="filterPayments()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                            <select id="paymentYearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterPayments()">
                                <option value="">All Years</option>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Month</label>
                            <select id="paymentMonthFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterPayments()">
                                <option value="">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                            <select id="paymentStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterPayments()">
                                <option value="">All Status</option>
                                <option value="received">Received</option>
                                <option value="processed">Processed</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Transaction Type</label>
                            <select id="paymentTypeFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterPayments()">
                                <option value="">All Types</option>
                                <option value="tuition_payment">Tuition Payment</option>
                                <option value="extra_fee_payment">Extra Fee Payment</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                            <select id="paymentSortBy" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterPayments()">
                                <option value="date_newest">Date (Newest)</option>
                                <option value="date_oldest">Date (Oldest)</option>
                                <option value="amount_low">Amount (Low to High)</option>
                                <option value="amount_high">Amount (High to Low)</option>
                                <option value="student_name">Student Name</option>
                                <option value="student_id">Student ID</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Summary Area -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="bg-blue-100 p-2 rounded-lg mr-3">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-blue-600 font-medium">Total Payments</p>
                                <p class="text-2xl font-bold text-blue-900" id="totalPaymentsCount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="bg-green-100 p-2 rounded-lg mr-3">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-green-600 font-medium">Total Amount</p>
                                <p class="text-2xl font-bold text-green-900" id="totalPaymentsAmount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="bg-yellow-100 p-2 rounded-lg mr-3">
                                <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-yellow-600 font-medium">Pending Processing</p>
                                <p class="text-2xl font-bold text-yellow-900" id="pendingProcessingCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction Records Table -->
                <div class="bg-white border rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold">Transaction Records</h3>
                            <div class="flex items-center space-x-3">
                                <button onclick="bulkUpdateStatus('processed')" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700" id="bulkProcessBtn" disabled>
                                    Mark as Processed
                                </button>
                                <button onclick="bulkDeletePayments()" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700" id="bulkDeleteBtn" disabled>
                                    Delete Selected
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        <input type="checkbox" id="selectAllPayments" class="rounded" onchange="toggleAllPaymentSelection()">
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tuition Period</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount Paid</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="paymentTransactionsTable" class="bg-white divide-y divide-gray-200">
                                <!-- Payment transactions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <!-- Student Tuition Detail Modal -->
    <div id="studentTuitionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <!-- Modal Header -->
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Student Tuition Details</h3>
                        <button onclick="closeStudentTuitionModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Basic Info -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Full Name</label>
                                <p id="modalStudentName" class="text-sm text-gray-900 font-medium">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Student ID</label>
                                <p id="modalStudentId" class="text-sm text-gray-900">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Class</label>
                                <p id="modalStudentClass" class="text-sm text-gray-900">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Status</label>
                                <p id="modalStudentStatus" class="text-sm text-gray-900">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Year Selection and Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Year</label>
                            <select id="modalYearSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadStudentTuitionDetails()">
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h4 class="font-medium text-blue-900 mb-2">Summary</h4>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between">
                                    <span>Total Expected:</span>
                                    <span id="modalTotalExpected" class="font-medium">$0.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Total Paid:</span>
                                    <span id="modalTotalPaid" class="font-medium text-green-600">$0.00</span>
                                </div>
                                <div class="flex justify-between border-t pt-1">
                                    <span class="font-medium">Outstanding:</span>
                                    <span id="modalOutstanding" class="font-medium text-red-600">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Area -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                        <textarea id="modalNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Add notes about this student's tuition..."></textarea>
                    </div>

                    <!-- Monthly Tuition Details -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-900 mb-4">Monthly Tuition Details</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="modalMonthlyDetails">
                            <!-- Monthly details will be loaded here -->
                        </div>
                    </div>

                    <!-- Modal Actions -->
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeStudentTuitionModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="saveStudentTuitionDetails()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Save Changes
                        </button>
                    </div>
                </div>


            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDdx6QyXzCWz7BRZInLu16LGnYBKvFO1CM",
            authDomain: "tnl-management-app.firebaseapp.com",
            projectId: "tnl-management-app",
            storageBucket: "tnl-management-app.firebasestorage.app",
            messagingSenderId: "710843379828",
            appId: "1:710843379828:web:76978490616ebe41bf2121",
            measurementId: "G-8W29VX7WTP"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        
        // Enable offline persistence
        db.enablePersistence({ synchronizeTabs: true })
            .then(() => {
                console.log('Offline persistence enabled');
                updateSyncStatus('connected', 'Offline ready');
            })
            .catch((err) => {
                console.warn('Offline persistence failed:', err);
                if (err.code === 'failed-precondition') {
                    console.warn('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                } else if (err.code === 'unimplemented') {
                    console.warn('The current browser does not support offline persistence');
                }
            });

        // Global variables
        let coursePlans = [];
        let students = [];
        let currentEditingPlan = null;
        let allStudentTuition = [];
        let currentModalStudent = null;
        let editMode = false;
        let allPayments = [];
        let filteredPayments = [];
        let paymentRowCounter = 0;
        let allStudentsForSearch = [];
        let isOnline = navigator.onLine;
        let pendingOperations = [];
        let feeTypes = [];
        let allStudentsForExtraFees = [];
        let currentEditingFeeType = null;

        // Enhanced data caching system with localStorage persistence
        let dataCache = {
            coursePlans: { data: null, timestamp: null, loaded: false },
            students: { data: null, timestamp: null, loaded: false },
            studentTuition: { data: null, timestamp: null, loaded: false },
            payments: { data: null, timestamp: null, loaded: false },
            classes: { data: null, timestamp: null, loaded: false },
            feeTypes: { data: null, timestamp: null, loaded: false },
            studentsForSearch: { data: null, timestamp: null, loaded: false },
            studentsForExtraFees: { data: null, timestamp: null, loaded: false }
        };
        const CACHE_DURATION = 30 * 60 * 1000; // 30 minutes in milliseconds
        const CACHE_STORAGE_KEY = 'tuitionSystemCache';
        
        // View state preservation
        let viewState = {
            currentTab: 'calculator',
            currentSubTab: 'planner',
            searchTerms: {},
            filterValues: {},
            sortOptions: {},
            scrollPositions: {},
            modalData: null
        };

        // Load cache from localStorage on startup
        function loadCacheFromStorage() {
            try {
                const storedCache = localStorage.getItem(CACHE_STORAGE_KEY);
                if (storedCache) {
                    const parsedCache = JSON.parse(storedCache);
                    // Merge with current cache structure
                    Object.keys(dataCache).forEach(key => {
                        if (parsedCache[key]) {
                            dataCache[key] = parsedCache[key];
                        }
                    });
                    console.log('Cache loaded from localStorage');
                }
            } catch (error) {
                console.warn('Failed to load cache from localStorage:', error);
            }
        }

        // Save cache to localStorage
        function saveCacheToStorage() {
            try {
                localStorage.setItem(CACHE_STORAGE_KEY, JSON.stringify(dataCache));
            } catch (error) {
                console.warn('Failed to save cache to localStorage:', error);
            }
        }

        // View state preservation functions
        function saveViewState() {
            try {
                // Save current search terms
                const searchInputs = ['studentSearch', 'paymentSearch', 'extraFeeStudentSearch'];
                searchInputs.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) viewState.searchTerms[id] = element.value;
                });

                // Save current filter values
                const filterSelects = [
                    'monthFilter', 'yearFilter', 'classFilter', 'classStatusFilter', 'studentStatusFilter',
                    'tuitionYearFilter', 'tuitionClassFilter', 'tuitionStatusFilter', 'tuitionSortBy',
                    'paymentYearFilter', 'paymentMonthFilter', 'paymentStatusFilter', 'paymentTypeFilter', 'paymentSortBy',
                    'extraFeeClassFilter', 'extraFeeYearFilter'
                ];
                filterSelects.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) viewState.filterValues[id] = element.value;
                });

                // Save scroll positions
                const scrollableElements = ['studentsTableBody', 'studentTuitionTableBody', 'paymentTransactionsTable'];
                scrollableElements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element && element.parentElement) {
                        viewState.scrollPositions[id] = element.parentElement.scrollTop;
                    }
                });

                localStorage.setItem('tuitionSystemViewState', JSON.stringify(viewState));
            } catch (error) {
                console.warn('Failed to save view state:', error);
            }
        }

        function restoreViewState() {
            try {
                const savedState = localStorage.getItem('tuitionSystemViewState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    
                    // Restore search terms
                    Object.entries(parsedState.searchTerms || {}).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element && value) element.value = value;
                    });

                    // Restore filter values
                    Object.entries(parsedState.filterValues || {}).forEach(([id, value]) => {
                        const element = document.getElementById(id);
                        if (element && value) element.value = value;
                    });

                    // Restore tab states
                    if (parsedState.currentTab) {
                        viewState.currentTab = parsedState.currentTab;
                    }
                    if (parsedState.currentSubTab) {
                        viewState.currentSubTab = parsedState.currentSubTab;
                    }

                    // Restore modal data
                    if (parsedState.modalData) {
                        viewState.modalData = parsedState.modalData;
                    }

                    console.log('View state restored');
                }
            } catch (error) {
                console.warn('Failed to restore view state:', error);
            }
        }

        function restoreScrollPositions() {
            try {
                const savedState = localStorage.getItem('tuitionSystemViewState');
                if (savedState) {
                    const parsedState = JSON.parse(savedState);
                    
                    // Restore scroll positions with a delay to ensure DOM is ready
                    setTimeout(() => {
                        Object.entries(parsedState.scrollPositions || {}).forEach(([id, position]) => {
                            const element = document.getElementById(id);
                            if (element && element.parentElement && position > 0) {
                                element.parentElement.scrollTop = position;
                            }
                        });
                    }, 100);
                }
            } catch (error) {
                console.warn('Failed to restore scroll positions:', error);
            }
        }

        function isCacheValid(cacheEntry) {
            if (!cacheEntry.data || !cacheEntry.timestamp) return false;
            return (Date.now() - cacheEntry.timestamp) < CACHE_DURATION;
        }

        function setCacheData(key, data) {
            dataCache[key] = {
                data: data,
                timestamp: Date.now(),
                loaded: true
            };
            saveCacheToStorage();
            console.log(`Cache updated for ${key}:`, {
                dataSize: Array.isArray(data) ? data.length : typeof data === 'object' ? Object.keys(data).length : 'single item',
                timestamp: new Date().toLocaleTimeString()
            });
        }

        function getCacheData(key) {
            if (isCacheValid(dataCache[key])) {
                console.log(`Using cached data for ${key}`);
                return dataCache[key].data;
            }
            return null;
        }

        function isCacheLoaded(key) {
            return dataCache[key].loaded && isCacheValid(dataCache[key]);
        }

        function clearCache(specificKey = null) {
            if (specificKey) {
                dataCache[specificKey] = { data: null, timestamp: null, loaded: false };
            } else {
                Object.keys(dataCache).forEach(key => {
                    dataCache[key] = { data: null, timestamp: null, loaded: false };
                });
            }
            saveCacheToStorage();
            console.log(specificKey ? `Cache cleared for ${specificKey}` : 'All cache cleared');
        }

        // Smart data loading with cache-first approach
        async function loadDataWithCache(key, loadFunction, forceReload = false) {
            // Check cache first unless force reload
            if (!forceReload && isCacheLoaded(key)) {
                const cachedData = getCacheData(key);
                if (cachedData) {
                    return cachedData;
                }
            }

            // Load fresh data
            console.log(`Loading fresh data for ${key}...`);
            updateSyncStatus('syncing', `Loading ${key}...`);
            
            try {
                const freshData = await loadFunction();
                setCacheData(key, freshData);
                updateSyncStatus(isOnline ? 'connected' : 'offline');
                return freshData;
            } catch (error) {
                console.error(`Error loading ${key}:`, error);
                updateSyncStatus('error', `Failed to load ${key}`);
                
                // Try to return stale cache data as fallback
                const staleData = dataCache[key].data;
                if (staleData) {
                    console.log(`Using stale cache data for ${key}`);
                    return staleData;
                }
                throw error;
            }
        }

        // Smart data update functions that preserve view state
        async function updateDataAndPreserveView(updateFunction, affectedCacheKeys = []) {
            try {
                // Save current view state
                saveViewState();
                
                // Perform the update
                await updateFunction();
                
                // Clear affected cache keys
                affectedCacheKeys.forEach(key => clearCache(key));
                
                // Refresh only the current visible data without changing view
                await refreshCurrentView();
                
                // Restore view state
                setTimeout(() => {
                    restoreViewState();
                    restoreScrollPositions();
                }, 100);
                
            } catch (error) {
                console.error('Error updating data:', error);
                throw error;
            }
        }

        async function refreshCurrentView() {
            const currentTab = viewState.currentTab;
            const currentSubTab = viewState.currentSubTab;
            
            if (currentTab === 'student' && tabDataLoaded.student) {
                await loadStudentTuitionDataCached();
            } else if (currentTab === 'payment' && tabDataLoaded.payment) {
                await loadPaymentTrackerCached();
            } else if (currentTab === 'calculator') {
                if (currentSubTab === 'planner') {
                    await loadCoursePlans(true);
                } else if (currentSubTab === 'monthly' && tabDataLoaded.monthly) {
                    await loadStudentsWithFilters();
                } else if (currentSubTab === 'extraFees' && tabDataLoaded.extraFees) {
                    await loadExtraFeesDataCached();
                }
            }
        }

        // Optimized individual update functions
        async function updateSingleRecord(collection, docId, data, affectedViews = []) {
            try {
                if (isOnline) {
                    await db.collection(collection).doc(docId).update(data);
                } else {
                    addPendingOperation({
                        type: 'update',
                        collection: collection,
                        docId: docId,
                        data: data
                    });
                }

                // Update local cache without full reload
                await updateLocalCache(collection, docId, data, 'update');
                
                // Refresh only affected views
                await refreshAffectedViews(affectedViews);
                
            } catch (error) {
                console.error('Error updating record:', error);
                throw error;
            }
        }

        async function updateLocalCache(collection, docId, data, operation) {
            // Update relevant cache entries based on collection
            if (collection === 'tuition') {
                // Update student tuition cache
                if (dataCache.studentTuition.data) {
                    // Find and update the specific student's tuition data
                    const studentId = data.studentId || docId.split('_')[1];
                    const student = dataCache.studentTuition.data.find(s => s.studentId === studentId);
                    if (student && student.tuitionData) {
                        const month = data.month;
                        if (month && student.tuitionData.monthlyData[month]) {
                            Object.assign(student.tuitionData.monthlyData[month], data);
                        }
                    }
                }
            } else if (collection === 'paymentTransactions') {
                // Update payments cache
                if (dataCache.payments.data) {
                    if (operation === 'update') {
                        const paymentIndex = dataCache.payments.data.findIndex(p => p.id === docId);
                        if (paymentIndex !== -1) {
                            Object.assign(dataCache.payments.data[paymentIndex], data);
                        }
                    } else if (operation === 'create') {
                        dataCache.payments.data.push({ id: docId, ...data });
                    } else if (operation === 'delete') {
                        dataCache.payments.data = dataCache.payments.data.filter(p => p.id !== docId);
                    }
                }
            }
            
            // Save updated cache
            saveCacheToStorage();
        }

        async function refreshAffectedViews(affectedViews) {
            for (const view of affectedViews) {
                if (view === 'studentTuition' && viewState.currentTab === 'student') {
                    filterStudentTuition();
                } else if (view === 'payments' && viewState.currentTab === 'payment') {
                    filterPayments();
                } else if (view === 'monthlyCalculation' && viewState.currentSubTab === 'monthly') {
                    renderStudentsTable();
                }
            }
        }

        // Offline detection
        window.addEventListener('online', () => {
            isOnline = true;
            updateSyncStatus('connected', 'Back online');
            processPendingOperations();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateSyncStatus('offline', 'Working offline');
        });

        // Vietnamese text normalization for search
        function normalizeVietnamese(str) {
            if (!str) return '';
            return str.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                .replace(/Ä‘/g, 'd')
                .replace(/Ä/g, 'd');
        }



        // Vietnamese currency formatting
        function formatVNDForDisplay(amount, isTableCell = false) {
            if (!amount || amount === 0) return '0';
            
            if (isTableCell) {
                // For table cells, show compact format without .000
                if (amount >= 1000000) {
                    return (amount / 1000000).toFixed(0) + 'M';
                } else if (amount >= 1000) {
                    return (amount / 1000).toFixed(0) + 'K';
                }
                return amount.toFixed(0);
            } else {
                // For other displays, show full format with .000
                return (amount / 1000).toLocaleString('vi-VN') + '.000';
            }
        }

        function formatVNDFull(amount) {
            if (!amount || amount === 0) return '0';
            return (amount / 1000).toLocaleString('vi-VN') + '.000';
        }

        function formatVNDShort(amount) {
            if (!amount || amount === 0) return '0';
            
            if (amount >= 1000000) {
                return (amount / 1000000).toFixed(0) + 'M';
            } else if (amount >= 1000) {
                return (amount / 1000).toFixed(0) + 'K';
            }
            return (amount / 1000).toFixed(0);
        }

        function parseVNDInput(value) {
            if (!value) return 0;
            // Remove any non-numeric characters except decimal point
            const cleanValue = value.toString().replace(/[^\d.]/g, '');
            const numValue = parseFloat(cleanValue) || 0;
            // Multiply by 1000 to convert to actual VND amount
            return numValue * 1000;
        }

        // Global tab state tracking
        let tabDataLoaded = {
            calculator: true, // Always loaded on startup
            student: false,
            payment: false,
            planner: true, // Always loaded on startup
            monthly: false,
            extraFees: false
        };

        // Tab switching functions with data preservation
        function switchTab(tabName) {
            // Save current view state before switching
            saveViewState();
            
            // Hide all content
            document.getElementById('calculatorContent').classList.add('hidden');
            document.getElementById('studentContent').classList.add('hidden');
            document.getElementById('paymentContent').classList.add('hidden');

            // Remove active classes
            document.getElementById('calculatorTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('calculatorTab').classList.add('border-transparent', 'text-gray-500');
            document.getElementById('studentTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('studentTab').classList.add('border-transparent', 'text-gray-500');
            document.getElementById('paymentTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('paymentTab').classList.add('border-transparent', 'text-gray-500');

            // Update view state
            viewState.currentTab = tabName;

            // Show selected content and activate tab
            if (tabName === 'calculator') {
                document.getElementById('calculatorContent').classList.remove('hidden');
                document.getElementById('calculatorTab').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('calculatorTab').classList.remove('border-transparent', 'text-gray-500');
                // Calculator data is already loaded on startup - no refresh needed
            } else if (tabName === 'student') {
                document.getElementById('studentContent').classList.remove('hidden');
                document.getElementById('studentTab').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('studentTab').classList.remove('border-transparent', 'text-gray-500');
                // Only load data if not already loaded
                if (!tabDataLoaded.student) {
                    loadStudentTuitionDataCached();
                    tabDataLoaded.student = true;
                } else {
                    // Restore scroll position for already loaded data
                    restoreScrollPositions();
                }
            } else if (tabName === 'payment') {
                document.getElementById('paymentContent').classList.remove('hidden');
                document.getElementById('paymentTab').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('paymentTab').classList.remove('border-transparent', 'text-gray-500');
                // Only load data if not already loaded
                if (!tabDataLoaded.payment) {
                    loadPaymentTrackerCached();
                    tabDataLoaded.payment = true;
                } else {
                    // Restore scroll position for already loaded data
                    restoreScrollPositions();
                }
            }
        }

        function switchCalculatorTab(tabName) {
            // Save current view state before switching
            saveViewState();
            
            // Hide all calculator content
            document.getElementById('plannerContent').classList.add('hidden');
            document.getElementById('monthlyContent').classList.add('hidden');
            document.getElementById('extraFeesContent').classList.add('hidden');

            // Remove active classes
            document.getElementById('plannerSubTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('plannerSubTab').classList.add('border-transparent', 'text-gray-500');
            document.getElementById('monthlySubTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('monthlySubTab').classList.add('border-transparent', 'text-gray-500');
            document.getElementById('extraFeesSubTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('extraFeesSubTab').classList.add('border-transparent', 'text-gray-500');

            // Update view state
            viewState.currentSubTab = tabName;

            // Show selected content and activate tab
            if (tabName === 'planner') {
                document.getElementById('plannerContent').classList.remove('hidden');
                document.getElementById('plannerSubTab').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('plannerSubTab').classList.remove('border-transparent', 'text-gray-500');
                // Course plans are already loaded on startup - no refresh needed
            } else if (tabName === 'monthly') {
                document.getElementById('monthlyContent').classList.remove('hidden');
                document.getElementById('monthlySubTab').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('monthlySubTab').classList.remove('border-transparent', 'text-gray-500');
                // Preserve the current state - don't reset to getting started if data is already loaded
                if (!tabDataLoaded.monthly) {
                    showGettingStartedMessage();
                } else {
                    // Restore scroll position for already loaded data
                    restoreScrollPositions();
                }
                // If data was previously loaded, keep showing it
            } else if (tabName === 'extraFees') {
                document.getElementById('extraFeesContent').classList.remove('hidden');
                document.getElementById('extraFeesSubTab').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('extraFeesSubTab').classList.remove('border-transparent', 'text-gray-500');
                // Only load data if not already loaded
                if (!tabDataLoaded.extraFees) {
                    loadExtraFeesDataCached();
                    tabDataLoaded.extraFees = true;
                } else {
                    // Restore scroll position for already loaded data
                    restoreScrollPositions();
                }
            }
        }

        // Cached loading functions for instant tab switching
        async function loadStudentTuitionDataCached() {
            try {
                const data = await loadDataWithCache('studentTuition', async () => {
                    // Load all students
                    const studentsSnapshot = await db.collection('students').get();
                    const studentTuitionData = [];
                    
                    for (const doc of studentsSnapshot.docs) {
                        const studentData = { id: doc.id, ...doc.data() };
                        
                        // Get enrollment year from student data or default to current year
                        const enrollmentYear = studentData.enrollmentYear || new Date().getFullYear();
                        
                        // Get the display year from filter or current year
                        const displayYear = parseInt(document.getElementById('tuitionYearFilter').value) || new Date().getFullYear();
                        
                        // Load tuition data for the display year
                        const tuitionData = await loadStudentYearlyTuition(studentData.studentId, displayYear);
                        
                        studentData.enrollmentYear = enrollmentYear;
                        studentData.tuitionData = tuitionData;
                        
                        studentTuitionData.push(studentData);
                    }
                    
                    return studentTuitionData;
                });

                allStudentTuition = data;
                
                // Load classes for filter if not already cached
                if (!isCacheLoaded('classes')) {
                    await loadTuitionClassesCached();
                }
                
                // Apply initial filters and render
                filterStudentTuition();
                
            } catch (error) {
                console.error('Error loading student tuition data:', error);
                allStudentTuition = [];
                filterStudentTuition();
            }
        }

        async function loadPaymentTrackerCached() {
            try {
                const data = await loadDataWithCache('payments', async () => {
                    let paymentsSnapshot;
                    try {
                        paymentsSnapshot = await db.collection('paymentTransactions')
                            .orderBy('paymentDate', 'desc')
                            .get();
                    } catch (orderError) {
                        console.log('No orderBy index, loading without ordering...');
                        paymentsSnapshot = await db.collection('paymentTransactions').get();
                    }
                    
                    const payments = [];
                    
                    paymentsSnapshot.forEach(doc => {
                        try {
                            const data = doc.data();
                            
                            // Handle different date formats
                            let paymentDate;
                            if (data.paymentDate) {
                                if (data.paymentDate.toDate) {
                                    paymentDate = data.paymentDate.toDate();
                                } else if (typeof data.paymentDate === 'string') {
                                    paymentDate = new Date(data.paymentDate);
                                } else {
                                    paymentDate = data.paymentDate;
                                }
                            } else {
                                paymentDate = new Date();
                            }
                            
                            if (data.studentId && (data.amountPaid || data.amount)) {
                                payments.push({
                                    id: doc.id,
                                    paymentDate: paymentDate,
                                    studentId: data.studentId,
                                    studentName: data.studentName || data.fullName || data.name || 'Unknown',
                                    classAssignment: data.classAssignment || data.class || 'N/A',
                                    tuitionYear: parseInt(data.tuitionYear || data.year) || new Date().getFullYear(),
                                    tuitionMonth: parseInt(data.tuitionMonth || data.month) || 1,
                                    amountPaid: parseFloat(data.amountPaid || data.amount) || 0,
                                    paymentStatus: data.paymentStatus || data.status || 'received',
                                    recordedAt: data.recordedAt || data.createdAt,
                                    recordedBy: data.recordedBy || 'system',
                                    source: data.source || 'manual',
                                    transactionType: data.transactionType || 'tuition_payment'
                                });
                            }
                        } catch (docError) {
                            console.warn('Error processing payment document:', doc.id, docError);
                        }
                    });
                    
                    return payments;
                });

                allPayments = data;
                
                // Load students for search if not already cached
                if (!isCacheLoaded('studentsForSearch')) {
                    await loadStudentsForSearchCached();
                }
                
                // Apply filters and render
                filterPayments();
                
            } catch (error) {
                console.error('Error loading payments:', error);
                allPayments = [];
                filterPayments();
            }
        }

        // New function to check if required filters are selected
        function checkFiltersAndLoadStudents() {
            const selectedMonth = document.getElementById('monthFilter').value;
            const selectedYear = document.getElementById('yearFilter').value;
            const loadBtn = document.getElementById('loadStudentsBtn');
            
            if (selectedMonth && selectedYear) {
                // Enable the load button
                loadBtn.disabled = false;
                loadBtn.className = 'px-6 py-2 bg-blue-600 text-white rounded-md text-sm hover:bg-blue-700 cursor-pointer';
                loadBtn.textContent = 'Load Student Data';
                
                // Auto-load when both month and year are selected
                loadStudentsWithFilters();
            } else {
                // Disable the load button
                loadBtn.disabled = true;
                loadBtn.className = 'px-6 py-2 bg-gray-400 text-white rounded-md text-sm opacity-50 cursor-not-allowed';
                loadBtn.textContent = 'Select Month and Year First';
                
                // Show getting started message
                showGettingStartedMessage();
            }
        }

        function showGettingStartedMessage() {
            document.getElementById('monthlyGettingStarted').classList.remove('hidden');
            document.getElementById('monthlyStudentsTable').classList.add('hidden');
            document.getElementById('monthlyLoadingIndicator').classList.add('hidden');
        }

        function showLoadingIndicator() {
            document.getElementById('monthlyGettingStarted').classList.add('hidden');
            document.getElementById('monthlyStudentsTable').classList.add('hidden');
            document.getElementById('monthlyLoadingIndicator').classList.remove('hidden');
        }

        function showStudentsTable() {
            document.getElementById('monthlyGettingStarted').classList.add('hidden');
            document.getElementById('monthlyLoadingIndicator').classList.add('hidden');
            document.getElementById('monthlyStudentsTable').classList.remove('hidden');
        }

        async function loadStudentsWithFilters() {
            const selectedMonth = document.getElementById('monthFilter').value;
            const selectedYear = document.getElementById('yearFilter').value;
            
            // Require both month and year to be selected
            if (!selectedMonth || !selectedYear) {
                showGettingStartedMessage();
                tabDataLoaded.monthly = false;
                return;
            }
            
            try {
                showLoadingIndicator();
                updateSyncStatus('syncing', 'Loading student data...');
                
                console.log(`Loading students for ${selectedMonth}/${selectedYear}...`);
                
                // Get other filter values
                const selectedClass = document.getElementById('classFilter').value;
                const selectedClassStatus = document.getElementById('classStatusFilter').value;
                const selectedStudentStatus = document.getElementById('studentStatusFilter').value;
                
                console.log('Filters:', { selectedMonth, selectedYear, selectedClass, selectedClassStatus, selectedStudentStatus });
                
                // Load ALL students first (no filters on the query to ensure we get everyone)
                const snapshot = await db.collection('students').get();
                console.log(`Found ${snapshot.size} total students in database`);
                
                const studentsData = [];
                const year = parseInt(selectedYear);
                const month = parseInt(selectedMonth);
                
                for (const doc of snapshot.docs) {
                    const studentData = { id: doc.id, ...doc.data() };
                    
                    // Apply client-side filters
                    let includeStudent = true;
                    
                    // Apply student status filter
                    if (selectedStudentStatus && studentData.status !== selectedStudentStatus) {
                        includeStudent = false;
                    }
                    
                    // Apply class filter
                    if (selectedClass && studentData.classAssignment !== selectedClass) {
                        includeStudent = false;
                    }
                    
                    if (!includeStudent) {
                        continue;
                    }
                    
                    // Get attendance data for the specific month/year
                    const attendanceData = await getMonthlyAttendance(studentData.studentId, year, month, false);
                    
                    // Load existing tuition calculation data from Firestore
                    const monthStr = String(month).padStart(2, '0');
                    const tuitionDocId = `tuition_${studentData.studentId}_${year}-${monthStr}`;
                    let existingTuitionData = null;
                    
                    try {
                        const tuitionDoc = await db.collection('tuition').doc(tuitionDocId).get();
                        if (tuitionDoc.exists) {
                            existingTuitionData = tuitionDoc.data();
                            console.log(`Found existing tuition data for ${studentData.studentId}:`, existingTuitionData);
                        }
                    } catch (error) {
                        console.warn(`Error loading tuition data for ${studentData.studentId}:`, error);
                    }
                    
                    // Include student even if no attendance (show 0 lessons/courses)
                    // This ensures all students appear in the list
                    const studentEntry = {
                        ...studentData,
                        id: `${doc.id}_${year}_${month}`,
                        originalId: doc.id,
                        displayMonth: month,
                        displayYear: year,
                        attendedLessons: attendanceData.attendedLessons || 0,
                        coursesCount: attendanceData.coursesCount || 0,
                        lessonLength: existingTuitionData?.lessonLength || 1.5,
                        studyHours: existingTuitionData?.studyHours || ((attendanceData.attendedLessons || 0) * (existingTuitionData?.lessonLength || 1.5)),
                        // Restore saved tuition calculation data
                        coursePlan: existingTuitionData?.coursePlan || null,
                        calculatedFee: existingTuitionData?.calculatedFee || 0,
                        adjustedFee: existingTuitionData?.adjustedFee || 0,
                        finalFee: existingTuitionData?.finalFee || 0,
                        status: existingTuitionData?.status || null,
                        savedAt: existingTuitionData?.savedAt || null,
                        informedAt: existingTuitionData?.informedAt || null
                    };
                    studentsData.push(studentEntry);
                }
                
                console.log(`Processed ${studentsData.length} student entries after filtering`);
                
                students = studentsData;
                
                // Update the period display
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
                document.getElementById('selectedPeriod').textContent = `${monthNames[month - 1]} ${year}`;
                document.getElementById('studentsCount').textContent = `${studentsData.length} students`;
                
                renderStudentsTable();
                showStudentsTable();
                
                // Mark monthly tab as loaded with data
                tabDataLoaded.monthly = true;
                
                updateSyncStatus(isOnline ? 'connected' : 'offline');
                
            } catch (error) {
                console.error('Error loading students:', error);
                students = [];
                renderStudentsTable();
                showStudentsTable();
                tabDataLoaded.monthly = false;
                updateSyncStatus('error', 'Load failed');
            }
        }

        // Keep the old function for backward compatibility but make it use the new approach
        async function loadStudentsCached() {
            // For the monthly tab, we now require explicit filter selection
            // This function will only be called from other tabs
            const selectedMonth = document.getElementById('monthFilter')?.value;
            const selectedYear = document.getElementById('yearFilter')?.value;
            
            if (!selectedMonth || !selectedYear) {
                showGettingStartedMessage();
                return;
            }
            
            await loadStudentsWithFilters();
        }

        async function loadExtraFeesDataCached() {
            try {
                // Load fee types with caching
                await loadFeeTypesCached();
                
                // Load students for extra fees with caching
                await loadStudentsForExtraFeesCached();
                
                // Load extra fee classes for filter
                if (!isCacheLoaded('classes')) {
                    await loadExtraFeeClassesCached();
                }
                
                // Set current year as default
                const currentYear = new Date().getFullYear();
                document.getElementById('extraFeeYearFilter').value = currentYear;
                
                // Filter and render students
                filterExtraFeeStudents();
                
            } catch (error) {
                console.error('Error loading extra fees data:', error);
            }
        }

        async function loadFeeTypesCached() {
            try {
                const data = await loadDataWithCache('feeTypes', async () => {
                    const snapshot = await db.collection('feeTypes').get();
                    const feeTypesData = [];
                    
                    snapshot.forEach(doc => {
                        feeTypesData.push({ id: doc.id, ...doc.data() });
                    });
                    
                    return feeTypesData;
                });

                feeTypes = data;
                renderFeeTypes();
                
            } catch (error) {
                console.error('Error loading fee types:', error);
                feeTypes = [];
                renderFeeTypes();
            }
        }

        async function loadStudentsForSearchCached() {
            try {
                const data = await loadDataWithCache('studentsForSearch', async () => {
                    const studentsSnapshot = await db.collection('students').get();
                    const studentsData = [];
                    
                    studentsSnapshot.forEach(doc => {
                        const data = doc.data();
                        
                        if (data.studentId && data.fullName) {
                            studentsData.push({
                                id: doc.id,
                                studentId: data.studentId,
                                fullName: data.fullName,
                                classAssignment: data.classAssignment || 'N/A',
                                status: data.status || 'Active'
                            });
                        }
                    });
                    
                    studentsData.sort((a, b) => (a.fullName || '').localeCompare(b.fullName || ''));
                    return studentsData;
                });

                allStudentsForSearch = data;
                
            } catch (error) {
                console.error('Error loading students for search:', error);
                allStudentsForSearch = [];
            }
        }

        async function loadStudentsForExtraFeesCached() {
            try {
                const data = await loadDataWithCache('studentsForExtraFees', async () => {
                    const studentsSnapshot = await db.collection('students').get();
                    const studentsData = [];
                    
                    studentsSnapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.studentId && data.fullName) {
                            studentsData.push({
                                id: doc.id,
                                studentId: data.studentId,
                                fullName: data.fullName,
                                classAssignment: data.classAssignment || 'N/A',
                                status: data.status || 'Active'
                            });
                        }
                    });
                    
                    studentsData.sort((a, b) => (a.fullName || '').localeCompare(b.fullName || ''));
                    return studentsData;
                });

                allStudentsForExtraFees = data;
                
            } catch (error) {
                console.error('Error loading students for extra fees:', error);
                allStudentsForExtraFees = [];
            }
        }

        async function loadTuitionClassesCached() {
            try {
                console.log('Loading classes data...');
                
                const data = await loadDataWithCache('classes', async () => {
                    console.log('Fetching classes from database...');
                    const snapshot = await db.collection('classes').get();
                    console.log(`Found ${snapshot.size} class documents`);
                    
                    const classesData = [];
                    
                    snapshot.forEach(doc => {
                        const classData = doc.data();
                        const processedClass = {
                            id: doc.id,
                            classCode: classData.classCode || doc.id,
                            className: classData.className || classData.classCode || doc.id
                        };
                        classesData.push(processedClass);
                        console.log(`Processed class: ${processedClass.classCode} - ${processedClass.className}`);
                    });
                    
                    console.log(`Successfully processed ${classesData.length} classes`);
                    return classesData;
                });

                console.log(`Using ${data.length} classes for dropdowns`);

                // Update all class filter dropdowns immediately
                const classFilters = [
                    'classFilter',
                    'tuitionClassFilter', 
                    'extraFeeClassFilter'
                ];
                
                classFilters.forEach(filterId => {
                    const classFilter = document.getElementById(filterId);
                    if (classFilter) {
                        // Clear existing options
                        classFilter.innerHTML = '<option value="">All Classes</option>';
                        
                        // Add classes
                        data.forEach(classData => {
                            const option = document.createElement('option');
                            option.value = classData.classCode;
                            option.textContent = classData.className;
                            classFilter.appendChild(option);
                        });
                        
                        console.log(`Updated ${filterId} with ${data.length} classes`);
                    } else {
                        console.warn(`Class filter ${filterId} not found in DOM`);
                    }
                });
                
                console.log('Classes loading completed successfully');
                
            } catch (error) {
                console.error('Error loading classes:', error);
                updateSyncStatus('error', 'Failed to load classes');
                
                // Show error in dropdowns
                const classFilters = ['classFilter', 'tuitionClassFilter', 'extraFeeClassFilter'];
                classFilters.forEach(filterId => {
                    const classFilter = document.getElementById(filterId);
                    if (classFilter) {
                        classFilter.innerHTML = '<option value="">Error loading classes</option>';
                    }
                });
            }
        }

        async function loadExtraFeeClassesCached() {
            // This uses the same classes data as tuition classes
            await loadTuitionClassesCached();
        }

        // Firebase sync status
        function updateSyncStatus(status, message) {
            const syncIcon = document.getElementById('syncIcon');
            const syncText = document.getElementById('syncText');
            
            if (status === 'connected') {
                syncIcon.className = 'w-2 h-2 rounded-full mr-2 bg-green-500';
                syncText.textContent = message || 'Connected';
            } else if (status === 'syncing') {
                syncIcon.className = 'w-2 h-2 rounded-full mr-2 bg-yellow-500 animate-pulse';
                syncText.textContent = message || 'Syncing...';
            } else if (status === 'offline') {
                syncIcon.className = 'w-2 h-2 rounded-full mr-2 bg-orange-500';
                syncText.textContent = message || 'Working offline';
            } else {
                syncIcon.className = 'w-2 h-2 rounded-full mr-2 bg-red-500';
                syncText.textContent = message || 'Disconnected';
            }
        }

        // Offline operations handling
        function addPendingOperation(operation) {
            pendingOperations.push(operation);
            localStorage.setItem('pendingOperations', JSON.stringify(pendingOperations));
        }

        async function processPendingOperations() {
            if (pendingOperations.length === 0) return;
            
            updateSyncStatus('syncing', 'Syncing pending changes...');
            
            for (const operation of pendingOperations) {
                try {
                    await executeOperation(operation);
                } catch (error) {
                    console.error('Failed to sync operation:', error);
                }
            }
            
            pendingOperations = [];
            localStorage.removeItem('pendingOperations');
            updateSyncStatus('connected', 'All changes synced');
        }

        async function executeOperation(operation) {
            switch (operation.type) {
                case 'create':
                    await db.collection(operation.collection).doc(operation.docId).set(operation.data);
                    break;
                case 'update':
                    await db.collection(operation.collection).doc(operation.docId).update(operation.data);
                    break;
                case 'delete':
                    await db.collection(operation.collection).doc(operation.docId).delete();
                    break;
            }
        }

        // Payment Recorder Toggle
        function togglePaymentRecorder() {
            const content = document.getElementById('paymentRecorderContent');
            const icon = document.getElementById('paymentRecorderIcon');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.remove('rotate-90');
                icon.classList.add('rotate-0');
                
                // Don't initialize with rows - let user add them manually
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-0');
                icon.classList.add('rotate-90');
            }
        }

        // Course Plan Management
        document.getElementById('coursePlanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const planData = {
                planCode: document.getElementById('planCode').value,
                planName: document.getElementById('planName').value,
                numCourses: parseInt(document.getElementById('numCourses').value) || 0,
                numLessons: parseInt(document.getElementById('numLessons').value) || 0,
                numHours: parseFloat(document.getElementById('numHours').value) || 0,
                standardFee: parseFloat(document.getElementById('standardFee').value) * 1000 || 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'active'
            };

            try {
                updateSyncStatus('syncing', 'Saving plan...');
                
                if (currentEditingPlan) {
                    if (isOnline) {
                        await db.collection('coursePlans').doc(currentEditingPlan).update(planData);
                    } else {
                        addPendingOperation({
                            type: 'update',
                            collection: 'coursePlans',
                            docId: currentEditingPlan,
                            data: planData
                        });
                    }
                    currentEditingPlan = null;
                } else {
                    // Check if plan code already exists
                    const existingPlan = await db.collection('coursePlans').where('planCode', '==', planData.planCode).get();
                    if (!existingPlan.empty) {
                        alert('Plan code already exists. Please use a unique code.');
                        updateSyncStatus(isOnline ? 'connected' : 'offline');
                        return;
                    }
                    
                    // Generate sequential document ID
                    const allPlans = await db.collection('coursePlans').get();
                    const planNumber = String(allPlans.size + 1).padStart(3, '0');
                    const docId = `coursePlan_${planNumber}`;
                    
                    if (isOnline) {
                        await db.collection('coursePlans').doc(docId).set(planData);
                    } else {
                        addPendingOperation({
                            type: 'create',
                            collection: 'coursePlans',
                            docId: docId,
                            data: planData
                        });
                    }
                }
                
                document.getElementById('coursePlanForm').reset();
                clearCache(); // Clear cache to force fresh data load
                await loadCoursePlans(true); // Force reload to refresh cache
                updateSyncStatus(isOnline ? 'connected' : 'offline', isOnline ? 'Plan saved' : 'Plan saved offline');
            } catch (error) {
                console.error('Error saving plan:', error);
                updateSyncStatus('error', 'Save failed');
                alert('Error saving plan: ' + error.message);
            }
        });

        async function loadCoursePlans(forceReload = false) {
            try {
                // Use the cached loading approach for consistency
                const data = await loadDataWithCache('coursePlans', async () => {
                    console.log('Loading course plans from database...');
                    
                    // Load all course plans
                    const allPlansSnapshot = await db.collection('coursePlans').get();
                    console.log(`Found ${allPlansSnapshot.size} course plan documents`);
                    
                    const allPlans = [];
                    let activePlans = [];
                    let archivedPlans = [];

                    // Process all plans and separate by status
                    allPlansSnapshot.forEach(doc => {
                        const plan = { id: doc.id, ...doc.data() };
                        allPlans.push(plan);
                        
                        // Default to active if no status is set
                        const status = plan.status || 'active';
                        if (status === 'active') {
                            activePlans.push(plan);
                        } else if (status === 'archived') {
                            archivedPlans.push(plan);
                        } else {
                            // Default unknown status to active
                            activePlans.push(plan);
                        }
                    });

                    console.log(`Processed ${allPlans.length} course plans: ${activePlans.length} active, ${archivedPlans.length} archived`);

                    return {
                        coursePlans: allPlans,
                        activePlans: activePlans,
                        archivedPlans: archivedPlans
                    };
                }, forceReload);

                // Set global variables
                coursePlans = data.coursePlans;

                // Render UI
                renderCoursePlansUI(data.activePlans, data.archivedPlans);

            } catch (error) {
                console.error('Error loading course plans:', error);
                updateSyncStatus('error', 'Failed to load course plans');
                
                // Show empty state on error
                coursePlans = [];
                renderCoursePlansUI([], []);
            }
        }

        function renderCoursePlansUI(activePlans, archivedPlans) {
            const activePlansContent = document.getElementById('activePlansContent');
            const archivedPlansContent = document.getElementById('archivedPlansContent');
            
            activePlansContent.innerHTML = '';
            archivedPlansContent.innerHTML = '';

            // Render active plans
            if (activePlans.length === 0) {
                activePlansContent.innerHTML = '<p class="text-gray-500 text-center py-4">No active course plans found</p>';
            } else {
                activePlans.forEach(plan => {
                    const planElement = document.createElement('div');
                    planElement.className = 'border border-green-200 rounded-lg p-4 bg-green-50';
                    planElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-gray-900">${plan.planName}</h4>
                                <p class="text-sm text-gray-600">Code: ${plan.planCode}</p>
                                <div class="mt-2 text-sm text-gray-600">
                                    <p>Courses: ${plan.numCourses} | Lessons: ${plan.numLessons} | Hours: ${plan.numHours}</p>
                                    <p class="font-medium">Fee: ${formatVNDForDisplay(plan.standardFee)}</p>
                                </div>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editPlan('${plan.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                <button onclick="deletePlan('${plan.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                <button onclick="archivePlan('${plan.id}')" class="text-gray-600 hover:text-gray-800 text-sm">Archive</button>
                            </div>
                        </div>
                    `;
                    activePlansContent.appendChild(planElement);
                });
            }

            // Render archived plans
            if (archivedPlans.length === 0) {
                archivedPlansContent.innerHTML = '<p class="text-gray-500 text-center py-4">No archived course plans found</p>';
            } else {
                archivedPlans.forEach(plan => {
                    const planElement = document.createElement('div');
                    planElement.className = 'border rounded-lg p-4 bg-gray-100';
                    planElement.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-semibold text-gray-700">${plan.planName}</h4>
                                <p class="text-sm text-gray-500">Code: ${plan.planCode}</p>
                                <div class="mt-2 text-sm text-gray-500">
                                    <p>Courses: ${plan.numCourses} | Lessons: ${plan.numLessons} | Hours: ${plan.numHours}</p>
                                    <p class="font-medium">Fee: ${formatVNDForDisplay(plan.standardFee)}</p>
                                </div>
                                <span class="inline-block mt-2 px-2 py-1 text-xs bg-gray-200 text-gray-600 rounded">Archived</span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="unarchivePlan('${plan.id}')" class="text-green-600 hover:text-green-800 text-sm">Unarchive</button>
                                <button onclick="deletePlan('${plan.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                            </div>
                        </div>
                    `;
                    archivedPlansContent.appendChild(planElement);
                });
            }
        }

        async function editPlan(planId) {
            const plan = coursePlans.find(p => p.id === planId);
            if (plan) {
                document.getElementById('planCode').value = plan.planCode;
                document.getElementById('planName').value = plan.planName;
                document.getElementById('numCourses').value = plan.numCourses;
                document.getElementById('numLessons').value = plan.numLessons;
                document.getElementById('numHours').value = plan.numHours;
                document.getElementById('standardFee').value = plan.standardFee / 1000;
                currentEditingPlan = planId;
            }
        }

        async function deletePlan(planId) {
            if (confirm('Are you sure you want to delete this plan?')) {
                try {
                    updateSyncStatus('syncing', 'Deleting...');
                    
                    if (isOnline) {
                        await db.collection('coursePlans').doc(planId).delete();
                    } else {
                        addPendingOperation({
                            type: 'delete',
                            collection: 'coursePlans',
                            docId: planId
                        });
                    }
                    
                    loadCoursePlans();
                    updateSyncStatus(isOnline ? 'connected' : 'offline', isOnline ? 'Plan deleted' : 'Delete queued');
                } catch (error) {
                    console.error('Error deleting plan:', error);
                    updateSyncStatus('error', 'Delete failed');
                }
            }
        }

        async function archivePlan(planId) {
            try {
                updateSyncStatus('syncing', 'Archiving...');
                
                if (isOnline) {
                    await db.collection('coursePlans').doc(planId).update({ status: 'archived' });
                } else {
                    addPendingOperation({
                        type: 'update',
                        collection: 'coursePlans',
                        docId: planId,
                        data: { status: 'archived' }
                    });
                }
                
                loadCoursePlans();
                updateSyncStatus(isOnline ? 'connected' : 'offline', isOnline ? 'Plan archived' : 'Archive queued');
            } catch (error) {
                console.error('Error archiving plan:', error);
                updateSyncStatus('error', 'Archive failed');
            }
        }

        async function unarchivePlan(planId) {
            try {
                updateSyncStatus('syncing', 'Unarchiving...');
                
                if (isOnline) {
                    await db.collection('coursePlans').doc(planId).update({ status: 'active' });
                } else {
                    addPendingOperation({
                        type: 'update',
                        collection: 'coursePlans',
                        docId: planId,
                        data: { status: 'active' }
                    });
                }
                
                loadCoursePlans();
                updateSyncStatus(isOnline ? 'connected' : 'offline', isOnline ? 'Plan unarchived' : 'Unarchive queued');
            } catch (error) {
                console.error('Error unarchiving plan:', error);
                updateSyncStatus('error', 'Unarchive failed');
            }
        }

        function toggleSection(sectionName) {
            const content = document.getElementById(sectionName + 'Content');
            const icon = document.getElementById(sectionName + 'Icon');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.remove('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.add('rotate-180');
            }
        }

        function toggleFeeSection(sectionName) {
            const content = document.getElementById(sectionName + 'Content');
            const icon = document.getElementById(sectionName + 'Icon');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.remove('rotate-180');
                icon.classList.add('rotate-0');
            } else {
                content.classList.add('hidden');
                icon.classList.remove('rotate-0');
                icon.classList.add('rotate-180');
            }
        }

        // Student Management - Updated to show all students
        async function loadStudents() {
            // Use the cached version for consistency
            await loadStudentsCached();
        }

        async function getMonthlyAttendance(studentId, year, month, showAllTime = false) {
            try {
                // Get all attendance records for the student
                const attendanceSnapshot = await db.collection('attendance')
                    .where('studentId', '==', studentId)
                    .get();
                
                let attendedLessons = 0;
                let uniqueCourses = new Set();
                
                attendanceSnapshot.forEach(doc => {
                    const data = doc.data();
                    const attendanceDate = data.date?.toDate ? data.date.toDate() : new Date(data.date);
                    
                    // If showAllTime is true, count all attendance regardless of date
                    // Otherwise, filter by the selected month/year
                    const shouldCount = showAllTime || 
                        (attendanceDate.getFullYear() === year && 
                         attendanceDate.getMonth() + 1 === month);
                    
                    if (shouldCount) {
                        // Count only if student was present
                        if (data.status === 'present' || data.status === 'Present') {
                            attendedLessons++;
                            
                            // Track unique courses
                            if (data.courseCode) {
                                uniqueCourses.add(data.courseCode);
                            }
                        }
                    }
                });
                
                return {
                    attendedLessons: attendedLessons,
                    coursesCount: uniqueCourses.size
                };
            } catch (error) {
                console.error('Error getting attendance:', error);
                return {
                    attendedLessons: 0,
                    coursesCount: 0
                };
            }
        }

        function renderStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';

            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="px-6 py-8 text-center text-gray-500">
                            No students found for the selected criteria
                        </td>
                    </tr>
                `;
                return;
            }

            students.forEach(student => {
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const row = document.createElement('tr');
                
                // Determine button states based on saved data
                let saveButtonClass = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50 mr-2';
                let saveButtonText = 'Save';
                let saveButtonDisabled = true;
                let informButtonClass = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50';
                let informButtonText = 'Inform';
                let informButtonDisabled = true;
                
                if (student.status === 'informed') {
                    // Already informed - both buttons disabled
                    saveButtonClass = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50 mr-2';
                    saveButtonText = 'Saved';
                    saveButtonDisabled = true;
                    informButtonClass = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50';
                    informButtonText = 'Informed';
                    informButtonDisabled = true;
                } else if (student.status === 'saved' && student.finalFee > 0) {
                    // Saved but not informed - enable inform button
                    saveButtonClass = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50 mr-2';
                    saveButtonText = 'Saved';
                    saveButtonDisabled = true;
                    informButtonClass = 'bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700';
                    informButtonText = 'Inform';
                    informButtonDisabled = false;
                } else if (student.adjustedFee > 0 || student.calculatedFee > 0) {
                    // Has fee data but not saved - enable save button
                    saveButtonClass = 'bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 mr-2';
                    saveButtonText = 'Save';
                    saveButtonDisabled = false;
                }
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${student.fullName || 'N/A'}</div>
                            <div class="text-sm text-gray-500">ID: ${student.studentId || 'N/A'}</div>
                            <div class="text-sm text-gray-500">Class: ${student.classAssignment || 'N/A'}</div>
                            ${student.status ? `<div class="text-xs text-blue-600">Status: ${student.status}</div>` : ''}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${monthNames[student.displayMonth - 1]}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${student.displayYear}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">
                            <div>Courses: ${student.coursesCount || 0}</div>
                            <div>Lessons: ${student.attendedLessons || 0}</div>
                            <div>Length: <input type="number" step="0.5" value="${student.lessonLength || 1.5}" class="w-16 px-1 py-1 border rounded text-xs" onchange="updateStudentData('${student.id}', 'lessonLength', this.value)"></div>
                            <div>Hours: <span id="hours-${student.id}">${student.studyHours || 0}</span></div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <select class="w-full px-2 py-1 border rounded text-sm" onchange="updateStudentCoursePlan('${student.id}', this.value)" id="coursePlan-${student.id}">
                            <option value="">Select Plan</option>
                            ${coursePlans.map(plan => `<option value="${plan.id}" ${student.coursePlan === plan.id ? 'selected' : ''}>${plan.planName}</option>`).join('')}
                        </select>
                        <div id="planDetails-${student.id}" class="mt-2 text-xs text-gray-600 ${student.coursePlan ? '' : 'hidden'}">
                            <!-- Plan details will appear here -->
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900" id="calculated-${student.id}">${student.calculatedFee ? formatVNDFull(student.calculatedFee) : '0'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="relative">
                            <input type="number" step="0.01" placeholder="0" value="${student.adjustedFee ? (student.adjustedFee / 1000) : ''}" class="w-24 px-2 py-1 pr-10 border rounded text-sm" id="adjusted-${student.id}" onchange="updateAdjustedFee('${student.id}')">
                            <span class="absolute right-2 top-1 text-xs text-gray-500">.000</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="saveStudentTuition('${student.id}')" class="${saveButtonClass}" ${saveButtonDisabled ? 'disabled' : ''} id="save-${student.id}">${saveButtonText}</button>
                        <button onclick="informStudent('${student.id}')" class="${informButtonClass}" ${informButtonDisabled ? 'disabled' : ''} id="inform-${student.id}">${informButtonText}</button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Restore course plan details if saved
                if (student.coursePlan) {
                    setTimeout(() => {
                        updateStudentCoursePlan(student.id, student.coursePlan, true);
                    }, 100);
                }
            });
        }

        function updateStudentData(studentId, field, value) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                student[field] = parseFloat(value) || value;
                
                if (field === 'lessonLength') {
                    student.studyHours = student.attendedLessons * student.lessonLength;
                    document.getElementById(`hours-${studentId}`).textContent = student.studyHours;
                }
            }
        }

        function updateAdjustedFee(studentId) {
            const student = students.find(s => s.id === studentId);
            const adjustedInput = document.getElementById(`adjusted-${studentId}`);
            const saveBtn = document.getElementById(`save-${studentId}`);
            const informBtn = document.getElementById(`inform-${studentId}`);
            
            if (!student) return;
            
            const adjustedValue = parseVNDInput(adjustedInput.value);
            student.adjustedFee = adjustedValue;
            
            // Don't update button states if already informed
            if (student.status === 'informed') {
                return;
            }
            
            // Don't update button states if already saved (unless changing the adjusted fee)
            if (student.status === 'saved' && student.finalFee > 0) {
                // If changing adjusted fee after saving, enable save button again
                if (adjustedValue !== student.finalFee) {
                    saveBtn.disabled = false;
                    saveBtn.className = 'bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 mr-2';
                    saveBtn.textContent = 'Save';
                    
                    informBtn.disabled = true;
                    informBtn.className = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50';
                    informBtn.textContent = 'Inform';
                }
                return;
            }
            
            const hasCalculatedFee = student.calculatedFee > 0;
            const hasAdjustedFee = adjustedValue > 0;
            const hasFee = hasCalculatedFee || hasAdjustedFee;
            
            if (hasFee) {
                // Enable Save button
                saveBtn.disabled = false;
                saveBtn.className = 'bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 mr-2';
                saveBtn.textContent = 'Save';
                
                // Disable Inform button until saved
                informBtn.disabled = true;
                informBtn.className = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50';
                informBtn.textContent = 'Inform';
            } else {
                // Disable both buttons when no fee
                saveBtn.disabled = true;
                saveBtn.className = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50 mr-2';
                saveBtn.textContent = 'Save';
                
                informBtn.disabled = true;
                informBtn.className = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50';
                informBtn.textContent = 'Inform';
            }
        }

        function updateStudentCoursePlan(studentId, planId, isRestoring = false) {
            const student = students.find(s => s.id === studentId);
            const planDetailsDiv = document.getElementById(`planDetails-${studentId}`);
            const calculatedFeeDiv = document.getElementById(`calculated-${studentId}`);
            
            if (student) {
                student.coursePlan = planId;
                
                if (planId) {
                    const selectedPlan = coursePlans.find(p => p.id === planId);
                    if (selectedPlan) {
                        // Show plan details
                        planDetailsDiv.innerHTML = `
                            <div>Code: ${selectedPlan.planCode}</div>
                            <div>Courses: ${selectedPlan.numCourses} | Lessons: ${selectedPlan.numLessons}</div>
                            <div>Hours: ${selectedPlan.numHours} | Fee: ${formatVNDFull(selectedPlan.standardFee)}</div>
                        `;
                        planDetailsDiv.classList.remove('hidden');
                        
                        // Calculate fee based on plan (only if not restoring saved data)
                        let calculatedFee = 0;
                        if (isRestoring && student.calculatedFee > 0) {
                            // Use saved calculated fee when restoring
                            calculatedFee = student.calculatedFee;
                        } else {
                            // Calculate fresh fee
                            if (selectedPlan.numHours > 0) {
                                // Calculate based on hours ratio
                                const hourlyRate = selectedPlan.standardFee / selectedPlan.numHours;
                                calculatedFee = hourlyRate * student.studyHours;
                            } else if (selectedPlan.numLessons > 0) {
                                // Calculate based on lessons ratio
                                const lessonRate = selectedPlan.standardFee / selectedPlan.numLessons;
                                calculatedFee = lessonRate * student.attendedLessons;
                            } else {
                                // Use standard fee
                                calculatedFee = selectedPlan.standardFee;
                            }
                            
                            // Update student object with new calculated fee
                            student.calculatedFee = calculatedFee;
                        }
                        
                        calculatedFeeDiv.textContent = formatVNDFull(calculatedFee);
                        
                        // Update button states if there's a calculated fee and not restoring
                        if (!isRestoring && calculatedFee > 0) {
                            updateButtonStatesAfterCalculation(studentId);
                        }
                    }
                } else {
                    // Hide plan details and reset calculated fee
                    planDetailsDiv.classList.add('hidden');
                    calculatedFeeDiv.textContent = '0';
                    student.calculatedFee = 0;
                    
                    // Reset button states if not restoring
                    if (!isRestoring) {
                        updateButtonStatesAfterCalculation(studentId);
                    }
                }
            }
        }
        
        function updateButtonStatesAfterCalculation(studentId) {
            const student = students.find(s => s.id === studentId);
            const saveBtn = document.getElementById(`save-${studentId}`);
            const informBtn = document.getElementById(`inform-${studentId}`);
            const adjustedInput = document.getElementById(`adjusted-${studentId}`);
            
            if (!student || !saveBtn || !informBtn) return;
            
            const hasCalculatedFee = student.calculatedFee > 0;
            const hasAdjustedFee = parseVNDInput(adjustedInput.value) > 0;
            const hasFee = hasCalculatedFee || hasAdjustedFee;
            
            if (student.status === 'informed') {
                // Already informed - keep both disabled
                return;
            } else if (student.status === 'saved' && student.finalFee > 0) {
                // Already saved - keep save disabled, enable inform
                return;
            } else if (hasFee) {
                // Has fee data - enable save button
                saveBtn.disabled = false;
                saveBtn.className = 'bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 mr-2';
                saveBtn.textContent = 'Save';
                
                // Keep inform disabled until saved
                informBtn.disabled = true;
                informBtn.className = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50';
                informBtn.textContent = 'Inform';
            } else {
                // No fee data - disable both buttons
                saveBtn.disabled = true;
                saveBtn.className = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50 mr-2';
                saveBtn.textContent = 'Save';
                
                informBtn.disabled = true;
                informBtn.className = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50';
                informBtn.textContent = 'Inform';
            }
        }

        async function saveStudentTuition(studentId) {
            try {
                updateSyncStatus('syncing', 'Saving tuition...');
                
                const student = students.find(s => s.id === studentId);
                if (!student) return;
                
                // Use the display month/year from the student entry
                const currentMonth = student.displayMonth;
                const currentYear = student.displayYear;
                
                // Format document ID as tuition_studentID_yyyy-mm
                const monthStr = String(currentMonth).padStart(2, '0');
                const docId = `tuition_${student.studentId}_${currentYear}-${monthStr}`;
                
                const adjustedFee = parseVNDInput(document.getElementById(`adjusted-${studentId}`).value);
                const calculatedFee = student.calculatedFee || 0;
                const finalFee = adjustedFee > 0 ? adjustedFee : calculatedFee;
                
                const tuitionData = {
                    studentId: student.studentId,
                    fullName: student.fullName,
                    classAssignment: student.classAssignment,
                    month: currentMonth,
                    year: currentYear,
                    attendedLessons: student.attendedLessons,
                    coursesCount: student.coursesCount,
                    lessonLength: student.lessonLength,
                    studyHours: student.studyHours,
                    calculatedFee: calculatedFee,
                    adjustedFee: adjustedFee,
                    finalFee: finalFee,
                    coursePlan: student.coursePlan || null,
                    savedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'saved',
                    paid: false,
                    processed: false
                };
                
                // Use optimized update function
                await updateSingleRecord('tuition', docId, tuitionData, ['studentTuition', 'monthlyCalculation']);
                
                // Update student object with saved data
                student.calculatedFee = calculatedFee;
                student.adjustedFee = adjustedFee;
                student.finalFee = finalFee;
                student.status = 'saved';
                student.savedAt = new Date();
                
                // Update button states after saving
                const saveBtn = document.getElementById(`save-${studentId}`);
                const informBtn = document.getElementById(`inform-${studentId}`);
                
                // Save button becomes "Saved", grayed out and inactive
                saveBtn.disabled = true;
                saveBtn.className = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50 mr-2';
                saveBtn.textContent = 'Saved';
                
                // Inform button becomes active if there's a final fee
                if (finalFee > 0) {
                    informBtn.disabled = false;
                    informBtn.className = 'bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700';
                    informBtn.textContent = 'Inform';
                } else {
                    informBtn.disabled = true;
                    informBtn.className = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50';
                    informBtn.textContent = 'Inform';
                }
                
                // Update status display in the student info
                const studentInfoDiv = document.querySelector(`#save-${studentId}`).closest('tr').querySelector('.text-sm.font-medium.text-gray-900').parentElement;
                const existingStatus = studentInfoDiv.querySelector('.text-xs.text-blue-600');
                if (existingStatus) {
                    existingStatus.textContent = 'Status: saved';
                } else {
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'text-xs text-blue-600';
                    statusDiv.textContent = 'Status: saved';
                    studentInfoDiv.appendChild(statusDiv);
                }
                
                updateSyncStatus(isOnline ? 'connected' : 'offline', isOnline ? 'Tuition saved' : 'Tuition saved offline');
            } catch (error) {
                console.error('Error saving tuition:', error);
                updateSyncStatus('error', 'Save failed');
                alert('Error saving tuition: ' + error.message);
            }
        }

        async function informStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            try {
                updateSyncStatus('syncing', 'Informing student...');
                
                // Update tuition record to mark as informed
                const currentMonth = student.displayMonth;
                const currentYear = student.displayYear;
                const monthStr = String(currentMonth).padStart(2, '0');
                const docId = `tuition_${student.studentId}_${currentYear}-${monthStr}`;
                
                const updateData = {
                    status: 'informed',
                    informedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (isOnline) {
                    await db.collection('tuition').doc(docId).update(updateData);
                } else {
                    addPendingOperation({
                        type: 'update',
                        collection: 'tuition',
                        docId: docId,
                        data: updateData
                    });
                }
                
                // Update student object
                student.status = 'informed';
                student.informedAt = new Date();
                
                // Update button states after informing
                const saveBtn = document.getElementById(`save-${studentId}`);
                const informBtn = document.getElementById(`inform-${studentId}`);
                
                // Both buttons become inactive
                saveBtn.disabled = true;
                saveBtn.className = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50 mr-2';
                saveBtn.textContent = 'Saved';
                
                informBtn.disabled = true;
                informBtn.className = 'bg-gray-400 text-white px-3 py-1 rounded text-xs opacity-50';
                informBtn.textContent = 'Informed';
                
                // Update status display in the student info
                const studentInfoDiv = document.querySelector(`#save-${studentId}`).closest('tr').querySelector('.text-sm.font-medium.text-gray-900').parentElement;
                const existingStatus = studentInfoDiv.querySelector('.text-xs.text-blue-600');
                if (existingStatus) {
                    existingStatus.textContent = 'Status: informed';
                } else {
                    const statusDiv = document.createElement('div');
                    statusDiv.className = 'text-xs text-blue-600';
                    statusDiv.textContent = 'Status: informed';
                    studentInfoDiv.appendChild(statusDiv);
                }
                
                updateSyncStatus(isOnline ? 'connected' : 'offline', isOnline ? 'Student informed' : 'Inform status saved offline');
                
                // Show success message
                alert(`Tuition information sent to ${student.fullName}`);
                
            } catch (error) {
                console.error('Error informing student:', error);
                updateSyncStatus('error', 'Inform failed');
                alert('Error informing student: ' + error.message);
            }
        }

        // Load classes for filter dropdown
        async function loadClasses() {
            try {
                console.log('Loading classes (legacy function)...');
                // Use the cached version for consistency
                await loadTuitionClassesCached();
            } catch (error) {
                console.error('Error loading classes:', error);
                updateSyncStatus('error', 'Failed to load classes');
            }
        }

        // Student Tuition Management Functions
        async function loadStudentTuitionData(forceReload = false) {
            try {
                // Check cache first unless force reload
                if (!forceReload) {
                    const cachedData = getCacheData('studentTuition');
                    if (cachedData) {
                        allStudentTuition = cachedData;
                        await loadTuitionClasses();
                        filterStudentTuition();
                        return;
                    }
                }

                updateSyncStatus('syncing', 'Loading student tuition...');
                
                // Load all students
                const studentsSnapshot = await db.collection('students').get();
                allStudentTuition = [];
                
                for (const doc of studentsSnapshot.docs) {
                    const studentData = { id: doc.id, ...doc.data() };
                    
                    // Get enrollment year from student data or default to current year
                    const enrollmentYear = studentData.enrollmentYear || new Date().getFullYear();
                    
                    // Get the display year from filter or current year
                    const displayYear = parseInt(document.getElementById('tuitionYearFilter').value) || new Date().getFullYear();
                    
                    // Load tuition data for the display year
                    const tuitionData = await loadStudentYearlyTuition(studentData.studentId, displayYear);
                    
                    studentData.enrollmentYear = enrollmentYear;
                    studentData.tuitionData = tuitionData;
                    
                    allStudentTuition.push(studentData);
                }
                
                // Cache the data
                setCacheData('studentTuition', allStudentTuition);

                // Load classes for filter
                await loadTuitionClasses();
                
                // Apply initial filters and render
                filterStudentTuition();
                
                updateSyncStatus(isOnline ? 'connected' : 'offline');
            } catch (error) {
                console.error('Error loading student tuition:', error);
                updateSyncStatus('error', 'Load failed');
                allStudentTuition = []; // Reset on error
                filterStudentTuition(); // Show empty state
            }
        }

        async function loadStudentYearlyTuition(studentId, year) {
            try {
                console.log(`Loading tuition data for student ${studentId}, year ${year}`);
                
                // Query tuition records for the specific student and year
                const tuitionSnapshot = await db.collection('tuition')
                    .where('studentId', '==', studentId)
                    .where('year', '==', parseInt(year))
                    .get();
                
                console.log(`Found ${tuitionSnapshot.size} tuition records for student ${studentId}`);
                
                const monthlyData = {};
                let totalExpected = 0;
                let totalPaid = 0;
                
                tuitionSnapshot.forEach(doc => {
                    const data = doc.data();
                    console.log(`Processing tuition record:`, data);
                    
                    const month = parseInt(data.month);
                    
                    if (month >= 1 && month <= 12) {
                        // Try different field names for fee
                        const fee = data.finalFee || data.adjustedFee || data.calculatedFee || data.fee || data.standardFee || 0;
                        const isPaid = data.paid === true;
                        const isProcessed = data.processed === true;
                        
                        monthlyData[month] = {
                            fee: fee,
                            paid: isPaid,
                            processed: isProcessed,
                            paymentDate: data.paymentDate || null,
                            status: data.status || (fee > 0 ? 'informed' : 'no_fee'),
                            docId: doc.id
                        };
                        
                        totalExpected += fee;
                        if (isPaid) {
                            totalPaid += fee;
                        }
                    }
                });
                
                console.log(`Student ${studentId} summary: Expected=${totalExpected}, Paid=${totalPaid}, Monthly data:`, monthlyData);
                
                return {
                    monthlyData,
                    totalExpected,
                    totalPaid,
                    outstanding: totalExpected - totalPaid
                };
            } catch (error) {
                console.error('Error loading yearly tuition for student', studentId, 'year', year, ':', error);
                return {
                    monthlyData: {},
                    totalExpected: 0,
                    totalPaid: 0,
                    outstanding: 0
                };
            }
        }

        async function loadTuitionClasses() {
            try {
                const snapshot = await db.collection('classes').get();
                const classFilter = document.getElementById('tuitionClassFilter');
                
                // Clear existing options except "All Classes"
                classFilter.innerHTML = '<option value="">All Classes</option>';
                
                snapshot.forEach(doc => {
                    const classData = doc.data();
                    const option = document.createElement('option');
                    option.value = classData.classCode || doc.id;
                    option.textContent = classData.className || classData.classCode || doc.id;
                    classFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        async function filterStudentTuition() {
            const searchTerm = normalizeVietnamese(document.getElementById('studentSearch').value);
            const yearFilter = document.getElementById('tuitionYearFilter').value;
            const classFilter = document.getElementById('tuitionClassFilter').value;
            const statusFilter = document.getElementById('tuitionStatusFilter').value;
            const sortBy = document.getElementById('tuitionSortBy').value;
            
            const displayYear = yearFilter ? parseInt(yearFilter) : new Date().getFullYear();
            
            // If year filter changed, reload tuition data for all students
            const needsReload = allStudentTuition.length > 0 && 
                allStudentTuition[0].tuitionData && 
                allStudentTuition[0].lastLoadedYear !== displayYear;
            
            if (needsReload) {
                updateSyncStatus('syncing', 'Loading tuition data...');
                
                // Reload tuition data for the new year
                for (const student of allStudentTuition) {
                    student.tuitionData = await loadStudentYearlyTuition(student.studentId, displayYear);
                    student.lastLoadedYear = displayYear;
                }
                
                updateSyncStatus(isOnline ? 'connected' : 'offline');
            }
            
            let filteredStudents = allStudentTuition.filter(student => {
                // Search filter with Vietnamese normalization
                const matchesSearch = !searchTerm || 
                    normalizeVietnamese(student.fullName || '').includes(searchTerm) ||
                    normalizeVietnamese(student.studentId || '').includes(searchTerm);
                
                // Year filter - show data from enrollment year onwards
                const matchesYear = !yearFilter || student.enrollmentYear <= displayYear;
                
                // Class filter
                const matchesClass = !classFilter || student.classAssignment === classFilter;
                
                // Status filter
                const matchesStatus = !statusFilter || student.status === statusFilter;
                
                // Status-based year limit: if student is not active, don't show beyond finished/dropped year
                const isActiveStatus = student.status === 'Active' || student.status === 'Inactive';
                const finishedYear = student.finishedYear || new Date().getFullYear();
                const shouldShowYear = isActiveStatus || displayYear <= finishedYear;
                
                return matchesSearch && matchesYear && matchesClass && matchesStatus && shouldShowYear;
            });
            
            // Sort students
            filteredStudents.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return (a.fullName || '').localeCompare(b.fullName || '');
                    case 'studentId':
                        return (a.studentId || '').localeCompare(b.studentId || '');
                    case 'class':
                        return (a.classAssignment || '').localeCompare(b.classAssignment || '');
                    case 'enrollmentYear':
                        return (a.enrollmentYear || 0) - (b.enrollmentYear || 0);
                    default:
                        return 0;
                }
            });
            
            renderStudentTuitionTable(filteredStudents, displayYear);
        }

        function renderStudentTuitionTable(students, displayYear) {
            const tbody = document.getElementById('studentTuitionTableBody');
            tbody.innerHTML = '';
            
            console.log(`Rendering ${students.length} students for year ${displayYear}`);
            
            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="15" class="px-6 py-8 text-center text-gray-500">
                            No students found for the selected criteria
                        </td>
                    </tr>
                `;
                return;
            }
            
            students.forEach((student, index) => {
                console.log(`Rendering student ${index + 1}:`, {
                    name: student.fullName,
                    id: student.studentId,
                    tuitionData: student.tuitionData ? 'Present' : 'Missing',
                    monthlyDataCount: student.tuitionData?.monthlyData ? Object.keys(student.tuitionData.monthlyData).length : 0
                });
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => openStudentTuitionModal(student);
                
                // Get tuition data for display year
                const yearTuition = student.tuitionData?.monthlyData || {};
                
                // Generate monthly cells
                let monthlyCells = '';
                for (let month = 1; month <= 12; month++) {
                    const monthData = yearTuition[month];
                    let cellClass = 'px-1 py-2 text-center text-xs';
                    let cellContent = '-';
                    
                    if (monthData) {
                        const fee = monthData.fee;
                        if (fee > 0) {
                            if (editMode) {
                                // In edit mode, show input field
                                cellContent = `<input type="number" value="${fee / 1000}" class="w-12 px-1 py-1 text-xs border rounded text-center" onchange="updateTuitionFee('${student.studentId}', ${month}, ${displayYear}, this.value)" onclick="event.stopPropagation()">`;
                            } else {
                                // In view mode, show short format
                                cellContent = formatVNDShort(fee);
                            }
                            
                            // Color coding based on status
                            switch (monthData.status) {
                                case 'processed':
                                    cellClass += ' bg-green-100 text-green-800';
                                    break;
                                case 'paid':
                                    cellClass += ' bg-yellow-100 text-yellow-800';
                                    break;
                                case 'informed':
                                case 'saved':
                                    cellClass += ' bg-red-100 text-red-800';
                                    break;
                                default:
                                    cellClass += ' bg-gray-100 text-gray-600';
                            }
                        } else {
                            cellClass += ' bg-gray-100 text-gray-600';
                        }
                    } else {
                        cellClass += ' bg-gray-50 text-gray-400';
                        if (editMode) {
                            cellContent = `<input type="number" value="0" class="w-12 px-1 py-1 text-xs border rounded text-center" onchange="updateTuitionFee('${student.studentId}', ${month}, ${displayYear}, this.value)" onclick="event.stopPropagation()">`;
                        }
                    }
                    
                    monthlyCells += `<td class="${cellClass}">${cellContent}</td>`;
                }
                
                // Calculate summary
                const totalExpected = student.tuitionData?.totalExpected || 0;
                const totalPaid = student.tuitionData?.totalPaid || 0;
                const outstanding = totalExpected - totalPaid;
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${student.fullName || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${student.classAssignment || 'N/A'}</div>
                            <div class="text-xs text-gray-400">ID: ${student.studentId || 'N/A'}</div>
                            <div class="text-xs text-gray-400">${student.status || 'N/A'} (${student.enrollmentYear || 'N/A'})</div>
                        </div>
                    </td>
                    ${monthlyCells}
                    <td class="px-2 py-3 whitespace-nowrap text-xs">
                        <div class="space-y-1">
                            <div>Total: <span class="font-medium">${formatVNDFull(totalExpected)}</span></div>
                            <div>Paid: <span class="text-green-600 font-medium">${formatVNDFull(totalPaid)}</span></div>
                            <div>Outstanding: <span class="text-red-600 font-medium">${formatVNDFull(outstanding)}</span></div>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <button onclick="event.stopPropagation(); deleteStudentTuition('${student.id}')" class="text-red-600 hover:text-red-800">
                            Delete
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function openStudentTuitionModal(student) {
            currentModalStudent = student;
            
            // Populate basic info
            document.getElementById('modalStudentName').textContent = student.fullName || 'N/A';
            document.getElementById('modalStudentId').textContent = student.studentId || 'N/A';
            document.getElementById('modalStudentClass').textContent = student.classAssignment || 'N/A';
            document.getElementById('modalStudentStatus').textContent = student.status || 'N/A';
            
            // Set year to current year or enrollment year
            const currentYear = new Date().getFullYear();
            document.getElementById('modalYearSelect').value = currentYear;
            
            // Load tuition details
            loadStudentTuitionDetails();
            
            // Show modal
            document.getElementById('studentTuitionModal').classList.remove('hidden');
        }

        async function loadStudentTuitionDetails() {
            if (!currentModalStudent) return;
            
            const selectedYear = parseInt(document.getElementById('modalYearSelect').value);
            
            try {
                // Load tuition data for selected year
                const tuitionData = await loadStudentYearlyTuition(currentModalStudent.studentId, selectedYear);
                
                // Update summary
                document.getElementById('modalTotalExpected').textContent = formatVNDFull(tuitionData.totalExpected);
                document.getElementById('modalTotalPaid').textContent = formatVNDFull(tuitionData.totalPaid);
                document.getElementById('modalOutstanding').textContent = formatVNDFull(tuitionData.outstanding);
                
                // Load notes
                const notesDoc = await db.collection('studentNotes').doc(`${currentModalStudent.studentId}_${selectedYear}`).get();
                document.getElementById('modalNotes').value = notesDoc.exists ? notesDoc.data().notes || '' : '';
                
                // Render monthly details
                renderModalMonthlyDetails(tuitionData.monthlyData, selectedYear);
                
            } catch (error) {
                console.error('Error loading student tuition details:', error);
            }
        }

        function renderModalMonthlyDetails(monthlyData, year) {
            const container = document.getElementById('modalMonthlyDetails');
            container.innerHTML = '';
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            for (let month = 1; month <= 12; month++) {
                const monthData = monthlyData[month] || {};
                const fee = monthData.fee || 0;
                const paid = monthData.paid || false;
                const processed = monthData.processed || false;
                const paymentDate = monthData.paymentDate || '';
                
                // Determine card color based on fee, paid, and processed status
                let cardClass = 'border rounded-lg p-3';
                let headerClass = 'font-medium text-sm mb-2';
                
                if (fee > 0) {
                    if (processed) {
                        // Processed: Green
                        cardClass += ' bg-green-50 border-green-200';
                        headerClass += ' text-green-800';
                    } else if (paid) {
                        // Paid but not processed: Yellow
                        cardClass += ' bg-yellow-50 border-yellow-200';
                        headerClass += ' text-yellow-800';
                    } else {
                        // Fee set but not paid: Red
                        cardClass += ' bg-red-50 border-red-200';
                        headerClass += ' text-red-800';
                    }
                } else {
                    // No fee: Gray
                    cardClass += ' bg-gray-50 border-gray-200';
                    headerClass += ' text-gray-500';
                }
                
                const monthCard = document.createElement('div');
                monthCard.className = cardClass;
                monthCard.innerHTML = `
                    <div class="${headerClass}">${monthNames[month - 1]} ${year}</div>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs text-gray-600">Fee</label>
                            <div class="relative">
                                <input type="number" step="0.01" value="${fee / 1000}" 
                                       class="w-full px-2 py-1 pr-8 border rounded text-sm" 
                                       onchange="updateModalMonthFee(${month}, this.value)">
                                <span class="absolute right-2 top-1 text-xs text-gray-500">.000</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center space-x-1">
                                <input type="checkbox" ${paid ? 'checked' : ''} 
                                       ${fee <= 0 ? 'disabled' : ''}
                                       onchange="updateModalMonthPaid(${month}, this.checked)"
                                       class="rounded" id="paid_${month}">
                                <label class="text-xs text-gray-600">Paid</label>
                            </div>
                            <div class="flex items-center space-x-1">
                                <input type="checkbox" ${processed ? 'checked' : ''} 
                                       ${!paid || fee <= 0 ? 'disabled' : ''}
                                       onchange="updateModalMonthProcessed(${month}, this.checked)"
                                       class="rounded" id="processed_${month}">
                                <label class="text-xs text-gray-600">Processed</label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600">Payment Date</label>
                            <input type="date" value="${paymentDate}" 
                                   ${fee <= 0 ? 'disabled' : ''}
                                   class="w-full px-2 py-1 border rounded text-sm" 
                                   onchange="updateModalPaymentDate(${month}, this.value)"
                                   id="paymentDate_${month}">
                        </div>
                    </div>
                `;
                
                container.appendChild(monthCard);
            }
        }

        function updateModalMonthFee(month, inputValue) {
            // Store the change temporarily
            if (!currentModalStudent.tempChanges) {
                currentModalStudent.tempChanges = {};
            }
            if (!currentModalStudent.tempChanges[month]) {
                currentModalStudent.tempChanges[month] = {};
            }
            
            const fee = parseVNDInput(inputValue);
            currentModalStudent.tempChanges[month].fee = fee;
            
            // If fee is removed (0), clear all checkboxes and date
            if (fee <= 0) {
                currentModalStudent.tempChanges[month].paid = false;
                currentModalStudent.tempChanges[month].processed = false;
                currentModalStudent.tempChanges[month].paymentDate = '';
                
                // Update UI elements
                document.getElementById(`paid_${month}`).checked = false;
                document.getElementById(`paid_${month}`).disabled = true;
                document.getElementById(`processed_${month}`).checked = false;
                document.getElementById(`processed_${month}`).disabled = true;
                document.getElementById(`paymentDate_${month}`).value = '';
                document.getElementById(`paymentDate_${month}`).disabled = true;
            } else {
                // Enable paid checkbox and date when fee is set
                document.getElementById(`paid_${month}`).disabled = false;
                document.getElementById(`paymentDate_${month}`).disabled = false;
            }
            
            // Update the card appearance immediately
            updateModalCardAppearance(month);
        }

        function updateModalMonthPaid(month, paid) {
            if (!currentModalStudent.tempChanges) {
                currentModalStudent.tempChanges = {};
            }
            if (!currentModalStudent.tempChanges[month]) {
                currentModalStudent.tempChanges[month] = {};
            }
            currentModalStudent.tempChanges[month].paid = paid;
            
            if (paid) {
                // If marking as paid, set payment date to today if not already set
                if (!currentModalStudent.tempChanges[month].paymentDate) {
                    currentModalStudent.tempChanges[month].paymentDate = new Date().toISOString().split('T')[0];
                    document.getElementById(`paymentDate_${month}`).value = currentModalStudent.tempChanges[month].paymentDate;
                }
                // Enable processed checkbox
                document.getElementById(`processed_${month}`).disabled = false;
            } else {
                // If unmarking as paid, clear payment date and processed status
                currentModalStudent.tempChanges[month].paymentDate = '';
                currentModalStudent.tempChanges[month].processed = false;
                document.getElementById(`paymentDate_${month}`).value = '';
                document.getElementById(`processed_${month}`).checked = false;
                document.getElementById(`processed_${month}`).disabled = true;
            }
            
            // Update the card appearance immediately
            updateModalCardAppearance(month);
        }

        function updateModalMonthProcessed(month, processed) {
            if (!currentModalStudent.tempChanges) {
                currentModalStudent.tempChanges = {};
            }
            if (!currentModalStudent.tempChanges[month]) {
                currentModalStudent.tempChanges[month] = {};
            }
            currentModalStudent.tempChanges[month].processed = processed;
            
            // Update the card appearance immediately
            updateModalCardAppearance(month);
        }

        function updateModalPaymentDate(month, date) {
            if (!currentModalStudent.tempChanges) {
                currentModalStudent.tempChanges = {};
            }
            if (!currentModalStudent.tempChanges[month]) {
                currentModalStudent.tempChanges[month] = {};
            }
            currentModalStudent.tempChanges[month].paymentDate = date;
        }

        function updateModalCardAppearance(month) {
            // Find the card for this month and update its appearance
            const cards = document.querySelectorAll('#modalMonthlyDetails > div');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const selectedYear = parseInt(document.getElementById('modalYearSelect').value);
            
            cards.forEach(card => {
                const headerText = card.querySelector('.font-medium').textContent;
                if (headerText.includes(monthNames[month - 1]) && headerText.includes(selectedYear.toString())) {
                    // Get current values
                    const currentData = currentModalStudent.tuitionData?.monthlyData[month] || {};
                    const tempChanges = currentModalStudent.tempChanges?.[month] || {};
                    
                    const fee = tempChanges.fee !== undefined ? tempChanges.fee : (currentData.fee || 0);
                    const paid = tempChanges.paid !== undefined ? tempChanges.paid : (currentData.paid || false);
                    const processed = tempChanges.processed !== undefined ? tempChanges.processed : (currentData.processed || false);
                    
                    // Update card classes based on new logic
                    let cardClass = 'border rounded-lg p-3';
                    let headerClass = 'font-medium text-sm mb-2';
                    
                    if (fee > 0) {
                        if (processed) {
                            // Processed: Green
                            cardClass += ' bg-green-50 border-green-200';
                            headerClass += ' text-green-800';
                        } else if (paid) {
                            // Paid but not processed: Yellow
                            cardClass += ' bg-yellow-50 border-yellow-200';
                            headerClass += ' text-yellow-800';
                        } else {
                            // Fee set but not paid: Red
                            cardClass += ' bg-red-50 border-red-200';
                            headerClass += ' text-red-800';
                        }
                    } else {
                        // No fee: Gray
                        cardClass += ' bg-gray-50 border-gray-200';
                        headerClass += ' text-gray-500';
                    }
                    
                    card.className = cardClass;
                    card.querySelector('.font-medium').className = headerClass;
                }
            });
        }

        async function saveStudentTuitionDetails() {
            if (!currentModalStudent) return;
            
            try {
                updateSyncStatus('syncing', 'Saving changes...');
                
                const selectedYear = parseInt(document.getElementById('modalYearSelect').value);
                const notes = document.getElementById('modalNotes').value;
                
                // Save notes
                if (notes.trim()) {
                    const notesData = {
                        studentId: currentModalStudent.studentId,
                        year: selectedYear,
                        notes: notes,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    if (isOnline) {
                        await db.collection('studentNotes').doc(`${currentModalStudent.studentId}_${selectedYear}`).set(notesData);
                    } else {
                        addPendingOperation({
                            type: 'create',
                            collection: 'studentNotes',
                            docId: `${currentModalStudent.studentId}_${selectedYear}`,
                            data: notesData
                        });
                    }
                }
                
                // Save monthly changes and create payment transactions
                const newTransactions = [];
                if (currentModalStudent.tempChanges) {
                    for (const [month, changes] of Object.entries(currentModalStudent.tempChanges)) {
                        const monthStr = String(month).padStart(2, '0');
                        const docId = `tuition_${currentModalStudent.studentId}_${selectedYear}-${monthStr}`;
                        
                        const updateData = {
                            studentId: currentModalStudent.studentId,
                            fullName: currentModalStudent.fullName,
                            classAssignment: currentModalStudent.classAssignment,
                            month: parseInt(month),
                            year: selectedYear,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        if (changes.fee !== undefined) {
                            updateData.finalFee = changes.fee;
                            updateData.calculatedFee = changes.fee;
                            updateData.status = changes.fee > 0 ? 'saved' : 'no_fee';
                        }
                        
                        if (changes.paid !== undefined) {
                            updateData.paid = changes.paid;
                            if (changes.paid) {
                                updateData.status = 'paid';
                                updateData.paymentDate = changes.paymentDate || new Date().toISOString().split('T')[0];
                            }
                        }
                        
                        if (changes.processed !== undefined) {
                            updateData.processed = changes.processed;
                            if (changes.processed) {
                                updateData.status = 'processed';
                            }
                        }
                        
                        if (changes.paymentDate !== undefined) {
                            updateData.paymentDate = changes.paymentDate;
                        }
                        
                        // Use optimized update function
                        await updateSingleRecord('tuition', docId, updateData, ['studentTuition']);
                        
                        // Create/update transaction record when marking as paid or processed
                        if (changes.paid && !currentModalStudent.tuitionData?.monthlyData[month]?.paid) {
                            const fee = changes.fee !== undefined ? changes.fee : (currentModalStudent.tuitionData?.monthlyData[month]?.fee || 0);
                            
                            if (fee > 0) {
                                // Generate document ID: txn_YYYYMMDD_studentId_YYYYMM_timestamp
                                const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                                const monthStr = String(month).padStart(2, '0');
                                const timestamp = Date.now();
                                const txnDocId = `txn_${dateStr}_${currentModalStudent.studentId}_${selectedYear}${monthStr}_${timestamp}`;
                                
                                const transactionData = {
                                    paymentDate: new Date(changes.paymentDate || new Date().toISOString().split('T')[0]),
                                    studentId: currentModalStudent.studentId,
                                    studentName: currentModalStudent.fullName,
                                    classAssignment: currentModalStudent.classAssignment,
                                    tuitionYear: selectedYear,
                                    tuitionMonth: parseInt(month),
                                    amountPaid: fee,
                                    paymentStatus: changes.processed ? 'processed' : 'received',
                                    recordedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    recordedBy: 'tuition_board',
                                    source: 'tuition_modal',
                                    transactionType: 'tuition_payment'
                                };
                                
                                // Use optimized update function for payment transactions
                                await updateSingleRecord('paymentTransactions', txnDocId, transactionData, ['payments']);
                                newTransactions.push(transactionData);
                            }
                        } else if (changes.processed !== undefined && currentModalStudent.tuitionData?.monthlyData[month]?.paid) {
                            // Update existing transaction status when processed status changes
                            const existingTransactions = await db.collection('paymentTransactions')
                                .where('studentId', '==', currentModalStudent.studentId)
                                .where('tuitionYear', '==', selectedYear)
                                .where('tuitionMonth', '==', parseInt(month))
                                .get();
                            
                            existingTransactions.forEach(async (doc) => {
                                const newStatus = changes.processed ? 'processed' : 'received';
                                await updateSingleRecord('paymentTransactions', doc.id, {
                                    paymentStatus: newStatus,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                }, ['payments']);
                            });
                        }
                    }
                }
                
                // Update local cache for new transactions
                if (newTransactions.length > 0 && dataCache.payments.data) {
                    newTransactions.forEach(transaction => {
                        dataCache.payments.data.unshift(transaction); // Add to beginning for newest first
                    });
                    saveCacheToStorage();
                }
                
                // Clear temp changes
                currentModalStudent.tempChanges = {};
                
                // Refresh affected views
                await refreshAffectedViews(['studentTuition', 'payments']);
                
                // Close modal after successful save
                closeStudentTuitionModal();
                
                updateSyncStatus(isOnline ? 'connected' : 'offline', isOnline ? 'Changes saved' : 'Changes saved offline');
            } catch (error) {
                console.error('Error saving tuition details:', error);
                updateSyncStatus('error', 'Save failed');
                alert('Error saving changes: ' + error.message);
            }
        }

        function closeStudentTuitionModal() {
            document.getElementById('studentTuitionModal').classList.add('hidden');
            currentModalStudent = null;
        }

        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('editModeBtn');
            
            if (editMode) {
                btn.textContent = 'Exit Edit Mode';
                btn.className = 'px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm';
            } else {
                btn.textContent = 'Enable Edit Mode';
                btn.className = 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm';
            }
            
            // Re-render table with edit mode
            filterStudentTuition();
        }

        // Payment Tracker Functions
        async function loadPaymentTracker(forceReload = false) {
            try {
                // Check cache first unless force reload
                if (!forceReload) {
                    const cachedData = getCacheData('payments');
                    if (cachedData) {
                        allPayments = cachedData.payments;
                        allStudentsForSearch = cachedData.studentsForSearch;
                        filterPayments();
                        return;
                    }
                }

                updateSyncStatus('syncing', 'Loading payments...');
                console.log('Starting to load payment transactions...');
                
                // Try to load payment transactions, but handle if collection doesn't exist
                let paymentsSnapshot;
                try {
                    paymentsSnapshot = await db.collection('paymentTransactions')
                        .orderBy('paymentDate', 'desc')
                        .get();
                } catch (orderError) {
                    console.log('No orderBy index, loading without ordering...');
                    paymentsSnapshot = await db.collection('paymentTransactions').get();
                }
                
                allPayments = [];
                
                console.log(`Found ${paymentsSnapshot.size} payment documents`);
                
                paymentsSnapshot.forEach(doc => {
                    try {
                        const data = doc.data();
                        console.log('Processing payment document:', doc.id, data);
                        
                        // Handle different date formats
                        let paymentDate;
                        if (data.paymentDate) {
                            if (data.paymentDate.toDate) {
                                // Firestore Timestamp
                                paymentDate = data.paymentDate.toDate();
                            } else if (typeof data.paymentDate === 'string') {
                                // String date
                                paymentDate = new Date(data.paymentDate);
                            } else {
                                // Already a Date object
                                paymentDate = data.paymentDate;
                            }
                        } else {
                            paymentDate = new Date(); // Default to current date
                        }
                        
                        // Validate required fields - be more lenient
                        if (data.studentId && (data.amountPaid || data.amount)) {
                            allPayments.push({
                                id: doc.id,
                                paymentDate: paymentDate,
                                studentId: data.studentId,
                                studentName: data.studentName || data.fullName || data.name || 'Unknown',
                                classAssignment: data.classAssignment || data.class || 'N/A',
                                tuitionYear: parseInt(data.tuitionYear || data.year) || new Date().getFullYear(),
                                tuitionMonth: parseInt(data.tuitionMonth || data.month) || 1,
                                amountPaid: parseFloat(data.amountPaid || data.amount) || 0,
                                paymentStatus: data.paymentStatus || data.status || 'received',
                                recordedAt: data.recordedAt || data.createdAt,
                                recordedBy: data.recordedBy || 'system',
                                source: data.source || 'manual',
                                transactionType: data.transactionType || 'tuition_payment'
                            });
                        } else {
                            console.log('Skipping document due to missing required fields:', doc.id);
                        }
                    } catch (docError) {
                        console.warn('Error processing payment document:', doc.id, docError);
                    }
                });
                
                console.log(`Successfully loaded ${allPayments.length} payment transactions`);
                
                // Load students for search
                await loadStudentsForSearch();

                // Cache the data
                setCacheData('payments', {
                    payments: allPayments,
                    studentsForSearch: allStudentsForSearch
                });
                
                // Apply filters and render
                filterPayments();
                
                updateSyncStatus(isOnline ? 'connected' : 'offline');
            } catch (error) {
                console.error('Error loading payments:', error);
                updateSyncStatus('error', 'Load failed');
                allPayments = []; // Reset on error
                filterPayments(); // Show empty state
            }
        }

        async function loadStudentsForSearch() {
            try {
                const studentsSnapshot = await db.collection('students').get();
                allStudentsForSearch = [];
                
                studentsSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Only include students with required fields
                    if (data.studentId && data.fullName) {
                        allStudentsForSearch.push({
                            id: doc.id,
                            studentId: data.studentId,
                            fullName: data.fullName,
                            classAssignment: data.classAssignment || 'N/A',
                            status: data.status || 'Active'
                        });
                    }
                });
                
                // Sort students by name for better UX
                allStudentsForSearch.sort((a, b) => (a.fullName || '').localeCompare(b.fullName || ''));
                
                console.log(`Loaded ${allStudentsForSearch.length} students for search`);
            } catch (error) {
                console.error('Error loading students for search:', error);
                allStudentsForSearch = []; // Reset on error
            }
        }

        function addPaymentRow() {
            const tbody = document.getElementById('paymentRecordsTable');
            const row = document.createElement('tr');
            paymentRowCounter++;
            
            row.innerHTML = `
                <td class="px-4 py-2">
                    <input type="date" class="w-full px-2 py-1 border rounded text-sm" value="${new Date().toISOString().split('T')[0]}" id="paymentDate_${paymentRowCounter}">
                </td>
                <td class="px-4 py-2">
                    <div class="relative">
                        <input type="text" 
                               class="w-full px-2 py-1 border rounded text-sm" 
                               id="studentSearch_${paymentRowCounter}" 
                               placeholder="Search by name or ID..."
                               onkeyup="searchStudents(${paymentRowCounter})"
                               onfocus="showStudentDropdown(${paymentRowCounter})"
                               onblur="hideStudentDropdown(${paymentRowCounter})">
                        <input type="hidden" id="student_${paymentRowCounter}" onchange="updateOutstanding(${paymentRowCounter})">
                        <div id="studentDropdown_${paymentRowCounter}" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg max-h-40 overflow-y-auto hidden">
                            <!-- Student options will be populated here -->
                        </div>
                    </div>
                </td>
                <td class="px-4 py-2">
                    <select class="w-full px-2 py-1 border rounded text-sm" id="tuitionYear_${paymentRowCounter}" onchange="updateOutstanding(${paymentRowCounter})">
                        <option value="">Select Year</option>
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>
                        <option value="2029">2029</option>
                        <option value="2030">2030</option>
                    </select>
                </td>
                <td class="px-4 py-2">
                    <select class="w-full px-2 py-1 border rounded text-sm" id="tuitionMonth_${paymentRowCounter}" onchange="updateOutstanding(${paymentRowCounter})">
                        <option value="">Select Month</option>
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </td>
                <td class="px-4 py-2">
                    <div class="text-sm text-gray-600" id="outstanding_${paymentRowCounter}">-</div>
                </td>
                <td class="px-4 py-2">
                    <div class="relative">
                        <input type="number" step="0.01" placeholder="0" class="w-20 px-2 py-1 pr-8 border rounded text-sm" id="amountPaid_${paymentRowCounter}">
                        <span class="absolute right-2 top-1 text-xs text-gray-500">.000</span>
                    </div>
                </td>
                <td class="px-4 py-2">
                    <select class="w-full px-2 py-1 border rounded text-sm" id="paymentStatus_${paymentRowCounter}">
                        <option value="received">Received</option>
                        <option value="processed">Processed</option>
                    </select>
                </td>
                <td class="px-4 py-2">
                    <button onclick="removePaymentRow(this)" class="text-red-600 hover:text-red-800 text-sm">Remove</button>
                </td>
            `;
            
            tbody.appendChild(row);
        }

        function removePaymentRow(button) {
            button.closest('tr').remove();
        }

        function searchStudents(rowId) {
            const searchInput = document.getElementById(`studentSearch_${rowId}`);
            const dropdown = document.getElementById(`studentDropdown_${rowId}`);
            const searchTerm = normalizeVietnamese(searchInput.value.toLowerCase());
            
            if (searchTerm.length < 1) {
                dropdown.innerHTML = '';
                dropdown.classList.add('hidden');
                return;
            }
            
            const filteredStudents = allStudentsForSearch.filter(student => {
                const nameMatch = normalizeVietnamese(student.fullName.toLowerCase()).includes(searchTerm);
                const idMatch = student.studentId.toLowerCase().includes(searchTerm);
                return nameMatch || idMatch;
            });
            
            dropdown.innerHTML = '';
            
            if (filteredStudents.length === 0) {
                dropdown.innerHTML = '<div class="px-3 py-2 text-gray-500 text-sm">No students found</div>';
            } else {
                filteredStudents.slice(0, 10).forEach(student => { // Limit to 10 results
                    const option = document.createElement('div');
                    option.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                    option.innerHTML = `
                        <div class="font-medium">${student.fullName}</div>
                        <div class="text-xs text-gray-500">ID: ${student.studentId} | Class: ${student.classAssignment}</div>
                    `;
                    option.onmousedown = () => selectStudent(rowId, student);
                    dropdown.appendChild(option);
                });
            }
            
            dropdown.classList.remove('hidden');
        }
        
        function showStudentDropdown(rowId) {
            const dropdown = document.getElementById(`studentDropdown_${rowId}`);
            const searchInput = document.getElementById(`studentSearch_${rowId}`);
            
            if (searchInput.value.length > 0) {
                searchStudents(rowId);
            } else {
                // Show all students when focused with no search term
                dropdown.innerHTML = '';
                allStudentsForSearch.slice(0, 10).forEach(student => {
                    const option = document.createElement('div');
                    option.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                    option.innerHTML = `
                        <div class="font-medium">${student.fullName}</div>
                        <div class="text-xs text-gray-500">ID: ${student.studentId} | Class: ${student.classAssignment}</div>
                    `;
                    option.onmousedown = () => selectStudent(rowId, student);
                    dropdown.appendChild(option);
                });
                dropdown.classList.remove('hidden');
            }
        }
        
        function hideStudentDropdown(rowId) {
            setTimeout(() => {
                const dropdown = document.getElementById(`studentDropdown_${rowId}`);
                dropdown.classList.add('hidden');
            }, 200); // Delay to allow click events to fire
        }
        
        function selectStudent(rowId, student) {
            const searchInput = document.getElementById(`studentSearch_${rowId}`);
            const hiddenInput = document.getElementById(`student_${rowId}`);
            const dropdown = document.getElementById(`studentDropdown_${rowId}`);
            
            searchInput.value = `${student.fullName} (${student.studentId})`;
            hiddenInput.value = student.studentId;
            dropdown.classList.add('hidden');
            
            // Trigger outstanding update
            updateOutstanding(rowId);
        }

        async function updateOutstanding(rowId) {
            const studentId = document.getElementById(`student_${rowId}`).value;
            const year = document.getElementById(`tuitionYear_${rowId}`).value;
            const month = document.getElementById(`tuitionMonth_${rowId}`).value;
            const outstandingDiv = document.getElementById(`outstanding_${rowId}`);
            
            if (!studentId || !year || !month) {
                outstandingDiv.textContent = '-';
                return;
            }
            
            try {
                // Get tuition record for this student/month/year
                const monthStr = String(month).padStart(2, '0');
                const docId = `tuition_${studentId}_${year}-${monthStr}`;
                
                const tuitionDoc = await db.collection('tuition').doc(docId).get();
                
                if (tuitionDoc.exists) {
                    const data = tuitionDoc.data();
                    const finalFee = data.finalFee || data.calculatedFee || 0;
                    const paid = data.paid || false;
                    
                    if (paid) {
                        outstandingDiv.innerHTML = '<span class="text-green-600">Paid</span>';
                    } else if (finalFee > 0) {
                        outstandingDiv.textContent = formatVNDFull(finalFee);
                    } else {
                        outstandingDiv.innerHTML = '<span class="text-gray-500">No fee</span>';
                    }
                } else {
                    outstandingDiv.innerHTML = '<span class="text-gray-500">No record</span>';
                }
            } catch (error) {
                console.error('Error getting outstanding amount:', error);
                outstandingDiv.innerHTML = '<span class="text-red-500">Error</span>';
            }
        }

        async function recordPayments() {
            const tbody = document.getElementById('paymentRecordsTable');
            const rows = tbody.querySelectorAll('tr');
            
            if (rows.length === 0) {
                alert('No payment records to save');
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'Recording payments...');
                
                let recordedCount = 0;
                
                for (const row of rows) {
                    const rowId = row.querySelector('input[id^="paymentDate_"]')?.id.split('_')[1];
                    if (!rowId) continue;
                    
                    const paymentDate = document.getElementById(`paymentDate_${rowId}`)?.value;
                    const studentId = document.getElementById(`student_${rowId}`)?.value;
                    const tuitionYear = document.getElementById(`tuitionYear_${rowId}`)?.value;
                    const tuitionMonth = document.getElementById(`tuitionMonth_${rowId}`)?.value;
                    const amountPaid = parseVNDInput(document.getElementById(`amountPaid_${rowId}`)?.value);
                    const paymentStatus = document.getElementById(`paymentStatus_${rowId}`)?.value;
                    
                    // Skip empty rows
                    if (!paymentDate || !studentId || !tuitionYear || !tuitionMonth || !amountPaid) {
                        continue;
                    }
                    
                    // Find student details
                    const student = allStudentsForSearch.find(s => s.studentId === studentId);
                    if (!student) continue;
                    
                    // Generate transaction document ID
                    const dateStr = new Date(paymentDate).toISOString().slice(0, 10).replace(/-/g, '');
                    const monthStr = String(tuitionMonth).padStart(2, '0');
                    const timestamp = Date.now();
                    const txnDocId = `txn_${dateStr}_${studentId}_${tuitionYear}${monthStr}_${timestamp}`;
                    
                    // Create transaction record
                    const transactionData = {
                        paymentDate: new Date(paymentDate),
                        studentId: studentId,
                        studentName: student.fullName,
                        classAssignment: student.classAssignment,
                        tuitionYear: parseInt(tuitionYear),
                        tuitionMonth: parseInt(tuitionMonth),
                        amountPaid: amountPaid,
                        paymentStatus: paymentStatus,
                        recordedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        recordedBy: 'payment_recorder',
                        source: 'payment_tracker',
                        transactionType: 'tuition_payment'
                    };
                    
                    if (isOnline) {
                        await db.collection('paymentTransactions').doc(txnDocId).set(transactionData);
                    } else {
                        addPendingOperation({
                            type: 'create',
                            collection: 'paymentTransactions',
                            docId: txnDocId,
                            data: transactionData
                        });
                    }
                    
                    // Update tuition record
                    const tuitionDocId = `tuition_${studentId}_${tuitionYear}-${monthStr}`;
                    const tuitionUpdateData = {
                        paid: true,
                        paymentDate: paymentDate,
                        processed: paymentStatus === 'processed',
                        status: paymentStatus === 'processed' ? 'processed' : 'paid',
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    if (isOnline) {
                        await db.collection('tuition').doc(tuitionDocId).update(tuitionUpdateData);
                    } else {
                        addPendingOperation({
                            type: 'update',
                            collection: 'tuition',
                            docId: tuitionDocId,
                            data: tuitionUpdateData
                        });
                    }
                    
                    recordedCount++;
                }
                
                if (recordedCount > 0) {
                    // Clear the table
                    tbody.innerHTML = '';
                    paymentRowCounter = 0;
                    
                    // Reload payment data
                    await loadPaymentTracker();
                    
                    // Collapse the payment recorder
                    togglePaymentRecorder();
                    
                    updateSyncStatus(isOnline ? 'connected' : 'offline', 
                        isOnline ? `${recordedCount} payments recorded` : `${recordedCount} payments saved offline`);
                } else {
                    alert('No valid payment records found to save');
                    updateSyncStatus(isOnline ? 'connected' : 'offline');
                }
                
            } catch (error) {
                console.error('Error recording payments:', error);
                updateSyncStatus('error', 'Recording failed');
                alert('Error recording payments: ' + error.message);
            }
        }

        function cancelPaymentRecording() {
            if (confirm('Are you sure you want to cancel? All unsaved payment records will be lost.')) {
                document.getElementById('paymentRecordsTable').innerHTML = '';
                paymentRowCounter = 0;
                togglePaymentRecorder();
            }
        }

        function filterPayments() {
            const searchTerm = normalizeVietnamese(document.getElementById('paymentSearch').value);
            const yearFilter = document.getElementById('paymentYearFilter').value;
            const monthFilter = document.getElementById('paymentMonthFilter').value;
            const statusFilter = document.getElementById('paymentStatusFilter').value;
            const typeFilter = document.getElementById('paymentTypeFilter').value;
            const sortBy = document.getElementById('paymentSortBy').value;
            
            filteredPayments = allPayments.filter(payment => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    normalizeVietnamese(payment.studentName || '').includes(searchTerm) ||
                    normalizeVietnamese(payment.studentId || '').includes(searchTerm);
                
                // Year filter
                const matchesYear = !yearFilter || payment.tuitionYear === parseInt(yearFilter);
                
                // Month filter (only apply to tuition payments, extra fees don't have months)
                const matchesMonth = !monthFilter || 
                    (payment.transactionType === 'extra_fee_payment') ||
                    payment.tuitionMonth === parseInt(monthFilter);
                
                // Status filter
                const matchesStatus = !statusFilter || payment.paymentStatus === statusFilter;
                
                // Type filter
                const matchesType = !typeFilter || payment.transactionType === typeFilter;
                
                return matchesSearch && matchesYear && matchesMonth && matchesStatus && matchesType;
            });
            
            // Sort payments
            filteredPayments.sort((a, b) => {
                switch (sortBy) {
                    case 'date_newest':
                        return new Date(b.paymentDate) - new Date(a.paymentDate);
                    case 'date_oldest':
                        return new Date(a.paymentDate) - new Date(b.paymentDate);
                    case 'amount_low':
                        return (a.amountPaid || 0) - (b.amountPaid || 0);
                    case 'amount_high':
                        return (b.amountPaid || 0) - (a.amountPaid || 0);
                    case 'student_name':
                        return (a.studentName || '').localeCompare(b.studentName || '');
                    case 'student_id':
                        return (a.studentId || '').localeCompare(b.studentId || '');
                    default:
                        return 0;
                }
            });
            
            renderPaymentTransactionsTable();
            updatePaymentSummary();
        }

        function renderPaymentTransactionsTable() {
            const tbody = document.getElementById('paymentTransactionsTable');
            tbody.innerHTML = '';
            
            console.log(`Rendering ${filteredPayments.length} payment transactions`);
            
            if (filteredPayments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            No payment transactions found for the selected criteria<br>
                            <small class="text-xs">Total payments in database: ${allPayments.length}</small>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredPayments.forEach(payment => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const paymentDate = payment.paymentDate instanceof Date ? 
                    payment.paymentDate.toLocaleDateString('en-CA') : 
                    new Date(payment.paymentDate).toLocaleDateString('en-CA');
                
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                let tuitionPeriod = '';
                
                if (payment.transactionType === 'extra_fee_payment') {
                    tuitionPeriod = `${payment.extraFeeType || 'Extra Fee'} (${payment.tuitionYear})`;
                } else {
                    tuitionPeriod = `${monthNames[payment.tuitionMonth - 1]} ${payment.tuitionYear}`;
                }
                
                let statusBadge = '';
                if (payment.paymentStatus === 'processed') {
                    statusBadge = '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Processed</span>';
                } else {
                    statusBadge = '<span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Received</span>';
                }
                
                let typeBadge = '';
                if (payment.transactionType === 'extra_fee_payment') {
                    typeBadge = '<span class="inline-flex px-2 py-1 text-xs font-medium rounded bg-purple-100 text-purple-800 ml-2">Extra Fee</span>';
                } else {
                    typeBadge = '<span class="inline-flex px-2 py-1 text-xs font-medium rounded bg-blue-100 text-blue-800 ml-2">Tuition</span>';
                }
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="rounded payment-checkbox" data-payment-id="${payment.id}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${paymentDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${payment.studentName || 'N/A'}</div>
                        <div class="text-sm text-gray-500">ID: ${payment.studentId || 'N/A'}</div>
                        <div class="text-sm text-gray-500">${payment.classAssignment || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <div>${tuitionPeriod}</div>
                        <div>${typeBadge}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${formatVNDFull(payment.amountPaid || 0)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${statusBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="editPayment('${payment.id}')" class="text-blue-600 hover:text-blue-800 mr-3">Edit</button>
                        <button onclick="deletePayment('${payment.id}')" class="text-red-600 hover:text-red-800">Delete</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function updatePaymentSummary() {
            const totalCount = filteredPayments.length;
            const totalAmount = filteredPayments.reduce((sum, payment) => sum + (payment.amountPaid || 0), 0);
            const pendingCount = filteredPayments.filter(payment => payment.paymentStatus === 'received').length;
            
            document.getElementById('totalPaymentsCount').textContent = totalCount;
            document.getElementById('totalPaymentsAmount').textContent = formatVNDFull(totalAmount);
            document.getElementById('pendingProcessingCount').textContent = pendingCount;
        }

        function toggleAllPaymentSelection() {
            const selectAll = document.getElementById('selectAllPayments');
            const checkboxes = document.querySelectorAll('.payment-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateBulkActionButtons();
        }

        function updateBulkActionButtons() {
            const checkedBoxes = document.querySelectorAll('.payment-checkbox:checked');
            const bulkProcessBtn = document.getElementById('bulkProcessBtn');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            
            const hasSelection = checkedBoxes.length > 0;
            bulkProcessBtn.disabled = !hasSelection;
            bulkDeleteBtn.disabled = !hasSelection;
            
            if (hasSelection) {
                bulkProcessBtn.classList.remove('opacity-50');
                bulkDeleteBtn.classList.remove('opacity-50');
            } else {
                bulkProcessBtn.classList.add('opacity-50');
                bulkDeleteBtn.classList.add('opacity-50');
            }
        }

        // Add event listeners to payment checkboxes
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('payment-checkbox')) {
                updateBulkActionButtons();
            }
        });

        async function bulkUpdateStatus(newStatus) {
            const checkedBoxes = document.querySelectorAll('.payment-checkbox:checked');
            const paymentIds = Array.from(checkedBoxes).map(cb => cb.dataset.paymentId);
            
            if (paymentIds.length === 0) {
                alert('Please select payments to update');
                return;
            }
            
            if (!confirm(`Mark ${paymentIds.length} payment(s) as ${newStatus}?`)) {
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'Updating payments...');
                
                for (const paymentId of paymentIds) {
                    const updateData = {
                        paymentStatus: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    if (isOnline) {
                        await db.collection('paymentTransactions').doc(paymentId).update(updateData);
                    } else {
                        addPendingOperation({
                            type: 'update',
                            collection: 'paymentTransactions',
                            docId: paymentId,
                            data: updateData
                        });
                    }
                    
                    // Also update corresponding tuition record
                    const payment = allPayments.find(p => p.id === paymentId);
                    if (payment) {
                        const monthStr = String(payment.tuitionMonth).padStart(2, '0');
                        const tuitionDocId = `tuition_${payment.studentId}_${payment.tuitionYear}-${monthStr}`;
                        
                        const tuitionUpdateData = {
                            processed: newStatus === 'processed',
                            status: newStatus,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        if (isOnline) {
                            await db.collection('tuition').doc(tuitionDocId).update(tuitionUpdateData);
                        } else {
                            addPendingOperation({
                                type: 'update',
                                collection: 'tuition',
                                docId: tuitionDocId,
                                data: tuitionUpdateData
                            });
                        }
                    }
                }
                
                // Reload data
                await loadPaymentTracker();
                
                // Clear selections
                document.getElementById('selectAllPayments').checked = false;
                updateBulkActionButtons();
                
                updateSyncStatus(isOnline ? 'connected' : 'offline', 
                    isOnline ? `${paymentIds.length} payments updated` : `${paymentIds.length} updates saved offline`);
                
            } catch (error) {
                console.error('Error updating payments:', error);
                updateSyncStatus('error', 'Update failed');
                alert('Error updating payments: ' + error.message);
            }
        }

        async function bulkDeletePayments() {
            const checkedBoxes = document.querySelectorAll('.payment-checkbox:checked');
            const paymentIds = Array.from(checkedBoxes).map(cb => cb.dataset.paymentId);
            
            if (paymentIds.length === 0) {
                alert('Please select payments to delete');
                return;
            }
            
            if (!confirm(`Delete ${paymentIds.length} payment record(s)? This action cannot be undone.`)) {
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'Deleting payments...');
                
                for (const paymentId of paymentIds) {
                    if (isOnline) {
                        await db.collection('paymentTransactions').doc(paymentId).delete();
                    } else {
                        addPendingOperation({
                            type: 'delete',
                            collection: 'paymentTransactions',
                            docId: paymentId
                        });
                    }
                }
                
                // Reload data
                await loadPaymentTracker();
                
                // Clear selections
                document.getElementById('selectAllPayments').checked = false;
                updateBulkActionButtons();
                
                updateSyncStatus(isOnline ? 'connected' : 'offline', 
                    isOnline ? `${paymentIds.length} payments deleted` : `${paymentIds.length} deletions queued`);
                
            } catch (error) {
                console.error('Error deleting payments:', error);
                updateSyncStatus('error', 'Delete failed');
                alert('Error deleting payments: ' + error.message);
            }
        }

        async function editPayment(paymentId) {
            const payment = allPayments.find(p => p.id === paymentId);
            if (!payment) return;
            
            const newAmount = prompt('Enter new payment amount (in thousands):', (payment.amountPaid / 1000).toString());
            if (newAmount === null) return;
            
            const parsedAmount = parseVNDInput(newAmount);
            if (parsedAmount <= 0) {
                alert('Please enter a valid amount');
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'Updating payment...');
                
                const updateData = {
                    amountPaid: parsedAmount,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (isOnline) {
                    await db.collection('paymentTransactions').doc(paymentId).update(updateData);
                } else {
                    addPendingOperation({
                        type: 'update',
                        collection: 'paymentTransactions',
                        docId: paymentId,
                        data: updateData
                    });
                }
                
                // Reload data
                await loadPaymentTracker();
                
                updateSyncStatus(isOnline ? 'connected' : 'offline', 
                    isOnline ? 'Payment updated' : 'Update saved offline');
                
            } catch (error) {
                console.error('Error updating payment:', error);
                updateSyncStatus('error', 'Update failed');
                alert('Error updating payment: ' + error.message);
            }
        }

        async function deletePayment(paymentId) {
            if (!confirm('Delete this payment record? This action cannot be undone.')) {
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'Deleting payment...');
                
                if (isOnline) {
                    await db.collection('paymentTransactions').doc(paymentId).delete();
                } else {
                    addPendingOperation({
                        type: 'delete',
                        collection: 'paymentTransactions',
                        docId: paymentId
                    });
                }
                
                // Reload data
                await loadPaymentTracker();
                
                updateSyncStatus(isOnline ? 'connected' : 'offline', 
                    isOnline ? 'Payment deleted' : 'Deletion queued');
                
            } catch (error) {
                console.error('Error deleting payment:', error);
                updateSyncStatus('error', 'Delete failed');
                alert('Error deleting payment: ' + error.message);
            }
        }



        // Refresh all data function
        async function refreshAllData() {
            try {
                updateSyncStatus('syncing', 'Refreshing all data...');
                
                // Save current view state before refresh
                saveViewState();
                
                // Clear all cache
                clearCache();
                
                // Reset tab data loaded states to force fresh data on next visit
                tabDataLoaded = {
                    calculator: true, // Always loaded on startup
                    student: false,
                    payment: false,
                    planner: true, // Always loaded on startup
                    monthly: false,
                    extraFees: false
                };
                
                // Force reload all data based on current active tab
                await loadCoursePlans(true);
                
                // Check which tab is currently active and reload its data
                const activeTab = document.querySelector('[id$="Tab"].border-blue-500');
                if (activeTab) {
                    const tabId = activeTab.id;
                    if (tabId === 'studentTab') {
                        await loadStudentTuitionDataCached();
                        tabDataLoaded.student = true;
                    } else if (tabId === 'paymentTab') {
                        await loadPaymentTrackerCached();
                        tabDataLoaded.payment = true;
                    }
                }
                
                // Check which calculator sub-tab is active
                const activeSubTab = document.querySelector('[id$="SubTab"].border-blue-500');
                if (activeSubTab) {
                    const subTabId = activeSubTab.id;
                    if (subTabId === 'monthlySubTab') {
                        // For monthly tab, check if filters are set before loading
                        const selectedMonth = document.getElementById('monthFilter').value;
                        const selectedYear = document.getElementById('yearFilter').value;
                        if (selectedMonth && selectedYear) {
                            await loadStudentsWithFilters();
                            tabDataLoaded.monthly = true;
                        } else {
                            showGettingStartedMessage();
                        }
                    } else if (subTabId === 'extraFeesSubTab') {
                        await loadExtraFeesDataCached();
                        tabDataLoaded.extraFees = true;
                    }
                }
                
                // Restore view state after refresh
                setTimeout(() => {
                    restoreViewState();
                    restoreScrollPositions();
                }, 200);
                
                updateSyncStatus('connected', 'Data refreshed');
                
                // Show success message briefly
                setTimeout(() => {
                    updateSyncStatus('connected', 'Connected');
                }, 2000);
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                updateSyncStatus('error', 'Refresh failed');
            }
        }

        // Extra Fees Management Functions
        async function loadExtraFeesData() {
            try {
                updateSyncStatus('syncing', 'Loading extra fees...');
                
                // Load fee types
                await loadFeeTypes();
                
                // Load students for extra fees assignment
                await loadStudentsForExtraFees();
                
                // Load extra fee classes for filter
                await loadExtraFeeClasses();
                
                // Set current year as default
                const currentYear = new Date().getFullYear();
                document.getElementById('extraFeeYearFilter').value = currentYear;
                
                // Filter and render students
                filterExtraFeeStudents();
                
                updateSyncStatus(isOnline ? 'connected' : 'offline');
            } catch (error) {
                console.error('Error loading extra fees data:', error);
                updateSyncStatus('error', 'Load failed');
            }
        }

        async function loadFeeTypes() {
            try {
                const snapshot = await db.collection('feeTypes').get();
                feeTypes = [];
                
                snapshot.forEach(doc => {
                    feeTypes.push({ id: doc.id, ...doc.data() });
                });
                
                renderFeeTypes();
            } catch (error) {
                console.error('Error loading fee types:', error);
                feeTypes = [];
                renderFeeTypes();
            }
        }

        function renderFeeTypes() {
            const container = document.getElementById('feeTypesList');
            container.innerHTML = '';
            
            if (feeTypes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">No fee types found</p>';
                return;
            }
            
            feeTypes.forEach(feeType => {
                const feeTypeElement = document.createElement('div');
                feeTypeElement.className = `border rounded-lg p-4 ${feeType.active ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`;
                feeTypeElement.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold ${feeType.active ? 'text-green-900' : 'text-gray-700'}">${feeType.name}</h4>
                            <p class="text-sm ${feeType.active ? 'text-green-600' : 'text-gray-500'}">Default: ${formatVNDFull(feeType.defaultAmount || 0)}</p>
                            ${feeType.description ? `<p class="text-sm ${feeType.active ? 'text-green-600' : 'text-gray-500'} mt-1">${feeType.description}</p>` : ''}
                            <span class="inline-block mt-2 px-2 py-1 text-xs rounded ${feeType.active ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-600'}">
                                ${feeType.active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editFeeType('${feeType.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                            <button onclick="deleteFeeType('${feeType.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                        </div>
                    </div>
                `;
                container.appendChild(feeTypeElement);
            });
        }

        // Fee Type Form Handler
        document.getElementById('feeTypeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const feeTypeData = {
                name: document.getElementById('feeTypeName').value,
                defaultAmount: parseVNDInput(document.getElementById('feeTypeAmount').value),
                description: document.getElementById('feeTypeDescription').value,
                active: document.getElementById('feeTypeActive').checked,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                updateSyncStatus('syncing', 'Saving fee type...');
                
                if (currentEditingFeeType) {
                    if (isOnline) {
                        await db.collection('feeTypes').doc(currentEditingFeeType).update(feeTypeData);
                    } else {
                        addPendingOperation({
                            type: 'update',
                            collection: 'feeTypes',
                            docId: currentEditingFeeType,
                            data: feeTypeData
                        });
                    }
                    currentEditingFeeType = null;
                    document.getElementById('feeTypeSubmitText').textContent = 'Add Fee Type';
                } else {
                    // Generate sequential document ID
                    const allFeeTypes = await db.collection('feeTypes').get();
                    const feeTypeNumber = String(allFeeTypes.size + 1).padStart(3, '0');
                    const docId = `feeType_${feeTypeNumber}`;
                    
                    if (isOnline) {
                        await db.collection('feeTypes').doc(docId).set(feeTypeData);
                    } else {
                        addPendingOperation({
                            type: 'create',
                            collection: 'feeTypes',
                            docId: docId,
                            data: feeTypeData
                        });
                    }
                }
                
                document.getElementById('feeTypeForm').reset();
                document.getElementById('feeTypeActive').checked = true;
                await loadFeeTypes();
                updateSyncStatus(isOnline ? 'connected' : 'offline', isOnline ? 'Fee type saved' : 'Fee type saved offline');
            } catch (error) {
                console.error('Error saving fee type:', error);
                updateSyncStatus('error', 'Save failed');
                alert('Error saving fee type: ' + error.message);
            }
        });

        async function editFeeType(feeTypeId) {
            const feeType = feeTypes.find(ft => ft.id === feeTypeId);
            if (feeType) {
                document.getElementById('feeTypeName').value = feeType.name;
                document.getElementById('feeTypeAmount').value = (feeType.defaultAmount || 0) / 1000;
                document.getElementById('feeTypeDescription').value = feeType.description || '';
                document.getElementById('feeTypeActive').checked = feeType.active;
                currentEditingFeeType = feeTypeId;
                document.getElementById('feeTypeSubmitText').textContent = 'Update Fee Type';
            }
        }

        async function deleteFeeType(feeTypeId) {
            if (confirm('Are you sure you want to delete this fee type?')) {
                try {
                    updateSyncStatus('syncing', 'Deleting...');
                    
                    if (isOnline) {
                        await db.collection('feeTypes').doc(feeTypeId).delete();
                    } else {
                        addPendingOperation({
                            type: 'delete',
                            collection: 'feeTypes',
                            docId: feeTypeId
                        });
                    }
                    
                    await loadFeeTypes();
                    updateSyncStatus(isOnline ? 'connected' : 'offline', isOnline ? 'Fee type deleted' : 'Delete queued');
                } catch (error) {
                    console.error('Error deleting fee type:', error);
                    updateSyncStatus('error', 'Delete failed');
                }
            }
        }

        async function loadStudentsForExtraFees() {
            try {
                const studentsSnapshot = await db.collection('students').get();
                allStudentsForExtraFees = [];
                
                studentsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.studentId && data.fullName) {
                        allStudentsForExtraFees.push({
                            id: doc.id,
                            studentId: data.studentId,
                            fullName: data.fullName,
                            classAssignment: data.classAssignment || 'N/A',
                            status: data.status || 'Active'
                        });
                    }
                });
                
                allStudentsForExtraFees.sort((a, b) => (a.fullName || '').localeCompare(b.fullName || ''));
            } catch (error) {
                console.error('Error loading students for extra fees:', error);
                allStudentsForExtraFees = [];
            }
        }

        async function loadExtraFeeClasses() {
            try {
                const snapshot = await db.collection('classes').get();
                const classFilter = document.getElementById('extraFeeClassFilter');
                
                classFilter.innerHTML = '<option value="">All Classes</option>';
                
                snapshot.forEach(doc => {
                    const classData = doc.data();
                    const option = document.createElement('option');
                    option.value = classData.classCode || doc.id;
                    option.textContent = classData.className || classData.classCode || doc.id;
                    classFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        function filterExtraFeeStudents() {
            const searchTerm = normalizeVietnamese(document.getElementById('extraFeeStudentSearch').value);
            const classFilter = document.getElementById('extraFeeClassFilter').value;
            const yearFilter = parseInt(document.getElementById('extraFeeYearFilter').value);
            
            let filteredStudents = allStudentsForExtraFees.filter(student => {
                const matchesSearch = !searchTerm || 
                    normalizeVietnamese(student.fullName || '').includes(searchTerm) ||
                    normalizeVietnamese(student.studentId || '').includes(searchTerm);
                
                const matchesClass = !classFilter || student.classAssignment === classFilter;
                
                return matchesSearch && matchesClass;
            });
            
            renderExtraFeeStudentsTable(filteredStudents, yearFilter);
        }

        async function renderExtraFeeStudentsTable(students, year) {
            const tbody = document.getElementById('extraFeeStudentsTable');
            tbody.innerHTML = '';
            
            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="px-6 py-8 text-center text-gray-500">
                            No students found for the selected criteria
                        </td>
                    </tr>
                `;
                return;
            }
            
            for (const student of students) {
                // Load current extra fees for this student and year
                const extraFees = await loadStudentExtraFees(student.studentId, year);
                
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                // Render current extra fees with payment controls
                let currentFeesHtml = '';
                if (extraFees.length === 0) {
                    currentFeesHtml = '<span class="text-gray-500 text-sm">No extra fees</span>';
                } else {
                    currentFeesHtml = extraFees.map(fee => {
                        // Determine color based on payment status
                        let cardClass = 'rounded px-2 py-1 mb-1 border';
                        let textClass = 'text-sm';
                        
                        if (fee.processed) {
                            // Processed: Green
                            cardClass += ' bg-green-50 border-green-200';
                            textClass += ' text-green-800';
                        } else if (fee.paid) {
                            // Paid but not processed: Yellow
                            cardClass += ' bg-yellow-50 border-yellow-200';
                            textClass += ' text-yellow-800';
                        } else {
                            // Assigned but not paid: Red
                            cardClass += ' bg-red-50 border-red-200';
                            textClass += ' text-red-800';
                        }
                        
                        return `
                            <div class="${cardClass}">
                                <div class="flex items-center justify-between mb-1">
                                    <div class="${textClass} font-medium">${fee.feeTypeName}: ${formatVNDFull(fee.amount)}</div>
                                    <button onclick="removeStudentExtraFee('${fee.id}')" class="text-red-600 hover:text-red-800 text-xs ml-2">Ã—</button>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <label class="flex items-center space-x-1">
                                        <input type="checkbox" ${fee.paid ? 'checked' : ''} 
                                               onchange="updateExtraFeePaid('${fee.id}', this.checked)"
                                               class="rounded text-xs">
                                        <span class="text-xs">Paid</span>
                                    </label>
                                    <input type="date" value="${fee.paymentDate || ''}" 
                                           ${!fee.paid ? 'disabled' : ''}
                                           class="text-xs border rounded px-1 py-0.5 w-24" 
                                           onchange="updateExtraFeePaymentDate('${fee.id}', this.value)">
                                    <label class="flex items-center space-x-1">
                                        <input type="checkbox" ${fee.processed ? 'checked' : ''} 
                                               ${!fee.paid ? 'disabled' : ''}
                                               onchange="updateExtraFeeProcessed('${fee.id}', this.checked)"
                                               class="rounded text-xs">
                                        <span class="text-xs">Processed</span>
                                    </label>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
                
                // Create fee type dropdown
                const activeFeeTypes = feeTypes.filter(ft => ft.active);
                const feeTypeOptions = activeFeeTypes.map(ft => 
                    `<option value="${ft.id}">${ft.name} (${formatVNDFull(ft.defaultAmount || 0)})</option>`
                ).join('');
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${student.fullName}</div>
                            <div class="text-sm text-gray-500">ID: ${student.studentId}</div>
                            <div class="text-sm text-gray-500">Class: ${student.classAssignment}</div>
                            <div class="text-sm text-gray-500">Status: ${student.status}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="max-w-xs">
                            ${currentFeesHtml}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="space-y-2">
                            <select class="w-full px-2 py-1 border rounded text-sm" id="feeType_${student.id}">
                                <option value="">Select Fee Type</option>
                                ${feeTypeOptions}
                            </select>
                            <div class="relative">
                                <input type="number" step="0.001" placeholder="Custom amount" class="w-full px-2 py-1 pr-8 border rounded text-sm" id="customAmount_${student.id}">
                                <span class="absolute right-2 top-1 text-xs text-gray-500">.000</span>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="assignExtraFee('${student.studentId}', '${student.id}', ${year})" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">
                            Assign Fee
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            }
        }

        async function loadStudentExtraFees(studentId, year) {
            try {
                const snapshot = await db.collection('extraFees')
                    .where('studentId', '==', studentId)
                    .where('year', '==', year)
                    .get();
                
                const extraFees = [];
                snapshot.forEach(doc => {
                    extraFees.push({ id: doc.id, ...doc.data() });
                });
                
                return extraFees;
            } catch (error) {
                console.error('Error loading student extra fees:', error);
                return [];
            }
        }

        async function assignExtraFee(studentId, studentElementId, year) {
            const feeTypeId = document.getElementById(`feeType_${studentElementId}`).value;
            const customAmount = parseVNDInput(document.getElementById(`customAmount_${studentElementId}`).value);
            
            if (!feeTypeId) {
                alert('Please select a fee type');
                return;
            }
            
            const selectedFeeType = feeTypes.find(ft => ft.id === feeTypeId);
            if (!selectedFeeType) {
                alert('Invalid fee type selected');
                return;
            }
            
            const student = allStudentsForExtraFees.find(s => s.id === studentElementId);
            if (!student) {
                alert('Student not found');
                return;
            }
            
            const amount = customAmount > 0 ? customAmount : selectedFeeType.defaultAmount;
            
            if (amount <= 0) {
                alert('Please enter a valid amount or select a fee type with a default amount');
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'Assigning fee...');
                
                // Generate document ID
                const timestamp = Date.now();
                const docId = `extraFee_${studentId}_${year}_${feeTypeId}_${timestamp}`;
                
                const extraFeeData = {
                    studentId: studentId,
                    studentName: student.fullName,
                    classAssignment: student.classAssignment,
                    year: year,
                    feeTypeId: feeTypeId,
                    feeTypeName: selectedFeeType.name,
                    amount: amount,
                    paid: false,
                    processed: false,
                    paymentDate: null,
                    assignedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'assigned'
                };
                
                if (isOnline) {
                    await db.collection('extraFees').doc(docId).set(extraFeeData);
                } else {
                    addPendingOperation({
                        type: 'create',
                        collection: 'extraFees',
                        docId: docId,
                        data: extraFeeData
                    });
                }
                
                // Clear form inputs for this student
                document.getElementById(`feeType_${studentElementId}`).value = '';
                document.getElementById(`customAmount_${studentElementId}`).value = '';
                
                // Update only this student's row instead of refreshing entire table
                await updateStudentExtraFeesRow(studentId, studentElementId, year);
                
                updateSyncStatus(isOnline ? 'connected' : 'offline', isOnline ? 'Fee assigned' : 'Fee assigned offline');
            } catch (error) {
                console.error('Error assigning extra fee:', error);
                updateSyncStatus('error', 'Assignment failed');
                alert('Error assigning fee: ' + error.message);
            }
        }

        async function updateStudentExtraFeesRow(studentId, studentElementId, year) {
            try {
                // Find the row for this student
                const tbody = document.getElementById('extraFeeStudentsTable');
                const rows = tbody.querySelectorAll('tr');
                
                for (const row of rows) {
                    const studentInfo = row.querySelector('.text-sm.font-medium.text-gray-900');
                    if (studentInfo && studentInfo.textContent.includes(studentId)) {
                        // Load updated extra fees for this student
                        const extraFees = await loadStudentExtraFees(studentId, year);
                        
                        // Update the Current Extra Fees column
                        const currentFeesCell = row.children[1];
                        let currentFeesHtml = '';
                        
                        if (extraFees.length === 0) {
                            currentFeesHtml = '<span class="text-gray-500 text-sm">No extra fees</span>';
                        } else {
                            currentFeesHtml = extraFees.map(fee => {
                                // Determine color based on payment status
                                let cardClass = 'flex items-center justify-between rounded px-2 py-1 mb-1 border';
                                let textClass = 'text-sm';
                                
                                if (fee.processed) {
                                    // Processed: Green
                                    cardClass += ' bg-green-50 border-green-200';
                                    textClass += ' text-green-800';
                                } else if (fee.paid) {
                                    // Paid but not processed: Yellow
                                    cardClass += ' bg-yellow-50 border-yellow-200';
                                    textClass += ' text-yellow-800';
                                } else {
                                    // Assigned but not paid: Red
                                    cardClass += ' bg-red-50 border-red-200';
                                    textClass += ' text-red-800';
                                }
                                
                                return `
                                    <div class="${cardClass}">
                                        <div>
                                            <div class="${textClass} font-medium">${fee.feeTypeName}: ${formatVNDFull(fee.amount)}</div>
                                            <div class="flex items-center space-x-2 mt-1">
                                                <label class="flex items-center space-x-1">
                                                    <input type="checkbox" ${fee.paid ? 'checked' : ''} 
                                                           onchange="updateExtraFeePaid('${fee.id}', this.checked)"
                                                           class="rounded text-xs">
                                                    <span class="text-xs">Paid</span>
                                                </label>
                                                <input type="date" value="${fee.paymentDate || ''}" 
                                                       ${!fee.paid ? 'disabled' : ''}
                                                       class="text-xs border rounded px-1 py-0.5 w-24" 
                                                       onchange="updateExtraFeePaymentDate('${fee.id}', this.value)">
                                                <label class="flex items-center space-x-1">
                                                    <input type="checkbox" ${fee.processed ? 'checked' : ''} 
                                                           ${!fee.paid ? 'disabled' : ''}
                                                           onchange="updateExtraFeeProcessed('${fee.id}', this.checked)"
                                                           class="rounded text-xs">
                                                    <span class="text-xs">Processed</span>
                                                </label>
                                            </div>
                                        </div>
                                        <button onclick="removeStudentExtraFee('${fee.id}')" class="text-red-600 hover:text-red-800 text-xs ml-2">Ã—</button>
                                    </div>
                                `;
                            }).join('');
                        }
                        
                        currentFeesCell.innerHTML = `<div class="max-w-xs">${currentFeesHtml}</div>`;
                        break;
                    }
                }
            } catch (error) {
                console.error('Error updating student row:', error);
            }
        }

        async function updateExtraFeePaid(extraFeeId, paid) {
            try {
                // Get the extra fee data first
                const extraFeeDoc = await db.collection('extraFees').doc(extraFeeId).get();
                if (!extraFeeDoc.exists) {
                    throw new Error('Extra fee not found');
                }
                
                const extraFeeData = extraFeeDoc.data();
                
                const updateData = {
                    paid: paid,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (paid) {
                    // Set payment date to today if not already set
                    updateData.paymentDate = new Date().toISOString().split('T')[0];
                    updateData.status = 'paid';
                    
                    // Create transaction record for extra fee payment
                    const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                    const timestamp = Date.now();
                    const txnDocId = `txn_${dateStr}_${extraFeeData.studentId}_extrafee_${timestamp}`;
                    
                    const transactionData = {
                        paymentDate: new Date(updateData.paymentDate),
                        studentId: extraFeeData.studentId,
                        studentName: extraFeeData.studentName,
                        classAssignment: extraFeeData.classAssignment,
                        tuitionYear: extraFeeData.year,
                        tuitionMonth: null, // Extra fees don't have specific months
                        amountPaid: extraFeeData.amount,
                        paymentStatus: 'received',
                        recordedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        recordedBy: 'extra_fees_system',
                        source: 'extra_fees',
                        transactionType: 'extra_fee_payment',
                        extraFeeId: extraFeeId,
                        extraFeeType: extraFeeData.feeTypeName
                    };
                    
                    // Save transaction
                    await updateSingleRecord('paymentTransactions', txnDocId, transactionData, ['payments']);
                    
                } else {
                    // Clear payment date and processed status when unmarking as paid
                    updateData.paymentDate = null;
                    updateData.processed = false;
                    updateData.status = 'assigned';
                    
                    // Remove corresponding transaction record
                    const existingTransactions = await db.collection('paymentTransactions')
                        .where('extraFeeId', '==', extraFeeId)
                        .get();
                    
                    existingTransactions.forEach(async (doc) => {
                        if (isOnline) {
                            await db.collection('paymentTransactions').doc(doc.id).delete();
                        } else {
                            addPendingOperation({
                                type: 'delete',
                                collection: 'paymentTransactions',
                                docId: doc.id
                            });
                        }
                    });
                }
                
                if (isOnline) {
                    await db.collection('extraFees').doc(extraFeeId).update(updateData);
                } else {
                    addPendingOperation({
                        type: 'update',
                        collection: 'extraFees',
                        docId: extraFeeId,
                        data: updateData
                    });
                }
                
                // Refresh the table to show updated colors and states
                filterExtraFeeStudents();
                
            } catch (error) {
                console.error('Error updating extra fee paid status:', error);
                alert('Error updating payment status: ' + error.message);
            }
        }

        async function updateExtraFeePaymentDate(extraFeeId, paymentDate) {
            try {
                const updateData = {
                    paymentDate: paymentDate,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                if (isOnline) {
                    await db.collection('extraFees').doc(extraFeeId).update(updateData);
                } else {
                    addPendingOperation({
                        type: 'update',
                        collection: 'extraFees',
                        docId: extraFeeId,
                        data: updateData
                    });
                }
                
            } catch (error) {
                console.error('Error updating extra fee payment date:', error);
                alert('Error updating payment date: ' + error.message);
            }
        }

        async function updateExtraFeeProcessed(extraFeeId, processed) {
            try {
                const updateData = {
                    processed: processed,
                    status: processed ? 'processed' : 'paid',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Update corresponding transaction record status
                const existingTransactions = await db.collection('paymentTransactions')
                    .where('extraFeeId', '==', extraFeeId)
                    .get();
                
                existingTransactions.forEach(async (doc) => {
                    const newStatus = processed ? 'processed' : 'received';
                    await updateSingleRecord('paymentTransactions', doc.id, {
                        paymentStatus: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, ['payments']);
                });
                
                if (isOnline) {
                    await db.collection('extraFees').doc(extraFeeId).update(updateData);
                } else {
                    addPendingOperation({
                        type: 'update',
                        collection: 'extraFees',
                        docId: extraFeeId,
                        data: updateData
                    });
                }
                
                // Refresh the table to show updated colors
                filterExtraFeeStudents();
                
            } catch (error) {
                console.error('Error updating extra fee processed status:', error);
                alert('Error updating processed status: ' + error.message);
            }
        }

        async function removeStudentExtraFee(extraFeeId) {
            if (confirm('Remove this extra fee?')) {
                try {
                    updateSyncStatus('syncing', 'Removing fee...');
                    
                    if (isOnline) {
                        await db.collection('extraFees').doc(extraFeeId).delete();
                    } else {
                        addPendingOperation({
                            type: 'delete',
                            collection: 'extraFees',
                            docId: extraFeeId
                        });
                    }
                    
                    // Refresh the table
                    filterExtraFeeStudents();
                    
                    updateSyncStatus(isOnline ? 'connected' : 'offline', isOnline ? 'Fee removed' : 'Removal queued');
                } catch (error) {
                    console.error('Error removing extra fee:', error);
                    updateSyncStatus('error', 'Removal failed');
                    alert('Error removing fee: ' + error.message);
                }
            }
        }

        // Function to correct tuition statuses based on processed field
        async function correctTuitionStatuses() {
            try {
                console.log('Correcting tuition record statuses...');
                const tuitionSnapshot = await db.collection('tuition').get();
                let correctedCount = 0;
                
                for (const doc of tuitionSnapshot.docs) {
                    const data = doc.data();
                    const fee = data.finalFee || data.adjustedFee || data.calculatedFee || 0;
                    const paid = data.paid === true;
                    const processed = data.processed === true;
                    const currentStatus = data.status;
                    
                    let correctStatus;
                    if (fee <= 0) {
                        correctStatus = 'no_fee';
                    } else if (processed) {
                        correctStatus = 'processed';
                    } else if (paid) {
                        correctStatus = 'paid';
                    } else {
                        correctStatus = 'informed';
                    }
                    
                    // Update if status is incorrect
                    if (currentStatus !== correctStatus) {
                        await db.collection('tuition').doc(doc.id).update({
                            status: correctStatus,
                            statusCorrectedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        correctedCount++;
                        console.log(`Corrected status for ${doc.id}: ${currentStatus} â†’ ${correctStatus}`);
                    }
                }
                
                if (correctedCount > 0) {
                    console.log(`âœ… Corrected ${correctedCount} tuition record statuses`);
                } else {
                    console.log('âœ… All tuition record statuses are correct');
                }
                
            } catch (error) {
                console.error('Error correcting tuition statuses:', error);
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ðŸš€ Initializing Tuition Management System...');
            
            // Clear any stale cache on startup to ensure fresh data
            console.log('ðŸ§¹ Clearing stale cache to ensure fresh data...');
            clearCache();
            localStorage.removeItem(CACHE_STORAGE_KEY);
            
            // Load pending operations from localStorage
            const savedOperations = localStorage.getItem('pendingOperations');
            if (savedOperations) {
                pendingOperations = JSON.parse(savedOperations);
            }
            
            // Restore view state early
            restoreViewState();
            
            // Set default year values
            const currentYear = new Date().getFullYear();
            document.getElementById('tuitionYearFilter').value = currentYear;
            document.getElementById('paymentYearFilter').value = currentYear;
            document.getElementById('modalYearSelect').value = currentYear;
            
            // Set initial collapsed state for fee type sections
            document.getElementById('feeTypeManagementContent').classList.add('hidden');
            document.getElementById('feeTypesListContent').classList.add('hidden');
            
            // Restore tab states if saved
            if (viewState.currentTab && viewState.currentTab !== 'calculator') {
                switchTab(viewState.currentTab);
            }
            if (viewState.currentSubTab && viewState.currentSubTab !== 'planner') {
                switchCalculatorTab(viewState.currentSubTab);
            }
            
            // Load critical data immediately and in parallel
            console.log('ðŸ“Š Loading initial data from Firestore...');
            updateSyncStatus('syncing', 'Loading initial data...');
            
            try {
                // Load course plans and classes in parallel for faster startup
                await Promise.all([
                    loadCoursePlans(true).catch(error => {
                        console.error('Failed to load course plans:', error);
                        return null;
                    }),
                    loadTuitionClassesCached().catch(error => {
                        console.error('Failed to load classes:', error);
                        return null;
                    })
                ]);
                
                // Run status correction for existing tuition records
                if (isOnline) {
                    console.log('ðŸ”§ Running status correction for tuition records...');
                    await correctTuitionStatuses();
                }
                
                // Restore scroll positions after data is loaded
                setTimeout(() => {
                    restoreScrollPositions();
                }, 300);
                
                console.log('âœ… Initial data loaded successfully');
                updateSyncStatus(isOnline ? 'connected' : 'offline', 'Ready');
                
            } catch (error) {
                console.error('âŒ Error during initialization:', error);
                updateSyncStatus('error', 'Initialization failed');
            }
            
            // Process pending operations if online
            if (isOnline && pendingOperations.length > 0) {
                console.log(`ðŸ“¤ Processing ${pendingOperations.length} pending operations...`);
                processPendingOperations();
            }
            
            // Set up auto-save for view state
            setInterval(saveViewState, 5000); // Save view state every 5 seconds
            
            console.log('ðŸŽ‰ Tuition Management System initialized successfully');
        });
        // Initialize DOM event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up authentication...');
            // Authentication will handle the rest via onAuthStateChanged
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97a7053932b4045d',t:'MTc1NzA4ODg3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
