<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Account Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-functions-compat.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    .spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-top-color: #fff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .toast {
      animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s forwards;
    }
    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gray-900 text-gray-100"><!-- Loading State -->
  <div id="loadingState" class="h-full flex items-center justify-center">
   <div class="text-center">
    <div class="spinner mx-auto mb-4"></div>
    <p class="text-gray-400">Verifying access...</p>
   </div>
  </div><!-- Access Denied State -->
  <div id="accessDenied" class="h-full flex items-center justify-center hidden">
   <div class="text-center bg-gray-800 p-8 rounded-xl border border-red-500/30 max-w-md">
    <div class="w-16 h-16 mx-auto mb-4 bg-red-500/20 rounded-full flex items-center justify-center">
     <svg class="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
     </svg>
    </div>
    <h2 class="text-xl font-bold text-red-400 mb-2">Access Denied</h2>
    <p class="text-gray-400 mb-4">You do not have administrator privileges to access this page.</p><a href="Authen.html" class="inline-block px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors">Return to Login</a>
   </div>
  </div><!-- Main Content -->
  <div id="mainContent" class="h-full overflow-auto hidden">
   <div class="min-h-full p-6"><!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
     <div>
      <h1 id="pageTitle" class="text-2xl font-bold text-white">Account Management</h1>
      <p class="text-gray-400 text-sm mt-1">Manage user accounts and permissions</p>
     </div>
     <div class="flex items-center gap-3"><span id="adminInfo" class="text-sm text-gray-400"></span> <button id="createUserBtn" class="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-medium transition-colors flex items-center gap-2">
       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
       </svg> Create User </button>
     </div>
    </div><!-- Filters -->
    <div class="bg-gray-800 rounded-xl p-4 mb-6 border border-gray-700">
     <div class="flex flex-col sm:flex-row gap-4">
      <div class="flex-1"><input type="text" id="searchInput" placeholder="Search by name, username, or email..." class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-emerald-500 transition-colors">
      </div>
      <div class="flex gap-3"><select id="roleFilter" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-emerald-500 transition-colors"> <option value="">All Roles</option> <option value="admin">Admin</option> <option value="manager">Manager</option> <option value="teacher">Teacher</option> <option value="student">Student</option> <option value="parent">Parent</option> </select> <select id="statusFilter" class="px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-emerald-500 transition-colors"> <option value="">All Status</option> <option value="active">Active</option> <option value="disabled">Disabled</option> <option value="pending">Pending</option> </select>
      </div>
     </div>
    </div><!-- Table -->
    <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
     <div class="overflow-x-auto">
      <table class="w-full">
       <thead class="bg-gray-750">
        <tr class="border-b border-gray-700">
         <th class="text-left px-4 py-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Display Name</th>
         <th class="text-left px-4 py-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Username</th>
         <th class="text-left px-4 py-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Login Email</th>
         <th class="text-left px-4 py-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Role</th>
         <th class="text-left px-4 py-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Staff Link</th>
         <th class="text-left px-4 py-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Student Link</th>
         <th class="text-left px-4 py-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Status</th>
         <th class="text-left px-4 py-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Updated</th>
         <th class="text-right px-4 py-3 text-xs font-semibold text-gray-400 uppercase tracking-wider">Actions</th>
        </tr>
       </thead>
       <tbody id="usersTableBody" class="divide-y divide-gray-700"><!-- Users will be populated here -->
       </tbody>
      </table>
     </div>
     <div id="emptyState" class="hidden py-12 text-center">
      <svg class="w-12 h-12 mx-auto text-gray-600 mb-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
      </svg>
      <p class="text-gray-400">No users found</p>
     </div>
     <div id="loadingTable" class="py-12 text-center">
      <div class="spinner mx-auto mb-2" style="border-color: rgba(156,163,175,0.3); border-top-color: #9ca3af;"></div>
      <p class="text-gray-400 text-sm">Loading users...</p>
     </div>
    </div>
   </div>
  </div><!-- Create/Edit Modal -->
  <div id="userModal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-50">
   <div class="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-md max-h-[90%] overflow-auto">
    <div class="p-6 border-b border-gray-700">
     <h2 id="modalTitle" class="text-xl font-bold text-white">Create User</h2>
    </div>
    <form id="userForm" class="p-6 space-y-4"><input type="hidden" id="editUserId">
     <div><label class="block text-sm font-medium text-gray-300 mb-1">Display Name *</label> <input type="text" id="displayNameInput" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-emerald-500 transition-colors" placeholder="John Doe">
      <p id="displayNameError" class="text-red-400 text-xs mt-1 hidden"></p>
     </div>
     <div><label class="block text-sm font-medium text-gray-300 mb-1">Username *</label> <input type="text" id="usernameInput" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-emerald-500 transition-colors" placeholder="johndoe">
      <p class="text-gray-500 text-xs mt-1">3-40 characters, letters, numbers, underscore, hyphen only</p>
      <p id="usernameError" class="text-red-400 text-xs mt-1 hidden"></p>
     </div>
     <div><label class="block text-sm font-medium text-gray-300 mb-1">Login Email</label> <input type="email" id="loginEmailInput" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-emerald-500 transition-colors" placeholder="Auto-generated from username">
      <p class="text-gray-500 text-xs mt-1">Auto-generated as username@tnl.local</p>
      <p id="loginEmailError" class="text-red-400 text-xs mt-1 hidden"></p>
     </div>
     <div><label class="block text-sm font-medium text-gray-300 mb-1">Role *</label> <select id="roleInput" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-emerald-500 transition-colors"> <option value="">Select role...</option> <option value="admin">Admin</option> <option value="manager">Manager</option> <option value="teacher">Teacher</option> <option value="student">Student</option> <option value="parent">Parent</option> </select>
      <p id="roleError" class="text-red-400 text-xs mt-1 hidden"></p>
     </div>
     <div><label class="block text-sm font-medium text-gray-300 mb-1">Status</label> <select id="statusInput" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:border-emerald-500 transition-colors"> <option value="active">Active</option> <option value="disabled">Disabled</option> <option value="pending">Pending</option> </select>
     </div><!-- Linking Section -->
     <div id="linkingSection" class="border-t border-gray-700 pt-4">
      <h3 class="text-sm font-semibold text-gray-300 mb-3">Account Linking</h3>
      <div id="staffLinkSection" class="mb-4 hidden"><label class="block text-sm font-medium text-gray-300 mb-1">Staff Member</label>
       <div class="relative"><input type="text" id="staffSearchInput" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-emerald-500 transition-colors" placeholder="Search by name or ID..." autocomplete="off">
        <div id="staffSearchResults" class="absolute z-10 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto hidden"></div>
       </div><input type="hidden" id="staffIdInput">
       <div id="selectedStaffDisplay" class="mt-2 hidden">
        <div class="flex items-center justify-between bg-gray-700 border border-emerald-500/30 rounded-lg p-2">
         <div>
          <p class="text-white text-sm font-medium" id="selectedStaffName"></p>
          <p class="text-gray-400 text-xs" id="selectedStaffId"></p>
         </div><button type="button" id="clearStaffBtn" class="text-red-400 hover:text-red-300 p-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg></button>
        </div>
       </div>
       <p class="text-gray-500 text-xs mt-1">Link this account to a staff member record</p>
       <p id="staffIdError" class="text-red-400 text-xs mt-1 hidden"></p>
      </div>
      <div id="studentLinkSection" class="hidden"><label class="block text-sm font-medium text-gray-300 mb-1">Student</label>
       <div class="relative"><input type="text" id="studentSearchInput" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-emerald-500 transition-colors" placeholder="Search by name or code..." autocomplete="off">
        <div id="studentSearchResults" class="absolute z-10 w-full mt-1 bg-gray-700 border border-gray-600 rounded-lg shadow-lg max-h-48 overflow-y-auto hidden"></div>
       </div><input type="hidden" id="studentDocIdInput">
       <div id="selectedStudentDisplay" class="mt-2 hidden">
        <div class="flex items-center justify-between bg-gray-700 border border-emerald-500/30 rounded-lg p-2">
         <div>
          <p class="text-white text-sm font-medium" id="selectedStudentName"></p>
          <p class="text-gray-400 text-xs" id="selectedStudentCode"></p>
         </div><button type="button" id="clearStudentBtn" class="text-red-400 hover:text-red-300 p-1">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg></button>
        </div>
       </div>
       <p class="text-gray-500 text-xs mt-1">Link this account to a student record</p>
       <p id="studentDocIdError" class="text-red-400 text-xs mt-1 hidden"></p>
      </div>
     </div>
     <div id="passwordSection">
      <div class="mb-4"><label class="block text-sm font-medium text-gray-300 mb-1">Password *</label> <input type="password" id="passwordInput" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-emerald-500 transition-colors" placeholder="Minimum 8 characters">
       <p id="passwordError" class="text-red-400 text-xs mt-1 hidden"></p>
      </div>
      <div><label class="block text-sm font-medium text-gray-300 mb-1">Confirm Password *</label> <input type="password" id="confirmPasswordInput" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-emerald-500 transition-colors" placeholder="Re-enter password">
       <p id="confirmPasswordError" class="text-red-400 text-xs mt-1 hidden"></p>
      </div>
     </div>
     <div id="formError" class="bg-red-500/20 border border-red-500/30 rounded-lg p-3 text-red-400 text-sm hidden"></div>
     <div class="flex gap-3 pt-4"><button type="button" id="cancelBtn" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors"> Cancel </button> <button type="submit" id="saveBtn" class="flex-1 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2"> <span id="saveBtnText">Create User</span>
       <div id="saveBtnSpinner" class="spinner hidden" style="width: 16px; height: 16px; border-width: 2px;"></div></button>
     </div>
    </form>
   </div>
  </div><!-- Reset Password Modal -->
  <div id="resetPasswordModal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-50">
   <div class="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-md">
    <div class="p-6 border-b border-gray-700">
     <h2 class="text-xl font-bold text-white">Reset Password</h2>
     <p id="resetUserInfo" class="text-gray-400 text-sm mt-1"></p>
    </div>
    <form id="resetPasswordForm" class="p-6 space-y-4"><input type="hidden" id="resetUserId">
     <div><label class="block text-sm font-medium text-gray-300 mb-1">New Password *</label> <input type="password" id="newPasswordInput" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-emerald-500 transition-colors" placeholder="Minimum 8 characters">
      <p id="newPasswordError" class="text-red-400 text-xs mt-1 hidden"></p>
     </div>
     <div><label class="block text-sm font-medium text-gray-300 mb-1">Confirm New Password *</label> <input type="password" id="confirmNewPasswordInput" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:border-emerald-500 transition-colors" placeholder="Re-enter password">
      <p id="confirmNewPasswordError" class="text-red-400 text-xs mt-1 hidden"></p>
     </div>
     <div id="resetFormError" class="bg-red-500/20 border border-red-500/30 rounded-lg p-3 text-red-400 text-sm hidden"></div>
     <div class="flex gap-3 pt-4"><button type="button" id="cancelResetBtn" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors"> Cancel </button> <button type="submit" id="resetBtn" class="flex-1 px-4 py-2 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2"> <span id="resetBtnText">Reset Password</span>
       <div id="resetBtnSpinner" class="spinner hidden" style="width: 16px; height: 16px; border-width: 2px;"></div></button>
     </div>
    </form>
   </div>
  </div><!-- Confirm Disable Modal -->
  <div id="confirmModal" class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 hidden z-50">
   <div class="bg-gray-800 rounded-xl border border-gray-700 w-full max-w-sm p-6">
    <div class="w-12 h-12 mx-auto mb-4 bg-amber-500/20 rounded-full flex items-center justify-center">
     <svg class="w-6 h-6 text-amber-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
     </svg>
    </div>
    <h3 id="confirmTitle" class="text-lg font-bold text-white text-center mb-2">Disable User?</h3>
    <p id="confirmMessage" class="text-gray-400 text-center text-sm mb-6"></p><input type="hidden" id="confirmUserId"> <input type="hidden" id="confirmAction">
    <div class="flex gap-3"><button id="confirmCancelBtn" class="flex-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg font-medium transition-colors"> Cancel </button> <button id="confirmActionBtn" class="flex-1 px-4 py-2 bg-amber-600 hover:bg-amber-500 text-white rounded-lg font-medium transition-colors flex items-center justify-center gap-2"> <span id="confirmBtnText">Disable</span>
      <div id="confirmBtnSpinner" class="spinner hidden" style="width: 16px; height: 16px; border-width: 2px;"></div></button>
    </div>
   </div>
  </div><!-- Toast Container -->
  <div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>
  <script>
    // Firebase Configuration (same as other modules)
    const firebaseConfig = {
      apiKey: "AIzaSyCDzv0HseeLfijzyXZjKWFh9QaLrMB4afo",
      authDomain: "tnl2026.firebaseapp.com",
      projectId: "tnl2026",
      storageBucket: "tnl2026.firebasestorage.app",
      messagingSenderId: "883525152224",
      appId: "1:883525152224:web:619ae152cd8df3fcca8f85",
      measurementId: "G-3K6LXCKHZ9"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const functions = firebase.functions();

    // State
    let allUsers = [];
    let currentAdmin = null;
    let isEditMode = false;
    let functionsAvailable = true;

    // Config
    const defaultConfig = {
      page_title: 'Account Management'
    };

    // Allowed roles
    const ALLOWED_ROLES = ['admin', 'manager', 'teacher', 'student', 'parent'];
    const ALLOWED_STATUSES = ['active', 'disabled', 'pending'];

    // DOM Elements
    const loadingState = document.getElementById('loadingState');
    const accessDenied = document.getElementById('accessDenied');
    const mainContent = document.getElementById('mainContent');
    const usersTableBody = document.getElementById('usersTableBody');
    const emptyState = document.getElementById('emptyState');
    const loadingTable = document.getElementById('loadingTable');
    const searchInput = document.getElementById('searchInput');
    const roleFilter = document.getElementById('roleFilter');
    const statusFilter = document.getElementById('statusFilter');
    const userModal = document.getElementById('userModal');
    const userForm = document.getElementById('userForm');
    const resetPasswordModal = document.getElementById('resetPasswordModal');
    const resetPasswordForm = document.getElementById('resetPasswordForm');
    const confirmModal = document.getElementById('confirmModal');

    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 ${
        type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-600' : 'bg-amber-600'
      }`;
      toast.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          ${type === 'success' 
            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>'
            : type === 'error'
            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>'
            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01"/>'}
        </svg>
        <span class="text-sm font-medium">${message}</span>
      `;
      document.getElementById('toastContainer').appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // Format date
    function formatDate(timestamp) {
      if (!timestamp) return '-';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Get role badge color
    function getRoleBadgeClass(role) {
      const colors = {
        admin: 'bg-purple-500/20 text-purple-400 border-purple-500/30',
        manager: 'bg-blue-500/20 text-blue-400 border-blue-500/30',
        teacher: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
        student: 'bg-amber-500/20 text-amber-400 border-amber-500/30',
        parent: 'bg-pink-500/20 text-pink-400 border-pink-500/30'
      };
      return colors[role] || 'bg-gray-500/20 text-gray-400 border-gray-500/30';
    }

    // Get status badge color
    function getStatusBadgeClass(status) {
      const colors = {
        active: 'bg-emerald-500/20 text-emerald-400 border-emerald-500/30',
        disabled: 'bg-red-500/20 text-red-400 border-red-500/30',
        pending: 'bg-amber-500/20 text-amber-400 border-amber-500/30'
      };
      return colors[status] || 'bg-gray-500/20 text-gray-400 border-gray-500/30';
    }

    // Render users table
    function renderUsersTable(users) {
      loadingTable.classList.add('hidden');
      
      if (users.length === 0) {
        usersTableBody.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      usersTableBody.innerHTML = users.map(user => `
        <tr class="hover:bg-gray-750 transition-colors">
          <td class="px-4 py-3">
            <span class="text-white font-medium">${user.profile?.displayName || user.displayName || '-'}</span>
          </td>
          <td class="px-4 py-3">
            <span class="text-gray-300 font-mono text-sm">${user.username || '-'}</span>
          </td>
          <td class="px-4 py-3">
            <span class="text-gray-400 text-sm">${user.loginEmail || user.email || '-'}</span>
          </td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 text-xs font-medium rounded border ${getRoleBadgeClass(user.role)}">${user.role || '-'}</span>
          </td>
          <td class="px-4 py-3">
            <span class="text-gray-300 text-sm font-mono">${user.links?.staffId || '-'}</span>
          </td>
          <td class="px-4 py-3">
            <span class="text-gray-300 text-sm font-mono">${user.links?.studentDocId || '-'}</span>
          </td>
          <td class="px-4 py-3">
            <span class="px-2 py-1 text-xs font-medium rounded border ${getStatusBadgeClass(user.status)}">${user.status || 'active'}</span>
          </td>
          <td class="px-4 py-3">
            <span class="text-gray-400 text-sm">${formatDate(user.updatedAt)}</span>
          </td>
          <td class="px-4 py-3 text-right">
            <div class="flex items-center justify-end gap-1">
              <button onclick="editUser('${user.id}')" class="p-1.5 text-gray-400 hover:text-white hover:bg-gray-700 rounded transition-colors" title="Edit">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
              </button>
              <button onclick="toggleUserStatus('${user.id}')" class="p-1.5 text-gray-400 hover:text-amber-400 hover:bg-gray-700 rounded transition-colors" title="${user.status === 'disabled' ? 'Enable' : 'Disable'}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  ${user.status === 'disabled' 
                    ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>'
                    : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21"/>'}
                </svg>
              </button>
              <button onclick="resetPassword('${user.id}')" class="p-1.5 text-gray-400 hover:text-emerald-400 hover:bg-gray-700 rounded transition-colors" title="Reset Password">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Filter users
    function filterUsers() {
      const search = searchInput.value.toLowerCase();
      const role = roleFilter.value;
      const status = statusFilter.value;

      const filtered = allUsers.filter(user => {
        const matchesSearch = !search || 
          (user.profile?.displayName || user.displayName || '').toLowerCase().includes(search) ||
          (user.username || '').toLowerCase().includes(search) ||
          (user.loginEmail || user.email || '').toLowerCase().includes(search);
        const matchesRole = !role || user.role === role;
        const matchesStatus = !status || user.status === status;
        return matchesSearch && matchesRole && matchesStatus;
      });

      renderUsersTable(filtered);
    }

    // Load users from Firestore
    async function loadUsers() {
      loadingTable.classList.remove('hidden');
      emptyState.classList.add('hidden');
      
      try {
        // Fetch all users without ordering (to avoid missing updatedAt field errors)
        const snapshot = await db.collection('users').get();
        allUsers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Sort client-side with safe fallback for missing updatedAt
        allUsers.sort((a, b) => {
          const aTime = a.updatedAt?.toMillis?.() || a.createdAt?.toMillis?.() || 0;
          const bTime = b.updatedAt?.toMillis?.() || b.createdAt?.toMillis?.() || 0;
          return bTime - aTime; // Descending order (newest first)
        });
        
        filterUsers();
      } catch (error) {
        console.error('Error loading users:', error);
        showToast('Failed to load users', 'error');
        loadingTable.classList.add('hidden');
      }
    }

    // Create a Firebase Auth user WITHOUT logging out the current admin
    async function createUserViaSecondaryAuth({ loginEmail, password, role, username, displayName, status }) {
      // Create secondary app instance
      let secondaryApp;
      try {
        secondaryApp = firebase.app('secondary');
      } catch (_) {
        secondaryApp = firebase.initializeApp(firebaseConfig, 'secondary');
      }

      const secondaryAuth = secondaryApp.auth();

      try {
        const cred = await secondaryAuth.createUserWithEmailAndPassword(loginEmail, password);
        const newUid = cred.user.uid;

        // Create/merge Firestore user doc (role MUST be top-level)
        await db.collection('users').doc(newUid).set({
          role: role,
          status: status || 'active',
          username: username,
          loginEmail: loginEmail,
          profile: { displayName: displayName || '' },
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        // Keep the admin session intact
        await secondaryAuth.signOut();

        // Clean up the secondary app to avoid leaks
        await secondaryApp.delete();

        return { uid: newUid };
      } catch (err) {
        // Try to clean up even if failed
        try { await secondaryAuth.signOut(); } catch (_) {}
        try { await secondaryApp.delete(); } catch (_) {}
        throw err;
      }
    }

    // Username validation
    function validateUsername(username) {
      if (!username) return 'Username is required';
      if (username.length < 3 || username.length > 40) return 'Username must be 3-40 characters';
      if (!/^[A-Za-z0-9_-]+$/.test(username)) return 'Only letters, numbers, underscore, and hyphen allowed';
      return null;
    }

    // Check if username is already taken (case-insensitive)
    async function isUsernameTaken(username, excludeUserId = null) {
      const normalizedUsername = username.toLowerCase();
      const snapshot = await db.collection('users')
        .where('username', '==', normalizedUsername)
        .get();
      
      if (snapshot.empty) return false;
      
      // If editing, check if the username belongs to a different user
      if (excludeUserId) {
        return snapshot.docs.some(doc => doc.id !== excludeUserId);
      }
      
      return true;
    }

    // Count total admins in the system
    async function countAdmins() {
      const snapshot = await db.collection('users')
        .where('role', '==', 'admin')
        .get();
      return snapshot.size;
    }

    // Check if user is the current admin
    function isCurrentAdmin(userId) {
      return currentAdmin && currentAdmin.uid === userId;
    }

    // Show error on field
    function showFieldError(fieldId, message) {
      const errorEl = document.getElementById(fieldId + 'Error');
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.classList.remove('hidden');
      }
    }

    // Clear field error
    function clearFieldError(fieldId) {
      const errorEl = document.getElementById(fieldId + 'Error');
      if (errorEl) {
        errorEl.classList.add('hidden');
      }
    }

    // Clear all errors
    function clearAllErrors() {
      ['displayName', 'username', 'loginEmail', 'role', 'password', 'confirmPassword', 'staffId', 'studentDocId'].forEach(clearFieldError);
      document.getElementById('formError').classList.add('hidden');
    }

    // Show/hide linking sections based on role
    function updateLinkingSections(role) {
      const staffSection = document.getElementById('staffLinkSection');
      const studentSection = document.getElementById('studentLinkSection');
      
      // Show Staff linking for admin, manager, teacher
      if (['admin', 'manager', 'teacher'].includes(role)) {
        staffSection.classList.remove('hidden');
      } else {
        staffSection.classList.add('hidden');
        clearStaffSelection();
      }
      
      // Show Student linking for student, parent
      if (['student', 'parent'].includes(role)) {
        studentSection.classList.remove('hidden');
      } else {
        studentSection.classList.add('hidden');
        clearStudentSelection();
      }
    }

    // Staff search functionality
    let staffSearchTimeout = null;
    const staffSearchInput = document.getElementById('staffSearchInput');
    const staffSearchResults = document.getElementById('staffSearchResults');
    const staffIdInput = document.getElementById('staffIdInput');
    const selectedStaffDisplay = document.getElementById('selectedStaffDisplay');
    const clearStaffBtn = document.getElementById('clearStaffBtn');

    async function searchStaff(query) {
      if (!query || query.length < 2) {
        staffSearchResults.classList.add('hidden');
        return;
      }

      try {
        const normalizedQuery = query.toLowerCase().trim();
        
        // Search by staffId, fullName, or preferredName
        const snapshot = await db.collection('staff')
          .where('status', '==', 'active')
          .get();

        const results = snapshot.docs
          .map(doc => ({ id: doc.id, ...doc.data() }))
          .filter(staff => {
            const staffId = (staff.staffId || '').toLowerCase();
            const fullName = (staff.fullName || '').toLowerCase();
            const preferredName = (staff.preferredName || '').toLowerCase();
            return staffId.includes(normalizedQuery) || 
                   fullName.includes(normalizedQuery) || 
                   preferredName.includes(normalizedQuery);
          })
          .slice(0, 10); // Limit to 10 results

        if (results.length === 0) {
          staffSearchResults.innerHTML = '<div class="px-4 py-2 text-gray-400 text-sm">No staff found</div>';
          staffSearchResults.classList.remove('hidden');
          return;
        }

        staffSearchResults.innerHTML = results.map(staff => `
          <div class="staff-result-item px-4 py-2 hover:bg-gray-600 cursor-pointer transition-colors" 
               data-id="${staff.id}" 
               data-staff-id="${staff.staffId || ''}"
               data-name="${staff.fullName || ''}"
               data-preferred="${staff.preferredName || ''}">
            <p class="text-white text-sm font-medium">${staff.fullName || 'Unknown'}</p>
            <div class="flex items-center gap-2 text-xs text-gray-400">
              <span class="font-mono">${staff.staffId || 'No ID'}</span>
              ${staff.preferredName ? `<span>• ${staff.preferredName}</span>` : ''}
              ${staff.roles && staff.roles.length > 0 ? `<span>• ${staff.roles.join(', ')}</span>` : ''}
            </div>
          </div>
        `).join('');

        staffSearchResults.classList.remove('hidden');

        // Add click handlers
        document.querySelectorAll('.staff-result-item').forEach(item => {
          item.addEventListener('click', () => {
            selectStaff(
              item.dataset.id,
              item.dataset.staffId,
              item.dataset.name,
              item.dataset.preferred
            );
          });
        });
      } catch (error) {
        console.error('Error searching staff:', error);
        staffSearchResults.innerHTML = '<div class="px-4 py-2 text-red-400 text-sm">Search failed</div>';
        staffSearchResults.classList.remove('hidden');
      }
    }

    function selectStaff(docId, staffId, fullName, preferredName) {
      staffIdInput.value = docId;
      staffSearchInput.value = '';
      staffSearchResults.classList.add('hidden');
      
      document.getElementById('selectedStaffName').textContent = fullName + (preferredName ? ` (${preferredName})` : '');
      document.getElementById('selectedStaffId').textContent = staffId;
      selectedStaffDisplay.classList.remove('hidden');
      clearFieldError('staffId');
    }

    function clearStaffSelection() {
      staffIdInput.value = '';
      staffSearchInput.value = '';
      staffSearchResults.classList.add('hidden');
      selectedStaffDisplay.classList.add('hidden');
    }

    staffSearchInput.addEventListener('input', (e) => {
      clearTimeout(staffSearchTimeout);
      staffSearchTimeout = setTimeout(() => searchStaff(e.target.value), 300);
    });

    staffSearchInput.addEventListener('focus', () => {
      if (staffSearchInput.value.length >= 2) {
        searchStaff(staffSearchInput.value);
      }
    });

    clearStaffBtn.addEventListener('click', clearStaffSelection);

    // Click outside to close
    document.addEventListener('click', (e) => {
      if (!staffSearchInput.contains(e.target) && !staffSearchResults.contains(e.target)) {
        staffSearchResults.classList.add('hidden');
      }
    });

    // Student search functionality
    let studentSearchTimeout = null;
    const studentSearchInput = document.getElementById('studentSearchInput');
    const studentSearchResults = document.getElementById('studentSearchResults');
    const studentDocIdInput = document.getElementById('studentDocIdInput');
    const selectedStudentDisplay = document.getElementById('selectedStudentDisplay');
    const clearStudentBtn = document.getElementById('clearStudentBtn');

    async function searchStudent(query) {
      if (!query || query.length < 2) {
        studentSearchResults.classList.add('hidden');
        return;
      }

      try {
        const normalizedQuery = query.toLowerCase().trim();
        
        // Search by publicCode, fullName, or normalizedName
        const snapshot = await db.collection('students')
          .where('isDeleted', '==', false)
          .where('status', '==', 'active')
          .get();

        const results = snapshot.docs
          .map(doc => ({ id: doc.id, ...doc.data() }))
          .filter(student => {
            const publicCode = (student.publicCode || '').toLowerCase();
            const fullName = (student.fullName || '').toLowerCase();
            const normalizedName = (student.normalizedName || '').toLowerCase();
            return publicCode.includes(normalizedQuery) || 
                   fullName.includes(normalizedQuery) || 
                   normalizedName.includes(normalizedQuery);
          })
          .slice(0, 10); // Limit to 10 results

        if (results.length === 0) {
          studentSearchResults.innerHTML = '<div class="px-4 py-2 text-gray-400 text-sm">No students found</div>';
          studentSearchResults.classList.remove('hidden');
          return;
        }

        studentSearchResults.innerHTML = results.map(student => `
          <div class="student-result-item px-4 py-2 hover:bg-gray-600 cursor-pointer transition-colors" 
               data-id="${student.id}" 
               data-code="${student.publicCode || ''}"
               data-name="${student.fullName || ''}">
            <p class="text-white text-sm font-medium">${student.fullName || 'Unknown'}</p>
            <div class="flex items-center gap-2 text-xs text-gray-400">
              <span class="font-mono">${student.publicCode || 'No Code'}</span>
              ${student.dob ? `<span>• DOB: ${student.dob}</span>` : ''}
            </div>
          </div>
        `).join('');

        studentSearchResults.classList.remove('hidden');

        // Add click handlers
        document.querySelectorAll('.student-result-item').forEach(item => {
          item.addEventListener('click', () => {
            selectStudent(
              item.dataset.id,
              item.dataset.code,
              item.dataset.name
            );
          });
        });
      } catch (error) {
        console.error('Error searching students:', error);
        studentSearchResults.innerHTML = '<div class="px-4 py-2 text-red-400 text-sm">Search failed</div>';
        studentSearchResults.classList.remove('hidden');
      }
    }

    function selectStudent(docId, publicCode, fullName) {
      studentDocIdInput.value = docId;
      studentSearchInput.value = '';
      studentSearchResults.classList.add('hidden');
      
      document.getElementById('selectedStudentName').textContent = fullName;
      document.getElementById('selectedStudentCode').textContent = publicCode;
      selectedStudentDisplay.classList.remove('hidden');
      clearFieldError('studentDocId');
    }

    function clearStudentSelection() {
      studentDocIdInput.value = '';
      studentSearchInput.value = '';
      studentSearchResults.classList.add('hidden');
      selectedStudentDisplay.classList.add('hidden');
    }

    studentSearchInput.addEventListener('input', (e) => {
      clearTimeout(studentSearchTimeout);
      studentSearchTimeout = setTimeout(() => searchStudent(e.target.value), 300);
    });

    studentSearchInput.addEventListener('focus', () => {
      if (studentSearchInput.value.length >= 2) {
        searchStudent(studentSearchInput.value);
      }
    });

    clearStudentBtn.addEventListener('click', clearStudentSelection);

    // Click outside to close
    document.addEventListener('click', (e) => {
      if (!studentSearchInput.contains(e.target) && !studentSearchResults.contains(e.target)) {
        studentSearchResults.classList.add('hidden');
      }
    });

    // Validate Staff ID exists
    async function validateStaffId(staffDocId) {
      if (!staffDocId || staffDocId.trim() === '') return null; // Empty is OK
      
      try {
        const doc = await db.collection('staff').doc(staffDocId.trim()).get();
        if (!doc.exists) {
          return 'Staff member not found';
        }
        return null;
      } catch (error) {
        console.error('Error validating staff ID:', error);
        return 'Failed to validate staff member';
      }
    }

    // Validate Student Doc ID exists
    async function validateStudentDocId(studentDocId) {
      if (!studentDocId || studentDocId.trim() === '') return null; // Empty is OK
      
      try {
        const doc = await db.collection('students').doc(studentDocId.trim()).get();
        if (!doc.exists) {
          return 'Student not found';
        }
        return null;
      } catch (error) {
        console.error('Error validating student doc ID:', error);
        return 'Failed to validate student';
      }
    }

    // Update reverse links in staff/students collections
    async function updateReverseLinks(userId, newStaffId, newStudentDocId, oldStaffId, oldStudentDocId) {
      // Handle staff link
      if (newStaffId !== oldStaffId) {
        // Remove old link if exists
        if (oldStaffId) {
          try {
            const oldStaffDoc = await db.collection('staff').doc(oldStaffId).get();
            if (oldStaffDoc.exists && oldStaffDoc.data().authUid === userId) {
              await db.collection('staff').doc(oldStaffId).update({
                authUid: firebase.firestore.FieldValue.delete()
              });
            }
          } catch (error) {
            console.warn('Failed to remove old staff link:', error);
          }
        }
        
        // Add new link if provided
        if (newStaffId) {
          try {
            await db.collection('staff').doc(newStaffId).set({
              authUid: userId
            }, { merge: true });
          } catch (error) {
            console.warn('Failed to add new staff link:', error);
          }
        }
      }
      
      // Handle student link
      if (newStudentDocId !== oldStudentDocId) {
        // Remove old link if exists
        if (oldStudentDocId) {
          try {
            const oldStudentDoc = await db.collection('students').doc(oldStudentDocId).get();
            if (oldStudentDoc.exists && oldStudentDoc.data().authUid === userId) {
              await db.collection('students').doc(oldStudentDocId).update({
                authUid: firebase.firestore.FieldValue.delete()
              });
            }
          } catch (error) {
            console.warn('Failed to remove old student link:', error);
          }
        }
        
        // Add new link if provided
        if (newStudentDocId) {
          try {
            await db.collection('students').doc(newStudentDocId).set({
              authUid: userId
            }, { merge: true });
          } catch (error) {
            console.warn('Failed to add new student link:', error);
          }
        }
      }
    }

    // Open create modal
    function openCreateModal() {
      isEditMode = false;
      document.getElementById('modalTitle').textContent = 'Create User';
      document.getElementById('saveBtnText').textContent = 'Create User';
      document.getElementById('editUserId').value = '';
      document.getElementById('passwordSection').classList.remove('hidden');
      userForm.reset();
      document.getElementById('statusInput').value = 'active';
      document.getElementById('staffIdInput').value = '';
      document.getElementById('studentDocIdInput').value = '';
      
      // Enable both dropdowns for create mode
      document.getElementById('roleInput').disabled = false;
      document.getElementById('roleInput').title = '';
      document.getElementById('statusInput').disabled = false;
      document.getElementById('statusInput').title = '';
      
      updateLinkingSections(''); // Hide both initially
      clearAllErrors();
      userModal.classList.remove('hidden');
    }

    // Edit user
    async function editUser(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;

      isEditMode = true;
      document.getElementById('modalTitle').textContent = 'Edit User';
      document.getElementById('saveBtnText').textContent = 'Save Changes';
      document.getElementById('editUserId').value = userId;
      document.getElementById('passwordSection').classList.add('hidden');
      document.getElementById('displayNameInput').value = user.profile?.displayName || user.displayName || '';
      document.getElementById('usernameInput').value = user.username || '';
      document.getElementById('loginEmailInput').value = user.loginEmail || user.email || '';
      document.getElementById('roleInput').value = user.role || '';
      document.getElementById('statusInput').value = user.status || 'active';
      
      // Load existing links
      if (user.links?.staffId) {
        try {
          const staffDoc = await db.collection('staff').doc(user.links.staffId).get();
          if (staffDoc.exists) {
            const staffData = staffDoc.data();
            selectStaff(staffDoc.id, staffData.staffId, staffData.fullName, staffData.preferredName);
          }
        } catch (error) {
          console.error('Error loading staff link:', error);
        }
      } else {
        clearStaffSelection();
      }

      if (user.links?.studentDocId) {
        try {
          const studentDoc = await db.collection('students').doc(user.links.studentDocId).get();
          if (studentDoc.exists) {
            const studentData = studentDoc.data();
            selectStudent(studentDoc.id, studentData.publicCode, studentData.fullName);
          }
        } catch (error) {
          console.error('Error loading student link:', error);
        }
      } else {
        clearStudentSelection();
      }
      
      // Update linking sections based on role
      updateLinkingSections(user.role || '');
      
      // Check admin safety rules
      const isSelf = isCurrentAdmin(userId);
      const totalAdmins = await countAdmins();
      const isLastAdmin = user.role === 'admin' && totalAdmins === 1;
      
      const roleInput = document.getElementById('roleInput');
      const statusInput = document.getElementById('statusInput');
      
      // Reset both to enabled first
      roleInput.disabled = false;
      roleInput.title = '';
      statusInput.disabled = false;
      statusInput.title = '';
      
      // Apply restrictions only if needed
      if (isSelf) {
        roleInput.disabled = true;
        roleInput.title = 'You cannot change your own role';
        statusInput.disabled = true;
        statusInput.title = 'You cannot disable your own account';
      } else if (isLastAdmin) {
        roleInput.disabled = true;
        roleInput.title = 'Cannot change role of the last admin';
        statusInput.disabled = true;
        statusInput.title = 'Cannot disable the last admin';
      }
      
      clearAllErrors();
      userModal.classList.remove('hidden');
    }

    // Close modal
    function closeModal() {
      userModal.classList.add('hidden');
    }

    // Auto-generate login email
    document.getElementById('usernameInput').addEventListener('input', (e) => {
      const username = e.target.value.trim();
      const loginEmailInput = document.getElementById('loginEmailInput');
      if (!isEditMode && username) {
        loginEmailInput.value = `${username}@tnl.local`;
      }
    });

    // Update linking sections when role changes
    document.getElementById('roleInput').addEventListener('change', (e) => {
      updateLinkingSections(e.target.value);
    });

    // Handle form submit
    userForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearAllErrors();

      const userId = document.getElementById('editUserId').value;
      const displayName = document.getElementById('displayNameInput').value.trim();
      let username = document.getElementById('usernameInput').value.trim();
      let loginEmail = document.getElementById('loginEmailInput').value.trim();
      const role = document.getElementById('roleInput').value;
      const status = document.getElementById('statusInput').value;
      const password = document.getElementById('passwordInput').value;
      const confirmPassword = document.getElementById('confirmPasswordInput').value;
      let staffId = document.getElementById('staffIdInput').value.trim();
      let studentDocId = document.getElementById('studentDocIdInput').value.trim();

      // Normalize username and loginEmail to lowercase
      username = username.toLowerCase();
      loginEmail = loginEmail.toLowerCase() || `${username}@tnl.local`;

      // Validation
      let hasError = false;

      if (!displayName) {
        showFieldError('displayName', 'Display name is required');
        hasError = true;
      }

      const usernameError = validateUsername(username);
      if (usernameError) {
        showFieldError('username', usernameError);
        hasError = true;
      } else {
        // Check for duplicate username
        const isTaken = await isUsernameTaken(username, isEditMode ? userId : null);
        if (isTaken) {
          showFieldError('username', 'This username is already taken');
          hasError = true;
        }
      }

      if (!role) {
        showFieldError('role', 'Role is required');
        hasError = true;
      } else if (!ALLOWED_ROLES.includes(role)) {
        showFieldError('role', 'Invalid role selected');
        hasError = true;
      }

      // Validate Staff ID if provided
      if (staffId) {
        const staffError = await validateStaffId(staffId);
        if (staffError) {
          showFieldError('staffId', staffError);
          hasError = true;
        }
      }

      // Validate Student Doc ID if provided
      if (studentDocId) {
        const studentError = await validateStudentDocId(studentDocId);
        if (studentError) {
          showFieldError('studentDocId', studentError);
          hasError = true;
        }
      }

      // Admin safety checks
      if (isEditMode) {
        const user = allUsers.find(u => u.id === userId);
        const isSelf = isCurrentAdmin(userId);
        const totalAdmins = await countAdmins();
        const isLastAdmin = user?.role === 'admin' && totalAdmins === 1;

        // Prevent current admin from removing their own admin role
        if (isSelf && user?.role === 'admin' && role !== 'admin') {
          showFieldError('role', 'You cannot remove your own admin role');
          hasError = true;
        }

        // Prevent current admin from disabling their own account
        if (isSelf && status === 'disabled') {
          showFieldError('role', 'You cannot disable your own account');
          hasError = true;
        }

        // Prevent demoting or disabling the last admin
        if (isLastAdmin) {
          if (role !== 'admin') {
            showFieldError('role', 'Cannot change role of the last admin');
            hasError = true;
          }
          if (status === 'disabled') {
            showFieldError('role', 'Cannot disable the last admin');
            hasError = true;
          }
        }
      }

      if (!isEditMode) {
        if (!password) {
          showFieldError('password', 'Password is required');
          hasError = true;
        } else if (password.length < 8) {
          showFieldError('password', 'Password must be at least 8 characters');
          hasError = true;
        }

        if (password !== confirmPassword) {
          showFieldError('confirmPassword', 'Passwords do not match');
          hasError = true;
        }
      }

      if (hasError) return;

      // Show loading
      document.getElementById('saveBtn').disabled = true;
      document.getElementById('saveBtnText').textContent = isEditMode ? 'Saving...' : 'Creating...';
      document.getElementById('saveBtnSpinner').classList.remove('hidden');

      try {
        if (isEditMode) {
          // Get old link values for comparison
          const user = allUsers.find(u => u.id === userId);
          const oldStaffId = user?.links?.staffId || null;
          const oldStudentDocId = user?.links?.studentDocId || null;

          // Update existing user - Direct Firestore update
          try {
            // Build update object
            const updateData = {
              role: role,
              status: status,
              username: username,
              loginEmail: loginEmail,
              'profile.displayName': displayName,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Add links object
            updateData['links.staffId'] = staffId || null;
            updateData['links.studentDocId'] = studentDocId || null;

            await db.collection('users').doc(userId).update(updateData);

            // Update reverse links
            await updateReverseLinks(userId, staffId || null, studentDocId || null, oldStaffId, oldStudentDocId);

            showToast('User updated successfully');
          } catch (updateError) {
            console.error('Firestore update error:', updateError);
            throw new Error('Failed to update user: ' + updateError.message);
          }
        } else {
          // Create new user (prefer Cloud Function if available, fallback to secondary auth)
          try {
            let newUid = null;

            // Try Cloud Function first (if it exists)
            try {
              const adminCreateUser = functions.httpsCallable('adminCreateUser');
              const result = await adminCreateUser({
                loginEmail,
                password,
                role,
                username,
                displayName,
                status
              });
              newUid = result?.data?.uid || null;
            } catch (fnError) {
              // If Functions are blocked (billing) / not deployed / CORS / internal → fallback
              console.warn('adminCreateUser failed, falling back to secondary auth:', fnError);
            }

            // Fallback path (NO Functions, NO billing)
            if (!newUid) {
              const created = await createUserViaSecondaryAuth({
                loginEmail,
                password,
                role,
                username,
                displayName,
                status
              });
              newUid = created.uid;
            }

            // Add links to the newly created user
            if (staffId || studentDocId) {
              await db.collection('users').doc(newUid).update({
                'links.staffId': staffId || null,
                'links.studentDocId': studentDocId || null
              });

              // Update reverse links
              await updateReverseLinks(newUid, staffId || null, studentDocId || null, null, null);
            }

            showToast('User created successfully');
          } catch (createError) {
            throw createError;
          }
        }

        closeModal();
        await loadUsers();
      } catch (error) {
        console.error('Error saving user:', error);
        document.getElementById('formError').textContent = error.message || 'Failed to save user';
        document.getElementById('formError').classList.remove('hidden');
      } finally {
        document.getElementById('saveBtn').disabled = false;
        document.getElementById('saveBtnText').textContent = isEditMode ? 'Save Changes' : 'Create User';
        document.getElementById('saveBtnSpinner').classList.add('hidden');
      }
    });

    // Toggle user status
    async function toggleUserStatus(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;

      // Safety checks
      const isSelf = isCurrentAdmin(userId);
      const totalAdmins = await countAdmins();
      const isLastAdmin = user.role === 'admin' && totalAdmins === 1;

      // Prevent current admin from disabling themselves
      if (isSelf && user.status !== 'disabled') {
        showToast('You cannot disable your own account', 'error');
        return;
      }

      // Prevent disabling the last admin
      if (isLastAdmin && user.status !== 'disabled') {
        showToast('Cannot disable the last admin', 'error');
        return;
      }

      const newStatus = user.status === 'disabled' ? 'active' : 'disabled';
      const action = newStatus === 'disabled' ? 'disable' : 'enable';

      document.getElementById('confirmUserId').value = userId;
      document.getElementById('confirmAction').value = newStatus;
      document.getElementById('confirmTitle').textContent = `${action.charAt(0).toUpperCase() + action.slice(1)} User?`;
      document.getElementById('confirmMessage').textContent = `Are you sure you want to ${action} ${user.profile?.displayName || user.username || 'this user'}?`;
      document.getElementById('confirmBtnText').textContent = action.charAt(0).toUpperCase() + action.slice(1);
      confirmModal.classList.remove('hidden');
    }

    // Handle confirm action
    document.getElementById('confirmActionBtn').addEventListener('click', async () => {
      const userId = document.getElementById('confirmUserId').value;
      const newStatus = document.getElementById('confirmAction').value;

      document.getElementById('confirmActionBtn').disabled = true;
      document.getElementById('confirmBtnSpinner').classList.remove('hidden');

      try {
        // Direct Firestore update (no Cloud Function needed)
        await db.collection('users').doc(userId).update({
          status: newStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast(`User ${newStatus === 'disabled' ? 'disabled' : 'enabled'} successfully`);
        confirmModal.classList.add('hidden');
        await loadUsers();
      } catch (error) {
        console.error('Error updating status:', error);
        showToast('Failed to update user status', 'error');
      } finally {
        document.getElementById('confirmActionBtn').disabled = false;
        document.getElementById('confirmBtnSpinner').classList.add('hidden');
      }
    });

    // Reset password
    function resetPassword(userId) {
      const user = allUsers.find(u => u.id === userId);
      if (!user) return;

      document.getElementById('resetUserId').value = userId;
      document.getElementById('resetUserInfo').textContent = `For: ${user.profile?.displayName || user.username || user.loginEmail}`;
      document.getElementById('newPasswordInput').value = '';
      document.getElementById('confirmNewPasswordInput').value = '';
      document.getElementById('newPasswordError').classList.add('hidden');
      document.getElementById('confirmNewPasswordError').classList.add('hidden');
      document.getElementById('resetFormError').classList.add('hidden');
      resetPasswordModal.classList.remove('hidden');
    }

    // Handle reset password form
    resetPasswordForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const userId = document.getElementById('resetUserId').value;
      const newPassword = document.getElementById('newPasswordInput').value;
      const confirmNewPassword = document.getElementById('confirmNewPasswordInput').value;

      document.getElementById('newPasswordError').classList.add('hidden');
      document.getElementById('confirmNewPasswordError').classList.add('hidden');
      document.getElementById('resetFormError').classList.add('hidden');

      let hasError = false;

      if (!newPassword) {
        document.getElementById('newPasswordError').textContent = 'Password is required';
        document.getElementById('newPasswordError').classList.remove('hidden');
        hasError = true;
      } else if (newPassword.length < 8) {
        document.getElementById('newPasswordError').textContent = 'Password must be at least 8 characters';
        document.getElementById('newPasswordError').classList.remove('hidden');
        hasError = true;
      }

      if (newPassword !== confirmNewPassword) {
        document.getElementById('confirmNewPasswordError').textContent = 'Passwords do not match';
        document.getElementById('confirmNewPasswordError').classList.remove('hidden');
        hasError = true;
      }

      if (hasError) return;

      document.getElementById('resetBtn').disabled = true;
      document.getElementById('resetBtnText').textContent = 'Resetting...';
      document.getElementById('resetBtnSpinner').classList.remove('hidden');

      try {
        // Password reset DISABLED (requires Cloud Functions with proper CORS)
        document.getElementById('resetFormError').textContent = 'Password reset requires Cloud Functions with CORS enabled. Please configure and deploy the adminResetPassword function, or contact your system administrator.';
        document.getElementById('resetFormError').classList.remove('hidden');
      } catch (error) {
        console.error('Error resetting password:', error);
        document.getElementById('resetFormError').textContent = error.message || 'Failed to reset password';
        document.getElementById('resetFormError').classList.remove('hidden');
      } finally {
        document.getElementById('resetBtn').disabled = false;
        document.getElementById('resetBtnText').textContent = 'Reset Password';
        document.getElementById('resetBtnSpinner').classList.add('hidden');
      }
    });

    // Event listeners
    document.getElementById('createUserBtn').addEventListener('click', openCreateModal);
    document.getElementById('cancelBtn').addEventListener('click', closeModal);
    document.getElementById('cancelResetBtn').addEventListener('click', () => resetPasswordModal.classList.add('hidden'));
    document.getElementById('confirmCancelBtn').addEventListener('click', () => confirmModal.classList.add('hidden'));
    searchInput.addEventListener('input', filterUsers);
    roleFilter.addEventListener('change', filterUsers);
    statusFilter.addEventListener('change', filterUsers);

    // Close modals on backdrop click
    userModal.addEventListener('click', (e) => { if (e.target === userModal) closeModal(); });
    resetPasswordModal.addEventListener('click', (e) => { if (e.target === resetPasswordModal) resetPasswordModal.classList.add('hidden'); });
    confirmModal.addEventListener('click', (e) => { if (e.target === confirmModal) confirmModal.classList.add('hidden'); });

    // Element SDK
    async function onConfigChange(config) {
      document.getElementById('pageTitle').textContent = config.page_title || defaultConfig.page_title;
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ['page_title', config.page_title || defaultConfig.page_title]
      ]);
    }

    // AdminGuard - Check authentication and admin role
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        // Not logged in - redirect to Authen.html
        window.location.href = 'Authen.html?next=Account_Manager.html';
        return;
      }

      try {
        // Load user document from Firestore
        const userDoc = await db.collection('users').doc(user.uid).get();
        const userData = userDoc.data();

        if (!userData || userData.role !== 'admin') {
          // Not admin - show access denied
          loadingState.classList.add('hidden');
          accessDenied.classList.remove('hidden');
          return;
        }

        // User is admin - show main content
        currentAdmin = { uid: user.uid, ...userData };
        document.getElementById('adminInfo').textContent = `Logged in as: ${userData.profile?.displayName || user.email}`;
        
        loadingState.classList.add('hidden');
        mainContent.classList.remove('hidden');
        
        // Load users
        await loadUsers();

      } catch (error) {
        console.error('Error checking admin status:', error);
        loadingState.classList.add('hidden');
        accessDenied.classList.remove('hidden');
      }
    });

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bf4f175d6b30454',t:'MTc2ODY0MzM3My4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>