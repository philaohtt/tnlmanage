<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Staff Directory - School Management System</title>
  <script src="/_sdk/element_sdk.js"></script><!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { 
      getFirestore, 
      collection, 
      doc, 
      setDoc, 
      updateDoc, 
      deleteDoc, 
      onSnapshot,
      query,
      where,
      serverTimestamp,
      runTransaction,
      orderBy
    } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCDzv0HseeLfijzyXZjKWFh9QaLrMB4afo",
      authDomain: "tnl2026.firebaseapp.com",
      projectId: "tnl2026",
      storageBucket: "tnl2026.firebasestorage.app",
      messagingSenderId: "883525152224",
      appId: "1:883525152224:web:619ae152cd8df3fcca8f85",
      measurementId: "G-3K6LXCKHZ9"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Make Firebase utilities available globally
    window.firebaseApp = app;
    window.db = db;
    window.firebaseUtils = {
      collection,
      doc,
      setDoc,
      updateDoc,
      deleteDoc,
      onSnapshot,
      query,
      where,
      serverTimestamp,
      runTransaction,
      orderBy
    };

    // Signal that Firebase is ready
    window.firebaseReady = true;
    window.dispatchEvent(new Event('firebase-ready'));
  </script>
  <style>
    body {
      box-sizing: border-box;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body, #app {
      height: 100%;
      width: 100%;
    }

    body {
      font-family: Inter, system-ui, -apple-system, sans-serif;
      background: #f8f9fa;
      color: #1a1a1a;
      line-height: 1.5;
      font-size: 13px;
    }

    #app {
      display: flex;
      flex-direction: column;
      overflow: auto;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
      width: 100%;
    }

    .header {
      margin-bottom: 24px;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 16px;
    }

    .header-content h1 {
      font-size: 1.85em;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 4px;
    }

    .header-content p {
      font-size: 1em;
      color: #64748b;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 1em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      opacity: 0.9;
    }

    .btn-secondary {
      background: white;
      color: #64748b;
      border: 1px solid #e5e7eb;
    }

    .btn-secondary:hover:not(:disabled) {
      border-color: #2563eb;
      color: #2563eb;
    }

    .btn-danger {
      background: #dc2626;
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      opacity: 0.9;
    }

    .btn-warning {
      background: #f59e0b;
      color: white;
    }

    .btn-warning:hover:not(:disabled) {
      opacity: 0.9;
    }

    .btn-icon {
      background: white;
      color: #64748b;
      border: 1px solid #e5e7eb;
      padding: 8px;
    }

    .btn-icon:hover:not(:disabled) {
      border-color: #2563eb;
      color: #2563eb;
    }

    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 16px;
      padding: 16px;
      background: white;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
    }

    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 8px 12px 8px 36px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 1em;
      background: #f8f9fa;
      transition: border-color 0.2s;
    }

    .search-box input:focus {
      outline: none;
      border-color: #2563eb;
      background: white;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #64748b;
      font-size: 0.9em;
    }

    select {
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 1em;
      background: white;
      cursor: pointer;
      transition: border-color 0.2s;
      color: #1a1a1a;
    }

    select:focus {
      outline: none;
      border-color: #2563eb;
    }

    .count-label {
      font-size: 0.95em;
      color: #64748b;
      margin-left: auto;
    }

    .card {
      background: white;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f8f9fa;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      padding: 12px 16px;
      text-align: left;
      font-size: 0.85em;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #e5e7eb;
    }

    td {
      padding: 12px 16px;
      border-bottom: 1px solid #f1f3f5;
      font-size: 1em;
    }

    tbody tr {
      cursor: pointer;
      transition: background-color 0.15s;
    }

    tbody tr:hover {
      background: #f8f9fa;
    }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #2563eb;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.95em;
    }

    .staff-name {
      font-weight: 600;
      color: #1a1a1a;
    }

    .roles-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .role-badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: 500;
      background: #dbeafe;
      color: #1e40af;
      min-width: 60px;
      text-align: center;
      display: inline-block;
    }

    .roles-list-wrapper {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .roles-row {
      display: flex;
      gap: 6px;
    }

    .contact-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .contact-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.95em;
    }

    .contact-icon {
      color: #64748b;
      font-size: 0.9em;
    }

    .status-badge {
      padding: 3px 10px;
      border-radius: 4px;
      font-size: 0.85em;
      font-weight: 600;
      text-transform: capitalize;
    }

    .status-active {
      background: #d1fae5;
      color: #065f46;
    }

    .status-inactive {
      background: #f3f4f6;
      color: #4b5563;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 0.9em;
    }

    .btn-icon-action {
      padding: 6px;
      border-radius: 4px;
      background: transparent;
      border: 1px solid #e5e7eb;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
    }

    .btn-icon-action:hover {
      background: #f8f9fa;
      border-color: #64748b;
    }

    .btn-icon-action.edit:hover {
      background: #dbeafe;
      border-color: #2563eb;
    }

    .btn-icon-action.toggle-status:hover {
      background: #fef3c7;
      border-color: #f59e0b;
    }

    .empty-state {
      text-align: center;
      padding: 60px 24px;
    }

    .empty-icon {
      font-size: 3em;
      margin-bottom: 12px;
      opacity: 0.3;
    }

    .empty-state h3 {
      font-size: 1.3em;
      color: #1a1a1a;
      margin-bottom: 6px;
      font-weight: 600;
    }

    .empty-state p {
      color: #64748b;
      margin-bottom: 20px;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(2px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 600px;
      max-height: 90%;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid #e5e7eb;
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 1.4em;
      color: #1a1a1a;
      font-weight: 700;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.6em;
      color: #64748b;
      cursor: pointer;
      padding: 0;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .modal-close:hover {
      background: #f1f3f5;
      color: #1a1a1a;
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 500;
      font-size: 0.95em;
      color: #1a1a1a;
    }

    .form-group label.required::after {
      content: " *";
      color: #dc2626;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #e5e7eb;
      border-radius: 6px;
      font-size: 1em;
      transition: border-color 0.2s;
      font-family: inherit;
      background: #f8f9fa;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #2563eb;
      background: white;
    }

    .form-group input:disabled,
    .form-group textarea:disabled {
      background: #f8f9fa;
      color: #64748b;
      cursor: not-allowed;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 70px;
    }

    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .checkbox-item input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
      accent-color: #2563eb;
    }

    .checkbox-item label {
      margin: 0;
      cursor: pointer;
      font-weight: 400;
    }

    .modal-footer {
      padding: 16px 20px;
      border-top: 1px solid #e5e7eb;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    .toast-container {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .toast {
      background: white;
      padding: 14px 16px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 280px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast-success {
      border-left: 3px solid #10b981;
    }

    .toast-error {
      border-left: 3px solid #dc2626;
    }

    .toast-warning {
      border-left: 3px solid #f59e0b;
    }

    .toast-icon {
      font-size: 1.3em;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      margin-bottom: 2px;
      font-size: 0.95em;
    }

    .toast-message {
      font-size: 0.9em;
      color: #64748b;
    }

    .confirm-modal .modal {
      max-width: 400px;
    }

    .confirm-modal .modal-body {
      padding: 28px 20px;
      text-align: center;
    }

    .confirm-icon {
      font-size: 3em;
      margin-bottom: 12px;
    }

    .confirm-icon-warning {
      color: #f59e0b;
    }

    .confirm-icon-danger {
      color: #dc2626;
    }

    .confirm-modal h3 {
      font-size: 1.3em;
      margin-bottom: 6px;
      color: #1a1a1a;
      font-weight: 700;
    }

    .confirm-modal p {
      color: #64748b;
      margin-bottom: 20px;
    }

    .two-column {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px 16px;
      }

      .header-top {
        flex-direction: column;
        align-items: stretch;
      }

      .header-actions {
        justify-content: stretch;
      }

      .header-actions button {
        flex: 1;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      .search-box {
        width: 100%;
      }

      .count-label {
        margin-left: 0;
      }

      .two-column {
        grid-template-columns: 1fr;
      }

      th, td {
        padding: 12px 8px;
        font-size: 13px;
      }

      .action-buttons {
        flex-direction: column;
      }
    }

    .loading-spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div id="app">
   <div class="container">
    <div class="header">
     <div class="header-top">
      <div class="header-content">
       <h1 id="page-title">Staff Directory</h1>
       <p id="page-subtitle">Manage teachers and staff profiles</p>
      </div>
      <div class="header-actions"><button class="btn btn-primary" id="add-staff-btn"> <span>+</span> <span>Add Staff</span> </button> <button class="btn btn-secondary" id="import-csv-btn"> <span>üì•</span> <span>Import CSV</span> </button> <button class="btn btn-icon" id="refresh-btn" title="Refresh"> <span>üîÑ</span> </button>
      </div>
     </div>
     <div class="controls">
      <div class="search-box"><span class="search-icon">üîç</span> <input type="text" id="search-input" placeholder="Search name, email, phone...">
      </div><select id="role-filter"> <option value="">All Roles</option> <option value="Admin">Admin</option> <option value="Manager">Manager</option> <option value="Teacher">Teacher</option> <option value="Staff">Staff</option> </select> <select id="status-filter"> <option value="">All Status</option> <option value="active">Active</option> <option value="inactive">Inactive</option> </select> <select id="sort-select"> <option value="name-asc">Name A ‚Üí Z</option> <option value="name-desc">Name Z ‚Üí A</option> <option value="newest">Newest</option> <option value="oldest">Oldest</option> </select> <span class="count-label" id="count-label">Showing 0 of 0</span>
     </div>
    </div>
    <div class="card">
     <div class="table-container">
      <div id="table-content"></div>
     </div>
    </div>
   </div>
  </div>
  <div class="modal-overlay" id="staff-modal-overlay">
   <div class="modal">
    <div class="modal-header">
     <h2 id="modal-title">Add Staff</h2><button class="modal-close" id="modal-close-btn">√ó</button>
    </div>
    <div class="modal-body">
     <form id="staff-form">
      <div class="form-group"><label>Staff ID</label> <input type="text" id="staff-id-input" disabled>
      </div>
      <div class="form-group"><label class="required">Full Name</label> <input type="text" id="full-name-input" required>
      </div>
      <div class="form-group"><label>Preferred Name</label> <input type="text" id="preferred-name-input">
      </div>
      <div class="two-column">
       <div class="form-group"><label>Email</label> <input type="email" id="email-input">
       </div>
       <div class="form-group"><label>Phone</label> <input type="tel" id="phone-input">
       </div>
      </div>
      <div class="form-group"><label>Roles</label>
       <div class="checkbox-group">
        <div class="checkbox-item"><input type="checkbox" id="role-admin" value="Admin"> <label for="role-admin">Admin</label>
        </div>
        <div class="checkbox-item"><input type="checkbox" id="role-manager" value="Manager"> <label for="role-manager">Manager</label>
        </div>
        <div class="checkbox-item"><input type="checkbox" id="role-teacher" value="Teacher"> <label for="role-teacher">Teacher</label>
        </div>
        <div class="checkbox-item"><input type="checkbox" id="role-staff" value="Staff"> <label for="role-staff">Staff</label>
        </div>
       </div>
      </div>
      <div class="form-group"><label>Status</label> <select id="status-select"> <option value="active">Active</option> <option value="inactive">Inactive</option> </select>
      </div>
      <div class="form-group"><label>Notes</label> <textarea id="notes-input"></textarea>
      </div>
     </form>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" id="cancel-btn">Cancel</button> <button class="btn btn-primary" id="save-btn"> <span id="save-btn-text">Save</span> </button> <button class="btn btn-primary" id="edit-btn" style="display: none;">Edit</button>
    </div>
   </div>
  </div>
  <div class="modal-overlay confirm-modal" id="confirm-modal-overlay">
   <div class="modal">
    <div class="modal-header">
     <h2>Confirm Action</h2><button class="modal-close" id="confirm-modal-close-btn">√ó</button>
    </div>
    <div class="modal-body">
     <div class="confirm-icon" id="confirm-icon">
      ‚ö†Ô∏è
     </div>
     <h3 id="confirm-title">Confirm Action</h3>
     <p id="confirm-message">Are you sure?</p>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" id="confirm-cancel-btn">Cancel</button> <button class="btn" id="confirm-action-btn"> <span id="confirm-btn-text">Confirm</span> </button>
    </div>
   </div>
  </div>
  <div class="toast-container" id="toast-container"></div>
  <script type="module">
    const defaultConfig = {
      page_title: "Staff Directory",
      page_subtitle: "Manage teachers and staff profiles",
      empty_state_message: "No staff members yet",
      primary_bg: "#f8f9fa",
      surface_color: "#ffffff",
      text_color: "#1a1a1a",
      primary_action: "#2563eb",
      secondary_action: "#64748b",
      font_family: "Inter, system-ui, -apple-system, sans-serif",
      font_size: 13
    };

    let currentStaffData = [];
    let filteredStaffData = [];
    let currentEditingStaff = null;
    let modalMode = 'add';
    let confirmCallback = null;
    let unsubscribeStaff = null;

    async function onConfigChange(config) {
      const titleElement = document.getElementById('page-title');
      const subtitleElement = document.getElementById('page-subtitle');
      const baseFontSize = config.font_size || defaultConfig.font_size;
      const customFont = config.font_family || defaultConfig.font_family;
      const baseFontStack = 'Inter, system-ui, -apple-system, sans-serif';

      titleElement.textContent = config.page_title || defaultConfig.page_title;
      subtitleElement.textContent = config.page_subtitle || defaultConfig.page_subtitle;

      document.body.style.background = config.primary_bg || defaultConfig.primary_bg;
      document.body.style.color = config.text_color || defaultConfig.text_color;
      document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;
      document.body.style.fontSize = `${baseFontSize}px`;

      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      document.querySelectorAll('.card, .controls, .modal, .toast').forEach(el => {
        el.style.background = surfaceColor;
      });

      const primaryColor = config.primary_action || defaultConfig.primary_action;
      document.querySelectorAll('.btn-primary, .avatar').forEach(el => {
        el.style.background = primaryColor;
      });

      const secondaryColor = config.secondary_action || defaultConfig.secondary_action;
      document.querySelectorAll('.btn-secondary').forEach(el => {
        el.style.color = secondaryColor;
      });

      const headerTitle = document.querySelector('.header-content h1');
      if (headerTitle) headerTitle.style.fontSize = `${baseFontSize * 1.85}px`;

      const headerSubtitle = document.querySelector('.header-content p');
      if (headerSubtitle) headerSubtitle.style.fontSize = `${baseFontSize}px`;

      document.querySelectorAll('.btn').forEach(el => {
        el.style.fontSize = `${baseFontSize}px`;
      });

      document.querySelectorAll('input, select, textarea').forEach(el => {
        el.style.fontSize = `${baseFontSize}px`;
      });

      document.querySelectorAll('th').forEach(el => {
        el.style.fontSize = `${baseFontSize * 0.85}px`;
      });

      document.querySelectorAll('td').forEach(el => {
        el.style.fontSize = `${baseFontSize}px`;
      });

      document.querySelectorAll('.modal-header h2').forEach(el => {
        el.style.fontSize = `${baseFontSize * 1.4}px`;
      });

      document.querySelectorAll('label').forEach(el => {
        el.style.fontSize = `${baseFontSize * 0.95}px`;
      });
    }

    // ============================================
    // FIRESTORE FUNCTIONS
    // ============================================

    /**
     * Generate staff ID using Firestore transaction
     * Format: STF_YYYY_FIRSTNAME_NNN
     */
    async function generateStaffId(fullName) {
      const { doc, runTransaction } = window.firebaseUtils;
      const db = window.db;
      
      const year = new Date().getFullYear();
      
      // Extract and normalize first name
      const firstName = fullName.trim().split(' ')[0]
        .toUpperCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, ''); // Remove accents
      
      const counterDocId = `staff_${year}`;
      const counterRef = doc(db, 'counters', counterDocId);
      
      let nextNumber;
      
      try {
        await runTransaction(db, async (transaction) => {
          const counterDoc = await transaction.get(counterRef);
          
          if (!counterDoc.exists()) {
            // Initialize counter for this year
            nextNumber = 1;
            transaction.set(counterRef, { next: 2 });
          } else {
            // Increment existing counter
            nextNumber = counterDoc.data().next;
            transaction.update(counterRef, { next: nextNumber + 1 });
          }
        });
        
        // Format with leading zeros
        const counter = nextNumber.toString().padStart(3, '0');
        return `STF_${year}_${firstName}_${counter}`;
      } catch (error) {
        console.error('Error generating staff ID:', error);
        throw error;
      }
    }

    /**
     * Subscribe to staff collection with realtime updates
     * Ordered by preferredName
     */
    function subscribeToStaff() {
      const { collection, query, orderBy, onSnapshot } = window.firebaseUtils;
      const db = window.db;
      
      const staffRef = collection(db, 'staff');
      const q = query(staffRef, orderBy('preferredName'));
      
      unsubscribeStaff = onSnapshot(q, (snapshot) => {
        currentStaffData = snapshot.docs.map(doc => ({
          __docId: doc.id,
          ...doc.data()
        }));
        
        applyFiltersAndSort();
      }, (error) => {
        console.error('Error listening to staff:', error);
        showToast('error', 'Connection Error', 'Failed to load staff data');
      });
    }

    /**
     * Create new staff member
     * DocId equals staffId
     */
    async function createStaff(staffData) {
      const { doc, setDoc, serverTimestamp } = window.firebaseUtils;
      const db = window.db;
      
      try {
        // Generate staff ID
        const staffId = await generateStaffId(staffData.fullName);
        
        // Prepare document with camelCase fields
        const docData = {
          staffId: staffId,
          fullName: staffData.fullName,
          preferredName: staffData.preferredName,
          roles: staffData.roles,
          status: staffData.status,
          contacts: {
            email: staffData.contacts.email,
            phone: staffData.contacts.phone
          },
          notes: staffData.notes,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        
        // Create document with staffId as document ID
        const staffRef = doc(db, 'staff', staffId);
        await setDoc(staffRef, docData);
        
        return { success: true, staffId };
      } catch (error) {
        console.error('Error creating staff:', error);
        return { success: false, error };
      }
    }

    /**
     * Update existing staff member
     */
    async function updateStaff(staffId, updates) {
      const { doc, updateDoc, serverTimestamp } = window.firebaseUtils;
      const db = window.db;
      
      try {
        const staffRef = doc(db, 'staff', staffId);
        await updateDoc(staffRef, {
          ...updates,
          updatedAt: serverTimestamp()
        });
        
        return { success: true };
      } catch (error) {
        console.error('Error updating staff:', error);
        return { success: false, error };
      }
    }

    /**
     * Toggle staff status (active/inactive)
     */
    async function toggleStaffStatus(staffId, newStatus) {
      return await updateStaff(staffId, { status: newStatus });
    }

    // ============================================
    // UI FUNCTIONS
    // ============================================

    function getInitials(name) {
      if (!name) return '??';
      const parts = name.trim().split(' ');
      if (parts.length >= 2) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      }
      return name.substr(0, 2).toUpperCase();
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      
      // Handle Firestore timestamp
      let date;
      if (timestamp.toDate) {
        date = timestamp.toDate();
      } else if (timestamp.seconds) {
        date = new Date(timestamp.seconds * 1000);
      } else {
        date = new Date(timestamp);
      }
      
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;

      const options = { month: 'short', day: 'numeric', year: 'numeric' };
      return date.toLocaleDateString('en-US', options);
    }

    function renderTable() {
      const container = document.getElementById('table-content');
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;

      if (filteredStaffData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üë•</div>
            <h3>${config.empty_state_message || defaultConfig.empty_state_message}</h3>
            <p>Add your first staff member to get started</p>
            <button class="btn btn-primary" id="empty-add-btn">
              <span>‚ûï</span>
              <span>Add Staff</span>
            </button>
          </div>
        `;
        
        document.getElementById('empty-add-btn')?.addEventListener('click', openAddModal);
        return;
      }

      let tableHTML = `
        <table>
          <thead>
            <tr>
              <th>Photo</th>
              <th>Name</th>
              <th>Roles</th>
              <th>Contact</th>
              <th>Status</th>
              <th>Updated</th>
              <th style="text-align: right;">Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      filteredStaffData.forEach(staff => {
        const roles = Array.isArray(staff.roles) ? staff.roles : [];
        let rolesHTML = '';
        
        if (roles.length > 0) {
          // Split roles into rows of 2
          const roleRows = [];
          for (let i = 0; i < roles.length; i += 2) {
            const row = roles.slice(i, i + 2);
            roleRows.push(row);
          }
          
          rolesHTML = '<div class="roles-list-wrapper">';
          roleRows.forEach(row => {
            rolesHTML += '<div class="roles-row">';
            row.forEach(role => {
              rolesHTML += `<span class="role-badge">${role}</span>`;
            });
            rolesHTML += '</div>';
          });
          rolesHTML += '</div>';
        } else {
          rolesHTML = '<span style="color: #868e96;">No roles</span>';
        }

        // Build contact info
        let contactHTML = '<div class="contact-info">';
        const phone = staff.contacts?.phone || '';
        const email = staff.contacts?.email || '';
        
        if (phone) {
          contactHTML += `<div class="contact-item"><span class="contact-icon">üìû</span><span>${phone}</span></div>`;
        }
        if (email) {
          contactHTML += `<div class="contact-item"><span class="contact-icon">‚úâÔ∏è</span><span>${email}</span></div>`;
        }
        if (!phone && !email) {
          contactHTML += '<span style="color: #868e96;">N/A</span>';
        }
        contactHTML += '</div>';

        const statusLabel = staff.status === 'active' ? 'Active' : 'Inactive';
        const toggleStatusLabel = staff.status === 'active' ? 'Deactivate' : 'Activate';
        const toggleStatusIcon = staff.status === 'active' ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è';

        tableHTML += `
          <tr data-staff-id="${staff.__docId}">
            <td>
              <div class="avatar">${getInitials(staff.fullName)}</div>
            </td>
            <td>
              <div class="staff-name">${staff.fullName || 'N/A'}</div>
              ${staff.preferredName ? `<div style="font-size: 12px; color: #868e96;">${staff.preferredName}</div>` : ''}
            </td>
            <td>
              ${rolesHTML}
            </td>
            <td>
              ${contactHTML}
            </td>
            <td>
              <span class="status-badge status-${staff.status || 'active'}">${statusLabel}</span>
            </td>
            <td>${formatDate(staff.updatedAt)}</td>
            <td>
              <div class="action-buttons" style="justify-content: flex-end;">
                <button class="btn-icon-action edit" data-action="edit" data-id="${staff.__docId}" title="Edit">‚úèÔ∏è</button>
                <button class="btn-icon-action toggle-status" data-action="toggle-status" data-id="${staff.__docId}" data-current-status="${staff.status}" title="${toggleStatusLabel}">${toggleStatusIcon}</button>
              </div>
            </td>
          </tr>
        `;
      });

      tableHTML += `
          </tbody>
        </table>
      `;

      container.innerHTML = tableHTML;

      // Add event listeners
      container.querySelectorAll('tbody tr').forEach(row => {
        row.addEventListener('click', (e) => {
          if (!e.target.closest('button')) {
            const staffId = row.dataset.staffId;
            openViewModal(staffId);
          }
        });
      });

      container.querySelectorAll('button[data-action]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const action = btn.dataset.action;
          const id = btn.dataset.id;
          
          if (action === 'edit') openEditModal(id);
          else if (action === 'toggle-status') {
            const currentStatus = btn.dataset.currentStatus;
            const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
            confirmToggleStatus(id, newStatus);
          }
        });
      });
    }

    function applyFiltersAndSort() {
      const searchTerm = document.getElementById('search-input').value.toLowerCase();
      const roleFilter = document.getElementById('role-filter').value;
      const statusFilter = document.getElementById('status-filter').value;
      const sortBy = document.getElementById('sort-select').value;

      filteredStaffData = currentStaffData.filter(staff => {
        // Search matches preferredName, fullName (case-insensitive), and roles
        const matchesSearch = !searchTerm || 
          (staff.fullName && staff.fullName.toLowerCase().includes(searchTerm)) ||
          (staff.preferredName && staff.preferredName.toLowerCase().includes(searchTerm)) ||
          (staff.staffId && staff.staffId.toLowerCase().includes(searchTerm)) ||
          (Array.isArray(staff.roles) && staff.roles.some(role => role.toLowerCase().includes(searchTerm)));

        const matchesRole = !roleFilter || (Array.isArray(staff.roles) && staff.roles.includes(roleFilter));
        const matchesStatus = !statusFilter || staff.status === statusFilter;

        return matchesSearch && matchesRole && matchesStatus;
      });

      filteredStaffData.sort((a, b) => {
        switch(sortBy) {
          case 'name-asc':
            return (a.preferredName || a.fullName || '').localeCompare(b.preferredName || b.fullName || '');
          case 'name-desc':
            return (b.preferredName || b.fullName || '').localeCompare(a.preferredName || a.fullName || '');
          case 'newest': {
            const aTime = a.createdAt?.seconds || 0;
            const bTime = b.createdAt?.seconds || 0;
            return bTime - aTime;
          }
          case 'oldest': {
            const aTime = a.createdAt?.seconds || 0;
            const bTime = b.createdAt?.seconds || 0;
            return aTime - bTime;
          }
          default:
            return 0;
        }
      });

      document.getElementById('count-label').textContent = 
        `Showing ${filteredStaffData.length} of ${currentStaffData.length}`;

      renderTable();
    }

    function openAddModal() {
      modalMode = 'add';
      currentEditingStaff = null;
      document.getElementById('modal-title').textContent = 'Add Staff';
      document.getElementById('staff-form').reset();
      document.getElementById('staff-id-input').value = 'Auto-generated on save';
      setFormReadonly(false);
      document.getElementById('save-btn').style.display = 'block';
      document.getElementById('edit-btn').style.display = 'none';
      document.getElementById('staff-modal-overlay').classList.add('active');
    }

    function openEditModal(staffId) {
      const staff = currentStaffData.find(s => s.__docId === staffId);
      if (!staff) return;

      modalMode = 'edit';
      currentEditingStaff = staff;
      populateForm(staff);
      document.getElementById('modal-title').textContent = 'Edit Staff';
      setFormReadonly(false);
      document.getElementById('save-btn').style.display = 'block';
      document.getElementById('edit-btn').style.display = 'none';
      document.getElementById('staff-modal-overlay').classList.add('active');
    }

    function openViewModal(staffId) {
      const staff = currentStaffData.find(s => s.__docId === staffId);
      if (!staff) return;

      modalMode = 'view';
      currentEditingStaff = staff;
      populateForm(staff);
      document.getElementById('modal-title').textContent = 'Staff Details';
      setFormReadonly(true);
      document.getElementById('save-btn').style.display = 'none';
      document.getElementById('edit-btn').style.display = 'block';
      document.getElementById('staff-modal-overlay').classList.add('active');
    }

    function populateForm(staff) {
      document.getElementById('staff-id-input').value = staff.staffId || '';
      document.getElementById('full-name-input').value = staff.fullName || '';
      document.getElementById('preferred-name-input').value = staff.preferredName || '';
      document.getElementById('email-input').value = staff.contacts?.email || '';
      document.getElementById('phone-input').value = staff.contacts?.phone || '';
      document.getElementById('status-select').value = staff.status || 'active';
      document.getElementById('notes-input').value = staff.notes || '';

      // Clear all checkboxes
      document.getElementById('role-admin').checked = false;
      document.getElementById('role-manager').checked = false;
      document.getElementById('role-teacher').checked = false;
      document.getElementById('role-staff').checked = false;

      // Set checked based on array
      if (Array.isArray(staff.roles)) {
        staff.roles.forEach(role => {
          const checkbox = document.getElementById(`role-${role.toLowerCase()}`);
          if (checkbox) checkbox.checked = true;
        });
      }
    }

    function setFormReadonly(readonly) {
      const inputs = document.querySelectorAll('#staff-form input:not(#staff-id-input), #staff-form select, #staff-form textarea');
      inputs.forEach(input => {
        if (readonly) {
          input.setAttribute('disabled', 'disabled');
        } else {
          input.removeAttribute('disabled');
        }
      });
    }

    function closeModal() {
      document.getElementById('staff-modal-overlay').classList.remove('active');
      currentEditingStaff = null;
    }

    async function saveStaff() {
      const fullName = document.getElementById('full-name-input').value.trim();
      if (!fullName) {
        showToast('error', 'Validation Error', 'Full name is required');
        return;
      }

      // Collect selected roles as array
      const selectedRoles = [];
      if (document.getElementById('role-admin').checked) selectedRoles.push('Admin');
      if (document.getElementById('role-manager').checked) selectedRoles.push('Manager');
      if (document.getElementById('role-teacher').checked) selectedRoles.push('Teacher');
      if (document.getElementById('role-staff').checked) selectedRoles.push('Staff');

      const staffData = {
        fullName: fullName,
        preferredName: document.getElementById('preferred-name-input').value.trim(),
        contacts: {
          email: document.getElementById('email-input').value.trim(),
          phone: document.getElementById('phone-input').value.trim()
        },
        roles: selectedRoles,
        status: document.getElementById('status-select').value,
        notes: document.getElementById('notes-input').value.trim()
      };

      const saveBtn = document.getElementById('save-btn');
      const saveBtnText = document.getElementById('save-btn-text');
      saveBtn.disabled = true;
      saveBtnText.innerHTML = '<div class="loading-spinner"></div>';

      let result;
      if (modalMode === 'add') {
        result = await createStaff(staffData);
      } else {
        result = await updateStaff(currentEditingStaff.__docId, staffData);
      }

      saveBtn.disabled = false;
      saveBtnText.textContent = 'Save';

      if (result.success) {
        showToast('success', 'Success', modalMode === 'add' ? 'Staff member added successfully' : 'Staff member updated successfully');
        closeModal();
      } else {
        showToast('error', 'Error', 'Failed to save staff member');
      }
    }

    function confirmToggleStatus(staffId, newStatus) {
      const staff = currentStaffData.find(s => s.__docId === staffId);
      if (!staff) return;

      const confirmIcon = document.getElementById('confirm-icon');
      const statusLabel = newStatus === 'active' ? 'Activate' : 'Deactivate';
      const actionWord = newStatus === 'active' ? 'activate' : 'deactivate';
      
      confirmIcon.className = 'confirm-icon confirm-icon-warning';
      confirmIcon.textContent = newStatus === 'active' ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';

      document.getElementById('confirm-title').textContent = `${statusLabel} Staff Member?`;
      document.getElementById('confirm-message').textContent = `Are you sure you want to ${actionWord} ${staff.fullName}?`;
      
      const confirmBtn = document.getElementById('confirm-action-btn');
      confirmBtn.className = 'btn btn-warning';
      document.getElementById('confirm-btn-text').textContent = statusLabel;

      confirmCallback = async () => {
        const confirmBtnText = document.getElementById('confirm-btn-text');
        confirmBtn.disabled = true;
        confirmBtnText.innerHTML = '<div class="loading-spinner"></div>';

        const result = await toggleStaffStatus(staff.__docId, newStatus);

        confirmBtn.disabled = false;
        confirmBtnText.textContent = statusLabel;

        if (result.success) {
          showToast('success', 'Success', `Staff member ${actionWord}d successfully`);
          closeConfirmModal();
        } else {
          showToast('error', 'Error', `Failed to ${actionWord} staff member`);
        }
      };

      document.getElementById('confirm-modal-overlay').classList.add('active');
    }

    function closeConfirmModal() {
      document.getElementById('confirm-modal-overlay').classList.remove('active');
      confirmCallback = null;
    }

    function showToast(type, title, message) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;

      const icon = type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚ö†';

      toast.innerHTML = `
        <div class="toast-icon">${icon}</div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
      `;

      container.appendChild(toast);

      setTimeout(() => {
        toast.remove();
      }, 4000);
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================

    document.getElementById('add-staff-btn').addEventListener('click', openAddModal);

    document.getElementById('import-csv-btn').addEventListener('click', () => {
      showToast('warning', 'Coming Soon', 'CSV import feature will be available in a future update');
    });

    document.getElementById('refresh-btn').addEventListener('click', () => {
      applyFiltersAndSort();
      showToast('success', 'Refreshed', 'Staff list updated');
    });

    document.getElementById('search-input').addEventListener('input', applyFiltersAndSort);
    document.getElementById('role-filter').addEventListener('change', applyFiltersAndSort);
    document.getElementById('status-filter').addEventListener('change', applyFiltersAndSort);
    document.getElementById('sort-select').addEventListener('change', applyFiltersAndSort);

    document.getElementById('modal-close-btn').addEventListener('click', closeModal);
    document.getElementById('cancel-btn').addEventListener('click', closeModal);

    document.getElementById('save-btn').addEventListener('click', (e) => {
      e.preventDefault();
      saveStaff();
    });

    document.getElementById('edit-btn').addEventListener('click', () => {
      modalMode = 'edit';
      document.getElementById('modal-title').textContent = 'Edit Staff';
      setFormReadonly(false);
      document.getElementById('save-btn').style.display = 'block';
      document.getElementById('edit-btn').style.display = 'none';
    });

    document.getElementById('confirm-modal-close-btn').addEventListener('click', closeConfirmModal);
    document.getElementById('confirm-cancel-btn').addEventListener('click', closeConfirmModal);
    document.getElementById('confirm-action-btn').addEventListener('click', () => {
      if (confirmCallback) confirmCallback();
    });

    document.getElementById('staff-modal-overlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeModal();
    });

    document.getElementById('confirm-modal-overlay').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeConfirmModal();
    });

    // ============================================
    // INITIALIZATION
    // ============================================

    async function init() {
      // Initialize Element SDK
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [
              {
                get: () => config.primary_bg || defaultConfig.primary_bg,
                set: (value) => {
                  config.primary_bg = value;
                  window.elementSdk.setConfig({ primary_bg: value });
                }
              },
              {
                get: () => config.surface_color || defaultConfig.surface_color,
                set: (value) => {
                  config.surface_color = value;
                  window.elementSdk.setConfig({ surface_color: value });
                }
              },
              {
                get: () => config.text_color || defaultConfig.text_color,
                set: (value) => {
                  config.text_color = value;
                  window.elementSdk.setConfig({ text_color: value });
                }
              },
              {
                get: () => config.primary_action || defaultConfig.primary_action,
                set: (value) => {
                  config.primary_action = value;
                  window.elementSdk.setConfig({ primary_action: value });
                }
              },
              {
                get: () => config.secondary_action || defaultConfig.secondary_action,
                set: (value) => {
                  config.secondary_action = value;
                  window.elementSdk.setConfig({ secondary_action: value });
                }
              }
            ],
            borderables: [],
            fontEditable: {
              get: () => config.font_family || defaultConfig.font_family,
              set: (value) => {
                config.font_family = value;
                window.elementSdk.setConfig({ font_family: value });
              }
            },
            fontSizeable: {
              get: () => config.font_size || defaultConfig.font_size,
              set: (value) => {
                config.font_size = value;
                window.elementSdk.setConfig({ font_size: value });
              }
            }
          }),
          mapToEditPanelValues: (config) => new Map([
            ["page_title", config.page_title || defaultConfig.page_title],
            ["page_subtitle", config.page_subtitle || defaultConfig.page_subtitle],
            ["empty_state_message", config.empty_state_message || defaultConfig.empty_state_message]
          ])
        });
      }

      // Wait for Firebase to be ready
      if (window.firebaseReady) {
        subscribeToStaff();
      } else {
        window.addEventListener('firebase-ready', () => {
          subscribeToStaff();
        });
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b634531d503fe8b',t:'MTc2NzExNTg4MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>