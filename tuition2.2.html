<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tuition Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center">
                    <div class="bg-green-100 p-3 rounded-lg mr-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-semibold text-gray-900 mb-1 flex items-center">
                            <span class="mr-2">💰</span> Tuition Management System
                        </h1>
                        <p class="text-gray-600">Comprehensive tuition tracking and payment management</p>
                    </div>
                </div>
                <!-- Sync Status -->
                <div id="syncIndicator" class="flex items-center px-3 py-2 rounded-lg text-xs border">
                    <div id="syncIcon" class="w-2 h-2 rounded-full mr-2 bg-green-500"></div>
                    <span id="syncText">Connected</span>
                </div>
            </div>
        </div>

        <!-- Main Navigation Tabs -->
        <div class="bg-white rounded-lg shadow-sm border mb-6">
            <div class="border-b border-gray-200">
                <nav class="flex space-x-8 px-6">
                    <button onclick="switchTab('calculator')" id="calculatorTab" class="py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                        Tuition Calculator
                    </button>
                    <button onclick="switchTab('student')" id="studentTab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                        Student Tuition
                    </button>
                    <button onclick="switchTab('payment')" id="paymentTab" class="py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                        Payment Tracker
                    </button>
                </nav>
            </div>

            <!-- Tuition Calculator Tab -->
            <div id="calculatorContent" class="p-6">
                <!-- Calculator Sub-tabs -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="flex space-x-6">
                        <button onclick="switchCalculatorTab('planner')" id="plannerSubTab" class="py-2 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
                            Course Planner
                        </button>
                        <button onclick="switchCalculatorTab('monthly')" id="monthlySubTab" class="py-2 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700">
                            Monthly Tuition Calculation
                        </button>
                    </nav>
                </div>

                <!-- Course Planner -->
                <div id="plannerContent">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Input Form -->
                        <div class="bg-gray-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold mb-4">Create Course Plan</h3>
                            <form id="coursePlanForm" class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Plan Code *</label>
                                    <input type="text" id="planCode" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Plan Name *</label>
                                    <input type="text" id="planName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Number of Courses</label>
                                    <input type="number" id="numCourses" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Number of Lessons</label>
                                    <input type="number" id="numLessons" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Number of Hours</label>
                                    <input type="number" id="numHours" step="0.5" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Standard Fee</label>
                                    <div class="relative">
                                        <input type="number" id="standardFee" step="0.01" class="w-full px-3 py-2 pr-12 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                        <span class="absolute right-3 top-2 text-gray-500 text-sm">.000</span>
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                                    Add Course Plan
                                </button>
                            </form>
                        </div>

                        <!-- Course Plans List -->
                        <div class="bg-white border rounded-lg p-6">
                            <h3 class="text-lg font-semibold mb-4">Course Plans</h3>
                            
                            <!-- Active Plans Section -->
                            <div class="mb-6">
                                <button onclick="toggleSection('activePlans')" class="flex items-center justify-between w-full p-3 bg-green-50 border border-green-200 rounded-lg hover:bg-green-100 transition-colors">
                                    <span class="font-medium text-green-800">Active Plans</span>
                                    <svg id="activePlansIcon" class="w-5 h-5 text-green-600 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div id="activePlansContent" class="mt-3 space-y-3">
                                    <!-- Active plans will be loaded here -->
                                </div>
                            </div>

                            <!-- Archived Plans Section -->
                            <div>
                                <button onclick="toggleSection('archivedPlans')" class="flex items-center justify-between w-full p-3 bg-gray-50 border border-gray-200 rounded-lg hover:bg-gray-100 transition-colors">
                                    <span class="font-medium text-gray-700">Archived Plans</span>
                                    <svg id="archivedPlansIcon" class="w-5 h-5 text-gray-600 transform transition-transform rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </button>
                                <div id="archivedPlansContent" class="mt-3 space-y-3 hidden">
                                    <!-- Archived plans will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Tuition Calculation -->
                <div id="monthlyContent" class="hidden">
                    <!-- Filters -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Month</label>
                                <select id="monthFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadStudents()">
                                    <option value="">All Months</option>
                                    <option value="1">January</option>
                                    <option value="2">February</option>
                                    <option value="3">March</option>
                                    <option value="4">April</option>
                                    <option value="5">May</option>
                                    <option value="6">June</option>
                                    <option value="7">July</option>
                                    <option value="8">August</option>
                                    <option value="9">September</option>
                                    <option value="10">October</option>
                                    <option value="11">November</option>
                                    <option value="12">December</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                                <select id="yearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadStudents()">
                                    <option value="">All Years</option>
                                    <option value="2023">2023</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                    <option value="2029">2029</option>
                                    <option value="2030">2030</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Class</label>
                                <select id="classFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadStudents()">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Class Status</label>
                                <select id="classStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadStudents()">
                                    <option value="">All Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Student Status</label>
                                <select id="studentStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadStudents()">
                                    <option value="">All Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Inactive">Inactive</option>
                                    <option value="Finished">Finished</option>
                                    <option value="Dropped">Dropped</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Students Table -->
                    <div class="bg-white border rounded-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                            <input type="checkbox" id="selectAll" class="rounded">
                                        </th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Info</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Monthly Actual</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course Planner</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Calculated Fee</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Adjusted Fee</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="studentsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Students will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Student Tuition Tab -->
            <div id="studentContent" class="p-6 hidden">
                <h2 class="text-xl font-semibold mb-6">Student Tuition Management</h2>
                
                <!-- Search, Filter, Sort Bar -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900">Student Tuition Overview</h3>
                        <button onclick="toggleEditMode()" id="editModeBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm">
                            Enable Edit Mode
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                            <input type="text" id="studentSearch" placeholder="Search by name or ID..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" oninput="filterStudentTuition()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                            <select id="tuitionYearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterStudentTuition()">
                                <option value="">All Years</option>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Class</label>
                            <select id="tuitionClassFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterStudentTuition()">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="tuitionStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterStudentTuition()">
                                <option value="">All Status</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                                <option value="Finished">Finished</option>
                                <option value="Dropped">Dropped</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                            <select id="tuitionSortBy" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterStudentTuition()">
                                <option value="name">Name</option>
                                <option value="studentId">Student ID</option>
                                <option value="class">Class</option>
                                <option value="enrollmentYear">Enrollment Year</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Student Tuition Table -->
                <div class="bg-white border rounded-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Info</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Jan</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Feb</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Mar</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Apr</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">May</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Jun</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Jul</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Aug</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Sep</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Oct</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Nov</th>
                                    <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Dec</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Summary</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentTuitionTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Student tuition data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Payment Tracker Tab -->
            <div id="paymentContent" class="p-6 hidden">
                <h2 class="text-xl font-semibold mb-6">Payment Tracking</h2>
                
                <!-- Record Payment Modal -->
                <div class="bg-white border rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Record Payment(s)</h3>
                    
                    <!-- Payment Records Table -->
                    <div class="overflow-x-auto mb-4">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Payment Date</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Student</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tuition Year</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Tuition Month</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Outstanding</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Amount Paid</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Payment Status</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="paymentRecordsTable" class="divide-y divide-gray-200">
                                <!-- Payment records will be added here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex justify-between items-center">
                        <button onclick="addPaymentRow()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm">
                            Add Row
                        </button>
                        <div class="space-x-3">
                            <button onclick="cancelPaymentRecording()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                                Cancel
                            </button>
                            <button onclick="recordPayments()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                Record Payment(s)
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Search, Filter, Sort -->
                <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                            <input type="text" id="paymentSearch" placeholder="Search by student name or ID..." 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                                   oninput="filterPayments()">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Year</label>
                            <select id="paymentYearFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterPayments()">
                                <option value="">All Years</option>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Month</label>
                            <select id="paymentMonthFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterPayments()">
                                <option value="">All Months</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                            <select id="paymentStatusFilter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterPayments()">
                                <option value="">All Status</option>
                                <option value="received">Received</option>
                                <option value="processed">Processed</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Sort By</label>
                            <select id="paymentSortBy" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="filterPayments()">
                                <option value="date_newest">Date (Newest)</option>
                                <option value="date_oldest">Date (Oldest)</option>
                                <option value="amount_low">Amount (Low to High)</option>
                                <option value="amount_high">Amount (High to Low)</option>
                                <option value="student_name">Student Name</option>
                                <option value="student_id">Student ID</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Summary Area -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="bg-blue-100 p-2 rounded-lg mr-3">
                                <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-blue-600 font-medium">Total Payments</p>
                                <p class="text-2xl font-bold text-blue-900" id="totalPaymentsCount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="bg-green-100 p-2 rounded-lg mr-3">
                                <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-green-600 font-medium">Total Amount</p>
                                <p class="text-2xl font-bold text-green-900" id="totalPaymentsAmount">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-center">
                            <div class="bg-yellow-100 p-2 rounded-lg mr-3">
                                <svg class="w-5 h-5 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <p class="text-sm text-yellow-600 font-medium">Pending Processing</p>
                                <p class="text-2xl font-bold text-yellow-900" id="pendingProcessingCount">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction Records Table -->
                <div class="bg-white border rounded-lg overflow-hidden">
                    <div class="px-6 py-4 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-semibold">Transaction Records</h3>
                            <div class="flex items-center space-x-3">
                                <button onclick="bulkUpdateStatus('processed')" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700" id="bulkProcessBtn" disabled>
                                    Mark as Processed
                                </button>
                                <button onclick="bulkDeletePayments()" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700" id="bulkDeleteBtn" disabled>
                                    Delete Selected
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        <input type="checkbox" id="selectAllPayments" class="rounded" onchange="toggleAllPaymentSelection()">
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tuition Period</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount Paid</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="paymentTransactionsTable" class="bg-white divide-y divide-gray-200">
                                <!-- Payment transactions will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Student Tuition Detail Modal -->
    <div id="studentTuitionModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-screen overflow-y-auto">
                <div class="p-6">
                    <!-- Modal Header -->
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Student Tuition Details</h3>
                        <button onclick="closeStudentTuitionModal()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <!-- Basic Info -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Full Name</label>
                                <p id="modalStudentName" class="text-sm text-gray-900 font-medium">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Student ID</label>
                                <p id="modalStudentId" class="text-sm text-gray-900">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Class</label>
                                <p id="modalStudentClass" class="text-sm text-gray-900">-</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Status</label>
                                <p id="modalStudentStatus" class="text-sm text-gray-900">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Year Selection and Summary -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Select Year</label>
                            <select id="modalYearSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="loadStudentTuitionDetails()">
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                                <option value="2026">2026</option>
                                <option value="2027">2027</option>
                                <option value="2028">2028</option>
                                <option value="2029">2029</option>
                                <option value="2030">2030</option>
                            </select>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-4">
                            <h4 class="font-medium text-blue-900 mb-2">Summary</h4>
                            <div class="space-y-1 text-sm">
                                <div class="flex justify-between">
                                    <span>Total Expected:</span>
                                    <span id="modalTotalExpected" class="font-medium">$0.00</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Total Paid:</span>
                                    <span id="modalTotalPaid" class="font-medium text-green-600">$0.00</span>
                                </div>
                                <div class="flex justify-between border-t pt-1">
                                    <span class="font-medium">Outstanding:</span>
                                    <span id="modalOutstanding" class="font-medium text-red-600">$0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Area -->
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                        <textarea id="modalNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Add notes about this student's tuition..."></textarea>
                    </div>

                    <!-- Monthly Tuition Details -->
                    <div class="mb-6">
                        <h4 class="font-medium text-gray-900 mb-4">Monthly Tuition Details</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="modalMonthlyDetails">
                            <!-- Monthly details will be loaded here -->
                        </div>
                    </div>

                    <!-- Modal Actions -->
                    <div class="flex justify-end space-x-3">
                        <button onclick="closeStudentTuitionModal()" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                            Cancel
                        </button>
                        <button onclick="saveStudentTuitionDetails()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDdx6QyXzCWz7BRZInLu16LGnYBKvFO1CM",
            authDomain: "tnl-management-app.firebaseapp.com",
            projectId: "tnl-management-app",
            storageBucket: "tnl-management-app.firebasestorage.app",
            messagingSenderId: "710843379828",
            appId: "1:710843379828:web:76978490616ebe41bf2121",
            measurementId: "G-8W29VX7WTP"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global variables
        let coursePlans = [];
        let students = [];
        let currentEditingPlan = null;
        let allStudentTuition = [];
        let currentModalStudent = null;
        let editMode = false;
        let allPayments = [];
        let filteredPayments = [];
        let paymentRowCounter = 0;
        let allStudentsForSearch = [];

        // Vietnamese text normalization for search
        function normalizeVietnamese(str) {
            if (!str) return '';
            return str.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove diacritics
                .replace(/đ/g, 'd')
                .replace(/Đ/g, 'd');
        }

        // Vietnamese currency formatting
        function formatVNDForDisplay(amount, isTableCell = false) {
            if (!amount || amount === 0) return '0';
            
            if (isTableCell) {
                // For table cells, show compact format without .000
                if (amount >= 1000000) {
                    return (amount / 1000000).toFixed(0) + 'M';
                } else if (amount >= 1000) {
                    return (amount / 1000).toFixed(0) + 'K';
                }
                return amount.toFixed(0);
            } else {
                // For other displays, show full format with .000
                return amount.toLocaleString('vi-VN');
            }
        }

        function parseVNDInput(value) {
            if (!value) return 0;
            // Remove any non-numeric characters except decimal point
            const cleanValue = value.toString().replace(/[^\d.]/g, '');
            const numValue = parseFloat(cleanValue) || 0;
            // Multiply by 1000 to convert to actual VND amount
            return numValue * 1000;
        }

        // Tab switching functions
        function switchTab(tabName) {
            // Hide all content
            document.getElementById('calculatorContent').classList.add('hidden');
            document.getElementById('studentContent').classList.add('hidden');
            document.getElementById('paymentContent').classList.add('hidden');

            // Remove active classes
            document.getElementById('calculatorTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('calculatorTab').classList.add('border-transparent', 'text-gray-500');
            document.getElementById('studentTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('studentTab').classList.add('border-transparent', 'text-gray-500');
            document.getElementById('paymentTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('paymentTab').classList.add('border-transparent', 'text-gray-500');

            // Show selected content and activate tab
            if (tabName === 'calculator') {
                document.getElementById('calculatorContent').classList.remove('hidden');
                document.getElementById('calculatorTab').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('calculatorTab').classList.remove('border-transparent', 'text-gray-500');
            } else if (tabName === 'student') {
                document.getElementById('studentContent').classList.remove('hidden');
                document.getElementById('studentTab').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('studentTab').classList.remove('border-transparent', 'text-gray-500');
                loadStudentTuitionData();
            } else if (tabName === 'payment') {
                document.getElementById('paymentContent').classList.remove('hidden');
                document.getElementById('paymentTab').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('paymentTab').classList.remove('border-transparent', 'text-gray-500');
                loadPaymentTracker();
            }
        }

        function switchCalculatorTab(tabName) {
            // Hide all calculator content
            document.getElementById('plannerContent').classList.add('hidden');
            document.getElementById('monthlyContent').classList.add('hidden');

            // Remove active classes
            document.getElementById('plannerSubTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('plannerSubTab').classList.add('border-transparent', 'text-gray-500');
            document.getElementById('monthlySubTab').classList.remove('border-blue-500', 'text-blue-600');
            document.getElementById('monthlySubTab').classList.add('border-transparent', 'text-gray-500');

            // Show selected content and activate tab
            if (tabName === 'planner') {
                document.getElementById('plannerContent').classList.remove('hidden');
                document.getElementById('plannerSubTab').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('plannerSubTab').classList.remove('border-transparent', 'text-gray-500');
            } else if (tabName === 'monthly') {
                document.getElementById('monthlyContent').classList.remove('hidden');
                document.getElementById('monthlySubTab').classList.add('border-blue-500', 'text-blue-600');
                document.getElementById('monthlySubTab').classList.remove('border-transparent', 'text-gray-500');
                loadStudents();
            }
        }

        // Firebase sync status
        function updateSyncStatus(status, message) {
            const syncIcon = document.getElementById('syncIcon');
            const syncText = document.getElementById('syncText');
            
            if (status === 'connected') {
                syncIcon.className = 'w-2 h-2 rounded-full mr-2 bg-green-500';
                syncText.textContent = message || 'Connected';
            } else if (status === 'syncing') {
                syncIcon.className = 'w-2 h-2 rounded-full mr-2 bg-yellow-500 animate-pulse';
                syncText.textContent = message || 'Syncing...';
            } else {
                syncIcon.className = 'w-2 h-2 rounded-full mr-2 bg-red-500';
                syncText.textContent = message || 'Disconnected';
            }
        }

        // Course Plan Management
        document.getElementById('coursePlanForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const planData = {
                planCode: document.getElementById('planCode').value,
                planName: document.getElementById('planName').value,
                numCourses: parseInt(document.getElementById('numCourses').value) || 0,
                numLessons: parseInt(document.getElementById('numLessons').value) || 0,
                numHours: parseFloat(document.getElementById('numHours').value) || 0,
                standardFee: parseFloat(document.getElementById('standardFee').value) || 0,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'active'
            };

            try {
                updateSyncStatus('syncing', 'Saving plan...');
                
                if (currentEditingPlan) {
                    await db.collection('coursePlans').doc(currentEditingPlan).update(planData);
                    currentEditingPlan = null;
                } else {
                    // Check if plan code already exists
                    const existingPlan = await db.collection('coursePlans').where('planCode', '==', planData.planCode).get();
                    if (!existingPlan.empty) {
                        alert('Plan code already exists. Please use a unique code.');
                        updateSyncStatus('connected');
                        return;
                    }
                    
                    // Generate sequential document ID
                    const allPlans = await db.collection('coursePlans').get();
                    const planNumber = String(allPlans.size + 1).padStart(3, '0');
                    const docId = `coursePlan_${planNumber}`;
                    
                    await db.collection('coursePlans').doc(docId).set(planData);
                }
                
                document.getElementById('coursePlanForm').reset();
                await loadCoursePlans();
                updateSyncStatus('connected', 'Plan saved');
            } catch (error) {
                console.error('Error saving plan:', error);
                updateSyncStatus('error', 'Save failed');
                alert('Error saving plan: ' + error.message);
            }
        });

        async function loadCoursePlans() {
            try {
                updateSyncStatus('syncing', 'Loading plans...');
                
                // Load active plans
                const activeSnapshot = await db.collection('coursePlans').where('status', '==', 'active').get();
                const archivedSnapshot = await db.collection('coursePlans').where('status', '==', 'archived').get();
                
                coursePlans = [];
                
                const activePlansContent = document.getElementById('activePlansContent');
                const archivedPlansContent = document.getElementById('archivedPlansContent');
                
                activePlansContent.innerHTML = '';
                archivedPlansContent.innerHTML = '';

                // Process active plans
                if (activeSnapshot.empty) {
                    activePlansContent.innerHTML = '<p class="text-gray-500 text-center py-4">No active course plans found</p>';
                } else {
                    activeSnapshot.forEach(doc => {
                        const plan = { id: doc.id, ...doc.data() };
                        coursePlans.push(plan);
                        
                        const planElement = document.createElement('div');
                        planElement.className = 'border border-green-200 rounded-lg p-4 bg-green-50';
                        planElement.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold text-gray-900">${plan.planName}</h4>
                                    <p class="text-sm text-gray-600">Code: ${plan.planCode}</p>
                                    <div class="mt-2 text-sm text-gray-600">
                                        <p>Courses: ${plan.numCourses} | Lessons: ${plan.numLessons} | Hours: ${plan.numHours}</p>
                                        <p class="font-medium">Fee: ${formatVNDForDisplay(plan.standardFee * 1000)}</p>
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="editPlan('${doc.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Edit</button>
                                    <button onclick="deletePlan('${doc.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                    <button onclick="archivePlan('${doc.id}')" class="text-gray-600 hover:text-gray-800 text-sm">Archive</button>
                                </div>
                            </div>
                        `;
                        activePlansContent.appendChild(planElement);
                    });
                }

                // Process archived plans
                if (archivedSnapshot.empty) {
                    archivedPlansContent.innerHTML = '<p class="text-gray-500 text-center py-4">No archived course plans found</p>';
                } else {
                    archivedSnapshot.forEach(doc => {
                        const plan = { id: doc.id, ...doc.data() };
                        
                        const planElement = document.createElement('div');
                        planElement.className = 'border rounded-lg p-4 bg-gray-100';
                        planElement.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-semibold text-gray-700">${plan.planName}</h4>
                                    <p class="text-sm text-gray-500">Code: ${plan.planCode}</p>
                                    <div class="mt-2 text-sm text-gray-500">
                                        <p>Courses: ${plan.numCourses} | Lessons: ${plan.numLessons} | Hours: ${plan.numHours}</p>
                                        <p class="font-medium">Fee: ${formatVNDForDisplay(plan.standardFee * 1000)}</p>
                                    </div>
                                    <span class="inline-block mt-2 px-2 py-1 text-xs bg-gray-200 text-gray-600 rounded">Archived</span>
                                </div>
                                <div class="flex space-x-2">
                                    <button onclick="unarchivePlan('${doc.id}')" class="text-green-600 hover:text-green-800 text-sm">Unarchive</button>
                                    <button onclick="deletePlan('${doc.id}')" class="text-red-600 hover:text-red-800 text-sm">Delete</button>
                                </div>
                            </div>
                        `;
                        archivedPlansContent.appendChild(planElement);
                    });
                }

                updateSyncStatus('connected');
            } catch (error) {
                console.error('Error loading plans:', error);
                updateSyncStatus('error', 'Load failed');
            }
        }

        async function editPlan(planId) {
            const plan = coursePlans.find(p => p.id === planId);
            if (plan) {
                document.getElementById('planCode').value = plan.planCode;
                document.getElementById('planName').value = plan.planName;
                document.getElementById('numCourses').value = plan.numCourses;
                document.getElementById('numLessons').value = plan.numLessons;
                document.getElementById('numHours').value = plan.numHours;
                document.getElementById('standardFee').value = plan.standardFee;
                currentEditingPlan = planId;
            }
        }

        async function deletePlan(planId) {
            if (confirm('Are you sure you want to delete this plan?')) {
                try {
                    updateSyncStatus('syncing', 'Deleting...');
                    await db.collection('coursePlans').doc(planId).delete();
                    loadCoursePlans();
                    updateSyncStatus('connected', 'Plan deleted');
                } catch (error) {
                    console.error('Error deleting plan:', error);
                    updateSyncStatus('error', 'Delete failed');
                }
            }
        }

        async function archivePlan(planId) {
            try {
                updateSyncStatus('syncing', 'Archiving...');
                await db.collection('coursePlans').doc(planId).update({ status: 'archived' });
                loadCoursePlans();
                updateSyncStatus('connected', 'Plan archived');
            } catch (error) {
                console.error('Error archiving plan:', error);
                updateSyncStatus('error', 'Archive failed');
            }
        }

        async function unarchivePlan(planId) {
            try {
                updateSyncStatus('syncing', 'Unarchiving...');
                await db.collection('coursePlans').doc(planId).update({ status: 'active' });
                loadCoursePlans();
                updateSyncStatus('connected', 'Plan unarchived');
            } catch (error) {
                console.error('Error unarchiving plan:', error);
                updateSyncStatus('error', 'Unarchive failed');
            }
        }

        function toggleSection(sectionName) {
            const content = document.getElementById(sectionName + 'Content');
            const icon = document.getElementById(sectionName + 'Icon');
            
            if (content.classList.contains('hidden')) {
                content.classList.remove('hidden');
                icon.classList.remove('rotate-180');
            } else {
                content.classList.add('hidden');
                icon.classList.add('rotate-180');
            }
        }

        // Student Management
        async function loadStudents() {
            try {
                updateSyncStatus('syncing', 'Loading students...');
                
                // Get filter values
                const selectedMonth = document.getElementById('monthFilter').value;
                const selectedYear = document.getElementById('yearFilter').value;
                const selectedClass = document.getElementById('classFilter').value;
                const selectedClassStatus = document.getElementById('classStatusFilter').value;
                const selectedStudentStatus = document.getElementById('studentStatusFilter').value;
                
                // Use current month/year if not specified
                const currentMonth = selectedMonth ? parseInt(selectedMonth) : new Date().getMonth() + 1;
                const currentYear = selectedYear ? parseInt(selectedYear) : new Date().getFullYear();
                
                let studentsQuery = db.collection('students');
                
                // Apply student status filter
                if (selectedStudentStatus) {
                    studentsQuery = studentsQuery.where('status', '==', selectedStudentStatus);
                }
                
                // Apply class filter
                if (selectedClass) {
                    studentsQuery = studentsQuery.where('classAssignment', '==', selectedClass);
                }
                
                const snapshot = await studentsQuery.get();
                students = [];
                
                for (const doc of snapshot.docs) {
                    const studentData = { id: doc.id, ...doc.data() };
                    
                    // Determine if we should show all-time data or filtered data
                    const showAllTime = !selectedMonth && !selectedYear;
                    
                    // Calculate attendance for the selected period or all-time
                    const attendanceData = await getMonthlyAttendance(
                        studentData.studentId, 
                        currentYear, 
                        currentMonth, 
                        showAllTime
                    );
                    
                    // Only include students who have attendance data for the selected period
                    // or include all if no specific month/year filter is applied
                    if (showAllTime) {
                        // Show all students with their all-time attendance data
                        studentData.attendedLessons = attendanceData.attendedLessons;
                        studentData.coursesCount = attendanceData.coursesCount;
                        studentData.lessonLength = 1.5; // Default lesson length
                        studentData.studyHours = attendanceData.attendedLessons * studentData.lessonLength;
                        students.push(studentData);
                    } else if (attendanceData.attendedLessons > 0 || attendanceData.coursesCount > 0) {
                        // Only show students with attendance in the selected period
                        studentData.attendedLessons = attendanceData.attendedLessons;
                        studentData.coursesCount = attendanceData.coursesCount;
                        studentData.lessonLength = 1.5; // Default lesson length
                        studentData.studyHours = attendanceData.attendedLessons * studentData.lessonLength;
                        students.push(studentData);
                    }
                }
                
                renderStudentsTable();
                updateSyncStatus('connected');
            } catch (error) {
                console.error('Error loading students:', error);
                updateSyncStatus('error', 'Load failed');
            }
        }

        async function getMonthlyAttendance(studentId, year, month, showAllTime = false) {
            try {
                // Get all attendance records for the student
                const attendanceSnapshot = await db.collection('attendance')
                    .where('studentId', '==', studentId)
                    .get();
                
                let attendedLessons = 0;
                let uniqueCourses = new Set();
                
                attendanceSnapshot.forEach(doc => {
                    const data = doc.data();
                    const attendanceDate = data.date?.toDate ? data.date.toDate() : new Date(data.date);
                    
                    // If showAllTime is true, count all attendance regardless of date
                    // Otherwise, filter by the selected month/year
                    const shouldCount = showAllTime || 
                        (attendanceDate.getFullYear() === year && 
                         attendanceDate.getMonth() + 1 === month);
                    
                    if (shouldCount) {
                        // Count only if student was present
                        if (data.status === 'present' || data.status === 'Present') {
                            attendedLessons++;
                            
                            // Track unique courses
                            if (data.courseCode) {
                                uniqueCourses.add(data.courseCode);
                            }
                        }
                    }
                });
                
                return {
                    attendedLessons: attendedLessons,
                    coursesCount: uniqueCourses.size
                };
            } catch (error) {
                console.error('Error getting attendance:', error);
                return {
                    attendedLessons: 0,
                    coursesCount: 0
                };
            }
        }

        function renderStudentsTable() {
            const tbody = document.getElementById('studentsTableBody');
            tbody.innerHTML = '';

            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            No students found for the selected criteria
                        </td>
                    </tr>
                `;
                return;
            }

            students.forEach(student => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="rounded" data-student-id="${student.id}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${student.fullName || 'N/A'}</div>
                            <div class="text-sm text-gray-500">ID: ${student.studentId || 'N/A'}</div>
                            <div class="text-sm text-gray-500">Class: ${student.classAssignment || 'N/A'}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">
                            <div>Courses: ${student.coursesCount || 0}</div>
                            <div>Lessons: ${student.attendedLessons || 0}</div>
                            <div>Length: <input type="number" step="0.5" value="${student.lessonLength || 1.5}" class="w-16 px-1 py-1 border rounded text-xs" onchange="updateStudentData('${student.id}', 'lessonLength', this.value)"></div>
                            <div>Hours: <span id="hours-${student.id}">${student.studyHours || 0}</span></div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <select class="w-full px-2 py-1 border rounded text-sm" onchange="updateStudentCoursePlan('${student.id}', this.value)">
                            <option value="">Select Plan</option>
                            ${coursePlans.map(plan => `<option value="${plan.id}">${plan.planName}</option>`).join('')}
                        </select>
                        <div id="planDetails-${student.id}" class="mt-2 text-xs text-gray-600 hidden">
                            <!-- Plan details will appear here -->
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900" id="calculated-${student.id}">0</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="relative">
                            <input type="number" step="0.01" placeholder="0" class="w-24 px-2 py-1 pr-8 border rounded text-sm" id="adjusted-${student.id}">
                            <span class="absolute right-2 top-1 text-xs text-gray-500">.000</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <button onclick="saveStudentTuition('${student.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 mr-2">Save</button>
                        <button onclick="informStudent('${student.id}')" class="bg-green-600 text-white px-3 py-1 rounded text-xs hover:bg-green-700 opacity-50" disabled id="inform-${student.id}">Inform</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateStudentData(studentId, field, value) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                student[field] = parseFloat(value) || value;
                
                if (field === 'lessonLength') {
                    student.studyHours = student.attendedLessons * student.lessonLength;
                    document.getElementById(`hours-${studentId}`).textContent = student.studyHours;
                }
            }
        }

        function updateStudentCoursePlan(studentId, planId) {
            const student = students.find(s => s.id === studentId);
            const planDetailsDiv = document.getElementById(`planDetails-${studentId}`);
            const calculatedFeeDiv = document.getElementById(`calculated-${studentId}`);
            
            if (student) {
                student.coursePlan = planId;
                
                if (planId) {
                    const selectedPlan = coursePlans.find(p => p.id === planId);
                    if (selectedPlan) {
                        // Show plan details
                        planDetailsDiv.innerHTML = `
                            <div>Code: ${selectedPlan.planCode}</div>
                            <div>Courses: ${selectedPlan.numCourses} | Lessons: ${selectedPlan.numLessons}</div>
                            <div>Hours: ${selectedPlan.numHours} | Fee: ${formatVNDForDisplay(selectedPlan.standardFee * 1000)}.000</div>
                        `;
                        planDetailsDiv.classList.remove('hidden');
                        
                        // Calculate fee based on plan
                        let calculatedFee = 0;
                        if (selectedPlan.numHours > 0) {
                            // Calculate based on hours ratio
                            const hourlyRate = selectedPlan.standardFee / selectedPlan.numHours;
                            calculatedFee = hourlyRate * student.studyHours;
                        } else if (selectedPlan.numLessons > 0) {
                            // Calculate based on lessons ratio
                            const lessonRate = selectedPlan.standardFee / selectedPlan.numLessons;
                            calculatedFee = lessonRate * student.attendedLessons;
                        } else {
                            // Use standard fee
                            calculatedFee = selectedPlan.standardFee;
                        }
                        
                        calculatedFeeDiv.textContent = `${formatVNDForDisplay(calculatedFee)}.000`;
                    }
                } else {
                    // Hide plan details and reset calculated fee
                    planDetailsDiv.classList.add('hidden');
                    calculatedFeeDiv.textContent = '0';
                }
            }
        }

        async function saveStudentTuition(studentId) {
            try {
                updateSyncStatus('syncing', 'Saving tuition...');
                
                const student = students.find(s => s.id === studentId);
                if (!student) return;
                
                // Get current month/year
                const currentMonth = parseInt(document.getElementById('monthFilter').value) || new Date().getMonth() + 1;
                const currentYear = parseInt(document.getElementById('yearFilter').value) || new Date().getFullYear();
                
                // Format document ID as tuition_studentID_yyyy-mm
                const monthStr = String(currentMonth).padStart(2, '0');
                const docId = `tuition_${student.studentId}_${currentYear}-${monthStr}`;
                
                const adjustedFee = parseVNDInput(document.getElementById(`adjusted-${studentId}`).value);
                const calculatedFeeText = document.getElementById(`calculated-${studentId}`).textContent.replace('.000', '').replace(/[^\d]/g, '');
                const calculatedFee = parseFloat(calculatedFeeText) * 1000 || 0;
                
                const tuitionData = {
                    studentId: student.studentId,
                    fullName: student.fullName,
                    classAssignment: student.classAssignment,
                    month: currentMonth,
                    year: currentYear,
                    attendedLessons: student.attendedLessons,
                    lessonLength: student.lessonLength,
                    studyHours: student.studyHours,
                    calculatedFee: calculatedFee,
                    adjustedFee: adjustedFee,
                    finalFee: adjustedFee > 0 ? adjustedFee : calculatedFee,
                    coursePlan: student.coursePlan || null,
                    savedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'saved'
                };
                
                await db.collection('tuition').doc(docId).set(tuitionData);
                
                // Enable the inform button after saving
                document.getElementById(`inform-${studentId}`).disabled = false;
                document.getElementById(`inform-${studentId}`).classList.remove('opacity-50');
                
                updateSyncStatus('connected', 'Tuition saved');
            } catch (error) {
                console.error('Error saving tuition:', error);
                updateSyncStatus('error', 'Save failed');
                alert('Error saving tuition: ' + error.message);
            }
        }

        function informStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            if (student) {
                alert(`Tuition information sent to ${student.fullName}`);
            }
        }



        // Load classes for filter dropdown
        async function loadClasses() {
            try {
                const snapshot = await db.collection('classes').get();
                const classFilter = document.getElementById('classFilter');
                
                // Clear existing options except "All Classes"
                classFilter.innerHTML = '<option value="">All Classes</option>';
                
                snapshot.forEach(doc => {
                    const classData = doc.data();
                    const option = document.createElement('option');
                    option.value = classData.classCode || doc.id;
                    option.textContent = classData.className || classData.classCode || doc.id;
                    classFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        // Student Tuition Management Functions
        async function loadStudentTuitionData() {
            try {
                updateSyncStatus('syncing', 'Loading student tuition...');
                
                // Load all students
                const studentsSnapshot = await db.collection('students').get();
                allStudentTuition = [];
                
                for (const doc of studentsSnapshot.docs) {
                    const studentData = { id: doc.id, ...doc.data() };
                    
                    // Get enrollment year from student data
                    const enrollmentYear = studentData.enrollmentYear || new Date().getFullYear();
                    
                    // Load tuition data for this student
                    const tuitionData = await loadStudentYearlyTuition(studentData.studentId, enrollmentYear);
                    
                    studentData.enrollmentYear = enrollmentYear;
                    studentData.tuitionData = tuitionData;
                    
                    allStudentTuition.push(studentData);
                }
                
                // Load classes for filter
                await loadTuitionClasses();
                
                // Apply initial filters and render
                filterStudentTuition();
                
                updateSyncStatus('connected');
            } catch (error) {
                console.error('Error loading student tuition:', error);
                updateSyncStatus('error', 'Load failed');
            }
        }

        async function loadStudentYearlyTuition(studentId, year) {
            try {
                const tuitionSnapshot = await db.collection('tuition')
                    .where('studentId', '==', studentId)
                    .where('year', '==', year)
                    .get();
                
                const monthlyData = {};
                let totalExpected = 0;
                let totalPaid = 0;
                
                tuitionSnapshot.forEach(doc => {
                    const data = doc.data();
                    const month = data.month;
                    
                    monthlyData[month] = {
                        fee: data.finalFee || data.calculatedFee || 0,
                        paid: data.paid || false,
                        processed: data.processed || false,
                        paymentDate: data.paymentDate || null,
                        status: data.status || 'informed',
                        docId: doc.id
                    };
                    
                    totalExpected += data.finalFee || data.calculatedFee || 0;
                    if (data.paid) {
                        totalPaid += data.finalFee || data.calculatedFee || 0;
                    }
                });
                
                return {
                    monthlyData,
                    totalExpected,
                    totalPaid,
                    outstanding: totalExpected - totalPaid
                };
            } catch (error) {
                console.error('Error loading yearly tuition:', error);
                return {
                    monthlyData: {},
                    totalExpected: 0,
                    totalPaid: 0,
                    outstanding: 0
                };
            }
        }

        async function loadTuitionClasses() {
            try {
                const snapshot = await db.collection('classes').get();
                const classFilter = document.getElementById('tuitionClassFilter');
                
                // Clear existing options except "All Classes"
                classFilter.innerHTML = '<option value="">All Classes</option>';
                
                snapshot.forEach(doc => {
                    const classData = doc.data();
                    const option = document.createElement('option');
                    option.value = classData.classCode || doc.id;
                    option.textContent = classData.className || classData.classCode || doc.id;
                    classFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading classes:', error);
            }
        }

        function filterStudentTuition() {
            const searchTerm = normalizeVietnamese(document.getElementById('studentSearch').value);
            const yearFilter = document.getElementById('tuitionYearFilter').value;
            const classFilter = document.getElementById('tuitionClassFilter').value;
            const statusFilter = document.getElementById('tuitionStatusFilter').value;
            const sortBy = document.getElementById('tuitionSortBy').value;
            
            let filteredStudents = allStudentTuition.filter(student => {
                // Search filter with Vietnamese normalization
                const matchesSearch = !searchTerm || 
                    normalizeVietnamese(student.fullName || '').includes(searchTerm) ||
                    normalizeVietnamese(student.studentId || '').includes(searchTerm);
                
                // Year filter - show data from enrollment year onwards
                const currentYear = yearFilter ? parseInt(yearFilter) : new Date().getFullYear();
                const matchesYear = !yearFilter || student.enrollmentYear <= currentYear;
                
                // Class filter
                const matchesClass = !classFilter || student.classAssignment === classFilter;
                
                // Status filter
                const matchesStatus = !statusFilter || student.status === statusFilter;
                
                // Status-based year limit: if student is not active, don't show beyond finished/dropped year
                const isActiveStatus = student.status === 'Active' || student.status === 'Inactive';
                const finishedYear = student.finishedYear || new Date().getFullYear();
                const shouldShowYear = isActiveStatus || currentYear <= finishedYear;
                
                return matchesSearch && matchesYear && matchesClass && matchesStatus && shouldShowYear;
            });
            
            // Sort students
            filteredStudents.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return (a.fullName || '').localeCompare(b.fullName || '');
                    case 'studentId':
                        return (a.studentId || '').localeCompare(b.studentId || '');
                    case 'class':
                        return (a.classAssignment || '').localeCompare(b.classAssignment || '');
                    case 'enrollmentYear':
                        return (a.enrollmentYear || 0) - (b.enrollmentYear || 0);
                    default:
                        return 0;
                }
            });
            
            renderStudentTuitionTable(filteredStudents, yearFilter ? parseInt(yearFilter) : new Date().getFullYear());
        }

        function renderStudentTuitionTable(students, displayYear) {
            const tbody = document.getElementById('studentTuitionTableBody');
            tbody.innerHTML = '';
            
            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="15" class="px-6 py-8 text-center text-gray-500">
                            No students found for the selected criteria
                        </td>
                    </tr>
                `;
                return;
            }
            
            students.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 cursor-pointer';
                row.onclick = () => openStudentTuitionModal(student);
                
                // Get tuition data for display year
                const yearTuition = student.tuitionData?.monthlyData || {};
                
                // Generate monthly cells
                let monthlyCells = '';
                for (let month = 1; month <= 12; month++) {
                    const monthData = yearTuition[month];
                    let cellClass = 'px-1 py-2 text-center text-xs';
                    let cellContent = '-';
                    
                    if (monthData) {
                        const fee = monthData.fee;
                        if (fee > 0) {
                            if (editMode) {
                                // In edit mode, show input field
                                cellContent = `<input type="number" value="${fee / 1000}" class="w-12 px-1 py-1 text-xs border rounded text-center" onchange="updateTuitionFee('${student.studentId}', ${month}, ${displayYear}, this.value)" onclick="event.stopPropagation()">`;
                            } else {
                                // In view mode, show formatted amount
                                cellContent = formatVNDForDisplay(fee, true);
                            }
                            
                            // Color coding based on status
                            switch (monthData.status) {
                                case 'processed':
                                    cellClass += ' bg-green-100 text-green-800';
                                    break;
                                case 'paid':
                                    cellClass += ' bg-yellow-100 text-yellow-800';
                                    break;
                                case 'informed':
                                case 'saved':
                                    cellClass += ' bg-red-100 text-red-800';
                                    break;
                                default:
                                    cellClass += ' bg-gray-100 text-gray-600';
                            }
                        } else {
                            cellClass += ' bg-gray-100 text-gray-600';
                        }
                    } else {
                        cellClass += ' bg-gray-50 text-gray-400';
                        if (editMode) {
                            cellContent = `<input type="number" value="0" class="w-12 px-1 py-1 text-xs border rounded text-center" onchange="updateTuitionFee('${student.studentId}', ${month}, ${displayYear}, this.value)" onclick="event.stopPropagation()">`;
                        }
                    }
                    
                    monthlyCells += `<td class="${cellClass}">${cellContent}</td>`;
                }
                
                // Calculate summary
                const totalExpected = student.tuitionData?.totalExpected || 0;
                const totalPaid = student.tuitionData?.totalPaid || 0;
                const outstanding = totalExpected - totalPaid;
                
                row.innerHTML = `
                    <td class="px-4 py-3 whitespace-nowrap">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${student.fullName || 'N/A'}</div>
                            <div class="text-sm text-gray-500">${student.classAssignment || 'N/A'}</div>
                            <div class="text-xs text-gray-400">ID: ${student.studentId || 'N/A'}</div>
                            <div class="text-xs text-gray-400">${student.status || 'N/A'} (${student.enrollmentYear || 'N/A'})</div>
                        </div>
                    </td>
                    ${monthlyCells}
                    <td class="px-2 py-3 whitespace-nowrap text-xs">
                        <div class="space-y-1">
                            <div>Total: <span class="font-medium">${formatVNDForDisplay(totalExpected)}</span></div>
                            <div>Paid: <span class="text-green-600 font-medium">${formatVNDForDisplay(totalPaid)}</span></div>
                            <div>Outstanding: <span class="text-red-600 font-medium">${formatVNDForDisplay(outstanding)}</span></div>
                        </div>
                    </td>
                    <td class="px-4 py-3 whitespace-nowrap text-sm">
                        <button onclick="event.stopPropagation(); deleteStudentTuition('${student.id}')" class="text-red-600 hover:text-red-800">
                            Delete
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function openStudentTuitionModal(student) {
            currentModalStudent = student;
            
            // Populate basic info
            document.getElementById('modalStudentName').textContent = student.fullName || 'N/A';
            document.getElementById('modalStudentId').textContent = student.studentId || 'N/A';
            document.getElementById('modalStudentClass').textContent = student.classAssignment || 'N/A';
            document.getElementById('modalStudentStatus').textContent = student.status || 'N/A';
            
            // Set year to current year or enrollment year
            const currentYear = new Date().getFullYear();
            document.getElementById('modalYearSelect').value = currentYear;
            
            // Load tuition details
            loadStudentTuitionDetails();
            
            // Show modal
            document.getElementById('studentTuitionModal').classList.remove('hidden');
        }

        async function loadStudentTuitionDetails() {
            if (!currentModalStudent) return;
            
            const selectedYear = parseInt(document.getElementById('modalYearSelect').value);
            
            try {
                // Load tuition data for selected year
                const tuitionData = await loadStudentYearlyTuition(currentModalStudent.studentId, selectedYear);
                
                // Update summary
                document.getElementById('modalTotalExpected').textContent = formatVNDForDisplay(tuitionData.totalExpected);
                document.getElementById('modalTotalPaid').textContent = formatVNDForDisplay(tuitionData.totalPaid);
                document.getElementById('modalOutstanding').textContent = formatVNDForDisplay(tuitionData.outstanding);
                
                // Load notes
                const notesDoc = await db.collection('studentNotes').doc(`${currentModalStudent.studentId}_${selectedYear}`).get();
                document.getElementById('modalNotes').value = notesDoc.exists ? notesDoc.data().notes || '' : '';
                
                // Render monthly details
                renderModalMonthlyDetails(tuitionData.monthlyData, selectedYear);
                
            } catch (error) {
                console.error('Error loading student tuition details:', error);
            }
        }

        function renderModalMonthlyDetails(monthlyData, year) {
            const container = document.getElementById('modalMonthlyDetails');
            container.innerHTML = '';
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            for (let month = 1; month <= 12; month++) {
                const monthData = monthlyData[month] || {};
                const fee = monthData.fee || 0;
                const paid = monthData.paid || false;
                const processed = monthData.processed || false;
                const paymentDate = monthData.paymentDate || '';
                
                // Determine card color based on fee, paid, and processed status
                let cardClass = 'border rounded-lg p-3';
                let headerClass = 'font-medium text-sm mb-2';
                
                if (fee > 0) {
                    if (processed) {
                        // Processed: Green
                        cardClass += ' bg-green-50 border-green-200';
                        headerClass += ' text-green-800';
                    } else if (paid) {
                        // Paid but not processed: Yellow
                        cardClass += ' bg-yellow-50 border-yellow-200';
                        headerClass += ' text-yellow-800';
                    } else {
                        // Fee set but not paid: Red
                        cardClass += ' bg-red-50 border-red-200';
                        headerClass += ' text-red-800';
                    }
                } else {
                    // No fee: Gray
                    cardClass += ' bg-gray-50 border-gray-200';
                    headerClass += ' text-gray-500';
                }
                
                const monthCard = document.createElement('div');
                monthCard.className = cardClass;
                monthCard.innerHTML = `
                    <div class="${headerClass}">${monthNames[month - 1]} ${year}</div>
                    <div class="space-y-2">
                        <div>
                            <label class="block text-xs text-gray-600">Fee</label>
                            <div class="relative">
                                <input type="number" step="0.01" value="${fee / 1000}" 
                                       class="w-full px-2 py-1 pr-8 border rounded text-sm" 
                                       onchange="updateModalMonthFee(${month}, this.value)">
                                <span class="absolute right-2 top-1 text-xs text-gray-500">.000</span>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center space-x-1">
                                <input type="checkbox" ${paid ? 'checked' : ''} 
                                       ${fee <= 0 ? 'disabled' : ''}
                                       onchange="updateModalMonthPaid(${month}, this.checked)"
                                       class="rounded" id="paid_${month}">
                                <label class="text-xs text-gray-600">Paid</label>
                            </div>
                            <div class="flex items-center space-x-1">
                                <input type="checkbox" ${processed ? 'checked' : ''} 
                                       ${!paid || fee <= 0 ? 'disabled' : ''}
                                       onchange="updateModalMonthProcessed(${month}, this.checked)"
                                       class="rounded" id="processed_${month}">
                                <label class="text-xs text-gray-600">Processed</label>
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-600">Payment Date</label>
                            <input type="date" value="${paymentDate}" 
                                   ${fee <= 0 ? 'disabled' : ''}
                                   class="w-full px-2 py-1 border rounded text-sm" 
                                   onchange="updateModalPaymentDate(${month}, this.value)"
                                   id="paymentDate_${month}">
                        </div>
                    </div>
                `;
                
                container.appendChild(monthCard);
            }
        }

        function updateModalMonthFee(month, inputValue) {
            // Store the change temporarily
            if (!currentModalStudent.tempChanges) {
                currentModalStudent.tempChanges = {};
            }
            if (!currentModalStudent.tempChanges[month]) {
                currentModalStudent.tempChanges[month] = {};
            }
            
            const fee = parseVNDInput(inputValue);
            currentModalStudent.tempChanges[month].fee = fee;
            
            // If fee is removed (0), clear all checkboxes and date
            if (fee <= 0) {
                currentModalStudent.tempChanges[month].paid = false;
                currentModalStudent.tempChanges[month].processed = false;
                currentModalStudent.tempChanges[month].paymentDate = '';
                
                // Update UI elements
                document.getElementById(`paid_${month}`).checked = false;
                document.getElementById(`paid_${month}`).disabled = true;
                document.getElementById(`processed_${month}`).checked = false;
                document.getElementById(`processed_${month}`).disabled = true;
                document.getElementById(`paymentDate_${month}`).value = '';
                document.getElementById(`paymentDate_${month}`).disabled = true;
            } else {
                // Enable paid checkbox and date when fee is set
                document.getElementById(`paid_${month}`).disabled = false;
                document.getElementById(`paymentDate_${month}`).disabled = false;
            }
            
            // Update the card appearance immediately
            updateModalCardAppearance(month);
        }

        function updateModalMonthPaid(month, paid) {
            if (!currentModalStudent.tempChanges) {
                currentModalStudent.tempChanges = {};
            }
            if (!currentModalStudent.tempChanges[month]) {
                currentModalStudent.tempChanges[month] = {};
            }
            currentModalStudent.tempChanges[month].paid = paid;
            
            if (paid) {
                // If marking as paid, set payment date to today if not already set
                if (!currentModalStudent.tempChanges[month].paymentDate) {
                    currentModalStudent.tempChanges[month].paymentDate = new Date().toISOString().split('T')[0];
                    document.getElementById(`paymentDate_${month}`).value = currentModalStudent.tempChanges[month].paymentDate;
                }
                // Enable processed checkbox
                document.getElementById(`processed_${month}`).disabled = false;
            } else {
                // If unmarking as paid, clear payment date and processed status
                currentModalStudent.tempChanges[month].paymentDate = '';
                currentModalStudent.tempChanges[month].processed = false;
                document.getElementById(`paymentDate_${month}`).value = '';
                document.getElementById(`processed_${month}`).checked = false;
                document.getElementById(`processed_${month}`).disabled = true;
            }
            
            // Update the card appearance immediately
            updateModalCardAppearance(month);
        }

        function updateModalMonthProcessed(month, processed) {
            if (!currentModalStudent.tempChanges) {
                currentModalStudent.tempChanges = {};
            }
            if (!currentModalStudent.tempChanges[month]) {
                currentModalStudent.tempChanges[month] = {};
            }
            currentModalStudent.tempChanges[month].processed = processed;
            
            // Update the card appearance immediately
            updateModalCardAppearance(month);
        }

        function updateModalPaymentDate(month, date) {
            if (!currentModalStudent.tempChanges) {
                currentModalStudent.tempChanges = {};
            }
            if (!currentModalStudent.tempChanges[month]) {
                currentModalStudent.tempChanges[month] = {};
            }
            currentModalStudent.tempChanges[month].paymentDate = date;
        }

        function updateModalCardAppearance(month) {
            // Find the card for this month and update its appearance
            const cards = document.querySelectorAll('#modalMonthlyDetails > div');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const selectedYear = parseInt(document.getElementById('modalYearSelect').value);
            
            cards.forEach(card => {
                const headerText = card.querySelector('.font-medium').textContent;
                if (headerText.includes(monthNames[month - 1]) && headerText.includes(selectedYear.toString())) {
                    // Get current values
                    const currentData = currentModalStudent.tuitionData?.monthlyData[month] || {};
                    const tempChanges = currentModalStudent.tempChanges?.[month] || {};
                    
                    const fee = tempChanges.fee !== undefined ? tempChanges.fee : (currentData.fee || 0);
                    const paid = tempChanges.paid !== undefined ? tempChanges.paid : (currentData.paid || false);
                    const processed = tempChanges.processed !== undefined ? tempChanges.processed : (currentData.processed || false);
                    
                    // Update card classes based on new logic
                    let cardClass = 'border rounded-lg p-3';
                    let headerClass = 'font-medium text-sm mb-2';
                    
                    if (fee > 0) {
                        if (processed) {
                            // Processed: Green
                            cardClass += ' bg-green-50 border-green-200';
                            headerClass += ' text-green-800';
                        } else if (paid) {
                            // Paid but not processed: Yellow
                            cardClass += ' bg-yellow-50 border-yellow-200';
                            headerClass += ' text-yellow-800';
                        } else {
                            // Fee set but not paid: Red
                            cardClass += ' bg-red-50 border-red-200';
                            headerClass += ' text-red-800';
                        }
                    } else {
                        // No fee: Gray
                        cardClass += ' bg-gray-50 border-gray-200';
                        headerClass += ' text-gray-500';
                    }
                    
                    card.className = cardClass;
                    card.querySelector('.font-medium').className = headerClass;
                }
            });
        }

        async function saveStudentTuitionDetails() {
            if (!currentModalStudent) return;
            
            try {
                updateSyncStatus('syncing', 'Saving changes...');
                
                const selectedYear = parseInt(document.getElementById('modalYearSelect').value);
                const notes = document.getElementById('modalNotes').value;
                
                // Save notes
                if (notes.trim()) {
                    await db.collection('studentNotes').doc(`${currentModalStudent.studentId}_${selectedYear}`).set({
                        studentId: currentModalStudent.studentId,
                        year: selectedYear,
                        notes: notes,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                
                // Save monthly changes
                if (currentModalStudent.tempChanges) {
                    for (const [month, changes] of Object.entries(currentModalStudent.tempChanges)) {
                        const monthStr = String(month).padStart(2, '0');
                        const docId = `tuition_${currentModalStudent.studentId}_${selectedYear}-${monthStr}`;
                        
                        const updateData = {
                            studentId: currentModalStudent.studentId,
                            fullName: currentModalStudent.fullName,
                            classAssignment: currentModalStudent.classAssignment,
                            month: parseInt(month),
                            year: selectedYear,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        if (changes.fee !== undefined) {
                            updateData.finalFee = changes.fee;
                            updateData.calculatedFee = changes.fee;
                            updateData.status = changes.fee > 0 ? 'saved' : 'no_fee';
                        }
                        
                        if (changes.paid !== undefined) {
                            updateData.paid = changes.paid;
                            if (changes.paid) {
                                updateData.status = 'paid';
                                updateData.paymentDate = changes.paymentDate || new Date().toISOString().split('T')[0];
                            }
                        }
                        
                        if (changes.processed !== undefined) {
                            updateData.processed = changes.processed;
                            if (changes.processed) {
                                updateData.status = 'processed';
                            }
                        }
                        
                        if (changes.paymentDate !== undefined) {
                            updateData.paymentDate = changes.paymentDate;
                        }
                        
                        await db.collection('tuition').doc(docId).set(updateData, { merge: true });
                        
                        // Create transaction record ONLY if marking as paid for the first time
                        // Save to separate paymentTransactions collection instead of payments
                        if (changes.paid && !currentModalStudent.tuitionData?.monthlyData[month]?.paid) {
                            const fee = changes.fee !== undefined ? changes.fee : (currentModalStudent.tuitionData?.monthlyData[month]?.fee || 0);
                            
                            if (fee > 0) {
                                // Generate document ID: txn_YYYYMMDD_studentId_YYYYMM_timestamp
                                const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                                const monthStr = String(month).padStart(2, '0');
                                const timestamp = Date.now();
                                const txnDocId = `txn_${dateStr}_${currentModalStudent.studentId}_${selectedYear}${monthStr}_${timestamp}`;
                                
                                const transactionData = {
                                    paymentDate: new Date(changes.paymentDate || new Date().toISOString().split('T')[0]),
                                    studentId: currentModalStudent.studentId,
                                    studentName: currentModalStudent.fullName,
                                    classAssignment: currentModalStudent.classAssignment,
                                    tuitionYear: selectedYear,
                                    tuitionMonth: parseInt(month),
                                    amountPaid: fee,
                                    paymentStatus: 'received', // Always start as received from tuition board
                                    recordedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    recordedBy: 'tuition_board',
                                    source: 'tuition_modal',
                                    transactionType: 'tuition_payment'
                                };
                                
                                await db.collection('paymentTransactions').doc(txnDocId).set(transactionData);
                            }
                        }
                    }
                }
                
                // Clear temp changes
                currentModalStudent.tempChanges = {};
                
                // Reload data and close modal
                await loadStudentTuitionData();
                closeStudentTuitionModal();
                
                updateSyncStatus('connected', 'Changes saved');
            } catch (error) {
                console.error('Error saving tuition details:', error);
                updateSyncStatus('error', 'Save failed');
                alert('Error saving changes: ' + error.message);
            }
        }

        function closeStudentTuitionModal() {
            document.getElementById('studentTuitionModal').classList.add('hidden');
            currentModalStudent = null;
        }

        function toggleEditMode() {
            editMode = !editMode;
            const btn = document.getElementById('editModeBtn');
            
            if (editMode) {
                btn.textContent = 'Exit Edit Mode';
                btn.className = 'px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm';
            } else {
                btn.textContent = 'Enable Edit Mode';
                btn.className = 'px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm';
            }
            
            // Re-render table with edit mode
            filterStudentTuition();
        }

        async function updateTuitionFee(studentId, month, year, inputValue) {
            try {
                const fee = parseVNDInput(inputValue);
                const monthStr = String(month).padStart(2, '0');
                const docId = `tuition_${studentId}_${year}-${monthStr}`;
                
                // Find student data
                const student = allStudentTuition.find(s => s.studentId === studentId);
                if (!student) return;
                
                const updateData = {
                    studentId: studentId,
                    fullName: student.fullName,
                    classAssignment: student.classAssignment,
                    month: month,
                    year: year,
                    finalFee: fee,
                    calculatedFee: fee,
                    status: fee > 0 ? 'saved' : 'no_fee',
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('tuition').doc(docId).set(updateData, { merge: true });
                
                // Update local data
                if (!student.tuitionData) {
                    student.tuitionData = { monthlyData: {}, totalExpected: 0, totalPaid: 0, outstanding: 0 };
                }
                if (!student.tuitionData.monthlyData[month]) {
                    student.tuitionData.monthlyData[month] = {};
                }
                student.tuitionData.monthlyData[month].fee = fee;
                student.tuitionData.monthlyData[month].status = fee > 0 ? 'saved' : 'no_fee';
                
                // Recalculate totals
                let totalExpected = 0;
                let totalPaid = 0;
                for (const monthData of Object.values(student.tuitionData.monthlyData)) {
                    totalExpected += monthData.fee || 0;
                    if (monthData.paid) {
                        totalPaid += monthData.fee || 0;
                    }
                }
                student.tuitionData.totalExpected = totalExpected;
                student.tuitionData.totalPaid = totalPaid;
                student.tuitionData.outstanding = totalExpected - totalPaid;
                
                updateSyncStatus('connected', 'Fee updated');
            } catch (error) {
                console.error('Error updating tuition fee:', error);
                updateSyncStatus('error', 'Update failed');
            }
        }

        async function deleteStudentTuition(studentId) {
            if (!confirm('Are you sure you want to delete all tuition records for this student?')) {
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'Deleting records...');
                
                // Delete all tuition records for this student
                const tuitionSnapshot = await db.collection('tuition')
                    .where('studentId', '==', studentId)
                    .get();
                
                const batch = db.batch();
                tuitionSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                
                await batch.commit();
                
                // Reload data
                await loadStudentTuitionData();
                
                updateSyncStatus('connected', 'Records deleted');
            } catch (error) {
                console.error('Error deleting tuition records:', error);
                updateSyncStatus('error', 'Delete failed');
                alert('Error deleting records: ' + error.message);
            }
        }

        // Payment Tracker Functions
        async function loadPaymentTracker() {
            try {
                updateSyncStatus('syncing', 'Loading payments...');
                
                // Load all students for search functionality
                await loadAllStudentsForSearch();
                
                // Load all payments
                await loadAllPayments();
                
                // Clear any existing rows first
                document.getElementById('paymentRecordsTable').innerHTML = '';
                paymentRowCounter = 0;
                
                // Apply filters and render
                filterPayments();
                
                updateSyncStatus('connected');
            } catch (error) {
                console.error('Error loading payment tracker:', error);
                updateSyncStatus('error', 'Load failed');
            }
        }

        async function loadAllStudentsForSearch() {
            try {
                const snapshot = await db.collection('students').get();
                allStudentsForSearch = [];
                
                snapshot.forEach(doc => {
                    const student = { id: doc.id, ...doc.data() };
                    allStudentsForSearch.push(student);
                });
            } catch (error) {
                console.error('Error loading students for search:', error);
            }
        }

        async function loadAllPayments() {
            try {
                const snapshot = await db.collection('paymentTransactions').get();
                allPayments = [];
                
                snapshot.forEach(doc => {
                    const payment = { id: doc.id, ...doc.data() };
                    // Convert Firestore timestamp to Date if needed
                    if (payment.paymentDate && payment.paymentDate.toDate) {
                        payment.paymentDate = payment.paymentDate.toDate();
                    }
                    allPayments.push(payment);
                });
            } catch (error) {
                console.error('Error loading payments:', error);
            }
        }

        function addPaymentRow() {
            paymentRowCounter++;
            const tbody = document.getElementById('paymentRecordsTable');
            const row = document.createElement('tr');
            row.id = `paymentRow_${paymentRowCounter}`;
            row.className = 'border-b';
            
            const today = new Date().toISOString().split('T')[0];
            const currentYear = new Date().getFullYear();
            
            row.innerHTML = `
                <td class="px-4 py-2">
                    <input type="date" value="${today}" class="w-full px-2 py-1 border rounded text-sm" id="paymentDate_${paymentRowCounter}">
                </td>
                <td class="px-4 py-2">
                    <div class="relative">
                        <input type="text" placeholder="Type to search students..." class="w-full px-2 py-1 border rounded text-sm" 
                               id="studentSearch_${paymentRowCounter}" 
                               oninput="filterStudentDropdown(${paymentRowCounter})"
                               onfocus="showAllStudents(${paymentRowCounter})"
                               onblur="hideStudentDropdown(${paymentRowCounter})"
                               autocomplete="off">
                        <div id="studentDropdown_${paymentRowCounter}" class="absolute z-[9999] w-full bg-white border rounded-md shadow-lg hidden max-h-40 overflow-y-auto">
                            <!-- Student options will appear here -->
                        </div>
                        <input type="hidden" id="selectedStudentId_${paymentRowCounter}">
                    </div>
                </td>
                <td class="px-4 py-2">
                    <select class="w-full px-2 py-1 border rounded text-sm" id="tuitionYear_${paymentRowCounter}" onchange="updateOutstanding(${paymentRowCounter})">
                        <option value="2023">2023</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>
                        <option value="2029">2029</option>
                        <option value="2030" selected>2030</option>
                    </select>
                </td>
                <td class="px-4 py-2">
                    <select class="w-full px-2 py-1 border rounded text-sm" id="tuitionMonth_${paymentRowCounter}" onchange="updateOutstanding(${paymentRowCounter})">
                        <option value="1">January</option>
                        <option value="2">February</option>
                        <option value="3">March</option>
                        <option value="4">April</option>
                        <option value="5">May</option>
                        <option value="6">June</option>
                        <option value="7">July</option>
                        <option value="8">August</option>
                        <option value="9">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </td>
                <td class="px-4 py-2">
                    <div class="text-sm font-medium text-gray-900" id="outstanding_${paymentRowCounter}">-</div>
                </td>
                <td class="px-4 py-2">
                    <div class="relative">
                        <input type="number" step="0.01" placeholder="0" class="w-full px-2 py-1 pr-8 border rounded text-sm" id="amountPaid_${paymentRowCounter}">
                        <span class="absolute right-2 top-1 text-xs text-gray-500">.000</span>
                    </div>
                </td>
                <td class="px-4 py-2">
                    <select class="w-full px-2 py-1 border rounded text-sm" id="paymentStatus_${paymentRowCounter}">
                        <option value="received">Received</option>
                        <option value="processed">Processed</option>
                    </select>
                </td>
                <td class="px-4 py-2">
                    <button onclick="deletePaymentRow(${paymentRowCounter})" class="text-red-600 hover:text-red-800 text-sm">
                        Delete
                    </button>
                </td>
            `;
            
            // Set current year and month as defaults
            row.querySelector(`#tuitionYear_${paymentRowCounter}`).value = currentYear;
            row.querySelector(`#tuitionMonth_${paymentRowCounter}`).value = new Date().getMonth() + 1;
            
            tbody.appendChild(row);
            
            // Pre-populate the dropdown with all students
            populateStudentDropdown(paymentRowCounter);
        }

        function deletePaymentRow(rowId) {
            const row = document.getElementById(`paymentRow_${rowId}`);
            if (row) {
                row.remove();
            }
        }

        function populateStudentDropdown(rowId) {
            const dropdown = document.getElementById(`studentDropdown_${rowId}`);
            dropdown.innerHTML = '';
            
            // Sort students by name for better UX
            const sortedStudents = [...allStudentsForSearch].sort((a, b) => 
                (a.fullName || '').localeCompare(b.fullName || '')
            );
            
            sortedStudents.forEach(student => {
                const option = document.createElement('div');
                option.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm student-option';
                option.dataset.studentName = normalizeVietnamese(student.fullName || '');
                option.dataset.studentId = normalizeVietnamese(student.studentId || '');
                option.innerHTML = `
                    <div class="font-medium">${student.fullName || 'N/A'}</div>
                    <div class="text-gray-500 text-xs">ID: ${student.studentId || 'N/A'} | Class: ${student.classAssignment || 'N/A'}</div>
                `;
                option.onmousedown = () => selectStudent(rowId, student);
                dropdown.appendChild(option);
            });
        }

        function filterStudentDropdown(rowId) {
            const searchInput = document.getElementById(`studentSearch_${rowId}`);
            const dropdown = document.getElementById(`studentDropdown_${rowId}`);
            const searchTerm = normalizeVietnamese(searchInput.value);
            
            const options = dropdown.querySelectorAll('.student-option');
            let visibleCount = 0;
            
            options.forEach(option => {
                const nameMatch = option.dataset.studentName.includes(searchTerm);
                const idMatch = option.dataset.studentId.includes(searchTerm);
                
                if (nameMatch || idMatch || searchTerm === '') {
                    option.style.display = 'block';
                    visibleCount++;
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Show dropdown if there are visible options
            if (visibleCount > 0) {
                dropdown.classList.remove('hidden');
            } else {
                dropdown.classList.add('hidden');
            }
        }

        function showAllStudents(rowId) {
            const dropdown = document.getElementById(`studentDropdown_${rowId}`);
            const options = dropdown.querySelectorAll('.student-option');
            
            // Show all options
            options.forEach(option => {
                option.style.display = 'block';
            });
            
            dropdown.classList.remove('hidden');
        }

        function selectStudent(rowId, student) {
            document.getElementById(`studentSearch_${rowId}`).value = `${student.fullName} (${student.studentId})`;
            document.getElementById(`selectedStudentId_${rowId}`).value = student.studentId;
            document.getElementById(`studentDropdown_${rowId}`).classList.add('hidden');
            
            // Update outstanding amount when student is selected
            updateOutstanding(rowId);
        }

        function hideStudentDropdown(rowId) {
            setTimeout(() => {
                document.getElementById(`studentDropdown_${rowId}`).classList.add('hidden');
            }, 200);
        }

        async function updateOutstanding(rowId) {
            const studentId = document.getElementById(`selectedStudentId_${rowId}`).value;
            const year = parseInt(document.getElementById(`tuitionYear_${rowId}`).value);
            const month = parseInt(document.getElementById(`tuitionMonth_${rowId}`).value);
            const outstandingDiv = document.getElementById(`outstanding_${rowId}`);
            
            if (!studentId || !year || !month) {
                outstandingDiv.textContent = '-';
                return;
            }
            
            try {
                // Get tuition record for this student/month/year
                const monthStr = String(month).padStart(2, '0');
                const docId = `tuition_${studentId}_${year}-${monthStr}`;
                const tuitionDoc = await db.collection('tuition').doc(docId).get();
                
                if (tuitionDoc.exists) {
                    const tuitionData = tuitionDoc.data();
                    const finalFee = tuitionData.finalFee || tuitionData.calculatedFee || 0;
                    const paid = tuitionData.paid || false;
                    
                    if (finalFee > 0) {
                        if (paid) {
                            outstandingDiv.textContent = '0';
                            outstandingDiv.className = 'text-sm font-medium text-green-600';
                        } else {
                            outstandingDiv.textContent = formatVNDForDisplay(finalFee, true);
                            outstandingDiv.className = 'text-sm font-medium text-red-600';
                        }
                    } else {
                        outstandingDiv.textContent = 'No fee set';
                        outstandingDiv.className = 'text-sm font-medium text-gray-500';
                    }
                } else {
                    outstandingDiv.textContent = 'No record';
                    outstandingDiv.className = 'text-sm font-medium text-gray-500';
                }
            } catch (error) {
                console.error('Error fetching outstanding amount:', error);
                outstandingDiv.textContent = 'Error';
                outstandingDiv.className = 'text-sm font-medium text-red-500';
            }
        }

        async function recordPayments() {
            try {
                updateSyncStatus('syncing', 'Recording payments...');
                
                const tbody = document.getElementById('paymentRecordsTable');
                const rows = tbody.querySelectorAll('tr');
                const payments = [];
                
                for (const row of rows) {
                    const rowId = row.id.split('_')[1];
                    const paymentDate = document.getElementById(`paymentDate_${rowId}`).value;
                    const selectedStudentId = document.getElementById(`selectedStudentId_${rowId}`).value;
                    const tuitionYear = parseInt(document.getElementById(`tuitionYear_${rowId}`).value);
                    const tuitionMonth = parseInt(document.getElementById(`tuitionMonth_${rowId}`).value);
                    const amountPaid = parseVNDInput(document.getElementById(`amountPaid_${rowId}`).value);
                    const paymentStatus = document.getElementById(`paymentStatus_${rowId}`).value;
                    
                    // Validate required fields
                    if (!paymentDate || !selectedStudentId || !amountPaid || amountPaid <= 0) {
                        continue; // Skip incomplete rows
                    }
                    
                    // Find student details
                    const student = allStudentsForSearch.find(s => s.studentId === selectedStudentId);
                    if (!student) continue;
                    
                    // Generate document ID: rec_YYYYMMDD_studentId_YYYYMM_timestamp
                    const dateStr = paymentDate.replace(/-/g, '');
                    const monthStr = String(tuitionMonth).padStart(2, '0');
                    const timestamp = Date.now();
                    const recDocId = `rec_${dateStr}_${selectedStudentId}_${tuitionYear}${monthStr}_${timestamp}`;
                    
                    const paymentData = {
                        paymentDate: new Date(paymentDate),
                        studentId: selectedStudentId,
                        studentName: student.fullName,
                        classAssignment: student.classAssignment,
                        tuitionYear: tuitionYear,
                        tuitionMonth: tuitionMonth,
                        amountPaid: amountPaid,
                        paymentStatus: paymentStatus,
                        recordedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        recordedBy: 'payment_recorder',
                        source: 'payment_tracker',
                        transactionType: 'manual_payment',
                        docId: recDocId
                    };
                    
                    payments.push(paymentData);
                }
                
                if (payments.length === 0) {
                    alert('No valid payment records to save. Please fill in all required fields.');
                    updateSyncStatus('connected');
                    return;
                }
                
                // Save payments to new paymentTransactions collection
                const batch = db.batch();
                for (const payment of payments) {
                    const docRef = db.collection('paymentTransactions').doc(payment.docId);
                    batch.set(docRef, payment);
                    
                    // Update tuition record if exists
                    const monthStr = String(payment.tuitionMonth).padStart(2, '0');
                    const tuitionDocId = `tuition_${payment.studentId}_${payment.tuitionYear}-${monthStr}`;
                    const tuitionRef = db.collection('tuition').doc(tuitionDocId);
                    
                    batch.set(tuitionRef, {
                        paid: true,
                        paymentDate: payment.paymentDate,
                        paymentAmount: payment.amountPaid,
                        paymentStatus: payment.paymentStatus,
                        status: payment.paymentStatus === 'processed' ? 'processed' : 'paid'
                    }, { merge: true });
                }
                
                await batch.commit();
                
                // Clear the form and reload data
                cancelPaymentRecording();
                await loadAllPayments();
                filterPayments();
                
                updateSyncStatus('connected', `${payments.length} payment(s) recorded`);
                alert(`Successfully recorded ${payments.length} payment(s)!`);
                
            } catch (error) {
                console.error('Error recording payments:', error);
                updateSyncStatus('error', 'Recording failed');
                alert('Error recording payments: ' + error.message);
            }
        }

        function cancelPaymentRecording() {
            // Clear all payment rows
            document.getElementById('paymentRecordsTable').innerHTML = '';
            paymentRowCounter = 0;
            
            // Add one empty row
            addPaymentRow();
        }

        function filterPayments() {
            const searchTerm = normalizeVietnamese(document.getElementById('paymentSearch').value);
            const yearFilter = document.getElementById('paymentYearFilter').value;
            const monthFilter = document.getElementById('paymentMonthFilter').value;
            const statusFilter = document.getElementById('paymentStatusFilter').value;
            const sortBy = document.getElementById('paymentSortBy').value;
            
            filteredPayments = allPayments.filter(payment => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    normalizeVietnamese(payment.studentName || '').includes(searchTerm) ||
                    normalizeVietnamese(payment.studentId || '').includes(searchTerm);
                
                // Year filter
                const matchesYear = !yearFilter || payment.tuitionYear == yearFilter;
                
                // Month filter
                const matchesMonth = !monthFilter || payment.tuitionMonth == monthFilter;
                
                // Status filter
                const matchesStatus = !statusFilter || payment.paymentStatus === statusFilter;
                
                return matchesSearch && matchesYear && matchesMonth && matchesStatus;
            });
            
            // Sort payments
            filteredPayments.sort((a, b) => {
                switch (sortBy) {
                    case 'date_newest':
                        return new Date(b.paymentDate) - new Date(a.paymentDate);
                    case 'date_oldest':
                        return new Date(a.paymentDate) - new Date(b.paymentDate);
                    case 'amount_low':
                        return (a.amountPaid || 0) - (b.amountPaid || 0);
                    case 'amount_high':
                        return (b.amountPaid || 0) - (a.amountPaid || 0);
                    case 'student_name':
                        return (a.studentName || '').localeCompare(b.studentName || '');
                    case 'student_id':
                        return (a.studentId || '').localeCompare(b.studentId || '');
                    default:
                        return 0;
                }
            });
            
            renderPaymentTransactions();
            updatePaymentSummary();
        }

        function renderPaymentTransactions() {
            const tbody = document.getElementById('paymentTransactionsTable');
            tbody.innerHTML = '';
            
            if (filteredPayments.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500">
                            No payment records found for the selected criteria
                        </td>
                    </tr>
                `;
                return;
            }
            
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            filteredPayments.forEach(payment => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                
                const paymentDate = payment.paymentDate instanceof Date ? payment.paymentDate : new Date(payment.paymentDate);
                const formattedDate = paymentDate.toLocaleDateString('en-GB');
                
                const statusClass = payment.paymentStatus === 'processed' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                const statusText = payment.paymentStatus === 'processed' ? 'Processed' : 'Received';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="rounded payment-checkbox" data-payment-id="${payment.id}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${formattedDate}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${payment.studentName || 'N/A'}</div>
                        <div class="text-sm text-gray-500">ID: ${payment.studentId || 'N/A'}</div>
                        <div class="text-sm text-gray-500">Class: ${payment.classAssignment || 'N/A'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${monthNames[payment.tuitionMonth - 1]} ${payment.tuitionYear}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${formatVNDForDisplay(payment.amountPaid)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editPayment('${payment.id}')" class="text-blue-600 hover:text-blue-900 mr-3">Edit</button>
                        <button onclick="deletePayment('${payment.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Update bulk action buttons
            updateBulkActionButtons();
        }

        function updatePaymentSummary() {
            const totalCount = filteredPayments.length;
            const totalAmount = filteredPayments.reduce((sum, payment) => sum + (payment.amountPaid || 0), 0);
            const pendingCount = filteredPayments.filter(payment => payment.paymentStatus === 'received').length;
            
            document.getElementById('totalPaymentsCount').textContent = totalCount;
            document.getElementById('totalPaymentsAmount').textContent = formatVNDForDisplay(totalAmount);
            document.getElementById('pendingProcessingCount').textContent = pendingCount;
        }

        function toggleAllPaymentSelection() {
            const selectAll = document.getElementById('selectAllPayments');
            const checkboxes = document.querySelectorAll('.payment-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateBulkActionButtons();
        }

        function updateBulkActionButtons() {
            const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
            const bulkProcessBtn = document.getElementById('bulkProcessBtn');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            
            const hasSelection = checkboxes.length > 0;
            bulkProcessBtn.disabled = !hasSelection;
            bulkDeleteBtn.disabled = !hasSelection;
            
            if (hasSelection) {
                bulkProcessBtn.classList.remove('opacity-50');
                bulkDeleteBtn.classList.remove('opacity-50');
            } else {
                bulkProcessBtn.classList.add('opacity-50');
                bulkDeleteBtn.classList.add('opacity-50');
            }
        }

        async function bulkUpdateStatus(newStatus) {
            const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
            if (checkboxes.length === 0) return;
            
            if (!confirm(`Are you sure you want to mark ${checkboxes.length} payment(s) as ${newStatus}?`)) {
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'Updating status...');
                
                const batch = db.batch();
                checkboxes.forEach(checkbox => {
                    const paymentId = checkbox.dataset.paymentId;
                    const paymentRef = db.collection('paymentTransactions').doc(paymentId);
                    batch.update(paymentRef, { 
                        paymentStatus: newStatus,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                
                await batch.commit();
                
                // Reload data
                await loadAllPayments();
                filterPayments();
                
                // Clear selections
                document.getElementById('selectAllPayments').checked = false;
                
                updateSyncStatus('connected', 'Status updated');
            } catch (error) {
                console.error('Error updating payment status:', error);
                updateSyncStatus('error', 'Update failed');
                alert('Error updating payment status: ' + error.message);
            }
        }

        async function bulkDeletePayments() {
            const checkboxes = document.querySelectorAll('.payment-checkbox:checked');
            if (checkboxes.length === 0) return;
            
            if (!confirm(`Are you sure you want to delete ${checkboxes.length} payment record(s)? This action cannot be undone.`)) {
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'Deleting payments...');
                
                const batch = db.batch();
                checkboxes.forEach(checkbox => {
                    const paymentId = checkbox.dataset.paymentId;
                    const paymentRef = db.collection('paymentTransactions').doc(paymentId);
                    batch.delete(paymentRef);
                });
                
                await batch.commit();
                
                // Reload data
                await loadAllPayments();
                filterPayments();
                
                // Clear selections
                document.getElementById('selectAllPayments').checked = false;
                
                updateSyncStatus('connected', 'Payments deleted');
            } catch (error) {
                console.error('Error deleting payments:', error);
                updateSyncStatus('error', 'Delete failed');
                alert('Error deleting payments: ' + error.message);
            }
        }

        async function editPayment(paymentId) {
            // For now, just show an alert. Could implement a modal for editing
            alert('Edit payment functionality - to be implemented');
        }

        async function deletePayment(paymentId) {
            if (!confirm('Are you sure you want to delete this payment record?')) {
                return;
            }
            
            try {
                updateSyncStatus('syncing', 'Deleting payment...');
                
                await db.collection('paymentTransactions').doc(paymentId).delete();
                
                // Reload data
                await loadAllPayments();
                filterPayments();
                
                updateSyncStatus('connected', 'Payment deleted');
            } catch (error) {
                console.error('Error deleting payment:', error);
                updateSyncStatus('error', 'Delete failed');
                alert('Error deleting payment: ' + error.message);
            }
        }

        // Add event listeners for bulk actions
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('payment-checkbox')) {
                updateBulkActionButtons();
            }
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadCoursePlans();
            loadClasses();
            
            // Set current month and year as defaults
            const now = new Date();
            document.getElementById('monthFilter').value = now.getMonth() + 1;
            document.getElementById('yearFilter').value = now.getFullYear();
            
            // Set up real-time listeners for Firestore
            setupRealtimeListeners();
        });

        function setupRealtimeListeners() {
            // Listen for course plans changes
            db.collection('coursePlans')
                .onSnapshot((snapshot) => {
                    loadCoursePlans();
                    updateSyncStatus('connected', 'Synced');
                }, (error) => {
                    console.error('Error in real-time listener:', error);
                    updateSyncStatus('error', 'Sync failed');
                });
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97399ea0e2e2e2f2',t:'MTc1NTk0MTcyNC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
