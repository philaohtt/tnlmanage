<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, limit, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBikDynsjPuXbFCUqfQowEwosO4tl66WOI",
            authDomain: "tnl-app-ver3.firebaseapp.com",
            projectId: "tnl-app-ver3",
            storageBucket: "tnl-app-ver3.firebasestorage.app",
            messagingSenderId: "87206246036",
            appId: "1:87206246036:web:5f96bf7e59a2a0d9a82681",
            measurementId: "G-XGP4JNMZNQ"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Make Firebase functions globally available
        window.db = db;
        window.firestore = { collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, limit, getDoc, setDoc };
        
        // Signal that Firebase is ready and trigger initial load
        window.firebaseReady = true;
        
        // Initialize the app immediately after Firebase is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (window.db && window.firestore) {
                    loadCourses();
                    loadStudents();
                } else {
                    updateConnectionStatus('error');
                    showNotification('Firebase not initialized. Please check your configuration.', 'error');
                }
            }, 500);
        });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-connected { background-color: #10b981; }
        .status-loading { background-color: #f59e0b; animation: pulse 2s infinite; }
        .status-error { background-color: #ef4444; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        
        .loading { opacity: 0.6; pointer-events: none; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Course Management System</h1>
                    <p class="text-sm text-gray-600 mt-1">Manage courses, students, attendance, and performance</p>
                </div>
                <div class="flex items-center">
                    <span class="status-dot status-loading"></span>
                    <span class="text-sm text-gray-600" id="statusText">Connecting...</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Tabs -->
        <div class="flex justify-center gap-4 mb-6">
            <button onclick="switchTab('in-progress')" id="tab-in-progress" class="px-6 py-3 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 flex items-center">
                ðŸ“š In Progress <span id="count-in-progress" class="ml-2 px-2 py-0.5 bg-blue-200 text-blue-800 rounded-full text-xs">0</span>
            </button>
            <button onclick="switchTab('upcoming')" id="tab-upcoming" class="px-6 py-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-orange-100 hover:text-orange-800 flex items-center">
                ðŸ“… Upcoming <span id="count-upcoming" class="ml-2 px-2 py-0.5 bg-gray-200 text-gray-600 rounded-full text-xs">0</span>
            </button>
            <button onclick="switchTab('finished')" id="tab-finished" class="px-6 py-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-green-100 hover:text-green-800 flex items-center">
                âœ… Finished <span id="count-finished" class="ml-2 px-2 py-0.5 bg-gray-200 text-gray-600 rounded-full text-xs">0</span>
            </button>
        </div>

        <!-- Search & Controls -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <div class="flex flex-col sm:flex-row gap-4 justify-between items-end">
                <div class="flex flex-col sm:flex-row gap-4 flex-1">
                    <input type="text" placeholder="Search courses..." class="flex-1 max-w-md pl-4 pr-4 py-2 border rounded-lg" id="searchInput">
                    <div class="flex flex-col">
                        <label class="text-sm font-medium text-gray-700 mb-1">Sort by</label>
                        <select id="sortSelect" class="px-3 py-2 border rounded-lg text-sm">
                            <option value="code">Course Code</option>
                            <option value="name">Course Name</option>
                            <option value="teacher">Teacher</option>
                            <option value="startDate">Start Date</option>
                            <option value="studentCount">Student Count</option>
                        </select>
                    </div>
                </div>
                <button onclick="openAddCourseModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium">
                    + Add Course
                </button>
            </div>
        </div>

        <!-- Courses Table -->
        <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Course</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Teacher & Schedule</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Students</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Sessions</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Assessments</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="coursesTableBody" class="divide-y">
                        <!-- Courses will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Empty State -->
            <div id="emptyState" class="text-center py-12" style="display: none;">
                <div class="text-gray-400 mb-4">ðŸ“š</div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No courses found</h3>
                <p class="text-gray-500 mb-4">Get started by adding your first course.</p>
                <button onclick="openAddCourseModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-medium">
                    Add Your First Course
                </button>
            </div>
        </div>
    </main>

    <!-- Add Course Modal -->
    <div id="addCourseModal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">Add New Course</h2>
                <button onclick="closeAddCourseModal()" class="text-gray-400 hover:text-gray-600">Ã—</button>
            </div>
            
            <form id="addCourseForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Course Code</label>
                        <input type="text" required class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., CS101" id="courseCode">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Course Name</label>
                        <input type="text" required class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., Introduction to Computer Science" id="courseName">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Teacher</label>
                        <select required class="w-full px-3 py-2 border rounded-lg" id="courseTeacher" onchange="toggleCustomTeacher()">
                            <option value="">Select a teacher</option>
                            <option value="other">Other (specify below)</option>
                        </select>
                        <input type="text" class="w-full px-3 py-2 border rounded-lg mt-2" placeholder="Enter teacher name" id="customTeacher" style="display: none;">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Start Date</label>
                            <input type="date" required class="w-full px-3 py-2 border rounded-lg" id="courseStartDate">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Status</label>
                            <select required class="w-full px-3 py-2 border rounded-lg" id="courseStatus">
                                <option value="inProgress">In Progress</option>
                                <option value="upcoming">Upcoming</option>
                                <option value="finished">Finished</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Schedule</label>
                        <input type="text" required class="w-full px-3 py-2 border rounded-lg" placeholder="e.g., Mon, Wed, Fri 9:00-10:30" id="courseSchedule">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6 pt-6 border-t">
                    <button type="button" onclick="closeAddCourseModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg">Add Course</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Students Modal -->
    <div id="manageStudentsModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh;">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold" id="manageStudentsTitle">Manage Students</h2>
                <button onclick="closeManageStudentsModal()" class="text-gray-400 hover:text-gray-600">Ã—</button>
            </div>
            
            <!-- Search and Filters -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Search Students</label>
                        <input type="text" placeholder="Search by name or ID..." class="w-full px-3 py-2 border rounded-lg text-sm" id="studentSearchInput">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Filter by Status</label>
                        <select class="w-full px-3 py-2 border rounded-lg text-sm" id="studentStatusFilter">
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="finished">Finished</option>
                            <option value="dropped">Dropped</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Filter by Class</label>
                        <select class="w-full px-3 py-2 border rounded-lg text-sm" id="studentClassFilter">
                            <option value="">All Classes</option>
                            <!-- Classes will be populated dynamically -->
                        </select>
                    </div>
                </div>
            </div>

            <!-- Two Column Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Available Students (Left Side) -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-lg font-medium">Available Students <span id="availableCount" class="text-sm text-gray-500">(0)</span></h4>
                        <button onclick="toggleAvailableStudents()" class="text-sm text-blue-600 hover:text-blue-800 flex items-center">
                            <svg id="availableCollapseIcon" class="w-4 h-4 mr-1 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                            <span id="availableCollapseText">Collapse</span>
                        </button>
                    </div>
                    <div id="availableStudentsContainer" class="border rounded-lg overflow-hidden">
                        <div class="overflow-x-auto max-h-96">
                            <table class="w-full">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Select</th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="availableStudentsBody">
                                    <!-- Available students will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Currently Enrolled Students (Right Side) -->
                <div>
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="text-lg font-medium">Currently Enrolled <span id="enrolledCount" class="text-sm text-gray-500">(0)</span></h4>
                        <button onclick="toggleEnrolledStudents()" class="text-sm text-green-600 hover:text-green-800 flex items-center">
                            <svg id="enrolledCollapseIcon" class="w-4 h-4 mr-1 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                            <span id="enrolledCollapseText">Collapse</span>
                        </button>
                    </div>
                    <div id="enrolledStudentsContainer" class="border rounded-lg overflow-hidden">
                        <div class="overflow-x-auto max-h-96">
                            <table class="w-full">
                                <thead class="bg-green-50 sticky top-0">
                                    <tr>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                                        <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200" id="enrolledStudentsBody">
                                    <!-- Enrolled students will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex justify-between items-center pt-6 border-t">
                <div class="flex space-x-3">
                    <button onclick="enrollSelectedStudents()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-medium">
                        Enroll Selected Students
                    </button>
                    <button onclick="addNewStudent()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-medium">
                        + Add New Student
                    </button>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600">
                        <span id="selectedStudentsCount">0</span> students selected
                    </div>
                    <button onclick="closeManageStudentsModal()" class="px-6 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg font-medium">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Modal -->
    <div id="attendanceModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh;">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">Manage Attendance</h2>
                <button onclick="closeAttendanceModal()" class="text-gray-400 hover:text-gray-600">Ã—</button>
            </div>
            <div class="course-info mb-6"></div>
            
            <!-- Add Session Form -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-medium">Add New Session</h3>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">Sort students by:</label>
                        <select id="attendanceStudentSort" class="px-2 py-1 border rounded text-sm" onchange="loadAttendanceForCourse(currentCourseId)">
                            <option value="id">Student ID</option>
                            <option value="name">Name</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                    <input type="date" required class="px-3 py-2 border rounded-lg text-sm" placeholder="Date">
                    <input type="text" required class="px-3 py-2 border rounded-lg text-sm" placeholder="Teacher">
                    <input type="text" required class="px-3 py-2 border rounded-lg text-sm" placeholder="Lesson Name">
                    <button onclick="addAttendanceDate()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm">
                        Add Session
                    </button>
                </div>
            </div>
            
            <!-- Attendance Table -->
            <div class="border rounded-lg overflow-hidden">
                <div class="overflow-auto max-h-96" style="max-width: 100%;">
                    <table class="w-full text-sm relative">
                        <thead id="attendanceTableHead" class="bg-gray-50 sticky top-0 z-30">
                            <!-- Headers will be populated by JavaScript -->
                        </thead>
                        <tbody id="attendanceTableBody">
                            <!-- Attendance data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6 pt-6 border-t">
                <button onclick="closeAttendanceModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Performance Modal -->
    <div id="performanceModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh;">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">Manage Performance</h2>
                <button onclick="closePerformanceModal()" class="text-gray-400 hover:text-gray-600">Ã—</button>
            </div>
            
            <!-- Add Assessment Form -->
            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-sm font-medium">Add New Assessment</h3>
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">Sort students by:</label>
                        <select id="performanceStudentSort" class="px-2 py-1 border rounded text-sm" onchange="loadPerformanceForCourse(currentCourseId)">
                            <option value="id">Student ID</option>
                            <option value="name">Name</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                    <input type="date" required class="px-3 py-2 border rounded-lg text-sm" placeholder="Date">
                    <input type="text" required class="px-3 py-2 border rounded-lg text-sm" placeholder="Assessment Name">
                    <input type="text" required class="px-3 py-2 border rounded-lg text-sm" placeholder="Teacher">
                    <input type="number" step="0.1" min="0" class="px-3 py-2 border rounded-lg text-sm" placeholder="Max Score (optional)">
                    <button onclick="addAssessment()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                        Add Assessment
                    </button>
                </div>
            </div>
            
            <!-- Performance Table -->
            <div class="border rounded-lg overflow-hidden">
                <div class="overflow-auto max-h-96" style="max-width: 100%;">
                    <table class="w-full text-sm relative">
                        <thead id="performanceTableHead" class="bg-gray-50 sticky top-0 z-30">
                            <!-- Headers will be populated by JavaScript -->
                        </thead>
                        <tbody id="performanceTableBody">
                            <!-- Performance data will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6 pt-6 border-t">
                <button onclick="closePerformanceModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">Close</button>
            </div>
        </div>
    </div>

    <!-- Student Attendance Modal -->
    <div id="studentAttendanceModal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">Edit Student Attendance</h2>
                <button onclick="closeStudentAttendanceModal()" class="text-gray-400 hover:text-gray-600">Ã—</button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="font-medium">Student:</span> <span id="studentAttendanceName"></span></div>
                        <div><span class="font-medium">ID:</span> <span id="studentAttendanceId"></span></div>
                        <div><span class="font-medium">Date:</span> <span id="studentAttendanceDate"></span></div>
                        <div><span class="font-medium">Teacher:</span> <span id="studentAttendanceTeacher"></span></div>
                        <div class="col-span-2"><span class="font-medium">Lesson:</span> <span id="studentAttendanceLesson"></span></div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Attendance Status</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="attendanceStatus" value="present" class="mr-2">
                            <span class="text-green-700">Present</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="attendanceStatus" value="absent" class="mr-2">
                            <span class="text-red-700">Absent</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="attendanceStatus" value="no-record" class="mr-2">
                            <span class="text-gray-700">No Record</span>
                        </label>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2">Notes (Optional)</label>
                    <textarea id="attendanceNotes" class="w-full px-3 py-2 border rounded-lg" rows="3" placeholder="Add any notes about this attendance record..."></textarea>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6 pt-6 border-t">
                <button onclick="closeStudentAttendanceModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">Cancel</button>
                <button onclick="saveStudentAttendance()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Save Attendance</button>
            </div>
        </div>
    </div>

    <!-- Date Attendance Modal -->
    <div id="dateAttendanceModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">Manage Attendance for Date</h2>
                <button onclick="closeDateAttendanceModal()" class="text-gray-400 hover:text-gray-600">Ã—</button>
            </div>
            
            <div id="dateAttendanceInfo" class="bg-gray-50 p-4 rounded-lg mb-6 text-sm space-y-1"></div>
            
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium">Student Attendance</h3>
                <div class="flex space-x-2">
                    <button onclick="markAllPresentForDate()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">
                        Mark All Present
                    </button>
                    <button onclick="clearAllForDate()" class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm">
                        Clear All
                    </button>
                </div>
            </div>
            
            <div class="border rounded-lg overflow-hidden">
                <div class="overflow-y-auto max-h-96">
                    <table class="w-full">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Student</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500">Status</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="dateAttendanceStudentsList">
                            <!-- Students will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6 pt-6 border-t">
                <button onclick="closeDateAttendanceModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">Close</button>
                <button onclick="saveDateAttendance()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Attendance Date Modal -->
    <div id="editAttendanceDateModal" class="modal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">Edit Attendance Date</h2>
                <button onclick="closeEditAttendanceDateModal()" class="text-gray-400 hover:text-gray-600">Ã—</button>
            </div>
            
            <form id="editAttendanceDateForm">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Date</label>
                        <input type="date" required class="w-full px-3 py-2 border rounded-lg" id="editAttendanceDate">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Teacher</label>
                        <input type="text" required class="w-full px-3 py-2 border rounded-lg" placeholder="Teacher name" id="editAttendanceTeacher">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Lesson Name</label>
                        <input type="text" required class="w-full px-3 py-2 border rounded-lg" placeholder="Lesson name" id="editAttendanceLesson">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-6 pt-6 border-t">
                    <button type="button" onclick="closeEditAttendanceDateModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Update Date</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assessment Grades Modal -->
    <div id="assessmentGradesModal" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh;">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold">Enter Grades for Assessment</h2>
                <button onclick="closeAssessmentGradesModal()" class="text-gray-400 hover:text-gray-600">Ã—</button>
            </div>
            
            <div id="assessmentGradesInfo" class="bg-gray-50 p-4 rounded-lg mb-6 text-sm space-y-1"></div>
            
            <div class="border rounded-lg overflow-hidden">
                <div class="overflow-y-auto max-h-96">
                    <table class="w-full">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Student ID</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Student Name</th>
                                <th class="px-4 py-2 text-center text-xs font-medium text-gray-500">Score</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Comments</th>
                            </tr>
                        </thead>
                        <tbody id="assessmentGradesStudentsList">
                            <!-- Students will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="flex justify-end space-x-3 mt-6 pt-6 border-t">
                <button onclick="closeAssessmentGradesModal()" class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg">Cancel</button>
                <button onclick="saveAllAssessmentGrades()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">Save All Grades</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Global state
        let currentTab = 'in-progress';
        let courses = [];
        let students = [];
        let loading = false;
        let currentCourseId = null;
        let attendanceDates = [];
        let currentAttendanceRecords = new Map();
        let currentAssessments = [];
        let currentPerformanceRecords = new Map();

        // Connection status
        function updateConnectionStatus(status) {
            const statusDot = document.querySelector('.status-dot');
            const statusText = document.getElementById('statusText');
            
            statusDot.className = 'status-dot';
            
            switch(status) {
                case 'connected':
                    statusDot.classList.add('status-connected');
                    statusText.textContent = 'Connected';
                    break;
                case 'loading':
                    statusDot.classList.add('status-loading');
                    statusText.textContent = 'Loading...';
                    break;
                case 'error':
                    statusDot.classList.add('status-error');
                    statusText.textContent = 'Error';
                    break;
            }
        }

        // Sort function
        function sortCourses(courseList, sortBy) {
            return [...courseList].sort((a, b) => {
                switch (sortBy) {
                    case 'code':
                        return a.code.localeCompare(b.code);
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'teacher':
                        return a.teacher.localeCompare(b.teacher);
                    case 'startDate':
                        return new Date(a.startDate) - new Date(b.startDate);
                    case 'studentCount':
                        return (b.studentCount || 0) - (a.studentCount || 0);
                    default:
                        return a.code.localeCompare(b.code);
                }
            });
        }

        // Core data loading
        async function loadCourses() {
            if (loading) return;
            
            try {
                loading = true;
                updateConnectionStatus('loading');
                
                console.log('Attempting to load courses from Firestore...');
                console.log('Firebase DB:', window.db);
                console.log('Firestore functions:', window.firestore);
                
                const coursesRef = window.firestore.collection(window.db, 'courses');
                const snapshot = await window.firestore.getDocs(coursesRef);
                
                console.log('Firestore query completed. Documents found:', snapshot.size);
                
                courses = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    console.log('Course document:', doc.id, data);
                    courses.push({ 
                        id: doc.id, 
                        ...data,
                        studentCount: data.studentCount || 0,
                        sessionCount: data.sessionCount || 0,
                        assessmentCount: data.assessmentCount || 0
                    });
                });
                
                // If no courses found, add sample data for testing
                if (courses.length === 0) {
                    console.log('No courses found, adding sample data...');
                    await addSampleData();
                    // Reload after adding sample data
                    const newSnapshot = await window.firestore.getDocs(coursesRef);
                    courses = [];
                    newSnapshot.forEach((doc) => {
                        const data = doc.data();
                        courses.push({ 
                            id: doc.id, 
                            ...data,
                            studentCount: data.studentCount || 0,
                            sessionCount: data.sessionCount || 0,
                            assessmentCount: data.assessmentCount || 0
                        });
                    });
                }
                
                console.log('Final courses array:', courses);
                
                // Load date ranges for courses with sessions
                await loadCourseDateRanges();
                
                renderCourses();
                updateTabCounts();
                updateConnectionStatus('connected');
                showNotification(`Loaded ${courses.length} courses successfully!`, 'success');
                
            } catch (error) {
                console.error('Error loading courses:', error);
                updateConnectionStatus('error');
                showNotification(`Failed to load courses: ${error.message}`, 'error');
                
                // Load sample data for offline testing
                loadSampleDataOffline();
            } finally {
                loading = false;
            }
        }

        // Add sample data to Firestore for testing
        async function addSampleData() {
            try {
                const sampleCourses = [
                    {
                        code: 'CS101',
                        name: 'Introduction to Computer Science',
                        teacher: 'Dr. Smith',
                        startDate: '2024-01-15',
                        status: 'inProgress',
                        schedule: 'Mon, Wed, Fri 9:00-10:30',
                        studentCount: 25,
                        sessionCount: 12,
                        assessmentCount: 3
                    },
                    {
                        code: 'MATH201',
                        name: 'Advanced Mathematics',
                        teacher: 'Prof. Johnson',
                        startDate: '2024-02-01',
                        status: 'upcoming',
                        schedule: 'Tue, Thu 14:00-15:30',
                        studentCount: 18,
                        sessionCount: 0,
                        assessmentCount: 0
                    },
                    {
                        code: 'ENG150',
                        name: 'English Literature',
                        teacher: 'Ms. Williams',
                        startDate: '2023-09-01',
                        status: 'finished',
                        schedule: 'Mon, Wed 11:00-12:30',
                        studentCount: 22,
                        sessionCount: 24,
                        assessmentCount: 5
                    }
                ];

                const sampleStudents = [
                    {
                        humanId: 'STU001',
                        fullName: 'John Doe',
                        classRef: 'classes/CS_CLASS_001',
                        status: 'active'
                    },
                    {
                        humanId: 'STU002',
                        fullName: 'Jane Smith',
                        classRef: 'classes/MATH_CLASS_001',
                        status: 'active'
                    },
                    {
                        humanId: 'STU003',
                        fullName: 'Bob Johnson',
                        classRef: 'classes/ENG_CLASS_001',
                        status: 'inactive'
                    }
                ];

                const sampleClasses = [
                    {
                        id: 'CS_CLASS_001',
                        name: 'Computer Science'
                    },
                    {
                        id: 'MATH_CLASS_001',
                        name: 'Mathematics'
                    },
                    {
                        id: 'ENG_CLASS_001',
                        name: 'English'
                    }
                ];

                // Add classes first
                for (const classData of sampleClasses) {
                    const docRef = window.firestore.doc(window.db, 'classes', classData.id);
                    await window.firestore.setDoc(docRef, {
                        name: classData.name,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                }

                // Add courses
                for (const course of sampleCourses) {
                    const courseId = `COURSE_${course.code}_${Date.now()}`;
                    const docRef = window.firestore.doc(window.db, 'courses', courseId);
                    await window.firestore.setDoc(docRef, {
                        ...course,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                }

                // Add students
                for (const student of sampleStudents) {
                    const studentId = `STUDENT_${student.humanId}_${Date.now()}`;
                    const docRef = window.firestore.doc(window.db, 'students', studentId);
                    await window.firestore.setDoc(docRef, {
                        ...student,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                }

                console.log('Sample data added successfully');
            } catch (error) {
                console.error('Error adding sample data:', error);
            }
        }

        // Load sample data for offline testing
        function loadSampleDataOffline() {
            console.log('Loading sample data for offline testing...');
            courses = [
                {
                    id: 'sample1',
                    code: 'CS101',
                    name: 'Introduction to Computer Science',
                    teacher: 'Dr. Smith',
                    startDate: '2024-01-15',
                    status: 'inProgress',
                    schedule: 'Mon, Wed, Fri 9:00-10:30',
                    studentCount: 25,
                    sessionCount: 12,
                    assessmentCount: 3
                },
                {
                    id: 'sample2',
                    code: 'MATH201',
                    name: 'Advanced Mathematics',
                    teacher: 'Prof. Johnson',
                    startDate: '2024-02-01',
                    status: 'upcoming',
                    schedule: 'Tue, Thu 14:00-15:30',
                    studentCount: 18,
                    sessionCount: 0,
                    assessmentCount: 0
                },
                {
                    id: 'sample3',
                    code: 'ENG150',
                    name: 'English Literature',
                    teacher: 'Ms. Williams',
                    startDate: '2023-09-01',
                    status: 'finished',
                    schedule: 'Mon, Wed 11:00-12:30',
                    studentCount: 22,
                    sessionCount: 24,
                    assessmentCount: 5
                }
            ];

            students = [
                {
                    id: 'student1',
                    humanId: 'STU001',
                    fullName: 'John Doe',
                    classRef: 'classes/CS_CLASS_001',
                    className: 'Computer Science',
                    status: 'active'
                },
                {
                    id: 'student2',
                    humanId: 'STU002',
                    fullName: 'Jane Smith',
                    classRef: 'classes/MATH_CLASS_001',
                    className: 'Mathematics',
                    status: 'active'
                },
                {
                    id: 'student3',
                    humanId: 'STU003',
                    fullName: 'Bob Johnson',
                    classRef: 'classes/ENG_CLASS_001',
                    className: 'English',
                    status: 'inactive'
                }
            ];

            renderCourses();
            updateTabCounts();
            updateConnectionStatus('error');
            showNotification('Using sample data (Firebase connection failed)', 'warning');
        }

        async function loadCourseDateRanges() {
            try {
                for (const course of courses) {
                    if (course.sessionCount > 0) {
                        const datesQuery = window.firestore.query(
                            window.firestore.collection(window.db, 'attendanceDates'),
                            window.firestore.where('courseId', '==', course.id)
                        );
                        const datesSnapshot = await window.firestore.getDocs(datesQuery);
                        
                        const dates = [];
                        datesSnapshot.forEach(doc => {
                            dates.push(doc.data().date);
                        });
                        
                        if (dates.length > 0) {
                            dates.sort();
                            course.firstSessionDate = dates[0];
                            course.lastSessionDate = dates[dates.length - 1];
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading course date ranges:', error);
            }
        }

        async function loadStudents() {
            try {
                const studentsRef = window.firestore.collection(window.db, 'students');
                const snapshot = await window.firestore.getDocs(studentsRef);
                
                students = [];
                snapshot.forEach((doc) => {
                    students.push({ id: doc.id, ...doc.data() });
                });
                
            } catch (error) {
                console.error('Error loading students:', error);
                students = [];
            }
        }

        async function loadStudentClassNames() {
            try {
                // Get unique class references from students
                const classRefs = [...new Set(students
                    .map(s => s.classRef)
                    .filter(ref => ref && ref.startsWith('classes/'))
                )];

                // Load class documents
                const classPromises = classRefs.map(async (classRef) => {
                    const classId = classRef.replace('classes/', '');
                    const classDoc = await window.firestore.getDoc(
                        window.firestore.doc(window.db, 'classes', classId)
                    );
                    return { ref: classRef, data: classDoc.exists() ? classDoc.data() : null };
                });

                const classResults = await Promise.all(classPromises);
                const classMap = new Map();
                
                classResults.forEach(result => {
                    if (result.data && result.data.name) {
                        classMap.set(result.ref, result.data.name);
                    }
                });

                // Add class names to student objects
                students.forEach(student => {
                    if (student.classRef && classMap.has(student.classRef)) {
                        student.className = classMap.get(student.classRef);
                    } else {
                        student.className = 'N/A';
                    }
                });

            } catch (error) {
                console.error('Error loading class names:', error);
                // Set default class names if loading fails
                students.forEach(student => {
                    student.className = 'N/A';
                });
            }
        }

        async function addCourse(courseData) {
            try {
                const timestamp = Date.now();
                const courseId = `COURSE_${courseData.code.replace(/[^a-zA-Z0-9]/g, '')}_${timestamp}`;
                
                const docRef = window.firestore.doc(window.db, 'courses', courseId);
                await window.firestore.setDoc(docRef, {
                    ...courseData,
                    studentCount: 0,
                    sessionCount: 0,
                    assessmentCount: 0,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                
                showNotification('Course added successfully!', 'success');
                loadCourses();
                return courseId;
            } catch (error) {
                console.error('Error adding course:', error);
                showNotification('Failed to add course', 'error');
                throw error;
            }
        }

        async function updateCourse(courseId, updates) {
            try {
                const courseRef = window.firestore.doc(window.db, 'courses', courseId);
                await window.firestore.updateDoc(courseRef, {
                    ...updates,
                    updatedAt: new Date()
                });
                
                showNotification('Course updated successfully!', 'success');
                loadCourses();
            } catch (error) {
                console.error('Error updating course:', error);
                showNotification('Failed to update course', 'error');
                throw error;
            }
        }

        async function deleteCourse(courseId) {
            if (!confirm('Are you sure you want to delete this course?')) return;
            
            try {
                await window.firestore.deleteDoc(window.firestore.doc(window.db, 'courses', courseId));
                showNotification('Course deleted successfully!', 'success');
                loadCourses();
            } catch (error) {
                console.error('Error deleting course:', error);
                showNotification('Failed to delete course', 'error');
            }
        }

        // UI Rendering
        function renderCourses() {
            const tbody = document.getElementById('coursesTableBody');
            const emptyState = document.getElementById('emptyState');
            const sortBy = document.getElementById('sortSelect')?.value || 'code';
            
            // Filter courses by current tab
            let filteredCourses = courses.filter(course => {
                if (currentTab === 'in-progress') return course.status === 'inProgress';
                if (currentTab === 'upcoming') return course.status === 'upcoming';
                if (currentTab === 'finished') return course.status === 'finished';
                return true;
            });
            
            // Sort courses
            filteredCourses = sortCourses(filteredCourses, sortBy);
            
            if (filteredCourses.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            
            tbody.innerHTML = filteredCourses.map(course => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                        <div class="font-medium text-sm">${course.code}</div>
                        <div class="text-xs text-gray-600">${course.name}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm">${course.teacher}</div>
                        <div class="text-xs text-gray-600">${course.schedule}</div>
                        <div class="text-xs text-gray-500">Started: ${new Date(course.startDate).toLocaleDateString()}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm font-medium">${course.studentCount || 0} students</div>
                        <button onclick="openManageStudentsModal('${course.id}')" class="text-blue-600 hover:text-blue-800 text-xs">
                            Manage Students
                        </button>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm">${course.sessionCount || 0} sessions</div>
                        <button onclick="openAttendanceModal('${course.id}')" class="text-green-600 hover:text-green-800 text-xs">
                            Manage Attendance
                        </button>
                        ${course.firstSessionDate && course.lastSessionDate ? 
                            `<div class="text-xs text-blue-600 mt-1">Period: ${new Date(course.firstSessionDate).toLocaleDateString()} - ${new Date(course.lastSessionDate).toLocaleDateString()}</div>` : 
                            course.sessionCount > 0 ? '<div class="text-xs text-blue-600 mt-1">Loading period...</div>' : ''
                        }
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-sm">${course.assessmentCount || 0} assessments</div>
                        <button onclick="openPerformanceModal('${course.id}')" class="text-purple-600 hover:text-purple-800 text-xs">
                            Manage Performance
                        </button>
                    </td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            <button onclick="editCourse('${course.id}')" class="text-blue-600 hover:text-blue-800 text-xs">Edit</button>
                            <button onclick="deleteCourse('${course.id}')" class="text-red-600 hover:text-red-800 text-xs">Delete</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateTabCounts() {
            const inProgressCount = courses.filter(c => c.status === 'inProgress').length;
            const upcomingCount = courses.filter(c => c.status === 'upcoming').length;
            const finishedCount = courses.filter(c => c.status === 'finished').length;
            
            document.getElementById('count-in-progress').textContent = inProgressCount;
            document.getElementById('count-upcoming').textContent = upcomingCount;
            document.getElementById('count-finished').textContent = finishedCount;
        }

        // Modal functions
        function openAddCourseModal() {
            document.getElementById('addCourseModal').classList.add('show');
        }

        function closeAddCourseModal() {
            document.getElementById('addCourseModal').classList.remove('show');
            document.getElementById('addCourseForm').reset();
            delete document.getElementById('addCourseForm').dataset.courseId;
            
            // Reset modal title and button text
            document.querySelector('#addCourseModal h2').textContent = 'Add New Course';
            document.querySelector('#addCourseForm button[type="submit"]').textContent = 'Add Course';
        }

        function editCourse(courseId) {
            const course = courses.find(c => c.id === courseId);
            if (!course) return;
            
            // Populate form
            document.getElementById('courseCode').value = course.code;
            document.getElementById('courseName').value = course.name;
            document.getElementById('courseTeacher').value = course.teacher;
            document.getElementById('courseStartDate').value = course.startDate;
            document.getElementById('courseStatus').value = course.status;
            document.getElementById('courseSchedule').value = course.schedule;
            
            // Store course ID and update modal
            document.getElementById('addCourseForm').dataset.courseId = courseId;
            document.querySelector('#addCourseModal h2').textContent = 'Edit Course';
            document.querySelector('#addCourseForm button[type="submit"]').textContent = 'Update Course';
            
            openAddCourseModal();
        }

        // Move To Modal Functions
        function openMoveToModal(courseId) {
            moveToModalCourseId = courseId;
            const course = courses.find(c => c.id === courseId);
            
            if (!course) {
                showNotification('Course not found', 'error');
                return;
            }
            
            document.getElementById('moveToInfo').innerHTML = `
                <div><span class="font-medium">Course:</span> ${course.code} - ${course.name}</div>
                <div><span class="font-medium">Current Status:</span> ${getStatusLabel(course.status)}</div>
                <div><span class="font-medium">Teacher:</span> ${course.teacher}</div>
            `;
            
            // Set available options (exclude current status)
            const statusSelect = document.getElementById('moveToStatus');
            statusSelect.innerHTML = '<option value="">Select new status</option>';
            
            if (course.status !== 'upcoming') {
                statusSelect.innerHTML += '<option value="upcoming">ðŸ“… Upcoming</option>';
            }
            if (course.status !== 'inProgress') {
                statusSelect.innerHTML += '<option value="inProgress">ðŸ“š In Progress</option>';
            }
            if (course.status !== 'finished') {
                statusSelect.innerHTML += '<option value="finished">âœ… Finished</option>';
            }
            
            document.getElementById('moveToModal').classList.add('show');
        }

        function closeMoveToModal() {
            document.getElementById('moveToModal').classList.remove('show');
            moveToModalCourseId = null;
            document.getElementById('moveToStatus').value = '';
        }

        async function confirmMoveTo() {
            const newStatus = document.getElementById('moveToStatus').value;
            
            if (!newStatus) {
                showNotification('Please select a status to move to', 'error');
                return;
            }
            
            if (!moveToModalCourseId) {
                showNotification('No course selected', 'error');
                return;
            }
            
            try {
                await updateCourse(moveToModalCourseId, { status: newStatus });
                showNotification('Course moved successfully!', 'success');
                closeMoveToModal();
            } catch (error) {
                console.error('Error moving course:', error);
                showNotification('Failed to move course', 'error');
            }
        }

        function getStatusLabel(status) {
            switch (status) {
                case 'upcoming': return 'ðŸ“… Upcoming';
                case 'inProgress': return 'ðŸ“š In Progress';
                case 'finished': return 'âœ… Finished';
                default: return status;
            }
        }

        // Tab switching
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab styling
            document.querySelectorAll('[id^="tab-"]').forEach(btn => {
                btn.className = 'px-6 py-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-orange-100 hover:text-orange-800 flex items-center';
            });
            
            const activeTab = document.getElementById(`tab-${tab}`);
            if (tab === 'in-progress') {
                activeTab.className = 'px-6 py-3 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 flex items-center';
            } else if (tab === 'upcoming') {
                activeTab.className = 'px-6 py-3 rounded-lg text-sm font-medium bg-orange-100 text-orange-800 flex items-center';
            } else if (tab === 'finished') {
                activeTab.className = 'px-6 py-3 rounded-lg text-sm font-medium bg-green-100 text-green-800 flex items-center';
            }
            
            renderCourses();
        }

        // Student management
        let availableStudents = [];
        let enrolledStudents = [];
        let availableCollapsed = false;
        let enrolledCollapsed = false;

        async function openManageStudentsModal(courseId) {
            currentCourseId = courseId;
            const course = courses.find(c => c.id === courseId);
            
            if (!course) {
                showNotification('Course not found', 'error');
                return;
            }
            
            document.getElementById('manageStudentsTitle').textContent = `Manage Students - ${course.name}`;
            
            // Load students if not already loaded
            if (students.length === 0) {
                await loadStudents();
            }
            
            await loadStudentEnrollments();
            populateClassFilter();
            renderStudentsTables();
            document.getElementById('manageStudentsModal').classList.add('show');
        }

        function closeManageStudentsModal() {
            document.getElementById('manageStudentsModal').classList.remove('show');
            currentCourseId = null;
            availableStudents = [];
            enrolledStudents = [];
            
            // Reset filters
            document.getElementById('studentSearchInput').value = '';
            document.getElementById('studentStatusFilter').value = '';
            document.getElementById('studentClassFilter').value = '';
        }

        async function loadStudentEnrollments() {
            try {
                // Load all enrollments for this course (active and dropped)
                const enrollmentsQuery = window.firestore.query(
                    window.firestore.collection(window.db, 'enrollments'),
                    window.firestore.where('courseId', '==', currentCourseId)
                );
                const enrollmentsSnapshot = await window.firestore.getDocs(enrollmentsQuery);
                
                const enrolledStudentIds = [];
                const droppedStudentIds = [];
                const enrollmentStatuses = new Map();
                
                enrollmentsSnapshot.forEach(doc => {
                    const enrollment = doc.data();
                    enrollmentStatuses.set(enrollment.studentId, enrollment.status);
                    
                    if (enrollment.status === 'active') {
                        enrolledStudentIds.push(enrollment.studentId);
                    } else if (enrollment.status === 'dropped') {
                        droppedStudentIds.push(enrollment.studentId);
                    }
                });

                // Load class names for all students
                await loadStudentClassNames();

                // Get enrolled and dropped students
                const activeStudents = students.filter(s => enrolledStudentIds.includes(s.id));
                const droppedStudents = students.filter(s => droppedStudentIds.includes(s.id));
                
                // Mark dropped students and combine lists (active first, then dropped)
                droppedStudents.forEach(student => {
                    student.isDropped = true;
                    student.enrollmentStatus = 'dropped';
                });
                activeStudents.forEach(student => {
                    student.isDropped = false;
                    student.enrollmentStatus = 'active';
                });
                
                enrolledStudents = [...activeStudents, ...droppedStudents];
                availableStudents = students.filter(s => !enrolledStudentIds.includes(s.id) && !droppedStudentIds.includes(s.id));
                
                // Check data existence for all enrolled students (including dropped)
                await checkStudentDataExistence();
                
            } catch (error) {
                console.error('Error loading student enrollments:', error);
                showNotification('Failed to load student enrollments', 'error');
            }
        }

        async function checkStudentDataExistence() {
            try {
                for (const student of enrolledStudents) {
                    // Check attendance data
                    const attendanceQuery = window.firestore.query(
                        window.firestore.collection(window.db, 'attendance'),
                        window.firestore.where('courseId', '==', currentCourseId),
                        window.firestore.where('studentId', '==', student.id)
                    );
                    const attendanceSnapshot = await window.firestore.getDocs(attendanceQuery);
                    
                    // Check assessment data
                    const performanceQuery = window.firestore.query(
                        window.firestore.collection(window.db, 'performance'),
                        window.firestore.where('courseId', '==', currentCourseId),
                        window.firestore.where('studentId', '==', student.id)
                    );
                    const performanceSnapshot = await window.firestore.getDocs(performanceQuery);
                    
                    student.hasAttendanceData = !attendanceSnapshot.empty;
                    student.hasAssessmentData = !performanceSnapshot.empty;
                    student.hasAnyData = student.hasAttendanceData || student.hasAssessmentData;
                }
            } catch (error) {
                console.error('Error checking student data existence:', error);
                // Set default values if check fails
                enrolledStudents.forEach(student => {
                    student.hasAttendanceData = false;
                    student.hasAssessmentData = false;
                    student.hasAnyData = false;
                });
            }
        }

        function populateClassFilter() {
            const classFilter = document.getElementById('studentClassFilter');
            const classes = [...new Set(students.map(s => s.className).filter(c => c && c !== 'N/A'))].sort();
            
            classFilter.innerHTML = '<option value="">All Classes</option>';
            classes.forEach(className => {
                classFilter.innerHTML += `<option value="${className}">${className}</option>`;
            });
        }

        function renderStudentsTables() {
            renderAvailableStudents();
            renderEnrolledStudents();
            updateStudentCounts();
        }

        function renderAvailableStudents() {
            const tbody = document.getElementById('availableStudentsBody');
            const filteredStudents = filterStudents(availableStudents);
            
            tbody.innerHTML = filteredStudents.map(student => `
                <tr class="hover:bg-gray-50">
                    <td class="px-2 py-2">
                        <input type="checkbox" class="available-student-checkbox" value="${student.id}">
                    </td>
                    <td class="px-2 py-2 text-sm font-medium">${student.humanId || student.id}</td>
                    <td class="px-2 py-2 text-sm">${student.fullName || student.name || 'Unknown'}</td>
                    <td class="px-2 py-2 text-sm">${student.className || 'N/A'}</td>
                    <td class="px-2 py-2">
                        <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full ${getStatusBadgeClass(student.status)}">
                            ${student.status || 'active'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function renderEnrolledStudents() {
            const tbody = document.getElementById('enrolledStudentsBody');
            const filteredStudents = filterStudents(enrolledStudents);
            
            tbody.innerHTML = filteredStudents.map(student => {
                const hasData = student.hasAnyData;
                const dataTypes = [];
                if (student.hasAttendanceData) dataTypes.push('attendance');
                if (student.hasAssessmentData) dataTypes.push('grades');
                const dataTooltip = hasData ? `Has ${dataTypes.join(' and ')} data` : 'No data recorded';
                const isDropped = student.isDropped || student.enrollmentStatus === 'dropped';
                const rowClass = isDropped ? 'hover:bg-gray-50 opacity-60 bg-gray-50' : 'hover:bg-gray-50';
                const textClass = isDropped ? 'text-gray-500' : '';
                
                return `
                    <tr class="${rowClass}">
                        <td class="px-2 py-2 text-sm font-medium ${textClass}">${student.humanId || student.id}</td>
                        <td class="px-2 py-2 text-sm ${textClass}">
                            ${student.fullName || student.name || 'Unknown'}
                            ${isDropped ? '<span class="text-xs text-red-600 ml-2">(Dropped)</span>' : ''}
                        </td>
                        <td class="px-2 py-2 text-sm ${textClass}">${student.className || 'N/A'}</td>
                        <td class="px-2 py-2">
                            <div class="flex space-x-2">
                                ${isDropped ? `
                                    <button onclick="reEnrollStudent('${student.id}')" 
                                            class="text-green-600 hover:text-green-800 text-xs font-medium"
                                            title="Re-enroll this student">
                                        Re-enroll
                                    </button>
                                    <button onclick="permanentlyRemoveStudent('${student.id}')" 
                                            class="text-red-600 hover:text-red-800 text-xs font-medium"
                                            title="Permanently remove student and all data">
                                        Remove Permanently
                                    </button>
                                ` : hasData ? `
                                    <button onclick="dropStudent('${student.id}')" 
                                            class="text-orange-600 hover:text-orange-800 text-xs font-medium"
                                            title="${dataTooltip} - can only drop">
                                        Drop
                                    </button>
                                    <button class="text-gray-400 text-xs cursor-not-allowed" 
                                            title="Cannot remove - student has data"
                                            disabled>
                                        Remove
                                    </button>
                                ` : `
                                    <button onclick="unenrollStudent('${student.id}')" 
                                            class="text-red-600 hover:text-red-800 text-xs font-medium"
                                            title="${dataTooltip} - can be removed">
                                        Remove
                                    </button>
                                    <button class="text-gray-400 text-xs cursor-not-allowed" 
                                            title="No data to preserve"
                                            disabled>
                                        Drop
                                    </button>
                                `}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterStudents(studentList) {
            const searchTerm = document.getElementById('studentSearchInput').value.toLowerCase();
            const statusFilter = document.getElementById('studentStatusFilter').value;
            const classFilter = document.getElementById('studentClassFilter').value;
            
            return studentList.filter(student => {
                const matchesSearch = !searchTerm || 
                    (student.fullName || student.name || '').toLowerCase().includes(searchTerm) ||
                    (student.humanId || student.id).toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || student.status === statusFilter;
                const matchesClass = !classFilter || student.className === classFilter;
                
                return matchesSearch && matchesStatus && matchesClass;
            });
        }

        function getStatusBadgeClass(status) {
            switch (status) {
                case 'active': return 'bg-green-100 text-green-800';
                case 'inactive': return 'bg-gray-100 text-gray-800';
                case 'finished': return 'bg-blue-100 text-blue-800';
                case 'dropped': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function updateStudentCounts() {
            const availableFiltered = filterStudents(availableStudents);
            const enrolledFiltered = filterStudents(enrolledStudents);
            
            document.getElementById('availableCount').textContent = `(${availableFiltered.length})`;
            document.getElementById('enrolledCount').textContent = `(${enrolledFiltered.length})`;
            
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.available-student-checkbox:checked');
            document.getElementById('selectedStudentsCount').textContent = checkboxes.length;
        }

        function toggleAvailableStudents() {
            const container = document.getElementById('availableStudentsContainer');
            const icon = document.getElementById('availableCollapseIcon');
            const text = document.getElementById('availableCollapseText');
            
            availableCollapsed = !availableCollapsed;
            
            if (availableCollapsed) {
                container.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
                text.textContent = 'Expand';
            } else {
                container.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
                text.textContent = 'Collapse';
            }
        }

        function toggleEnrolledStudents() {
            const container = document.getElementById('enrolledStudentsContainer');
            const icon = document.getElementById('enrolledCollapseIcon');
            const text = document.getElementById('enrolledCollapseText');
            
            enrolledCollapsed = !enrolledCollapsed;
            
            if (enrolledCollapsed) {
                container.style.display = 'none';
                icon.style.transform = 'rotate(-90deg)';
                text.textContent = 'Expand';
            } else {
                container.style.display = 'block';
                icon.style.transform = 'rotate(0deg)';
                text.textContent = 'Collapse';
            }
        }

        async function unenrollStudent(studentId) {
            if (confirm('Are you sure you want to completely remove this student from the course?')) {
                await removeStudentCompletely(studentId);
            }
        }

        async function dropStudent(studentId) {
            if (confirm('Are you sure you want to drop this student from the course? Their data will be preserved.')) {
                await dropStudentFromCourse(studentId);
            }
        }

        async function removeStudentCompletely(studentId) {
            try {
                const enrollmentId = `ENROLL_${currentCourseId}_${studentId}`;
                const enrollmentRef = window.firestore.doc(window.db, 'enrollments', enrollmentId);
                
                await window.firestore.deleteDoc(enrollmentRef);
                
                // Update course student count
                const course = courses.find(c => c.id === currentCourseId);
                if (course && course.studentCount > 0) {
                    await updateCourse(currentCourseId, { 
                        studentCount: course.studentCount - 1 
                    });
                }
                
                showNotification('Student completely removed from course', 'success');
                await loadStudentEnrollments();
                renderStudentsTables();
                
            } catch (error) {
                console.error('Error removing student from course:', error);
                showNotification('Failed to remove student from course', 'error');
            }
        }

        async function dropStudentFromCourse(studentId) {
            try {
                const enrollmentId = `ENROLL_${currentCourseId}_${studentId}`;
                const enrollmentRef = window.firestore.doc(window.db, 'enrollments', enrollmentId);
                
                // Update enrollment status to 'dropped' instead of deleting
                await window.firestore.updateDoc(enrollmentRef, {
                    status: 'dropped',
                    droppedAt: new Date(),
                    updatedAt: new Date()
                });
                
                // Update course student count (dropped students don't count as active)
                const course = courses.find(c => c.id === currentCourseId);
                if (course && course.studentCount > 0) {
                    await updateCourse(currentCourseId, { 
                        studentCount: course.studentCount - 1 
                    });
                }
                
                showNotification('Student dropped from course (data preserved)', 'success');
                await loadStudentEnrollments();
                renderStudentsTables();
                
            } catch (error) {
                console.error('Error dropping student from course:', error);
                showNotification('Failed to drop student from course', 'error');
            }
        }

        async function reEnrollStudent(studentId) {
            if (confirm('Are you sure you want to re-enroll this student? They will be moved back to active status.')) {
                try {
                    const enrollmentId = `ENROLL_${currentCourseId}_${studentId}`;
                    const enrollmentRef = window.firestore.doc(window.db, 'enrollments', enrollmentId);
                    
                    // Update enrollment status back to 'active'
                    await window.firestore.updateDoc(enrollmentRef, {
                        status: 'active',
                        reEnrolledAt: new Date(),
                        updatedAt: new Date()
                    });
                    
                    // Update course student count
                    const course = courses.find(c => c.id === currentCourseId);
                    if (course) {
                        await updateCourse(currentCourseId, { 
                            studentCount: (course.studentCount || 0) + 1 
                        });
                    }
                    
                    showNotification('Student re-enrolled successfully', 'success');
                    await loadStudentEnrollments();
                    renderStudentsTables();
                    
                } catch (error) {
                    console.error('Error re-enrolling student:', error);
                    showNotification('Failed to re-enroll student', 'error');
                }
            }
        }

        async function permanentlyRemoveStudent(studentId) {
            if (confirm('Are you sure you want to permanently remove this student? This will delete ALL their data including attendance and grades. This action cannot be undone.')) {
                try {
                    // Delete enrollment
                    const enrollmentId = `ENROLL_${currentCourseId}_${studentId}`;
                    const enrollmentRef = window.firestore.doc(window.db, 'enrollments', enrollmentId);
                    await window.firestore.deleteDoc(enrollmentRef);
                    
                    // Delete all attendance records
                    const attendanceQuery = window.firestore.query(
                        window.firestore.collection(window.db, 'attendance'),
                        window.firestore.where('courseId', '==', currentCourseId),
                        window.firestore.where('studentId', '==', studentId)
                    );
                    const attendanceSnapshot = await window.firestore.getDocs(attendanceQuery);
                    const attendanceDeletePromises = [];
                    attendanceSnapshot.forEach(doc => {
                        attendanceDeletePromises.push(window.firestore.deleteDoc(doc.ref));
                    });
                    
                    // Delete all performance records
                    const performanceQuery = window.firestore.query(
                        window.firestore.collection(window.db, 'performance'),
                        window.firestore.where('courseId', '==', currentCourseId),
                        window.firestore.where('studentId', '==', studentId)
                    );
                    const performanceSnapshot = await window.firestore.getDocs(performanceQuery);
                    const performanceDeletePromises = [];
                    performanceSnapshot.forEach(doc => {
                        performanceDeletePromises.push(window.firestore.deleteDoc(doc.ref));
                    });
                    
                    // Execute all deletions
                    await Promise.all([...attendanceDeletePromises, ...performanceDeletePromises]);
                    
                    showNotification('Student permanently removed with all data', 'success');
                    await loadStudentEnrollments();
                    renderStudentsTables();
                    
                } catch (error) {
                    console.error('Error permanently removing student:', error);
                    showNotification('Failed to permanently remove student', 'error');
                }
            }
        }

        async function enrollSelectedStudents() {
            const checkboxes = document.querySelectorAll('.available-student-checkbox:checked');
            const selectedStudentIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedStudentIds.length === 0) {
                showNotification('Please select students to enroll', 'error');
                return;
            }
            
            try {
                for (const studentId of selectedStudentIds) {
                    const enrollmentId = `ENROLL_${currentCourseId}_${studentId}`;
                    const docRef = window.firestore.doc(window.db, 'enrollments', enrollmentId);
                    
                    await window.firestore.setDoc(docRef, {
                        courseId: currentCourseId,
                        studentId: studentId,
                        status: 'active',
                        enrolledAt: new Date(),
                        createdAt: new Date()
                    });
                }
                
                // Update course student count
                const course = courses.find(c => c.id === currentCourseId);
                if (course) {
                    await updateCourse(currentCourseId, { 
                        studentCount: (course.studentCount || 0) + selectedStudentIds.length 
                    });
                }
                
                showNotification(`Successfully enrolled ${selectedStudentIds.length} student(s)`, 'success');
                
                // Refresh the student lists
                await loadStudentEnrollments();
                renderStudentsTables();
                
            } catch (error) {
                console.error('Error enrolling students:', error);
                showNotification('Failed to enroll students', 'error');
            }
        }

        function addNewStudent() {
            // Placeholder for add student functionality
            showNotification('Add student functionality coming soon', 'info');
        }

        function editStudent(studentId) {
            // Placeholder for edit student functionality
            showNotification('Edit student functionality coming soon', 'info');
        }

        function deleteStudent(studentId) {
            // Placeholder for delete student functionality
            showNotification('Delete student functionality coming soon', 'info');
        }

        // Attendance Management Functions
        function openAttendanceModal(courseId) {
            currentCourseId = courseId;
            const course = courses.find(c => c.id === courseId);
            if (course) {
                document.querySelector('#attendanceModal h2').textContent = 'Manage Attendance';
                document.querySelector('#attendanceModal .course-info').innerHTML = `
                    <div class="text-lg font-medium text-gray-800">${course.code}: ${course.name}</div>
                `;
            }
            document.getElementById('attendanceModal').classList.add('show');
            loadAttendanceForCourse(courseId);
        }

        function closeAttendanceModal() {
            document.getElementById('attendanceModal').classList.remove('show');
        }

        async function loadAttendanceForCourse(courseId) {
            try {
                const course = courses.find(c => c.id === courseId);
                if (!course) return;

                // Load attendance dates
                const datesQuery = window.firestore.query(
                    window.firestore.collection(window.db, 'attendanceDates'),
                    window.firestore.where('courseId', '==', courseId)
                );
                const datesSnapshot = await window.firestore.getDocs(datesQuery);
                
                attendanceDates = [];
                datesSnapshot.forEach(doc => {
                    attendanceDates.push({ id: doc.id, ...doc.data() });
                });
                attendanceDates.sort((a, b) => new Date(a.date) - new Date(b.date));

                // Load all enrolled students (active and dropped)
                const enrollmentsQuery = window.firestore.query(
                    window.firestore.collection(window.db, 'enrollments'),
                    window.firestore.where('courseId', '==', courseId)
                );
                const enrollmentsSnapshot = await window.firestore.getDocs(enrollmentsQuery);
                
                const enrolledStudentIds = [];
                const droppedStudentIds = [];
                enrollmentsSnapshot.forEach(doc => {
                    const enrollment = doc.data();
                    if (enrollment.status === 'active') {
                        enrolledStudentIds.push(enrollment.studentId);
                    } else if (enrollment.status === 'dropped') {
                        droppedStudentIds.push(enrollment.studentId);
                    }
                });

                // Get active and dropped students, mark dropped ones
                const activeStudents = students.filter(s => enrolledStudentIds.includes(s.id));
                const droppedStudents = students.filter(s => droppedStudentIds.includes(s.id));
                
                droppedStudents.forEach(student => {
                    student.isDropped = true;
                    student.enrollmentStatus = 'dropped';
                });
                activeStudents.forEach(student => {
                    student.isDropped = false;
                    student.enrollmentStatus = 'active';
                });

                // Sort students based on selected option (default to ID)
                const sortBy = document.getElementById('attendanceStudentSort')?.value || 'id';
                if (sortBy === 'name') {
                    activeStudents.sort((a, b) => a.fullName.localeCompare(b.fullName));
                    droppedStudents.sort((a, b) => a.fullName.localeCompare(b.fullName));
                } else if (sortBy === 'id') {
                    activeStudents.sort((a, b) => a.humanId.localeCompare(b.humanId));
                    droppedStudents.sort((a, b) => a.humanId.localeCompare(b.humanId));
                }
                const courseStudents = [...activeStudents, ...droppedStudents];

                // Load attendance records
                const attendanceQuery = window.firestore.query(
                    window.firestore.collection(window.db, 'attendance'),
                    window.firestore.where('courseId', '==', courseId)
                );
                const attendanceSnapshot = await window.firestore.getDocs(attendanceQuery);
                
                currentAttendanceRecords.clear();
                attendanceSnapshot.forEach(doc => {
                    const record = doc.data();
                    const key = `${record.studentId}-${record.dateId}`;
                    currentAttendanceRecords.set(key, {
                        status: record.status,
                        notes: record.notes || ''
                    });
                });

                renderAttendanceTable(courseStudents);
            } catch (error) {
                console.error('Error loading attendance:', error);
                showNotification('Failed to load attendance data', 'error');
            }
        }

        function renderAttendanceTable(courseStudents) {
            const tableHead = document.getElementById('attendanceTableHead');
            const tableBody = document.getElementById('attendanceTableBody');

            if (courseStudents.length === 0) {
                tableHead.innerHTML = '<tr><th class="px-4 py-2 text-center">No students enrolled</th></tr>';
                tableBody.innerHTML = '';
                return;
            }

            // Build header
            let headerHTML = `
                <tr>
                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 sticky left-0 bg-gray-50 z-20 border-r border-gray-300" style="min-width: 100px;">Student ID</th>
                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 sticky bg-gray-50 z-20 border-r border-gray-300" style="left: 100px; min-width: 150px;">Student Name</th>
            `;
            
            attendanceDates.forEach(dateRecord => {
                const date = new Date(dateRecord.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const dayOfWeek = new Date(dateRecord.date).toLocaleDateString('en-US', { weekday: 'short' });
                
                // Calculate attendance summary
                const summary = calculateAttendanceSummary(dateRecord.id);
                
                headerHTML += `
                    <th class="px-1 py-1 text-center text-xs font-medium text-gray-500" style="min-width: 100px;">
                        <div class="cursor-pointer" onclick="openDateAttendanceModal('${dateRecord.id}')" title="Click to manage attendance">
                            <div class="font-semibold text-xs">${date}</div>
                            <div class="text-xs text-gray-400">${dayOfWeek}</div>
                            <div class="text-xs text-gray-400">${dateRecord.lessonName}</div>
                            <div class="text-xs text-gray-400">${dateRecord.teacher}</div>
                            <div class="text-xs mt-1 flex justify-center space-x-2">
                                <span class="text-green-600">${summary.present}P</span>
                                <span class="text-red-600">${summary.absent}A</span>
                                <span class="text-blue-600 font-medium">${summary.rate}%</span>
                            </div>
                            <div class="flex justify-center space-x-1 mt-1">
                                <button onclick="event.stopPropagation(); editAttendanceDate('${dateRecord.id}')" class="text-blue-600 hover:text-blue-800" title="Edit">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button onclick="event.stopPropagation(); deleteAttendanceDate('${dateRecord.id}')" class="text-red-600 hover:text-red-800" title="Delete">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </th>
                `;
            });
            
            headerHTML += '</tr>';
            tableHead.innerHTML = headerHTML;

            // Build body
            let bodyHTML = '';
            courseStudents.forEach(student => {
                const isDropped = student.isDropped || student.enrollmentStatus === 'dropped';
                const rowClass = isDropped ? 'hover:bg-gray-50 opacity-60 bg-gray-50' : 'hover:bg-gray-50';
                const textClass = isDropped ? 'text-gray-500' : '';
                const bgClass = isDropped ? 'bg-gray-50' : 'bg-white';
                
                bodyHTML += `
                    <tr class="${rowClass}">
                        <td class="px-2 py-2 text-xs sticky left-0 ${bgClass} font-medium ${textClass} z-10 border-r border-gray-300" style="min-width: 100px;">
                            ${student.humanId}
                        </td>
                        <td class="px-2 py-2 text-xs sticky ${bgClass} ${textClass} z-10 border-r border-gray-300" style="left: 100px; min-width: 150px;">
                            ${student.fullName}
                            ${isDropped ? '<span class="text-xs text-red-600 ml-2">(Dropped)</span>' : ''}
                        </td>
                `;
                
                attendanceDates.forEach(dateRecord => {
                    const key = `${student.id}-${dateRecord.id}`;
                    const record = currentAttendanceRecords.get(key);
                    const status = record ? record.status : 'no-record';
                    const hasNotes = record && record.notes && record.notes.trim() !== '';
                    
                    let cellClass = status === 'present' ? 'bg-green-100 text-green-800' :
                                   status === 'absent' ? 'bg-red-100 text-red-800' : 'bg-gray-100';
                    
                    // Gray out dropped students' attendance cells
                    if (isDropped) {
                        cellClass = 'bg-gray-200 text-gray-500';
                    }
                    
                    const statusText = status === 'present' ? 'P' : status === 'absent' ? 'A' : '-';
                    const clickHandler = isDropped ? '' : `onclick="openStudentAttendanceModal('${student.id}', '${dateRecord.id}', '${status}')"`;
                    const cursorClass = isDropped ? 'cursor-not-allowed' : 'cursor-pointer hover:bg-gray-200';
                    const title = isDropped ? 'Student is dropped - attendance cannot be edited' : 
                                (hasNotes ? 'Has notes: ' + record.notes : 'Click to edit attendance');
                    
                    bodyHTML += `
                        <td class="px-1 py-1 text-center ${cursorClass} ${cellClass} relative" 
                            ${clickHandler}
                            title="${title}">
                            <div class="flex items-center justify-center space-x-1">
                                <span class="text-sm font-bold">${statusText}</span>
                                ${hasNotes && !isDropped ? '<svg class="w-3 h-3 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>' : ''}
                            </div>
                        </td>
                    `;
                });
                
                bodyHTML += '</tr>';
            });
            
            tableBody.innerHTML = bodyHTML;
        }

        function calculateAttendanceSummary(dateId) {
            let present = 0;
            let absent = 0;
            let total = 0;
            
            for (const [key, record] of currentAttendanceRecords.entries()) {
                if (key.endsWith(`-${dateId}`)) {
                    total++;
                    if (record.status === 'present') present++;
                    else if (record.status === 'absent') absent++;
                }
            }
            
            const rate = total > 0 ? Math.round((present / total) * 100) : 0;
            return { present, absent, total, rate };
        }

        async function addAttendanceDate() {
            const modal = document.getElementById('attendanceModal');
            const inputs = modal.querySelectorAll('input');
            const [dateInput, teacherInput, lessonInput] = inputs;
            
            const date = dateInput.value;
            const teacher = teacherInput.value.trim();
            const lessonName = lessonInput.value.trim();
            
            if (!date || !teacher || !lessonName) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            try {
                const dateId = `ATTDATE_${currentCourseId}_${date.replace(/-/g, '')}`;
                const docRef = window.firestore.doc(window.db, 'attendanceDates', dateId);
                
                await window.firestore.setDoc(docRef, {
                    courseId: currentCourseId,
                    date: date,
                    teacher: teacher,
                    lessonName: lessonName,
                    createdAt: new Date()
                });
                
                // Update course session count
                const course = courses.find(c => c.id === currentCourseId);
                if (course) {
                    await updateCourse(currentCourseId, { 
                        sessionCount: (course.sessionCount || 0) + 1 
                    });
                }
                
                // Clear form
                dateInput.value = '';
                teacherInput.value = '';
                lessonInput.value = '';
                
                showNotification('Session added successfully', 'success');
                loadAttendanceForCourse(currentCourseId);
            } catch (error) {
                console.error('Error adding attendance date:', error);
                showNotification('Failed to add session', 'error');
            }
        }

        // Student Attendance Modal Functions
        let currentStudentId = null;
        let currentDateId = null;

        async function openStudentAttendanceModal(studentId, dateId, currentStatus) {
            currentStudentId = studentId;
            currentDateId = dateId;
            
            const student = students.find(s => s.id === studentId);
            const dateRecord = attendanceDates.find(d => d.id === dateId);
            
            if (!student || !dateRecord) {
                showNotification('Student or date information not found', 'error');
                return;
            }
            
            document.getElementById('studentAttendanceName').textContent = student.fullName;
            document.getElementById('studentAttendanceId').textContent = student.humanId;
            document.getElementById('studentAttendanceDate').textContent = new Date(dateRecord.date).toLocaleDateString();
            document.getElementById('studentAttendanceTeacher').textContent = dateRecord.teacher;
            document.getElementById('studentAttendanceLesson').textContent = dateRecord.lessonName;
            
            const statusRadio = document.querySelector(`input[name="attendanceStatus"][value="${currentStatus}"]`);
            if (statusRadio) {
                statusRadio.checked = true;
            }
            
            // Load existing notes
            const key = `${studentId}-${dateId}`;
            const record = currentAttendanceRecords.get(key);
            const existingNotes = record && record.notes ? record.notes : '';
            document.getElementById('attendanceNotes').value = existingNotes;
            
            document.getElementById('studentAttendanceModal').classList.add('show');
        }

        function closeStudentAttendanceModal() {
            document.getElementById('studentAttendanceModal').classList.remove('show');
            document.getElementById('attendanceNotes').value = '';
            document.querySelectorAll('input[name="attendanceStatus"]').forEach(radio => radio.checked = false);
            currentStudentId = null;
            currentDateId = null;
        }

        async function saveStudentAttendance() {
            const selectedStatus = document.querySelector('input[name="attendanceStatus"]:checked');
            const notes = document.getElementById('attendanceNotes').value.trim();
            
            if (!selectedStatus) {
                showNotification('Please select an attendance status', 'error');
                return;
            }
            
            try {
                const attendanceRecordId = `ATT_${currentCourseId}_${currentStudentId}_${currentDateId}`;
                const docRef = window.firestore.doc(window.db, 'attendance', attendanceRecordId);
                
                if (selectedStatus.value === 'no-record') {
                    const existingDoc = await window.firestore.getDoc(docRef);
                    if (existingDoc.exists()) {
                        await window.firestore.deleteDoc(docRef);
                    }
                    currentAttendanceRecords.delete(`${currentStudentId}-${currentDateId}`);
                } else {
                    const recordData = {
                        courseId: currentCourseId,
                        studentId: currentStudentId,
                        dateId: currentDateId,
                        status: selectedStatus.value,
                        notes: notes,
                        updatedAt: new Date()
                    };
                    
                    const existingDoc = await window.firestore.getDoc(docRef);
                    if (!existingDoc.exists()) {
                        recordData.createdAt = new Date();
                        await window.firestore.setDoc(docRef, recordData);
                    } else {
                        await window.firestore.updateDoc(docRef, recordData);
                    }
                    
                    currentAttendanceRecords.set(`${currentStudentId}-${currentDateId}`, {
                        status: selectedStatus.value,
                        notes: notes
                    });
                }
                
                showNotification('Attendance updated successfully', 'success');
                closeStudentAttendanceModal();
                loadAttendanceForCourse(currentCourseId);
                
            } catch (error) {
                console.error('Error saving attendance:', error);
                showNotification('Failed to save attendance', 'error');
            }
        }

        // Date Attendance Modal Functions
        let currentDateRecord = null;
        let currentCourseStudents = [];

        async function openDateAttendanceModal(dateId) {
            currentDateId = dateId;
            
            const dateRecord = attendanceDates.find(d => d.id === dateId);
            if (!dateRecord) {
                showNotification('Date information not found', 'error');
                return;
            }
            
            currentDateRecord = dateRecord;
            
            const dateObj = new Date(dateRecord.date);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('dateAttendanceInfo').innerHTML = `
                <div><span class="font-medium">Date:</span> ${formattedDate}</div>
                <div><span class="font-medium">Teacher:</span> ${dateRecord.teacher}</div>
                <div><span class="font-medium">Lesson:</span> ${dateRecord.lessonName}</div>
            `;
            
            await loadDateAttendanceStudents(dateId);
            document.getElementById('dateAttendanceModal').classList.add('show');
        }

        function closeDateAttendanceModal() {
            document.getElementById('dateAttendanceModal').classList.remove('show');
            currentDateId = null;
            currentDateRecord = null;
        }

        async function loadDateAttendanceStudents(dateId) {
            try {
                const enrollmentsRef = window.firestore.collection(window.db, 'enrollments');
                const enrollmentQuery = window.firestore.query(enrollmentsRef, window.firestore.where('courseId', '==', currentCourseId));
                const enrollmentSnapshot = await window.firestore.getDocs(enrollmentQuery);
                
                const enrolledStudentIds = [];
                const droppedStudentIds = [];
                enrollmentSnapshot.forEach((doc) => {
                    const enrollment = doc.data();
                    if (enrollment.status === 'active') {
                        enrolledStudentIds.push(enrollment.studentId);
                    } else if (enrollment.status === 'dropped') {
                        droppedStudentIds.push(enrollment.studentId);
                    }
                });
                
                // Get active and dropped students, mark dropped ones
                const activeStudents = students.filter(s => enrolledStudentIds.includes(s.id));
                const droppedStudents = students.filter(s => droppedStudentIds.includes(s.id));
                
                droppedStudents.forEach(student => {
                    student.isDropped = true;
                    student.enrollmentStatus = 'dropped';
                });
                activeStudents.forEach(student => {
                    student.isDropped = false;
                    student.enrollmentStatus = 'active';
                });

                // Sort students based on selected option
                const sortBy = document.getElementById('attendanceStudentSort')?.value || 'id';
                if (sortBy === 'name') {
                    activeStudents.sort((a, b) => a.fullName.localeCompare(b.fullName));
                    droppedStudents.sort((a, b) => a.fullName.localeCompare(b.fullName));
                } else if (sortBy === 'id') {
                    activeStudents.sort((a, b) => a.humanId.localeCompare(b.humanId));
                    droppedStudents.sort((a, b) => a.humanId.localeCompare(b.humanId));
                }
                currentCourseStudents = [...activeStudents, ...droppedStudents];
                
                renderDateAttendanceStudents();
                
            } catch (error) {
                console.error('Error loading date attendance students:', error);
                showNotification('Failed to load student attendance data', 'error');
            }
        }

        function renderDateAttendanceStudents() {
            const tbody = document.getElementById('dateAttendanceStudentsList');
            
            tbody.innerHTML = currentCourseStudents.map(student => {
                const key = `${student.id}-${currentDateId}`;
                const record = currentAttendanceRecords.get(key);
                const status = record ? record.status : 'no-record';
                const notes = record ? record.notes || '' : '';
                const isDropped = student.isDropped || student.enrollmentStatus === 'dropped';
                const rowClass = isDropped ? 'hover:bg-gray-50 opacity-60 bg-gray-50' : 'hover:bg-gray-50';
                const textClass = isDropped ? 'text-gray-500' : '';
                
                return `
                    <tr class="${rowClass}">
                        <td class="px-4 py-3">
                            <div class="text-sm font-medium ${isDropped ? 'text-gray-500' : 'text-gray-900'}">${student.fullName}</div>
                            <div class="text-xs ${isDropped ? 'text-gray-400' : 'text-gray-500'}">${student.humanId}</div>
                            ${isDropped ? '<div class="text-xs text-red-600">(Dropped)</div>' : ''}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <select class="px-2 py-1 text-sm border border-gray-300 rounded ${isDropped ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : ''}" 
                                    ${isDropped ? 'disabled' : `onchange="updateStudentAttendanceStatus('${student.id}', this.value)"`}>
                                <option value="no-record" ${status === 'no-record' ? 'selected' : ''}>No Record</option>
                                <option value="present" ${status === 'present' ? 'selected' : ''}>Present</option>
                                <option value="absent" ${status === 'absent' ? 'selected' : ''}>Absent</option>
                            </select>
                        </td>
                        <td class="px-4 py-3">
                            <textarea class="w-full px-2 py-1 text-sm border border-gray-300 rounded resize-none ${isDropped ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : ''}" 
                                      rows="2" 
                                      placeholder="${isDropped ? 'Student is dropped' : 'Add notes...'}"
                                      ${isDropped ? 'disabled readonly' : `onchange="updateStudentAttendanceNotes('${student.id}', this.value)"`}>${notes}</textarea>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function updateStudentAttendanceStatus(studentId, status) {
            try {
                const attendanceRecordId = `ATT_${currentCourseId}_${studentId}_${currentDateId}`;
                const docRef = window.firestore.doc(window.db, 'attendance', attendanceRecordId);
                
                if (status === 'no-record') {
                    const existingDoc = await window.firestore.getDoc(docRef);
                    if (existingDoc.exists()) {
                        await window.firestore.deleteDoc(docRef);
                    }
                    currentAttendanceRecords.delete(`${studentId}-${currentDateId}`);
                } else {
                    const key = `${studentId}-${currentDateId}`;
                    const existingRecord = currentAttendanceRecords.get(key);
                    const existingNotes = existingRecord ? existingRecord.notes || '' : '';
                    
                    const attendanceData = {
                        courseId: currentCourseId,
                        studentId: studentId,
                        dateId: currentDateId,
                        status: status,
                        notes: existingNotes,
                        updatedAt: new Date()
                    };
                    
                    const existingDoc = await window.firestore.getDoc(docRef);
                    if (!existingDoc.exists()) {
                        attendanceData.createdAt = new Date();
                        await window.firestore.setDoc(docRef, attendanceData);
                    } else {
                        await window.firestore.updateDoc(docRef, attendanceData);
                    }
                    
                    currentAttendanceRecords.set(key, {
                        status: status,
                        notes: existingNotes
                    });
                }
                
                // Refresh the main attendance table in the background
                await loadAttendanceForCourse(currentCourseId);
                
            } catch (error) {
                console.error('Error updating attendance status:', error);
                showNotification('Failed to update attendance status', 'error');
            }
        }

        async function updateStudentAttendanceNotes(studentId, notes) {
            try {
                const key = `${studentId}-${currentDateId}`;
                const existingRecord = currentAttendanceRecords.get(key);
                const currentStatus = existingRecord ? existingRecord.status : 'no-record';
                
                if (currentStatus === 'no-record' && notes.trim() === '') {
                    return; // No need to save empty notes for no-record status
                }
                
                const attendanceRecordId = `ATT_${currentCourseId}_${studentId}_${currentDateId}`;
                const docRef = window.firestore.doc(window.db, 'attendance', attendanceRecordId);
                
                const attendanceData = {
                    courseId: currentCourseId,
                    studentId: studentId,
                    dateId: currentDateId,
                    status: currentStatus === 'no-record' ? 'present' : currentStatus, // Default to present if adding notes
                    notes: notes.trim(),
                    updatedAt: new Date()
                };
                
                const existingDoc = await window.firestore.getDoc(docRef);
                if (!existingDoc.exists()) {
                    attendanceData.createdAt = new Date();
                    await window.firestore.setDoc(docRef, attendanceData);
                } else {
                    await window.firestore.updateDoc(docRef, attendanceData);
                }
                
                currentAttendanceRecords.set(key, {
                    status: attendanceData.status,
                    notes: notes.trim()
                });
                
                // If we changed from no-record to present, update the dropdown
                if (currentStatus === 'no-record' && notes.trim() !== '') {
                    renderDateAttendanceStudents();
                }
                
            } catch (error) {
                console.error('Error updating attendance notes:', error);
                showNotification('Failed to update attendance notes', 'error');
            }
        }

        async function markAllPresentForDate() {
            if (!confirm('Mark all students as Present for this date?')) return;
            
            try {
                for (const student of currentCourseStudents) {
                    const attendanceRecordId = `ATT_${currentCourseId}_${student.id}_${currentDateId}`;
                    const docRef = window.firestore.doc(window.db, 'attendance', attendanceRecordId);
                    
                    const attendanceData = {
                        courseId: currentCourseId,
                        studentId: student.id,
                        dateId: currentDateId,
                        status: 'present',
                        updatedAt: new Date()
                    };
                    
                    const existingDoc = await window.firestore.getDoc(docRef);
                    if (!existingDoc.exists()) {
                        attendanceData.createdAt = new Date();
                        await window.firestore.setDoc(docRef, attendanceData);
                    } else {
                        await window.firestore.updateDoc(docRef, attendanceData);
                    }
                    
                    currentAttendanceRecords.set(`${student.id}-${currentDateId}`, {
                        status: 'present',
                        notes: ''
                    });
                }
                
                showNotification('All students marked as present successfully', 'success');
                
                // Update the date attendance modal interface immediately
                renderDateAttendanceStudents();
                
                // Also refresh the main attendance table in the background
                await loadAttendanceForCourse(currentCourseId);
                
            } catch (error) {
                console.error('Error marking all students present:', error);
                showNotification('Failed to mark all students present', 'error');
            }
        }

        async function clearAllForDate() {
            if (!confirm('Clear all attendance records for this date?')) return;
            
            try {
                for (const student of currentCourseStudents) {
                    const attendanceRecordId = `ATT_${currentCourseId}_${student.id}_${currentDateId}`;
                    const docRef = window.firestore.doc(window.db, 'attendance', attendanceRecordId);
                    
                    const existingDoc = await window.firestore.getDoc(docRef);
                    if (existingDoc.exists()) {
                        await window.firestore.deleteDoc(docRef);
                    }
                    
                    currentAttendanceRecords.delete(`${student.id}-${currentDateId}`);
                }
                
                showNotification('All attendance records cleared successfully', 'success');
                
                // Update the date attendance modal interface immediately
                renderDateAttendanceStudents();
                
                // Also refresh the main attendance table in the background
                await loadAttendanceForCourse(currentCourseId);
                
            } catch (error) {
                console.error('Error clearing attendance records:', error);
                showNotification('Failed to clear attendance records', 'error');
            }
        }

        function saveDateAttendance() {
            showNotification('All changes are saved automatically', 'success');
            closeDateAttendanceModal();
        }

        // Edit Attendance Date Functions
        let editingDateId = null;

        async function editAttendanceDate(dateId) {
            editingDateId = dateId;
            const dateRecord = attendanceDates.find(d => d.id === dateId);
            
            if (!dateRecord) {
                showNotification('Date record not found', 'error');
                return;
            }
            
            document.getElementById('editAttendanceDate').value = dateRecord.date;
            document.getElementById('editAttendanceTeacher').value = dateRecord.teacher;
            document.getElementById('editAttendanceLesson').value = dateRecord.lessonName;
            
            document.getElementById('editAttendanceDateModal').classList.add('show');
        }

        function closeEditAttendanceDateModal() {
            document.getElementById('editAttendanceDateModal').classList.remove('show');
            editingDateId = null;
        }

        async function deleteAttendanceDate(dateId) {
            if (!confirm('Are you sure you want to delete this attendance date? This will also delete all attendance records for this date.')) return;
            
            try {
                const dateRef = window.firestore.doc(window.db, 'attendanceDates', dateId);
                await window.firestore.deleteDoc(dateRef);
                
                const attendanceQuery = window.firestore.query(
                    window.firestore.collection(window.db, 'attendance'),
                    window.firestore.where('courseId', '==', currentCourseId),
                    window.firestore.where('dateId', '==', dateId)
                );
                const attendanceSnapshot = await window.firestore.getDocs(attendanceQuery);
                
                const deletePromises = [];
                attendanceSnapshot.forEach((doc) => {
                    deletePromises.push(window.firestore.deleteDoc(doc.ref));
                });
                
                await Promise.all(deletePromises);
                
                const course = courses.find(c => c.id === currentCourseId);
                if (course && course.sessionCount > 0) {
                    await updateCourse(currentCourseId, { 
                        sessionCount: course.sessionCount - 1 
                    });
                }
                
                showNotification('Attendance date deleted successfully', 'success');
                loadAttendanceForCourse(currentCourseId);
                
            } catch (error) {
                console.error('Error deleting attendance date:', error);
                showNotification('Failed to delete attendance date', 'error');
            }
        }

        // Performance Management Functions
        function openPerformanceModal(courseId) {
            currentCourseId = courseId;
            document.getElementById('performanceModal').classList.add('show');
            loadPerformanceForCourse(courseId);
        }

        function closePerformanceModal() {
            document.getElementById('performanceModal').classList.remove('show');
        }

        async function loadPerformanceForCourse(courseId) {
            try {
                const course = courses.find(c => c.id === courseId);
                if (!course) return;

                // Load assessments
                const assessmentsQuery = window.firestore.query(
                    window.firestore.collection(window.db, 'assessments'),
                    window.firestore.where('courseId', '==', courseId)
                );
                const assessmentsSnapshot = await window.firestore.getDocs(assessmentsQuery);
                
                currentAssessments = [];
                assessmentsSnapshot.forEach(doc => {
                    currentAssessments.push({ id: doc.id, ...doc.data() });
                });
                currentAssessments.sort((a, b) => new Date(a.date) - new Date(b.date));

                // Load all enrolled students (active and dropped)
                const enrollmentsQuery = window.firestore.query(
                    window.firestore.collection(window.db, 'enrollments'),
                    window.firestore.where('courseId', '==', courseId)
                );
                const enrollmentsSnapshot = await window.firestore.getDocs(enrollmentsQuery);
                
                const enrolledStudentIds = [];
                const droppedStudentIds = [];
                enrollmentsSnapshot.forEach(doc => {
                    const enrollment = doc.data();
                    if (enrollment.status === 'active') {
                        enrolledStudentIds.push(enrollment.studentId);
                    } else if (enrollment.status === 'dropped') {
                        droppedStudentIds.push(enrollment.studentId);
                    }
                });

                // Get active and dropped students, mark dropped ones
                const activeStudents = students.filter(s => enrolledStudentIds.includes(s.id));
                const droppedStudents = students.filter(s => droppedStudentIds.includes(s.id));
                
                droppedStudents.forEach(student => {
                    student.isDropped = true;
                    student.enrollmentStatus = 'dropped';
                });
                activeStudents.forEach(student => {
                    student.isDropped = false;
                    student.enrollmentStatus = 'active';
                });

                // Sort students based on selected option
                const sortBy = document.getElementById('performanceStudentSort')?.value || 'id';
                if (sortBy === 'name') {
                    activeStudents.sort((a, b) => a.fullName.localeCompare(b.fullName));
                    droppedStudents.sort((a, b) => a.fullName.localeCompare(b.fullName));
                } else if (sortBy === 'id') {
                    activeStudents.sort((a, b) => a.humanId.localeCompare(b.humanId));
                    droppedStudents.sort((a, b) => a.humanId.localeCompare(b.humanId));
                }
                const courseStudents = [...activeStudents, ...droppedStudents];

                // Load performance records
                const performanceQuery = window.firestore.query(
                    window.firestore.collection(window.db, 'performance'),
                    window.firestore.where('courseId', '==', courseId)
                );
                const performanceSnapshot = await window.firestore.getDocs(performanceQuery);
                
                currentPerformanceRecords.clear();
                performanceSnapshot.forEach(doc => {
                    const record = doc.data();
                    const key = `${record.studentId}-${record.assessmentId}`;
                    currentPerformanceRecords.set(key, record);
                });

                renderPerformanceTable(courseStudents);
            } catch (error) {
                console.error('Error loading performance:', error);
                showNotification('Failed to load performance data', 'error');
            }
        }

        function renderPerformanceTable(courseStudents) {
            const tableHead = document.getElementById('performanceTableHead');
            const tableBody = document.getElementById('performanceTableBody');

            if (courseStudents.length === 0) {
                tableHead.innerHTML = '<tr><th class="px-4 py-2 text-center">No students enrolled</th></tr>';
                tableBody.innerHTML = '';
                return;
            }

            // Build header
            let headerHTML = `
                <tr>
                    <th class="px-2 py-2 text-left text-xs font-medium text-gray-500 sticky left-0 bg-gray-50 z-20 border-r border-gray-300" style="min-width: 200px;">Student</th>
            `;
            
            currentAssessments.forEach(assessment => {
                const date = new Date(assessment.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const summary = calculateGradeSummary(assessment.id);
                
                headerHTML += `
                    <th class="px-2 py-2 text-center text-xs font-medium text-gray-500" style="min-width: 100px;">
                        <div class="cursor-pointer" onclick="openAssessmentGradesModal('${assessment.id}')" title="Click to enter grades">
                            <div class="font-semibold">${assessment.occasion}</div>
                            <div class="text-xs text-gray-400">${date}</div>
                            <div class="text-xs text-gray-400">${assessment.teacher}</div>
                            ${assessment.maxScore ? `<div class="text-xs text-purple-600">Max: ${assessment.maxScore}</div>` : ''}
                            <div class="text-xs mt-1">
                                <span class="text-blue-600">Avg: ${summary.average}</span>
                                <span class="text-gray-600 ml-1">${summary.graded}/${summary.total}</span>
                            </div>
                            <div class="flex justify-center space-x-1 mt-1">
                                <button onclick="event.stopPropagation(); editAssessment('${assessment.id}')" class="text-blue-600 hover:text-blue-800" title="Edit">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button onclick="event.stopPropagation(); deleteAssessment('${assessment.id}')" class="text-red-600 hover:text-red-800" title="Delete">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </th>
                `;
            });
            
            headerHTML += '</tr>';
            tableHead.innerHTML = headerHTML;

            // Build body
            let bodyHTML = '';
            courseStudents.forEach(student => {
                const isDropped = student.isDropped || student.enrollmentStatus === 'dropped';
                const rowClass = isDropped ? 'hover:bg-gray-50 opacity-60 bg-gray-50' : 'hover:bg-gray-50';
                const textClass = isDropped ? 'text-gray-500' : '';
                const bgClass = isDropped ? 'bg-gray-50' : 'bg-white';
                
                bodyHTML += `
                    <tr class="${rowClass}">
                        <td class="px-2 py-2 text-xs sticky left-0 ${bgClass} z-10 border-r border-gray-300" style="min-width: 200px;">
                            <div class="font-medium ${textClass}">${student.humanId}</div>
                            <div class="${isDropped ? 'text-gray-500' : 'text-gray-600'}">${student.fullName}</div>
                            ${isDropped ? '<div class="text-xs text-red-600">(Dropped)</div>' : ''}
                        </td>
                `;
                
                currentAssessments.forEach(assessment => {
                    const key = `${student.id}-${assessment.id}`;
                    const record = currentPerformanceRecords.get(key);
                    const score = record ? record.score : null;
                    let cellClass = getGradeCellClass(score, assessment.maxScore);
                    
                    // Gray out dropped students' grade cells
                    if (isDropped) {
                        cellClass = 'bg-gray-200 text-gray-500';
                    }
                    
                    const displayScore = score !== null ? score : '-';
                    const clickHandler = isDropped ? '' : `onclick="openAssessmentGradesModal('${assessment.id}')"`;
                    const cursorClass = isDropped ? 'cursor-not-allowed' : 'cursor-pointer hover:bg-gray-200';
                    const title = isDropped ? 'Student is dropped - grades cannot be edited' : 'Click to enter grades';
                    
                    bodyHTML += `
                        <td class="px-2 py-2 text-center ${cursorClass} ${cellClass}" 
                            ${clickHandler}
                            title="${title}">
                            <span class="text-sm font-bold">${displayScore}</span>
                        </td>
                    `;
                });
                
                bodyHTML += '</tr>';
            });
            
            tableBody.innerHTML = bodyHTML;
        }

        function getGradeCellClass(score, maxScore) {
            if (score === null || score === undefined) return 'bg-gray-100 text-gray-600';
            if (!maxScore) return 'bg-blue-100 text-blue-800';
            
            const percentage = (score / maxScore) * 100;
            if (percentage >= 80) return 'bg-green-100 text-green-800';
            if (percentage >= 60) return 'bg-yellow-100 text-yellow-800';
            return 'bg-red-100 text-red-800';
        }

        function calculateGradeSummary(assessmentId) {
            let total = 0;
            let graded = 0;
            let sum = 0;
            
            for (const [key, record] of currentPerformanceRecords.entries()) {
                if (key.endsWith(`-${assessmentId}`)) {
                    total++;
                    if (record.score !== null && record.score !== undefined) {
                        graded++;
                        sum += parseFloat(record.score);
                    }
                }
            }
            
            const average = graded > 0 ? (sum / graded).toFixed(1) : 'N/A';
            return { total, graded, average };
        }

        async function addAssessment() {
            const modal = document.getElementById('performanceModal');
            const inputs = modal.querySelectorAll('input');
            const [dateInput, occasionInput, teacherInput, maxScoreInput] = inputs;
            
            const date = dateInput.value;
            const occasion = occasionInput.value.trim();
            const teacher = teacherInput.value.trim();
            const maxScore = maxScoreInput.value.trim() ? parseFloat(maxScoreInput.value) : null;
            
            if (!date || !occasion || !teacher) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                const assessmentId = `ASSESS_${currentCourseId}_${Date.now()}`;
                const docRef = window.firestore.doc(window.db, 'assessments', assessmentId);
                
                const assessmentData = {
                    courseId: currentCourseId,
                    date: date,
                    occasion: occasion,
                    teacher: teacher,
                    createdAt: new Date()
                };
                
                if (maxScore !== null) {
                    assessmentData.maxScore = maxScore;
                }
                
                await window.firestore.setDoc(docRef, assessmentData);
                
                const course = courses.find(c => c.id === currentCourseId);
                if (course) {
                    await updateCourse(currentCourseId, { 
                        assessmentCount: (course.assessmentCount || 0) + 1 
                    });
                }
                
                inputs.forEach(input => input.value = '');
                
                showNotification('Assessment added successfully', 'success');
                loadPerformanceForCourse(currentCourseId);
            } catch (error) {
                console.error('Error adding assessment:', error);
                showNotification('Failed to add assessment', 'error');
            }
        }

        function editAssessment(assessmentId) {
            showNotification('Edit assessment functionality coming soon', 'info');
        }

        async function deleteAssessment(assessmentId) {
            if (!confirm('Are you sure you want to delete this assessment? This will also delete all grades for this assessment.')) return;
            
            try {
                const assessmentRef = window.firestore.doc(window.db, 'assessments', assessmentId);
                await window.firestore.deleteDoc(assessmentRef);
                
                const performanceQuery = window.firestore.query(
                    window.firestore.collection(window.db, 'performance'),
                    window.firestore.where('courseId', '==', currentCourseId),
                    window.firestore.where('assessmentId', '==', assessmentId)
                );
                const performanceSnapshot = await window.firestore.getDocs(performanceQuery);
                
                const deletePromises = [];
                performanceSnapshot.forEach((doc) => {
                    deletePromises.push(window.firestore.deleteDoc(doc.ref));
                });
                
                await Promise.all(deletePromises);
                
                const course = courses.find(c => c.id === currentCourseId);
                if (course && course.assessmentCount > 0) {
                    await updateCourse(currentCourseId, { 
                        assessmentCount: course.assessmentCount - 1 
                    });
                }
                
                showNotification('Assessment deleted successfully', 'success');
                loadPerformanceForCourse(currentCourseId);
                
            } catch (error) {
                console.error('Error deleting assessment:', error);
                showNotification('Failed to delete assessment', 'error');
            }
        }

        // Assessment Grades Modal Functions
        let currentAssessmentId = null;

        async function openAssessmentGradesModal(assessmentId) {
            currentAssessmentId = assessmentId;
            
            const assessment = currentAssessments.find(a => a.id === assessmentId);
            if (!assessment) {
                showNotification('Assessment information not found', 'error');
                return;
            }
            
            const dateObj = new Date(assessment.date);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            document.getElementById('assessmentGradesInfo').innerHTML = `
                <div><span class="font-medium">Assessment:</span> ${assessment.occasion}</div>
                <div><span class="font-medium">Date:</span> ${formattedDate}</div>
                <div><span class="font-medium">Teacher:</span> ${assessment.teacher}</div>
            `;
            
            await loadAssessmentGradesStudents(assessmentId);
            document.getElementById('assessmentGradesModal').classList.add('show');
        }

        function closeAssessmentGradesModal() {
            document.getElementById('assessmentGradesModal').classList.remove('show');
            currentAssessmentId = null;
        }

        async function loadAssessmentGradesStudents(assessmentId) {
            try {
                const enrollmentsRef = window.firestore.collection(window.db, 'enrollments');
                const enrollmentQuery = window.firestore.query(enrollmentsRef, window.firestore.where('courseId', '==', currentCourseId));
                const enrollmentSnapshot = await window.firestore.getDocs(enrollmentQuery);
                
                const enrolledStudentIds = [];
                const droppedStudentIds = [];
                enrollmentSnapshot.forEach((doc) => {
                    const enrollment = doc.data();
                    if (enrollment.status === 'active') {
                        enrolledStudentIds.push(enrollment.studentId);
                    } else if (enrollment.status === 'dropped') {
                        droppedStudentIds.push(enrollment.studentId);
                    }
                });
                
                // Get active and dropped students, mark dropped ones
                const activeStudents = students.filter(s => enrolledStudentIds.includes(s.id));
                const droppedStudents = students.filter(s => droppedStudentIds.includes(s.id));
                
                droppedStudents.forEach(student => {
                    student.isDropped = true;
                    student.enrollmentStatus = 'dropped';
                });
                activeStudents.forEach(student => {
                    student.isDropped = false;
                    student.enrollmentStatus = 'active';
                });

                // Sort students based on selected option
                const sortBy = document.getElementById('performanceStudentSort')?.value || 'id';
                if (sortBy === 'name') {
                    activeStudents.sort((a, b) => a.fullName.localeCompare(b.fullName));
                    droppedStudents.sort((a, b) => a.fullName.localeCompare(b.fullName));
                } else if (sortBy === 'id') {
                    activeStudents.sort((a, b) => a.humanId.localeCompare(b.humanId));
                    droppedStudents.sort((a, b) => a.humanId.localeCompare(b.humanId));
                }
                const courseStudents = [...activeStudents, ...droppedStudents];
                
                renderAssessmentGradesStudents(courseStudents, assessmentId);
                
            } catch (error) {
                console.error('Error loading assessment grades:', error);
                showNotification('Failed to load student grades', 'error');
            }
        }

        function renderAssessmentGradesStudents(courseStudents, assessmentId) {
            const tbody = document.getElementById('assessmentGradesStudentsList');
            
            tbody.innerHTML = courseStudents.map(student => {
                const key = `${student.id}-${assessmentId}`;
                const record = currentPerformanceRecords.get(key);
                const score = record ? record.score || '' : '';
                const comments = record ? record.comments || '' : '';
                const isDropped = student.isDropped || student.enrollmentStatus === 'dropped';
                const rowClass = isDropped ? 'hover:bg-gray-50 opacity-60 bg-gray-50' : 'hover:bg-gray-50';
                
                return `
                    <tr class="${rowClass}">
                        <td class="px-4 py-3">
                            <div class="text-sm font-medium ${isDropped ? 'text-gray-500' : 'text-gray-900'}">${student.humanId}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm ${isDropped ? 'text-gray-500' : 'text-gray-900'}">${student.fullName}</div>
                            ${isDropped ? '<div class="text-xs text-red-600">(Dropped)</div>' : ''}
                        </td>
                        <td class="px-4 py-3 text-center">
                            <input type="number" 
                                   step="0.1" 
                                   min="0" 
                                   class="w-20 px-2 py-1 text-sm border border-gray-300 rounded text-center ${isDropped ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : ''}" 
                                   placeholder="${isDropped ? 'N/A' : 'Score'}"
                                   value="${score}"
                                   ${isDropped ? 'disabled readonly' : `onchange="updateStudentGrade('${student.id}', 'score', this.value)"`}>
                        </td>
                        <td class="px-4 py-3">
                            <textarea class="w-full px-2 py-1 text-sm border border-gray-300 rounded resize-none ${isDropped ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : ''}" 
                                      rows="2" 
                                      placeholder="${isDropped ? 'Student is dropped' : 'Add comments...'}"
                                      ${isDropped ? 'disabled readonly' : `onchange="updateStudentGrade('${student.id}', 'comments', this.value)"`}>${comments}</textarea>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        let tempGrades = new Map();

        function updateStudentGrade(studentId, field, value) {
            const key = `${studentId}-${currentAssessmentId}`;
            
            if (!tempGrades.has(key)) {
                const existingRecord = currentPerformanceRecords.get(key) || {};
                tempGrades.set(key, { ...existingRecord });
            }
            
            const record = tempGrades.get(key);
            if (field === 'score') {
                record.score = value.trim() !== '' ? parseFloat(value) : null;
            } else if (field === 'comments') {
                record.comments = value.trim();
            }
            
            tempGrades.set(key, record);
        }

        async function saveAllAssessmentGrades() {
            try {
                const savePromises = [];
                let changesCount = 0;
                
                // Get all students in the modal to check for changes
                const rows = document.querySelectorAll('#assessmentGradesStudentsList tr');
                
                for (const row of rows) {
                    const studentId = row.querySelector('input[type="number"]')?.getAttribute('onchange')?.match(/'([^']+)'/)?.[1];
                    if (!studentId) continue;
                    
                    const scoreInput = row.querySelector('input[type="number"]');
                    const commentsTextarea = row.querySelector('textarea');
                    
                    if (!scoreInput || !commentsTextarea) continue;
                    
                    const newScore = scoreInput.value.trim();
                    const newComments = commentsTextarea.value.trim();
                    
                    const key = `${studentId}-${currentAssessmentId}`;
                    const existingRecord = currentPerformanceRecords.get(key);
                    
                    // Check if there are actual changes
                    const existingScore = existingRecord?.score;
                    const existingComments = existingRecord?.comments || '';
                    
                    const scoreChanged = (newScore === '' ? null : parseFloat(newScore)) !== existingScore;
                    const commentsChanged = newComments !== existingComments;
                    
                    if (!scoreChanged && !commentsChanged) continue;
                    
                    changesCount++;
                    
                    const performanceRecordId = `PERF_${currentCourseId}_${studentId}_${currentAssessmentId}`;
                    const docRef = window.firestore.doc(window.db, 'performance', performanceRecordId);
                    
                    const hasScore = newScore !== '' && newScore !== null && newScore !== undefined;
                    const hasComments = newComments !== '';
                    
                    if (!hasScore && !hasComments) {
                        // Delete record if both score and comments are empty
                        const existingDoc = await window.firestore.getDoc(docRef);
                        if (existingDoc.exists()) {
                            savePromises.push(window.firestore.deleteDoc(docRef));
                        }
                        currentPerformanceRecords.delete(key);
                    } else {
                        // Save record with score and/or comments
                        const recordData = {
                            courseId: currentCourseId,
                            studentId: studentId,
                            assessmentId: currentAssessmentId,
                            score: hasScore ? parseFloat(newScore) : null,
                            comments: newComments,
                            updatedAt: new Date()
                        };
                        
                        const existingDoc = await window.firestore.getDoc(docRef);
                        if (!existingDoc.exists()) {
                            recordData.createdAt = new Date();
                            savePromises.push(window.firestore.setDoc(docRef, recordData));
                        } else {
                            savePromises.push(window.firestore.updateDoc(docRef, recordData));
                        }
                        
                        currentPerformanceRecords.set(key, recordData);
                    }
                }
                
                if (changesCount === 0) {
                    showNotification('No changes to save', 'info');
                    return;
                }
                
                await Promise.all(savePromises);
                
                showNotification(`Successfully saved grades for ${changesCount} student(s)`, 'success');
                tempGrades.clear();
                closeAssessmentGradesModal();
                loadPerformanceForCourse(currentCourseId);
                
            } catch (error) {
                console.error('Error saving assessment grades:', error);
                showNotification('Failed to save grades', 'error');
            }
        }

        // Notification system
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            
            const bgColor = type === 'success' ? 'bg-green-500' : 
                           type === 'error' ? 'bg-red-500' : 
                           type === 'warning' ? 'bg-orange-500' : 'bg-blue-500';
            
            notification.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg transform transition-all duration-300 translate-x-full opacity-0`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('translate-x-full', 'opacity-0');
            }, 100);
            
            const duration = type === 'error' ? 5000 : 3000;
            setTimeout(() => {
                notification.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => {
                    if (container.contains(notification)) {
                        container.removeChild(notification);
                    }
                }, 300);
            }, duration);
        }

        // Form submission
        document.getElementById('addCourseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const courseData = {
                code: document.getElementById('courseCode').value,
                name: document.getElementById('courseName').value,
                teacher: document.getElementById('courseTeacher').value === 'other' ? 
                        document.getElementById('customTeacher').value : 
                        document.getElementById('courseTeacher').value,
                startDate: document.getElementById('courseStartDate').value,
                status: document.getElementById('courseStatus').value,
                schedule: document.getElementById('courseSchedule').value
            };
            
            try {
                const courseId = e.target.dataset.courseId;
                if (courseId) {
                    await updateCourse(courseId, courseData);
                } else {
                    await addCourse(courseData);
                }
                closeAddCourseModal();
            } catch (error) {
                console.error('Error saving course:', error);
            }
        });



        // Edit attendance date form submission
        document.getElementById('editAttendanceDateForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!editingDateId) {
                showNotification('No date selected for editing', 'error');
                return;
            }
            
            const date = document.getElementById('editAttendanceDate').value;
            const teacher = document.getElementById('editAttendanceTeacher').value.trim();
            const lessonName = document.getElementById('editAttendanceLesson').value.trim();
            
            if (!date || !teacher || !lessonName) {
                showNotification('Please fill in all fields', 'error');
                return;
            }
            
            try {
                const dateRef = window.firestore.doc(window.db, 'attendanceDates', editingDateId);
                await window.firestore.updateDoc(dateRef, {
                    date: date,
                    teacher: teacher,
                    lessonName: lessonName,
                    updatedAt: new Date()
                });
                
                showNotification('Attendance date updated successfully', 'success');
                closeEditAttendanceDateModal();
                loadAttendanceForCourse(currentCourseId);
                
            } catch (error) {
                console.error('Error updating attendance date:', error);
                showNotification('Failed to update attendance date', 'error');
            }
        });

        // Teacher selection toggle
        function toggleCustomTeacher() {
            const teacherSelect = document.getElementById('courseTeacher');
            const customTeacherInput = document.getElementById('customTeacher');
            
            if (teacherSelect.value === 'other') {
                customTeacherInput.style.display = 'block';
                customTeacherInput.required = true;
            } else {
                customTeacherInput.style.display = 'none';
                customTeacherInput.required = false;
                customTeacherInput.value = '';
            }
        }

        // Initialize event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Sort functionality
            const sortSelect = document.getElementById('sortSelect');
            if (sortSelect) {
                sortSelect.addEventListener('change', () => {
                    renderCourses();
                });
            }

            // Search functionality
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    if (!searchTerm) {
                        renderCourses();
                        return;
                    }
                    
                    const filteredCourses = courses.filter(course => 
                        course.code.toLowerCase().includes(searchTerm) ||
                        course.name.toLowerCase().includes(searchTerm) ||
                        course.teacher.toLowerCase().includes(searchTerm)
                    );
                    
                    const tbody = document.getElementById('coursesTableBody');
                    const sortBy = document.getElementById('sortSelect')?.value || 'code';
                    const sortedCourses = sortCourses(filteredCourses, sortBy);
                    
                    tbody.innerHTML = sortedCourses.map(course => `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3">
                                <div class="font-medium text-sm">${course.code}</div>
                                <div class="text-xs text-gray-600">${course.name}</div>
                            </td>
                            <td class="px-4 py-3">
                                <div class="text-sm">${course.teacher}</div>
                                <div class="text-xs text-gray-600">${course.schedule}</div>
                                <div class="text-xs text-gray-500">Started: ${new Date(course.startDate).toLocaleDateString()}</div>
                            </td>
                            <td class="px-4 py-3">
                                <div class="text-sm font-medium">${course.studentCount || 0} students</div>
                                <button onclick="openManageStudentsModal('${course.id}')" class="text-blue-600 hover:text-blue-800 text-xs">
                                    Manage Students
                                </button>
                            </td>
                            <td class="px-4 py-3">
                                <div class="text-sm">${course.sessionCount || 0} sessions</div>
                                <button onclick="openAttendanceModal('${course.id}')" class="text-green-600 hover:text-green-800 text-xs">
                                    Manage Attendance
                                </button>
                                ${course.firstSessionDate && course.lastSessionDate ? 
                                    `<div class="text-xs text-blue-600 mt-1">Period: ${new Date(course.firstSessionDate).toLocaleDateString()} - ${new Date(course.lastSessionDate).toLocaleDateString()}</div>` : 
                                    course.sessionCount > 0 ? '<div class="text-xs text-blue-600 mt-1">Loading period...</div>' : ''
                                }
                            </td>
                            <td class="px-4 py-3">
                                <div class="text-sm">${course.assessmentCount || 0} assessments</div>
                                <button onclick="openPerformanceModal('${course.id}')" class="text-purple-600 hover:text-purple-800 text-xs">
                                    Manage Performance
                                </button>
                            </td>
                            <td class="px-4 py-3">
                                <div class="flex space-x-2">
                                    <button onclick="editCourse('${course.id}')" class="text-blue-600 hover:text-blue-800 text-xs">Edit</button>
                                    <button onclick="deleteCourse('${course.id}')" class="text-red-600 hover:text-red-800 text-xs">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `).join('');
                });
            }

            // Student checkbox and filter event listeners
            document.addEventListener('change', function(e) {
                if (e.target.classList.contains('available-student-checkbox')) {
                    updateSelectedCount();
                }
            });

            // Filter event listeners for student modal
            const studentSearchInput = document.getElementById('studentSearchInput');
            if (studentSearchInput) {
                studentSearchInput.addEventListener('input', () => {
                    renderStudentsTables();
                });
            }

            const studentStatusFilter = document.getElementById('studentStatusFilter');
            if (studentStatusFilter) {
                studentStatusFilter.addEventListener('change', () => {
                    renderStudentsTables();
                });
            }

            const studentClassFilter = document.getElementById('studentClassFilter');
            if (studentClassFilter) {
                studentClassFilter.addEventListener('change', () => {
                    renderStudentsTables();
                });
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9842b9519165dd42',t:'MTc1ODcyMTU0NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
