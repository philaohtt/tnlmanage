<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Course Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    
    <!-- Firebase Configuration -->
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDdx6QyXzCWz7BRZInLu16LGnYBKvFO1CM",
            authDomain: "tnl-management-app.firebaseapp.com",
            projectId: "tnl-management-app",
            storageBucket: "tnl-management-app.firebasestorage.app",
            messagingSenderId: "710843379828",
            appId: "1:710843379828:web:76978490616ebe41bf2121",
            measurementId: "G-8W29VX7WTP"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
    </script>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <div class="flex justify-between items-start mb-4">
                <div class="flex items-center">
                    <div class="bg-blue-100 p-3 rounded-lg mr-4">
                        <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-semibold text-gray-900 mb-1">ðŸ“š Course Management System</h1>
                        <p class="text-gray-600">Manage courses, students, attendance, and performance</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- Sync Status -->
                    <div id="syncIndicator" class="flex items-center px-3 py-2 rounded-lg text-xs border">
                        <div id="syncIcon" class="w-2 h-2 rounded-full mr-2 bg-green-500"></div>
                        <span id="syncText">Connected</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs and Controls -->
        <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
            <!-- Tab Instructions -->
            <div class="text-center mb-4">
                <p class="text-sm text-gray-600">Click on each tab to view courses</p>
            </div>
            
            <!-- Tabs -->
            <div class="flex justify-center gap-4 mb-6">
                <button onclick="switchTab('in-progress')" id="tab-in-progress" class="tab-button active px-6 py-3 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    ðŸ“š In Progress
                    <span id="count-in-progress" class="ml-2 px-2 py-0.5 bg-blue-200 text-blue-800 rounded-full text-xs">0</span>
                </button>
                <button onclick="switchTab('upcoming')" id="tab-upcoming" class="tab-button px-6 py-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-orange-100 hover:text-orange-800 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a1 1 0 011-1h6a1 1 0 011 1v4m-6 0h6m-6 0V7a1 1 0 00-1 1v11a2 2 0 002 2h6a2 2 0 002-2V8a1 1 0 00-1-1V7"></path>
                    </svg>
                    ðŸ“… Upcoming
                    <span id="count-upcoming" class="ml-2 px-2 py-0.5 bg-gray-200 text-gray-600 rounded-full text-xs">0</span>
                </button>
                <button onclick="switchTab('finished')" id="tab-finished" class="tab-button px-6 py-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-green-100 hover:text-green-800 flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    âœ… Finished
                    <span id="count-finished" class="ml-2 px-2 py-0.5 bg-gray-200 text-gray-600 rounded-full text-xs">0</span>
                </button>
            </div>

            <!-- Search and Sort -->
            <div class="flex flex-col sm:flex-row gap-4 mb-6">
                <div class="flex-1">
                    <input type="text" id="searchInput" placeholder="Search by course code, name, or teacher..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           oninput="filterCourses()">
                </div>
                <select id="sortSelect" onchange="sortCourses()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="code">Sort by Code</option>
                    <option value="name">Sort by Name</option>
                    <option value="teacher">Sort by Teacher</option>
                    <option value="startDate">Sort by Start Date</option>
                    <option value="recentLesson">Sort by Recent Lesson</option>
                </select>
                <button onclick="openAddCourseModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Add Course
                </button>
            </div>
        </div>

        <!-- Course Table -->
        <div class="bg-white rounded-lg shadow-sm border overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Course</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">General Info</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Students</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Attendance</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Performance</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="courseTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Courses will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Course Modal -->
    <div id="addCourseModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Add New Course</h3>
                    <button onclick="closeAddCourseModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                <form id="addCourseForm" onsubmit="addCourse(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Course Code</label>
                            <input type="text" id="courseCode" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Course Name</label>
                            <input type="text" id="courseName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Teacher</label>
                            <select id="teacherSelect" onchange="toggleCustomTeacher()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Teacher</option>
                                <option value="other">Other</option>
                            </select>
                            <input type="text" id="customTeacher" placeholder="Enter teacher name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 mt-2 hidden">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Schedule</label>
                            <input type="text" id="schedule" placeholder="e.g., Monday 10:00 AM - 12:00 PM" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Course Status</label>
                            <select id="courseStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="in-progress">In Progress</option>
                                <option value="upcoming">Upcoming</option>
                                <option value="finished">Finished</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="startDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeAddCourseModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancel</button>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Add Course</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Students Management Modal -->
    <div id="studentsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-6xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-xl font-semibold">Manage Students</h3>
                        <div id="courseInfo" class="text-sm text-gray-600 mt-1">
                            <!-- Course code and name will be populated here -->
                        </div>
                    </div>
                    <button onclick="closeStudentsModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Search -->
                <div class="mb-4">
                    <input type="text" id="studentSearchInput" placeholder="Search by Student ID or Name..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           oninput="filterAvailableStudents()">
                </div>

                <!-- Filters -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Class</label>
                        <select id="classFilter" onchange="filterAvailableStudents()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">All Classes</option>
                            <option value="active">Active Classes Only</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Year of Enrollment</label>
                        <select id="yearFilter" onchange="filterAvailableStudents()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">All Years</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">School</label>
                        <select id="schoolFilter" onchange="filterAvailableStudents()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">All Schools</option>
                        </select>
                    </div>
                </div>

                <!-- Available Students Table -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Available Students</h4>
                    <div class="border rounded-lg overflow-hidden">
                        <div class="overflow-x-auto max-h-64">
                            <table class="w-full">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Select</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DOB</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">School</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year Enrolled</th>
                                    </tr>
                                </thead>
                                <tbody id="availableStudentsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Available students will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Currently Enrolled Students -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium mb-3">Currently Enrolled Students <span id="enrolledCount" class="text-sm text-gray-500">(0)</span></h4>
                    <div class="border rounded-lg overflow-hidden">
                        <div class="overflow-x-auto max-h-48">
                            <table class="w-full">
                                <thead class="bg-green-50 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">School</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="enrolledStudentsTableBody" class="bg-white divide-y divide-gray-200">
                                    <!-- Enrolled students will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-3">
                    <button onclick="closeStudentsModal()" class="px-6 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancel</button>
                    <button onclick="saveStudentChanges()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Attendance Modal -->
    <div id="attendanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-2">
            <div class="bg-white rounded-lg w-full h-[95vh] p-6 overflow-y-auto" style="max-width: 95vw;">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-xl font-semibold">Manage Attendance</h3>
                        <div id="attendanceCourseInfo" class="text-sm text-gray-600 mt-1">
                            <!-- Course code and name will be populated here -->
                        </div>
                    </div>
                    <button onclick="closeAttendanceModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Add Date Controls -->
                <div class="mb-6 flex items-center gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Select Date</label>
                        <input type="date" id="attendanceDatePicker" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="pt-6">
                        <button onclick="addAttendanceDate()" id="addDateBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add Date
                        </button>
                    </div>
                    <div class="pt-6">
                        <p class="text-xs text-gray-500">Maximum 50 dates allowed</p>
                    </div>
                </div>

                <!-- Attendance Table -->
                <div class="border rounded-lg overflow-hidden mb-6">
                    <div class="overflow-x-auto overflow-y-auto max-h-96">
                        <table class="w-full" id="attendanceTable" style="min-width: max-content;">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r sticky left-0 bg-gray-50 z-10" style="width: 120px; min-width: 120px;">Student ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r sticky bg-gray-50 z-10" style="left: 120px; width: 200px; min-width: 200px;">Student Name</th>
                                    <!-- Date columns will be added dynamically -->
                                </tr>
                            </thead>
                            <tbody id="attendanceTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Attendance rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-3">
                    <button onclick="closeAttendanceModal()" class="px-6 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Close</button>
                    <button onclick="saveAllAttendanceChanges()" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Save All Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Individual Student Attendance Modal -->
    <div id="studentAttendanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[70]">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Student Attendance</h3>
                    <button onclick="closeStudentAttendanceModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="studentAttendanceInfo" class="mb-4">
                    <!-- Student info will be populated here -->
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Attendance Status</label>
                        <div class="space-y-2">
                            <label class="flex items-center">
                                <input type="radio" name="attendanceStatus" value="present" class="mr-2">
                                <span class="text-green-600">Present</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="attendanceStatus" value="absent" class="mr-2">
                                <span class="text-red-600">Absent</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="attendanceStatus" value="no-record" class="mr-2" checked>
                                <span class="text-gray-500">No Record</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes (Optional)</label>
                        <textarea id="studentNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="Enter any notes about this student's attendance..."></textarea>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeStudentAttendanceModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancel</button>
                    <button onclick="saveStudentAttendance()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Drop Student Modal -->
    <div id="dropStudentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[70]">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-md w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-red-600">Drop Student</h3>
                    <button onclick="closeDropStudentModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="dropStudentInfo" class="mb-4">
                    <!-- Student info will be populated here -->
                </div>

                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-yellow-600 mt-0.5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                        <div class="text-sm">
                            <p class="font-medium text-yellow-800 mb-1">Important Notice</p>
                            <p class="text-yellow-700">This student has existing attendance and/or performance records. Dropping will keep all records but mark the student as inactive. The student will appear grayed out in all lists.</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Drop Date <span class="text-red-500">*</span>
                        </label>
                        <input type="date" id="dropDate" required 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">Date when the student was dropped from the course</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Reason for Dropping (Optional)</label>
                        <textarea id="dropReason" rows="3" placeholder="Enter reason for dropping the student..."
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent"></textarea>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button onclick="closeDropStudentModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                        Cancel
                    </button>
                    <button onclick="confirmDropStudent()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
                        Drop Student
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Date Attendance Modal -->
    <div id="dateAttendanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[70]">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-4xl w-full p-6 max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">Take Attendance</h3>
                    <button onclick="closeDateAttendanceModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
                
                <div id="dateAttendanceInfo" class="mb-4">
                    <!-- Date info will be populated here -->
                </div>

                <div class="mb-4">
                    <button onclick="markAllPresent()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">Mark All as Present</button>
                </div>

                <div class="border rounded-lg overflow-hidden mb-4">
                    <div class="overflow-y-auto max-h-64">
                        <table class="w-full">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                </tr>
                            </thead>
                            <tbody id="dateAttendanceTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Students will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="flex justify-end space-x-3">
                    <button onclick="closeDateAttendanceModal()" class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancel</button>
                    <button onclick="saveDateAttendance()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Modal -->
    <div id="performanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-2">
            <div class="bg-white rounded-lg w-full h-[95vh] p-6 overflow-y-auto" style="max-width: 95vw;">
                <!-- Header -->
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-xl font-semibold">Manage Performance</h3>
                        <div id="performanceCourseInfo" class="text-sm text-gray-600 mt-1">
                            <!-- Course code and name will be populated here -->
                        </div>
                    </div>
                    <button onclick="closePerformanceModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Tab Navigation -->
                <div class="flex space-x-1 mb-6 bg-gray-100 p-1 rounded-lg">
                    <button onclick="switchPerformanceTab('overview')" id="performanceTab-overview" 
                            class="performance-tab-button active flex-1 px-4 py-2 text-sm font-medium rounded-md bg-white text-purple-700 shadow-sm">
                        ðŸ“Š Overview
                    </button>
                    <button onclick="switchPerformanceTab('individual')" id="performanceTab-individual" 
                            class="performance-tab-button flex-1 px-4 py-2 text-sm font-medium rounded-md text-gray-600 hover:text-purple-700">
                        ðŸ‘¤ Individual Students
                    </button>
                </div>

                <!-- Tab Content -->
                <div id="performanceTabContent">
                    <!-- Content will be populated based on active tab -->
                </div>
            </div>
        </div>
    </div>

    <!-- Assessment Details Modal -->
    <div id="assessmentDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60]">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-6xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-lg font-semibold">Assessment Details</h3>
                        <div id="assessmentDetailsInfo" class="text-sm text-gray-600 mt-1">
                            <!-- Assessment info will be populated here -->
                        </div>
                    </div>
                    <button onclick="closeAssessmentDetailsModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <!-- Students Performance Grid -->
                <div class="border rounded-lg overflow-hidden mb-6">
                    <div class="overflow-y-auto max-h-96">
                        <table class="w-full">
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student ID</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student Name</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comments</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Attach File</th>
                                </tr>
                            </thead>
                            <tbody id="assessmentDetailsTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Students will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex justify-end space-x-3">
                    <button onclick="closeAssessmentDetailsModal()" class="px-6 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">Cancel</button>
                    <button onclick="saveAssessmentDetails()" class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Performance Form Modal -->
    <div id="addPerformanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-[60]">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-semibold">Add Performance Information</h3>
                    <button onclick="closeAddPerformanceForm()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>

                <form id="addPerformanceForm" onsubmit="savePerformanceInfo(event)">
                    <div class="space-y-6">
                        <!-- Date of Assessment -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Date of Assessment <span class="text-red-500">*</span>
                            </label>
                            <input type="date" id="assessmentDate" required 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>

                        <!-- Occasion -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Occasion <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="occasionInput" required placeholder="Enter assessment occasion (e.g., Quiz 1, Midterm Exam, etc.)"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>

                        <!-- Teacher -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Teacher <span class="text-red-500">*</span>
                            </label>
                            <input type="text" id="teacherInput" required placeholder="Enter teacher name"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>

                        <!-- Maximum Score -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Maximum Score (Optional)</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="maxScore" min="1" step="0.1" placeholder="100" value="100"
                                       class="w-32 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <span class="text-gray-500 text-sm">points total</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">Set the maximum possible score for this assessment</p>
                        </div>

                        <!-- Attach File -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Attach File (Optional)</label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-purple-400 transition-colors">
                                <input type="file" id="performanceFile" class="hidden" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt" onchange="handleFileSelection(this)">
                                <div id="fileDropArea" onclick="document.getElementById('performanceFile').click()" class="cursor-pointer">
                                    <svg class="w-12 h-12 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    <p class="text-sm text-gray-600">Click to upload or drag and drop</p>
                                    <p class="text-xs text-gray-500 mt-1">PDF, DOC, DOCX, JPG, PNG, TXT (Max 10MB)</p>
                                </div>
                                <div id="selectedFileName" class="hidden mt-2 text-sm text-green-600 flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span id="fileNameText"></span>
                                    <button type="button" onclick="clearSelectedFile()" class="ml-2 text-red-500 hover:text-red-700">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description (Optional)</label>
                            <textarea id="performanceComments" rows="4" placeholder="Enter description about this assessment..."
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                        </div>

                        <!-- Show to Students -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Show to Students <span class="text-red-500">*</span>
                            </label>
                            <select id="showToStudents" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="">Select Option</option>
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-end space-x-3 mt-8">
                        <button type="button" onclick="closeAddPerformanceForm()" 
                                class="px-6 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
                            Save Performance Info
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let courses = [];
        let currentTab = 'in-progress';
        let currentCourseId = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadCourses();
            loadAllPerformanceRecords();
        });

        // Firebase operations
        async function loadCourses() {
            try {
                const snapshot = await db.collection('courses').get();
                courses = [];
                snapshot.forEach(doc => {
                    courses.push({ id: doc.id, ...doc.data() });
                });
                updateCourseCounts();
                displayCourses();
            } catch (error) {
                console.error('Error loading courses:', error);
            }
        }

        async function saveCourse(courseData) {
            try {
                // Generate sequential course ID
                const coursesSnapshot = await db.collection('courses').get();
                const courseCount = coursesSnapshot.size + 1;
                const courseId = `course_${courseCount.toString().padStart(3, '0')}`;
                
                await db.collection('courses').doc(courseId).set({
                    ...courseData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    students: [],
                    attendance: [],
                    assessments: []
                });
                return courseId;
            } catch (error) {
                console.error('Error saving course:', error);
                throw error;
            }
        }

        async function updateCourse(courseId, updates) {
            try {
                await db.collection('courses').doc(courseId).update(updates);
            } catch (error) {
                console.error('Error updating course:', error);
                throw error;
            }
        }

        async function deleteCourse(courseId) {
            try {
                await db.collection('courses').doc(courseId).delete();
            } catch (error) {
                console.error('Error deleting course:', error);
                throw error;
            }
        }

        // Tab management
        function switchTab(tab) {
            currentTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.id === 'tab-in-progress') {
                    btn.className = 'tab-button px-6 py-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-blue-100 hover:text-blue-800 flex items-center';
                } else if (btn.id === 'tab-upcoming') {
                    btn.className = 'tab-button px-6 py-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-orange-100 hover:text-orange-800 flex items-center';
                } else if (btn.id === 'tab-finished') {
                    btn.className = 'tab-button px-6 py-3 rounded-lg text-sm font-medium bg-gray-100 text-gray-600 hover:bg-green-100 hover:text-green-800 flex items-center';
                }
            });
            
            // Set active tab styling
            const activeTab = document.getElementById(`tab-${tab}`);
            activeTab.classList.add('active');
            if (tab === 'in-progress') {
                activeTab.className = 'tab-button active px-6 py-3 rounded-lg text-sm font-medium bg-blue-100 text-blue-800 flex items-center';
            } else if (tab === 'upcoming') {
                activeTab.className = 'tab-button active px-6 py-3 rounded-lg text-sm font-medium bg-orange-100 text-orange-800 flex items-center';
            } else if (tab === 'finished') {
                activeTab.className = 'tab-button active px-6 py-3 rounded-lg text-sm font-medium bg-green-100 text-green-800 flex items-center';
            }
            
            displayCourses();
        }

        // Course display and filtering
        function displayCourses() {
            const filteredCourses = courses.filter(course => course.status === currentTab);
            const tbody = document.getElementById('courseTableBody');
            
            if (filteredCourses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            <div class="flex flex-col items-center">
                                <svg class="w-12 h-12 text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                </svg>
                                <p>No ${currentTab.replace('-', ' ')} courses found</p>
                                <button onclick="openAddCourseModal()" class="mt-2 text-blue-600 hover:text-blue-800">Add your first course</button>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filteredCourses.map(course => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${course.code}</div>
                            <div class="text-sm text-gray-500">${course.name}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">ðŸ‘¨â€ðŸ« ${course.teacher}</div>
                        <div class="text-sm text-gray-500">ðŸ“… ${course.schedule || 'TBD'}</div>
                        <div class="text-sm text-gray-500">ðŸ—“ï¸ ${formatDate(course.startDate)}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${course.students?.length || 0} students</div>
                        <button onclick="openStudentsModal('${course.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Manage Students</button>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="openAttendanceModal('${course.id}')" class="text-green-600 hover:text-green-800 text-sm block mb-1">Manage Attendance</button>
                        <div class="text-xs text-gray-500">${getAttendancePeriod(course)}</div>
                        <div class="text-xs text-gray-500">${course.attendanceDates?.length || 0} sessions</div>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="openPerformanceModal('${course.id}')" class="text-purple-600 hover:text-purple-800 text-sm block mb-1">Manage Performance</button>
                        <div class="text-xs text-gray-500">${getAssessmentCount(course)} assessments</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex space-x-2">
                            <button onclick="editCourse('${course.id}')" class="text-blue-600 hover:text-blue-800">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="deleteCourseConfirm('${course.id}')" class="text-red-600 hover:text-red-800">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                            <select onchange="moveCourse('${course.id}', this.value)" class="text-xs border rounded px-1 py-1">
                                <option value="">Move to...</option>
                                <option value="in-progress" ${course.status === 'in-progress' ? 'disabled' : ''}>In Progress</option>
                                <option value="upcoming" ${course.status === 'upcoming' ? 'disabled' : ''}>Upcoming</option>
                                <option value="finished" ${course.status === 'finished' ? 'disabled' : ''}>Finished</option>
                            </select>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateCourseCounts() {
            const counts = {
                'in-progress': courses.filter(c => c.status === 'in-progress').length,
                'upcoming': courses.filter(c => c.status === 'upcoming').length,
                'finished': courses.filter(c => c.status === 'finished').length
            };
            
            Object.keys(counts).forEach(status => {
                const countElement = document.getElementById(`count-${status}`);
                countElement.textContent = counts[status];
                
                // Update count badge colors based on active tab
                if (currentTab === status) {
                    if (status === 'in-progress') {
                        countElement.className = 'ml-2 px-2 py-0.5 bg-blue-200 text-blue-800 rounded-full text-xs';
                    } else if (status === 'upcoming') {
                        countElement.className = 'ml-2 px-2 py-0.5 bg-orange-200 text-orange-800 rounded-full text-xs';
                    } else if (status === 'finished') {
                        countElement.className = 'ml-2 px-2 py-0.5 bg-green-200 text-green-800 rounded-full text-xs';
                    }
                } else {
                    countElement.className = 'ml-2 px-2 py-0.5 bg-gray-200 text-gray-600 rounded-full text-xs';
                }
            });
        }

        function filterCourses() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filteredCourses = courses.filter(course => 
                course.status === currentTab &&
                (course.code.toLowerCase().includes(searchTerm) ||
                 course.name.toLowerCase().includes(searchTerm) ||
                 course.teacher.toLowerCase().includes(searchTerm))
            );
            
            // Update display with filtered courses
            displayFilteredCourses(filteredCourses);
        }

        function displayFilteredCourses(filteredCourses) {
            const tbody = document.getElementById('courseTableBody');
            
            if (filteredCourses.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            No courses match your search criteria
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = filteredCourses.map(course => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div>
                            <div class="text-sm font-medium text-gray-900">${course.code}</div>
                            <div class="text-sm text-gray-500">${course.name}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">ðŸ‘¨â€ðŸ« ${course.teacher}</div>
                        <div class="text-sm text-gray-500">ðŸ“… ${course.schedule || 'TBD'}</div>
                        <div class="text-sm text-gray-500">ðŸ—“ï¸ ${formatDate(course.startDate)}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900">${course.students?.length || 0} students</div>
                        <button onclick="openStudentsModal('${course.id}')" class="text-blue-600 hover:text-blue-800 text-sm">Manage Students</button>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="openAttendanceModal('${course.id}')" class="text-green-600 hover:text-green-800 text-sm block mb-1">Manage Attendance</button>
                        <div class="text-xs text-gray-500">${getAttendancePeriod(course)}</div>
                        <div class="text-xs text-gray-500">${course.attendanceDates?.length || 0} sessions</div>
                    </td>
                    <td class="px-6 py-4">
                        <button onclick="openPerformanceModal('${course.id}')" class="text-purple-600 hover:text-purple-800 text-sm block mb-1">Manage Performance</button>
                        <div class="text-xs text-gray-500">${getAssessmentCount(course)} assessments</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex space-x-2">
                            <button onclick="editCourse('${course.id}')" class="text-blue-600 hover:text-blue-800">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="deleteCourseConfirm('${course.id}')" class="text-red-600 hover:text-red-800">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                            <select onchange="moveCourse('${course.id}', this.value)" class="text-xs border rounded px-1 py-1">
                                <option value="">Move to...</option>
                                <option value="in-progress" ${course.status === 'in-progress' ? 'disabled' : ''}>In Progress</option>
                                <option value="upcoming" ${course.status === 'upcoming' ? 'disabled' : ''}>Upcoming</option>
                                <option value="finished" ${course.status === 'finished' ? 'disabled' : ''}>Finished</option>
                            </select>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function sortCourses() {
            const sortBy = document.getElementById('sortSelect').value;
            
            courses.sort((a, b) => {
                switch (sortBy) {
                    case 'code':
                        return a.code.localeCompare(b.code);
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'teacher':
                        return a.teacher.localeCompare(b.teacher);
                    case 'startDate':
                        return new Date(a.startDate) - new Date(b.startDate);
                    case 'recentLesson':
                        const aRecent = a.attendance?.length ? Math.max(...a.attendance.map(att => new Date(att.date))) : 0;
                        const bRecent = b.attendance?.length ? Math.max(...b.attendance.map(att => new Date(att.date))) : 0;
                        return bRecent - aRecent;
                    default:
                        return 0;
                }
            });
            
            displayCourses();
        }

        // Modal management
        function openAddCourseModal() {
            document.getElementById('addCourseModal').classList.remove('hidden');
        }

        function closeAddCourseModal() {
            document.getElementById('addCourseModal').classList.add('hidden');
            document.getElementById('addCourseForm').reset();
            document.getElementById('customTeacher').classList.add('hidden');
        }

        function toggleCustomTeacher() {
            const select = document.getElementById('teacherSelect');
            const customInput = document.getElementById('customTeacher');
            
            if (select.value === 'other') {
                customInput.classList.remove('hidden');
                customInput.required = true;
            } else {
                customInput.classList.add('hidden');
                customInput.required = false;
                customInput.value = '';
            }
        }

        async function addCourse(event) {
            event.preventDefault();
            
            const teacherSelect = document.getElementById('teacherSelect');
            const customTeacher = document.getElementById('customTeacher');
            const teacher = teacherSelect.value === 'other' ? customTeacher.value : teacherSelect.value;
            
            const courseData = {
                code: document.getElementById('courseCode').value,
                name: document.getElementById('courseName').value,
                teacher: teacher,
                schedule: document.getElementById('schedule').value,
                status: document.getElementById('courseStatus').value,
                startDate: document.getElementById('startDate').value
            };
            
            try {
                await saveCourse(courseData);
                closeAddCourseModal();
                loadCourses();
            } catch (error) {
                alert('Error adding course: ' + error.message);
            }
        }

        async function moveCourse(courseId, newStatus) {
            if (!newStatus) return;
            
            try {
                await updateCourse(courseId, { status: newStatus });
                loadCourses();
            } catch (error) {
                alert('Error moving course: ' + error.message);
            }
        }

        async function deleteCourseConfirm(courseId) {
            if (confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
                try {
                    await deleteCourse(courseId);
                    loadCourses();
                } catch (error) {
                    alert('Error deleting course: ' + error.message);
                }
            }
        }

        // Students management
        let allStudents = [];
        let allClasses = [];
        let availableStudents = [];
        let selectedStudents = [];
        let currentlyEnrolledStudents = [];
        let currentStudentToProcess = null;

        async function openStudentsModal(courseId) {
            currentCourseId = courseId;
            const course = courses.find(c => c.id === courseId);
            
            // Update course info display
            document.getElementById('courseInfo').innerHTML = `${course.code} - ${course.name}`;
            
            // Load students and classes data
            await loadStudentsAndClasses();
            
            // Load enrollment data from Firebase to get the most current enrollment status
            await loadEnrollmentData(course);
            
            // Populate filters
            populateFilters();
            
            // Display data
            filterAvailableStudents();
            displayEnrolledStudents();
            
            document.getElementById('studentsModal').classList.remove('hidden');
        }

        async function loadEnrollmentData(course) {
            try {
                // Query enrollment collection for this course (including both Active and Dropped)
                const enrollmentSnapshot = await db.collection('enrollment')
                    .where('courseCode', '==', course.code)
                    .get();

                const enrollmentData = [];
                enrollmentSnapshot.forEach(doc => {
                    const data = doc.data();
                    enrollmentData.push(data);
                });

                // Find the full student objects for enrolled students and merge with enrollment data
                currentlyEnrolledStudents = [];
                selectedStudents = [];

                enrollmentData.forEach(enrollment => {
                    const student = allStudents.find(s => s.studentId === enrollment.studentId);
                    if (student) {
                        const enrichedStudent = {
                            ...student,
                            status: enrollment.status,
                            dropDate: enrollment.dropDate,
                            dropReason: enrollment.dropReason,
                            droppedAt: enrollment.droppedAt,
                            enrolledAt: enrollment.enrolledAt
                        };
                        
                        currentlyEnrolledStudents.push(enrichedStudent);
                        selectedStudents.push(enrichedStudent);
                    }
                });

                console.log(`Loaded ${currentlyEnrolledStudents.length} enrolled students (including dropped) from enrollment collection`);
            } catch (error) {
                console.error('Error loading enrollment data:', error);
                // Fallback to course.students if enrollment collection fails
                currentlyEnrolledStudents = course.students || [];
                selectedStudents = [...currentlyEnrolledStudents];
            }
        }

        function closeStudentsModal() {
            document.getElementById('studentsModal').classList.add('hidden');
            currentCourseId = null;
            selectedStudents = [];
            currentlyEnrolledStudents = [];
        }

        async function loadStudentsAndClasses() {
            try {
                // Load students
                const studentsSnapshot = await db.collection('students').get();
                allStudents = [];
                studentsSnapshot.forEach(doc => {
                    allStudents.push({ id: doc.id, ...doc.data() });
                });

                // Load classes
                const classesSnapshot = await db.collection('classes').get();
                allClasses = [];
                classesSnapshot.forEach(doc => {
                    allClasses.push({ id: doc.id, ...doc.data() });
                });
            } catch (error) {
                console.error('Error loading students and classes:', error);
                // Create sample data if collections don't exist
                createSampleData();
            }
        }

        function createSampleData() {
            // Sample students data
            allStudents = [
                {
                    id: 'student_001',
                    studentId: 'STU001',
                    fullName: 'John Smith',
                    dateOfbirth: '2005-03-15',
                    classAssignment: 'class_001',
                    school: 'Central High School',
                    status: 'Active',
                    yearEnrolled: 2023
                },
                {
                    id: 'student_002',
                    studentId: 'STU002',
                    fullName: 'Emma Johnson',
                    dateOfbirth: '2005-07-22',
                    classAssignment: 'class_002',
                    school: 'Central High School',
                    status: 'Active',
                    yearEnrolled: 2023
                },
                {
                    id: 'student_003',
                    studentId: 'STU003',
                    fullName: 'Michael Brown',
                    dateOfbirth: '2004-11-08',
                    classAssignment: 'class_001',
                    school: 'North High School',
                    status: 'Active',
                    yearEnrolled: 2022
                },
                {
                    id: 'student_004',
                    studentId: 'STU004',
                    fullName: 'Sarah Davis',
                    dateOfbirth: '2005-01-30',
                    classAssignment: 'class_003',
                    school: 'South High School',
                    status: 'Inactive',
                    yearEnrolled: 2023
                }
            ];

            // Sample classes data
            allClasses = [
                {
                    id: 'class_001',
                    className: '12A',
                    status: 'Active'
                },
                {
                    id: 'class_002',
                    className: '12B',
                    status: 'Active'
                },
                {
                    id: 'class_003',
                    className: '11A',
                    status: 'Inactive'
                }
            ];
        }

        function populateFilters() {
            // Populate year filter
            const yearFilter = document.getElementById('yearFilter');
            const years = [...new Set(allStudents.map(s => s.yearEnrolled))].sort((a, b) => b - a);
            yearFilter.innerHTML = '<option value="">All Years</option>' + 
                years.map(year => `<option value="${year}">${year}</option>`).join('');

            // Populate school filter
            const schoolFilter = document.getElementById('schoolFilter');
            const schools = [...new Set(allStudents.map(s => s.school))].sort();
            schoolFilter.innerHTML = '<option value="">All Schools</option>' + 
                schools.map(school => `<option value="${school}">${school}</option>`).join('');
        }

        function filterAvailableStudents() {
            const searchTerm = document.getElementById('studentSearchInput').value.toLowerCase();
            const classFilter = document.getElementById('classFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const schoolFilter = document.getElementById('schoolFilter').value;

            availableStudents = allStudents.filter(student => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    student.studentId.toLowerCase().includes(searchTerm) ||
                    student.fullName.toLowerCase().includes(searchTerm);

                // Class filter
                const studentClass = allClasses.find(c => c.id === student.classAssignment);
                const matchesClass = !classFilter || 
                    (classFilter === 'active' && studentClass?.status === 'Active');

                // Year filter
                const matchesYear = !yearFilter || student.yearEnrolled.toString() === yearFilter;

                // School filter
                const matchesSchool = !schoolFilter || student.school === schoolFilter;

                return matchesSearch && matchesClass && matchesYear && matchesSchool;
            });

            displayAvailableStudents();
        }

        function displayAvailableStudents() {
            const tbody = document.getElementById('availableStudentsTableBody');
            
            if (availableStudents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-500">
                            No students match the current filters
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = availableStudents.map(student => {
                const studentClass = allClasses.find(c => c.id === student.classAssignment);
                // Check if student is enrolled by comparing studentId (more reliable than object comparison)
                const isEnrolled = selectedStudents.some(s => s.studentId === student.studentId);
                // Check if student is already saved/enrolled (from currentlyEnrolledStudents)
                const isSavedEnrollment = currentlyEnrolledStudents.some(s => s.studentId === student.studentId);
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-3">
                            <input type="checkbox" ${isEnrolled ? 'checked' : ''} 
                                   ${isSavedEnrollment ? 'disabled' : ''}
                                   onchange="toggleStudentSelection('${student.id}', this.checked)"
                                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 ${isSavedEnrollment ? 'opacity-50 cursor-not-allowed' : ''}">
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <span class="text-sm font-medium text-gray-900">${student.studentId}</span>
                                ${isEnrolled ? '<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">âœ“ Enrolled</span>' : ''}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-900">${student.fullName}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${formatDate(student.dateOfBirth)}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${student.classAssignment}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${student.school}</td>
                        <td class="px-4 py-3">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${student.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${student.status}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-500">${student.yearEnrolled}</td>
                    </tr>
                `;
            }).join('');
        }

        function displayEnrolledStudents() {
            const tbody = document.getElementById('enrolledStudentsTableBody');
            const count = document.getElementById('enrolledCount');
            
            count.textContent = `(${selectedStudents.length})`;
            
            if (selectedStudents.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            No students currently enrolled
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = selectedStudents.map(student => {
                const studentClass = allClasses.find(c => c.id === student.classAssignment);
                const hasRecords = checkStudentHasRecords(student.studentId);
                const isDropped = student.status === 'Dropped';
                
                // Determine button states
                const canRemove = !hasRecords && !isDropped;
                const canDrop = hasRecords && !isDropped;
                
                const rowClass = isDropped ? 'bg-gray-100 opacity-60' : 'hover:bg-gray-50';
                const textClass = isDropped ? 'text-gray-500' : '';
                
                return `
                    <tr class="${rowClass}">
                        <td class="px-4 py-3 text-sm font-medium ${isDropped ? 'text-gray-500' : 'text-gray-900'}">
                            ${student.studentId}
                            ${isDropped ? '<span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">Dropped</span>' : ''}
                        </td>
                        <td class="px-4 py-3 text-sm ${isDropped ? 'text-gray-500' : 'text-gray-900'}">${student.fullName}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${student.classAssignment}</td>
                        <td class="px-4 py-3 text-sm text-gray-500">${student.school}</td>
                        <td class="px-4 py-3">
                            ${isDropped ? `
                                <div class="space-y-2">
                                    <div class="text-xs text-gray-500">
                                        Dropped: ${formatDate(student.dropDate)}
                                        ${student.dropReason ? `<br>Reason: ${student.dropReason}` : ''}
                                    </div>
                                    <button onclick="reEnrollStudent('${student.id}')" 
                                            class="px-3 py-1 text-xs font-medium rounded-lg bg-green-100 text-green-700 hover:bg-green-200 transition-colors">
                                        Re-enroll
                                    </button>
                                </div>
                            ` : `
                                <div class="flex space-x-2">
                                    <button id="remove-btn-${student.id}" onclick="removeStudent('${student.id}')" 
                                            class="px-3 py-1 text-xs font-medium rounded-lg transition-colors ${canRemove ? 'bg-red-100 text-red-700 hover:bg-red-200' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}"
                                            ${!canRemove ? 'disabled' : ''}>
                                        Remove
                                    </button>
                                    <button id="drop-btn-${student.id}" onclick="openDropStudentModal('${student.id}')" 
                                            class="px-3 py-1 text-xs font-medium rounded-lg transition-colors ${canDrop ? 'bg-orange-100 text-orange-700 hover:bg-orange-200' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}"
                                            ${!canDrop ? 'disabled' : ''}>
                                        Drop
                                    </button>
                                </div>
                            `}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function toggleStudentSelection(studentId, isSelected) {
            const student = allStudents.find(s => s.id === studentId);
            if (!student) return;

            if (isSelected) {
                if (!selectedStudents.some(s => s.id === studentId)) {
                    selectedStudents.push(student);
                }
            } else {
                selectedStudents = selectedStudents.filter(s => s.id !== studentId);
            }

            displayEnrolledStudents();
            displayAvailableStudents(); // Refresh to update enrollment status
        }

        function removeFromEnrolled(studentId) {
            selectedStudents = selectedStudents.filter(s => s.id !== studentId);
            displayEnrolledStudents();
            displayAvailableStudents(); // Refresh to update checkboxes
        }

        function checkStudentHasRecords(studentId) {
            const course = courses.find(c => c.id === currentCourseId);
            if (!course) return false;
            
            // Check attendance records
            const hasAttendanceRecords = (course.attendanceDates || []).some(dateData => 
                dateData.records && dateData.records[studentId]
            );
            
            // Check performance records
            const hasPerformanceRecords = performanceRecords.some(record => 
                record.studentId === studentId && record.courseCode === course.code
            );
            
            return hasAttendanceRecords || hasPerformanceRecords;
        }

        function removeStudent(studentId) {
            const student = selectedStudents.find(s => s.id === studentId);
            if (!student) return;
            
            const hasRecords = checkStudentHasRecords(student.studentId);
            
            if (hasRecords) {
                alert('Cannot remove this student. They have existing attendance or performance records. Use "Drop" instead.');
                return;
            }
            
            if (confirm(`Are you sure you want to remove ${student.fullName} from this course? This action cannot be undone.`)) {
                selectedStudents = selectedStudents.filter(s => s.id !== studentId);
                displayEnrolledStudents();
                displayAvailableStudents(); // Refresh to update checkboxes
            }
        }

        function openDropStudentModal(studentId) {
            const student = selectedStudents.find(s => s.id === studentId);
            if (!student) return;
            
            const hasRecords = checkStudentHasRecords(student.studentId);
            
            if (!hasRecords) {
                alert('This student has no attendance or performance records. Use "Remove" instead of "Drop".');
                return;
            }
            
            currentStudentToProcess = student;
            
            // Update modal content
            document.getElementById('dropStudentInfo').innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="text-sm font-medium text-gray-900">${student.fullName}</div>
                    <div class="text-sm text-gray-500">Student ID: ${student.studentId}</div>
                    <div class="text-sm text-gray-500">Class: ${student.className || 'N/A'}</div>
                    <div class="text-sm text-gray-500">School: ${student.school}</div>
                </div>
            `;
            
            // Set default drop date to today
            document.getElementById('dropDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('dropReason').value = '';
            
            document.getElementById('dropStudentModal').classList.remove('hidden');
        }

        function closeDropStudentModal() {
            document.getElementById('dropStudentModal').classList.add('hidden');
            currentStudentToProcess = null;
        }

        async function confirmDropStudent() {
            if (!currentStudentToProcess) return;
            
            const dropDate = document.getElementById('dropDate').value;
            const dropReason = document.getElementById('dropReason').value;
            
            if (!dropDate) {
                alert('Please enter a drop date.');
                return;
            }
            
            try {
                const course = courses.find(c => c.id === currentCourseId);
                
                // Update student status in selectedStudents
                const studentIndex = selectedStudents.findIndex(s => s.id === currentStudentToProcess.id);
                if (studentIndex !== -1) {
                    selectedStudents[studentIndex] = {
                        ...selectedStudents[studentIndex],
                        status: 'Dropped',
                        dropDate: dropDate,
                        dropReason: dropReason,
                        droppedAt: new Date().toISOString()
                    };
                }
                
                // Update enrollment record in Firebase
                const enrollmentId = `${currentStudentToProcess.studentId}_${course.code}`;
                await db.collection('enrollment').doc(enrollmentId).update({
                    status: 'Dropped',
                    dropDate: dropDate,
                    dropReason: dropReason,
                    droppedAt: new Date().toISOString()
                });
                
                closeDropStudentModal();
                displayEnrolledStudents();
                
                alert(`${currentStudentToProcess.fullName} has been dropped from the course. All records are preserved.`);
            } catch (error) {
                alert('Error dropping student: ' + error.message);
            }
        }

        async function reEnrollStudent(studentId) {
            const student = selectedStudents.find(s => s.id === studentId);
            if (!student) return;
            
            if (!confirm(`Are you sure you want to re-enroll ${student.fullName}? This will restore their active status in the course.`)) {
                return;
            }
            
            try {
                const course = courses.find(c => c.id === currentCourseId);
                
                // Update student status in selectedStudents
                const studentIndex = selectedStudents.findIndex(s => s.id === studentId);
                if (studentIndex !== -1) {
                    selectedStudents[studentIndex] = {
                        ...selectedStudents[studentIndex],
                        status: 'Active',
                        reEnrolledAt: new Date().toISOString(),
                        // Keep drop history for audit trail
                        previousDropDate: selectedStudents[studentIndex].dropDate,
                        previousDropReason: selectedStudents[studentIndex].dropReason,
                        previousDroppedAt: selectedStudents[studentIndex].droppedAt,
                        // Clear current drop fields
                        dropDate: null,
                        dropReason: null,
                        droppedAt: null
                    };
                }
                
                // Update enrollment record in Firebase
                const enrollmentId = `${student.studentId}_${course.code}`;
                await db.collection('enrollment').doc(enrollmentId).update({
                    status: 'Active',
                    reEnrolledAt: new Date().toISOString(),
                    // Keep drop history for audit trail
                    previousDropDate: student.dropDate,
                    previousDropReason: student.dropReason,
                    previousDroppedAt: student.droppedAt,
                    // Clear current drop fields
                    dropDate: firebase.firestore.FieldValue.delete(),
                    dropReason: firebase.firestore.FieldValue.delete(),
                    droppedAt: firebase.firestore.FieldValue.delete()
                });
                
                displayEnrolledStudents();
                
                alert(`${student.fullName} has been successfully re-enrolled in the course!`);
            } catch (error) {
                alert('Error re-enrolling student: ' + error.message);
            }
        }

        async function saveStudentChanges() {
            try {
                const course = courses.find(c => c.id === currentCourseId);
                
                // Convert selected students to the format expected by the course
                const studentsToSave = selectedStudents.map(student => ({
                    id: student.id,
                    studentId: student.studentId,
                    name: student.fullName,
                    email: student.email || `${student.studentId.toLowerCase()}@school.edu`,
                    enrolledAt: new Date().toISOString()
                }));

                // Update the course with new student list
                await updateCourse(currentCourseId, { students: studentsToSave });

                // Manage enrollment collection
                await updateEnrollmentCollection(course, currentlyEnrolledStudents, selectedStudents);
                
                await loadCourses();
                closeStudentsModal();
                
                alert(`Successfully updated enrollment. ${studentsToSave.length} students are now enrolled.`);
            } catch (error) {
                alert('Error saving student changes: ' + error.message);
            }
        }

        async function updateEnrollmentCollection(course, previouslyEnrolled, currentlySelected) {
            try {
                // Get students who were removed (in previously enrolled but not in currently selected)
                // Only consider active students for removal (not dropped students)
                const activePreviouslyEnrolled = previouslyEnrolled.filter(s => s.status !== 'Dropped');
                const activeCurrentlySelected = currentlySelected.filter(s => s.status !== 'Dropped');
                
                const removedStudents = activePreviouslyEnrolled.filter(prev => 
                    !activeCurrentlySelected.some(curr => curr.id === prev.id)
                );

                // Get students who were added (in currently selected but not in previously enrolled)
                const addedStudents = activeCurrentlySelected.filter(curr => 
                    !activePreviouslyEnrolled.some(prev => prev.id === curr.id)
                );

                // Remove enrollment documents for removed students (only if they don't have records)
                for (const student of removedStudents) {
                    const hasRecords = checkStudentHasRecords(student.studentId);
                    if (!hasRecords) {
                        const enrollmentId = `${student.studentId}_${course.code}`;
                        try {
                            await db.collection('enrollment').doc(enrollmentId).delete();
                            console.log(`Removed enrollment: ${enrollmentId}`);
                        } catch (error) {
                            console.error(`Error removing enrollment ${enrollmentId}:`, error);
                        }
                    }
                }

                // Add enrollment documents for new students
                for (const student of addedStudents) {
                    const enrollmentId = `${student.studentId}_${course.code}`;
                    const enrollmentData = {
                        studentId: student.studentId,
                        studentName: student.fullName,
                        courseId: course.id,
                        courseCode: course.code,
                        courseName: course.name,
                        enrolledAt: new Date().toISOString(),
                        status: 'Active'
                    };

                    try {
                        await db.collection('enrollment').doc(enrollmentId).set(enrollmentData);
                        console.log(`Added enrollment: ${enrollmentId}`);
                    } catch (error) {
                        console.error(`Error adding enrollment ${enrollmentId}:`, error);
                    }
                }

                console.log(`Enrollment updated: ${removedStudents.length} removed, ${addedStudents.length} added`);
            } catch (error) {
                console.error('Error updating enrollment collection:', error);
                throw error;
            }
        }

        // Attendance management
        let attendanceDates = [];
        let currentAttendanceDate = null;
        let currentStudentAttendance = null;
        let attendanceChanges = {};

        async function openAttendanceModal(courseId) {
            currentCourseId = courseId;
            const course = courses.find(c => c.id === courseId);
            
            // Update course info display
            document.getElementById('attendanceCourseInfo').innerHTML = `${course.code} - ${course.name}`;
            
            // Load attendance dates and data
            await loadAttendanceDates(course);
            
            document.getElementById('attendanceModal').classList.remove('hidden');
            displayAttendanceTable();
        }

        function closeAttendanceModal() {
            document.getElementById('attendanceModal').classList.add('hidden');
            currentCourseId = null;
            attendanceDates = [];
            attendanceChanges = {};
        }

        async function loadAttendanceDates(course) {
            try {
                // Load attendance dates from the course or create empty array
                attendanceDates = course.attendanceDates || [];
                
                // Sort dates with oldest first (newest on the right)
                attendanceDates.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Load attendance records from the attendance collection
                const attendanceSnapshot = await db.collection('attendance')
                    .where('courseCode', '==', course.code)
                    .get();
                
                // Organize attendance data by date
                attendanceSnapshot.forEach(doc => {
                    const data = doc.data();
                    const dateKey = data.date;
                    
                    // Find the date in attendanceDates and add the student record
                    const dateIndex = attendanceDates.findIndex(d => d.date === dateKey);
                    if (dateIndex !== -1) {
                        if (!attendanceDates[dateIndex].records) {
                            attendanceDates[dateIndex].records = {};
                        }
                        attendanceDates[dateIndex].records[data.studentId] = {
                            status: data.status,
                            notes: data.notes || ''
                        };
                    }
                });
                
                console.log('Loaded attendance dates:', attendanceDates);
            } catch (error) {
                console.error('Error loading attendance dates:', error);
                attendanceDates = [];
            }
        }

        async function addAttendanceDate() {
            if (attendanceDates.length >= 50) {
                alert('Maximum of 50 dates allowed');
                return;
            }

            const course = courses.find(c => c.id === currentCourseId);
            const selectedDate = document.getElementById('attendanceDatePicker').value;
            
            if (!selectedDate) {
                alert('Please select a date');
                return;
            }
            
            // Check if date already exists
            if (attendanceDates.some(d => d.date === selectedDate)) {
                alert('Attendance for this date already exists');
                return;
            }

            const newDate = {
                date: selectedDate,
                teacher: '',
                lessonName: '',
                records: {}
            };

            attendanceDates.push(newDate);
            
            // Sort dates with newest first (most recent on the right)
            attendanceDates.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Update the course with new attendance dates
            try {
                await updateCourse(currentCourseId, { attendanceDates: attendanceDates });
                displayAttendanceTable();
                
                // Clear the date picker
                document.getElementById('attendanceDatePicker').value = '';
                
                // Update button state
                const addBtn = document.getElementById('addDateBtn');
                if (attendanceDates.length >= 50) {
                    addBtn.disabled = true;
                    addBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
            } catch (error) {
                alert('Error adding date: ' + error.message);
                attendanceDates.pop(); // Remove the added date on error
            }
        }

        function displayAttendanceTable() {
            const course = courses.find(c => c.id === currentCourseId);
            const students = course.students || [];
            
            const thead = document.querySelector('#attendanceTable thead tr');
            const tbody = document.getElementById('attendanceTableBody');
            
            // Clear existing date columns (keep first 2 columns)
            const existingHeaders = thead.querySelectorAll('th');
            for (let i = existingHeaders.length - 1; i >= 2; i--) {
                existingHeaders[i].remove();
            }
            
            // Add date column headers
            attendanceDates.forEach(dateData => {
                const th = document.createElement('th');
                th.className = 'px-1 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-r';
                th.style.width = '100px';
                th.style.minWidth = '100px';
                th.innerHTML = `
                    <div class="space-y-1">
                        <div class="cursor-pointer hover:text-blue-600" onclick="openDateAttendanceModal('${dateData.date}')">
                            <div class="font-semibold">${formatDate(dateData.date)}</div>
                            <div class="text-xs text-gray-400">${new Date(dateData.date).toLocaleDateString('en-US', { weekday: 'short' })}</div>
                        </div>
                        <div class="text-xs space-y-1">
                            <div class="text-center">
                                <input type="text" value="${dateData.teacher}" placeholder="Teacher" 
                                       class="text-xs border-0 bg-transparent focus:bg-white focus:border focus:border-gray-300 rounded px-1 py-0.5 w-16 text-center"
                                       onchange="updateDateInfo('${dateData.date}', 'teacher', this.value)"
                                       onclick="event.stopPropagation()">
                            </div>
                            <div class="text-center">
                                <input type="text" value="${dateData.lessonName}" placeholder="Lesson" 
                                       class="text-xs border-0 bg-transparent focus:bg-white focus:border focus:border-gray-300 rounded px-1 py-0.5 w-16 text-center"
                                       onchange="updateDateInfo('${dateData.date}', 'lessonName', this.value)"
                                       onclick="event.stopPropagation()">
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            ${getAttendanceSummary(dateData, students)}
                        </div>
                        <button onclick="deleteAttendanceDate('${dateData.date}')" class="text-red-500 hover:text-red-700 text-xs">
                            Delete
                        </button>
                    </div>
                `;
                thead.appendChild(th);
            });
            
            // Display student rows
            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${2 + attendanceDates.length}" class="px-4 py-8 text-center text-gray-500">
                            No students enrolled in this course
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = students.map(student => {
                const attendanceCells = attendanceDates.map(dateData => {
                    const record = dateData.records[student.studentId];
                    const status = record ? record.status : 'no-record';
                    const statusClass = getStatusClass(status);
                    const statusText = getStatusText(status);
                    
                    return `
                        <td class="px-1 py-3 border-r text-center" style="width: 100px; min-width: 100px;">
                            <button onclick="openStudentAttendanceModal('${student.studentId}', '${dateData.date}')" 
                                    class="w-full text-center p-1 rounded hover:bg-gray-50 ${statusClass}">
                                <div class="text-xs font-medium">${statusText}</div>
                                ${record && record.notes ? `<div class="text-xs text-gray-500 truncate">${record.notes}</div>` : ''}
                            </button>
                        </td>
                    `;
                }).join('');
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-2 py-3 text-sm font-medium text-gray-900 border-r sticky left-0 bg-white z-10" style="width: 80px; min-width: 80px;">${student.studentId}</td>
                        <td class="px-2 py-3 text-sm text-gray-900 border-r sticky bg-white z-10" style="left: 80px; width: 120px; min-width: 120px;">${student.name}</td>
                        ${attendanceCells}
                    </tr>
                `;
            }).join('');
        }

        function getStatusClass(status) {
            switch (status) {
                case 'present': return 'text-green-600 bg-green-50';
                case 'absent': return 'text-red-600 bg-red-50';
                default: return 'text-gray-500 bg-gray-50';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'present': return 'Present';
                case 'absent': return 'Absent';
                default: return 'No Record';
            }
        }

        function getAttendanceSummary(dateData, students) {
            const records = Object.values(dateData.records || {});
            const present = records.filter(r => r.status === 'present').length;
            const absent = records.filter(r => r.status === 'absent').length;
            const total = students.length;
            const rate = total > 0 ? Math.round((present / total) * 100) : 0;
            
            return `<span class="text-green-600 font-medium">${present}P</span> <span class="text-red-600 font-medium">${absent}A</span> (${rate}%)`;
        }

        async function deleteAttendanceDate(date) {
            if (!confirm('Are you sure you want to delete this attendance date? This will remove all attendance records for this date.')) {
                return;
            }

            try {
                const course = courses.find(c => c.id === currentCourseId);
                
                // Remove from attendanceDates array
                attendanceDates = attendanceDates.filter(d => d.date !== date);
                
                // Delete attendance records from database
                const attendanceSnapshot = await db.collection('attendance')
                    .where('courseCode', '==', course.code)
                    .where('date', '==', date)
                    .get();
                
                const batch = db.batch();
                attendanceSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                // Update course
                await updateCourse(currentCourseId, { attendanceDates: attendanceDates });
                
                displayAttendanceTable();
                
                // Re-enable add button if under limit
                const addBtn = document.getElementById('addDateBtn');
                if (attendanceDates.length < 50) {
                    addBtn.disabled = false;
                    addBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            } catch (error) {
                alert('Error deleting attendance date: ' + error.message);
            }
        }

        // Student attendance modal functions
        function openStudentAttendanceModal(studentId, date) {
            const course = courses.find(c => c.id === currentCourseId);
            const student = course.students.find(s => s.studentId === studentId);
            const dateData = attendanceDates.find(d => d.date === date);
            const record = dateData.records[studentId];
            
            currentStudentAttendance = { studentId, date };
            
            // Update modal content
            document.getElementById('studentAttendanceInfo').innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="text-sm font-medium text-gray-900">${student.name} (${student.studentId})</div>
                    <div class="text-sm text-gray-500">${formatDate(date)} - ${dateData.lessonName}</div>
                </div>
            `;
            
            // Set current status
            const status = record ? record.status : 'no-record';
            document.querySelector(`input[name="attendanceStatus"][value="${status}"]`).checked = true;
            
            // Set notes
            document.getElementById('studentNotes').value = record ? record.notes || '' : '';
            
            document.getElementById('studentAttendanceModal').classList.remove('hidden');
        }

        function closeStudentAttendanceModal() {
            document.getElementById('studentAttendanceModal').classList.add('hidden');
            currentStudentAttendance = null;
        }

        async function saveStudentAttendance() {
            if (!currentStudentAttendance) return;
            
            const status = document.querySelector('input[name="attendanceStatus"]:checked').value;
            const notes = document.getElementById('studentNotes').value;
            
            try {
                await saveAttendanceRecord(currentStudentAttendance.studentId, currentStudentAttendance.date, status, notes);
                closeStudentAttendanceModal();
                await loadAttendanceDates(courses.find(c => c.id === currentCourseId));
                displayAttendanceTable();
            } catch (error) {
                alert('Error saving attendance: ' + error.message);
            }
        }

        // Date attendance modal functions
        function openDateAttendanceModal(date) {
            const course = courses.find(c => c.id === currentCourseId);
            const dateData = attendanceDates.find(d => d.date === date);
            const students = course.students || [];
            
            currentAttendanceDate = date;
            
            // Update modal content
            document.getElementById('dateAttendanceInfo').innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg">
                    <div class="text-lg font-medium text-gray-900">${formatDate(date)} - ${dateData.lessonName}</div>
                    <div class="text-sm text-gray-500">Teacher: ${dateData.teacher}</div>
                </div>
            `;
            
            // Display students
            const tbody = document.getElementById('dateAttendanceTableBody');
            tbody.innerHTML = students.map(student => {
                const record = dateData.records[student.studentId];
                const status = record ? record.status : 'no-record';
                const notes = record ? record.notes || '' : '';
                
                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${student.studentId}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${student.name}</td>
                        <td class="px-4 py-3">
                            <select class="text-sm border rounded px-2 py-1" data-student-id="${student.studentId}">
                                <option value="no-record" ${status === 'no-record' ? 'selected' : ''}>No Record</option>
                                <option value="present" ${status === 'present' ? 'selected' : ''}>Present</option>
                                <option value="absent" ${status === 'absent' ? 'selected' : ''}>Absent</option>
                            </select>
                        </td>
                        <td class="px-4 py-3">
                            <input type="text" class="text-sm border rounded px-2 py-1 w-full" 
                                   placeholder="Notes..." value="${notes}" data-student-id="${student.studentId}">
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('dateAttendanceModal').classList.remove('hidden');
        }

        function closeDateAttendanceModal() {
            document.getElementById('dateAttendanceModal').classList.add('hidden');
            currentAttendanceDate = null;
        }

        function markAllPresent() {
            const selects = document.querySelectorAll('#dateAttendanceTableBody select');
            selects.forEach(select => {
                select.value = 'present';
            });
        }

        async function saveDateAttendance() {
            if (!currentAttendanceDate) return;
            
            const tbody = document.getElementById('dateAttendanceTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            try {
                for (const row of rows) {
                    const select = row.querySelector('select');
                    const input = row.querySelector('input');
                    const studentId = select.dataset.studentId;
                    const status = select.value;
                    const notes = input.value;
                    
                    await saveAttendanceRecord(studentId, currentAttendanceDate, status, notes);
                }
                
                closeDateAttendanceModal();
                await loadAttendanceDates(courses.find(c => c.id === currentCourseId));
                displayAttendanceTable();
            } catch (error) {
                alert('Error saving attendance: ' + error.message);
            }
        }

        async function saveAttendanceRecord(studentId, date, status, notes) {
            const course = courses.find(c => c.id === currentCourseId);
            const student = course.students.find(s => s.studentId === studentId);
            
            const attendanceId = `att_${course.code}_${studentId}_${date}`;
            
            const attendanceData = {
                courseCode: course.code,
                courseName: course.name,
                studentId: studentId,
                studentName: student.name,
                date: date,
                status: status,
                notes: notes,
                updatedAt: new Date().toISOString()
            };
            
            if (status === 'no-record') {
                // Delete the record if status is no-record
                try {
                    await db.collection('attendance').doc(attendanceId).delete();
                } catch (error) {
                    // Document might not exist, which is fine
                }
            } else {
                // Save or update the record
                await db.collection('attendance').doc(attendanceId).set(attendanceData);
            }
            
            // Update local attendanceDates
            const dateData = attendanceDates.find(d => d.date === date);
            if (dateData) {
                if (status === 'no-record') {
                    delete dateData.records[studentId];
                } else {
                    dateData.records[studentId] = { status, notes };
                }
            }
        }

        async function updateDateInfo(date, field, value) {
            try {
                const dateData = attendanceDates.find(d => d.date === date);
                if (dateData) {
                    dateData[field] = value;
                    await updateCourse(currentCourseId, { attendanceDates: attendanceDates });
                }
            } catch (error) {
                console.error('Error updating date info:', error);
            }
        }

        async function saveAllAttendanceChanges() {
            try {
                // All changes are saved automatically when individual records are updated
                alert('All attendance changes have been saved successfully!');
                closeAttendanceModal();
            } catch (error) {
                alert('Error saving attendance changes: ' + error.message);
            }
        }

        // Performance management
        let performanceRecords = [];
        let currentPerformanceTab = 'overview';

        async function openPerformanceModal(courseId) {
            currentCourseId = courseId;
            const course = courses.find(c => c.id === courseId);
            
            // Update course info display
            document.getElementById('performanceCourseInfo').innerHTML = `${course.code} - ${course.name}`;
            
            // Load performance records for this specific course
            const courseRecords = await loadPerformanceRecords(course);
            
            // Set performanceRecords to the course-specific records for the modal
            performanceRecords = courseRecords;
            
            // Reset to overview tab
            currentPerformanceTab = 'overview';
            switchPerformanceTab('overview');
            
            document.getElementById('performanceModal').classList.remove('hidden');
        }

        function closePerformanceModal() {
            document.getElementById('performanceModal').classList.add('hidden');
            currentCourseId = null;
            performanceRecords = [];
            currentPerformanceTab = 'overview';
        }

        function switchPerformanceTab(tab) {
            currentPerformanceTab = tab;
            
            // Update tab buttons
            document.querySelectorAll('.performance-tab-button').forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'text-purple-700', 'shadow-sm');
                btn.classList.add('text-gray-600', 'hover:text-purple-700');
            });
            
            const activeTab = document.getElementById(`performanceTab-${tab}`);
            activeTab.classList.add('active', 'bg-white', 'text-purple-700', 'shadow-sm');
            activeTab.classList.remove('text-gray-600', 'hover:text-purple-700');
            
            // Display appropriate content
            displayPerformanceTabContent();
        }

        function displayPerformanceTabContent() {
            const container = document.getElementById('performanceTabContent');
            const course = courses.find(c => c.id === currentCourseId);
            const students = course.students || [];
            
            switch (currentPerformanceTab) {
                case 'overview':
                    displayPerformanceOverview(container, students);
                    break;
                case 'individual':
                    displayIndividualStudents(container, students);
                    break;
            }
        }

        function displayPerformanceOverview(container, students) {
            const course = courses.find(c => c.id === currentCourseId);
            
            // Get assessments from course's assessmentDates (sorted by date)
            const assessments = (course.assessmentDates || []).map(assessmentInfo => {
                // Find performance records for this assessment
                const records = performanceRecords.filter(record => 
                    record.date === assessmentInfo.date && 
                    record.occasion === assessmentInfo.occasion && 
                    record.teacher === assessmentInfo.teacher
                );
                
                return {
                    date: assessmentInfo.date,
                    occasion: assessmentInfo.occasion,
                    teacher: assessmentInfo.teacher,
                    maxScore: assessmentInfo.maxScore,
                    showToStudents: assessmentInfo.showToStudents,
                    records: records
                };
            });

            container.innerHTML = `
                <div class="space-y-4">
                    <!-- Add Assessment Button -->
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-medium">Performance Overview</h4>
                        <button onclick="openAddPerformanceForm()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            Add Assessment
                        </button>
                    </div>

                    <!-- Performance Table -->
                    <div class="border rounded-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full" style="min-width: max-content;">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r sticky left-0 bg-gray-50 z-10" style="width: 200px; min-width: 200px;">
                                            Student
                                        </th>
                                        ${assessments.map(assessment => `
                                            <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider border-r cursor-pointer hover:bg-gray-100" 
                                                style="width: 150px; min-width: 150px;"
                                                onclick="openAssessmentDetails('${assessment.date}', '${assessment.occasion}', '${assessment.teacher}')">
                                                <div class="space-y-1">
                                                    <div class="font-semibold text-gray-700">${formatDate(assessment.date)}</div>
                                                    <div class="text-xs">${assessment.occasion}</div>
                                                    <div class="text-xs text-gray-500">${assessment.teacher}</div>
                                                    <div class="flex justify-center space-x-1 mt-2">
                                                        <button onclick="event.stopPropagation(); editAssessmentHeader('${assessment.date}', '${assessment.occasion}', '${assessment.teacher}')" 
                                                                class="text-blue-500 hover:text-blue-700 text-xs">
                                                            Edit
                                                        </button>
                                                        <button onclick="event.stopPropagation(); deleteAssessment('${assessment.date}', '${assessment.occasion}', '${assessment.teacher}')" 
                                                                class="text-red-500 hover:text-red-700 text-xs">
                                                            Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            </th>
                                        `).join('')}
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-200">
                                    ${students.length === 0 ? `
                                        <tr>
                                            <td colspan="${1 + assessments.length}" class="px-4 py-8 text-center text-gray-500">
                                                No students enrolled in this course
                                            </td>
                                        </tr>
                                    ` : students.map(student => `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 border-r sticky left-0 bg-white z-10" style="width: 200px; min-width: 200px;">
                                                <div class="text-sm font-medium text-gray-900">${student.studentId}</div>
                                                <div class="text-sm text-gray-500">${student.name}</div>
                                            </td>
                                            ${assessments.map(assessment => {
                                                const studentRecord = assessment.records.find(r => r.studentId === student.studentId);
                                                const score = studentRecord && studentRecord.score !== null && studentRecord.score !== undefined && studentRecord.score !== '' 
                                                    ? `${studentRecord.score}/${studentRecord.maxScore}` : '-';
                                                return `
                                                    <td class="px-2 py-3 text-center border-r cursor-pointer hover:bg-gray-100" 
                                                        style="width: 150px; min-width: 150px;"
                                                        onclick="openAssessmentDetails('${assessment.date}', '${assessment.occasion}', '${assessment.teacher}')">
                                                        <div class="text-sm font-medium">${score}</div>
                                                        ${studentRecord && studentRecord.comments ? `
                                                            <div class="text-xs text-gray-500 truncate" title="${studentRecord.comments}">
                                                                ðŸ’¬ ${studentRecord.comments.substring(0, 20)}${studentRecord.comments.length > 20 ? '...' : ''}
                                                            </div>
                                                        ` : ''}
                                                    </td>
                                                `;
                                            }).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    ${assessments.length === 0 ? `
                        <div class="text-center py-8 bg-gray-50 rounded-lg">
                            <svg class="w-12 h-12 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p class="text-gray-500">No assessments yet</p>
                            <button onclick="openAddPerformanceForm()" class="mt-2 text-purple-600 hover:text-purple-800">Add your first assessment</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function displayIndividualStudents(container, students) {
            if (students.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <p class="text-gray-500 text-lg mb-2">No students enrolled</p>
                        <p class="text-gray-400 text-sm">Add students to this course to track their performance</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="space-y-4">
                    <!-- Search and Filter -->
                    <div class="flex gap-4 mb-6">
                        <input type="text" id="studentPerformanceSearch" placeholder="Search students..." 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                               oninput="filterStudentPerformance()">
                        <select id="performanceFilter" onchange="filterStudentPerformance()" 
                                class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="">All Students</option>
                            <option value="high">High Performers (>80%)</option>
                            <option value="medium">Medium Performers (60-80%)</option>
                            <option value="low">Low Performers (<60%)</option>
                            <option value="no-data">No Performance Data</option>
                        </select>
                    </div>

                    <!-- Students Grid -->
                    <div id="studentsPerformanceGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${students.map(student => {
                            const studentRecords = performanceRecords.filter(r => r.studentId === student.studentId);
                            const averageScore = studentRecords.length > 0 ? 
                                studentRecords
                                    .filter(r => r.score !== null && r.score !== undefined && r.score !== '')
                                    .reduce((sum, r) => sum + (r.score / r.maxScore * 100), 0) / 
                                studentRecords.filter(r => r.score !== null && r.score !== undefined && r.score !== '').length : null;
                            
                            const performanceClass = averageScore === null ? 'bg-gray-50' : 
                                averageScore >= 80 ? 'bg-green-50' : 
                                averageScore >= 60 ? 'bg-yellow-50' : 'bg-red-50';
                            
                            const performanceColor = averageScore === null ? 'text-gray-600' : 
                                averageScore >= 80 ? 'text-green-600' : 
                                averageScore >= 60 ? 'text-yellow-600' : 'text-red-600';

                            return `
                                <div class="bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                    <div class="flex items-center justify-between mb-3">
                                        <div>
                                            <div class="font-medium text-gray-900">${student.name}</div>
                                            <div class="text-sm text-gray-500">${student.studentId}</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold ${performanceColor}">
                                                ${averageScore !== null ? averageScore.toFixed(1) + '%' : 'N/A'}
                                            </div>
                                            <div class="text-xs text-gray-500">${studentRecords.length} assessments</div>
                                        </div>
                                    </div>
                                    
                                    <div class="space-y-2">
                                        ${studentRecords.length === 0 ? `
                                            <div class="text-sm text-gray-500 text-center py-2">No performance data</div>
                                        ` : `
                                            ${studentRecords.slice(0, 3).map(record => `
                                                <div class="flex justify-between items-center text-sm">
                                                    <span class="text-gray-600">${record.occasion}</span>
                                                    <span class="font-medium">
                                                        ${record.score !== null && record.score !== undefined && record.score !== '' ? 
                                                            `${record.score}/${record.maxScore}` : 'No score'}
                                                    </span>
                                                </div>
                                            `).join('')}
                                            ${studentRecords.length > 3 ? `
                                                <div class="text-xs text-purple-600 text-center">+${studentRecords.length - 3} more</div>
                                            ` : ''}
                                        `}
                                    </div>
                                    
                                    <div class="mt-3 pt-3 border-t border-gray-100">
                                        <button onclick="viewStudentDetails('${student.studentId}')" 
                                                class="w-full text-center py-1 text-sm text-purple-600 hover:text-purple-800">
                                            View Details
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }



        async function loadAllPerformanceRecords() {
            try {
                // Load all performance records from Firebase for assessment counting
                const performanceSnapshot = await db.collection('performance').get();
                
                performanceRecords = [];
                performanceSnapshot.forEach(doc => {
                    performanceRecords.push({ id: doc.id, ...doc.data() });
                });
                
                console.log('Loaded all performance records for counting:', performanceRecords.length);
            } catch (error) {
                console.error('Error loading all performance records:', error);
                performanceRecords = [];
            }
        }

        async function loadPerformanceRecords(course) {
            try {
                // Load performance records from Firebase for specific course
                const performanceSnapshot = await db.collection('performance')
                    .where('courseCode', '==', course.code)
                    .get();
                
                const coursePerformanceRecords = [];
                performanceSnapshot.forEach(doc => {
                    coursePerformanceRecords.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by date in JavaScript instead of Firestore
                coursePerformanceRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Update the global performanceRecords for this course
                performanceRecords = performanceRecords.filter(r => r.courseCode !== course.code);
                performanceRecords.push(...coursePerformanceRecords);
                
                console.log('Loaded performance records for course:', coursePerformanceRecords.length);
                return coursePerformanceRecords;
            } catch (error) {
                console.error('Error loading performance records:', error);
                return [];
            }
        }

        // Helper functions for performance management
        function filterStudentPerformance() {
            // This function would filter the students grid based on search and performance level
            // For now, it's a placeholder
            console.log('Filtering student performance...');
        }

        function viewStudentDetails(studentId) {
            const course = courses.find(c => c.id === currentCourseId);
            const student = course.students.find(s => s.studentId === studentId);
            const studentRecords = performanceRecords.filter(r => r.studentId === studentId);
            
            if (!student) {
                alert('Student not found');
                return;
            }
            
            // Create a detailed modal for this student
            const modalHtml = `
                <div id="studentDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-[70]">
                    <div class="flex items-center justify-center min-h-screen p-4">
                        <div class="bg-white rounded-lg max-w-4xl w-full p-6 max-h-[90vh] overflow-y-auto">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="text-xl font-semibold">Student Performance Details</h3>
                                    <div class="text-sm text-gray-600 mt-1">
                                        ${student.name} (${student.studentId}) - ${course.code}: ${course.name}
                                    </div>
                                </div>
                                <button onclick="closeStudentDetailsModal()" class="text-gray-400 hover:text-gray-600">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                            
                            <!-- Performance Summary -->
                            <div class="bg-gray-50 rounded-lg p-4 mb-6">
                                <h4 class="font-medium text-gray-900 mb-3">Performance Summary</h4>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-purple-600">
                                            ${studentRecords.length}
                                        </div>
                                        <div class="text-sm text-gray-600">Total Assessments</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold ${getAverageScoreColor(studentRecords)}">
                                            ${getAverageScore(studentRecords)}
                                        </div>
                                        <div class="text-sm text-gray-600">Average Score</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-blue-600">
                                            ${getLatestScore(studentRecords)}
                                        </div>
                                        <div class="text-sm text-gray-600">Latest Score</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Assessment History -->
                            <div class="mb-6">
                                <div class="flex justify-between items-center mb-3">
                                    <h4 class="font-medium text-gray-900">Assessment History</h4>
                                    <select id="assessmentSortSelect" onchange="sortAssessmentHistory()" class="text-sm border border-gray-300 rounded px-2 py-1">
                                        <option value="date-desc">Sort by Date (Newest First)</option>
                                        <option value="date-asc">Sort by Date (Oldest First)</option>
                                        <option value="name-asc">Sort by Name (A-Z)</option>
                                        <option value="name-desc">Sort by Name (Z-A)</option>
                                        <option value="order-added">Sort by Order Added</option>
                                    </select>
                                </div>
                                ${studentRecords.length === 0 ? `
                                    <div class="text-center py-8 text-gray-500">
                                        <svg class="w-12 h-12 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                        <p>No assessment records found for this student</p>
                                    </div>
                                ` : `
                                    <div id="assessmentHistoryContainer" class="space-y-4">
                                        ${studentRecords.sort((a, b) => new Date(b.date) - new Date(a.date)).map(record => `
                                            <div class="border border-gray-200 rounded-lg p-4">
                                                <div class="flex justify-between items-start mb-2">
                                                    <div>
                                                        <h5 class="font-medium text-gray-900">${record.occasion}</h5>
                                                        <div class="text-sm text-gray-600">
                                                            ðŸ“… ${formatDate(record.date)} â€¢ ðŸ‘¨â€ðŸ« ${record.teacher}
                                                        </div>
                                                    </div>
                                                    <div class="text-right">
                                                        ${record.score !== null && record.score !== undefined && record.score !== '' ? `
                                                            <div class="text-lg font-bold ${getScoreColor(record.score, record.maxScore)}">
                                                                ${record.score}/${record.maxScore}
                                                            </div>
                                                            <div class="text-sm text-gray-500">
                                                                ${Math.round((record.score / record.maxScore) * 100)}%
                                                            </div>
                                                        ` : `
                                                            <div class="text-lg font-medium text-gray-400">
                                                                No Score
                                                            </div>
                                                        `}
                                                    </div>
                                                </div>
                                                ${record.comments ? `
                                                    <div class="mt-3 p-3 bg-gray-50 rounded-lg">
                                                        <div class="text-sm font-medium text-gray-700 mb-1">Comments:</div>
                                                        <div class="text-sm text-gray-600">${record.comments}</div>
                                                    </div>
                                                ` : ''}
                                                ${record.fileName ? `
                                                    <div class="mt-2 text-sm text-blue-600">
                                                        ðŸ“Ž Attachment: ${record.fileName}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `).join('')}
                                    </div>
                                `}
                            </div>
                            
                            <!-- Close Button -->
                            <div class="flex justify-end">
                                <button onclick="closeStudentDetailsModal()" class="px-6 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('studentDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeStudentDetailsModal() {
            const modal = document.getElementById('studentDetailsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function getAverageScore(records) {
            const scoredRecords = records.filter(r => r.score !== null && r.score !== undefined && r.score !== '');
            if (scoredRecords.length === 0) return 'N/A';
            
            const average = scoredRecords.reduce((sum, r) => sum + (r.score / r.maxScore * 100), 0) / scoredRecords.length;
            return average.toFixed(1) + '%';
        }
        
        function getLatestScore(records) {
            const sortedRecords = records.sort((a, b) => new Date(b.date) - new Date(a.date));
            const latestRecord = sortedRecords.find(r => r.score !== null && r.score !== undefined && r.score !== '');
            
            if (!latestRecord) return 'N/A';
            return `${latestRecord.score}/${latestRecord.maxScore}`;
        }
        
        function getAverageScoreColor(records) {
            const scoredRecords = records.filter(r => r.score !== null && r.score !== undefined && r.score !== '');
            if (scoredRecords.length === 0) return 'text-gray-400';
            
            const average = scoredRecords.reduce((sum, r) => sum + (r.score / r.maxScore * 100), 0) / scoredRecords.length;
            
            if (average >= 80) return 'text-green-600';
            if (average >= 60) return 'text-yellow-600';
            return 'text-red-600';
        }
        
        function getScoreColor(score, maxScore) {
            const percentage = (score / maxScore) * 100;
            if (percentage >= 80) return 'text-green-600';
            if (percentage >= 60) return 'text-yellow-600';
            return 'text-red-600';
        }

        function getScoreColorClass(score, maxScore) {
            const percentage = (score / maxScore) * 100;
            if (percentage >= 80) return 'text-green-600';
            if (percentage >= 60) return 'text-yellow-600';
            return 'text-red-600';
        }

        function sortAssessmentHistory() {
            const sortBy = document.getElementById('assessmentSortSelect').value;
            const container = document.getElementById('assessmentHistoryContainer');
            const course = courses.find(c => c.id === currentCourseId);
            
            // Get the current student ID from the modal context
            const modalContent = document.getElementById('studentDetailsModal');
            if (!modalContent) return;
            
            const studentIdMatch = modalContent.innerHTML.match(/\(([^)]+)\)/);
            if (!studentIdMatch) return;
            
            const studentId = studentIdMatch[1];
            let studentRecords = performanceRecords.filter(r => r.studentId === studentId);
            
            // Sort based on selection
            switch (sortBy) {
                case 'date-desc':
                    studentRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                    break;
                case 'date-asc':
                    studentRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
                    break;
                case 'name-asc':
                    studentRecords.sort((a, b) => a.occasion.localeCompare(b.occasion));
                    break;
                case 'name-desc':
                    studentRecords.sort((a, b) => b.occasion.localeCompare(a.occasion));
                    break;
                case 'order-added':
                    studentRecords.sort((a, b) => new Date(a.createdAt || a.date) - new Date(b.createdAt || b.date));
                    break;
            }
            
            // Update the container with sorted records
            container.innerHTML = studentRecords.map(record => `
                <div class="border border-gray-200 rounded-lg p-4">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <h5 class="font-medium text-gray-900">${record.occasion}</h5>
                            <div class="text-sm text-gray-600">
                                ðŸ“… ${formatDate(record.date)} â€¢ ðŸ‘¨â€ðŸ« ${record.teacher}
                            </div>
                        </div>
                        <div class="text-right">
                            ${record.score !== null && record.score !== undefined && record.score !== '' ? `
                                <div class="text-lg font-bold ${getScoreColor(record.score, record.maxScore)}">
                                    ${record.score}/${record.maxScore}
                                </div>
                                <div class="text-sm text-gray-500">
                                    ${Math.round((record.score / record.maxScore) * 100)}%
                                </div>
                            ` : `
                                <div class="text-lg font-medium text-gray-400">
                                    No Score
                                </div>
                            `}
                        </div>
                    </div>
                    ${record.comments ? `
                        <div class="mt-3 p-3 bg-gray-50 rounded-lg">
                            <div class="text-sm font-medium text-gray-700 mb-1">Comments:</div>
                            <div class="text-sm text-gray-600">${record.comments}</div>
                        </div>
                    ` : ''}
                    ${record.fileName ? `
                        <div class="mt-2 text-sm text-blue-600">
                            ðŸ“Ž Attachment: ${record.fileName}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function exportPerformanceData() {
            // This would export performance data to CSV or PDF
            alert('Export functionality would be implemented here. This would generate a report of all performance data.');
        }

        function openAddPerformanceForm() {
            document.getElementById('addPerformanceModal').classList.remove('hidden');
            // Set default date to today
            document.getElementById('assessmentDate').value = new Date().toISOString().split('T')[0];
        }

        function closeAddPerformanceForm() {
            document.getElementById('addPerformanceModal').classList.add('hidden');
            document.getElementById('addPerformanceForm').reset();
            document.getElementById('selectedFileName').classList.add('hidden');
            
            // Reset form to add mode
            document.querySelector('#addPerformanceModal h3').textContent = 'Add Performance Information';
            document.querySelector('#addPerformanceModal button[type="submit"]').textContent = 'Save Performance Info';
            
            const form = document.getElementById('addPerformanceForm');
            delete form.dataset.editMode;
            delete form.dataset.originalDate;
            delete form.dataset.originalOccasion;
            delete form.dataset.originalTeacher;
        }



        async function savePerformanceInfo(event) {
            event.preventDefault();
            
            const course = courses.find(c => c.id === currentCourseId);
            const occasion = document.getElementById('occasionInput').value;
            const teacher = document.getElementById('teacherInput').value;
            const maxScore = document.getElementById('maxScore').value;
            const assessmentDate = document.getElementById('assessmentDate').value;
            const form = document.getElementById('addPerformanceForm');
            const isEditMode = form.dataset.editMode === 'true';
            
            // Create document ID in format: per_coursecode_occasion_yyyy-mm-dd
            const performanceId = `per_${course.code}_${occasion.replace(/\s+/g, '_')}_${assessmentDate}`;
            
            const performanceData = {
                courseCode: course.code,
                courseName: course.name,
                date: assessmentDate,
                occasion: occasion,
                teacher: teacher,
                score: null, // Individual scores will be set per student
                maxScore: maxScore ? parseFloat(maxScore) : 100,
                comments: document.getElementById('performanceComments').value,
                showToStudents: document.getElementById('showToStudents').value,
                fileName: null, // File handling would need additional implementation
                updatedAt: new Date().toISOString()
            };
            
            // Add createdAt only for new records
            if (!isEditMode) {
                performanceData.createdAt = new Date().toISOString();
            }
            
            // Handle file if selected
            const fileInput = document.getElementById('performanceFile');
            if (fileInput.files.length > 0) {
                performanceData.fileName = fileInput.files[0].name;
                // In a real implementation, you would upload the file to Firebase Storage
                // and store the download URL in the performance record
            }
            
            try {
                if (isEditMode) {
                    // If editing, we might need to handle ID changes
                    const originalDate = form.dataset.originalDate;
                    const originalOccasion = form.dataset.originalOccasion;
                    const originalTeacher = form.dataset.originalTeacher;
                    const originalId = `per_${course.code}_${originalOccasion.replace(/\s+/g, '_')}_${originalDate}`;
                    
                    // If the key fields changed, delete old records and create new ones
                    if (originalDate !== assessmentDate || originalOccasion !== occasion || originalTeacher !== teacher) {
                        // Delete all old records for this assessment
                        const oldRecordsSnapshot = await db.collection('performance')
                            .where('courseCode', '==', course.code)
                            .where('date', '==', originalDate)
                            .where('occasion', '==', originalOccasion)
                            .where('teacher', '==', originalTeacher)
                            .get();
                        
                        const batch = db.batch();
                        oldRecordsSnapshot.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        await batch.commit();
                        
                        // Create new records with updated information
                        const newRecordsSnapshot = await db.collection('performance')
                            .where('courseCode', '==', course.code)
                            .where('date', '==', originalDate)
                            .where('occasion', '==', originalOccasion)
                            .where('teacher', '==', originalTeacher)
                            .get();
                        
                        // Update all student records for this assessment
                        const updateBatch = db.batch();
                        oldRecordsSnapshot.forEach(doc => {
                            const data = doc.data();
                            const newId = `per_${course.code}_${occasion.replace(/\s+/g, '_')}_${assessmentDate}_${data.studentId}`;
                            const newRef = db.collection('performance').doc(newId);
                            updateBatch.set(newRef, {
                                ...data,
                                date: assessmentDate,
                                occasion: occasion,
                                teacher: teacher,
                                updatedAt: new Date().toISOString()
                            });
                        });
                        await updateBatch.commit();
                        
                        // Remove old assessment from course's assessmentDates
                        const currentAssessmentDates = course.assessmentDates || [];
                        const updatedAssessmentDates = currentAssessmentDates.filter(a => 
                            !(a.date === originalDate && a.occasion === originalOccasion && a.teacher === originalTeacher)
                        );
                        await updateCourse(currentCourseId, { assessmentDates: updatedAssessmentDates });
                    }
                    
                    // Update the main assessment record
                    await db.collection('performance').doc(performanceId).set(performanceData, { merge: true });
                    
                    // Update assessment in course's assessmentDates
                    await updateAssessmentInCourse(course, assessmentDate, occasion, teacher, performanceData, isEditMode);
                    
                    alert('Assessment updated successfully!');
                } else {
                    // Save new assessment
                    await db.collection('performance').doc(performanceId).set(performanceData);
                    
                    // Add assessment to course's assessmentDates
                    await updateAssessmentInCourse(course, assessmentDate, occasion, teacher, performanceData, isEditMode);
                    
                    alert('Assessment created successfully!');
                }
                
                closeAddPerformanceForm();
                await loadCourses(); // Reload courses to update assessment count
                await loadPerformanceRecords(course);
                displayPerformanceTabContent(); // Refresh the current tab content
                
            } catch (error) {
                alert('Error saving assessment: ' + error.message);
            }
        }

        async function updateAssessmentInCourse(course, assessmentDate, occasion, teacher, performanceData, isEditMode) {
            try {
                // Get current assessment dates or initialize empty array
                const currentAssessmentDates = course.assessmentDates || [];
                
                // Create assessment info object
                const assessmentInfo = {
                    date: assessmentDate,
                    occasion: occasion,
                    teacher: teacher,
                    maxScore: performanceData.maxScore,
                    comments: performanceData.comments,
                    showToStudents: performanceData.showToStudents,
                    fileName: performanceData.fileName,
                    createdAt: performanceData.createdAt || new Date().toISOString(),
                    updatedAt: performanceData.updatedAt
                };
                
                // Check if assessment already exists
                const existingIndex = currentAssessmentDates.findIndex(a => 
                    a.date === assessmentDate && a.occasion === occasion && a.teacher === teacher
                );
                
                let updatedAssessmentDates;
                if (existingIndex !== -1) {
                    // Update existing assessment
                    updatedAssessmentDates = [...currentAssessmentDates];
                    updatedAssessmentDates[existingIndex] = assessmentInfo;
                } else {
                    // Add new assessment
                    updatedAssessmentDates = [...currentAssessmentDates, assessmentInfo];
                }
                
                // Sort assessments by date (oldest first, newest last)
                updatedAssessmentDates.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                // Update course with new assessment dates
                await updateCourse(course.id, { assessmentDates: updatedAssessmentDates });
                
                console.log('Assessment info saved to course:', assessmentInfo);
            } catch (error) {
                console.error('Error updating assessment in course:', error);
                throw error;
            }
        }

        async function deletePerformanceRecord(recordId) {
            if (!confirm('Are you sure you want to delete this performance record? This action cannot be undone.')) {
                return;
            }
            
            try {
                await db.collection('performance').doc(recordId).delete();
                
                const course = courses.find(c => c.id === currentCourseId);
                await loadPerformanceRecords(course);
                displayPerformanceTabContent(); // Refresh the current tab content
                
                alert('Performance record deleted successfully!');
            } catch (error) {
                alert('Error deleting performance record: ' + error.message);
            }
        }

        function editPerformanceRecord(recordId) {
            // This would open the form in edit mode
            // For now, showing a simple alert
            alert('Edit functionality would be implemented here. The form would open pre-filled with the record data.');
        }

        function handleFileSelection(input) {
            const file = input.files[0];
            if (file) {
                // Check file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    alert('File size must be less than 10MB');
                    input.value = '';
                    return;
                }
                
                // Show selected file name
                document.getElementById('fileNameText').textContent = file.name;
                document.getElementById('selectedFileName').classList.remove('hidden');
            }
        }

        function clearSelectedFile() {
            document.getElementById('performanceFile').value = '';
            document.getElementById('selectedFileName').classList.add('hidden');
            document.getElementById('fileNameText').textContent = '';
        }

        // Assessment Details Modal Functions
        let currentAssessmentDetails = null;

        function openAssessmentDetails(date, occasion, teacher) {
            const course = courses.find(c => c.id === currentCourseId);
            const students = course.students || [];
            
            currentAssessmentDetails = { date, occasion, teacher };
            
            // Find assessment record to get additional details
            const assessmentRecord = performanceRecords.find(r => 
                r.date === date && r.occasion === occasion && r.teacher === teacher
            );
            
            // Update modal header with detailed assessment info
            document.getElementById('assessmentDetailsInfo').innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
                    <!-- Basic Info Card -->
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-2">Assessment Details</h4>
                        <div class="space-y-1 text-sm">
                            <div><span class="font-medium">Name:</span> ${occasion}</div>
                            <div><span class="font-medium">Date:</span> ${formatDate(date)}</div>
                            <div><span class="font-medium">Teacher:</span> ${teacher}</div>
                            <div><span class="font-medium">Max Score:</span> ${assessmentRecord ? assessmentRecord.maxScore : 100} points</div>
                        </div>
                    </div>
                    
                    <!-- Additional Info Card -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-2">Settings</h4>
                        <div class="space-y-1 text-sm">
                            <div class="flex items-center">
                                <span class="font-medium mr-2">Visibility:</span>
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${assessmentRecord && assessmentRecord.showToStudents === 'yes' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                                    ${assessmentRecord && assessmentRecord.showToStudents === 'yes' ? 'ðŸ‘ï¸ Visible to Students' : 'ðŸ”’ Hidden from Students'}
                                </span>
                            </div>
                            <div><span class="font-medium">Created:</span> ${assessmentRecord && assessmentRecord.createdAt ? formatDate(assessmentRecord.createdAt.split('T')[0]) : 'N/A'}</div>
                            <div><span class="font-medium">Last Updated:</span> ${assessmentRecord && assessmentRecord.updatedAt ? formatDate(assessmentRecord.updatedAt.split('T')[0]) : 'N/A'}</div>
                        </div>
                    </div>
                    
                    <!-- Description & Attachments Card -->
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h4 class="font-medium text-gray-900 mb-2">Additional Information</h4>
                        <div class="space-y-2 text-sm">
                            ${assessmentRecord && assessmentRecord.comments ? `
                                <div>
                                    <span class="font-medium">Description:</span>
                                    <div class="mt-1 p-2 bg-white rounded text-gray-700 text-xs">${assessmentRecord.comments}</div>
                                </div>
                            ` : '<div class="text-gray-500 italic">No description provided</div>'}
                            
                            ${assessmentRecord && assessmentRecord.fileName ? `
                                <div class="mt-2">
                                    <span class="font-medium">Attachment:</span>
                                    <div class="mt-1 flex items-center p-2 bg-white rounded">
                                        <svg class="w-4 h-4 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                                        </svg>
                                        <span class="text-xs text-blue-600">${assessmentRecord.fileName}</span>
                                    </div>
                                </div>
                            ` : '<div class="text-gray-500 italic text-xs mt-2">No attachment</div>'}
                        </div>
                    </div>
                </div>
            `;
            
            // Display students grid
            const tbody = document.getElementById('assessmentDetailsTableBody');
            tbody.innerHTML = students.map(student => {
                // Find existing performance record for this student and assessment
                const existingRecord = performanceRecords.find(r => 
                    r.date === date && 
                    r.occasion === occasion && 
                    r.teacher === teacher && 
                    r.studentId === student.studentId
                );
                
                return `
                    <tr>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${student.studentId}</td>
                        <td class="px-4 py-3 text-sm text-gray-900">${student.name}</td>
                        <td class="px-4 py-3">
                            <div class="flex items-center space-x-2">
                                <input type="number" 
                                       data-student-id="${student.studentId}" 
                                       data-field="score"
                                       value="${existingRecord && existingRecord.score !== null ? existingRecord.score : ''}"
                                       min="0" step="0.1" placeholder="Score"
                                       class="w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500">
                                <span class="text-gray-500 text-sm">out of</span>
                                <input type="number" 
                                       data-student-id="${student.studentId}" 
                                       data-field="maxScore"
                                       value="${existingRecord ? existingRecord.maxScore : (assessmentRecord ? assessmentRecord.maxScore : 100)}"
                                       min="1" step="0.1" placeholder="${assessmentRecord ? assessmentRecord.maxScore : 100}"
                                       class="w-16 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500">
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <textarea data-student-id="${student.studentId}" 
                                      data-field="comments"
                                      rows="2" placeholder="Comments..."
                                      class="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-purple-500">${existingRecord ? existingRecord.comments || '' : ''}</textarea>
                        </td>
                        <td class="px-4 py-3">
                            <div class="space-y-2">
                                <input type="file" 
                                       data-student-id="${student.studentId}"
                                       data-field="file"
                                       accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt"
                                       class="text-xs border border-gray-300 rounded px-2 py-1">
                                ${existingRecord && existingRecord.fileName ? `
                                    <div class="text-xs text-green-600">ðŸ“Ž ${existingRecord.fileName}</div>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('assessmentDetailsModal').classList.remove('hidden');
        }

        function closeAssessmentDetailsModal() {
            document.getElementById('assessmentDetailsModal').classList.add('hidden');
            currentAssessmentDetails = null;
        }

        async function saveAssessmentDetails() {
            if (!currentAssessmentDetails) return;
            
            const course = courses.find(c => c.id === currentCourseId);
            const students = course.students || [];
            const tbody = document.getElementById('assessmentDetailsTableBody');
            const rows = tbody.querySelectorAll('tr');
            
            try {
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const student = students[i];
                    
                    const scoreInput = row.querySelector('input[data-field="score"]');
                    const maxScoreInput = row.querySelector('input[data-field="maxScore"]');
                    const commentsTextarea = row.querySelector('textarea[data-field="comments"]');
                    const fileInput = row.querySelector('input[data-field="file"]');
                    
                    const score = scoreInput.value ? parseFloat(scoreInput.value) : null;
                    const maxScore = maxScoreInput.value ? parseFloat(maxScoreInput.value) : 100;
                    const comments = commentsTextarea.value;
                    
                    // Create performance record for this student
                    const performanceId = `per_${course.code}_${currentAssessmentDetails.occasion.replace(/\s+/g, '_')}_${currentAssessmentDetails.date}_${student.studentId}`;
                    
                    const performanceData = {
                        courseCode: course.code,
                        courseName: course.name,
                        studentId: student.studentId,
                        studentName: student.name,
                        date: currentAssessmentDetails.date,
                        occasion: currentAssessmentDetails.occasion,
                        teacher: currentAssessmentDetails.teacher,
                        score: score,
                        maxScore: maxScore,
                        comments: comments,
                        fileName: fileInput.files.length > 0 ? fileInput.files[0].name : null,
                        showToStudents: 'yes', // Default to yes for individual student records
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString()
                    };
                    
                    // Only save if there's actual data (score, comments, or file)
                    if (score !== null || comments.trim() !== '' || fileInput.files.length > 0) {
                        await db.collection('performance').doc(performanceId).set(performanceData);
                    }
                }
                
                closeAssessmentDetailsModal();
                await loadPerformanceRecords(course);
                displayPerformanceTabContent(); // Refresh the current tab content
                
                alert('Student performance data saved successfully!');
            } catch (error) {
                alert('Error saving student performance data: ' + error.message);
            }
        }

        function editAssessmentHeader(date, occasion, teacher) {
            // Find the assessment record to get additional details
            const assessmentRecord = performanceRecords.find(r => 
                r.date === date && r.occasion === occasion && r.teacher === teacher
            );
            
            // Pre-fill the form with existing data
            document.getElementById('assessmentDate').value = date;
            document.getElementById('occasionInput').value = occasion;
            document.getElementById('teacherInput').value = teacher;
            
            if (assessmentRecord) {
                document.getElementById('maxScore').value = assessmentRecord.maxScore || 100;
                document.getElementById('performanceComments').value = assessmentRecord.comments || '';
                document.getElementById('showToStudents').value = assessmentRecord.showToStudents || 'yes';
            }
            
            // Change form title and button text
            document.querySelector('#addPerformanceModal h3').textContent = 'Edit Assessment';
            document.querySelector('#addPerformanceModal button[type="submit"]').textContent = 'Update Assessment';
            
            // Store original values for comparison
            const form = document.getElementById('addPerformanceForm');
            form.dataset.editMode = 'true';
            form.dataset.originalDate = date;
            form.dataset.originalOccasion = occasion;
            form.dataset.originalTeacher = teacher;
            
            document.getElementById('addPerformanceModal').classList.remove('hidden');
        }

        async function deleteAssessment(date, occasion, teacher) {
            if (!confirm('Are you sure you want to delete this entire assessment? This will remove all student records for this assessment.')) {
                return;
            }
            
            try {
                const course = courses.find(c => c.id === currentCourseId);
                
                // Delete all performance records for this assessment
                const performanceSnapshot = await db.collection('performance')
                    .where('courseCode', '==', course.code)
                    .where('date', '==', date)
                    .where('occasion', '==', occasion)
                    .where('teacher', '==', teacher)
                    .get();
                
                const batch = db.batch();
                performanceSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                
                // Remove assessment from course's assessmentDates
                const currentAssessmentDates = course.assessmentDates || [];
                const updatedAssessmentDates = currentAssessmentDates.filter(a => 
                    !(a.date === date && a.occasion === occasion && a.teacher === teacher)
                );
                await updateCourse(currentCourseId, { assessmentDates: updatedAssessmentDates });
                
                await loadCourses(); // Reload courses to update assessment count
                await loadPerformanceRecords(course);
                displayPerformanceTabContent(); // Refresh the current tab content
                
                alert('Assessment deleted successfully!');
            } catch (error) {
                alert('Error deleting assessment: ' + error.message);
            }
        }

        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB');
        }

        function getAssessmentCount(course) {
            // Get assessment count from course's assessmentDates array
            return course.assessmentDates ? course.assessmentDates.length : 0;
        }

        function getAttendancePeriod(course) {
            const attendanceDates = course.attendanceDates || [];
            if (attendanceDates.length === 0) return 'No sessions yet';
            
            const dates = attendanceDates.map(a => new Date(a.date)).sort((a, b) => a - b);
            const firstDate = formatDate(dates[0]);
            const lastDate = formatDate(dates[dates.length - 1]);
            
            return dates.length === 1 ? firstDate : `${firstDate} - ${lastDate}`;
        }

        function editCourse(courseId) {
            // This would open an edit modal similar to add course modal
            // For brevity, showing a simple implementation
            const course = courses.find(c => c.id === courseId);
            if (course) {
                // Populate the add course modal with existing data
                document.getElementById('courseCode').value = course.code;
                document.getElementById('courseName').value = course.name;
                document.getElementById('teacherSelect').value = course.teacher;
                document.getElementById('schedule').value = course.schedule || '';
                document.getElementById('courseStatus').value = course.status;
                document.getElementById('startDate').value = course.startDate;
                
                // Change the form submission to update instead of add
                const form = document.getElementById('addCourseForm');
                form.onsubmit = async function(event) {
                    event.preventDefault();
                    
                    const teacherSelect = document.getElementById('teacherSelect');
                    const customTeacher = document.getElementById('customTeacher');
                    const teacher = teacherSelect.value === 'other' ? customTeacher.value : teacherSelect.value;
                    
                    const updates = {
                        code: document.getElementById('courseCode').value,
                        name: document.getElementById('courseName').value,
                        teacher: teacher,
                        schedule: document.getElementById('schedule').value,
                        status: document.getElementById('courseStatus').value,
                        startDate: document.getElementById('startDate').value
                    };
                    
                    try {
                        await updateCourse(courseId, updates);
                        closeAddCourseModal();
                        loadCourses();
                        // Reset form submission back to add mode
                        form.onsubmit = addCourse;
                    } catch (error) {
                        alert('Error updating course: ' + error.message);
                    }
                };
                
                openAddCourseModal();
            }
        }
    </script>

    <style>
        .tab-button.active {
            @apply bg-blue-100 text-blue-700;
        }
        
        .tab-button:not(.active) {
            @apply text-gray-600 hover:text-gray-800;
        }

        /* Mobile-specific improvements */
        @media (max-width: 640px) {
            /* Improve touch targets */
            button, select, input[type="checkbox"], input[type="radio"] {
                min-height: 44px;
                min-width: 44px;
            }
            
            /* Better modal sizing on mobile */
            .modal-content {
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Prevent horizontal scroll */
            body {
                overflow-x: hidden;
            }
            
            /* Better table scrolling on mobile */
            .table-container {
                -webkit-overflow-scrolling: touch;
            }
            
            /* Improve form inputs on mobile */
            input, textarea, select {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }

        /* Smooth scrolling for better UX */
        html {
            scroll-behavior: smooth;
        }

        /* Better focus states for accessibility */
        button:focus, input:focus, select:focus, textarea:focus {
            outline: 2px solid #3B82F6;
            outline-offset: 2px;
        }
    </style>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9736801ee2f620e9',t:'MTc1NTkwOTAxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
